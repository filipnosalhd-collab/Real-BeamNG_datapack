<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>BeamNG Drive - Datapack PL</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* Ekran blokady mobilnej */
      #mobileBlockScreen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        z-index: 99999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 30px;
        text-align: center;
      }

      #mobileBlockScreen .block-icon {
        font-size: 80px;
        margin-bottom: 30px;
      }

      #mobileBlockScreen h1 {
        color: #ef4444;
        font-size: 1.8em;
        margin-bottom: 20px;
      }

      #mobileBlockScreen p {
        color: #888;
        font-size: 1em;
        line-height: 1.6;
        max-width: 400px;
      }

      #mobileBlockScreen .desktop-icon {
        margin-top: 40px;
        font-size: 60px;
        opacity: 0.5;
      }

      /* Ukryj grƒô na mobile */
      @media (max-width: 768px), (hover: none) and (pointer: coarse) {
        #mobileBlockScreen {
          display: flex !important;
        }

        #gameContainer,
        .container,
        header,
        .btn-grid,
        .modal {
          display: none !important;
        }
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        min-height: 100vh;
        color: #fff;
        padding: 10px;
        transition: background 0.5s ease;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        padding: 20px;
        padding-top: 50px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 15px;
        margin-bottom: 15px;
        border: 2px solid #ff6b35;
        position: relative;
      }

      header h1 {
        font-size: clamp(1.5em, 5vw, 2.2em);
        color: #ff6b35;
        text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
      }

      header h2 {
        font-size: clamp(0.9em, 3vw, 1.1em);
        color: #ffd700;
      }

      .header-btns-left,
      .header-btns-right {
        position: absolute;
        top: 10px;
        display: flex;
        gap: 5px;
      }

      .header-btns-left {
        left: 10px;
      }

      .header-btns-right {
        right: 10px;
      }

      .lang-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #555;
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lang-btn:hover,
      .lang-btn:active {
        background: rgba(255, 255, 255, 0.2);
      }

      @media (max-width: 400px) {
        .lang-btn {
          padding: 6px 10px;
          font-size: 1em;
          min-width: 40px;
          min-height: 40px;
        }

        header {
          padding-top: 45px;
        }
      }

      .money-display {
        background: linear-gradient(145deg, #2d2d2d, #1a1a1a);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 15px;
        border: 2px solid #444;
      }

      .money-display h3 {
        color: #888;
        font-size: 0.9em;
        margin-bottom: 5px;
      }

      .money-amount {
        font-size: clamp(2em, 8vw, 3em);
        font-weight: bold;
        color: #4ade80;
        text-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
      }

      .money-amount.low {
        color: #f87171;
      }

      .debt-display {
        background: rgba(239, 68, 68, 0.2);
        border: 2px solid #ef4444;
        border-radius: 10px;
        padding: 10px;
        margin-top: 10px;
        display: none;
      }

      .debt-display.active {
        display: block;
      }

      .debt-display h4 {
        color: #ef4444;
        font-size: 0.9em;
      }

      .debt-amount {
        font-size: 1.5em;
        color: #ef4444;
        font-weight: bold;
      }

      .debt-deadline {
        font-size: 0.8em;
        color: #f87171;
      }

      .buttons-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 15px;
      }

      .btn {
        padding: 15px 10px;
        font-size: clamp(0.85em, 2.5vw, 1em);
        font-weight: bold;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn-icon {
        font-size: 1.8em;
      }

      .btn-instruction {
        background: linear-gradient(145deg, #3b82f6, #2563eb);
        color: white;
      }
      .btn-repair {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        color: white;
      }
      .btn-buy {
        background: linear-gradient(145deg, #10b981, #059669);
        color: white;
      }
      .btn-sell {
        background: linear-gradient(145deg, #ec4899, #db2777);
        color: white;
      }
      .btn-earn {
        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        color: white;
      }
      .btn-tax {
        background: linear-gradient(145deg, #ef4444, #dc2626);
        color: white;
      }
      .btn-card {
        background: linear-gradient(145deg, #06b6d4, #0891b2);
        color: white;
      }
      .btn-inventory {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        color: white;
      }
      .btn-shop {
        background: linear-gradient(145deg, #10b981, #059669);
        color: white;
      }
      .btn-insurance {
        background: linear-gradient(145deg, #ec4899, #db2777);
        color: white;
      }

      /* Paski statusu */
      .status-bars {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 12px 15px;
        margin-bottom: 15px;
      }

      .status-bar {
        margin: 8px 0;
      }

      .status-bar:first-child {
        margin-top: 0;
      }
      .status-bar:last-child {
        margin-bottom: 0;
      }

      .status-label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8em;
        margin-bottom: 4px;
        color: #ccc;
      }

      .status-track {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        height: 16px;
        overflow: hidden;
      }

      .status-fill {
        height: 100%;
        border-radius: 8px;
        transition: width 0.3s ease;
      }

      .status-fill.health {
        background: linear-gradient(90deg, #ef4444, #f87171);
      }
      .status-fill.food {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
      }
      .status-fill.water {
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
      }

      .status-value {
        font-size: 0.7em;
        color: #888;
        text-align: right;
        margin-top: 2px;
      }

      /* Sklep/Ekwipunek */
      .shop-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        max-height: 350px;
        overflow-y: auto;
        padding: 5px;
      }

      .shop-item {
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid #444;
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .shop-item:hover {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.15);
        transform: scale(1.02);
      }

      .shop-item .item-icon {
        font-size: 1.8em;
      }
      .shop-item .item-name {
        font-weight: bold;
        font-size: 0.85em;
        margin: 5px 0;
      }
      .shop-item .item-stats {
        font-size: 0.7em;
        color: #aaa;
        line-height: 1.3;
      }
      .shop-item .item-stats .positive {
        color: #4ade80;
      }
      .shop-item .item-stats .negative {
        color: #f87171;
      }
      .shop-item .item-price {
        margin-top: 6px;
        font-weight: bold;
        color: #ff6b35;
        font-size: 0.9em;
      }

      .inventory-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .inv-tab {
        flex: 1;
        padding: 10px 5px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        color: #888;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.85em;
        transition: all 0.2s;
      }

      .inv-tab.active {
        background: #ff6b35;
        color: white;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 10px;
        overflow-y: auto;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: linear-gradient(145deg, #2d2d2d, #1a1a1a);
        border-radius: 15px;
        padding: 20px;
        max-width: 450px;
        width: calc(100% - 20px);
        margin: 10px;
        border: 2px solid #ff6b35;
        max-height: 90vh;
        overflow-y: auto;
      }

      @media (max-width: 480px) {
        .modal-content {
          padding: 15px;
          border-radius: 12px;
        }
      }

      .modal-content h2 {
        color: #ff6b35;
        text-align: center;
        margin-bottom: 15px;
        font-size: clamp(1.3em, 4vw, 1.6em);
      }

      .modal-close {
        background: #ef4444;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-size: 1em;
        cursor: pointer;
        width: 100%;
        margin-top: 15px;
      }

      .instruction-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .instruction-section h3 {
        color: #ffd700;
        margin-bottom: 8px;
        font-size: 1em;
      }

      .instruction-section ul {
        list-style: none;
      }

      .instruction-section li {
        padding: 6px 0;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
      }

      .instruction-section li:last-child {
        border-bottom: none;
      }

      .price.earn {
        color: #4ade80;
        font-weight: bold;
      }
      .price.cost {
        color: #f87171;
        font-weight: bold;
      }

      .upload-section {
        text-align: center;
      }

      .upload-section > p {
        color: #aaa;
        margin-bottom: 10px;
        font-size: 0.9em;
      }

      .upload-area {
        border: 3px dashed #555;
        border-radius: 15px;
        padding: 25px 15px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s;
      }

      .upload-area:hover,
      .upload-area.dragover {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.1);
      }

      .upload-icon {
        font-size: 2.5em;
        margin-bottom: 5px;
      }

      .preview-image {
        max-width: 100%;
        max-height: 150px;
        border-radius: 10px;
        margin: 10px 0;
        object-fit: contain;
      }

      .ai-response {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        text-align: center;
        display: none;
      }

      .ai-response.active {
        display: block;
      }

      .ai-response .loader {
        width: 35px;
        height: 35px;
        border: 3px solid #333;
        border-top-color: #ff6b35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
        15% {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
        85% {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
      }

      .ai-response .result-icon {
        font-size: 2.5em;
        margin-bottom: 5px;
      }

      .ai-response .result-text {
        font-size: 1em;
        margin-bottom: 5px;
      }

      .ai-response .result-amount {
        font-size: 2em;
        font-weight: bold;
      }

      .ai-response .result-amount.cost {
        color: #f87171;
      }
      .ai-response .result-amount.earn {
        color: #4ade80;
      }

      .qr-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin: 15px 0;
        text-align: center;
      }

      .qr-section h4 {
        color: #1a1a2e;
        margin-bottom: 10px;
        font-size: 1em;
      }

      .qr-section p {
        color: #666;
        font-size: 0.85em;
        margin-bottom: 15px;
      }

      #qrcode,
      .qr-container {
        display: flex;
        justify-content: center;
        margin: 10px 0;
      }

      .qr-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
      }

      .qr-status.waiting {
        background: rgba(251, 191, 36, 0.2);
        color: #f59e0b;
      }

      .qr-status.success {
        background: rgba(74, 222, 128, 0.2);
        color: #22c55e;
      }

      .qr-status.rejected {
        background: rgba(248, 113, 113, 0.2);
        color: #ef4444;
      }

      .garage-item {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid #444;
        border-radius: 10px;
        padding: 12px;
        margin: 8px 0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .garage-item:hover {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.1);
      }

      .garage-item.selected {
        border-color: #4ade80;
        background: rgba(74, 222, 128, 0.1);
      }

      .garage-item .car-name {
        font-weight: bold;
        font-size: 1.1em;
      }

      .garage-item .car-price {
        color: #4ade80;
        font-size: 0.9em;
      }

      .verify-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
      }

      .verify-page img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 15px;
        margin: 20px 0;
        border: 3px solid #ff6b35;
      }

      .verify-page h2 {
        color: #ff6b35;
        margin-bottom: 10px;
      }

      .verify-page p {
        color: #aaa;
        margin-bottom: 20px;
        font-size: 1.1em;
      }

      .verify-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      .verify-btn {
        padding: 15px 40px;
        font-size: 1.2em;
        font-weight: bold;
        border: none;
        border-radius: 12px;
        cursor: pointer;
      }

      .verify-btn.yes {
        background: linear-gradient(145deg, #4ade80, #22c55e);
        color: white;
      }

      .verify-btn.no {
        background: linear-gradient(145deg, #f87171, #ef4444);
        color: white;
      }

      .verify-result {
        font-size: 3em;
        margin: 30px 0;
      }

      .confirm-btn {
        background: linear-gradient(145deg, #4ade80, #22c55e);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
        display: none;
      }

      .confirm-btn.active {
        display: block;
      }

      .confirm-btn.pay {
        background: linear-gradient(145deg, #f87171, #ef4444);
      }

      .beam-pay-card {
        width: 100%;
        aspect-ratio: 1.6;
        border-radius: 15px;
        background: linear-gradient(
          135deg,
          #1e40af,
          #3b82f6,
          #60a5fa,
          #3b82f6,
          #1e40af
        );
        background-size: 400% 400%;
        animation: cardShine 3s ease infinite;
        padding: 20px;
        position: relative;
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        overflow: hidden;
      }

      @keyframes cardShine {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      .card-logo {
        font-size: 1.2em;
        font-weight: bold;
        color: #fff;
      }

      .card-code {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: clamp(1.5em, 6vw, 2.2em);
        font-weight: bold;
        color: #fff;
        letter-spacing: 8px;
        font-family: "Courier New", monospace;
      }

      .card-balance {
        position: absolute;
        bottom: 15px;
        right: 20px;
        text-align: right;
      }

      .card-balance .label {
        font-size: 0.7em;
        color: rgba(255, 255, 255, 0.7);
      }

      .card-balance .amount {
        font-size: 1.2em;
        font-weight: bold;
        color: #fff;
      }

      .card-settings {
        margin-top: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 12px;
      }

      .card-settings h4 {
        color: #ffd700;
        margin-bottom: 10px;
        font-size: 0.95em;
      }

      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #333;
        font-size: 0.9em;
      }

      .setting-row:last-child {
        border-bottom: none;
      }

      .setting-label {
        color: #aaa;
      }
      .setting-value {
        font-weight: bold;
        color: #fff;
      }

      .limit-bar {
        width: 100%;
        height: 8px;
        background: #333;
        border-radius: 4px;
        margin-top: 8px;
        overflow: hidden;
      }

      .limit-fill {
        height: 100%;
        background: linear-gradient(90deg, #4ade80, #fbbf24, #ef4444);
        transition: width 0.3s;
      }

      .card-btn {
        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.85em;
        cursor: pointer;
        margin-top: 8px;
        width: 100%;
      }

      .tax-info {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid #ef4444;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .tax-info h4 {
        color: #ef4444;
        margin-bottom: 10px;
      }

      .tax-stat {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 0.9em;
      }

      .tax-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
        border-radius: 10px;
        margin: 10px 0;
      }

      .toggle-switch {
        width: 50px;
        height: 26px;
        background: #333;
        border-radius: 13px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
      }

      .toggle-switch.active {
        background: #4ade80;
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        width: 22px;
        height: 22px;
        background: #fff;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }

      .toggle-switch.active::after {
        transform: translateX(24px);
      }

      .pin-display {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 15px 0;
      }

      .pin-digit {
        width: 40px;
        height: 50px;
        background: #1a1a1a;
        border: 2px solid #444;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: bold;
        color: #fff;
      }

      .pin-digit.filled {
        border-color: #4ade80;
      }

      .pin-keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        max-width: 220px;
        margin: 0 auto;
      }

      .pin-key {
        padding: 12px;
        font-size: 1.3em;
        border: none;
        border-radius: 8px;
        background: #333;
        color: #fff;
        cursor: pointer;
      }

      .pin-key:active {
        transform: scale(0.95);
      }

      .pin-key.delete {
        background: #ef4444;
      }
      .pin-key.confirm {
        background: #4ade80;
      }

      .lang-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        max-height: 400px;
        overflow-y: auto;
      }

      .lang-option {
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #333;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        font-size: 0.85em;
        transition: all 0.2s;
      }

      .lang-option:hover,
      .lang-option.selected {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.2);
      }

      .input-group {
        margin: 10px 0;
      }

      .input-group label {
        display: block;
        color: #aaa;
        margin-bottom: 5px;
        font-size: 0.9em;
      }

      .input-group input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #444;
        background: #1a1a1a;
        color: #fff;
        font-size: 1.1em;
        text-align: center;
      }

      .input-group input:focus {
        outline: none;
        border-color: #ff6b35;
      }

      .ocr-progress {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        height: 6px;
        margin-top: 10px;
        overflow: hidden;
      }

      .ocr-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ff6b35, #ffd700);
        width: 0%;
        transition: width 0.3s;
      }

      @media (max-width: 400px) {
        .buttons-grid {
          gap: 8px;
        }

        .btn {
          padding: 12px 8px;
        }

        .btn-icon {
          font-size: 1.5em;
        }

        .pin-digit {
          width: 35px;
          height: 45px;
          font-size: 1.3em;
        }

        .pin-keypad {
          max-width: 180px;
        }

        .pin-key {
          padding: 10px;
          font-size: 1.1em;
        }
      }
    </style>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <!-- Ekran blokady dla urzƒÖdze≈Ñ mobilnych -->
    <div id="mobileBlockScreen">
      <div class="block-icon">üìµ</div>
      <h1 id="mobileBlockTitle">Gra niedostƒôpna na urzƒÖdzeniach mobilnych</h1>
      <p id="mobileBlockText">
        Ze wzglƒôdu na z≈Ço≈ºono≈õƒá mechanik i interfejsu, optymalizacja tej gry na
        urzƒÖdzenia mobilne nie jest mo≈ºliwa.
        <br /><br />
        Gra wymaga precyzyjnego sterowania i du≈ºego ekranu, kt√≥re sƒÖ dostƒôpne
        tylko na komputerach stacjonarnych i laptopach.
        <br /><br />
        Zapraszamy do gry na komputerze! üñ•Ô∏è
      </p>
      <div class="desktop-icon">üíª</div>
    </div>

    <div id="gameContainer">
      <div class="container">
        <header>
          <div class="header-btns-left">
            <button
              class="lang-btn"
              onclick="openModal('saves')"
              title="Save'y"
            >
              üíæ
            </button>
            <button
              class="lang-btn"
              onclick="openModal('vouchers')"
              title="Bony"
            >
              üéÅ
            </button>
          </div>
          <div class="header-btns-right">
            <button
              class="lang-btn"
              onclick="openModal('notifications')"
              title="Powiadomienia"
              style="position: relative"
            >
              üîî
              <span
                id="notificationBadge"
                style="
                  display: none;
                  position: absolute;
                  top: -5px;
                  right: -5px;
                  background: #ef4444;
                  color: white;
                  font-size: 0.6em;
                  padding: 2px 5px;
                  border-radius: 10px;
                  min-width: 15px;
                  text-align: center;
                "
                >0</span
              >
            </button>
            <button
              class="lang-btn"
              onclick="openModal('onlineAccount')"
              title="Konto online"
              id="onlineAccountBtn"
            >
              üë§
            </button>
            <button
              class="lang-btn"
              onclick="openModal('language')"
              title="Jƒôzyk"
            >
              üåê
            </button>
          </div>
          <div onclick="openModal('gameMode')" style="cursor: pointer">
            <h1 id="gameModeTitle">üöó BeamNG Drive</h1>
            <h2 id="gameModeSubtitle">Datapack</h2>
          </div>
          <div
            id="currentSaveDisplay"
            style="font-size: 0.8em; color: #888; margin-top: 5px"
          ></div>
        </header>

        <div class="money-display">
          <h3>üí∞ <span data-translate="yourMoney">TWOJE PIENIƒÑDZE</span></h3>
          <div class="money-amount" id="moneyDisplay">50 000 z≈Ç</div>

          <div class="debt-display" id="debtDisplay">
            <h4>‚ö†Ô∏è <span data-translate="debt">D≈ÅUG</span></h4>
            <div class="debt-amount" id="debtAmount">0 z≈Ç</div>
            <div class="debt-deadline" id="debtDeadline"></div>
          </div>
        </div>

        <!-- Paski statusu -->
        <div class="status-bars">
          <div class="status-bar">
            <div class="status-label">
              ‚ù§Ô∏è <span data-translate="health">Zdrowie</span>
            </div>
            <div class="status-track">
              <div
                class="status-fill health"
                id="healthBar"
                style="width: 100%"
              ></div>
            </div>
            <div class="status-value" id="healthValue">100/100</div>
          </div>
          <div class="status-bar">
            <div class="status-label">
              üçî <span data-translate="food">Jedzenie</span>
            </div>
            <div class="status-track">
              <div
                class="status-fill food"
                id="foodBar"
                style="width: 100%"
              ></div>
            </div>
            <div class="status-value" id="foodValue">1000/1000 kcal</div>
          </div>
          <div class="status-bar">
            <div class="status-label">
              üíß <span data-translate="water">Picie</span>
            </div>
            <div class="status-track">
              <div
                class="status-fill water"
                id="waterBar"
                style="width: 100%"
              ></div>
            </div>
            <div class="status-value" id="waterValue">1000/1000 ml</div>
          </div>
        </div>

        <div class="buttons-grid">
          <button
            class="btn btn-instruction"
            onclick="openModal('instruction')"
          >
            <span class="btn-icon">üìñ</span>
            <span data-translate="instructions">Instrukcja</span>
          </button>
          <button class="btn btn-earn" onclick="openModal('work')">
            <span class="btn-icon">üíº</span>
            <span data-translate="work">Praca</span>
          </button>
          <button class="btn btn-repair" onclick="openModal('repair')">
            <span class="btn-icon">üîß</span>
            <span data-translate="repair">Napraw Auto</span>
          </button>
          <button class="btn btn-buy" onclick="openModal('buy')">
            <span class="btn-icon">üöô</span>
            <span data-translate="buyCar">Kup Auto</span>
          </button>
          <button class="btn btn-sell" onclick="openModal('sell')">
            <span class="btn-icon">üí∏</span>
            <span data-translate="sellCar">Sprzedaj Auto</span>
          </button>
          <button class="btn btn-shop" onclick="openModal('shop')">
            <span class="btn-icon">üõí</span>
            <span data-translate="shop">Sklep</span>
          </button>
          <button class="btn btn-inventory" onclick="openModal('inventory')">
            <span class="btn-icon">üéí</span>
            <span data-translate="inventory">Ekwipunek</span>
          </button>
          <button
            class="btn"
            onclick="openModal('garage')"
            style="background: linear-gradient(145deg, #6366f1, #4f46e5)"
          >
            <span class="btn-icon">üöó</span>
            <span data-translate="garage">Gara≈º</span>
          </button>
          <button class="btn btn-insurance" onclick="openModal('insurance')">
            <span class="btn-icon">üè•</span>
            <span data-translate="insurance">Ubezpieczenia</span>
          </button>
          <button
            class="btn"
            onclick="openModal('business')"
            style="background: linear-gradient(145deg, #f59e0b, #d97706)"
          >
            <span class="btn-icon">üè¢</span>
            <span data-translate="business">Firmy</span>
          </button>
          <button
            class="btn"
            onclick="openModal('bank')"
            style="background: linear-gradient(145deg, #10b981, #059669)"
          >
            <span class="btn-icon">üè¶</span>
            <span data-translate="bank">Bank</span>
          </button>
          <button class="btn btn-tax" onclick="openModal('tax')">
            <span class="btn-icon">üèõÔ∏è</span>
            <span data-translate="taxes">Podatki</span>
          </button>
          <button class="btn btn-card" onclick="openModal('card')">
            <span class="btn-icon">üí≥</span>
            <span data-translate="card">Karta Beam-Pay</span>
          </button>
        </div>
      </div>

      <!-- Modal Instrukcja -->
      <div class="modal" id="modalInstruction">
        <div class="modal-content">
          <h2>üìñ <span data-translate="instructions">Instrukcja</span></h2>

          <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px">
            <div class="instruction-section">
              <h3>üíº <span data-translate="workSystem">System pracy</span></h3>
              <p
                style="color: #aaa; font-size: 0.9em; margin-bottom: 10px"
                data-translate="workDesc"
              >
                Wybierz zaw√≥d i pracuj 2 minuty w mini-grze:
              </p>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      margin-bottom: 4px;
                    "
                  >
                    <span>üßπ SprzƒÖtacz ‚Üí üë®‚Äç‚öïÔ∏è Chirurg</span>
                    <span style="color: #4ade80">500 - 7000 z≈Ç</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="jobsRange"
                    >13 zawod√≥w od ≈Çatwych do trudnych</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #f59e0b; margin-bottom: 4px">
                    üí∞ <span data-translate="coinGame">≈Åapanie monet</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="coinGameDesc"
                    >Klikaj spadajƒÖce monety +100 z≈Ç za ka≈ºdƒÖ!</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #ef4444; margin-bottom: 4px">
                    üò¥ <span data-translate="sleepMechanic">Zasypianie</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="sleepMechanicDesc"
                    >Trzymaj ekran ≈ºeby nie zasnƒÖƒá! Spanie = strata do 90%
                    zarobku</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>
                üöó <span data-translate="garageSystem">System gara≈ºu</span>
              </h3>
              <p
                style="color: #aaa; font-size: 0.9em; margin-bottom: 10px"
                data-translate="garageDesc"
              >
                Kupuj, ulepszaj i sprzedawaj auta:
              </p>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #6366f1; margin-bottom: 4px">
                    ‚¨ÜÔ∏è <span data-translate="upgrading">Ulepszanie</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="upgradeInfo"
                    >Kliknij raz - auto ulepsza siƒô w tle. Warto≈õƒá ro≈õnie (50% ‚Üí
                    1000%)</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #ef4444; margin-bottom: 4px">
                    üí• <span data-translate="breakRisk">Ryzyko zepsucia</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="breakInfo"
                    >0.5%/s szansy na zepsucie. Koszt: 150 z≈Ç + -5%
                    warto≈õci</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #10b981; margin-bottom: 4px">
                    üí∞ <span data-translate="selling">Sprzeda≈º</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="sellInfo"
                    >Cena = cena bazowa √ó procent ulepszenia</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>
                üí≥ <span data-translate="payments">P≈Çatno≈õci i op≈Çaty</span>
              </h3>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(239, 68, 68, 0.1);
                    border-radius: 8px;
                    margin-bottom: 6px;
                    display: flex;
                    justify-content: space-between;
                    border: 1px solid #ef4444;
                  "
                >
                  <span>üèõÔ∏è <span data-translate="taxes">Podatki</span></span>
                  <span style="color: #ef4444">-500 z≈Ç / 5 min</span>
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #f59e0b; margin-bottom: 4px">
                    ‚ö° <span data-translate="autoPay">Auto-p≈Çatno≈õƒá</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="autoPayInfo2"
                    >W≈ÇƒÖcz w ustawieniach karty - automatycznie p≈Çaci podatki i
                    ubezpieczenia</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #ef4444; margin-bottom: 4px">
                    ‚ö†Ô∏è <span data-translate="debtSystem">System d≈Çug√≥w</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="debtInfo2"
                    >Brak kasy = d≈Çug. Masz 7 dni na sp≈Çatƒô!</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>üõ°Ô∏è <span data-translate="insurances">Ubezpieczenia</span></h3>
              <p
                style="color: #aaa; font-size: 0.9em; margin-bottom: 10px"
                data-translate="insuranceDesc"
              >
                R√≥≈ºne pakiety dajƒÖce bonusy:
              </p>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #4ade80">‚ù§Ô∏èüçîüíß</span>
                  <span data-translate="healthIns">Zdrowotne</span> -
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="healthInsDesc"
                    >regeneracja HP, jedzenia, picia</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #6366f1">üîß‚öôÔ∏è</span>
                  <span data-translate="upgradeIns">Na ulepszanie</span> -
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="upgradeInsDesc"
                    >szybsze ulepszanie, mniejsza szansa zepsucia</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #f59e0b">üõ°Ô∏èü©π</span>
                  <span data-translate="repairIns">Na naprawƒô</span> -
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="repairInsDesc"
                    >pokrywa 30-100% koszt√≥w naprawy</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>‚ù§Ô∏è <span data-translate="survival">Przetrwanie</span></h3>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #ef4444"
                    >üçî <span data-translate="hungerDrain">G≈Ç√≥d</span>:</span
                  >
                  <span style="color: #888; font-size: 0.85em"
                    >-10 kcal / 5 min</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #3b82f6"
                    >üíß
                    <span data-translate="thirstDrain">Pragnienie</span>:</span
                  >
                  <span style="color: #888; font-size: 0.85em"
                    >-15 ml / 5 min</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(239, 68, 68, 0.2);
                    border-radius: 8px;
                    margin-bottom: 6px;
                    border: 1px solid #ef4444;
                  "
                >
                  <div style="color: #ef4444; margin-bottom: 4px">
                    üíÄ <span data-translate="death">≈ömierƒá</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="deathDesc"
                    >G≈Ç√≥d/woda = 0 ‚Üí tracisz HP. HP = 0 ‚Üí zginiesz i wr√≥cisz do
                    checkpointu!</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="survivalTip"
                    >Kupuj jedzenie i napoje w sklepie, lub wykup
                    ubezpieczenie!</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>
                üíæ
                <span data-translate="checkpointSystem"
                  >System checkpoint√≥w</span
                >
              </h3>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #10b981; margin-bottom: 4px">
                    üíæ
                    <span data-translate="createCheckpointInfo">Tworzenie</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="createCheckpointDesc"
                    >W menu Save'√≥w kliknij "Zapisz checkpoint" ≈ºeby zapisaƒá
                    aktualny postƒôp</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #f59e0b; margin-bottom: 4px">
                    üîÑ <span data-translate="respawn">Odrodzenie</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="respawnDesc"
                    >Po ≈õmierci wr√≥cisz do checkpointu. Brak checkpointu = reset
                    postƒôpu!</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>
                üéÅ <span data-translate="voucherSystem">System bon√≥w</span>
              </h3>
              <p
                style="color: #aaa; font-size: 0.9em"
                data-translate="voucherDesc"
              >
                Tw√≥rz bony pieniƒô≈ºne i wysy≈Çaj znajomym przez WhatsApp,
                Messenger, Email lub SMS. PieniƒÖdze pobierane sƒÖ dopiero gdy
                odbiorca zaakceptuje bon.
              </p>
            </div>

            <div class="instruction-section">
              <h3>üéÆ <span data-translate="gameModes">Tryby gry</span></h3>
              <p
                style="color: #aaa; font-size: 0.9em"
                data-translate="gameModesDesc"
              >
                Kliknij tytu≈Ç gry aby prze≈ÇƒÖczyƒá miƒôdzy trybem BeamNG (fikcyjne
                auta) a Real Life (prawdziwe marki). Ka≈ºdy tryb ma osobny
                postƒôp!
              </p>
            </div>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('instruction')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Zarobek -->
      <div class="modal" id="modalEarn">
        <div class="modal-content">
          <h2>üõ£Ô∏è <span data-translate="earnKm">Zarobek za kilometry</span></h2>

          <div class="upload-section">
            <div class="ai-response active" id="earnResponse">
              <div class="result-icon">üõ£Ô∏è</div>
              <div class="result-text" data-translate="enterKm">
                Wpisz przejechane kilometry:
              </div>
              <input
                type="number"
                id="kmInput"
                step="0.1"
                min="0.1"
                style="
                  width: 120px;
                  padding: 12px;
                  font-size: 1.2em;
                  border-radius: 8px;
                  border: 2px solid #ff6b35;
                  text-align: center;
                  margin: 10px 0;
                  background: #1a1a2e;
                  color: white;
                "
                placeholder="km"
              />
              <div style="color: #888; font-size: 0.9em">
                √ó 100 z≈Ç = <span id="kmCalc" style="color: #4ade80">0</span> z≈Ç
              </div>
            </div>

            <button class="confirm-btn" id="earnBtn" onclick="confirmEarn()">
              üí∞ <span data-translate="collectEarnings">Odbierz zarobek</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('earn')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Naprawa -->
      <div class="modal" id="modalRepair">
        <div class="modal-content">
          <h2>üîß <span data-translate="repair">Napraw Auto</span></h2>

          <div class="upload-section">
            <p>
              <span data-translate="selectCarToRepair"
                >Wybierz auto do naprawy:</span
              >
            </p>

            <div
              id="repairCarList"
              style="max-height: 300px; overflow-y: auto; margin-bottom: 15px"
            ></div>

            <div class="ai-response" id="repairResponse" style="display: none">
              <div class="result-icon">üîß</div>
              <div class="result-text" data-translate="repairCostInfo">
                Koszt naprawy:
              </div>
              <div class="result-amount cost" id="repairCostDisplay">
                -5,000 z≈Ç
              </div>
            </div>

            <button
              class="confirm-btn pay"
              id="repairBtn"
              onclick="confirmRepair()"
              style="display: none"
            >
              üîß <span data-translate="payAndRepair">Zap≈Çaƒá i napraw</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('repair')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Kup Auto -->
      <div class="modal" id="modalBuy">
        <div class="modal-content">
          <h2>üöô <span data-translate="buyCar">Kup Auto</span></h2>

          <!-- Wyszukiwarka -->
          <input
            type="text"
            id="carSearchInput"
            placeholder="üîç Szukaj auta..."
            style="
              width: 100%;
              padding: 12px;
              font-size: 1em;
              border-radius: 10px;
              border: 2px solid #444;
              background: #1a1a2e;
              color: white;
              margin-bottom: 15px;
            "
            oninput="filterCars()"
          />

          <!-- Lista aut -->
          <div
            class="shop-grid"
            id="carBuyGrid"
            style="max-height: 400px"
          ></div>

          <button
            class="modal-close"
            onclick="closeModal('buy')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Sprzedaj Auto -->
      <div class="modal" id="modalSell">
        <div class="modal-content">
          <h2>üí∏ <span data-translate="sellCar">Sprzedaj Auto</span></h2>

          <p
            style="color: #888; text-align: center; margin-bottom: 15px"
            data-translate="get50percent"
          >
            Dostaniesz 50% warto≈õci
          </p>

          <div id="sellGarageSection">
            <div
              id="sellGarageList"
              style="max-height: 350px; overflow-y: auto"
            ></div>
          </div>

          <div
            id="sellEmptyGarage"
            style="
              text-align: center;
              padding: 30px;
              color: #888;
              display: none;
            "
          >
            <div style="font-size: 3em">üÖøÔ∏è</div>
            <p data-translate="noCarInGarage">Nie masz ≈ºadnych aut w gara≈ºu</p>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('sell')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Sklep -->
      <div class="modal" id="modalShop">
        <div class="modal-content">
          <h2>üõí <span data-translate="shop">Sklep</span></h2>

          <!-- Zak≈Çadki -->
          <div class="inventory-tabs">
            <button class="inv-tab active" onclick="showShopTab('food')">
              üçî <span data-translate="foodTab">Jedzenie</span>
            </button>
            <button class="inv-tab" onclick="showShopTab('drinks')">
              ü•§ <span data-translate="drinksTab">Napoje</span>
            </button>
          </div>

          <!-- Produkty do kupienia -->
          <div class="shop-grid" id="shopGrid"></div>

          <button
            class="modal-close"
            onclick="closeModal('shop')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Ekwipunek (Plecak) -->
      <!-- Modal Gara≈º -->
      <div class="modal" id="modalGarage">
        <div class="modal-content">
          <h2>üöó <span data-translate="garage">Gara≈º</span></h2>

          <div
            id="garageEmpty"
            style="
              text-align: center;
              padding: 30px;
              color: #888;
              display: none;
            "
          >
            <div style="font-size: 3em">üöó</div>
            <p data-translate="noCarInGarage">Brak aut w gara≈ºu</p>
            <p
              style="font-size: 0.85em; margin-top: 5px"
              data-translate="buyCarFirst"
            >
              Kup auto w salonie!
            </p>
          </div>

          <div id="garageList" style="max-height: 60vh; overflow-y: auto"></div>

          <button
            class="modal-close"
            onclick="closeModal('garage')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Ulepszanie Auta -->
      <div class="modal" id="modalUpgrade">
        <div class="modal-content">
          <h2>üîß <span data-translate="upgradeCar">Ulepszanie</span></h2>

          <div
            id="upgradeCarInfo"
            style="text-align: center; margin-bottom: 15px"
          ></div>

          <div
            style="
              background: rgba(0, 0, 0, 0.3);
              border-radius: 10px;
              padding: 15px;
              margin-bottom: 15px;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
              "
            >
              <span data-translate="sellValue">Warto≈õƒá sprzeda≈ºy:</span>
              <span
                id="upgradeSellPercent"
                style="color: #4ade80; font-weight: bold"
                >50%</span
              >
            </div>
            <div
              style="
                width: 100%;
                height: 20px;
                background: #333;
                border-radius: 10px;
                overflow: hidden;
              "
            >
              <div
                id="upgradeProgressBar"
                style="
                  width: 5%;
                  height: 100%;
                  background: linear-gradient(90deg, #ef4444, #f59e0b, #4ade80);
                  transition: width 0.1s;
                "
              ></div>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                font-size: 0.8em;
                color: #888;
                margin-top: 5px;
              "
            >
              <span>50%</span>
              <span>1000%</span>
            </div>
          </div>

          <div
            id="upgradeStatus"
            style="
              text-align: center;
              margin-bottom: 15px;
              padding: 10px;
              background: rgba(0, 0, 0, 0.2);
              border-radius: 8px;
            "
          ></div>

          <button
            id="upgradeBtn"
            onclick="toggleUpgrade()"
            style="
              width: 100%;
              padding: 15px;
              background: #10b981;
              color: white;
              border: none;
              border-radius: 10px;
              font-size: 1.1em;
              cursor: pointer;
              margin-bottom: 10px;
            "
          >
            ‚ñ∂Ô∏è <span data-translate="startUpgrade">Rozpocznij ulepszanie</span>
          </button>

          <div
            style="
              background: rgba(239, 68, 68, 0.1);
              border: 1px solid #ef4444;
              border-radius: 8px;
              padding: 10px;
              margin-bottom: 15px;
            "
          >
            <p style="font-size: 0.85em; color: #ef4444; text-align: center">
              ‚ö†Ô∏è
              <span data-translate="upgradeWarning"
                >Podczas ulepszania auto mo≈ºe siƒô zepsuƒá! (150 z≈Ç + -5%)</span
              >
            </p>
          </div>

          <button
            class="modal-close"
            onclick="closeUpgradeModal()"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Praca -->
      <div class="modal" id="modalWork">
        <div class="modal-content">
          <h2>üíº <span data-translate="work">Praca</span></h2>

          <p
            style="color: #888; text-align: center; margin-bottom: 15px"
            data-translate="chooseJob"
          >
            Wybierz pracƒô:
          </p>

          <div id="jobsList" style="max-height: 50vh; overflow-y: auto"></div>

          <button
            class="modal-close"
            onclick="closeModal('work')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Mini-gra Praca -->
      <div class="modal" id="modalWorkGame">
        <div
          class="modal-content"
          style="
            max-width: 100%;
            width: 100%;
            height: 90vh;
            padding: 10px;
            position: relative;
            overflow: hidden;
          "
        >
          <div
            id="workGameHeader"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <span
              id="workJobName"
              style="font-size: 1.2em; font-weight: bold"
            ></span>
            <div style="display: flex; align-items: center; gap: 15px">
              <span id="workTimer" style="font-size: 1.5em; color: #f59e0b"
                >2:00</span
              >
              <button
                onclick="quitWorkEarly()"
                style="
                  padding: 8px 15px;
                  background: #ef4444;
                  color: white;
                  border: none;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 0.9em;
                "
              >
                ‚èπÔ∏è Przerwij (-3%)
              </button>
            </div>
          </div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 10px;
            "
          >
            <span>üí∞ <span id="workEarned">0</span> z≈Ç</span>
            <span
              >üìà +<span id="workBonus">0</span> z≈Ç
              <span data-translate="bonus">bonus</span></span
            >
          </div>

          <!-- Obszar gry -->
          <div
            id="workGameArea"
            style="
              position: relative;
              width: 100%;
              height: calc(100% - 120px);
              background: #1a1a2e;
              border-radius: 10px;
              overflow: hidden;
            "
          >
            <!-- Ciemnienie (zasypianie) -->
            <div
              id="sleepOverlayTop"
              style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 0;
                background: linear-gradient(to bottom, #000, transparent);
                pointer-events: none;
                z-index: 10;
              "
            ></div>
            <div
              id="sleepOverlayBottom"
              style="
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 0;
                background: linear-gradient(to top, #000, transparent);
                pointer-events: none;
                z-index: 10;
              "
            ></div>

            <!-- SpadajƒÖce pieniƒÖdze -->
            <div
              id="coinsContainer"
              style="position: absolute; top: 0; left: 0; right: 0; bottom: 0"
            ></div>
          </div>

          <!-- Przycisk "nie zasypiaj" - trzeba TRZYMAƒÜ -->
          <button
            id="wakeUpBtn"
            onmousedown="startWakeUp()"
            onmouseup="stopWakeUp()"
            onmouseleave="stopWakeUp()"
            ontouchstart="startWakeUp()"
            ontouchend="stopWakeUp()"
            style="
              position: absolute;
              bottom: 20px;
              left: 50%;
              transform: translateX(-50%);
              padding: 15px 40px;
              background: #ef4444;
              color: white;
              border: none;
              border-radius: 50px;
              font-size: 1.2em;
              cursor: pointer;
              z-index: 20;
              user-select: none;
              -webkit-user-select: none;
            "
          >
            üëÅÔ∏è <span data-translate="stayAwake">Trzymaj ≈ºeby nie zasnƒÖƒá!</span>
          </button>
        </div>
      </div>

      <div class="modal" id="modalInventory">
        <div class="modal-content">
          <h2>üéí <span data-translate="inventory">Ekwipunek</span></h2>

          <!-- Status gracza -->
          <div
            style="
              background: rgba(0, 0, 0, 0.3);
              border-radius: 10px;
              padding: 12px;
              margin-bottom: 15px;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span>‚ù§Ô∏è <span data-translate="health">Zdrowie</span></span>
              <span id="invHealth">100/100 HP</span>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span>üçî <span data-translate="food">Jedzenie</span></span>
              <span id="invFood">1000/1000 kcal</span>
            </div>
            <div style="display: flex; justify-content: space-between">
              <span>üíß <span data-translate="water">Picie</span></span>
              <span id="invWater">1000/1000 ml</span>
            </div>
          </div>

          <!-- Zawarto≈õƒá plecaka -->
          <h4 style="margin-bottom: 10px">
            üì¶ <span data-translate="backpackContents">Zawarto≈õƒá plecaka:</span>
          </h4>
          <div class="shop-grid" id="backpackGrid"></div>

          <div
            id="emptyBackpack"
            style="
              text-align: center;
              padding: 30px;
              color: #888;
              display: none;
            "
          >
            <div style="font-size: 3em">üéí</div>
            <p data-translate="emptyBackpack">Plecak jest pusty</p>
            <p
              style="font-size: 0.85em; margin-top: 5px"
              data-translate="goToShop"
            >
              Id≈∫ do sklepu kupiƒá jedzenie!
            </p>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('inventory')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Ubezpieczenia -->
      <div class="modal" id="modalInsurance">
        <div class="modal-content">
          <h2>üè• <span data-translate="insurance">Ubezpieczenia</span></h2>

          <!-- Aktywne ubezpieczenia -->
          <div
            id="activeInsurancesSection"
            style="margin-bottom: 15px; display: none"
          >
            <h4 style="color: #4ade80; margin-bottom: 10px">
              ‚úÖ
              <span data-translate="activeInsurances"
                >Aktywne ubezpieczenia</span
              >
              (<span id="activeCount">0</span>)
            </h4>
            <div
              id="activeInsurancesList"
              style="max-height: 150px; overflow-y: auto"
            ></div>
          </div>

          <p
            style="color: #888; text-align: center; margin-bottom: 10px"
            data-translate="chooseInsurance"
          >
            Wybierz pakiet:
          </p>

          <!-- Lista pakiet√≥w -->
          <div
            id="insuranceList"
            style="max-height: 300px; overflow-y: auto"
          ></div>

          <button
            class="modal-close"
            onclick="closeModal('insurance')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal wyboru okresu ubezpieczenia -->
      <div class="modal" id="modalInsurancePeriod">
        <div class="modal-content">
          <h2>üìÖ <span data-translate="choosePeriod">Wybierz okres</span></h2>

          <div
            id="insurancePeriodDetails"
            style="text-align: center; margin-bottom: 15px"
          ></div>

          <div
            id="periodOptions"
            style="display: flex; flex-direction: column; gap: 10px"
          ></div>

          <button
            class="modal-close"
            onclick="closeModal('insurancePeriod')"
            data-translate="cancel"
          >
            Anuluj
          </button>
        </div>
      </div>

      <!-- Modal szczeg√≥≈Ç√≥w ubezpieczenia -->
      <div class="modal" id="modalInsuranceDetails">
        <div class="modal-content">
          <h2>üìã <span data-translate="insuranceDetails">Szczeg√≥≈Çy</span></h2>

          <div id="insuranceDetailsContent"></div>

          <button
            class="modal-close"
            onclick="closeModal('insuranceDetails')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Podatki -->
      <div class="modal" id="modalTax">
        <div class="modal-content">
          <h2>üèõÔ∏è <span data-translate="taxes">Podatki</span></h2>

          <div class="tax-info">
            <h4>
              <span data-translate="taxInfo">Informacje o podatkach</span>
            </h4>
            <div class="tax-stat">
              <span data-translate="taxRate">Stawka:</span>
              <span class="price cost">500 z≈Ç / 5 min</span>
            </div>
            <div class="tax-stat">
              <span data-translate="totalPaid">Zap≈Çacono ≈ÇƒÖcznie:</span>
              <span id="totalTaxPaid">0 z≈Ç</span>
            </div>
            <div class="tax-stat">
              <span data-translate="nextTax">Nastƒôpny podatek za:</span>
              <span id="nextTaxTime">10:00</span>
            </div>
          </div>

          <div class="tax-toggle">
            <div>
              <strong data-translate="autoPay">Automatyczne p≈Çacenie</strong>
              <p
                style="font-size: 0.8em; color: #888"
                data-translate="autoPayDesc"
              >
                Karta p≈Çaci automatycznie w tle
              </p>
            </div>
            <div
              class="toggle-switch"
              id="autoPayToggle"
              onclick="toggleAutoPay()"
            ></div>
          </div>

          <div class="instruction-section">
            <h3>
              ‚ö†Ô∏è <span data-translate="debtInfo">Informacje o d≈Çugu</span>
            </h3>
            <p style="font-size: 0.9em; color: #aaa" data-translate="debtDesc">
              Je≈õli zabraknie pieniƒôdzy na podatek, powstanie d≈Çug. Masz 7 dni
              na sp≈Çatƒô d≈Çugu.
            </p>
            <div class="tax-stat" style="margin-top: 10px">
              <span data-translate="currentDebt">Aktualny d≈Çug:</span>
              <span id="currentDebt" class="price cost">0 z≈Ç</span>
            </div>
          </div>

          <button
            class="confirm-btn active"
            onclick="payDebt()"
            id="payDebtBtn"
            style="display: none"
          >
            üí≥ <span data-translate="payDebt">Sp≈Çaƒá d≈Çug</span>
          </button>

          <button
            class="modal-close"
            onclick="closeModal('tax')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Karta -->
      <div class="modal" id="modalCard">
        <div class="modal-content">
          <h2>üí≥ <span data-translate="card">Karta Beam-Pay</span></h2>

          <div class="beam-pay-card">
            <div class="card-logo">Beam-Pay</div>
            <div class="card-code" id="cardCode">000000</div>
            <div class="card-balance">
              <div class="label" data-translate="balance">Saldo</div>
              <div class="amount" id="cardBalance">50 000 z≈Ç</div>
            </div>
          </div>

          <div class="card-settings">
            <h4>
              ‚öôÔ∏è <span data-translate="cardSettings">Ustawienia karty</span>
            </h4>

            <div class="setting-row">
              <span class="setting-label" data-translate="spendingLimit"
                >Limit wydatk√≥w:</span
              >
              <span class="setting-value" id="limitValue">10 000 z≈Ç</span>
            </div>

            <div class="setting-row">
              <span class="setting-label" data-translate="spent"
                >Wydano z limitu:</span
              >
              <span class="setting-value" id="spentValue">0 z≈Ç</span>
            </div>

            <div class="setting-row">
              <span class="setting-label" data-translate="remaining"
                >Pozosta≈Ço:</span
              >
              <span class="setting-value" id="remainingValue">10 000 z≈Ç</span>
            </div>

            <div class="limit-bar">
              <div class="limit-fill" id="limitBar" style="width: 0%"></div>
            </div>

            <button class="card-btn" onclick="openModal('setLimit')">
              <span data-translate="setLimit">üìä Ustaw limit</span>
            </button>
            <button
              class="card-btn"
              onclick="pendingAction = 'resetLimit'; openModal('pin');"
            >
              <span data-translate="resetSpent">üîÑ Resetuj wydatki</span>
            </button>

            <div
              style="
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #444;
              "
            >
              <h4 style="margin-bottom: 10px">
                üí≥
                <span data-translate="autoPayments"
                  >Automatyczne p≈Çatno≈õci</span
                >
              </h4>
              <p
                style="font-size: 0.8em; color: #888; margin-bottom: 10px"
                data-translate="autoPayInfo"
              >
                Podatki i ubezpieczenia nie liczƒÖ siƒô do limitu
              </p>

              <div id="insuranceAutoPayList"></div>

              <div
                id="noInsurancesCard"
                style="
                  text-align: center;
                  color: #888;
                  padding: 10px;
                  display: none;
                "
              >
                <span data-translate="noActiveInsurance"
                  >Brak aktywnych ubezpiecze≈Ñ</span
                >
              </div>
            </div>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('card')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Ustaw Limit -->
      <div class="modal" id="modalSetLimit">
        <div class="modal-content">
          <h2>
            üìä <span data-translate="setLimit">Ustaw limit wydatk√≥w</span>
          </h2>

          <div class="input-group">
            <label data-translate="newLimit">Nowy limit (z≈Ç)</label>
            <input
              type="number"
              id="newLimitInput"
              min="100"
              placeholder="np. 10000"
            />
          </div>

          <button class="confirm-btn active" onclick="setNewLimit()">
            ‚úÖ <span data-translate="setLimitBtn">Ustaw limit</span>
          </button>
          <button
            class="modal-close"
            onclick="closeModal('setLimit')"
            data-translate="cancel"
          >
            Anuluj
          </button>
        </div>
      </div>

      <!-- Modal PIN -->
      <div class="modal" id="modalPin">
        <div class="modal-content">
          <h2>üîê <span data-translate="enterPin">Wpisz PIN</span></h2>
          <p
            style="
              text-align: center;
              color: #aaa;
              margin-bottom: 10px;
              font-size: 0.9em;
            "
            data-translate="enter6digitPin"
          >
            Wpisz 6-cyfrowy PIN z karty Beam-Pay
          </p>

          <div class="pin-display">
            <div class="pin-digit" id="pin1"></div>
            <div class="pin-digit" id="pin2"></div>
            <div class="pin-digit" id="pin3"></div>
            <div class="pin-digit" id="pin4"></div>
            <div class="pin-digit" id="pin5"></div>
            <div class="pin-digit" id="pin6"></div>
          </div>

          <div class="pin-keypad">
            <button class="pin-key" onclick="addPinDigit('1')">1</button>
            <button class="pin-key" onclick="addPinDigit('2')">2</button>
            <button class="pin-key" onclick="addPinDigit('3')">3</button>
            <button class="pin-key" onclick="addPinDigit('4')">4</button>
            <button class="pin-key" onclick="addPinDigit('5')">5</button>
            <button class="pin-key" onclick="addPinDigit('6')">6</button>
            <button class="pin-key" onclick="addPinDigit('7')">7</button>
            <button class="pin-key" onclick="addPinDigit('8')">8</button>
            <button class="pin-key" onclick="addPinDigit('9')">9</button>
            <button class="pin-key delete" onclick="deletePinDigit()">‚å´</button>
            <button class="pin-key" onclick="addPinDigit('0')">0</button>
            <button class="pin-key confirm" onclick="confirmPin()">‚úì</button>
          </div>

          <div
            id="forgotPinBtnContainer"
            style="display: none; margin-top: 10px"
          >
            <button
              onclick="forgotPinAuction()"
              style="
                width: 100%;
                padding: 12px;
                background: #f59e0b;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              ‚ùì <span data-translate="forgotPin">Nie pamiƒôtam PIN</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('pin'); pendingAction = null; pendingAuctionId = null;"
            data-translate="cancel"
          >
            Anuluj
          </button>
        </div>
      </div>

      <!-- Modal Limit Exceeded -->
      <div class="modal" id="modalLimitExceeded">
        <div class="modal-content">
          <h2>
            ‚ö†Ô∏è <span data-translate="limitExceeded">Przekroczono limit!</span>
          </h2>

          <div
            style="
              background: rgba(239, 68, 68, 0.2);
              border: 2px solid #ef4444;
              border-radius: 10px;
              padding: 15px;
              text-align: center;
            "
          >
            <h3 style="color: #ef4444">
              üö´ <span data-translate="pinRequired">Wymagany PIN</span>
            </h3>
            <p
              style="color: #aaa; margin-top: 10px"
              data-translate="transactionExceedsLimit"
            >
              Ta transakcja przekracza Tw√≥j limit wydatk√≥w. Wpisz PIN z karty
              aby potwierdziƒá.
            </p>
          </div>

          <button
            class="confirm-btn active"
            onclick="closeModal('limitExceeded'); openModal('pin');"
          >
            üîê <span data-translate="enterPinBtn">Wpisz PIN</span>
          </button>
          <button
            class="modal-close"
            onclick="closeModal('limitExceeded'); pendingAction = null;"
            data-translate="cancel"
          >
            Anuluj
          </button>
        </div>
      </div>

      <!-- Modal Wyb√≥r Trybu Gry -->
      <div class="modal" id="modalGameMode">
        <div class="modal-content">
          <h2>üéÆ <span data-translate="selectMode">Wybierz tryb</span></h2>

          <div style="display: flex; flex-direction: column; gap: 15px">
            <button
              onclick="switchGameMode('beamng')"
              id="modeBeamNG"
              style="
                padding: 20px;
                background: linear-gradient(145deg, #ff6b35, #f7931e);
                border: 3px solid transparent;
                border-radius: 15px;
                cursor: pointer;
                text-align: left;
                transition: all 0.3s;
              "
            >
              <div style="font-size: 1.5em; margin-bottom: 8px">
                üöó BeamNG Drive
              </div>
              <div style="font-size: 0.9em; color: rgba(255, 255, 255, 0.9)">
                Datapack
              </div>
              <div
                style="
                  font-size: 0.8em;
                  color: rgba(255, 255, 255, 0.7);
                  margin-top: 8px;
                "
                data-translate="beamngDesc"
              >
                Auta z gry BeamNG.drive - fikcyjne marki
              </div>
            </button>

            <button
              onclick="switchGameMode('reallife')"
              id="modeRealLife"
              style="
                padding: 20px;
                background: linear-gradient(145deg, #10b981, #059669);
                border: 3px solid transparent;
                border-radius: 15px;
                cursor: pointer;
                text-align: left;
                transition: all 0.3s;
              "
            >
              <div style="font-size: 1.5em; margin-bottom: 8px">
                üåç Real Life
              </div>
              <div
                style="font-size: 0.9em; color: rgba(255, 255, 255, 0.9)"
                data-translate="simulator"
              >
                Symulator
              </div>
              <div
                style="
                  font-size: 0.8em;
                  color: rgba(255, 255, 255, 0.7);
                  margin-top: 8px;
                "
                data-translate="reallifeDesc"
              >
                Prawdziwe marki aut w realnych cenach (-10%)
              </div>
            </button>
          </div>

          <div
            style="
              margin-top: 15px;
              padding: 12px;
              background: rgba(245, 158, 11, 0.1);
              border: 1px solid #f59e0b;
              border-radius: 10px;
              font-size: 0.85em;
              color: #f59e0b;
            "
          >
            ‚ö†Ô∏è
            <span data-translate="modeWarning"
              >Ka≈ºdy tryb ma osobny postƒôp na tym samym save'ie!</span
            >
          </div>

          <button
            class="modal-close"
            onclick="closeModal('gameMode')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Jƒôzyki -->
      <div class="modal" id="modalLanguage">
        <div class="modal-content">
          <h2>üåê <span data-translate="selectLanguage">Wybierz jƒôzyk</span></h2>

          <div class="lang-grid" id="langGrid"></div>

          <button
            class="modal-close"
            onclick="closeModal('language')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Save'y -->
      <div class="modal" id="modalSaves">
        <div class="modal-content">
          <h2>üíæ <span data-translate="saves">Save'y</span></h2>

          <div
            id="savesList"
            style="
              max-height: 50vh;
              overflow-y: auto;
              margin-bottom: 15px;
              -webkit-overflow-scrolling: touch;
            "
          ></div>

          <div
            style="
              padding: 12px;
              background: rgba(0, 0, 0, 0.2);
              border-radius: 10px;
            "
          >
            <p
              style="margin-bottom: 10px; font-weight: bold; font-size: 0.95em"
            >
              <span data-translate="createSave">Nowy save</span>
            </p>
            <input
              type="text"
              id="newSaveName"
              placeholder="Save 2"
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid #333;
                border-radius: 8px;
                background: #1a1a2e;
                color: white;
                margin-bottom: 10px;
                font-size: 16px;
              "
            />
            <button
              onclick="handleCreateSave()"
              style="
                width: 100%;
                padding: 14px;
                background: #10b981;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 1em;
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
              "
            >
              ‚ûï <span data-translate="createSave">Nowy save</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('saves')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Bony -->
      <div class="modal" id="modalVouchers">
        <div class="modal-content">
          <h2>üéÅ <span data-translate="vouchers">Bony</span></h2>

          <!-- Opisik -->
          <div
            style="
              background: rgba(139, 92, 246, 0.1);
              border: 1px solid #8b5cf6;
              border-radius: 10px;
              padding: 12px;
              margin-bottom: 15px;
              font-size: 0.85em;
              color: #aaa;
              line-height: 1.4;
            "
          >
            <span data-translate="vouchersDescription"
              >Bony to wirtualne pieniƒÖdze kt√≥re mo≈ºesz wys≈Çaƒá znajomym przez
              WhatsApp, Messenger, Email lub SMS. Odbiorca mo≈ºe przyjƒÖƒá bon
              (dostanie pieniƒÖdze) lub przekazaƒá go komu≈õ innemu.</span
            >
          </div>

          <!-- Twoje bony do wys≈Çania -->
          <div style="margin-bottom: 15px">
            <h3 style="font-size: 0.95em; margin-bottom: 10px">
              üì§ <span data-translate="vouchersToSend">Bony do wys≈Çania</span>
            </h3>
            <div
              id="vouchersToSendList"
              style="
                max-height: 30vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
              "
            ></div>
          </div>

          <!-- Otrzymane bony -->
          <div style="margin-bottom: 15px">
            <h3 style="font-size: 0.95em; margin-bottom: 10px">
              üì• <span data-translate="receivedVouchers">Otrzymane bony</span>
            </h3>
            <div
              id="receivedVouchersList"
              style="
                max-height: 30vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
              "
            ></div>
          </div>

          <!-- Utw√≥rz bon -->
          <div
            style="
              padding: 12px;
              background: rgba(0, 0, 0, 0.2);
              border-radius: 10px;
              margin-bottom: 15px;
            "
          >
            <p
              style="margin-bottom: 10px; font-weight: bold; font-size: 0.95em"
            >
              <span data-translate="createVoucher">Utw√≥rz bon</span>
            </p>
            <input
              type="number"
              id="voucherAmountInput"
              placeholder="100"
              min="1"
              inputmode="numeric"
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid #333;
                border-radius: 8px;
                background: #1a1a2e;
                color: white;
                margin-bottom: 10px;
                font-size: 16px;
              "
            />
            <input
              type="text"
              id="voucherMessageInput"
              placeholder="Wiadomo≈õƒá (opcjonalna)"
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid #333;
                border-radius: 8px;
                background: #1a1a2e;
                color: white;
                margin-bottom: 10px;
                font-size: 16px;
              "
            />
            <button
              onclick="handleCreateVoucher()"
              style="
                width: 100%;
                padding: 14px;
                background: #8b5cf6;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 1em;
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
              "
            >
              üéÅ <span data-translate="createVoucher">Utw√≥rz bon</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('vouchers')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Konto Online -->
      <!-- Modal WymuszajƒÖcy Logowanie (na starcie) -->
      <div class="modal" id="modalRequireLogin">
        <div class="modal-content" style="max-width: 400px; text-align: center">
          <h2>üéÆ BeamNG Datapack</h2>

          <div style="font-size: 4em; margin-bottom: 15px">üë§</div>

          <input
            type="text"
            id="loginName"
            placeholder="Twoja nazwa..."
            maxlength="20"
            style="
              width: 100%;
              padding: 15px;
              background: #222;
              border: 2px solid #333;
              border-radius: 10px;
              color: white;
              font-size: 1.1em;
              margin-bottom: 10px;
              text-align: center;
            "
          />
          <p
            id="loginError"
            style="
              color: #ef4444;
              font-size: 0.85em;
              display: none;
              margin-bottom: 10px;
            "
          ></p>

          <button
            onclick="setPlayerName()"
            style="
              width: 100%;
              padding: 15px;
              background: #10b981;
              color: white;
              border: none;
              border-radius: 10px;
              cursor: pointer;
              font-size: 1.1em;
            "
          >
            ‚úÖ Rozpocznij grƒô
          </button>

          <p style="color: #666; font-size: 0.8em; margin-top: 15px">
            Nazwa bƒôdzie widoczna dla innych graczy
          </p>
        </div>
      </div>

      <div class="modal" id="modalOnlineAccount">
        <div class="modal-content" style="max-width: 400px">
          <span class="close" onclick="closeModal('onlineAccount')"
            >&times;</span
          >
          <h2>üë§ <span data-translate="onlineAccount">Konto</span></h2>
          <div id="onlineAccountContent"></div>
        </div>
      </div>

      <!-- Modal Powiadomienia -->
      <div class="modal" id="modalNotifications">
        <div class="modal-content" style="max-width: 500px">
          <span class="close" onclick="closeModal('notifications')"
            >&times;</span
          >
          <h2>üîî <span data-translate="notifications">Powiadomienia</span></h2>
          <div
            id="notificationsList"
            style="max-height: 400px; overflow-y: auto"
          ></div>
        </div>
      </div>

      <!-- Modal Czat -->
      <div class="modal" id="modalChat">
        <div class="modal-content" style="max-width: 500px">
          <span class="close" onclick="closeChatModal()">&times;</span>
          <h2>
            üí¨ <span data-translate="chatWith">Czat z</span>
            <span id="chatWithName"></span>
          </h2>
          <div
            id="chatMessages"
            style="
              max-height: 300px;
              overflow-y: auto;
              background: #1a1a2e;
              padding: 10px;
              border-radius: 8px;
              margin-bottom: 10px;
            "
          ></div>
          <p
            style="
              color: #888;
              font-size: 0.75em;
              margin-bottom: 5px;
              text-align: center;
            "
          >
            üí∞ Koszt wiadomo≈õci: 5,50 z≈Ç/$
          </p>
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="chatInput"
              placeholder="Wiadomo≈õƒá..."
              style="
                flex: 1;
                padding: 12px;
                background: #222;
                border: 1px solid #333;
                border-radius: 8px;
                color: white;
              "
            />
            <button
              onclick="sendChatMessage()"
              style="
                padding: 12px 20px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              üì§
            </button>
          </div>
        </div>
      </div>

      <!-- Modal Aukcje -->
      <div class="modal" id="modalAuction">
        <div class="modal-content" style="max-width: 600px">
          <span class="close" onclick="closeModal('auction')">&times;</span>
          <h2>üè™ <span data-translate="auctionHouse">Dom Aukcyjny</span></h2>
          <div style="display: flex; gap: 10px; margin-bottom: 15px">
            <button
              onclick="showAuctionTab('browse')"
              class="tab-btn active"
              id="tabBrowse"
              style="
                flex: 1;
                padding: 10px;
                background: #333;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              üîç <span data-translate="browseAuctions">PrzeglƒÖdaj</span>
            </button>
            <button
              onclick="showAuctionTab('my')"
              class="tab-btn"
              id="tabMy"
              style="
                flex: 1;
                padding: 10px;
                background: #222;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              üì¶ <span data-translate="myAuctions">Moje</span>
            </button>
            <button
              onclick="showAuctionTab('create')"
              class="tab-btn"
              id="tabCreate"
              style="
                flex: 1;
                padding: 10px;
                background: #222;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              ‚ûï <span data-translate="createAuction">Wystaw</span>
            </button>
          </div>
          <div
            id="auctionContent"
            style="max-height: 400px; overflow-y: auto"
          ></div>
        </div>
      </div>

      <!-- Modal Szczeg√≥≈Çy Aukcji -->
      <div class="modal" id="modalAuctionDetail">
        <div class="modal-content" style="max-width: 450px">
          <span class="close" onclick="closeModal('auctionDetail')"
            >&times;</span
          >
          <div id="auctionDetailContent"></div>
        </div>
      </div>

      <!-- Modal Wy≈õlij do gracza online -->
      <div class="modal" id="modalSendToPlayer">
        <div class="modal-content" style="max-width: 400px">
          <span class="close" onclick="closeModal('sendToPlayer')"
            >&times;</span
          >
          <h2>
            üì§ <span data-translate="sendToPlayer">Wy≈õlij do gracza</span>
          </h2>
          <p style="color: #f59e0b; font-size: 0.9em; margin-bottom: 15px">
            ‚ö†Ô∏è
            <span data-translate="onlineFee">Op≈Çata: 250</span> ${getCurrency()}
          </p>
          <div
            id="onlinePlayersList"
            style="max-height: 300px; overflow-y: auto"
          ></div>
        </div>
      </div>

      <!-- Modal PodglƒÖd Bonu -->
      <div class="modal" id="modalVoucherPreview">
        <div class="modal-content">
          <div id="voucherPreviewContent"></div>
          <button
            class="modal-close"
            onclick="closeModal('voucherPreview')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Udostƒôpnij Bon -->
      <div class="modal" id="modalShareVoucher">
        <div class="modal-content">
          <h2>üì§ <span data-translate="shareVoucher">Wy≈õlij bon</span></h2>
          <div id="shareVoucherPreview" style="margin-bottom: 15px"></div>
          <div id="shareVoucherButtons"></div>
          <button
            class="modal-close"
            onclick="closeModal('shareVoucher')"
            style="margin-top: 15px"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Bank -->
      <div class="modal" id="modalBank">
        <div class="modal-content" style="max-width: 450px">
          <span class="close" onclick="closeModal('bank')">&times;</span>
          <h2>üè¶ <span data-translate="bank">Bank</span></h2>

          <div id="bankContent">
            <!-- Zawarto≈õƒá bƒôdzie renderowana dynamicznie -->
          </div>
        </div>
      </div>

      <!-- Modal Firmy -->
      <div class="modal" id="modalBusiness">
        <div class="modal-content" style="max-width: 550px">
          <span class="close" onclick="closeModal('business')">&times;</span>
          <h2>üè¢ <span data-translate="business">Twoje Firmy</span></h2>

          <div id="businessContent">
            <!-- Zawarto≈õƒá bƒôdzie renderowana dynamicznie -->
          </div>

          <button
            class="modal-close"
            onclick="closeModal('business')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Tworzenia Firmy -->
      <div class="modal" id="modalCreateBusiness">
        <div class="modal-content" style="max-width: 500px">
          <span class="close" onclick="closeModal('createBusiness')"
            >&times;</span
          >
          <h2>üèóÔ∏è <span data-translate="createBusiness">Za≈Ç√≥≈º Firmƒô</span></h2>

          <div id="createBusinessContent">
            <!-- Zawarto≈õƒá bƒôdzie renderowana dynamicznie -->
          </div>
        </div>
      </div>

      <!-- Modal Szczeg√≥≈Çy Firmy -->
      <div class="modal" id="modalBusinessDetail">
        <div class="modal-content" style="max-width: 550px">
          <span class="close" onclick="closeModal('businessDetail')"
            >&times;</span
          >
          <div id="businessDetailContent">
            <!-- Zawarto≈õƒá bƒôdzie renderowana dynamicznie -->
          </div>
        </div>
      </div>

      <!-- Modal Czat z Pracownikiem/Klientem -->
      <div class="modal" id="modalBusinessChat">
        <div class="modal-content" style="max-width: 500px">
          <span class="close" onclick="closeModal('businessChat')"
            >&times;</span
          >
          <h2 id="businessChatTitle">üí¨ Rozmowa</h2>

          <div
            id="businessChatMessages"
            style="
              max-height: 350px;
              overflow-y: auto;
              background: #1a1a2e;
              padding: 15px;
              border-radius: 10px;
              margin-bottom: 15px;
            "
          >
            <!-- Wiadomo≈õci czatu -->
          </div>

          <div
            id="businessChatOptions"
            style="display: flex; flex-direction: column; gap: 8px"
          >
            <!-- Opcje odpowiedzi -->
          </div>

          <div id="businessChatInput" style="display: none; margin-top: 10px">
            <input
              type="text"
              id="businessChatInputField"
              placeholder=""
              style="
                width: 100%;
                padding: 12px;
                background: #222;
                border: 2px solid #333;
                border-radius: 8px;
                color: white;
                font-size: 1em;
              "
            />
            <button
              onclick="sendBusinessChatInput()"
              id="businessChatSendBtn"
              style="
                width: 100%;
                margin-top: 8px;
                padding: 12px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
              data-translate="sendOffer"
            >
              Wy≈õlij
            </button>
          </div>
        </div>
      </div>

      <script>
        // ==================== JƒòZYKI ====================
        const languages = {
          pl: { name: "Polski", flag: "üáµüá±" },
          en: { name: "English", flag: "üá¨üáß" },
        };

        const translations = {
          pl: {
            yourMoney: "TWOJE PIENIƒÑDZE",
            debt: "D≈ÅUG",
            instructions: "Instrukcja",
            earnKm: "Zarobek (km)",
            repair: "Napraw Auto",
            buyCar: "Kup Auto",
            sellCar: "Sprzedaj Auto",
            work: "Praca",
            garage: "Gara≈º",
            business: "Firmy",
            createBusiness: "Za≈Ç√≥≈º Firmƒô",
            noBusinesses: "Nie masz jeszcze ≈ºadnej firmy",
            totalIncomeWeek: "≈ÅƒÖczny przych√≥d/tydzie≈Ñ",
            totalExpensesWeek: "≈ÅƒÖczne wydatki/tydzie≈Ñ",
            netProfitWeek: "Zysk netto/tydzie≈Ñ",
            workers: "pracownik√≥w",
            createNextBusiness: "Za≈Ç√≥≈º kolejnƒÖ firmƒô",
            selectCategory: "Wybierz kategoriƒô dzia≈Çalno≈õci",
            businessTypes: "typ√≥w firm",
            back: "Wr√≥ƒá",
            backToCategories: "Wr√≥ƒá do kategorii",
            selectType: "wybierz typ",
            startCost: "Koszt za≈Ço≈ºenia",
            clientsPerDay: "Klienci/dzie≈Ñ",
            avgIncomeClient: "≈ör. przych√≥d/klient",
            businessName: "Nazwa firmy",
            notEnoughMoneyBusiness: "Nie masz wystarczajƒÖco pieniƒôdzy!",
            youNeed: "Potrzebujesz",
            createBusinessFor: "Za≈Ç√≥≈º firmƒô za",
            hiredWorkers: "Zatrudnieni pracownicy",
            noWorkersYet:
              "Nie masz jeszcze pracownik√≥w. Zatrudnij kogo≈õ poni≈ºej!",
            candidates: "Kandydaci do pracy",
            noCandidates: "Brak kandydat√≥w. Nowi pojawiƒÖ siƒô wkr√≥tce.",
            searchCandidates: "Szukaj kandydat√≥w",
            negotiateTerms: "Negocjuj warunki",
            expects: "Oczekuje",
            activeClients: "Aktywni klienci",
            serve: "Obs≈Çu≈º",
            simulateDay: "Symuluj dzie≈Ñ pracy",
            closeBusiness: "Zamknij firmƒô",
            backToList: "Wr√≥ƒá do listy firm",
            reputation: "Reputacja",
            acceptTerms: "Akceptujƒô warunki",
            proposeAmount: "Zaproponuj innƒÖ kwotƒô",
            lowerBonus: "Ni≈ºsza prowizja, wy≈ºsza podstawa?",
            notInterested: "Dziƒôkujƒô, nie jeste≈õmy zainteresowani",
            giveRaise: "Daj podwy≈ºkƒô",
            needWorkers: "Potrzebujesz pracownik√≥w!",
            dayReport: "Dzie≈Ñ pracy",
            clients: "klient√≥w",
            afterCommission: "po prowizjach",
            hired: "Zatrudniono",
            workerFired: "Pracownik zwolniony",
            businessClosed: "Firma zamkniƒôta",
            businessCreated: "Za≈Ço≈ºono firmƒô",
            salariesIn: "Wyp≈Çaty w",
            cantAffordSalaries: "Nie staƒá Ciƒô na wyp≈Çaty w",
            addedToDebt: "Dodano do d≈Çugu",
            foundCandidates: "Znaleziono nowych kandydat√≥w!",
            needForRecruitment: "Potrzebujesz na rekrutacjƒô",
            chatWith: "Rozmowa z",
            greeting1:
              "Dzie≈Ñ dobry! Jestem {name}. Szukam pracy jako {position}.",
            greeting2:
              "Cze≈õƒá! Nazywam siƒô {name} i zainteresowa≈Ça mnie oferta pracy.",
            greeting3:
              "Witam serdecznie. {name}, szukam zatrudnienia w charakterze {position}.",
            salaryExpectation:
              "Moje oczekiwania to oko≈Ço {salary} {currency} tygodniowo, plus {bonus}% prowizji od wypracowanych zysk√≥w. Co Pan/Pani o tym sƒÖdzi?",
            acceptTermsBtn: "Akceptujƒô warunki",
            proposeAmountBtn: "Zaproponuj innƒÖ kwotƒô",
            lowerBonusBtn: "Ni≈ºsza prowizja, wy≈ºsza podstawa?",
            rejectBtn: "Dziƒôkujƒô, nie jeste≈õmy zainteresowani",
            acceptMsg:
              "Zgadzam siƒô na {salary} {currency}/tydzie≈Ñ plus {bonus}% prowizji. Witam w zespole!",
            workerAcceptMsg: "≈öwietnie! Bardzo siƒô cieszƒô. Kiedy mogƒô zaczƒÖƒá?",
            startNowMsg: "Od zaraz! Zapraszam do pracy.",
            workerThanksMsg: "Dziƒôkujƒô! Nie zawiodƒô.",
            counterOfferMsg: "Mam innƒÖ propozycjƒô finansowƒÖ...",
            enterSalaryPrompt: "Wpisz proponowanƒÖ pensjƒô tygodniowƒÖ:",
            sendOffer: "Wy≈õlij ofertƒô",
            proposeSalaryMsg: "Proponujƒô {salary} {currency} tygodniowo.",
            workerGreatOffer: "To bardzo fajna oferta! Zgadzam siƒô!",
            workerAcceptLower:
              "Trochƒô mniej ni≈º liczy≈Çem, ale zgoda. Bierzemy to!",
            workerCounterOffer:
              "To trochƒô za ma≈Ço... Mo≈ºe spotkamy siƒô w po≈Çowie drogi? {counter} {currency}?",
            workerTooLow:
              "Przepraszam, ale to znacznie poni≈ºej moich oczekiwa≈Ñ. Minimum {min} {currency}.",
            lowerBonusProposal:
              "Co powiesz na {salary} {currency}/tydzie≈Ñ, ale prowizja {bonus}%?",
            workerReasonable: "Hmm... to brzmi rozsƒÖdnie. Zgadzam siƒô!",
            workerNotGood:
              "Nie bardzo mi to pasuje. Mo≈ºe jednak {salary} i {bonus}%? To moja ostateczna oferta.",
            rejectMsg:
              "Dziƒôkujƒô za rozmowƒô, ale nie jeste≈õmy zainteresowani wsp√≥≈ÇpracƒÖ.",
            workerUnderstandMsg:
              "Rozumiem. Dziƒôkujƒô za po≈õwiƒôcony czas. Powodzenia!",
            backToBusinessBtn: "Wr√≥ƒá do firmy",
            bank: "Bank",
            takeCredit: "We≈∫ kredyt",
            creditAmount: "Kwota kredytu",
            interestRate: "Oprocentowanie",
            monthly: "miesiƒôcznie",
            repaymentPeriod: "Okres sp≈Çaty",
            months: "miesiƒôcy",
            monthlyPayment: "Rata miesiƒôczna",
            totalToRepay: "Razem do sp≈Çaty",
            yourCredits: "Twoje kredyty",
            noCredits: "Nie masz ≈ºadnych kredyt√≥w",
            remaining: "Pozosta≈Ço",
            payRate: "Zap≈Çaƒá ratƒô",
            payOff: "Sp≈Çaƒá ca≈Ço≈õƒá",
            creditTaken: "Kredyt przyznany!",
            ratePaid: "Rata zap≈Çacona",
            creditPaidOff: "Kredyt sp≈Çacony!",
            notEnoughForRate: "Nie masz na ratƒô!",
            upgrade: "Ulepsz",
            sellValue: "Warto≈õƒá",
            sell: "Sprzedaj",
            carBroken: "Auto zepsute!",
            cantSellBroken: "Nie mo≈ºesz sprzedaƒá zepsutego auta!",
            confirmSell: "Sprzedaƒá",
            forPrice: "za",
            sold: "Sprzedano!",
            basePrice: "Cena bazowa",
            buyQuestion: "Kupiƒá",
            carBought: "Kupiono",
            upgradeCar: "Ulepszanie",
            startUpgrade: "Rozpocznij ulepszanie",
            stopUpgrade: "Zatrzymaj",
            upgrading: "Ulepszanie w toku...",
            upgradeStopped: "Zatrzymane",
            clickToStart: "Kliknij aby rozpoczƒÖƒá",
            upgradeWarning:
              "Podczas ulepszania auto mo≈ºe siƒô zepsuƒá! (150 z≈Ç + -5%)",
            carBrokeMsg: "Auto siƒô zepsu≈Ço! -150 z≈Ç, -5%",
            carBreakDebt: "Zepsucie auta",
            buyCarFirst: "Kup auto w salonie!",
            chooseJob: "Wybierz pracƒô:",
            bonuses: "bonusy",
            bonus: "bonus",
            stayAwake: "Trzymaj ≈ºeby nie zasnƒÖƒá!",
            workDone: "Praca zako≈Ñczona!",
            basePay: "Podstawa",
            sleepPenalty: "Kara za spanie",
            total: "Razem",
            taxes: "Podatki",
            card: "Karta Beam-Pay",
            cardRealLife: "Karta Real-Card",
            howToEarn: "Jak zdobyƒá pieniƒÖdze?",
            perKm: "Za ka≈ºdy km",
            sellCarTo: "Sprzeda≈º auta",
            carPrice: "ceny auta",
            fees: "Op≈Çaty",
            fuel: "Paliwo (max 10 PkA)",
            startFuel: "Start: 10 punkt√≥w paliwa",
            taxesPer2km: "Podatki (co 2 km)",
            taxesPer10min: "Podatki (co 10 min)",
            repairCost: "Naprawa auta",
            fine: "Mandat",
            close: "Zamknij",
            sendScreenshotKm: "Wy≈õlij screenshot z przejechanych kilometr√≥w",
            clickOrDrag: "Kliknij lub przeciƒÖgnij screenshot",
            analyzing: "Analizujƒô screenshot...",
            collectEarnings: "Odbierz zarobek",
            sendScreenshotDamage: "Wy≈õlij screenshot uszkodzonego auta",
            repairCostInfo: "Koszt naprawy:",
            payAndRepair: "Zap≈Çaƒá i napraw",
            sendScreenshotCar: "Wy≈õlij screenshot z cenƒÖ auta",
            get50percent: "Dostaniesz 50% warto≈õci",
            buyCarBtn: "Kup auto",
            sellCarBtn: "Sprzedaj auto",
            taxInfo: "Informacje o podatkach",
            taxRate: "Stawka:",
            totalPaid: "Zap≈Çacono ≈ÇƒÖcznie:",
            nextTax: "Nastƒôpny podatek za:",
            autoPay: "Automatyczne p≈Çacenie",
            autoPayDesc: "Karta p≈Çaci automatycznie w tle",
            debtInfo: "Informacje o d≈Çugu",
            debtDesc:
              "Je≈õli zabraknie pieniƒôdzy na podatek, powstanie d≈Çug. Masz 7 dni na sp≈Çatƒô d≈Çugu.",
            currentDebt: "Aktualny d≈Çug:",
            payDebt: "Sp≈Çaƒá d≈Çug",
            balance: "Saldo",
            cardSettings: "Ustawienia karty",
            spendingLimit: "Limit wydatk√≥w:",
            spent: "Wydano z limitu:",
            remaining: "Pozosta≈Ço:",
            setLimit: "üìä Ustaw limit",
            resetSpent: "üîÑ Resetuj wydatki",
            newLimit: "Nowy limit (z≈Ç)",
            setLimitBtn: "Ustaw limit",
            cancel: "Anuluj",
            enterPin: "Wpisz PIN",
            enter6digitPin: "Wpisz 6-cyfrowy PIN z karty Beam-Pay",
            limitExceeded: "Przekroczono limit!",
            pinRequired: "Wymagany PIN",
            transactionExceedsLimit:
              "Ta transakcja przekracza Tw√≥j limit. Wpisz PIN aby potwierdziƒá.",
            enterPinBtn: "Wpisz PIN",
            selectLanguage: "Wybierz jƒôzyk",
            daysLeft: "dni do sp≈Çaty",
            notEnoughMoney: "Nie masz wystarczajƒÖco pieniƒôdzy!",
            invalidScreenshot: "Nie rozpoznano danych!",
            foundKm: "Znaleziono:",
            foundPrice: "Cena auta:",
            noCarFound: "Nie znaleziono auta na obrazku!",
            enterKm: "Wpisz przejechane kilometry:",
            enterPrice: "Wpisz cenƒô auta:",
            youGet50: "Dostaniesz 50%:",
            youPay: "Zap≈Çacisz:",
            generateQR: "Generuj kod QR",
            carName: "Nazwa auta (np. ETK 800)",
            carPricePlaceholder: "Cena ze screena",
            selectCarToSell: "Wybierz auto z gara≈ºu:",
            sendCarPhoto: "Wy≈õlij zdjƒôcie tego auta",
            noCarInGarage: "Nie masz ≈ºadnych aut w gara≈ºu",
            boughtFor: "Kupiono za",
            inventory: "Ekwipunek",
            health: "Zdrowie",
            food: "Jedzenie",
            water: "Picie",
            foodTab: "Jedzenie",
            drinksTab: "Napoje",
            foodFull: "Nie mo≈ºesz wiƒôcej je≈õƒá!",
            waterFull: "Nie mo≈ºesz wiƒôcej piƒá!",
            shop: "Sklep",
            backpackContents: "Zawarto≈õƒá plecaka:",
            emptyBackpack: "Plecak jest pusty",
            goToShop: "Id≈∫ do sklepu kupiƒá jedzenie!",
            useItem: "U≈ºyj",
            tooFull: "Jeste≈õ pe≈Çny!",
            insurance: "Ubezpieczenia",
            activeInsurances: "Aktywne ubezpieczenia",
            chooseInsurance: "Wybierz pakiet:",
            cancelInsurance: "Zrezygnuj",
            confirmCancelWithRefund: "Zrezygnowaƒá? Zwrot",
            confirmCancelNoRefund:
              "Zrezygnowaƒá? Brak zwrotu (u≈ºyto mniej ni≈º 3 razy)",
            choosePeriod: "Wybierz okres",
            hour: "Godzina",
            day: "Dzie≈Ñ",
            week: "Tydzie≈Ñ",
            month: "MiesiƒÖc",
            perHour: "/godz",
            perDay: "/dzie≈Ñ",
            perWeek: "/tydzie≈Ñ",
            perMonth: "/miesiƒÖc",
            activated: "Aktywowane",
            perHourShort: "/h",
            perDayShort: "/d",
            perWeekShort: "/tyg",
            every: "co",
            hour: "Godzina",
            day: "Dzie≈Ñ",
            week: "Tydzie≈Ñ",
            remaining: "Pozosta≈Ço",
            expired: "Wygas≈Ço",
            autoPayments: "Automatyczne p≈Çatno≈õci",
            autoPayInfo: "Podatki i ubezpieczenia nie liczƒÖ siƒô do limitu",
            autoPay: "Auto-p≈Çaƒá",
            noActiveInsurance: "Brak aktywnych ubezpiecze≈Ñ",
            alreadyHaveInsurance: "Ju≈º masz to ubezpieczenie!",
            insuranceDetails: "Szczeg√≥≈Çy",
            price: "Cena",
            totalPaid: "Zap≈Çacono ≈ÇƒÖcznie",
            benefitsReceived: "Otrzymane korzy≈õci",
            nextPayment: "Nastƒôpna p≈Çatno≈õƒá",
            refund: "zwrot",
            noRefund: "brak zwrotu",
            // Produkty - jedzenie
            itemBurger: "Burger",
            itemPizza: "Pizza",
            itemHotdog: "Hot Dog",
            itemFries: "Frytki",
            itemSandwich: "Kanapka",
            itemSalad: "Sa≈Çatka",
            itemApple: "Jab≈Çko",
            itemBanana: "Banan",
            itemWatermelon: "Arbuz",
            itemChicken: "Kurczak",
            itemSteak: "Stek",
            itemSushi: "Sushi",
            itemDonut: "PƒÖczek",
            itemIcecream: "Lody",
            itemChocolate: "Czekolada",
            // Produkty - napoje
            itemWater: "Woda",
            itemCola: "Cola",
            itemJuice: "Sok",
            itemCoffee: "Kawa",
            itemTea: "Herbata",
            itemMilk: "Mleko",
            itemBeer: "Piwo",
            itemWine: "Wino",
            itemSmoothie: "Smoothie",
            itemEnergyDrink: "Energetyk",
            itemLemonade: "Lemoniada",
            itemCoconut: "Woda kokosowa",
            // Ubezpieczenia - nazwy
            insBasic: "Basic",
            insStandard: "Standard",
            insPremium: "Premium",
            insVip: "VIP",
            insUltimate: "Ultimate",
            insHealthBasic: "Zdrowie Basic",
            insHealthPlus: "Zdrowie Plus",
            insFoodBasic: "Jedzenie Basic",
            insFoodPlus: "Jedzenie Plus",
            insWaterBasic: "Picie Basic",
            insWaterPlus: "Picie Plus",
            insHealthFood: "Zdrowie + Jedzenie",
            insHealthWater: "Zdrowie + Picie",
            insFoodWater: "Jedzenie + Picie",
            // Ubezpieczenia ulepszanie
            insUpgradeBasic: "Ulepszanie Basic",
            insUpgradePlus: "Ulepszanie Plus",
            insUpgradePro: "Ulepszanie Pro",
            insUpgradeMax: "Ulepszanie Max",
            insUpgradeBasicDesc: "+0.05%/s, -10% szansy zepsucia",
            insUpgradePlusDesc: "+0.1%/s, -20% szansy zepsucia",
            insUpgradeProDesc: "+0.15%/s, -30% szansy zepsucia",
            insUpgradeMaxDesc: "+0.2%/s, -40% szansy zepsucia",
            // Ubezpieczenia naprawa
            insRepairBasic: "Naprawa Basic",
            insRepairPlus: "Naprawa Plus",
            insRepairFull: "Naprawa Full",
            insRepairBasicDesc: "30% koszt√≥w naprawy pokryte",
            insRepairPlusDesc: "50% koszt√≥w naprawy pokryte",
            insRepairFullDesc: "100% koszt√≥w naprawy pokryte",
            noBrokenCars: "Wszystkie auta sƒÖ sprawne!",
            goToGarage: "Id≈∫ do Gara≈ºu ≈ºeby ulepszaƒá auta",
            carNotBroken: "To auto nie jest zepsute!",
            repairDebt: "Naprawa auta",
            addedToDebt: "Dodano do d≈Çugu",
            insuranceCovered: "Ubezpieczenie pokry≈Ço",
            coinsCollected: "Zebrane monety",
            // Save'y
            saves: "Save'y",
            currentSave: "Aktualny save",
            createSave: "Nowy save",
            deleteSave: "Usu≈Ñ save",
            switchSave: "Prze≈ÇƒÖcz",
            saveName: "Nazwa save'a",
            confirmDeleteSave: "UsunƒÖƒá ten save?",
            cannotDeleteLastSave: "Nie mo≈ºna usunƒÖƒá ostatniego save'a!",
            saveCreated: "Save utworzony!",
            active: "aktywny",
            enterNewName: "Wprowad≈∫ nowƒÖ nazwƒô:",
            // Bony
            vouchers: "Bony",
            vouchersRealLife: "Kupony",
            createVoucher: "Utw√≥rz bon",
            createVoucherRealLife: "Utw√≥rz kupon",
            voucherAmount: "Kwota bonu",
            voucherMessage: "Wiadomo≈õƒá (opcjonalna)",
            redeemVoucher: "Zrealizuj bon",
            enterVoucherCode: "Wprowad≈∫ kod bonu",
            voucherRedeemed: "Bon zrealizowany!",
            invalidVoucher: "Nieprawid≈Çowy kod bonu!",
            voucherCreated: "Bon utworzony! Kod:",
            voucherFrom: "Od:",
            yourVouchers: "Twoje bony",
            noVouchers: "Brak bon√≥w",
            // Naprawa
            selectCarToRepair: "Wybierz auto do naprawy:",
            repairSelectedCar: "Napraw wybrane auto",
            repaired: "Naprawione!",
            // Bony - rozszerzone
            vouchersToSend: "Bony do wys≈Çania",
            receivedVouchers: "Otrzymane bony",
            sendVoucher: "Wy≈õlij",
            acceptVoucher: "Przyjmij",
            rejectVoucher: "Przeka≈º dalej",
            shareVoucher: "Wy≈õlij bon",
            copyLink: "Kopiuj link",
            linkCopied: "Link skopiowany!",
            cancelVoucherConfirm: "Anulowaƒá bon? PieniƒÖdze wr√≥cƒÖ na konto.",
            youReceivedVoucher: "Dosta≈Çe≈õ/a≈õ bon o warto≈õci",
            voucherAccepted: "Bon przyjƒôty!",
            noReceivedVouchers: "Brak otrzymanych bon√≥w",
            invalidAmount: "Wprowad≈∫ prawid≈ÇowƒÖ kwotƒô!",
            pendingVoucher: "Wys≈Çano - oczekuje",
            cancelVoucherConfirm: "Anulowaƒá bon?",
            voucherAlreadyUsed: "Ten bon zosta≈Ç ju≈º wykorzystany!",
            voucherExpired: "Czas minƒÖ≈Ç! Link wygas≈Ç.",
            voucherNotFound: "Nie znaleziono bonu!",
            voucherCancelled: "Ten bon zosta≈Ç anulowany przez nadawcƒô.",
            cancelAndRefund: "Anuluj (zwrot dla nadawcy)",
            cancelled: "anulowany",
            refundToSender: "Zwrot dla nadawcy",
            // System online
            onlineAccount: "Konto Online",
            notifications: "Powiadomienia",
            auctionHouse: "Dom Aukcyjny",
            browseAuctions: "PrzeglƒÖdaj",
            myAuctions: "Moje",
            createAuction: "Wystaw",
            chooseNameAndPin: "Wybierz nazwƒô i PIN (4 cyfry)",
            playerName: "Nazwa gracza",
            register: "Zarejestruj siƒô",
            login: "Zaloguj siƒô",
            logout: "Wyloguj",
            onlinePlayers: "Gracze online",
            noPlayersOnline: "Brak graczy online",
            nameTooShort: "Nazwa musi mieƒá min. 2 znaki",
            pinMustBe4: "PIN musi mieƒá 4 cyfry",
            nameTaken: "Ta nazwa jest ju≈º zajƒôta!",
            registered: "Zarejestrowano!",
            welcome: "Witaj",
            loggedIn: "Zalogowano!",
            playerNotFound: "Nie znaleziono gracza",
            deleteAccount: "Usu≈Ñ konto",
            addFriend: "Dodaj znajomego",
            friends: "Znajomi",
            noFriends: "Brak znajomych",
            sendToFriend: "Wy≈õlij do znajomego",
            noFriendsToSend: "Brak znajomych. Dodaj znajomych w Konto Online!",
            wrongPin: "B≈Çƒôdny PIN!",
            loginFirst: "Najpierw siƒô zaloguj",
            noNotifications: "Brak powiadomie≈Ñ",
            sentYouVoucher: "wys≈Ça≈Ç Ci bon",
            bidOn: "zalicytowa≈Ç",
            wantsToNegotiate: "chce negocjowaƒá",
            yourOfferAccepted: "Twoja oferta zaakceptowana!",
            yourOfferRejected: "Twoja oferta odrzucona",
            seller: "Sprzedawca",
            price: "Cena",
            buyNow: "Kup teraz",
            negotiate: "Negocjuj",
            noAuctions: "Brak aukcji",
            noMyAuctions: "Nie masz wystawionych przedmiot√≥w",
            nothingToSell: "Nie masz nic do wystawienia",
            selectToSell: "Wybierz co chcesz wystawiƒá:",
            enterPrice: "Podaj cenƒô:",
            invalidPrice: "Nieprawid≈Çowa cena",
            auctionCreated: "Wystawiono!",
            enterYourOffer: "Podaj swojƒÖ ofertƒô:",
            offerSent: "Wys≈Çano ofertƒô!",
            purchaseSuccess: "Zakup udany!",
            waitingForSeller: "Czekaj na odpowied≈∫ sprzedawcy...",
            enterPin: "Wpisz PIN",
            forgotPin: "Nie pamiƒôtam",
            allow: "Pozw√≥l",
            deny: "Odm√≥w",
            buyerForgotPin: "KupujƒÖcy nie pamiƒôta PIN",
            allowedWithoutPin: "pozwoli≈Ç kupiƒá bez PIN",
            deniedWithoutPin: "nie pozwoli≈Ç kupiƒá bez PIN",
            counterOffer: "kontr-oferta",
            enterCounterOffer: "Podaj kontr-ofertƒô:",
            negotiations: "negocjacji",
            boughtYourItem: "kupi≈Ç Tw√≥j przedmiot",
            sendToPlayer: "Wy≈õlij do gracza",
            onlineFee: "Op≈Çata: 250",
            // Aukcje pakietowe
            selectItemsToSell: "Zaznacz co chcesz wystawiƒá:",
            cars: "Auta",
            food: "Jedzenie",
            customInsurance: "W≈Çasne ubezpieczenie",
            createInsurance: "Stw√≥rz ubezpieczenie",
            selectedItems: "Wybrane",
            totalPrice: "Cena za pakiet",
            listForSale: "Wystaw na sprzeda≈º",
            noCars: "Brak aut",
            noFood: "Brak jedzenia",
            selectSomething: "Wybierz co≈õ do wystawienia!",
            insuranceName: "Nazwa ubezpieczenia",
            myInsurance: "Moje ubezpieczenie",
            whatItGives: "Co daje",
            coveragePercent: "Pokrycie napraw",
            paymentInterval: "Op≈Çata co ile minut",
            paymentAmount: "Kwota op≈Çaty",
            add: "Dodaj",
            contents: "Zawarto≈õƒá",
            creationCost: "Koszt stworzenia",
            auctionSummary: "Podsumowanie",
            sellingPrice: "Cena sprzeda≈ºy",
            youPay: "P≈Çacisz",
            confirmListing: "Wystawiƒá?",
            cost: "Koszt",
            confirmCancelAuction:
              "Anulowaƒá aukcjƒô? Przedmioty wr√≥cƒÖ do Ciebie.",
            notYourAuction: "To nie Twoja aukcja!",
            auctionCancelled: "Aukcja anulowana!",
            repairs: "napraw",
            chatWith: "Czat z",
            reply: "Odpowiedz",
            noMessages: "Brak wiadomo≈õci",
            sendToOnlinePlayer: "Wy≈õlij do gracza online",
            voucherSentTo: "Bon wys≈Çany do",
            acceptedYourVoucher: "przyjƒÖ≈Ç Tw√≥j bon",
            rejectedYourVoucher: "odrzuci≈Ç Tw√≥j bon",
            voucherRejected: "Bon odrzucony",
            sendToPlayer: "Wy≈õlij do gracza",
            enterPlayerName: "Wpisz nazwƒô gracza...",
            orSelectPlayer: "Lub wybierz z listy:",
            allPlayers: "Wszyscy gracze",
            noPlayersYet: "Brak innych graczy",
            findPlayer: "Znajd≈∫ gracza",
            nameOrCardNumber: "Numer karty (6 cyfr)...",
            cardNumber: "Numer karty",
            wantsToBeYourFriend: "chce dodaƒá Ciƒô do znajomych!",
            acceptedYourFriendRequest:
              "zaakceptowa≈Ç zaproszenie! Jeste≈õcie znajomymi.",
            rejectedYourFriendRequest: "odrzuci≈Ç zaproszenie do znajomych",
            accept: "Akceptuj",
            reject: "Odrzuƒá",
            playerNotFound: "Nie znaleziono gracza",
            cantReceiveOwnVoucher: "Nie mo≈ºesz odebraƒá w≈Çasnego bonu!",
            sent: "wys≈Çany",
            total: "≈ÇƒÖcznie",
            shippingFee: "op≈Çata za przesy≈Çkƒô",
            shippingInfo: "Online: +100 z≈Ç | 30 sek od otwarcia!",
            noShippingFee: "Bez op≈Çaty za przesy≈Çkƒô",
            // Logowanie
            loginTitle: "Zaloguj siƒô",
            loginDesc:
              "Podaj sw√≥j email ≈ºeby m√≥c wysy≈Çaƒá i odbieraƒá bony/kupony.",
            loginBtn: "Zaloguj",
            loginPrivacy:
              "Email jest zapisywany tylko lokalnie na Twoim urzƒÖdzeniu.",
            invalidEmail: "Podaj prawid≈Çowy email!",
            loggedInAs: "Zalogowany jako",
            sameEmailVoucher:
              "Nie mo≈ºesz odebraƒá bonu wys≈Çanego z tego samego konta!",
            mustLoginFirst: "Musisz siƒô najpierw zalogowaƒá!",
            shareTo: "Udostƒôpnij do:",
            sendToOtherSave: "Lub wy≈õlij na inny zapis:",
            voucherSentToSave: "Bon wys≈Çany do",
            selectSaveForVoucher: "Na kt√≥ry zapis przyjƒÖƒá bon?",
            cannotAcceptOwnVoucher: "Nie mo≈ºesz przyjƒÖƒá w≈Çasnego bonu!",
            vouchersDescription:
              "Bony to wirtualne pieniƒÖdze kt√≥re mo≈ºesz wys≈Çaƒá znajomym przez WhatsApp, Messenger, Email lub SMS. Odbiorca mo≈ºe przyjƒÖƒá bon (dostanie pieniƒÖdze) lub przekazaƒá go komu≈õ innemu.",
            // Tryb gry
            selectMode: "Wybierz tryb",
            beamngDesc: "Auta z gry BeamNG.drive - fikcyjne marki",
            simulator: "Symulator",
            reallifeDesc: "Prawdziwe marki aut w realnych cenach (-10%)",
            modeWarning: "Ka≈ºdy tryb ma osobny postƒôp na tym samym save'ie!",
            // Instrukcje
            earnDesc: "Wykonuj prace aby zarabiaƒá pieniƒÖdze:",
            driverJob: "Kierowca",
            factoryJob: "Praca w fabryce",
            sleepJob: "Sen (AFK)",
            sellCarProfit: "Sprzeda≈º auta",
            ofValue: "warto≈õci",
            garageSystem: "System gara≈ºu",
            garageDesc: "Kupuj, ulepszaj i sprzedawaj auta:",
            upgradeInfo:
              "Kliknij raz - auto ulepsza siƒô w tle. Warto≈õƒá ro≈õnie (50% ‚Üí 1000%)",
            breakRisk: "Ryzyko zepsucia",
            breakInfo:
              "0.5%/s szansy na zepsucie. Koszt: 150 z≈Ç + -5% warto≈õci",
            selling: "Sprzeda≈º",
            sellInfo: "Cena = cena bazowa √ó procent ulepszenia",
            payments: "P≈Çatno≈õci i op≈Çaty",
            autoPayInfo2:
              "W≈ÇƒÖcz w ustawieniach karty - automatycznie p≈Çaci podatki i ubezpieczenia",
            debtSystem: "System d≈Çug√≥w",
            debtInfo2: "Brak kasy = d≈Çug. Masz 7 dni na sp≈Çatƒô!",
            insurances: "Ubezpieczenia",
            insuranceDesc: "R√≥≈ºne pakiety dajƒÖce bonusy:",
            healthIns: "Zdrowotne",
            healthInsDesc: "regeneracja HP, jedzenia, picia",
            upgradeIns: "Na ulepszanie",
            upgradeInsDesc: "szybsze ulepszanie, mniejsza szansa zepsucia",
            repairIns: "Na naprawƒô",
            repairInsDesc: "pokrywa 30-100% koszt√≥w naprawy",
            survival: "Przetrwanie",
            hungerDrain: "G≈Ç√≥d",
            thirstDrain: "Pragnienie",
            survivalTip:
              "Kupuj jedzenie i napoje w sklepie, lub wykup ubezpieczenie!",
            voucherSystem: "System bon√≥w",
            voucherDesc:
              "Tw√≥rz bony pieniƒô≈ºne i wysy≈Çaj znajomym przez WhatsApp, Messenger, Email lub SMS. PieniƒÖdze pobierane sƒÖ dopiero gdy odbiorca zaakceptuje bon.",
            value: "warto≈õci",
            // Nowa instrukcja
            workSystem: "System pracy",
            workDesc: "Wybierz zaw√≥d i pracuj 2 minuty w mini-grze:",
            jobsRange: "13 zawod√≥w od ≈Çatwych do trudnych",
            coinGame: "≈Åapanie monet",
            coinGameDesc: "Klikaj spadajƒÖce monety +100 z≈Ç za ka≈ºdƒÖ!",
            sleepMechanic: "Zasypianie",
            sleepMechanicDesc:
              "Trzymaj ekran ≈ºeby nie zasnƒÖƒá! Spanie = strata do 90% zarobku",
            gameModes: "Tryby gry",
            gameModesDesc:
              "Kliknij tytu≈Ç gry aby prze≈ÇƒÖczyƒá miƒôdzy trybem BeamNG (fikcyjne auta) a Real Life (prawdziwe marki). Ka≈ºdy tryb ma osobny postƒôp!",
            coinsCollected: "Zebrane monety",
            // ≈ömierƒá i checkpointy
            youDied: "ZginƒÖ≈Çe≈õ!",
            loadingCheckpoint: "Wczytywanie ostatniego checkpointu...",
            noCheckpoint: "Brak checkpointu",
            noCheckpointReset: "Brak checkpointu - zaczynasz od nowa!",
            checkpoint: "Checkpoint",
            saveCheckpoint: "Zapisz checkpoint",
            checkpointCreated: "Checkpoint utworzony!",
            checkpointInfo: "Je≈õli zginiesz, wr√≥cisz do tego momentu.",
            confirmDeleteCheckpoint:
              "UsunƒÖƒá checkpoint? Je≈õli zginiesz, stracisz ca≈Çy postƒôp!",
            checkpointDeleted: "Checkpoint usuniƒôty!",
            noCheckpointToDelete: "Nie masz checkpointu do usuniƒôcia!",
            deathWarning: "Uwaga! Jak zdrowie spadnie do 0 - zginiesz!",
            death: "≈ömierƒá",
            deathDesc:
              "G≈Ç√≥d/woda = 0 ‚Üí tracisz HP. HP = 0 ‚Üí zginiesz i wr√≥cisz do checkpointu!",
            checkpointSystem: "System checkpoint√≥w",
            createCheckpointInfo: "Tworzenie",
            createCheckpointDesc:
              "W menu Save'√≥w kliknij 'Zapisz checkpoint' ≈ºeby zapisaƒá aktualny postƒôp",
            respawn: "Odrodzenie",
            respawnDesc:
              "Po ≈õmierci wr√≥cisz do checkpointu. Brak checkpointu = reset postƒôpu!",
          },
          en: {
            yourMoney: "YOUR MONEY",
            debt: "DEBT",
            instructions: "Instructions",
            earnKm: "Earnings (km)",
            repair: "Repair Car",
            buyCar: "Buy Car",
            sellCar: "Sell Car",
            work: "Work",
            garage: "Garage",
            business: "Business",
            createBusiness: "Create Business",
            noBusinesses: "You don't have any businesses yet",
            totalIncomeWeek: "Total income/week",
            totalExpensesWeek: "Total expenses/week",
            netProfitWeek: "Net profit/week",
            workers: "workers",
            createNextBusiness: "Create another business",
            selectCategory: "Select business category",
            businessTypes: "business types",
            back: "Back",
            backToCategories: "Back to categories",
            selectType: "select type",
            startCost: "Start cost",
            clientsPerDay: "Clients/day",
            avgIncomeClient: "Avg. income/client",
            businessName: "Business name",
            notEnoughMoneyBusiness: "You don't have enough money!",
            youNeed: "You need",
            createBusinessFor: "Create business for",
            hiredWorkers: "Hired workers",
            noWorkersYet: "You don't have any workers yet. Hire someone below!",
            candidates: "Job candidates",
            noCandidates: "No candidates. New ones will appear soon.",
            searchCandidates: "Search candidates",
            negotiateTerms: "Negotiate terms",
            expects: "Expects",
            activeClients: "Active clients",
            serve: "Serve",
            simulateDay: "Simulate work day",
            closeBusiness: "Close business",
            backToList: "Back to business list",
            reputation: "Reputation",
            acceptTerms: "Accept terms",
            proposeAmount: "Propose different amount",
            lowerBonus: "Lower commission, higher base?",
            notInterested: "Thank you, we're not interested",
            giveRaise: "Give a raise",
            needWorkers: "You need workers!",
            dayReport: "Work day",
            clients: "clients",
            afterCommission: "after commissions",
            hired: "Hired",
            workerFired: "Worker fired",
            businessClosed: "Business closed",
            businessCreated: "Business created",
            salariesIn: "Salaries in",
            cantAffordSalaries: "Can't afford salaries in",
            addedToDebt: "Added to debt",
            foundCandidates: "Found new candidates!",
            needForRecruitment: "Need for recruitment",
            chatWith: "Chat with",
            greeting1:
              "Hello! I'm {name}. I'm looking for a job as {position}.",
            greeting2:
              "Hi! My name is {name} and I'm interested in your job offer.",
            greeting3:
              "Good day. {name}, looking for employment as {position}.",
            salaryExpectation:
              "My expectations are about {salary} {currency} weekly, plus {bonus}% commission from generated profits. What do you think?",
            acceptTermsBtn: "Accept terms",
            proposeAmountBtn: "Propose different amount",
            lowerBonusBtn: "Lower commission, higher base?",
            rejectBtn: "Thank you, we're not interested",
            acceptMsg:
              "I agree to {salary} {currency}/week plus {bonus}% commission. Welcome to the team!",
            workerAcceptMsg: "Great! I'm very happy. When can I start?",
            startNowMsg: "Right away! Welcome aboard.",
            workerThanksMsg: "Thank you! I won't let you down.",
            counterOfferMsg: "I have a different financial proposal...",
            enterSalaryPrompt: "Enter proposed weekly salary:",
            sendOffer: "Send offer",
            proposeSalaryMsg: "I propose {salary} {currency} weekly.",
            workerGreatOffer: "That's a great offer! I accept!",
            workerAcceptLower:
              "A bit less than I hoped, but deal. Let's do it!",
            workerCounterOffer:
              "That's a bit low... How about meeting in the middle? {counter} {currency}?",
            workerTooLow:
              "Sorry, but that's well below my expectations. Minimum {min} {currency}.",
            lowerBonusProposal:
              "How about {salary} {currency}/week, but {bonus}% commission?",
            workerReasonable: "Hmm... that sounds reasonable. I agree!",
            workerNotGood:
              "That doesn't work for me. How about {salary} and {bonus}%? That's my final offer.",
            rejectMsg:
              "Thank you for the conversation, but we're not interested in cooperation.",
            workerUnderstandMsg:
              "I understand. Thank you for your time. Good luck!",
            backToBusinessBtn: "Back to business",
            bank: "Bank",
            takeCredit: "Take a loan",
            creditAmount: "Loan amount",
            interestRate: "Interest rate",
            monthly: "monthly",
            repaymentPeriod: "Repayment period",
            months: "months",
            monthlyPayment: "Monthly payment",
            totalToRepay: "Total to repay",
            yourCredits: "Your loans",
            noCredits: "You have no loans",
            remaining: "Remaining",
            payRate: "Pay installment",
            payOff: "Pay off",
            creditTaken: "Loan approved!",
            ratePaid: "Installment paid",
            creditPaidOff: "Loan paid off!",
            notEnoughForRate: "Not enough for installment!",
            upgrade: "Upgrade",
            sellValue: "Value",
            sell: "Sell",
            carBroken: "Car broken!",
            cantSellBroken: "Cannot sell broken car!",
            confirmSell: "Sell",
            forPrice: "for",
            sold: "Sold!",
            basePrice: "Base price",
            buyQuestion: "Buy",
            carBought: "Bought",
            upgradeCar: "Upgrading",
            startUpgrade: "Start upgrading",
            stopUpgrade: "Stop",
            upgrading: "Upgrading...",
            upgradeStopped: "Stopped",
            clickToStart: "Click to start",
            upgradeWarning: "Car may break during upgrade! ($150 + -5%)",
            carBrokeMsg: "Car broke! -$150, -5%",
            carBreakDebt: "Car break",
            buyCarFirst: "Buy a car first!",
            chooseJob: "Choose job:",
            bonuses: "bonuses",
            bonus: "bonus",
            stayAwake: "Hold to stay awake!",
            workDone: "Work done!",
            basePay: "Base pay",
            sleepPenalty: "Sleep penalty",
            total: "Total",
            taxes: "Taxes",
            card: "Beam-Pay Card",
            cardRealLife: "Real-Card",
            howToEarn: "How to earn money?",
            perKm: "Per km",
            sellCarTo: "Sell car",
            carPrice: "car price",
            fees: "Fees",
            fuel: "Fuel (max 10)",
            startFuel: "Start: 10 fuel points",
            taxesPer2km: "Taxes (per 2 km)",
            taxesPer10min: "Taxes (per 10 min)",
            repairCost: "Car repair",
            fine: "Fine",
            close: "Close",
            sendScreenshotKm: "Send screenshot with kilometers",
            clickOrDrag: "Click or drag screenshot",
            analyzing: "Analyzing...",
            collectEarnings: "Collect",
            sendScreenshotDamage: "Send screenshot of damaged car",
            repairCostInfo: "Repair cost:",
            payAndRepair: "Pay and repair",
            sendScreenshotCar: "Send screenshot with car price",
            get50percent: "You get 50%",
            buyCarBtn: "Buy",
            sellCarBtn: "Sell",
            taxInfo: "Tax info",
            taxRate: "Rate:",
            totalPaid: "Total paid:",
            nextTax: "Next tax in:",
            autoPay: "Auto pay",
            autoPayDesc: "Card pays automatically",
            debtInfo: "Debt info",
            debtDesc: "No money for tax = debt. 7 days to pay.",
            currentDebt: "Current debt:",
            payDebt: "Pay debt",
            balance: "Balance",
            cardSettings: "Card settings",
            spendingLimit: "Limit:",
            spent: "Spent:",
            remaining: "Left:",
            setLimit: "üìä Set limit",
            resetSpent: "üîÑ Reset",
            newLimit: "New limit",
            setLimitBtn: "Set",
            cancel: "Cancel",
            enterPin: "Enter PIN",
            enter6digitPin: "Enter 6-digit PIN",
            limitExceeded: "Limit exceeded!",
            pinRequired: "PIN required",
            transactionExceedsLimit: "Exceeds limit. Enter PIN.",
            enterPinBtn: "Enter PIN",
            selectLanguage: "Select language",
            daysLeft: "days left",
            notEnoughMoney: "Not enough money!",
            invalidScreenshot: "Cannot read data!",
            foundKm: "Found:",
            foundPrice: "Price:",
            noCarFound: "No car found in image!",
            enterKm: "Enter kilometers:",
            enterPrice: "Enter car price:",
            youGet50: "You get 50%:",
            youPay: "You pay:",
            generateQR: "Generate QR code",
            carName: "Car name (e.g. ETK 800)",
            carPricePlaceholder: "Price from screenshot",
            selectCarToSell: "Select car from garage:",
            sendCarPhoto: "Send photo of this car",
            noCarInGarage: "No cars in garage",
            boughtFor: "Bought for",
            inventory: "Inventory",
            health: "Health",
            food: "Food",
            water: "Water",
            foodTab: "Food",
            drinksTab: "Drinks",
            foodFull: "You can't eat more!",
            waterFull: "You can't drink more!",
            shop: "Shop",
            backpackContents: "Backpack contents:",
            emptyBackpack: "Backpack is empty",
            goToShop: "Go to shop to buy food!",
            useItem: "Use",
            tooFull: "You're full!",
            insurance: "Insurance",
            activeInsurances: "Active insurances",
            chooseInsurance: "Choose package:",
            cancelInsurance: "Cancel",
            confirmCancelWithRefund: "Cancel? Refund",
            confirmCancelNoRefund: "Cancel? No refund (used less than 3 times)",
            choosePeriod: "Choose period",
            hour: "Hour",
            day: "Day",
            week: "Week",
            month: "Month",
            perHour: "/hour",
            perDay: "/day",
            perWeek: "/week",
            perMonth: "/month",
            activated: "Activated",
            perHourShort: "/h",
            perDayShort: "/d",
            perWeekShort: "/wk",
            every: "every",
            hour: "Hour",
            day: "Day",
            week: "Week",
            remaining: "Remaining",
            expired: "Expired",
            autoPayments: "Auto payments",
            autoPayInfo: "Taxes and insurance don't count toward limit",
            autoPay: "Auto-pay",
            noActiveInsurance: "No active insurances",
            alreadyHaveInsurance: "You already have this insurance!",
            insuranceDetails: "Details",
            price: "Price",
            totalPaid: "Total paid",
            benefitsReceived: "Benefits received",
            nextPayment: "Next payment",
            refund: "refund",
            noRefund: "no refund",
            // Products - food
            itemBurger: "Burger",
            itemPizza: "Pizza",
            itemHotdog: "Hot Dog",
            itemFries: "Fries",
            itemSandwich: "Sandwich",
            itemSalad: "Salad",
            itemApple: "Apple",
            itemBanana: "Banana",
            itemWatermelon: "Watermelon",
            itemChicken: "Chicken",
            itemSteak: "Steak",
            itemSushi: "Sushi",
            itemDonut: "Donut",
            itemIcecream: "Ice cream",
            itemChocolate: "Chocolate",
            // Products - drinks
            itemWater: "Water",
            itemCola: "Cola",
            itemJuice: "Juice",
            itemCoffee: "Coffee",
            itemTea: "Tea",
            itemMilk: "Milk",
            itemBeer: "Beer",
            itemWine: "Wine",
            itemSmoothie: "Smoothie",
            itemEnergyDrink: "Energy Drink",
            itemLemonade: "Lemonade",
            itemCoconut: "Coconut water",
            // Insurance - names
            insBasic: "Basic",
            insStandard: "Standard",
            insPremium: "Premium",
            insVip: "VIP",
            insUltimate: "Ultimate",
            insHealthBasic: "Health Basic",
            insHealthPlus: "Health Plus",
            insFoodBasic: "Food Basic",
            insFoodPlus: "Food Plus",
            insWaterBasic: "Water Basic",
            insWaterPlus: "Water Plus",
            insHealthFood: "Health + Food",
            insHealthWater: "Health + Water",
            insFoodWater: "Food + Water",
            // Upgrade insurances
            insUpgradeBasic: "Upgrade Basic",
            insUpgradePlus: "Upgrade Plus",
            insUpgradePro: "Upgrade Pro",
            insUpgradeMax: "Upgrade Max",
            insUpgradeBasicDesc: "+0.05%/s, -10% break chance",
            insUpgradePlusDesc: "+0.1%/s, -20% break chance",
            insUpgradeProDesc: "+0.15%/s, -30% break chance",
            insUpgradeMaxDesc: "+0.2%/s, -40% break chance",
            // Repair insurances
            insRepairBasic: "Repair Basic",
            insRepairPlus: "Repair Plus",
            insRepairFull: "Repair Full",
            insRepairBasicDesc: "30% repair costs covered",
            insRepairPlusDesc: "50% repair costs covered",
            insRepairFullDesc: "100% repair costs covered",
            noBrokenCars: "All cars are working!",
            goToGarage: "Go to Garage to upgrade cars",
            carNotBroken: "This car is not broken!",
            repairDebt: "Car repair",
            addedToDebt: "Added to debt",
            insuranceCovered: "Insurance covered",
            coinsCollected: "Coins collected",
            // Saves
            saves: "Saves",
            currentSave: "Current save",
            createSave: "New save",
            deleteSave: "Delete save",
            switchSave: "Switch",
            saveName: "Save name",
            confirmDeleteSave: "Delete this save?",
            cannotDeleteLastSave: "Cannot delete the last save!",
            saveCreated: "Save created!",
            active: "active",
            enterNewName: "Enter new name:",
            // Vouchers
            vouchers: "Vouchers",
            vouchersRealLife: "Coupons",
            createVoucher: "Create voucher",
            createVoucherRealLife: "Create coupon",
            voucherAmount: "Voucher amount",
            voucherMessage: "Message (optional)",
            redeemVoucher: "Redeem voucher",
            enterVoucherCode: "Enter voucher code",
            voucherRedeemed: "Voucher redeemed!",
            invalidVoucher: "Invalid voucher code!",
            voucherCreated: "Voucher created! Code:",
            voucherFrom: "From:",
            yourVouchers: "Your vouchers",
            noVouchers: "No vouchers",
            // Repair
            selectCarToRepair: "Select car to repair:",
            repairSelectedCar: "Repair selected car",
            repaired: "Repaired!",
            // Vouchers - extended
            vouchersToSend: "Vouchers to send",
            receivedVouchers: "Received vouchers",
            sendVoucher: "Send",
            acceptVoucher: "Accept",
            rejectVoucher: "Pass on",
            shareVoucher: "Send voucher",
            copyLink: "Copy link",
            linkCopied: "Link copied!",
            cancelVoucherConfirm: "Cancel voucher? Money will be refunded.",
            youReceivedVoucher: "You received a voucher worth",
            voucherAccepted: "Voucher accepted!",
            noReceivedVouchers: "No received vouchers",
            invalidAmount: "Enter a valid amount!",
            pendingVoucher: "Sent - waiting",
            cancelVoucherConfirm: "Cancel voucher?",
            voucherAlreadyUsed: "This voucher has already been used!",
            voucherExpired: "Time's up! Link expired.",
            voucherNotFound: "Voucher not found!",
            voucherCancelled: "This voucher was cancelled by the sender.",
            cancelAndRefund: "Cancel (refund to sender)",
            cancelled: "cancelled",
            refundToSender: "Refund to sender",
            // Online system
            onlineAccount: "Online Account",
            notifications: "Notifications",
            auctionHouse: "Auction House",
            browseAuctions: "Browse",
            myAuctions: "My auctions",
            createAuction: "Create",
            chooseNameAndPin: "Choose name and PIN (4 digits)",
            playerName: "Player name",
            register: "Register",
            login: "Log in",
            logout: "Log out",
            onlinePlayers: "Players online",
            noPlayersOnline: "No players online",
            nameTooShort: "Name must be at least 2 characters",
            pinMustBe4: "PIN must be 4 digits",
            nameTaken: "This name is already taken!",
            registered: "Registered!",
            welcome: "Welcome",
            loggedIn: "Logged in!",
            playerNotFound: "Player not found",
            deleteAccount: "Delete account",
            addFriend: "Add friend",
            friends: "Friends",
            noFriends: "No friends",
            sendToFriend: "Send to friend",
            noFriendsToSend: "No friends. Add friends in Online Account!",
            wrongPin: "Wrong PIN!",
            loginFirst: "Log in first",
            noNotifications: "No notifications",
            sentYouVoucher: "sent you a voucher",
            bidOn: "bid on",
            wantsToNegotiate: "wants to negotiate",
            yourOfferAccepted: "Your offer was accepted!",
            yourOfferRejected: "Your offer was rejected",
            seller: "Seller",
            price: "Price",
            buyNow: "Buy now",
            negotiate: "Negotiate",
            noAuctions: "No auctions",
            noMyAuctions: "You have no listed items",
            nothingToSell: "Nothing to sell",
            selectToSell: "Select item to sell:",
            enterPrice: "Enter price:",
            invalidPrice: "Invalid price",
            auctionCreated: "Listed!",
            enterYourOffer: "Enter your offer:",
            offerSent: "Offer sent!",
            purchaseSuccess: "Purchase successful!",
            waitingForSeller: "Waiting for seller response...",
            enterPin: "Enter PIN",
            forgotPin: "Forgot PIN",
            allow: "Allow",
            deny: "Deny",
            buyerForgotPin: "Buyer forgot PIN",
            allowedWithoutPin: "allowed purchase without PIN",
            deniedWithoutPin: "denied purchase without PIN",
            counterOffer: "counter-offer",
            enterCounterOffer: "Enter counter-offer:",
            negotiations: "negotiations",
            boughtYourItem: "bought your item",
            sendToPlayer: "Send to player",
            onlineFee: "Fee: 250",
            // Package auctions
            selectItemsToSell: "Select items to sell:",
            cars: "Cars",
            food: "Food",
            customInsurance: "Custom insurance",
            createInsurance: "Create insurance",
            selectedItems: "Selected",
            totalPrice: "Package price",
            listForSale: "List for sale",
            noCars: "No cars",
            noFood: "No food",
            selectSomething: "Select something to sell!",
            insuranceName: "Insurance name",
            myInsurance: "My insurance",
            whatItGives: "What it gives",
            coveragePercent: "Repair coverage",
            paymentInterval: "Payment every X minutes",
            paymentAmount: "Payment amount",
            add: "Add",
            contents: "Contents",
            creationCost: "Creation cost",
            auctionSummary: "Summary",
            sellingPrice: "Selling price",
            youPay: "You pay",
            confirmListing: "List it?",
            cost: "Cost",
            confirmCancelAuction:
              "Cancel auction? Items will be returned to you.",
            notYourAuction: "This is not your auction!",
            auctionCancelled: "Auction cancelled!",
            repairs: "repairs",
            chatWith: "Chat with",
            reply: "Reply",
            noMessages: "No messages",
            sendToOnlinePlayer: "Send to online player",
            voucherSentTo: "Voucher sent to",
            acceptedYourVoucher: "accepted your voucher",
            rejectedYourVoucher: "rejected your voucher",
            voucherRejected: "Voucher rejected",
            sendToPlayer: "Send to player",
            enterPlayerName: "Enter player name...",
            orSelectPlayer: "Or select from list:",
            allPlayers: "All players",
            noPlayersYet: "No other players yet",
            findPlayer: "Find player",
            nameOrCardNumber: "Card number (6 digits)...",
            cardNumber: "Card number",
            wantsToBeYourFriend: "wants to add you as a friend!",
            acceptedYourFriendRequest:
              "accepted your invite! You are now friends.",
            rejectedYourFriendRequest: "rejected your friend request",
            accept: "Accept",
            reject: "Reject",
            playerNotFound: "Player not found",
            cantReceiveOwnVoucher: "You cannot receive your own voucher!",
            sent: "sent",
            total: "total",
            shippingFee: "shipping fee",
            shippingInfo: "Online: +100 fee | 30 sec from opening!",
            noShippingFee: "No shipping fee",
            // Login
            loginTitle: "Log in",
            loginDesc: "Enter your email to send and receive vouchers/coupons.",
            loginBtn: "Log in",
            loginPrivacy: "Email is saved only locally on your device.",
            invalidEmail: "Enter a valid email!",
            loggedInAs: "Logged in as",
            sameEmailVoucher:
              "You cannot receive a voucher sent from the same account!",
            mustLoginFirst: "You must log in first!",
            shareTo: "Share to:",
            sendToOtherSave: "Or send to another save:",
            voucherSentToSave: "Voucher sent to",
            selectSaveForVoucher: "Which save to accept voucher?",
            cannotAcceptOwnVoucher: "Cannot accept your own voucher!",
            vouchersDescription:
              "Vouchers are virtual money you can send to friends via WhatsApp, Messenger, Email or SMS. The recipient can accept the voucher (get the money) or pass it on to someone else.",
            // Game mode
            selectMode: "Select mode",
            beamngDesc: "Cars from BeamNG.drive game - fictional brands",
            simulator: "Simulator",
            reallifeDesc: "Real car brands at realistic prices (-10%)",
            modeWarning: "Each mode has separate progress on the same save!",
            // Instructions
            earnDesc: "Do jobs to earn money:",
            driverJob: "Driver",
            factoryJob: "Factory work",
            sleepJob: "Sleep (AFK)",
            sellCarProfit: "Sell car",
            ofValue: "of value",
            garageSystem: "Garage system",
            garageDesc: "Buy, upgrade and sell cars:",
            upgradeInfo:
              "Click once - car upgrades in background. Value grows (50% ‚Üí 1000%)",
            breakRisk: "Break risk",
            breakInfo: "0.5%/s chance to break. Cost: 150 z≈Ç + -5% value",
            selling: "Selling",
            sellInfo: "Price = base price √ó upgrade percentage",
            payments: "Payments & fees",
            autoPayInfo2:
              "Enable in card settings - auto-pays taxes and insurances",
            debtSystem: "Debt system",
            debtInfo2: "No cash = debt. You have 7 days to pay!",
            insurances: "Insurances",
            insuranceDesc: "Various packages with bonuses:",
            healthIns: "Health",
            healthInsDesc: "regenerates HP, food, water",
            upgradeIns: "Upgrade",
            upgradeInsDesc: "faster upgrading, lower break chance",
            repairIns: "Repair",
            repairInsDesc: "covers 30-100% of repair costs",
            survival: "Survival",
            hungerDrain: "Hunger",
            thirstDrain: "Thirst",
            survivalTip: "Buy food and drinks in shop, or get insurance!",
            voucherSystem: "Voucher system",
            voucherDesc:
              "Create money vouchers and send to friends via WhatsApp, Messenger, Email or SMS. Money is deducted only when recipient accepts the voucher.",
            value: "value",
            // New instructions
            workSystem: "Work system",
            workDesc: "Choose a job and work 2 minutes in mini-game:",
            jobsRange: "13 jobs from easy to hard",
            coinGame: "Catching coins",
            coinGameDesc: "Click falling coins +100 z≈Ç each!",
            sleepMechanic: "Falling asleep",
            sleepMechanicDesc:
              "Hold screen to stay awake! Sleeping = lose up to 90% of earnings",
            gameModes: "Game modes",
            gameModesDesc:
              "Click game title to switch between BeamNG mode (fictional cars) and Real Life (real brands). Each mode has separate progress!",
            coinsCollected: "Coins collected",
            // Death and checkpoints
            youDied: "You died!",
            loadingCheckpoint: "Loading last checkpoint...",
            noCheckpoint: "No checkpoint",
            noCheckpointReset: "No checkpoint - starting over!",
            checkpoint: "Checkpoint",
            saveCheckpoint: "Save checkpoint",
            checkpointCreated: "Checkpoint created!",
            checkpointInfo: "If you die, you'll return to this moment.",
            confirmDeleteCheckpoint:
              "Delete checkpoint? If you die, you'll lose all progress!",
            checkpointDeleted: "Checkpoint deleted!",
            noCheckpointToDelete: "No checkpoint to delete!",
            deathWarning: "Warning! If health drops to 0 - you die!",
            death: "Death",
            deathDesc:
              "Hunger/water = 0 ‚Üí lose HP. HP = 0 ‚Üí you die and return to checkpoint!",
            checkpointSystem: "Checkpoint system",
            createCheckpointInfo: "Creating",
            createCheckpointDesc:
              "In Saves menu click 'Save checkpoint' to save current progress",
            respawn: "Respawn",
            respawnDesc:
              "After death you'll return to checkpoint. No checkpoint = progress reset!",
          },
        };

        Object.keys(languages).forEach((lang) => {
          if (!translations[lang]) translations[lang] = translations.en;
        });

        let currentLang = localStorage.getItem("beamng_lang") || "pl";

        // ==================== SYSTEM SAVE'√ìW ====================
        let saves = JSON.parse(localStorage.getItem("beamng_saves")) || [];
        let currentSaveId = localStorage.getItem("beamng_currentSave") || null;

        // Upewnij siƒô ≈ºe jest minimum 1 save
        function ensureDefaultSave() {
          if (saves.length === 0) {
            const newSave = createNewSaveData("Save 1");
            saves.push(newSave);
            currentSaveId = newSave.id;
            localStorage.setItem("beamng_saves", JSON.stringify(saves));
            localStorage.setItem("beamng_currentSave", currentSaveId);
          }
          if (!currentSaveId || !saves.find((s) => s.id === currentSaveId)) {
            currentSaveId = saves[0].id;
            localStorage.setItem("beamng_currentSave", currentSaveId);
          }
        }

        function createNewSaveData(name) {
          return {
            id: "save_" + Date.now(),
            name: name,
            createdAt: Date.now(),
            data: {
              money: 1500,
              limit: 10000,
              spent: 0,
              debt: 0,
              debtDeadline: null,
              totalTaxPaid: 0,
              autoPay: false,
              lastTaxTime: Date.now(),
              garage: [],
              health: 100,
              food: 1000,
              water: 1000,
              backpack: [],
              lastHungerTime: Date.now(),
              insurances: [],
              vouchersToSend: [],
              receivedVouchers: [],
            },
          };
        }

        // Interwa≈Çy ulepszania aut - musi byƒá przed loadSaveData
        let upgradeIntervals = {};

        // Tryb gry - musi byƒá przed loadSaveData
        let gameMode = localStorage.getItem("beamng_gameMode") || "beamng";

        // getCurrentCars() jest zdefiniowane po listach aut (beamngCars, realLifeCars)

        function getCurrentSave() {
          return saves.find((s) => s.id === currentSaveId);
        }

        function loadSaveData() {
          const save = getCurrentSave();
          if (!save) return;

          // Zatrzymaj wszystkie aktywne ulepszania przed za≈Çadowaniem nowego save'a
          Object.keys(upgradeIntervals).forEach((idx) => {
            clearInterval(upgradeIntervals[idx]);
          });
          upgradeIntervals = {};

          // Za≈Çaduj dane wsp√≥lne (limit, autoPay, lastTaxTime)
          // cardCode jest globalny dla urzƒÖdzenia - nie ≈Çaduj z save
          const d = save.data;
          pin = cardCode;
          limit = d.limit || 10000;
          autoPay = d.autoPay || false;
          lastTaxTime = d.lastTaxTime || Date.now();
          lastHungerTime = d.lastHungerTime || Date.now();

          // Za≈Çaduj dane specyficzne dla trybu
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          const modeData = save[modeKey];

          if (modeData) {
            money = modeData.money;
            garage = modeData.garage || [];
            spent = modeData.spent || 0;
            debt = modeData.debt || 0;
            debtDeadline = modeData.debtDeadline || null;
            totalTaxPaid = modeData.totalTaxPaid || 0;
            health = modeData.health || 100;
            food = modeData.food || 1000;
            water = modeData.water || 1000;
            backpack = modeData.backpack || [];
            activeInsurances = modeData.activeInsurances || [];
          } else {
            // Fallback do starych danych lub nowy start
            money = d.money || 1500;
            garage = d.garage || [];
            spent = d.spent || 0;
            debt = d.debt || 0;
            debtDeadline = d.debtDeadline || null;
            totalTaxPaid = d.totalTaxPaid || 0;
            health = d.health || 100;
            food = d.food || 1000;
            water = d.water || 1000;
            backpack = d.backpack || [];
            activeInsurances = d.insurances || [];
          }

          // Wzn√≥w ulepszania aut
          resumeUpgrades();
        }

        function saveSaveData() {
          const save = getCurrentSave();
          if (!save) return;

          // Zapisz dane wsp√≥lne (cardCode jest globalny w localStorage)
          save.data.limit = limit;
          save.data.autoPay = autoPay;
          save.data.lastTaxTime = lastTaxTime;
          save.data.lastHungerTime = lastHungerTime;

          // Zapisz dane specyficzne dla trybu
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          save[modeKey] = {
            money: money,
            garage: [...garage],
            spent: spent,
            debt: debt,
            debtDeadline: debtDeadline,
            totalTaxPaid: totalTaxPaid,
            health: health,
            food: food,
            water: water,
            backpack: [...backpack],
            activeInsurances: [...activeInsurances],
          };

          // Zachowaj te≈º vouchery (te sƒÖ wsp√≥lne)
          if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
          if (!save.data.receivedVouchers) save.data.receivedVouchers = [];

          localStorage.setItem("beamng_saves", JSON.stringify(saves));
        }

        function createSave(name) {
          const newSave = createNewSaveData(name);
          saves.push(newSave);
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          return newSave;
        }

        function deleteSave(saveId) {
          if (saves.length <= 1) {
            alert(
              translations[currentLang].cannotDeleteLastSave ||
                "Nie mo≈ºna usunƒÖƒá ostatniego save!"
            );
            return false;
          }
          const idx = saves.findIndex((s) => s.id === saveId);
          if (idx === -1) return false;

          saves.splice(idx, 1);
          localStorage.setItem("beamng_saves", JSON.stringify(saves));

          if (currentSaveId === saveId) {
            currentSaveId = saves[0].id;
            localStorage.setItem("beamng_currentSave", currentSaveId);
            loadSaveData();
          }
          return true;
        }

        function switchSave(saveId) {
          if (currentSaveId === saveId) return;

          // Zapisz obecny stan
          saveSaveData();

          // Prze≈ÇƒÖcz na nowy save
          currentSaveId = saveId;
          localStorage.setItem("beamng_currentSave", currentSaveId);

          // Za≈Çaduj dane nowego save'a
          loadSaveData();
          updateAllDisplays();
        }

        // ==================== D≈πWIƒòKI ====================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
          if (!audioCtx) {
            audioCtx = new AudioContext();
          }
          if (audioCtx.state === "suspended") {
            audioCtx.resume();
          }
        }

        // Generowanie d≈∫wiƒôk√≥w syntetycznych
        function playSound(type) {
          initAudio();
          if (!audioCtx) return;

          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);

          switch (type) {
            case "coin": // Z≈Çapanie monety - wysoki d≈∫wiƒôk
              oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(
                1760,
                audioCtx.currentTime + 0.1
              );
              gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.15
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.15);
              break;

            case "buy": // Kupno - kasa
              oscillator.frequency.setValueAtTime(523, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                659,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                784,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.3
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.3);
              break;

            case "sell": // Sprzeda≈º - cha-ching
              oscillator.frequency.setValueAtTime(1318, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                1568,
                audioCtx.currentTime + 0.08
              );
              gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.2
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.2);
              break;

            case "error": // B≈ÇƒÖd - niski d≈∫wiƒôk
              oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(
                100,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.25
              );
              oscillator.type = "sawtooth";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.25);
              break;

            case "success": // Sukces - fanfara
              oscillator.frequency.setValueAtTime(523, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                659,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                784,
                audioCtx.currentTime + 0.2
              );
              oscillator.frequency.setValueAtTime(
                1047,
                audioCtx.currentTime + 0.3
              );
              gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.5
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.5);
              break;

            case "click": // Klikniƒôcie przycisku
              oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
              gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.05
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.05);
              break;

            case "eat": // Jedzenie
              oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                350,
                audioCtx.currentTime + 0.05
              );
              oscillator.frequency.setValueAtTime(
                300,
                audioCtx.currentTime + 0.1
              );
              gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.15
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.15);
              break;

            case "drink": // Picie
              oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(
                200,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.25
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.25);
              break;

            case "repair": // Naprawa
              oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                400,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                300,
                audioCtx.currentTime + 0.2
              );
              oscillator.frequency.setValueAtTime(
                500,
                audioCtx.currentTime + 0.3
              );
              gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.4
              );
              oscillator.type = "square";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.4);
              break;

            case "break": // Zepsucie
              oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(
                50,
                audioCtx.currentTime + 0.5
              );
              gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.5
              );
              oscillator.type = "sawtooth";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.5);
              break;

            case "upgrade": // Ulepszenie tick
              oscillator.frequency.setValueAtTime(
                800 + Math.random() * 200,
                audioCtx.currentTime
              );
              gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.05
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.05);
              break;

            case "workStart": // Start pracy
              oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                554,
                audioCtx.currentTime + 0.15
              );
              oscillator.frequency.setValueAtTime(
                659,
                audioCtx.currentTime + 0.3
              );
              gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.45
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.45);
              break;

            case "workEnd": // Koniec pracy
              oscillator.frequency.setValueAtTime(659, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                784,
                audioCtx.currentTime + 0.15
              );
              oscillator.frequency.setValueAtTime(
                1047,
                audioCtx.currentTime + 0.3
              );
              gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.5
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.5);
              break;

            case "voucher": // Bon
              oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                1100,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                1320,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.35
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.35);
              break;

            case "insurance": // Ubezpieczenie
              oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                600,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                700,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.3
              );
              oscillator.type = "triangle";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.3);
              break;
          }
        }

        // ==================== STAN GRY ====================
        let money = 1500;
        // Kod karty - globalny dla urzƒÖdzenia (nie per save)
        let cardCode = localStorage.getItem("beamng_device_card_code");
        if (!cardCode) {
          cardCode = generateCardCodeSync();
          localStorage.setItem("beamng_device_card_code", cardCode);
        }
        let pin = cardCode;
        let limit = 10000;
        let spent = 0;
        let debt = 0;
        let debtDeadline = null;
        let totalTaxPaid = 0;
        let autoPay = false;
        let lastTaxTime = Date.now();
        let garage = [];

        // Jedzenie/Picie/Zdrowie
        let health = 100;
        let food = 1000;
        let water = 1000;
        let backpack = [];
        let lastHungerTime = Date.now();
        const MAX_HEALTH = 100;
        const MAX_FOOD = 1000;
        const MAX_WATER = 1000;
        const HUNGER_INTERVAL = 5 * 60 * 1000; // Co 5 minut
        const FOOD_DECAY = 50; // -50 kcal co 5 min
        const WATER_DECAY = 80; // -80 ml co 5 min

        // Ubezpieczenia - wiele aktywnych, p≈Çatno≈õci cykliczne (godzina/dzie≈Ñ/tydzie≈Ñ)
        let activeInsurances = [];

        const insurancePackages = [
          // Combo
          {
            id: "basic",
            nameKey: "insBasic",
            icon: "üíä",
            prices: { hour: 50, day: 200, week: 1000 },
            interval: 10,
            benefits: { hp: 3, kcal: 20, ml: 30 },
            descKey: "insBasicDesc",
          },

          {
            id: "standard",
            nameKey: "insStandard",
            icon: "üè•",
            prices: { hour: 100, day: 400, week: 2000 },
            interval: 10,
            benefits: { hp: 5, kcal: 40, ml: 50 },
            descKey: "insStandardDesc",
          },

          {
            id: "premium",
            nameKey: "insPremium",
            icon: "‚≠ê",
            prices: { hour: 180, day: 700, week: 3500 },
            interval: 8,
            benefits: { hp: 8, kcal: 50, ml: 60 },
            descKey: "insPremiumDesc",
          },

          {
            id: "vip",
            nameKey: "insVip",
            icon: "üëë",
            prices: { hour: 300, day: 1200, week: 6000 },
            interval: 5,
            benefits: { hp: 10, kcal: 60, ml: 80 },
            descKey: "insVipDesc",
          },

          {
            id: "ultimate",
            nameKey: "insUltimate",
            icon: "üíé",
            prices: { hour: 500, day: 2000, week: 10000 },
            interval: 5,
            benefits: { hp: 15, kcal: 80, ml: 100 },
            descKey: "insUltimateDesc",
          },

          // Zdrowie
          {
            id: "health_basic",
            nameKey: "insHealthBasic",
            icon: "‚ù§Ô∏è",
            prices: { hour: 40, day: 150, week: 800 },
            interval: 10,
            benefits: { hp: 8, kcal: 0, ml: 0 },
            descKey: "insHealthBasicDesc",
          },

          {
            id: "health_plus",
            nameKey: "insHealthPlus",
            icon: "‚ù§Ô∏è‚Äçüî•",
            prices: { hour: 80, day: 300, week: 1500 },
            interval: 8,
            benefits: { hp: 15, kcal: 0, ml: 0 },
            descKey: "insHealthPlusDesc",
          },

          // Jedzenie
          {
            id: "food_basic",
            nameKey: "insFoodBasic",
            icon: "üçû",
            prices: { hour: 30, day: 120, week: 600 },
            interval: 10,
            benefits: { hp: 0, kcal: 60, ml: 0 },
            descKey: "insFoodBasicDesc",
          },

          {
            id: "food_plus",
            nameKey: "insFoodPlus",
            icon: "üçî",
            prices: { hour: 70, day: 280, week: 1400 },
            interval: 8,
            benefits: { hp: 0, kcal: 120, ml: 0 },
            descKey: "insFoodPlusDesc",
          },

          // Picie
          {
            id: "water_basic",
            nameKey: "insWaterBasic",
            icon: "üíß",
            prices: { hour: 25, day: 100, week: 500 },
            interval: 10,
            benefits: { hp: 0, kcal: 0, ml: 80 },
            descKey: "insWaterBasicDesc",
          },

          {
            id: "water_plus",
            nameKey: "insWaterPlus",
            icon: "üåä",
            prices: { hour: 60, day: 250, week: 1200 },
            interval: 8,
            benefits: { hp: 0, kcal: 0, ml: 150 },
            descKey: "insWaterPlusDesc",
          },

          // Mix 2 w 1
          {
            id: "health_food",
            nameKey: "insHealthFood",
            icon: "üçé",
            prices: { hour: 60, day: 250, week: 1200 },
            interval: 10,
            benefits: { hp: 5, kcal: 50, ml: 0 },
            descKey: "insHealthFoodDesc",
          },

          {
            id: "health_water",
            nameKey: "insHealthWater",
            icon: "üí¶",
            prices: { hour: 55, day: 220, week: 1100 },
            interval: 10,
            benefits: { hp: 5, kcal: 0, ml: 60 },
            descKey: "insHealthWaterDesc",
          },

          {
            id: "food_water",
            nameKey: "insFoodWater",
            icon: "ü•ó",
            prices: { hour: 50, day: 200, week: 1000 },
            interval: 10,
            benefits: { hp: 0, kcal: 50, ml: 60 },
            descKey: "insFoodWaterDesc",
          },

          // === UBEZPIECZENIA NA ULEPSZANIE AUT ===
          {
            id: "upgrade_basic",
            nameKey: "insUpgradeBasic",
            icon: "üîß",
            type: "upgrade",
            prices: { hour: 80, day: 300, week: 1500 },
            rateBonus: 0.05,
            safetyBonus: 0.001,
            descKey: "insUpgradeBasicDesc",
          },

          {
            id: "upgrade_plus",
            nameKey: "insUpgradePlus",
            icon: "‚öôÔ∏è",
            type: "upgrade",
            prices: { hour: 150, day: 600, week: 3000 },
            rateBonus: 0.1,
            safetyBonus: 0.002,
            descKey: "insUpgradePlusDesc",
          },

          {
            id: "upgrade_pro",
            nameKey: "insUpgradePro",
            icon: "üõ†Ô∏è",
            type: "upgrade",
            prices: { hour: 250, day: 1000, week: 5000 },
            rateBonus: 0.15,
            safetyBonus: 0.003,
            descKey: "insUpgradeProDesc",
          },

          {
            id: "upgrade_max",
            nameKey: "insUpgradeMax",
            icon: "üèéÔ∏è",
            type: "upgrade",
            prices: { hour: 400, day: 1600, week: 8000 },
            rateBonus: 0.2,
            safetyBonus: 0.004,
            descKey: "insUpgradeMaxDesc",
          },

          // === UBEZPIECZENIA NA NAPRAWƒò ===
          {
            id: "repair_basic",
            nameKey: "insRepairBasic",
            icon: "ü©π",
            type: "repair",
            prices: { hour: 30, day: 120, week: 600 },
            coveragePercent: 30,
            descKey: "insRepairBasicDesc",
          },

          {
            id: "repair_plus",
            nameKey: "insRepairPlus",
            icon: "üèóÔ∏è",
            type: "repair",
            prices: { hour: 60, day: 240, week: 1200 },
            coveragePercent: 50,
            descKey: "insRepairPlusDesc",
          },

          {
            id: "repair_full",
            nameKey: "insRepairFull",
            icon: "üõ°Ô∏è",
            type: "repair",
            prices: { hour: 100, day: 400, week: 2000 },
            coveragePercent: 100,
            descKey: "insRepairFullDesc",
          },
        ];

        // Funkcja do pobierania nazwy ubezpieczenia
        function getInsuranceName(pkg) {
          const t = translations[currentLang] || translations.en;
          return t[pkg.nameKey] || pkg.nameKey;
        }

        function getInsuranceDesc(pkg) {
          const t = translations[currentLang] || translations.en;
          if (t[pkg.descKey]) return t[pkg.descKey];

          if (pkg.type === "upgrade") {
            return `+${pkg.rateBonus}%/s, -${Math.floor(
              ((pkg.safetyBonus * 1000) / 0.005) * 10
            )}% ${t.breakChance || "szansy zepsucia"}`;
          }
          if (pkg.type === "repair") {
            return `${pkg.coveragePercent}% ${
              t.repairCovered || "koszt√≥w naprawy pokryte"
            }`;
          }

          return `+${pkg.benefits.hp} HP, +${pkg.benefits.kcal} kcal, +${pkg.benefits.ml} ml`;
        }

        let currentPin = "";
        let pendingAction = null;
        let currentEarnAmount = 0;
        let currentBuyPrice = 0;
        let currentSellPrice = 0;
        let selectedCarIndex = -1;
        const REPAIR_COST = 5000;

        // Produkty - jedzenie
        const foodItems = [
          {
            id: "burger",
            icon: "üçî",
            nameKey: "itemBurger",
            price: 150,
            kcal: 350,
            ml: 0,
            hp: -5,
          },
          {
            id: "pizza",
            icon: "üçï",
            nameKey: "itemPizza",
            price: 200,
            kcal: 400,
            ml: 0,
            hp: -5,
          },
          {
            id: "hotdog",
            icon: "üå≠",
            nameKey: "itemHotdog",
            price: 100,
            kcal: 250,
            ml: 0,
            hp: -3,
          },
          {
            id: "fries",
            icon: "üçü",
            nameKey: "itemFries",
            price: 80,
            kcal: 300,
            ml: 0,
            hp: -5,
          },
          {
            id: "sandwich",
            icon: "ü•™",
            nameKey: "itemSandwich",
            price: 120,
            kcal: 280,
            ml: 0,
            hp: 0,
          },
          {
            id: "salad",
            icon: "ü•ó",
            nameKey: "itemSalad",
            price: 180,
            kcal: 150,
            ml: 50,
            hp: 10,
          },
          {
            id: "apple",
            icon: "üçé",
            nameKey: "itemApple",
            price: 30,
            kcal: 80,
            ml: 50,
            hp: 5,
          },
          {
            id: "banana",
            icon: "üçå",
            nameKey: "itemBanana",
            price: 25,
            kcal: 100,
            ml: 20,
            hp: 3,
          },
          {
            id: "watermelon",
            icon: "üçâ",
            nameKey: "itemWatermelon",
            price: 60,
            kcal: 50,
            ml: 200,
            hp: 8,
          },
          {
            id: "chicken",
            icon: "üçó",
            nameKey: "itemChicken",
            price: 220,
            kcal: 350,
            ml: 0,
            hp: 5,
          },
          {
            id: "steak",
            icon: "ü•©",
            nameKey: "itemSteak",
            price: 350,
            kcal: 450,
            ml: 0,
            hp: 10,
          },
          {
            id: "sushi",
            icon: "üç£",
            nameKey: "itemSushi",
            price: 280,
            kcal: 200,
            ml: 30,
            hp: 8,
          },
          {
            id: "donut",
            icon: "üç©",
            nameKey: "itemDonut",
            price: 40,
            kcal: 250,
            ml: 0,
            hp: -8,
          },
          {
            id: "icecream",
            icon: "üç¶",
            nameKey: "itemIcecream",
            price: 50,
            kcal: 200,
            ml: 30,
            hp: -3,
          },
          {
            id: "chocolate",
            icon: "üç´",
            nameKey: "itemChocolate",
            price: 35,
            kcal: 300,
            ml: 0,
            hp: -5,
          },
        ];

        // Produkty - napoje
        const drinkItems = [
          {
            id: "water",
            icon: "üíß",
            nameKey: "itemWater",
            price: 20,
            kcal: 0,
            ml: 500,
            hp: 5,
          },
          {
            id: "cola",
            icon: "ü•§",
            nameKey: "itemCola",
            price: 40,
            kcal: 150,
            ml: 330,
            hp: -5,
          },
          {
            id: "juice",
            icon: "üßÉ",
            nameKey: "itemJuice",
            price: 50,
            kcal: 100,
            ml: 250,
            hp: 3,
          },
          {
            id: "coffee",
            icon: "‚òï",
            nameKey: "itemCoffee",
            price: 60,
            kcal: 20,
            ml: 200,
            hp: 0,
          },
          {
            id: "tea",
            icon: "üçµ",
            nameKey: "itemTea",
            price: 40,
            kcal: 5,
            ml: 250,
            hp: 5,
          },
          {
            id: "milk",
            icon: "ü•õ",
            nameKey: "itemMilk",
            price: 35,
            kcal: 80,
            ml: 300,
            hp: 5,
          },
          {
            id: "beer",
            icon: "üç∫",
            nameKey: "itemBeer",
            price: 80,
            kcal: 150,
            ml: 500,
            hp: -10,
          },
          {
            id: "wine",
            icon: "üç∑",
            nameKey: "itemWine",
            price: 150,
            kcal: 120,
            ml: 150,
            hp: -8,
          },
          {
            id: "smoothie",
            icon: "ü•§",
            nameKey: "itemSmoothie",
            price: 100,
            kcal: 180,
            ml: 400,
            hp: 10,
          },
          {
            id: "energydrink",
            icon: "‚ö°",
            nameKey: "itemEnergyDrink",
            price: 70,
            kcal: 100,
            ml: 250,
            hp: -15,
          },
          {
            id: "lemonade",
            icon: "üçã",
            nameKey: "itemLemonade",
            price: 45,
            kcal: 80,
            ml: 300,
            hp: 3,
          },
          {
            id: "coconut",
            icon: "ü••",
            nameKey: "itemCoconut",
            price: 90,
            kcal: 50,
            ml: 350,
            hp: 8,
          },
        ];

        // Funkcja do pobierania nazwy produktu
        function getItemName(item) {
          const t = translations[currentLang] || translations.en;
          return t[item.nameKey] || item.nameKey;
        }

        let currentShopTab = "food";

        // Lista wszystkich aut z BeamNG.drive z cenami
        const beamngCars = [
          // Autobello
          {
            id: "autobuggy",
            brand: "Autobello",
            model: "Autobuggy",
            year: "2018-2022",
            price: 45000,
            type: "buggy",
          },
          {
            id: "piccolina",
            brand: "Autobello",
            model: "Piccolina",
            year: "1957-1973",
            price: 8000,
            type: "classic",
          },
          {
            id: "stambecco",
            brand: "Autobello",
            model: "Stambecco",
            year: "1971-1988",
            price: 15000,
            type: "offroad",
          },

          // Bruckell
          {
            id: "bastion",
            brand: "Bruckell",
            model: "Bastion",
            year: "2016-2022",
            price: 42000,
            type: "muscle",
          },
          {
            id: "legran",
            brand: "Bruckell",
            model: "LeGran",
            year: "1984-1993",
            price: 12000,
            type: "sedan",
          },
          {
            id: "moonhawk",
            brand: "Bruckell",
            model: "Moonhawk",
            year: "1973-1978",
            price: 25000,
            type: "muscle",
          },
          {
            id: "nine",
            brand: "Bruckell",
            model: "Nine",
            year: "1933-1934",
            price: 35000,
            type: "classic",
          },

          // Burnside
          {
            id: "special",
            brand: "Burnside",
            model: "Special",
            year: "1952-1954",
            price: 28000,
            type: "classic",
          },

          // Cherrier
          {
            id: "tograc",
            brand: "Cherrier",
            model: "Tograc",
            year: "2020-2024",
            price: 38000,
            type: "suv",
          },
          {
            id: "vivace",
            brand: "Cherrier",
            model: "Vivace",
            year: "2020-2024",
            price: 32000,
            type: "hatchback",
          },

          // Civetta
          {
            id: "bolide",
            brand: "Civetta",
            model: "Bolide",
            year: "1981-1988",
            price: 85000,
            type: "supercar",
          },
          {
            id: "scintilla",
            brand: "Civetta",
            model: "Scintilla",
            year: "2020-2022",
            price: 120000,
            type: "supercar",
          },

          // ETK
          {
            id: "etk800",
            brand: "ETK",
            model: "800 Series",
            year: "2013-2018",
            price: 55000,
            type: "sedan",
          },
          {
            id: "etkiseries",
            brand: "ETK",
            model: "I-Series",
            year: "1985-1993",
            price: 18000,
            type: "coupe",
          },
          {
            id: "etkkseries",
            brand: "ETK",
            model: "K-Series",
            year: "2015-2021",
            price: 75000,
            type: "suv",
          },

          // FPU
          {
            id: "wydra",
            brand: "FPU",
            model: "Wydra",
            year: "2008-2023",
            price: 22000,
            type: "military",
          },

          // Gavril
          {
            id: "barstow",
            brand: "Gavril",
            model: "Barstow",
            year: "1969-1971",
            price: 35000,
            type: "muscle",
          },
          {
            id: "bluebuck",
            brand: "Gavril",
            model: "Bluebuck",
            year: "1962-1963",
            price: 32000,
            type: "classic",
          },
          {
            id: "dseries",
            brand: "Gavril",
            model: "D-Series",
            year: "1986-2003",
            price: 28000,
            type: "pickup",
          },
          {
            id: "grandmarshal",
            brand: "Gavril",
            model: "Grand Marshal",
            year: "1990-1997",
            price: 18000,
            type: "sedan",
          },
          {
            id: "hseries",
            brand: "Gavril",
            model: "H-Series",
            year: "1993-2017",
            price: 35000,
            type: "van",
          },
          {
            id: "roamer",
            brand: "Gavril",
            model: "Roamer",
            year: "1992-2005",
            price: 32000,
            type: "suv",
          },
          {
            id: "tseries",
            brand: "Gavril",
            model: "T-Series",
            year: "1972-1986",
            price: 65000,
            type: "truck",
          },
          {
            id: "mdseries",
            brand: "Gavril",
            model: "MD-Series",
            year: "1986-1998",
            price: 45000,
            type: "truck",
          },

          // Hirochi
          {
            id: "aurata",
            brand: "Hirochi",
            model: "Aurata",
            year: "2016-2022",
            price: 42000,
            type: "sport",
          },
          {
            id: "esbr",
            brand: "Hirochi",
            model: "eSBR",
            year: "2013-2020",
            price: 95000,
            type: "electric",
          },
          {
            id: "sbr4",
            brand: "Hirochi",
            model: "SBR4",
            year: "2013-2020",
            price: 68000,
            type: "sport",
          },
          {
            id: "sunburst",
            brand: "Hirochi",
            model: "Sunburst",
            year: "2009-2014",
            price: 28000,
            type: "sport",
          },

          // Ibishu
          {
            id: "200bx",
            brand: "Ibishu",
            model: "200BX",
            year: "1990-1994",
            price: 15000,
            type: "coupe",
          },
          {
            id: "240bx",
            brand: "Ibishu",
            model: "240BX",
            year: "1990-1994",
            price: 18000,
            type: "coupe",
          },
          {
            id: "covet",
            brand: "Ibishu",
            model: "Covet",
            year: "1986-1992",
            price: 8000,
            type: "hatchback",
          },
          {
            id: "diana",
            brand: "Ibishu",
            model: "Diana",
            year: "1990-1994",
            price: 12000,
            type: "sedan",
          },
          {
            id: "hopper",
            brand: "Ibishu",
            model: "Hopper",
            year: "1989-2001",
            price: 18000,
            type: "offroad",
          },
          {
            id: "miramar",
            brand: "Ibishu",
            model: "Miramar",
            year: "1963-1994",
            price: 22000,
            type: "classic",
          },
          {
            id: "pessima",
            brand: "Ibishu",
            model: "Pessima",
            year: "1988-2000",
            price: 10000,
            type: "sedan",
          },
          {
            id: "pigeon",
            brand: "Ibishu",
            model: "Pigeon",
            year: "1980-1989",
            price: 3000,
            type: "microcar",
          },
          {
            id: "wigeon",
            brand: "Ibishu",
            model: "Wigeon",
            year: "1980-1989",
            price: 4500,
            type: "microcar",
          },

          // Soliad
          {
            id: "wendover",
            brand: "Soliad",
            model: "Wendover",
            year: "1987-1995",
            price: 14000,
            type: "sedan",
          },
          {
            id: "lansdale",
            brand: "Soliad",
            model: "Lansdale",
            year: "1996-2007",
            price: 22000,
            type: "sedan",
          },

          // SP
          {
            id: "dunekicker",
            brand: "SP",
            model: "Dunekicker",
            year: "2008",
            price: 55000,
            type: "buggy",
          },
          {
            id: "rockbasher",
            brand: "SP",
            model: "Rockbasher",
            year: "2008-2018",
            price: 48000,
            type: "offroad",
          },

          // Wentward
          {
            id: "dt40l",
            brand: "Wentward",
            model: "DT40L",
            year: "1987-1996",
            price: 85000,
            type: "bus",
          },
        ];

        // Lista prawdziwych aut dla trybu Real Life (ceny realne -10%)
        const realLifeCars = [
          // Ma≈Çe / Miejskie
          {
            id: "fiat500",
            brand: "Fiat",
            model: "500",
            year: "2020-2024",
            price: 54000,
            type: "microcar",
          },
          {
            id: "toyota_yaris",
            brand: "Toyota",
            model: "Yaris",
            year: "2020-2024",
            price: 72000,
            type: "hatchback",
          },
          {
            id: "vw_polo",
            brand: "Volkswagen",
            model: "Polo",
            year: "2021-2024",
            price: 81000,
            type: "hatchback",
          },
          {
            id: "skoda_fabia",
            brand: "≈†koda",
            model: "Fabia",
            year: "2021-2024",
            price: 67500,
            type: "hatchback",
          },
          {
            id: "opel_corsa",
            brand: "Opel",
            model: "Corsa",
            year: "2020-2024",
            price: 63000,
            type: "hatchback",
          },

          // Kompaktowe
          {
            id: "vw_golf",
            brand: "Volkswagen",
            model: "Golf",
            year: "2020-2024",
            price: 117000,
            type: "hatchback",
          },
          {
            id: "toyota_corolla",
            brand: "Toyota",
            model: "Corolla",
            year: "2020-2024",
            price: 108000,
            type: "sedan",
          },
          {
            id: "mazda3",
            brand: "Mazda",
            model: "3",
            year: "2020-2024",
            price: 99000,
            type: "hatchback",
          },
          {
            id: "honda_civic",
            brand: "Honda",
            model: "Civic",
            year: "2022-2024",
            price: 126000,
            type: "sedan",
          },
          {
            id: "ford_focus",
            brand: "Ford",
            model: "Focus",
            year: "2019-2023",
            price: 90000,
            type: "hatchback",
          },

          // Sedany
          {
            id: "bmw_3",
            brand: "BMW",
            model: "3 Series",
            year: "2020-2024",
            price: 189000,
            type: "sedan",
          },
          {
            id: "mercedes_c",
            brand: "Mercedes-Benz",
            model: "C-Class",
            year: "2021-2024",
            price: 207000,
            type: "sedan",
          },
          {
            id: "audi_a4",
            brand: "Audi",
            model: "A4",
            year: "2020-2024",
            price: 180000,
            type: "sedan",
          },
          {
            id: "skoda_octavia",
            brand: "≈†koda",
            model: "Octavia",
            year: "2020-2024",
            price: 108000,
            type: "sedan",
          },
          {
            id: "toyota_camry",
            brand: "Toyota",
            model: "Camry",
            year: "2020-2024",
            price: 144000,
            type: "sedan",
          },

          // SUV
          {
            id: "toyota_rav4",
            brand: "Toyota",
            model: "RAV4",
            year: "2020-2024",
            price: 162000,
            type: "suv",
          },
          {
            id: "vw_tiguan",
            brand: "Volkswagen",
            model: "Tiguan",
            year: "2020-2024",
            price: 153000,
            type: "suv",
          },
          {
            id: "bmw_x3",
            brand: "BMW",
            model: "X3",
            year: "2021-2024",
            price: 243000,
            type: "suv",
          },
          {
            id: "mercedes_glc",
            brand: "Mercedes-Benz",
            model: "GLC",
            year: "2020-2024",
            price: 252000,
            type: "suv",
          },
          {
            id: "audi_q5",
            brand: "Audi",
            model: "Q5",
            year: "2020-2024",
            price: 234000,
            type: "suv",
          },
          {
            id: "volvo_xc60",
            brand: "Volvo",
            model: "XC60",
            year: "2020-2024",
            price: 225000,
            type: "suv",
          },
          {
            id: "hyundai_tucson",
            brand: "Hyundai",
            model: "Tucson",
            year: "2021-2024",
            price: 135000,
            type: "suv",
          },
          {
            id: "kia_sportage",
            brand: "Kia",
            model: "Sportage",
            year: "2022-2024",
            price: 126000,
            type: "suv",
          },

          // Sportowe
          {
            id: "porsche_911",
            brand: "Porsche",
            model: "911 Carrera",
            year: "2020-2024",
            price: 630000,
            type: "sport",
          },
          {
            id: "bmw_m4",
            brand: "BMW",
            model: "M4",
            year: "2021-2024",
            price: 450000,
            type: "sport",
          },
          {
            id: "audi_rs6",
            brand: "Audi",
            model: "RS6 Avant",
            year: "2020-2024",
            price: 585000,
            type: "sport",
          },
          {
            id: "mercedes_amg_gt",
            brand: "Mercedes-AMG",
            model: "GT",
            year: "2020-2024",
            price: 720000,
            type: "supercar",
          },
          {
            id: "ford_mustang",
            brand: "Ford",
            model: "Mustang GT",
            year: "2020-2024",
            price: 270000,
            type: "muscle",
          },
          {
            id: "chevrolet_camaro",
            brand: "Chevrolet",
            model: "Camaro SS",
            year: "2020-2024",
            price: 243000,
            type: "muscle",
          },
          {
            id: "nissan_gtr",
            brand: "Nissan",
            model: "GT-R",
            year: "2020-2024",
            price: 540000,
            type: "sport",
          },
          {
            id: "toyota_supra",
            brand: "Toyota",
            model: "GR Supra",
            year: "2020-2024",
            price: 270000,
            type: "sport",
          },

          // Elektryczne
          {
            id: "tesla_model3",
            brand: "Tesla",
            model: "Model 3",
            year: "2020-2024",
            price: 180000,
            type: "electric",
          },
          {
            id: "tesla_modelS",
            brand: "Tesla",
            model: "Model S",
            year: "2020-2024",
            price: 450000,
            type: "electric",
          },
          {
            id: "bmw_i4",
            brand: "BMW",
            model: "i4",
            year: "2022-2024",
            price: 270000,
            type: "electric",
          },
          {
            id: "mercedes_eqs",
            brand: "Mercedes-Benz",
            model: "EQS",
            year: "2022-2024",
            price: 540000,
            type: "electric",
          },
          {
            id: "porsche_taycan",
            brand: "Porsche",
            model: "Taycan",
            year: "2020-2024",
            price: 450000,
            type: "electric",
          },

          // Pickupy / Terenowe
          {
            id: "ford_ranger",
            brand: "Ford",
            model: "Ranger",
            year: "2020-2024",
            price: 180000,
            type: "pickup",
          },
          {
            id: "toyota_hilux",
            brand: "Toyota",
            model: "Hilux",
            year: "2020-2024",
            price: 189000,
            type: "pickup",
          },
          {
            id: "jeep_wrangler",
            brand: "Jeep",
            model: "Wrangler",
            year: "2020-2024",
            price: 270000,
            type: "offroad",
          },
          {
            id: "land_rover_defender",
            brand: "Land Rover",
            model: "Defender",
            year: "2020-2024",
            price: 315000,
            type: "offroad",
          },

          // Vany / Dostawcze
          {
            id: "vw_transporter",
            brand: "Volkswagen",
            model: "Transporter",
            year: "2020-2024",
            price: 180000,
            type: "van",
          },
          {
            id: "ford_transit",
            brand: "Ford",
            model: "Transit",
            year: "2020-2024",
            price: 162000,
            type: "van",
          },
          {
            id: "mercedes_sprinter",
            brand: "Mercedes-Benz",
            model: "Sprinter",
            year: "2020-2024",
            price: 189000,
            type: "van",
          },

          // Luksusowe
          {
            id: "bmw_7",
            brand: "BMW",
            model: "7 Series",
            year: "2020-2024",
            price: 450000,
            type: "sedan",
          },
          {
            id: "mercedes_s",
            brand: "Mercedes-Benz",
            model: "S-Class",
            year: "2021-2024",
            price: 540000,
            type: "sedan",
          },
          {
            id: "audi_a8",
            brand: "Audi",
            model: "A8",
            year: "2020-2024",
            price: 495000,
            type: "sedan",
          },
          {
            id: "bentley_continental",
            brand: "Bentley",
            model: "Continental GT",
            year: "2020-2024",
            price: 990000,
            type: "supercar",
          },
          {
            id: "rolls_royce_ghost",
            brand: "Rolls-Royce",
            model: "Ghost",
            year: "2020-2024",
            price: 1530000,
            type: "sedan",
          },
        ];

        // ==================== SYSTEM TRYBU GRY ====================
        // gameMode jest zdefiniowane wcze≈õniej (przed loadSaveData)

        function getCurrentCars() {
          return gameMode === "reallife" ? realLifeCars : beamngCars;
        }

        function switchGameMode(mode) {
          const save = getCurrentSave();
          if (!save) return;

          // Zatrzymaj wszystkie ulepszania przed zmianƒÖ trybu
          Object.keys(upgradeIntervals).forEach((idx) => {
            clearInterval(upgradeIntervals[idx]);
          });
          upgradeIntervals = {};

          // Zapisz aktualny stan do obecnego trybu
          saveModeData(gameMode);

          // Zmie≈Ñ tryb
          gameMode = mode;
          localStorage.setItem("beamng_gameMode", mode);

          // Za≈Çaduj dane dla nowego trybu lub utw√≥rz nowe
          loadModeData(mode);

          // Aktualizuj UI
          updateGameModeUI();
          updateAllDisplays();
          renderGarageModal();
          closeModal("gameMode");
        }

        function saveModeData(mode) {
          const save = getCurrentSave();
          if (!save) return;

          const modeKey = mode === "reallife" ? "realLifeData" : "beamngData";
          save[modeKey] = {
            money: money,
            garage: [...garage],
            spent: spent,
            debt: debt,
            debtDeadline: debtDeadline,
            totalTaxPaid: totalTaxPaid,
            health: health,
            food: food,
            water: water,
            backpack: [...backpack],
            activeInsurances: [...activeInsurances],
          };
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
        }

        function loadModeData(mode) {
          const save = getCurrentSave();
          if (!save) return;

          const modeKey = mode === "reallife" ? "realLifeData" : "beamngData";
          const data = save[modeKey];

          if (data) {
            // Za≈Çaduj istniejƒÖce dane
            money = data.money;
            garage = data.garage || [];
            spent = data.spent || 0;
            debt = data.debt || 0;
            debtDeadline = data.debtDeadline || null;
            totalTaxPaid = data.totalTaxPaid || 0;
            health = data.health || 100;
            food = data.food || 1000;
            water = data.water || 1000;
            backpack = data.backpack || [];
            activeInsurances = data.activeInsurances || [];
          } else {
            // Pierwszy raz w tym trybie - nowy start
            money = 1500;
            garage = [];
            spent = 0;
            debt = 0;
            debtDeadline = null;
            totalTaxPaid = 0;
            health = 100;
            food = 1000;
            water = 1000;
            backpack = [];
            activeInsurances = [];
          }

          // Wzn√≥w ulepszania
          resumeUpgrades();
        }

        function updateGameModeUI() {
          const title = document.getElementById("gameModeTitle");
          const subtitle = document.getElementById("gameModeSubtitle");
          const t = translations[currentLang] || translations.en;

          // Elementy karty
          const cardBtn = document.querySelector('[data-translate="card"]');
          const cardTitle = document.querySelector(
            '#modalCard h2 [data-translate="card"]'
          );
          const cardLogo = document.querySelector(".card-logo");
          const pinInfo = document.querySelector(
            '[data-translate="enter6digitPin"]'
          );

          // Elementy bon√≥w
          const vouchersTitle = document.querySelector(
            '#modalVouchers h2 [data-translate="vouchers"]'
          );
          const createVoucherBtns = document.querySelectorAll(
            '[data-translate="createVoucher"]'
          );
          const vouchersToSendTitle = document.querySelector(
            '[data-translate="vouchersToSend"]'
          );
          const receivedVouchersTitle = document.querySelector(
            '[data-translate="receivedVouchers"]'
          );
          const shareVoucherTitle = document.querySelector(
            '#modalShareVoucher h2 [data-translate="shareVoucher"]'
          );

          if (gameMode === "reallife") {
            title.textContent = "üåç Real Life";
            subtitle.textContent = t.simulator || "Symulator";
            document.body.style.background =
              "linear-gradient(135deg, #064e3b 0%, #022c22 100%)";

            // Zmie≈Ñ nazwƒô karty
            if (cardBtn)
              cardBtn.textContent = t.cardRealLife || "Karta Real-Card";
            if (cardTitle)
              cardTitle.textContent = t.cardRealLife || "Karta Real-Card";
            if (cardLogo) cardLogo.textContent = "Real-Card";
            if (pinInfo)
              pinInfo.textContent =
                currentLang === "pl"
                  ? "Wpisz 6-cyfrowy PIN z karty Real-Card"
                  : "Enter 6-digit PIN from Real-Card";

            // Zmie≈Ñ nazwy bon√≥w na kupony
            if (vouchersTitle)
              vouchersTitle.textContent = t.vouchersRealLife || "Kupony";
            createVoucherBtns.forEach(
              (btn) =>
                (btn.textContent = t.createVoucherRealLife || "Utw√≥rz kupon")
            );
            if (vouchersToSendTitle)
              vouchersToSendTitle.textContent =
                currentLang === "pl" ? "Kupony do wys≈Çania" : "Coupons to send";
            if (receivedVouchersTitle)
              receivedVouchersTitle.textContent =
                currentLang === "pl" ? "Otrzymane kupony" : "Received coupons";
            if (shareVoucherTitle)
              shareVoucherTitle.textContent =
                currentLang === "pl" ? "Wy≈õlij kupon" : "Send coupon";
          } else {
            title.textContent = "üöó BeamNG Drive";
            subtitle.textContent = "Datapack";
            document.body.style.background =
              "linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)";

            // Zmie≈Ñ nazwƒô karty
            if (cardBtn) cardBtn.textContent = t.card || "Karta Beam-Pay";
            if (cardTitle) cardTitle.textContent = t.card || "Karta Beam-Pay";
            if (cardLogo) cardLogo.textContent = "Beam-Pay";
            if (pinInfo)
              pinInfo.textContent =
                currentLang === "pl"
                  ? "Wpisz 6-cyfrowy PIN z karty Beam-Pay"
                  : "Enter 6-digit PIN from Beam-Pay Card";

            // Zmie≈Ñ nazwy bon√≥w
            if (vouchersTitle) vouchersTitle.textContent = t.vouchers || "Bony";
            createVoucherBtns.forEach(
              (btn) => (btn.textContent = t.createVoucher || "Utw√≥rz bon")
            );
            if (vouchersToSendTitle)
              vouchersToSendTitle.textContent =
                currentLang === "pl" ? "Bony do wys≈Çania" : "Vouchers to send";
            if (receivedVouchersTitle)
              receivedVouchersTitle.textContent =
                currentLang === "pl" ? "Otrzymane bony" : "Received vouchers";
            if (shareVoucherTitle)
              shareVoucherTitle.textContent =
                currentLang === "pl" ? "Wy≈õlij bon" : "Send voucher";
          }

          // Pod≈õwietl aktywny tryb w modalu
          const beamngBtn = document.getElementById("modeBeamNG");
          const reallifeBtn = document.getElementById("modeRealLife");

          if (beamngBtn && reallifeBtn) {
            beamngBtn.style.borderColor =
              gameMode === "beamng" ? "#fff" : "transparent";
            reallifeBtn.style.borderColor =
              gameMode === "reallife" ? "#fff" : "transparent";
          }
        }

        // ==================== UI SAVE'√ìW ====================
        function renderSavesList() {
          const list = document.getElementById("savesList");
          const t = translations[currentLang] || translations.en;
          const activeText = t.active || "aktywny";

          list.innerHTML = saves
            .map((save) => {
              const isCurrent = save.id === currentSaveId;

              // Sprawd≈∫ checkpoint dla aktywnego save'a
              const modeKey =
                gameMode === "reallife"
                  ? "realLifeCheckpoint"
                  : "beamngCheckpoint";
              const hasCheckpoint = save[modeKey] ? true : false;
              const checkpointDate = hasCheckpoint
                ? new Date(save[modeKey].createdAt).toLocaleString()
                : null;

              // Pobierz dane z odpowiedniego trybu
              const modeDataKey =
                gameMode === "reallife" ? "realLifeData" : "beamngData";
              const modeData = save[modeDataKey] || save.data;
              const garageCount =
                modeData?.garage?.length || save.data?.garage?.length || 0;
              const saveMoney = modeData?.money ?? save.data?.money ?? 0;

              return `
                    <div style="padding:12px;margin-bottom:8px;background:${
                      isCurrent ? "rgba(74,222,128,0.2)" : "rgba(0,0,0,0.2)"
                    };border:2px solid ${
                isCurrent ? "#4ade80" : "#333"
              };border-radius:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                            <div style="flex:1;min-width:120px;">
                                <div style="font-weight:bold;font-size:1em;">${
                                  save.name
                                }</div>
                                <div style="font-size:0.8em;color:#888;">${saveMoney.toLocaleString()} ${getCurrency()} | üöó ${garageCount}</div>
                            </div>
                            <div style="display:flex;gap:8px;flex-shrink:0;">
                                <button onclick="renameSave('${
                                  save.id
                                }')" style="padding:10px 14px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;min-width:44px;min-height:44px;-webkit-tap-highlight-color:transparent;">‚úèÔ∏è</button>
                                ${
                                  !isCurrent
                                    ? `<button onclick="switchSave('${save.id}')" style="padding:10px 16px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;min-width:44px;min-height:44px;-webkit-tap-highlight-color:transparent;">‚ñ∂</button>`
                                    : `<span style="color:#4ade80;font-size:0.85em;padding:10px;">‚úì ${activeText}</span>`
                                }
                                ${
                                  saves.length > 1
                                    ? `<button onclick="handleDeleteSave('${save.id}')" style="padding:10px 16px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;min-width:44px;min-height:44px;-webkit-tap-highlight-color:transparent;">üóëÔ∏è</button>`
                                    : ""
                                }
                            </div>
                        </div>
                        ${
                          isCurrent
                            ? `
                            <div style="margin-top:10px;padding-top:10px;border-top:1px solid #333;">
                                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                                    <div style="font-size:0.85em;">
                                        ${
                                          hasCheckpoint
                                            ? `
                                            <span style="color:#4ade80;">üíæ ${
                                              t.checkpoint || "Checkpoint"
                                            }: ${checkpointDate}</span>
                                        `
                                            : `
                                            <span style="color:#888;">üì≠ ${
                                              t.noCheckpoint ||
                                              "Brak checkpointu"
                                            }</span>
                                        `
                                        }
                                    </div>
                                    <div style="display:flex;gap:6px;">
                                        <button onclick="createCheckpoint()" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">
                                            üíæ ${t.saveCheckpoint || "Zapisz"}
                                        </button>
                                        ${
                                          hasCheckpoint
                                            ? `
                                            <button onclick="deleteCheckpoint()" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">
                                                üóëÔ∏è
                                            </button>
                                        `
                                            : ""
                                        }
                                    </div>
                                </div>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
            })
            .join("");
        }

        function renameSave(saveId) {
          const save = saves.find((s) => s.id === saveId);
          if (!save) return;

          const t = translations[currentLang] || translations.en;
          const newName = prompt(
            t.enterNewName || "Wprowad≈∫ nowƒÖ nazwƒô:",
            save.name
          );

          if (newName && newName.trim()) {
            save.name = newName.trim();
            localStorage.setItem("beamng_saves", JSON.stringify(saves));
            renderSavesList();
            updateCurrentSaveDisplay();
          }
        }

        function handleCreateSave() {
          const nameInput = document.getElementById("newSaveName");
          const name = nameInput.value.trim() || "Save " + (saves.length + 1);

          const newSave = createSave(name);
          nameInput.value = "";

          renderSavesList();
          updateCurrentSaveDisplay();

          const t = translations[currentLang] || translations.en;
          alert(t.saveCreated || "Save utworzony!");
        }

        function handleDeleteSave(saveId) {
          const t = translations[currentLang] || translations.en;
          if (confirm(t.confirmDeleteSave || "UsunƒÖƒá ten save?")) {
            if (deleteSave(saveId)) {
              renderSavesList();
              updateAllDisplays();
              updateCurrentSaveDisplay();
            }
          }
        }

        function updateCurrentSaveDisplay() {
          const display = document.getElementById("currentSaveDisplay");
          const save = getCurrentSave();
          if (display && save) {
            display.textContent = "üíæ " + save.name;
          }
        }

        // ==================== UI BON√ìW ====================
        let currentVoucherToShare = null;

        function renderVouchersList() {
          const toSendList = document.getElementById("vouchersToSendList");
          const receivedList = document.getElementById("receivedVouchersList");
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();

          const noVouchersText =
            gameMode === "reallife"
              ? currentLang === "pl"
                ? "Brak kupon√≥w"
                : "No coupons"
              : t.noVouchers || "Brak bon√≥w";
          const noReceivedText =
            gameMode === "reallife"
              ? currentLang === "pl"
                ? "Brak otrzymanych kupon√≥w"
                : "No received coupons"
              : t.noReceivedVouchers || "Brak otrzymanych bon√≥w";

          if (!save || !save.data) {
            if (toSendList)
              toSendList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noVouchersText}</div>`;
            if (receivedList)
              receivedList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noReceivedText}</div>`;
            return;
          }

          // Bony do wys≈Çania - filtruj wed≈Çug aktualnego trybu
          const allVouchersToSend = save.data.vouchersToSend || [];
          const vouchersToSend = allVouchersToSend.filter(
            (v) => (v.gameMode || "beamng") === gameMode
          );

          if (vouchersToSend.length === 0) {
            toSendList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noVouchersText}</div>`;
          } else {
            toSendList.innerHTML = vouchersToSend
              .map((v, idx) => {
                // Znajd≈∫ rzeczywisty indeks w pe≈Çnej tablicy
                const realIdx = allVouchersToSend.findIndex(
                  (vv) => vv.id === v.id
                );
                return `
                    <div style="padding:12px;margin-bottom:8px;background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(168,85,247,0.1));border:2px solid #8b5cf6;border-radius:12px;">
                        ${renderVoucherCard(v)}
                        <div style="font-size:0.75em;color:#f59e0b;text-align:center;margin:8px 0;">‚è≥ ${
                          t.pendingVoucher || "Oczekuje na przyjƒôcie"
                        }</div>
                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <button onclick="openShareVoucher(${realIdx}, 'toSend')" style="flex:1;padding:10px;background:#8b5cf6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;-webkit-tap-highlight-color:transparent;">
                                üì§ ${
                                  gameMode === "reallife"
                                    ? currentLang === "pl"
                                      ? "Wy≈õlij"
                                      : "Send"
                                    : t.sendVoucher || "Wy≈õlij"
                                }
                            </button>
                            <button onclick="cancelVoucher(${realIdx})" style="padding:10px 15px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;-webkit-tap-highlight-color:transparent;">
                                ‚ùå
                            </button>
                        </div>
                    </div>
                `;
              })
              .join("");
          }

          // Otrzymane bony - filtruj wed≈Çug aktualnego trybu
          const allReceivedVouchers = save?.data?.receivedVouchers || [];
          const receivedVouchers = allReceivedVouchers.filter(
            (v) => (v.gameMode || "beamng") === gameMode
          );

          if (receivedVouchers.length === 0) {
            receivedList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noReceivedText}</div>`;
          } else {
            receivedList.innerHTML = receivedVouchers
              .map((v, idx) => {
                // Znajd≈∫ rzeczywisty indeks w pe≈Çnej tablicy
                const realIdx = allReceivedVouchers.findIndex(
                  (vv) => vv.id === v.id
                );
                return `
                    <div style="padding:12px;margin-bottom:8px;background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.1));border:2px solid #10b981;border-radius:12px;">
                        ${renderVoucherCard(v)}
                        <div style="font-size:0.8em;color:#888;margin-bottom:8px;">${
                          t.voucherFrom || "Od:"
                        } ${v.fromSave || "?"}</div>
                        <div style="display:flex;gap:8px;">
                            <button onclick="acceptVoucher(${realIdx})" style="flex:1;padding:10px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;">
                                ‚úÖ ${t.acceptVoucher || "Przyjmij"}
                            </button>
                            <button onclick="rejectVoucher(${realIdx})" style="flex:1;padding:10px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;">
                                ‚Ü©Ô∏è ${t.rejectVoucher || "Przeka≈º dalej"}
                            </button>
                        </div>
                    </div>
                `;
              })
              .join("");
          }
        }

        function renderVoucherCard(voucher) {
          const voucherMode = voucher.gameMode || gameMode;
          const isRealLife = voucherMode === "reallife";
          const titleText = isRealLife
            ? currentLang === "pl"
              ? "KUPON PODARUNKOWY"
              : "GIFT COUPON"
            : currentLang === "pl"
            ? "BON PODARUNKOWY"
            : "GIFT VOUCHER";
          const bgGradient = isRealLife
            ? "linear-gradient(145deg,#064e3b,#022c22)"
            : "linear-gradient(145deg,#1a1a2e,#16213e)";
          const borderColor = isRealLife ? "#10b981" : "#8b5cf6";
          const amountColor = isRealLife ? "#10b981" : "#8b5cf6";

          return `
                <div style="background:${bgGradient};border-radius:10px;padding:15px;text-align:center;border:1px dashed ${borderColor};">
                    <div style="font-size:2.5em;margin-bottom:5px;">${
                      isRealLife ? "üé´" : "üéÅ"
                    }</div>
                    <div style="font-size:0.8em;color:#888;text-transform:uppercase;letter-spacing:2px;">${titleText}</div>
                    <div style="font-size:2em;font-weight:bold;color:${amountColor};margin:10px 0;">${voucher.amount.toLocaleString()} ${getCurrency()}</div>
                    ${
                      voucher.message
                        ? `<div style="font-size:0.9em;color:#aaa;font-style:italic;">"${voucher.message}"</div>`
                        : ""
                    }
                </div>
            `;
        }

        function handleCreateVoucher() {
          const amountInput = document.getElementById("voucherAmountInput");
          const messageInput = document.getElementById("voucherMessageInput");
          const t = translations[currentLang] || translations.en;

          const amount = parseInt(amountInput.value);
          if (!amount || amount <= 0) {
            alert(t.invalidAmount || "Wprowad≈∫ prawid≈ÇowƒÖ kwotƒô!");
            return;
          }

          // Sprawd≈∫ czy masz tyle pieniƒôdzy (uwzglƒôdnij ju≈º utworzone bony)
          const save = getCurrentSave();
          if (!save) return;
          if (!save.data) save.data = {};

          // Filtruj bony tylko z aktualnego trybu
          const pendingTotal = (save.data.vouchersToSend || [])
            .filter((v) => v.gameMode === gameMode)
            .reduce((sum, v) => sum + v.amount, 0);

          if (money - pendingTotal < amount) {
            playSound("error");
            alert(t.notEnoughMoney || "Nie masz wystarczajƒÖco pieniƒôdzy!");
            return;
          }

          const voucher = {
            id:
              "bon_" +
              Date.now() +
              "_" +
              Math.random().toString(36).substr(2, 6),
            amount: amount,
            message: messageInput.value.trim(),
            createdAt: Date.now(),
            fromSave: save.name,
            fromSaveId: save.id,
            gameMode: gameMode, // Zapisz tryb gry
          };

          // NIE odejmuj pieniƒôdzy - tylko dodaj do listy oczekujƒÖcych
          if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
          save.data.vouchersToSend.push(voucher);

          saveSaveData();

          amountInput.value = "";
          messageInput.value = "";
          renderVouchersList();

          // Od razu otw√≥rz udostƒôpnianie
          currentVoucherToShare = {
            voucher,
            index: save.data.vouchersToSend.length - 1,
            source: "toSend",
          };
          openShareModal();
        }

        function cancelVoucher(idx) {
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();

          if (!save.data.vouchersToSend || !save.data.vouchersToSend[idx])
            return;

          // Bon jeszcze nie by≈Ç przyjƒôty, wiƒôc nic nie tracisz
          if (confirm(t.cancelVoucherConfirm || "Anulowaƒá bon?")) {
            save.data.vouchersToSend.splice(idx, 1);
            saveSaveData();
            updateAllDisplays();
            renderVouchersList();
          }
        }

        function openShareVoucher(idx, source) {
          const save = getCurrentSave();
          const vouchers =
            source === "toSend"
              ? save.data.vouchersToSend
              : save.data.receivedVouchers;

          if (!vouchers || !vouchers[idx]) return;

          currentVoucherToShare = {
            voucher: vouchers[idx],
            index: idx,
            source,
          };
          openShareModal();
        }

        function openShareModal() {
          if (!currentVoucherToShare) return;

          const v = currentVoucherToShare.voucher;
          const t = translations[currentLang] || translations.en;

          document.getElementById("shareVoucherPreview").innerHTML =
            renderVoucherCard(v);

          // Generuj przyciski udostƒôpniania
          const buttonsDiv = document.getElementById("shareVoucherButtons");

          // Lista innych save'√≥w (nie aktualny)
          const otherSaves = saves.filter((s) => s.id !== currentSaveId);

          // Pobierz znajomych (lokalnie)
          const friends = getFriendsList();

          buttonsDiv.innerHTML = `
                <!-- Wy≈õlij do znajomego -->
                ${
                  friends.length > 0
                    ? `
                    <p style="margin-bottom:5px;font-weight:bold;">‚≠ê ${
                      t.sendToFriend || "Wy≈õlij do znajomego:"
                    }</p>
                    <p style="color:#f59e0b;font-size:0.8em;margin-bottom:10px;">üí∞ Op≈Çata: ${VOUCHER_SEND_FEE} ${getCurrency()}</p>
                    <div style="display:flex;flex-direction:column;gap:6px;max-height:150px;overflow-y:auto;margin-bottom:15px;">
                        ${friends
                          .map(
                            (name) => `
                            <button onclick="sendVoucherToFriend('${name}')" style="padding:12px;background:#222;color:white;border:1px solid #333;border-radius:8px;cursor:pointer;text-align:left;">
                                üë§ ${name}
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                `
                    : `
                    <p style="color:#666;text-align:center;padding:15px;margin-bottom:15px;">${
                      t.noFriends || "Brak znajomych"
                    }<br><small>Dodaj znajomych w Konto Online!</small></p>
                `
                }
                
                <!-- Wy≈õlij przez link -->
                <p style="margin-bottom:10px;font-weight:bold;border-top:1px solid #333;padding-top:15px;">üîó ${
                  t.shareViaLink || "Lub wy≈õlij przez link:"
                }</p>
                <div style="display:flex;gap:8px;margin-bottom:15px;">
                    <button onclick="shareVoucherVia('copy')" style="flex:1;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;">üìã</button>
                    <button onclick="shareVoucherVia('whatsapp')" style="flex:1;padding:12px;background:#25D366;color:white;border:none;border-radius:8px;cursor:pointer;">üí¨</button>
                </div>
                
                ${
                  otherSaves.length > 0
                    ? `
                    <p style="margin-bottom:5px;font-weight:bold;border-top:1px solid #333;padding-top:15px;">üíæ ${
                      t.sendToOtherSave || "Lub na inny zapis:"
                    }</p>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        ${otherSaves
                          .map(
                            (s) => `
                            <button onclick="sendVoucherToSave('${s.id}')" style="padding:12px;background:rgba(0,0,0,0.3);color:white;border:2px solid #333;border-radius:10px;cursor:pointer;text-align:left;">
                                üíæ ${s.name}
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                `
                    : ""
                }
            `;

          openModal("shareVoucher");
        }

        // Wy≈õlij bon do znajomego (lokalnie - bez serwera)
        function sendVoucherToFriend(friendName) {
          if (!currentVoucherToShare) return;

          const v = currentVoucherToShare.voucher;
          const idx = currentVoucherToShare.index;
          const save = getCurrentSave();
          const t = translations[currentLang] || translations.en;

          // Sprawd≈∫ czy staƒá na op≈Çatƒô
          if (save.data.money < VOUCHER_SEND_FEE) {
            showToast(
              `‚ùå ${
                t.notEnoughMoney || "Brak ≈õrodk√≥w"
              } (${VOUCHER_SEND_FEE} ${getCurrency()})`
            );
            return;
          }

          // Pobierz op≈Çatƒô
          save.data.money -= VOUCHER_SEND_FEE;

          // Zapisz bon jako wys≈Çany do znajomego
          v.sentToFriend = friendName;
          v.sentAt = Date.now();

          // Zapisz info o bonie w localStorage dla znajomego
          let pendingVouchers = JSON.parse(
            localStorage.getItem("beamng_pending_vouchers") || "[]"
          );
          pendingVouchers.push({
            id: v.id,
            amount: v.amount,
            message: v.message,
            from: playerName,
            to: friendName,
            gameMode: v.gameMode || gameMode,
            sentAt: Date.now(),
          });
          localStorage.setItem(
            "beamng_pending_vouchers",
            JSON.stringify(pendingVouchers)
          );

          saveSaveData();
          updateAllDisplays();

          showToast(
            `‚úÖ Bon wys≈Çany do ${friendName}! (op≈Çata: ${VOUCHER_SEND_FEE} ${getCurrency()})`
          );
          closeModal("shareVoucher");
          renderVouchersList();
        }

        function getVoucherLink(voucher) {
          // Generuj czytelny link z parametrami
          const baseUrl =
            "https://filipnosalhd-collab.github.io/Real-BeamNG_datapack/";
          const params = new URLSearchParams();
          params.set("vid", voucher.id);
          params.set("amount", voucher.amount);
          params.set("from", voucher.fromSave);
          params.set("fromId", voucher.fromSaveId);
          params.set("mode", voucher.gameMode || gameMode);
          if (voucher.message) params.set("msg", voucher.message);
          return baseUrl + "?" + params.toString();
        }

        function getShareMessage(voucher) {
          const t = translations[currentLang] || translations.en;
          const genderMsg =
            t.youReceivedVoucher || "Dosta≈Çe≈õ/a≈õ bon o warto≈õci";
          return `üéÅ ${genderMsg} ${voucher.amount.toLocaleString()} ${getCurrency()}!\n\n`;
        }

        async function shareVoucherVia(method) {
          if (!currentVoucherToShare) return;

          const v = currentVoucherToShare.voucher;
          const idx = currentVoucherToShare.index;
          const save = getCurrentSave();
          const t = translations[currentLang] || translations.en;
          const voucherMode = v.gameMode || gameMode;

          const SHIPPING_FEE = 100; // Op≈Çata za przesy≈Çkƒô bonu
          const totalCost = v.amount + SHIPPING_FEE;

          // Poka≈º ≈Çadowanie
          const loadingMsg =
            currentLang === "pl" ? "Wysy≈Çanie..." : "Sending...";

          // Zapisz bon online do JSONBin
          saveVoucherOnline({
            id: v.id,
            amount: v.amount,
            message: v.message,
            fromSave: v.fromSave,
            fromSaveId: v.fromSaveId,
            gameMode: voucherMode,
          });

          // ONLINE - od razu odejmij pieniƒÖdze (warto≈õƒá bonu + op≈Çata za przesy≈Çkƒô)
          const modeKey =
            voucherMode === "reallife" ? "realLifeData" : "beamngData";

          // Odejmij pieniƒÖdze z odpowiedniego trybu (bon + przesy≈Çka)
          if (save[modeKey]) {
            save[modeKey].money = (save[modeKey].money || 0) - totalCost;
          }
          // Je≈õli jeste≈õmy w tym trybie, aktualizuj te≈º lokalnƒÖ zmiennƒÖ
          if (voucherMode === gameMode) {
            money -= totalCost;
          }

          // Usu≈Ñ bon z listy (ju≈º wys≈Çany online)
          if (save.data.vouchersToSend && save.data.vouchersToSend[idx]) {
            save.data.vouchersToSend.splice(idx, 1);
          }

          // Oznacz bon jako wys≈Çany online (nie mo≈ºna go odebraƒá samemu)
          markVoucherAsUsed(v.id + "_sender_" + save.id);

          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          updateAllDisplays();

          const link = getVoucherLink(v);
          const message = getShareMessage(v);
          const fullText = message + link;

          switch (method) {
            case "whatsapp":
              window.open(
                "https://wa.me/?text=" + encodeURIComponent(fullText),
                "_blank"
              );
              break;
            case "messenger":
              window.open(
                "https://www.facebook.com/dialog/send?link=" +
                  encodeURIComponent(link) +
                  "&app_id=0&redirect_uri=" +
                  encodeURIComponent(window.location.href),
                "_blank"
              );
              break;
            case "email":
              const subject =
                voucherMode === "reallife"
                  ? currentLang === "pl"
                    ? "Kupon podarunkowy Real Life"
                    : "Real Life Gift Coupon"
                  : currentLang === "pl"
                  ? "Bon podarunkowy BeamNG"
                  : "BeamNG Gift Voucher";
              window.open(
                "mailto:?subject=" +
                  encodeURIComponent(subject) +
                  "&body=" +
                  encodeURIComponent(fullText),
                "_blank"
              );
              break;
            case "sms":
              window.open(
                "sms:?body=" + encodeURIComponent(fullText),
                "_blank"
              );
              break;
          }

          closeModal("shareVoucher");
          renderVouchersList();

          // Poka≈º potwierdzenie z op≈ÇatƒÖ za przesy≈Çkƒô
          const voucherName =
            voucherMode === "reallife"
              ? currentLang === "pl"
                ? "Kupon"
                : "Coupon"
              : currentLang === "pl"
              ? "Bon"
              : "Voucher";
          const shippingText =
            currentLang === "pl" ? "op≈Çata za przesy≈Çkƒô" : "shipping fee";
          alert(
            `üì§ ${voucherName} ${
              t.sent || "wys≈Çany"
            }!\n-${v.amount.toLocaleString()} ${getCurrency()} (${voucherName.toLowerCase()})\n-${SHIPPING_FEE} ${getCurrency()} (${shippingText})\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n-${totalCost.toLocaleString()} ${getCurrency()} ${
              t.total || "≈ÇƒÖcznie"
            }`
          );
        }

        function sendVoucherToSave(targetSaveId) {
          if (!currentVoucherToShare) return;

          const t = translations[currentLang] || translations.en;
          const v = currentVoucherToShare.voucher;
          const targetSave = saves.find((s) => s.id === targetSaveId);

          if (!targetSave) return;

          // Dodaj bon do receivedVouchers w docelowym save'ie
          if (!targetSave.data.receivedVouchers)
            targetSave.data.receivedVouchers = [];
          targetSave.data.receivedVouchers.push({
            id: v.id,
            amount: v.amount,
            message: v.message,
            fromSave: v.fromSave,
            fromSaveId: v.fromSaveId,
            gameMode: v.gameMode || gameMode, // Dodaj tryb gry
            receivedAt: Date.now(),
            isLocal: true, // Oznacz ≈ºe wys≈Çane lokalnie (mo≈ºna anulowaƒá)
          });

          localStorage.setItem("beamng_saves", JSON.stringify(saves));

          const voucherName =
            (v.gameMode || gameMode) === "reallife"
              ? currentLang === "pl"
                ? "Kupon wys≈Çany do"
                : "Coupon sent to"
              : t.voucherSentToSave || "Bon wys≈Çany do";
          alert(`${voucherName} "${targetSave.name}"!`);
          closeModal("shareVoucher");
          renderVouchersList();
        }

        function acceptVoucher(idx) {
          const save = getCurrentSave();
          if (!save.data.receivedVouchers || !save.data.receivedVouchers[idx])
            return;

          const voucher = save.data.receivedVouchers[idx];

          // Znajd≈∫ save nadawcy i odejmij mu pieniƒÖdze
          const senderSave = saves.find((s) => s.id === voucher.fromSaveId);
          if (senderSave) {
            // Usu≈Ñ bon z listy oczekujƒÖcych nadawcy
            if (senderSave.data.vouchersToSend) {
              const vIdx = senderSave.data.vouchersToSend.findIndex(
                (v) => v.id === voucher.id
              );
              if (vIdx !== -1) {
                senderSave.data.vouchersToSend.splice(vIdx, 1);
              }
            }
            // Odejmij pieniƒÖdze nadawcy
            senderSave.data.money =
              (senderSave.data.money || 0) - voucher.amount;
          }

          // Dodaj pieniƒÖdze odbiorcy
          money += voucher.amount;
          save.data.receivedVouchers.splice(idx, 1);

          saveSaveData();
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          updateAllDisplays();
          renderVouchersList();

          playSound("voucher");
          const t = translations[currentLang] || translations.en;
          alert(
            `‚úÖ ${
              t.voucherAccepted || "Bon przyjƒôty!"
            }\n+${voucher.amount.toLocaleString()} ${getCurrency()}`
          );
        }

        function rejectVoucher(idx) {
          const save = getCurrentSave();
          if (!save.data.receivedVouchers || !save.data.receivedVouchers[idx])
            return;

          // Przenie≈õ do bon√≥w do wys≈Çania (przeka≈º dalej)
          const voucher = save.data.receivedVouchers[idx];
          voucher.fromSave = save.name;
          voucher.fromSaveId = save.id; // Teraz to ty wysy≈Çasz

          if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
          save.data.vouchersToSend.push(voucher);
          save.data.receivedVouchers.splice(idx, 1);

          saveSaveData();
          renderVouchersList();

          // Od razu otw√≥rz udostƒôpnianie
          currentVoucherToShare = {
            voucher,
            index: save.data.vouchersToSend.length - 1,
            source: "toSend",
          };
          openShareModal();
        }

        // Sprawd≈∫ czy w URL jest bon do odebrania
        // ==================== SYSTEM LOKALNY ====================
        const VOUCHER_EXPIRY_SECONDS = 30;
        const LINK_SEND_FEE = 100; // Op≈Çata za wys≈Çanie linkiem

        let playerName = localStorage.getItem("beamng_player_name") || null;

        // Op≈Çaty
        const CHAT_MESSAGE_FEE = 5.5; // Op≈Çata za wiadomo≈õƒá
        const VOUCHER_SEND_FEE = 250; // Op≈Çata za wys≈Çanie bonu

        // ========== SYSTEM NAZWY GRACZA ==========
        function checkRequireLogin() {
          if (!playerName) {
            document
              .getElementById("modalRequireLogin")
              .classList.add("active");
            return true;
          }
          return false;
        }

        function showLoginError(msg) {
          const errorEl = document.getElementById("loginError");
          errorEl.textContent = msg;
          errorEl.style.display = "block";
        }

        function hideLoginError() {
          document.getElementById("loginError").style.display = "none";
        }

        function setPlayerName() {
          const name = document.getElementById("loginName").value.trim();
          hideLoginError();

          if (name.length < 2) {
            showLoginError("Nazwa musi mieƒá min. 2 znaki");
            return;
          }
          if (name.length > 20) {
            showLoginError("Nazwa mo≈ºe mieƒá max. 20 znak√≥w");
            return;
          }

          playerName = name;
          localStorage.setItem("beamng_player_name", playerName);

          document
            .getElementById("modalRequireLogin")
            .classList.remove("active");
          updateAllDisplays();

          showToast(`üéÆ Witaj ${playerName}!`);
        }

        function editPlayerName() {
          const newName = prompt("Nowa nazwa:", playerName);
          if (!newName || newName.trim().length < 2) {
            showToast("‚ùå Nazwa musi mieƒá min. 2 znaki");
            return;
          }
          if (newName.trim().length > 20) {
            showToast("‚ùå Nazwa mo≈ºe mieƒá max. 20 znak√≥w");
            return;
          }

          playerName = newName.trim();
          localStorage.setItem("beamng_player_name", playerName);
          showToast(`‚úÖ Nazwa zmieniona na ${playerName}`);
          renderOnlineAccount();
        }

        function showToast(message) {
          const oldToast = document.getElementById("toast");
          if (oldToast) oldToast.remove();

          const toast = document.createElement("div");
          toast.id = "toast";
          toast.textContent = message;
          toast.style.cssText =
            "position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#10b981;color:white;padding:15px 30px;border-radius:10px;font-size:1.1em;z-index:9999;animation:fadeInOut 2s forwards;";
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        }

        // ========== DANE LOKALNE (bez serwera) ==========
        function getOnlineData() {
          const saved = localStorage.getItem("beamng_online_data");
          if (saved) {
            return JSON.parse(saved);
          }
          return {
            vouchers: {},
            players: {},
            notifications: {},
            chats: {},
            shop: { lastReset: 0, items: {} },
          };
        }

        function saveOnlineData(data) {
          localStorage.setItem("beamng_online_data", JSON.stringify(data));
          return true;
        }

        // ========== SYSTEM GRACZY ==========
        async function updatePlayerStatus() {
          if (!playerName) return;
          const data = getOnlineData();
          if (data.players && data.players[playerName]) {
            data.players[playerName].online = true;
            data.players[playerName].lastSeen = Date.now();
            data.players[playerName].gameMode = gameMode;
            data.players[playerName].cardNumber = cardCode;
            saveOnlineData(data);
          }
        }

        async function getOnlinePlayers() {
          const data = getOnlineData();
          if (!data.players) return [];
          const now = Date.now();
          const ONLINE_TIMEOUT = 2 * 60 * 1000; // 2 minuty
          return Object.entries(data.players)
            .filter(
              ([name, p]) =>
                p.online &&
                now - p.lastSeen < ONLINE_TIMEOUT &&
                name !== playerName
            )
            .map(([name, p]) => ({
              name,
              gameMode: p.gameMode,
              photoURL: p.photoURL || null,
            }));
        }

        // ========== SYSTEM BON√ìW ==========
        async function getOnlineVouchers() {
          const data = getOnlineData();
          return data.vouchers || {};
        }

        function saveVoucherOnline(voucher) {
          const data = getOnlineData();
          if (!data.vouchers) data.vouchers = {};
          data.vouchers[voucher.id] = {
            amount: voucher.amount,
            message: voucher.message || "",
            fromPlayer: playerName,
            fromSaveId: voucher.fromSaveId,
            toPlayer: voucher.toPlayer || null,
            gameMode: voucher.gameMode,
            sentAt: Date.now(),
            firstOpenedAt: null,
            status: "pending",
          };
          saveOnlineData(data);
        }

        function checkVoucherOnline(voucherId) {
          const data = getOnlineData();
          return data.vouchers ? data.vouchers[voucherId] : null;
        }

        function markVoucherOpened(voucherId) {
          const data = getOnlineData();
          if (
            data.vouchers &&
            data.vouchers[voucherId] &&
            !data.vouchers[voucherId].firstOpenedAt
          ) {
            data.vouchers[voucherId].firstOpenedAt = Date.now();
            data.vouchers[voucherId].status = "opened";
            saveOnlineData(data);
          }
          return data.vouchers ? data.vouchers[voucherId] : null;
        }

        function markVoucherUsedOnline(voucherId) {
          const data = getOnlineData();
          if (data.vouchers && data.vouchers[voucherId]) {
            data.vouchers[voucherId].status = "used";
            data.vouchers[voucherId].usedAt = Date.now();
            saveOnlineData(data);
          }
        }

        function cancelVoucherOnline(voucherId) {
          const data = getOnlineData();
          if (data.vouchers && data.vouchers[voucherId]) {
            data.vouchers[voucherId].status = "cancelled";
            data.vouchers[voucherId].cancelledAt = Date.now();
            saveOnlineData(data);
            return data.vouchers[voucherId];
          }
          return null;
        }

        // ========== SYSTEM POWIADOMIE≈É ==========
        function sendNotification(toPlayer, notification) {
          const data = getOnlineData();
          if (!data.notifications) data.notifications = {};
          if (!data.notifications[toPlayer]) data.notifications[toPlayer] = [];

          notification.id =
            "notif_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 6);
          notification.timestamp = Date.now();
          notification.read = false;

          data.notifications[toPlayer].push(notification);
          saveOnlineData(data);
        }

        function getMyNotifications() {
          if (!playerName) return [];
          const data = getOnlineData();
          return data.notifications && data.notifications[playerName]
            ? data.notifications[playerName]
            : [];
        }

        function markNotificationRead(notifId) {
          const data = getOnlineData();
          if (data.notifications && data.notifications[playerName]) {
            const notif = data.notifications[playerName].find(
              (n) => n.id === notifId
            );
            if (notif) notif.read = true;
            saveOnlineData(data);
          }
        }

        function removeNotification(notifId) {
          const data = getOnlineData();
          if (data.notifications && data.notifications[playerName]) {
            data.notifications[playerName] = data.notifications[
              playerName
            ].filter((n) => n.id !== notifId);
            saveOnlineData(data);
          }
        }

        async function checkNotifications() {
          if (!playerName) return;
          const notifs = getMyNotifications();
          unreadNotifications = notifs.filter((n) => !n.read).length;
          updateNotificationBadge();
        }

        function updateNotificationBadge() {
          const badge = document.getElementById("notificationBadge");
          if (badge) {
            badge.textContent = unreadNotifications;
            badge.style.display = unreadNotifications > 0 ? "flex" : "none";
          }
        }

        // ========== SYSTEM AUKCJI ==========
        async function createAuction(item) {
          const data = getOnlineData();
          if (!data.auctions) data.auctions = {};

          const auctionId =
            "auction_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 6);
          data.auctions[auctionId] = {
            seller: playerName,
            item: item,
            price: item.price,
            createdAt: Date.now(),
            status: "active",
            bids: [],
            negotiations: [],
          };
          saveOnlineData(data);
          return auctionId;
        }

        async function getActiveAuctions() {
          const data = getOnlineData();
          if (!data.auctions) return [];
          return Object.entries(data.auctions)
            .filter(([id, a]) => a.status === "active")
            .map(([id, a]) => ({ id, ...a }));
        }

        async function bidOnAuction(auctionId, amount, pin) {
          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId])
            return { success: false, error: "notFound" };

          const auction = data.auctions[auctionId];
          if (auction.seller === playerName)
            return { success: false, error: "ownAuction" };

          // Sprawd≈∫ limit karty
          const save = getCurrentSave();
          if (amount > limit && pin !== playerPin) {
            // Wy≈õlij powiadomienie do sprzedawcy o braku PIN
            sendNotification(auction.seller, {
              type: "pinRequired",
              from: playerName,
              auctionId: auctionId,
              amount: amount,
              message:
                currentLang === "pl"
                  ? "KupujƒÖcy nie pamiƒôta PIN"
                  : "Buyer forgot PIN",
            });
            return { success: false, error: "pinRequired" };
          }

          auction.bids.push({
            bidder: playerName,
            amount: amount,
            timestamp: Date.now(),
          });

          // Powiadom sprzedawcƒô
          sendNotification(auction.seller, {
            type: "newBid",
            from: playerName,
            auctionId: auctionId,
            amount: amount,
          });

          saveOnlineData(data);
          return { success: true };
        }

        async function negotiateAuction(auctionId, offeredPrice) {
          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId])
            return { success: false };

          const auction = data.auctions[auctionId];

          auction.negotiations.push({
            from: playerName,
            price: offeredPrice,
            timestamp: Date.now(),
            status: "pending",
          });

          // Powiadom sprzedawcƒô
          sendNotification(auction.seller, {
            type: "negotiation",
            from: playerName,
            auctionId: auctionId,
            offeredPrice: offeredPrice,
          });

          saveOnlineData(data);
          return { success: true };
        }

        async function respondToNegotiation(
          auctionId,
          negotiationIndex,
          response,
          counterOffer
        ) {
          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId])
            return { success: false };

          const auction = data.auctions[auctionId];
          const negotiation = auction.negotiations[negotiationIndex];

          if (response === "accept") {
            negotiation.status = "accepted";
            auction.status = "sold";
            auction.soldTo = negotiation.from;
            auction.soldPrice = negotiation.price;

            sendNotification(negotiation.from, {
              type: "negotiationAccepted",
              auctionId: auctionId,
              price: negotiation.price,
            });
          } else if (response === "reject") {
            negotiation.status = "rejected";

            sendNotification(negotiation.from, {
              type: "negotiationRejected",
              auctionId: auctionId,
            });
          } else if (response === "counter") {
            negotiation.status = "countered";
            negotiation.counterOffer = counterOffer;

            sendNotification(negotiation.from, {
              type: "counterOffer",
              from: playerName,
              auctionId: auctionId,
              counterOffer: counterOffer,
            });
          }

          saveOnlineData(data);
          return { success: true };
        }

        async function acceptAuction(auctionId, pinInput) {
          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId])
            return { success: false };

          const auction = data.auctions[auctionId];

          // Sprawd≈∫ hajs
          if (money < auction.price) {
            return { success: false, error: "noMoney" };
          }

          auction.status = "sold";
          auction.soldTo = playerName;
          auction.soldPrice = auction.price;

          sendNotification(auction.seller, {
            type: "auctionSold",
            from: playerName,
            auctionId: auctionId,
            price: auction.price,
          });

          saveOnlineData(data);
          return {
            success: true,
            items: auction.items,
            item: auction.item,
            price: auction.price,
          };
        }

        async function allowWithoutPin(notifId, auctionId, buyerName) {
          const data = getOnlineData();

          sendNotification(buyerName, {
            type: "pinBypassed",
            auctionId: auctionId,
            from: playerName,
          });

          removeNotification(notifId);
          return { success: true };
        }

        async function denyWithoutPin(notifId, buyerName) {
          sendNotification(buyerName, {
            type: "pinDenied",
            from: playerName,
          });

          removeNotification(notifId);
          return { success: true };
        }

        // ========== W≈ÅASNE UBEZPIECZENIA ==========
        async function createCustomInsurance(insurance) {
          const auctionId = await createAuction({
            type: "customInsurance",
            name: insurance.name,
            coverage: insurance.coverage,
            interval: insurance.interval,
            price: insurance.price,
            createdBy: playerName,
          });
          return auctionId;
        }

        // ========== SKLEP Z LIMITEM ==========
        async function checkShopReset() {
          const data = getOnlineData();
          if (!data.shop) data.shop = { lastReset: 0, items: {} };

          const now = Date.now();
          const lastReset = data.shop.lastReset || 0;
          const monday = getLastMonday();

          if (lastReset < monday) {
            // Reset sklepu
            data.shop.lastReset = now;
            data.shop.items = {}; // Resetuj ilo≈õci
            saveOnlineData(data);
          }
        }

        function getLastMonday() {
          const now = new Date();
          const day = now.getDay();
          const diff = now.getDate() - day + (day === 0 ? -6 : 1);
          const monday = new Date(now.setDate(diff));
          monday.setHours(0, 0, 0, 0);
          return monday.getTime();
        }

        // ========== LOKALNE FUNKCJE BON√ìW ==========
        function getUsedVoucherIds() {
          try {
            return JSON.parse(
              localStorage.getItem("beamng_used_vouchers") || "[]"
            );
          } catch (e) {
            return [];
          }
        }

        function markVoucherAsUsed(voucherId) {
          const used = getUsedVoucherIds();
          if (!used.includes(voucherId)) {
            used.push(voucherId);
            localStorage.setItem("beamng_used_vouchers", JSON.stringify(used));
          }
        }

        function isVoucherUsed(voucherId) {
          return getUsedVoucherIds().includes(voucherId);
        }

        async function checkUrlForVoucher() {
          const urlParams = new URLSearchParams(window.location.search);
          const t = translations[currentLang] || translations.en;

          const vid = urlParams.get("vid");
          const amount = urlParams.get("amount");
          const from = urlParams.get("from");
          const fromId = urlParams.get("fromId");
          const msg = urlParams.get("msg");
          const mode = urlParams.get("mode");

          if (vid && amount && fromId) {
            // Usu≈Ñ parametry z URL od razu
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );

            // Sprawd≈∫ status bonu online
            const onlineVoucher = checkVoucherOnline(vid);

            if (!onlineVoucher) {
              alert(t.voucherNotFound || "Nie znaleziono bonu!");
              return;
            }

            // Sprawd≈∫ czy bon ju≈º wykorzystany lub anulowany
            if (onlineVoucher.status === "used") {
              alert(t.voucherAlreadyUsed || "Ten bon zosta≈Ç ju≈º wykorzystany!");
              return;
            }

            if (onlineVoucher.status === "cancelled") {
              alert(
                t.voucherCancelled || "Ten bon zosta≈Ç anulowany przez nadawcƒô."
              );
              return;
            }

            // Sprawd≈∫ czy link wygas≈Ç (30 sekund od pierwszego wej≈õcia)
            if (onlineVoucher.firstOpenedAt) {
              const timeSinceOpened = Date.now() - onlineVoucher.firstOpenedAt;
              if (timeSinceOpened > VOUCHER_EXPIRY_SECONDS * 1000) {
                alert(
                  t.voucherExpired ||
                    "Ten link wygas≈Ç! Masz tylko 30 sekund od pierwszego otwarcia."
                );
                return;
              }
            }

            // Oznacz jako otwarty (pierwsze wej≈õcie)
            markVoucherOpened(vid);

            // Sprawd≈∫ czy nadawca nie pr√≥buje odebraƒá swojego bonu
            const save = getCurrentSave();
            if (save && save.id === fromId) {
              alert(
                t.cantReceiveOwnVoucher || "Nie mo≈ºesz odebraƒá w≈Çasnego bonu!"
              );
              return;
            }

            if (isVoucherUsed(vid + "_sender_" + (save ? save.id : ""))) {
              alert(
                t.cantReceiveOwnVoucher || "Nie mo≈ºesz odebraƒá w≈Çasnego bonu!"
              );
              return;
            }

            const voucher = {
              id: vid,
              amount: parseInt(amount),
              fromSave: from || "?",
              fromSaveId: fromId,
              message: msg || "",
              gameMode: mode || "beamng",
              isFromLink: true,
            };
            showReceivedVoucherModal(voucher);
          }
        }

        function showReceivedVoucherModal(voucher) {
          const t = translations[currentLang] || translations.en;

          // Nazwa trybu gry
          const modeName =
            voucher.gameMode === "reallife"
              ? currentLang === "pl"
                ? "Real Life"
                : "Real Life"
              : "BeamNG";
          const voucherTypeName =
            voucher.gameMode === "reallife"
              ? currentLang === "pl"
                ? "kupon"
                : "coupon"
              : currentLang === "pl"
              ? "bon"
              : "voucher";

          document.getElementById("voucherPreviewContent").innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:1.2em;color:#888;margin-bottom:15px;">${
                      t.youReceivedVoucher || "Dosta≈Çe≈õ/a≈õ bon o warto≈õci"
                    }</div>
                    ${renderVoucherCard(voucher)}
                    <div style="font-size:0.9em;color:#888;margin-top:10px;">${
                      t.voucherFrom || "Od:"
                    } ${voucher.fromSave || "?"}</div>
                    <div style="font-size:0.85em;margin-top:8px;padding:6px 12px;background:${
                      voucher.gameMode === "reallife"
                        ? "rgba(16,185,129,0.2)"
                        : "rgba(255,107,53,0.2)"
                    };border-radius:20px;display:inline-block;">
                        ${
                          voucher.gameMode === "reallife" ? "üåç" : "üöó"
                        } ${modeName}
                    </div>
                    ${
                      voucher.isFromLink
                        ? `
                        <div id="voucherCountdown" style="font-size:1.1em;color:#ef4444;margin-top:15px;font-weight:bold;">
                            ‚è±Ô∏è <span id="countdownSeconds">30</span>s
                        </div>
                    `
                        : ""
                    }
                </div>
                
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div style="display:flex;gap:10px;">
                        <button onclick="acceptReceivedVoucher()" style="flex:1;padding:15px;background:#10b981;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;">
                            ‚úÖ ${t.acceptVoucher || "Przyjmij"}
                        </button>
                        <button onclick="rejectReceivedVoucher()" style="flex:1;padding:15px;background:#f59e0b;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;">
                            ‚Ü©Ô∏è ${t.rejectVoucher || "Przeka≈º dalej"}
                        </button>
                    </div>
                    ${
                      voucher.isFromLink
                        ? `
                        <button onclick="cancelReceivedVoucher()" style="padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-size:0.95em;cursor:pointer;">
                            ‚ùå ${
                              t.cancelAndRefund || "Anuluj (zwrot dla nadawcy)"
                            }
                        </button>
                    `
                        : ""
                    }
                </div>
            `;

          // Zapisz tymczasowo
          window.tempReceivedVoucher = voucher;
          openModal("voucherPreview");

          // Uruchom odliczanie 30 sekund (tylko dla link√≥w online)
          if (voucher.isFromLink) {
            startVoucherCountdown(voucher.id);
          }
        }

        // Odliczanie 30 sekund
        let voucherCountdownInterval = null;
        async function startVoucherCountdown(voucherId) {
          if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

          // Pobierz czas otwarcia z serwera
          const onlineVoucher = checkVoucherOnline(voucherId);
          if (!onlineVoucher || !onlineVoucher.firstOpenedAt) return;

          const startTime = onlineVoucher.firstOpenedAt;
          const endTime = startTime + VOUCHER_EXPIRY_SECONDS * 1000;

          voucherCountdownInterval = setInterval(async () => {
            const remaining = Math.max(
              0,
              Math.ceil((endTime - Date.now()) / 1000)
            );
            const countdownEl = document.getElementById("countdownSeconds");
            if (countdownEl) {
              countdownEl.textContent = remaining;
            }

            if (remaining <= 0) {
              clearInterval(voucherCountdownInterval);
              closeModal("voucherPreview");
              const t = translations[currentLang] || translations.en;
              alert(t.voucherExpired || "Czas minƒÖ≈Ç! Link wygas≈Ç.");
              window.tempReceivedVoucher = null;
            }
          }, 500);
        }

        // Anuluj bon i zwr√≥ƒá hajs nadawcy
        async function cancelReceivedVoucher() {
          if (!window.tempReceivedVoucher) return;

          const voucher = window.tempReceivedVoucher;
          const t = translations[currentLang] || translations.en;

          // Zatrzymaj odliczanie
          if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

          // Oznacz bon jako anulowany online
          cancelVoucherOnline(voucher.id);
          markVoucherAsUsed(voucher.id);

          closeModal("voucherPreview");

          const voucherName =
            voucher.gameMode === "reallife"
              ? currentLang === "pl"
                ? "Kupon"
                : "Coupon"
              : currentLang === "pl"
              ? "Bon"
              : "Voucher";
          alert(
            `‚ùå ${voucherName} ${t.cancelled || "anulowany"}!\n${
              t.refundToSender || "Zwrot dla nadawcy"
            }: ${voucher.amount.toLocaleString()} ${getCurrency()}`
          );

          window.tempReceivedVoucher = null;
        }

        async function acceptReceivedVoucher() {
          if (!window.tempReceivedVoucher) return;

          const voucher = window.tempReceivedVoucher;
          const save = getCurrentSave();
          const t = translations[currentLang] || translations.en;
          const voucherMode = voucher.gameMode || "beamng";

          // Zatrzymaj odliczanie
          if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

          // Oznacz bon jako wykorzystany
          if (voucher.isFromLink) {
            markVoucherUsedOnline(voucher.id);
            markVoucherAsUsed(voucher.id);
          } else {
            // Bon lokalny - teraz odejmij pieniƒÖdze nadawcy
            const senderSave = saves.find((s) => s.id === voucher.fromSaveId);
            if (senderSave) {
              if (senderSave.data.vouchersToSend) {
                const vIdx = senderSave.data.vouchersToSend.findIndex(
                  (v) => v.id === voucher.id
                );
                if (vIdx !== -1) {
                  senderSave.data.vouchersToSend.splice(vIdx, 1);
                }
              }
              const senderModeKey =
                voucherMode === "reallife" ? "realLifeData" : "beamngData";
              if (senderSave[senderModeKey]) {
                senderSave[senderModeKey].money =
                  (senderSave[senderModeKey].money || 0) - voucher.amount;
              }
            }
          }

          // Dodaj pieniƒÖdze odbiorcy do odpowiedniego trybu
          const receiverModeKey =
            voucherMode === "reallife" ? "realLifeData" : "beamngData";

          if (!save[receiverModeKey]) {
            save[receiverModeKey] = {
              money: 1500,
              garage: [],
              spent: 0,
              debt: 0,
              health: 100,
              food: 1000,
              water: 1000,
              backpack: [],
              activeInsurances: [],
            };
          }
          save[receiverModeKey].money =
            (save[receiverModeKey].money || 0) + voucher.amount;

          if (voucherMode === gameMode) {
            money += voucher.amount;
          }

          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          updateAllDisplays();
          closeModal("voucherPreview");

          playSound("voucher");
          const modeName = voucherMode === "reallife" ? "Real Life" : "BeamNG";
          const voucherTypeName =
            voucherMode === "reallife"
              ? currentLang === "pl"
                ? "Kupon przyjƒôty!"
                : "Coupon accepted!"
              : currentLang === "pl"
              ? "Bon przyjƒôty!"
              : "Voucher accepted!";
          alert(
            `‚úÖ ${voucherTypeName}\n+${voucher.amount.toLocaleString()} ${getCurrency()} (${modeName})`
          );

          window.tempReceivedVoucher = null;
        }

        async function rejectReceivedVoucher() {
          if (!window.tempReceivedVoucher) return;

          const voucher = window.tempReceivedVoucher;
          const save = getCurrentSave();

          // Zatrzymaj odliczanie
          if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

          // Oznacz stary bon jako wykorzystany
          if (voucher.isFromLink) {
            markVoucherUsedOnline(voucher.id);
            markVoucherAsUsed(voucher.id);
          }

          // Utw√≥rz nowy bon z nowym ID (bo przekazujesz dalej)
          const newVoucher = {
            id:
              "bon_" +
              Date.now() +
              "_" +
              Math.random().toString(36).substr(2, 6),
            amount: voucher.amount,
            message: voucher.message,
            createdAt: Date.now(),
            fromSave: save.name,
            fromSaveId: save.id,
            gameMode: voucher.gameMode || gameMode,
            originalFrom: voucher.fromSave,
          };

          if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
          save.data.vouchersToSend.push(newVoucher);

          saveSaveData();
          closeModal("voucherPreview");

          // Od razu otw√≥rz udostƒôpnianie
          currentVoucherToShare = {
            voucher: newVoucher,
            index: save.data.vouchersToSend.length - 1,
            source: "toSend",
          };
          openShareModal();

          window.tempReceivedVoucher = null;
        }

        // ==================== UI NAPRAWY ====================
        let selectedRepairCarIndex = null;

        function renderRepairCarList() {
          const list = document.getElementById("repairCarList");
          const t = translations[currentLang] || translations.en;

          // Filtruj tylko zepsute auta
          const brokenCars = garage.filter((car) => car.broken);

          if (brokenCars.length === 0) {
            list.innerHTML = `<div style="color:#888;text-align:center;padding:20px;">
                    <div style="font-size:3em;margin-bottom:10px;">‚úÖ</div>
                    <p>${t.noBrokenCars || "Wszystkie auta sƒÖ sprawne!"}</p>
                    <p style="font-size:0.85em;margin-top:10px;">${
                      t.goToGarage || "Id≈∫ do Gara≈ºu ≈ºeby ulepszaƒá auta"
                    }</p>
                </div>`;
            document.getElementById("repairResponse").style.display = "none";
            document.getElementById("repairBtn").style.display = "none";
            return;
          }

          list.innerHTML = brokenCars
            .map((car, idx) => {
              const realIdx = garage.findIndex((c) => c.id === car.id);
              return `
                    <div class="garage-item" onclick="selectCarForRepair(${realIdx})" style="cursor:pointer;background:rgba(239,68,68,0.1);border:2px solid ${
                selectedRepairCarIndex === realIdx ? "#f59e0b" : "#ef4444"
              };${
                selectedRepairCarIndex === realIdx
                  ? "background:rgba(245,158,11,0.1);"
                  : ""
              }">
                        <div>
                            <div class="car-name">üîß ${car.brand} ${
                car.model
              }</div>
                            <div style="font-size:0.8em;color:#888;">${
                              car.year || ""
                            }</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#ef4444;font-size:0.9em;">${
                              t.repairCost || "Koszt"
                            }: 150 ${getCurrency()}</div>
                            ${
                              selectedRepairCarIndex === realIdx
                                ? '<span style="color:#f59e0b;">‚úì wybrane</span>'
                                : ""
                            }
                        </div>
                    </div>
                `;
            })
            .join("");
        }

        function selectCarForRepair(idx) {
          selectedRepairCarIndex = idx;
          renderRepairCarList();
          document.getElementById("repairResponse").style.display = "block";
          document.getElementById("repairBtn").style.display = "block";

          // Aktualizuj wy≈õwietlany koszt
          const insuranceHelp = getRepairInsuranceHelp();
          const finalCost = Math.max(0, 150 - insuranceHelp);
          document.getElementById(
            "repairCostDisplay"
          ).textContent = `-${finalCost.toLocaleString()} ${getCurrency()}`;
        }

        function confirmRepair() {
          const t = translations[currentLang] || translations.en;
          const repairCost = 150; // Koszt naprawy zepsutego auta

          if (
            selectedRepairCarIndex === null ||
            selectedRepairCarIndex >= garage.length
          ) {
            alert(t.selectCarToRepair || "Wybierz auto do naprawy!");
            return;
          }

          const car = garage[selectedRepairCarIndex];

          if (!car.broken) {
            alert(t.carNotBroken || "To auto nie jest zepsute!");
            return;
          }

          // Sprawd≈∫ czy ma ubezpieczenie na naprawƒô
          const insuranceHelp = getRepairInsuranceHelp();
          const finalCost = Math.max(0, repairCost - insuranceHelp);

          if (money < finalCost) {
            // Dodaj do d≈Çug√≥w
            const save = getCurrentSave();
            if (!save.data.debts) save.data.debts = [];
            save.data.debts.push({
              type: "repair",
              amount: finalCost,
              description: `${t.repairDebt || "Naprawa auta"}: ${car.brand} ${
                car.model
              }`,
              date: Date.now(),
            });
            car.broken = false;
            saveState();
            updateAllDisplays();
            closeModal("repair");
            playSound("repair");
            alert(
              `üîß ${car.brand} ${car.model} - ${
                t.repaired || "Naprawione!"
              }\nüí≥ ${
                t.addedToDebt || "Dodano do d≈Çugu"
              }: ${finalCost.toLocaleString()} ${getCurrency()}`
            );
          } else {
            money -= finalCost;
            spent += finalCost;
            car.broken = false;
            saveState();
            updateAllDisplays();
            closeModal("repair");
            playSound("repair");

            let msg = `üîß ${car.brand} ${car.model} - ${
              t.repaired || "Naprawione!"
            }\n-${finalCost.toLocaleString()} ${getCurrency()}`;
            if (insuranceHelp > 0) {
              msg += `\nüõ°Ô∏è ${
                t.insuranceCovered || "Ubezpieczenie pokry≈Ço"
              }: ${insuranceHelp.toLocaleString()} ${getCurrency()}`;
            }
            alert(msg);
          }

          selectedRepairCarIndex = null;
        }

        function getRepairInsuranceHelp() {
          const save = getCurrentSave();
          const activeIns = save.data.activeInsurances || [];
          let help = 0;

          activeIns.forEach((ins) => {
            if (ins.type === "repair" && ins.coveragePercent) {
              help = Math.max(help, 150 * (ins.coveragePercent / 100));
            }
          });

          return Math.floor(help);
        }

        // ==================== GARA≈ª ====================

        function renderGarageModal() {
          const list = document.getElementById("garageList");
          const empty = document.getElementById("garageEmpty");
          const t = translations[currentLang] || translations.en;

          if (garage.length === 0) {
            list.style.display = "none";
            empty.style.display = "block";
            return;
          }

          list.style.display = "block";
          empty.style.display = "none";

          list.innerHTML = garage
            .map((car, idx) => {
              const upgradePercent = car.upgradePercent || 50;
              const sellPrice = Math.floor(car.price * (upgradePercent / 100));
              const isBroken = car.broken;
              const isUpgrading = car.isUpgrading || false;

              return `
                    <div style="padding:15px;margin-bottom:10px;background:${
                      isBroken
                        ? "rgba(239,68,68,0.2)"
                        : isUpgrading
                        ? "rgba(99,102,241,0.2)"
                        : "rgba(0,0,0,0.3)"
                    };border:2px solid ${
                isBroken ? "#ef4444" : isUpgrading ? "#6366f1" : "#333"
              };border-radius:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <div>
                                <div style="font-size:1.1em;font-weight:bold;">${
                                  car.brand
                                } ${car.model}</div>
                                <div style="font-size:0.85em;color:#888;">${
                                  car.year || ""
                                }</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.8em;color:#888;">${
                                  t.sellValue || "Warto≈õƒá"
                                }:</div>
                                <div style="color:#4ade80;font-weight:bold;">${sellPrice.toLocaleString()} ${getCurrency()}</div>
                                <div style="font-size:0.75em;color:${
                                  upgradePercent > 100 ? "#4ade80" : "#f59e0b"
                                };">(${upgradePercent.toFixed(1)}%)</div>
                            </div>
                        </div>
                        ${
                          isBroken
                            ? `
                            <div style="background:rgba(239,68,68,0.3);padding:8px;border-radius:8px;text-align:center;margin-bottom:10px;">
                                <span style="color:#ef4444;">üîß ${
                                  t.carBroken || "Auto zepsute!"
                                }</span>
                            </div>
                        `
                            : isUpgrading
                            ? `
                            <div style="background:rgba(99,102,241,0.3);padding:8px;border-radius:8px;text-align:center;margin-bottom:10px;">
                                <span style="color:#6366f1;">‚ö° ${
                                  t.upgrading || "Ulepszanie w toku..."
                                }</span>
                            </div>
                        `
                            : ""
                        }
                        <div style="display:flex;gap:8px;">
                            ${
                              isBroken
                                ? `
                                <button onclick="goToRepair()" style="flex:1;padding:10px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;">
                                    üîß ${t.repair || "Napraw"}
                                </button>
                            `
                                : isUpgrading
                                ? `
                                <button onclick="stopCarUpgrade(${idx})" style="flex:1;padding:10px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;">
                                    ‚è∏Ô∏è ${t.stopUpgrade || "Zatrzymaj"}
                                </button>
                            `
                                : `
                                <button onclick="startCarUpgrade(${idx})" style="flex:1;padding:10px;background:#6366f1;color:white;border:none;border-radius:8px;cursor:pointer;">
                                    ‚¨ÜÔ∏è ${t.startUpgrade || "Ulepszaj"}
                                </button>
                            `
                            }
                            <button onclick="sellCarFromGarage(${idx})" style="padding:10px 15px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;">
                                üí∞ ${t.sell || "Sprzedaj"}
                            </button>
                        </div>
                    </div>
                `;
            })
            .join("");
        }

        function goToRepair() {
          closeModal("garage");
          openModal("repair");
        }

        function sellCarFromGarage(idx) {
          const t = translations[currentLang] || translations.en;
          const car = garage[idx];
          if (!car) return;

          if (car.broken) {
            alert(
              t.cantSellBroken ||
                "Nie mo≈ºesz sprzedaƒá zepsutego auta! Najpierw je napraw."
            );
            return;
          }

          // Zatrzymaj ulepszanie przed sprzeda≈ºƒÖ
          if (car.isUpgrading) {
            stopCarUpgrade(idx);
          }

          const upgradePercent = car.upgradePercent || 50;
          const sellPrice = Math.floor(car.price * (upgradePercent / 100));

          if (
            confirm(
              `${t.confirmSell || "Sprzedaƒá"} ${car.brand} ${car.model} ${
                t.forPrice || "za"
              } ${sellPrice.toLocaleString()} ${getCurrency()}?`
            )
          ) {
            money += sellPrice;
            garage.splice(idx, 1);
            saveState();
            updateAllDisplays();
            renderGarageModal();
            renderGarage();
            alert(
              `‚úÖ ${
                t.sold || "Sprzedano!"
              } +${sellPrice.toLocaleString()} ${getCurrency()}`
            );
          }
        }

        // === NOWY SYSTEM ULEPSZANIA - jedno klikniƒôcie, dzia≈Ça w tle ===
        function startCarUpgrade(idx) {
          const car = garage[idx];
          if (!car || car.broken) return;

          car.isUpgrading = true;

          // Pobierz bonus z ubezpieczenia
          const upgradeBonus = getUpgradeBonus();
          const baseRate = 0.1 + upgradeBonus.rateBonus;
          const breakChance = 0.005 - upgradeBonus.safetyBonus;

          // Uruchom interwa≈Ç dla tego auta
          upgradeIntervals[idx] = setInterval(() => {
            const currentCar = garage[idx];
            if (!currentCar || currentCar.broken) {
              stopCarUpgrade(idx);
              return;
            }

            // Sprawd≈∫ czy siƒô zepsu≈Ço
            if (Math.random() < Math.max(0.001, breakChance)) {
              carBrokeNew(idx);
              return;
            }

            // Ulepszaj
            currentCar.upgradePercent = Math.min(
              1000,
              (currentCar.upgradePercent || 50) + baseRate
            );
            playSound("upgrade");
            saveState();
          }, 1000);

          saveState();
          renderGarageModal();
        }

        function stopCarUpgrade(idx) {
          const car = garage[idx];
          if (!car) return;

          car.isUpgrading = false;

          if (upgradeIntervals[idx]) {
            clearInterval(upgradeIntervals[idx]);
            delete upgradeIntervals[idx];
          }

          saveState();
          renderGarageModal();
        }

        function carBrokeNew(idx) {
          const t = translations[currentLang] || translations.en;
          const car = garage[idx];
          if (!car) return;

          // Zatrzymaj ulepszanie
          car.isUpgrading = false;
          if (upgradeIntervals[idx]) {
            clearInterval(upgradeIntervals[idx]);
            delete upgradeIntervals[idx];
          }

          // Oznacz jako zepsute
          car.broken = true;
          car.upgradePercent = Math.max(50, (car.upgradePercent || 50) - 5);

          playSound("break");

          // Koszty zepsucia
          const repairDebt = 150;
          if (money >= repairDebt) {
            money -= repairDebt;
            spent += repairDebt;
          } else {
            addDebt(repairDebt - money);
            money = 0;
          }

          saveState();
          updateAllDisplays();
          renderGarageModal();

          alert(
            `üí• ${car.brand} ${car.model} ${
              t.carBrokeMsg || "siƒô zepsu≈Ço!"
            }\n-150 ${getCurrency()}, -5% ${t.value || "warto≈õci"}`
          );
        }

        // Wzn√≥w ulepszanie po za≈Çadowaniu save'a
        function resumeUpgrades() {
          garage.forEach((car, idx) => {
            if (car.isUpgrading && !car.broken) {
              // Uruchom ponownie interwa≈Ç
              const upgradeBonus = getUpgradeBonus();
              const baseRate = 0.1 + upgradeBonus.rateBonus;
              const breakChance = 0.005 - upgradeBonus.safetyBonus;

              upgradeIntervals[idx] = setInterval(() => {
                const currentCar = garage[idx];
                if (!currentCar || currentCar.broken) {
                  stopCarUpgrade(idx);
                  return;
                }

                if (Math.random() < Math.max(0.001, breakChance)) {
                  carBrokeNew(idx);
                  return;
                }

                currentCar.upgradePercent = Math.min(
                  1000,
                  (currentCar.upgradePercent || 50) + baseRate
                );
                playSound("upgrade");
                saveState();
              }, 1000);
            }
          });
        }

        // Stary system - do usuniƒôcia lub zostawienia dla kompatybilno≈õci
        let upgradingCarIndex = null;
        let isUpgrading = false;
        let upgradeInterval = null;

        function openUpgradeModal(idx) {
          upgradingCarIndex = idx;
          const car = garage[idx];
          const t = translations[currentLang] || translations.en;

          document.getElementById("upgradeCarInfo").innerHTML = `
                <div style="font-size:2em;">üöó</div>
                <div style="font-size:1.3em;font-weight:bold;">${car.brand} ${
            car.model
          }</div>
                <div style="color:#888;">${car.year || ""} ‚Ä¢ ${
            car.type || ""
          }</div>
                <div style="color:#4ade80;margin-top:5px;">${
                  t.basePrice || "Cena bazowa"
                }: ${car.price.toLocaleString()} ${getCurrency()}</div>
            `;

          updateUpgradeDisplay();
          document.getElementById(
            "upgradeStatus"
          ).innerHTML = `<span style="color:#888;">${
            t.clickToStart || "Kliknij aby rozpoczƒÖƒá ulepszanie"
          }</span>`;
          document.getElementById(
            "upgradeBtn"
          ).innerHTML = `‚ñ∂Ô∏è <span data-translate="startUpgrade">${
            t.startUpgrade || "Rozpocznij ulepszanie"
          }</span>`;

          closeModal("garage");
          openModal("upgrade");
        }

        function updateUpgradeDisplay() {
          if (upgradingCarIndex === null) return;
          const car = garage[upgradingCarIndex];
          const percent = car.upgradePercent || 50;

          document.getElementById("upgradeSellPercent").textContent =
            percent.toFixed(1) + "%";
          document.getElementById("upgradeProgressBar").style.width =
            ((percent - 50) / 950) * 100 + "%";
        }

        function toggleUpgrade() {
          const t = translations[currentLang] || translations.en;

          if (isUpgrading) {
            stopUpgrade();
          } else {
            startUpgrade();
          }
        }

        function startUpgrade() {
          if (upgradingCarIndex === null) return;
          const t = translations[currentLang] || translations.en;

          isUpgrading = true;
          document.getElementById("upgradeBtn").innerHTML = `‚è∏Ô∏è <span>${
            t.stopUpgrade || "Zatrzymaj"
          }</span>`;
          document.getElementById("upgradeBtn").style.background = "#ef4444";
          document.getElementById(
            "upgradeStatus"
          ).innerHTML = `<span style="color:#4ade80;">‚ö° ${
            t.upgrading || "Ulepszanie w toku..."
          }</span>`;

          // Pobierz bonus z ubezpieczenia
          const upgradeBonus = getUpgradeBonus();
          const baseRate = 0.1 + upgradeBonus.rateBonus;
          const breakChance = 0.005 - upgradeBonus.safetyBonus; // 0.5% co sekundƒô bazowo

          upgradeInterval = setInterval(() => {
            const car = garage[upgradingCarIndex];
            if (!car) {
              stopUpgrade();
              return;
            }

            // Sprawd≈∫ czy siƒô zepsu≈Ço
            if (Math.random() < Math.max(0.001, breakChance)) {
              carBroke();
              return;
            }

            // Ulepszaj
            car.upgradePercent = Math.min(
              1000,
              (car.upgradePercent || 50) + baseRate
            );
            playSound("upgrade");
            updateUpgradeDisplay();
            saveState();
          }, 1000);
        }

        function stopUpgrade() {
          const t = translations[currentLang] || translations.en;
          isUpgrading = false;
          if (upgradeInterval) clearInterval(upgradeInterval);
          upgradeInterval = null;

          document.getElementById("upgradeBtn").innerHTML = `‚ñ∂Ô∏è <span>${
            t.startUpgrade || "Rozpocznij ulepszanie"
          }</span>`;
          document.getElementById("upgradeBtn").style.background = "#10b981";
          document.getElementById(
            "upgradeStatus"
          ).innerHTML = `<span style="color:#888;">${
            t.upgradeStopped || "Ulepszanie zatrzymane"
          }</span>`;
        }

        function carBroke() {
          const t = translations[currentLang] || translations.en;
          stopUpgrade();
          playSound("break");

          const car = garage[upgradingCarIndex];
          car.broken = true;
          car.upgradePercent = Math.max(50, (car.upgradePercent || 50) - 5);

          const repairDebt = 150;
          if (money >= repairDebt) {
            money -= repairDebt;
            spent += repairDebt;
          } else {
            // Dodaj do d≈Çug√≥w
            const save = getCurrentSave();
            if (!save.data.debts) save.data.debts = [];
            save.data.debts.push({
              type: "carBreak",
              amount: repairDebt,
              description: `${t.carBreakDebt || "Zepsucie auta"}: ${
                car.brand
              } ${car.model}`,
              date: Date.now(),
            });
          }

          saveState();
          updateAllDisplays();
          updateUpgradeDisplay();

          document.getElementById(
            "upgradeStatus"
          ).innerHTML = `<span style="color:#ef4444;">üí• ${
            t.carBrokeMsg || "Auto siƒô zepsu≈Ço! -150 z≈Ç, -5%"
          }</span>`;

          alert(
            `üí• ${
              t.carBrokeMsg || "Auto siƒô zepsu≈Ço!"
            }\n-150 ${getCurrency()}\n-5% warto≈õci`
          );
        }

        function getUpgradeBonus() {
          // Sprawd≈∫ aktywne ubezpieczenia na ulepszanie
          const save = getCurrentSave();
          const activeIns = save.data.activeInsurances || [];

          let rateBonus = 0;
          let safetyBonus = 0;

          activeIns.forEach((ins) => {
            if (ins.type === "upgrade") {
              rateBonus += ins.rateBonus || 0;
              safetyBonus += ins.safetyBonus || 0;
            }
          });

          return { rateBonus, safetyBonus };
        }

        function closeUpgradeModal() {
          stopUpgrade();
          upgradingCarIndex = null;
          closeModal("upgrade");
        }

        // ==================== PRACA ====================
        const jobs = [
          {
            id: "cleaner",
            name: "SprzƒÖtacz",
            nameEn: "Cleaner",
            basePay: 500,
            difficulty: 1,
          },
          {
            id: "cashier",
            name: "Kasjer",
            nameEn: "Cashier",
            basePay: 600,
            difficulty: 1,
          },
          {
            id: "waiter",
            name: "Kelner",
            nameEn: "Waiter",
            basePay: 700,
            difficulty: 1,
          },
          {
            id: "cook",
            name: "Kucharz",
            nameEn: "Cook",
            basePay: 900,
            difficulty: 2,
          },
          {
            id: "driver",
            name: "Kierowca",
            nameEn: "Driver",
            basePay: 1100,
            difficulty: 2,
          },
          {
            id: "mechanic",
            name: "Mechanik",
            nameEn: "Mechanic",
            basePay: 1300,
            difficulty: 2,
          },
          {
            id: "electrician",
            name: "Elektryk",
            nameEn: "Electrician",
            basePay: 1500,
            difficulty: 3,
          },
          {
            id: "programmer",
            name: "Programista",
            nameEn: "Programmer",
            basePay: 2200,
            difficulty: 3,
          },
          {
            id: "lawyer",
            name: "Prawnik",
            nameEn: "Lawyer",
            basePay: 2800,
            difficulty: 4,
          },
          {
            id: "doctor",
            name: "Lekarz",
            nameEn: "Doctor",
            basePay: 3200,
            difficulty: 4,
          },
          {
            id: "surgeon",
            name: "Chirurg",
            nameEn: "Surgeon",
            basePay: 4500,
            difficulty: 5,
          },
          {
            id: "pilot",
            name: "Pilot",
            nameEn: "Pilot",
            basePay: 5500,
            difficulty: 5,
          },
          {
            id: "ceo",
            name: "Dyrektor",
            nameEn: "CEO",
            basePay: 7000,
            difficulty: 5,
          },
        ];

        let workInterval = null;
        let sleepInterval = null;
        let coinInterval = null;
        let workTimeLeft = 120;
        let workEarned = 0;
        let workBonus = 0;
        let sleepLevel = 0;
        let currentJob = null;

        function renderJobsList() {
          const list = document.getElementById("jobsList");
          const t = translations[currentLang] || translations.en;

          list.innerHTML = jobs
            .map((job) => {
              const difficultyStars = "‚≠ê".repeat(job.difficulty);
              const jobName = currentLang === "pl" ? job.name : job.nameEn;

              return `
                    <div onclick="startWork('${
                      job.id
                    }')" style="padding:15px;margin-bottom:10px;background:rgba(0,0,0,0.3);border:2px solid #333;border-radius:12px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='#333'">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-size:1.1em;font-weight:bold;">${jobName}</div>
                                <div style="font-size:0.85em;color:#888;">${difficultyStars}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:#4ade80;font-weight:bold;">${job.basePay.toLocaleString()} ${getCurrency()}</div>
                                <div style="font-size:0.75em;color:#888;">+ ${
                                  t.bonuses || "bonusy"
                                }</div>
                            </div>
                        </div>
                    </div>
                `;
            })
            .join("");
        }

        function startWork(jobId) {
          currentJob = jobs.find((j) => j.id === jobId);
          if (!currentJob) return;

          const t = translations[currentLang] || translations.en;
          workTimeLeft = 120;
          workEarned = 0;
          workBonus = 0;
          sleepLevel = 0;

          document.getElementById("workJobName").textContent =
            currentLang === "pl" ? currentJob.name : currentJob.nameEn;
          document.getElementById("workTimer").textContent = "2:00";
          document.getElementById("workEarned").textContent = "0";
          document.getElementById("workBonus").textContent = "0";
          document.getElementById("sleepOverlayTop").style.height = "0";
          document.getElementById("sleepOverlayBottom").style.height = "0";
          document.getElementById("coinsContainer").innerHTML = "";

          closeModal("work");
          openModal("workGame");
          playSound("workStart");

          // Timer
          workInterval = setInterval(() => {
            workTimeLeft--;
            const mins = Math.floor(workTimeLeft / 60);
            const secs = workTimeLeft % 60;
            document.getElementById("workTimer").textContent = `${mins}:${secs
              .toString()
              .padStart(2, "0")}`;

            if (workTimeLeft <= 0) {
              endWork();
            }
          }, 1000);

          // Zasypianie - im trudniejsza praca tym WOLNIEJ zasypiasz (bo jeste≈õ skupiony)
          // Ale ≈Çatwiejsze prace = szybciej zasypiasz z nud√≥w
          const sleepRate = 1.5 - currentJob.difficulty * 0.2; // 1‚≠ê = 1.3, 5‚≠ê = 0.5 - szybsze zasypianie
          sleepInterval = setInterval(() => {
            sleepLevel = Math.min(48, sleepLevel + sleepRate); // max 48% - prawie nic nie widaƒá
            updateSleepVisuals();
          }, 300); // szybsze tickowanie

          // SpadajƒÖce monety - trudniejsza praca = wiƒôcej monet (bo wiƒôcej okazji)
          const coinRate = 800 + currentJob.difficulty * 200; // 1‚≠ê = 1000ms, 5‚≠ê = 1800ms miƒôdzy monetami
          coinInterval = setInterval(() => {
            spawnCoin();
          }, coinRate);
        }

        function spawnCoin() {
          const container = document.getElementById("coinsContainer");
          const coin = document.createElement("div");
          coin.className = "falling-coin";
          coin.innerHTML = "üí∞";
          coin.style.cssText = `
                position: absolute;
                top: -60px;
                left: ${Math.random() * 80 + 10}%;
                font-size: 4em;
                cursor: pointer;
                z-index: 5;
                transition: top 3s linear;
            `;

          coin.onclick = () => {
            playSound("coin");
            workBonus += 100;
            document.getElementById("workBonus").textContent =
              workBonus.toLocaleString();
            coin.innerHTML = "+100";
            coin.style.color = "#4ade80";
            coin.style.fontSize = "2em";
            setTimeout(() => coin.remove(), 300);
          };

          container.appendChild(coin);

          setTimeout(() => {
            coin.style.top = "calc(100% + 60px)";
          }, 50);

          setTimeout(() => {
            if (coin.parentNode) coin.remove();
          }, 3500);
        }

        function updateSleepVisuals() {
          document.getElementById("sleepOverlayTop").style.height =
            sleepLevel + "%";
          document.getElementById("sleepOverlayBottom").style.height =
            sleepLevel + "%";

          // Monety prawie niewidoczne przy max ≈õnie
          const coinsOpacity = 1 - (sleepLevel / 48) * 0.95; // od 1 do 0.05
          document.getElementById("coinsContainer").style.opacity =
            coinsOpacity;
        }

        // P≈Çynne otwieranie oczu - im wiƒôcej ≈õpisz tym wolniej siƒô otwierajƒÖ
        let wakeUpInterval = null;

        function startWakeUp() {
          if (wakeUpInterval) return;
          wakeUpInterval = setInterval(() => {
            // Im wiƒôcej ≈õpisz, tym wolniej otwierasz oczy (mniejszy krok)
            const openSpeed = Math.max(0.5, 3 - (sleepLevel / 48) * 2.5); // od 3 do 0.5
            sleepLevel = Math.max(0, sleepLevel - openSpeed);
            updateSleepVisuals();
          }, 50); // p≈Çynna animacja
        }

        function stopWakeUp() {
          if (wakeUpInterval) {
            clearInterval(wakeUpInterval);
            wakeUpInterval = null;
          }
        }

        function wakeUp() {
          // Pojedyncze klikniƒôcie - ma≈Çe otwarcie
          const openSpeed = Math.max(0.5, 3 - (sleepLevel / 48) * 2.5);
          sleepLevel = Math.max(0, sleepLevel - openSpeed * 2);
          updateSleepVisuals();
        }

        // Przerwij pracƒô wcze≈õniej (-3% wyp≈Çaty)
        function quitWorkEarly() {
          if (!confirm("Przerwaƒá pracƒô? Dostaniesz 3% mniej wyp≈Çaty.")) return;

          clearInterval(workInterval);
          clearInterval(sleepInterval);
          clearInterval(coinInterval);
          stopWakeUp();

          const t = translations[currentLang] || translations.en;
          const basePay = currentJob.basePay;

          // Proporcja przepracowanego czasu (120s = pe≈Çny czas)
          const timeWorked = 120 - workTimeLeft;
          const timeRatio = timeWorked / 120;

          // Podstawa proporcjonalna do czasu
          const proportionalBase = Math.round(basePay * timeRatio);

          // Bonus za zebrane monety
          const totalEarned = proportionalBase + workBonus;

          // Kara za spanie
          const sleepPenalty = (sleepLevel / 45) * 0.9;
          const moneyLostSleep = Math.round(totalEarned * sleepPenalty);

          // Kara 3% za wcze≈õniejsze przerwanie
          const earlyPenalty = 0.03;
          const moneyLostEarly = Math.round(
            (totalEarned - moneyLostSleep) * earlyPenalty
          );

          // Finalna wyp≈Çata (zaokrƒÖglona)
          const finalPay = Math.round(
            totalEarned - moneyLostSleep - moneyLostEarly
          );

          money += finalPay;
          saveState();
          updateAllDisplays();

          closeModal("workGame");
          playSound("workEnd");

          let msg = `üíº ${t.workInterrupted || "Praca przerwana!"}\n\n`;
          msg += `‚è±Ô∏è Przepracowano: ${Math.floor(timeWorked / 60)}:${(
            timeWorked % 60
          )
            .toString()
            .padStart(2, "0")}\n`;
          msg += `${
            t.basePay || "Podstawa"
          }: ${proportionalBase.toLocaleString()} ${getCurrency()}\n`;
          msg += `üí∞ ${
            t.coinsCollected || "Zebrane monety"
          }: +${workBonus.toLocaleString()} ${getCurrency()}\n`;
          if (moneyLostSleep > 0) {
            msg += `üò¥ ${
              t.sleepPenalty || "Strata za spanie"
            }: -${moneyLostSleep.toLocaleString()} ${getCurrency()}\n`;
          }
          msg += `‚èπÔ∏è Kara za przerwanie: -${moneyLostEarly.toLocaleString()} ${getCurrency()} (3%)\n`;
          msg += `\n${
            t.total || "Razem"
          }: ${finalPay.toLocaleString()} ${getCurrency()}`;

          alert(msg);
          currentJob = null;
        }

        function endWork() {
          clearInterval(workInterval);
          clearInterval(sleepInterval);
          clearInterval(coinInterval);
          stopWakeUp(); // Zatrzymaj otwieranie oczu

          const t = translations[currentLang] || translations.en;
          const basePay = currentJob.basePay;

          // Bonus za klikanie monet
          const totalEarned = basePay + workBonus;

          // Im wiƒôcej ≈õpisz (sleepLevel 0-45), tym wiƒôcej TRACISZ (0-90%)
          const sleepPenalty = (sleepLevel / 45) * 0.9;
          const moneyLost = Math.floor(totalEarned * sleepPenalty);
          const finalPay = totalEarned - moneyLost;

          money += finalPay;
          saveState();
          updateAllDisplays();

          closeModal("workGame");
          playSound("workEnd");

          const penaltyPercent = Math.floor(sleepPenalty * 100);
          let msg = `üíº ${t.workDone || "Praca zako≈Ñczona!"}\n\n`;
          msg += `${
            t.basePay || "Podstawa"
          }: ${basePay.toLocaleString()} ${getCurrency()}\n`;
          msg += `üí∞ ${
            t.coinsCollected || "Zebrane monety"
          }: +${workBonus.toLocaleString()} ${getCurrency()}\n`;
          if (moneyLost > 0) {
            msg += `üò¥ ${
              t.sleepPenalty || "Strata za spanie"
            }: -${moneyLost.toLocaleString()} ${getCurrency()} (${penaltyPercent}%)\n`;
          }
          msg += `\n${
            t.total || "Razem"
          }: ${finalPay.toLocaleString()} ${getCurrency()}`;

          alert(msg);
          currentJob = null;
        }

        // ==================== UI SYSTEMU ONLINE ====================

        // Renderuj konto online
        function renderOnlineAccount() {
          const t = translations[currentLang] || translations.en;
          const content = document.getElementById("onlineAccountContent");

          // Pobierz znajomych z localStorage
          const friends = JSON.parse(
            localStorage.getItem("beamng_friends") || "[]"
          );

          content.innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:3em;margin-bottom:10px;">üë§</div>
                    <div style="font-size:1.3em;font-weight:bold;">${playerName}</div>
                    <button onclick="editPlayerName()" style="margin-top:8px;padding:6px 15px;background:#333;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">
                        ‚úèÔ∏è ${t.editName || "Zmie≈Ñ nazwƒô"}
                    </button>
                </div>
                
                <!-- Zapro≈õ znajomego -->
                <div style="background:#1a1a2e;padding:15px;border-radius:10px;margin-bottom:15px;">
                    <div style="font-weight:bold;margin-bottom:10px;">‚ûï ${
                      t.inviteFriend || "Zapro≈õ znajomego"
                    }</div>
                    <button onclick="generateFriendInviteLink()" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;">
                        üîó ${t.generateLink || "Wygeneruj link zaproszenia"}
                    </button>
                </div>
                
                <!-- Lista znajomych -->
                <div style="background:#1a1a2e;padding:15px;border-radius:10px;margin-bottom:15px;">
                    <div style="font-weight:bold;margin-bottom:10px;">‚≠ê ${
                      t.friends || "Znajomi"
                    }: ${friends.length}</div>
                    ${
                      friends.length > 0
                        ? `
                        <div style="max-height:200px;overflow-y:auto;">
                            ${friends
                              .map(
                                (f) => `
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#222;border-radius:6px;margin-bottom:5px;">
                                    <span style="flex:1;">üë§ ${f}</span>
                                    <div style="display:flex;gap:5px;">
                                        <button onclick="openChat('${f}')" style="padding:6px 12px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">üí¨</button>
                                        <button onclick="removeFriend('${f}')" style="padding:6px 12px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">‚úñ</button>
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        <p style="color:#888;font-size:0.75em;margin-top:8px;text-align:center;">üí¨ Wiadomo≈õƒá: ${CHAT_MESSAGE_FEE.toFixed(
                          2
                        )} ${getCurrency()}</p>
                    `
                        : `<div style="color:#666;text-align:center;padding:15px;">${
                            t.noFriends || "Brak znajomych"
                          }<br><span style="font-size:0.85em;">Wy≈õlij link zaproszenia!</span></div>`
                    }
                </div>
            `;
        }

        // ========== SYSTEM ZNAJOMYCH (przez link) ==========
        function generateFriendInviteLink() {
          const baseUrl = window.location.href.split("?")[0];
          const link = `${baseUrl}?friend_invite=${encodeURIComponent(
            playerName
          )}`;

          if (navigator.share) {
            navigator.share({
              title: "Zaproszenie do znajomych - BeamNG Datapack",
              text: `${playerName} zaprasza Ciƒô do znajomych!`,
              url: link,
            });
          } else {
            navigator.clipboard.writeText(link);
            showToast("üìã Link skopiowany!");
          }
        }

        function checkFriendInvite() {
          const params = new URLSearchParams(window.location.search);
          const inviteFrom = params.get("friend_invite");

          if (inviteFrom && playerName && inviteFrom !== playerName) {
            // Usu≈Ñ parametr z URL
            window.history.replaceState({}, "", window.location.pathname);

            // Poka≈º modal potwierdzenia
            if (
              confirm(
                `üëã ${inviteFrom} zaprasza Ciƒô do znajomych!\n\nCzy chcesz dodaƒá ${inviteFrom} do znajomych?`
              )
            ) {
              addFriendDirect(inviteFrom);
            }
          }
        }

        function addFriendDirect(friendName) {
          let friends = JSON.parse(
            localStorage.getItem("beamng_friends") || "[]"
          );

          if (friends.includes(friendName)) {
            showToast("‚ÑπÔ∏è Ju≈º jest znajomym");
            return;
          }

          friends.push(friendName);
          localStorage.setItem("beamng_friends", JSON.stringify(friends));

          showToast(`‚úÖ Dodano ${friendName} do znajomych!`);
          renderOnlineAccount();
        }

        function removeFriend(friendName) {
          if (!confirm(`UsunƒÖƒá ${friendName} ze znajomych?`)) return;

          let friends = JSON.parse(
            localStorage.getItem("beamng_friends") || "[]"
          );
          friends = friends.filter((f) => f !== friendName);
          localStorage.setItem("beamng_friends", JSON.stringify(friends));

          showToast(`üóëÔ∏è Usuniƒôto ${friendName}`);
          renderOnlineAccount();
        }

        function getFriendsList() {
          return JSON.parse(localStorage.getItem("beamng_friends") || "[]");
        }

        // Powiadomienia - uproszczone (lokalne)
        function renderNotifications() {
          const t = translations[currentLang] || translations.en;
          const list = document.getElementById("notificationsList");
          list.innerHTML = `<p style="color:#888;text-align:center;">${
            t.noNotifications || "Brak powiadomie≈Ñ"
          }</p>`;
        }

        // ========== SYSTEM CZATU ==========
        let currentChatUser = null;
        let chatInterval = null;

        function openChat(username) {
          if (!playerName) return;

          // Sprawd≈∫ czy to znajomy
          const friends = getFriendsList();
          const isFriend = friends.includes(username);

          if (!isFriend) {
            showToast("‚ùå Mo≈ºesz pisaƒá tylko ze znajomymi!");
            return;
          }

          currentChatUser = username;
          document.getElementById("chatWithName").textContent = username;
          closeModal("notifications");
          closeModal("onlineAccount");
          openModal("chat");
          loadChatMessages();

          // Od≈õwie≈ºaj czat co 3 sekundy
          if (chatInterval) clearInterval(chatInterval);
          chatInterval = setInterval(loadChatMessages, 3000);
        }

        function closeChatModal() {
          if (chatInterval) clearInterval(chatInterval);
          chatInterval = null;
          currentChatUser = null;
          closeModal("chat");
        }

        function loadChatMessages() {
          if (!currentChatUser || !playerName) return;

          const data = getOnlineData();
          if (!data.chats) data.chats = {};

          // Chat ID to posortowane nazwy u≈ºytkownik√≥w
          const chatId = [playerName, currentChatUser].sort().join("_");
          const chat = data.chats[chatId] || { messages: [] };

          const container = document.getElementById("chatMessages");
          if (!container) return;

          if (chat.messages.length === 0) {
            container.innerHTML =
              '<p style="color:#666;text-align:center;">Brak wiadomo≈õci</p>';
            return;
          }

          container.innerHTML = chat.messages
            .map((m) => {
              const isMe = m.from === playerName;
              return `
                    <div style="margin-bottom:8px;text-align:${
                      isMe ? "right" : "left"
                    };">
                        <div style="display:inline-block;max-width:80%;padding:8px 12px;border-radius:12px;background:${
                          isMe ? "#3b82f6" : "#333"
                        };">
                            ${m.text}
                        </div>
                        <div style="font-size:0.7em;color:#666;margin-top:2px;">${formatTimeAgo(
                          m.timestamp
                        )}</div>
                    </div>
                `;
            })
            .join("");

          container.scrollTop = container.scrollHeight;
        }

        function sendChatMessage() {
          const input = document.getElementById("chatInput");
          const text = input.value.trim();
          if (!text || !currentChatUser || !playerName) return;

          const save = getCurrentSave();
          const t = translations[currentLang] || translations.en;

          // Sprawd≈∫ czy staƒá na wiadomo≈õƒá
          if (save.data.money < CHAT_MESSAGE_FEE) {
            showToast(
              `‚ùå ${
                t.notEnoughMoney || "Brak ≈õrodk√≥w"
              } (${CHAT_MESSAGE_FEE.toFixed(2)} ${getCurrency()})`
            );
            return;
          }

          // Pobierz op≈Çatƒô
          save.data.money -= CHAT_MESSAGE_FEE;
          saveSaveData();
          updateAllDisplays();

          const data = getOnlineData();
          if (!data.chats) data.chats = {};

          const chatId = [playerName, currentChatUser].sort().join("_");
          if (!data.chats[chatId]) {
            data.chats[chatId] = {
              messages: [],
              participants: [playerName, currentChatUser],
            };
          }

          data.chats[chatId].messages.push({
            from: playerName,
            text: text,
            timestamp: Date.now(),
          });

          // Ogranicz do 100 ostatnich wiadomo≈õci
          if (data.chats[chatId].messages.length > 100) {
            data.chats[chatId].messages =
              data.chats[chatId].messages.slice(-100);
          }

          saveOnlineData(data);

          // Wy≈õlij powiadomienie do drugiej osoby
          sendNotification(currentChatUser, {
            type: "chatMessage",
            from: playerName,
            preview: text.substring(0, 50),
          });

          input.value = "";
          loadChatMessages();
        }

        // Enter wysy≈Ça wiadomo≈õƒá
        document.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && e.target.id === "chatInput") {
            sendChatMessage();
          }
        });

        // Renderuj aukcje
        let currentAuctionTab = "browse";

        async function showAuctionTab(tab) {
          currentAuctionTab = tab;
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => (b.style.background = "#222"));
          document.getElementById(
            "tab" + tab.charAt(0).toUpperCase() + tab.slice(1)
          ).style.background = "#333";
        }

        async function renderAuctionContent() {
          const t = translations[currentLang] || translations.en;
          const content = document.getElementById("auctionContent");

          if (!playerName) {
            content.innerHTML = `<p style="color:#888;text-align:center;padding:20px;">${
              t.loginFirst || "Najpierw siƒô zaloguj"
            }</p>`;
            return;
          }

          if (currentAuctionTab === "browse") {
            const auctions = await getActiveAuctions();
            const otherAuctions = auctions.filter(
              (a) => a.seller !== playerName
            );

            if (otherAuctions.length === 0) {
              content.innerHTML = `<p style="color:#888;text-align:center;padding:20px;">${
                t.noAuctions || "Brak aukcji"
              }</p>`;
              return;
            }

            content.innerHTML = otherAuctions
              .map((a) => {
                const displayName =
                  a.name ||
                  (a.item
                    ? a.item.name || a.item.brand + " " + a.item.model
                    : "Pakiet");
                const icon =
                  a.items && a.items.length > 1
                    ? "üì¶"
                    : a.items && a.items[0]
                    ? getItemIcon(a.items[0])
                    : "üì¶";
                return `
                    <div onclick="showAuctionDetail('${
                      a.id
                    }')" style="background:#1a1a2e;padding:12px;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:bold;">${icon} ${displayName}</div>
                            <div style="color:#888;font-size:0.85em;">${
                              t.seller || "Sprzedawca"
                            }: ${a.seller}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#10b981;font-weight:bold;">${a.price.toLocaleString()} ${getCurrency()}</div>
                        </div>
                    </div>
                `;
              })
              .join("");
          } else if (currentAuctionTab === "my") {
            const auctions = await getActiveAuctions();
            const myAuctions = auctions.filter((a) => a.seller === playerName);

            if (myAuctions.length === 0) {
              content.innerHTML = `<p style="color:#888;text-align:center;padding:20px;">${
                t.noMyAuctions || "Nie masz wystawionych przedmiot√≥w"
              }</p>`;
              return;
            }

            content.innerHTML = myAuctions
              .map((a) => {
                const displayName =
                  a.name ||
                  (a.item
                    ? a.item.name || a.item.brand + " " + a.item.model
                    : "Pakiet");
                const icon =
                  a.items && a.items.length > 1
                    ? "üì¶"
                    : a.items && a.items[0]
                    ? getItemIcon(a.items[0])
                    : "üì¶";
                return `
                    <div style="background:#1a1a2e;padding:12px;border-radius:8px;margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:bold;">${icon} ${displayName}</div>
                                <div style="color:#10b981;">${a.price.toLocaleString()} ${getCurrency()}</div>
                            </div>
                            <button onclick="cancelAuction('${
                              a.id
                            }')" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;">‚ùå</button>
                        </div>
                        ${
                          a.negotiations && a.negotiations.length > 0
                            ? `<div style="color:#f59e0b;font-size:0.85em;margin-top:8px;">üí¨ ${
                                a.negotiations.length
                              } ${t.negotiations || "negocjacji"}</div>`
                            : ""
                        }
                    </div>
                `;
              })
              .join("");
          } else if (currentAuctionTab === "create") {
            // Lista rzeczy do wystawienia
            const save = getCurrentSave();

            content.innerHTML = `
                    <div style="margin-bottom:15px;">
                        <p style="color:#888;margin-bottom:10px;">${
                          t.selectItemsToSell || "Zaznacz co chcesz wystawiƒá:"
                        }</p>
                        
                        <div style="font-weight:bold;margin:15px 0 8px;color:#f59e0b;">üöó ${
                          t.cars || "Auta"
                        }</div>
                        <div id="auctionCarsList"></div>
                        
                        <div style="font-weight:bold;margin:15px 0 8px;color:#10b981;">üçî ${
                          t.food || "Jedzenie"
                        }</div>
                        <div id="auctionFoodList"></div>
                        
                        <div style="font-weight:bold;margin:15px 0 8px;color:#8b5cf6;">üõ°Ô∏è ${
                          t.customInsurance || "W≈Çasne ubezpieczenie"
                        }</div>
                        <button onclick="showCreateInsuranceForm()" style="width:100%;padding:12px;background:#1a1a2e;border:2px dashed #8b5cf6;border-radius:8px;color:#8b5cf6;cursor:pointer;">
                            ‚ûï ${t.createInsurance || "Stw√≥rz ubezpieczenie"}
                        </button>
                        <div id="customInsurancePreview" style="margin-top:10px;"></div>
                    </div>
                    
                    <div id="auctionSelectedItems" style="background:#1a1a2e;padding:12px;border-radius:8px;margin:15px 0;display:none;">
                        <div style="font-weight:bold;margin-bottom:8px;">üì¶ ${
                          t.selectedItems || "Wybrane"
                        }:</div>
                        <div id="selectedItemsList"></div>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <label style="color:#888;font-size:0.9em;">${
                          t.totalPrice || "Cena za pakiet"
                        }:</label>
                        <input type="number" id="auctionPackagePrice" placeholder="0" style="width:100%;padding:12px;background:#1a1a2e;border:2px solid #333;border-radius:8px;color:white;font-size:1.2em;margin-top:5px;">
                    </div>
                    
                    <button onclick="createAuctionPackage()" style="width:100%;padding:15px;background:#10b981;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;margin-top:15px;">
                        ‚úÖ ${t.listForSale || "Wystaw na sprzeda≈º"}
                    </button>
                `;

            renderAuctionItemLists();
          }
        }

        // Wybrane przedmioty do aukcji
        let auctionSelectedCars = [];
        let auctionSelectedFood = [];
        let auctionCustomInsurance = null;

        function renderAuctionItemLists() {
          const t = translations[currentLang] || translations.en;

          // Auta - u≈ºywaj globalnej zmiennej garage
          const carsList = document.getElementById("auctionCarsList");
          if (!carsList) return;

          if (garage.length === 0) {
            carsList.innerHTML = `<p style="color:#666;font-size:0.9em;">${
              t.noCars || "Brak aut"
            }</p>`;
          } else {
            carsList.innerHTML = garage
              .map(
                (car, i) => `
                    <div onclick="toggleAuctionCar(${i})" style="background:${
                  auctionSelectedCars.includes(i) ? "#2a4a2a" : "#222"
                };padding:10px;border-radius:6px;margin-bottom:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:2px solid ${
                  auctionSelectedCars.includes(i) ? "#10b981" : "transparent"
                };">
                        <span>${car.brand} ${car.model}</span>
                        <span style="color:#888;">${car.price.toLocaleString()} ${getCurrency()}</span>
                    </div>
                `
              )
              .join("");
          }

          // Jedzenie - u≈ºywaj globalnej zmiennej backpack
          const foodList = document.getElementById("auctionFoodList");
          if (!foodList) return;

          if (backpack.length === 0) {
            foodList.innerHTML = `<p style="color:#666;font-size:0.9em;">${
              t.noFood || "Brak jedzenia"
            }</p>`;
          } else {
            // Grupuj jedzenie wed≈Çug id
            const groupedFood = {};
            for (let i = 0; i < backpack.length; i++) {
              const item = backpack[i];
              const key = item.id || item.nameKey || "item_" + i;
              if (!groupedFood[key]) {
                groupedFood[key] = { item: item, indices: [], count: 0 };
              }
              groupedFood[key].indices.push(i);
              groupedFood[key].count++;
            }

            let html = "";
            for (const key in groupedFood) {
              const data = groupedFood[key];
              const item = data.item;
              const itemName = item.nameKey
                ? translations[currentLang][item.nameKey] || item.nameKey
                : item.name || "Przedmiot";
              const icon = item.icon || "üì¶";
              const selectedCount = data.indices.filter((i) =>
                auctionSelectedFood.includes(i)
              ).length;
              const isSelected = selectedCount > 0;
              const allSelected = selectedCount === data.count;

              html += `
                    <div onclick="toggleAuctionFoodGroup('${key}')" style="background:${
                isSelected ? "#2a4a2a" : "#222"
              };padding:10px;border-radius:6px;margin-bottom:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:2px solid ${
                allSelected ? "#10b981" : isSelected ? "#4a7a4a" : "transparent"
              };">
                        <span>${icon} ${itemName} ${
                data.count > 1
                  ? '<span style="color:#ff6b35;">x' + data.count + "</span>"
                  : ""
              }</span>
                        <span style="color:#888;">${(
                          item.price || 0
                        ).toLocaleString()} ${getCurrency()}</span>
                    </div>`;
            }
            foodList.innerHTML = html;
          }

          updateSelectedItemsPreview();
        }

        // Przechowuj grupowanie
        let foodGroups = {};

        function updateFoodGroups() {
          foodGroups = {};
          backpack.forEach((item, i) => {
            const key = item.id || item.nameKey || item.name;
            if (!foodGroups[key]) {
              foodGroups[key] = [];
            }
            foodGroups[key].push(i);
          });
        }

        function toggleAuctionFoodGroup(key) {
          updateFoodGroups();
          const indices = foodGroups[key] || [];

          // Sprawd≈∫ ile jest ju≈º zaznaczonych
          const selectedCount = indices.filter((i) =>
            auctionSelectedFood.includes(i)
          ).length;

          if (selectedCount === indices.length) {
            // Wszystkie zaznaczone - odznacz wszystkie
            indices.forEach((i) => {
              auctionSelectedFood = auctionSelectedFood.filter((x) => x !== i);
            });
          } else {
            // Nie wszystkie zaznaczone - zaznacz wszystkie
            indices.forEach((i) => {
              if (!auctionSelectedFood.includes(i)) {
                auctionSelectedFood.push(i);
              }
            });
          }

          renderAuctionItemLists();
        }

        function toggleAuctionCar(index) {
          if (auctionSelectedCars.includes(index)) {
            auctionSelectedCars = auctionSelectedCars.filter(
              (i) => i !== index
            );
          } else {
            auctionSelectedCars.push(index);
          }
          renderAuctionItemLists();
        }

        function updateSelectedItemsPreview() {
          const t = translations[currentLang] || translations.en;

          const container = document.getElementById("auctionSelectedItems");
          const list = document.getElementById("selectedItemsList");

          if (!container || !list) return;

          const hasItems =
            auctionSelectedCars.length > 0 ||
            auctionSelectedFood.length > 0 ||
            auctionCustomInsurance;
          container.style.display = hasItems ? "block" : "none";

          if (!hasItems) return;

          let html = "";
          let totalValue = 0;

          auctionSelectedCars.forEach((i) => {
            const car = garage[i];
            if (car) {
              html += `<div style="color:#f59e0b;">üöó ${car.brand} ${car.model}</div>`;
              totalValue += car.price;
            }
          });

          auctionSelectedFood.forEach((i) => {
            const item = backpack[i];
            if (item) {
              const itemName = item.nameKey ? getItemName(item) : item.name;
              const icon = item.icon || "üçî";
              html += `<div style="color:#10b981;">${icon} ${itemName}</div>`;
              totalValue += item.price || 0;
            }
          });

          if (auctionCustomInsurance) {
            html += `<div style="color:#8b5cf6;">üõ°Ô∏è ${auctionCustomInsurance.name}</div>`;
            if (auctionCustomInsurance.creationCost) {
              html += `<div style="color:#f59e0b;font-size:0.85em;margin-left:20px;">üí∞ ${
                t.creationCost || "Koszt"
              }: ${auctionCustomInsurance.creationCost.toLocaleString()} ${getCurrency()}</div>`;
            }
          }

          list.innerHTML = html;

          // Ustaw sugerowanƒÖ cenƒô
          const priceInput = document.getElementById("auctionPackagePrice");
          if (priceInput && !priceInput.value) {
            priceInput.placeholder = totalValue.toLocaleString();
          }
        }

        function showCreateInsuranceForm() {
          const t = translations[currentLang] || translations.en;
          const preview = document.getElementById("customInsurancePreview");

          preview.innerHTML = `
                <div style="background:#2a2a4e;padding:15px;border-radius:8px;border:2px solid #8b5cf6;">
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.insuranceName || "Nazwa ubezpieczenia"
                        }:</label>
                        <input type="text" id="customInsName" placeholder="${
                          t.myInsurance || "Moje ubezpieczenie"
                        }" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.whatItGives || "Co daje"
                        } (HP/jedzenie/woda):</label>
                        <div style="display:flex;gap:10px;margin-top:3px;">
                            <input type="number" id="customInsHP" placeholder="HP" style="flex:1;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;">
                            <input type="number" id="customInsFood" placeholder="üçî" style="flex:1;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;">
                            <input type="number" id="customInsWater" placeholder="üíß" style="flex:1;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.coveragePercent || "Pokrycie napraw"
                        } (%):</label>
                        <input type="number" id="customInsCoverage" placeholder="50" min="0" max="100" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.paymentInterval || "Op≈Çata co ile minut"
                        }:</label>
                        <input type="number" id="customInsInterval" placeholder="60" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.paymentAmount || "Kwota op≈Çaty"
                        }:</label>
                        <input type="number" id="customInsPayment" placeholder="100" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="display:flex;gap:10px;">
                        <button onclick="addCustomInsurance()" style="flex:1;padding:10px;background:#8b5cf6;color:white;border:none;border-radius:6px;cursor:pointer;">‚úÖ ${
                          t.add || "Dodaj"
                        }</button>
                        <button onclick="cancelCustomInsurance()" style="flex:1;padding:10px;background:#333;color:white;border:none;border-radius:6px;cursor:pointer;">‚ùå ${
                          t.cancel || "Anuluj"
                        }</button>
                    </div>
                </div>
            `;
        }

        // Ceny za tworzenie ubezpieczenia
        const INSURANCE_COST_PER_FOOD = 5; // 5 z≈Ç za 1 kaloriƒô
        const INSURANCE_COST_PER_WATER = 15; // 15 z≈Ç za 1 ml
        const INSURANCE_COST_PER_HP = 20; // 20 z≈Ç za 1 HP
        const INSURANCE_MAX_VALUE = 1000; // Max dla ka≈ºdego

        function calculateInsuranceCost(ins) {
          const foodCost = (ins.food || 0) * INSURANCE_COST_PER_FOOD;
          const waterCost = (ins.water || 0) * INSURANCE_COST_PER_WATER;
          const hpCost = (ins.hp || 0) * INSURANCE_COST_PER_HP;
          return foodCost + waterCost + hpCost;
        }

        function addCustomInsurance() {
          const t = translations[currentLang] || translations.en;

          const name =
            document.getElementById("customInsName").value.trim() ||
            t.myInsurance ||
            "Moje ubezpieczenie";
          let hp = parseInt(document.getElementById("customInsHP").value) || 0;
          let food =
            parseInt(document.getElementById("customInsFood").value) || 0;
          let water =
            parseInt(document.getElementById("customInsWater").value) || 0;
          const coverage =
            parseInt(document.getElementById("customInsCoverage").value) || 0;
          const interval =
            parseInt(document.getElementById("customInsInterval").value) || 60;
          const payment =
            parseInt(document.getElementById("customInsPayment").value) || 100;

          // Limity max 1000
          hp = Math.min(INSURANCE_MAX_VALUE, Math.max(0, hp));
          food = Math.min(INSURANCE_MAX_VALUE, Math.max(0, food));
          water = Math.min(INSURANCE_MAX_VALUE, Math.max(0, water));

          const insuranceData = {
            type: "customInsurance",
            name: name,
            hp: hp,
            food: food,
            water: water,
            coverage: Math.min(100, Math.max(0, coverage)),
            interval: interval,
            payment: payment,
          };

          const creationCost = calculateInsuranceCost(insuranceData);

          // Sprawd≈∫ czy staƒá gracza
          if (creationCost > money) {
            alert(
              `${t.notEnoughMoney || "Nie masz wystarczajƒÖco pieniƒôdzy!"}\n${
                t.cost || "Koszt"
              }: ${creationCost.toLocaleString()} ${getCurrency()}`
            );
            return;
          }

          auctionCustomInsurance = insuranceData;
          auctionCustomInsurance.creationCost = creationCost;

          const preview = document.getElementById("customInsurancePreview");
          preview.innerHTML = `
                <div style="background:#2a2a4e;padding:12px;border-radius:8px;border:2px solid #8b5cf6;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:bold;color:#8b5cf6;">üõ°Ô∏è ${name}</div>
                            <div style="color:#888;font-size:0.85em;">
                                ${hp > 0 ? `+${hp} HP ` : ""}${
            food > 0 ? `+${food} üçî ` : ""
          }${water > 0 ? `+${water} üíß ` : ""}${
            coverage > 0 ? `${coverage}% napraw ` : ""
          }
                            </div>
                            <div style="color:#666;font-size:0.8em;">${payment} ${getCurrency()} / ${interval} min</div>
                        </div>
                        <button onclick="removeCustomInsurance()" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;">‚ùå</button>
                    </div>
                    <div style="margin-top:8px;padding-top:8px;border-top:1px solid #444;color:#f59e0b;font-size:0.85em;">
                        üí∞ ${
                          t.creationCost || "Koszt stworzenia"
                        }: ${creationCost.toLocaleString()} ${getCurrency()}
                    </div>
                </div>
            `;

          updateSelectedItemsPreview();
        }

        function cancelCustomInsurance() {
          document.getElementById("customInsurancePreview").innerHTML = "";
        }

        function removeCustomInsurance() {
          auctionCustomInsurance = null;
          document.getElementById("customInsurancePreview").innerHTML = "";
          updateSelectedItemsPreview();
        }

        async function createAuctionPackage() {
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();

          // Sprawd≈∫ czy zalogowany
          if (!playerName) {
            alert(t.loginFirst || "Najpierw siƒô zaloguj!");
            openModal("onlineAccount");
            return;
          }

          const hasItems =
            auctionSelectedCars.length > 0 ||
            auctionSelectedFood.length > 0 ||
            auctionCustomInsurance;
          if (!hasItems) {
            alert(t.selectSomething || "Wybierz co≈õ do wystawienia!");
            return;
          }

          const price = parseInt(
            document.getElementById("auctionPackagePrice").value
          );
          if (!price || price <= 0) {
            alert(t.enterPrice || "Podaj cenƒô!");
            return;
          }

          // Oblicz koszt stworzenia (tylko za ubezpieczenie)
          let creationCost = 0;
          if (auctionCustomInsurance && auctionCustomInsurance.creationCost) {
            creationCost = auctionCustomInsurance.creationCost;
          }

          // Sprawd≈∫ czy staƒá
          if (creationCost > money) {
            alert(
              `${t.notEnoughMoney || "Nie masz wystarczajƒÖco pieniƒôdzy!"}\n${
                t.creationCost || "Koszt stworzenia"
              }: ${creationCost.toLocaleString()} ${getCurrency()}`
            );
            return;
          }

          // Podsumowanie przed wystawieniem
          let summary = `üì¶ ${
            t.auctionSummary || "Podsumowanie"
          }\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;

          auctionSelectedCars.forEach((i) => {
            const car = garage[i];
            summary += `üöó ${car.brand} ${car.model}\n`;
          });

          auctionSelectedFood.forEach((i) => {
            const item = backpack[i];
            const itemName = item.nameKey ? getItemName(item) : item.name;
            const icon = item.icon || "üçî";
            summary += `${icon} ${itemName}\n`;
          });

          if (auctionCustomInsurance) {
            summary += `üõ°Ô∏è ${auctionCustomInsurance.name}\n`;
            if (creationCost > 0) {
              summary += `   üí∞ ${
                t.creationCost || "Koszt"
              }: -${creationCost.toLocaleString()} ${getCurrency()}\n`;
            }
          }

          summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          summary += `üíµ ${
            t.sellingPrice || "Cena sprzeda≈ºy"
          }: ${price.toLocaleString()} ${getCurrency()}\n`;
          if (creationCost > 0) {
            summary += `üí∏ ${
              t.youPay || "P≈Çacisz"
            }: -${creationCost.toLocaleString()} ${getCurrency()}\n`;
          }
          summary += `\n${t.confirmListing || "Wystawiƒá?"}`;

          if (!confirm(summary)) {
            return;
          }

          // Pobierz op≈Çatƒô za ubezpieczenie
          if (creationCost > 0) {
            money -= creationCost;
            spent += creationCost;
          }

          // Zbierz przedmioty
          const packageItems = [];
          let packageName = "";

          // Auta (sortuj malejƒÖco ≈ºeby usuwaƒá od ko≈Ñca)
          auctionSelectedCars
            .sort((a, b) => b - a)
            .forEach((i) => {
              const car = garage[i];
              packageItems.push({ type: "car", data: car });
              packageName +=
                (packageName ? " + " : "") + car.brand + " " + car.model;
            });

          // Jedzenie
          auctionSelectedFood
            .sort((a, b) => b - a)
            .forEach((i) => {
              const item = backpack[i];
              packageItems.push({ type: "food", data: item });
              const itemName = item.nameKey ? getItemName(item) : item.name;
              packageName += (packageName ? " + " : "") + itemName;
            });

          // Ubezpieczenie (bez creationCost w danych)
          if (auctionCustomInsurance) {
            const insData = { ...auctionCustomInsurance };
            delete insData.creationCost;
            packageItems.push({ type: "customInsurance", data: insData });
            packageName +=
              (packageName ? " + " : "") + auctionCustomInsurance.name;
          }

          // Utw√≥rz aukcjƒô
          const data = getOnlineData();
          if (!data.auctions) data.auctions = {};

          const auctionId =
            "auction_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 6);
          data.auctions[auctionId] = {
            seller: playerName,
            name: packageName,
            items: packageItems,
            price: price,
            createdAt: Date.now(),
            status: "active",
            bids: [],
            negotiations: [],
          };

          saveOnlineData(data);

          // Usu≈Ñ przedmioty z inwentarza
          auctionSelectedCars
            .sort((a, b) => b - a)
            .forEach((i) => {
              garage.splice(i, 1);
            });
          auctionSelectedFood
            .sort((a, b) => b - a)
            .forEach((i) => {
              backpack.splice(i, 1);
            });

          saveState();

          // Reset
          auctionSelectedCars = [];
          auctionSelectedFood = [];
          auctionCustomInsurance = null;

          let resultMsg = `‚úÖ ${
            t.auctionCreated || "Wystawiono!"
          }\n${packageName}`;
          if (creationCost > 0) {
            resultMsg += `\nüí∏ -${creationCost.toLocaleString()} ${getCurrency()}`;
          }
          alert(resultMsg);
          updateAllDisplays();
        }

        function getItemIcon(item) {
          if (!item) return "üì¶";
          if (item.type === "car") return "üöó";
          if (item.type === "food") return item.data?.icon || "üçî";
          if (item.type === "customInsurance") return "üõ°Ô∏è";
          if (item.icon) return item.icon;
          return "üì¶";
        }

        async function cancelAuction(auctionId) {
          const t = translations[currentLang] || translations.en;

          if (
            !confirm(
              t.confirmCancelAuction ||
                "Anulowaƒá aukcjƒô? Przedmioty wr√≥cƒÖ do Ciebie."
            )
          ) {
            return;
          }

          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId]) return;

          const auction = data.auctions[auctionId];

          // Sprawd≈∫ czy to Twoja aukcja
          if (auction.seller !== playerName) {
            alert(t.notYourAuction || "To nie Twoja aukcja!");
            return;
          }

          // Zwr√≥ƒá przedmioty
          const save = getCurrentSave();
          if (!save.data.backpack) save.data.backpack = [];

          if (auction.items) {
            auction.items.forEach((item) => {
              if (item.type === "car") {
                garage.push(item.data);
              } else if (item.type === "food") {
                save.data.backpack.push(item.data);
              }
              // Ubezpieczenie przepada (op≈Çata za stworzenie by≈Ça pobrana)
            });
          }

          // Usu≈Ñ aukcjƒô
          delete data.auctions[auctionId];
          saveOnlineData(data);

          saveState();
          updateAllDisplays();

          alert(`‚úÖ ${t.auctionCancelled || "Aukcja anulowana!"}`);
        }

        async function showAuctionDetail(auctionId) {
          const t = translations[currentLang] || translations.en;
          const data = getOnlineData();
          const auction = data.auctions[auctionId];
          if (!auction) return;

          // Generuj listƒô przedmiot√≥w w pakiecie
          let itemsHtml = "";
          if (auction.items && auction.items.length > 0) {
            itemsHtml = auction.items
              .map((item) => {
                if (item.type === "car") {
                  return `<div style="padding:8px;background:#222;border-radius:6px;margin-bottom:5px;">üöó ${item.data.brand} ${item.data.model}</div>`;
                } else if (item.type === "food") {
                  const itemName = item.data.nameKey
                    ? t[item.data.nameKey] || item.data.nameKey
                    : item.data.name;
                  const icon = item.data.icon || "üçî";
                  const kcal = item.data.kcal || item.data.food || 0;
                  const ml = item.data.ml || item.data.water || 0;
                  return `<div style="padding:8px;background:#222;border-radius:6px;margin-bottom:5px;">${icon} ${itemName} (+${kcal} üçî +${ml} üíß)</div>`;
                } else if (item.type === "customInsurance") {
                  const ins = item.data;
                  return `<div style="padding:8px;background:#222;border-radius:6px;margin-bottom:5px;">
                            üõ°Ô∏è ${ins.name}<br>
                            <span style="color:#888;font-size:0.85em;">
                                ${ins.hp > 0 ? `+${ins.hp} HP ` : ""}${
                    ins.food > 0 ? `+${ins.food} üçî ` : ""
                  }${ins.water > 0 ? `+${ins.water} üíß ` : ""}${
                    ins.coverage > 0
                      ? `${ins.coverage}% ${t.repairs || "napraw"}`
                      : ""
                  }<br>
                                ${ins.payment} ${getCurrency()} / ${
                    ins.interval
                  } min
                            </span>
                        </div>`;
                }
                return "";
              })
              .join("");
          } else if (auction.item) {
            // Stary format - pojedynczy przedmiot
            itemsHtml = `<div style="padding:8px;background:#222;border-radius:6px;">${getItemIcon(
              auction.item
            )} ${
              auction.item.name || auction.item.brand + " " + auction.item.model
            }</div>`;
          }

          const content = document.getElementById("auctionDetailContent");
          content.innerHTML = `
                <h3>üì¶ ${auction.name || "Pakiet"}</h3>
                <div style="background:#1a1a2e;padding:15px;border-radius:10px;margin:15px 0;">
                    <div style="font-weight:bold;margin-bottom:10px;">${
                      t.contents || "Zawarto≈õƒá"
                    }:</div>
                    ${itemsHtml}
                    <div style="display:flex;justify-content:space-between;margin-top:15px;padding-top:10px;border-top:1px solid #333;">
                        <span style="color:#888;">${
                          t.seller || "Sprzedawca"
                        }:</span>
                        <span>${auction.seller}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:8px;">
                        <span style="color:#888;">${t.price || "Cena"}:</span>
                        <span style="color:#10b981;font-weight:bold;font-size:1.2em;">${auction.price.toLocaleString()} ${getCurrency()}</span>
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <button onclick="buyAuctionItem('${auctionId}')" style="padding:15px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;">
                        üí∞ ${t.buyNow || "Kup teraz"}
                    </button>
                    <button onclick="showNegotiateModal('${auctionId}')" style="padding:15px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;">
                        ü§ù ${t.negotiate || "Negocjuj cenƒô"}
                    </button>
                </div>
            `;
          openModal("auctionDetail");
        }

        let pendingAuctionId = null;

        async function buyAuctionItem(auctionId) {
          const t = translations[currentLang] || translations.en;
          const data = getOnlineData();
          const auction = data.auctions[auctionId];

          if (auction.price > limit) {
            pendingAction = "buyAuction";
            pendingAuctionId = auctionId;
            closeModal("auctionDetail");
            openModal("pin");
            return;
          }

          await completePurchaseWithPin(auctionId);
        }

        async function completePurchaseWithPin(auctionId) {
          const t = translations[currentLang] || translations.en;
          const result = await acceptAuction(auctionId, pin);

          if (result.success) {
            money -= result.price;
            spent += result.price;

            const save = getCurrentSave();
            if (!save.data.backpack) save.data.backpack = [];
            if (!save.data.customInsurances) save.data.customInsurances = [];

            // Dodaj przedmioty z pakietu
            if (result.items && result.items.length > 0) {
              result.items.forEach((item) => {
                if (item.type === "car") {
                  garage.push(item.data);
                } else if (item.type === "food") {
                  save.data.backpack.push(item.data);
                } else if (item.type === "customInsurance") {
                  save.data.customInsurances.push(item.data);
                }
              });
            } else if (result.item) {
              // Stary format
              if (result.item.type === "car") {
                garage.push(result.item.item || result.item);
              } else if (result.item.type === "food") {
                save.data.backpack.push(result.item.item || result.item);
              }
            }

            saveState();
            updateAllDisplays();
            closeModal("auctionDetail");
            alert(`‚úÖ ${t.purchaseSuccess || "Zakup udany!"}`);
          } else if (result.error === "noMoney") {
            alert(t.notEnoughMoney || "Nie masz wystarczajƒÖco pieniƒôdzy!");
          }
          pendingAuctionId = null;
        }

        async function forgotPinAuction() {
          const t = translations[currentLang] || translations.en;
          closeModal("pin");

          if (pendingAuctionId) {
            const data = getOnlineData();
            const auction = data.auctions[pendingAuctionId];

            sendNotification(auction.seller, {
              type: "pinRequired",
              from: playerName,
              auctionId: pendingAuctionId,
              amount: auction.price,
              message: t.buyerForgotPin || "KupujƒÖcy nie pamiƒôta PIN",
            });

            alert(t.waitingForSeller || "Wys≈Çano pro≈õbƒô do sprzedawcy...");
          }
          pendingAction = null;
          pendingAuctionId = null;
        }

        async function showNegotiateModal(auctionId) {
          const t = translations[currentLang] || translations.en;
          const price = prompt(t.enterYourOffer || "Podaj swojƒÖ ofertƒô:");
          if (!price) return;

          const priceNum = parseInt(price);
          if (isNaN(priceNum) || priceNum <= 0) return;

          await negotiateAuction(auctionId, priceNum);
          closeModal("auctionDetail");
          alert(`‚úÖ ${t.offerSent || "Wys≈Çano ofertƒô!"}`);
        }

        async function allowWithoutPinUI(notifId, auctionId, buyerName) {
          await allowWithoutPin(notifId, auctionId, buyerName);
          renderNotifications();
        }

        async function denyWithoutPinUI(notifId, buyerName) {
          await denyWithoutPin(notifId, buyerName);
          renderNotifications();
        }

        async function respondNegotiation(notifId, auctionId, response) {
          const data = getOnlineData();
          const auction = data.auctions[auctionId];
          if (!auction) return;

          const negIndex = auction.negotiations.length - 1;
          await respondToNegotiation(auctionId, negIndex, response, null);
          removeNotification(notifId);
          renderNotifications();
        }

        async function showCounterOffer(notifId, auctionId, fromPlayer) {
          const t = translations[currentLang] || translations.en;
          const price = prompt(t.enterCounterOffer || "Podaj kontr-ofertƒô:");
          if (!price) return;

          const priceNum = parseInt(price);
          if (isNaN(priceNum) || priceNum <= 0) return;

          const data = getOnlineData();
          const auction = data.auctions[auctionId];
          const negIndex = auction.negotiations.length - 1;

          await respondToNegotiation(auctionId, negIndex, "counter", priceNum);
          removeNotification(notifId);
          renderNotifications();
        }

        // ==================== INIT ====================
        function init() {
          ensureDefaultSave();
          loadSaveData();
          generateLangGrid();
          applyLanguage();
          updateGameModeUI();
          updateAllDisplays();
          updateCurrentSaveDisplay();
          checkMissedTaxes();
          checkMissedHunger();
          checkInsuranceBenefits();
          startTaxTimer();
          startHungerTimer();
          startInsuranceTimer();
          checkUrlForVoucher();

          // Sprawd≈∫ czy zalogowany - je≈õli nie, poka≈º ekran logowania
          if (!checkRequireLogin()) {
            // Sprawd≈∫ zaproszenie do znajomych
            checkFriendInvite();
          }

          // Event listenery dla modali
          document
            .getElementById("modalOnlineAccount")
            ?.addEventListener("click", (e) => {
              if (e.target.id === "modalOnlineAccount")
                closeModal("onlineAccount");
            });
          document
            .getElementById("modalNotifications")
            ?.addEventListener("click", (e) => {
              if (e.target.id === "modalNotifications")
                closeModal("notifications");
            });
          document
            .getElementById("modalChat")
            ?.addEventListener("click", (e) => {
              if (e.target.id === "modalChat") closeChatModal();
            });
          document
            .getElementById("modalAuction")
            ?.addEventListener("click", (e) => {
              if (e.target.id === "modalAuction") closeModal("auction");
            });
        }

        function saveState() {
          saveSaveData();
          localStorage.setItem("beamng_lang", currentLang);
        }

        async function generateCardCode() {
          const data = getOnlineData();
          const existingCards = new Set();

          // Zbierz wszystkie istniejƒÖce numery kart
          if (data.players) {
            for (const player of Object.values(data.players)) {
              if (player.cardNumber) {
                existingCards.add(player.cardNumber);
              }
            }
          }

          // Generuj unikalny kod 6 cyfr
          let code;
          let attempts = 0;
          do {
            code = "";
            for (let i = 0; i < 6; i++) code += Math.floor(Math.random() * 10);
            attempts++;
          } while (existingCards.has(code) && attempts < 100);

          return code;
        }

        function generateCardCodeSync() {
          // Wersja synchroniczna dla kompatybilno≈õci - 6 cyfr
          let code = "";
          for (let i = 0; i < 6; i++) code += Math.floor(Math.random() * 10);
          return code;
        }

        // ==================== OBS≈ÅUGA FORMULARZY ====================
        let currentImageDataForVerify = null;
        let carSearchQuery = "";

        // Renderuj listƒô aut do kupienia
        function renderCarBuyList() {
          const grid = document.getElementById("carBuyGrid");
          const query = carSearchQuery.toLowerCase();
          const cars = getCurrentCars();

          const filtered = cars.filter(
            (car) =>
              car.brand.toLowerCase().includes(query) ||
              car.model.toLowerCase().includes(query) ||
              car.type.toLowerCase().includes(query)
          );

          if (filtered.length === 0) {
            grid.innerHTML =
              '<div style="text-align:center;padding:20px;color:#888;grid-column:span 2;">Nie znaleziono aut</div>';
            return;
          }

          grid.innerHTML = filtered
            .map(
              (car) => `
                <div class="shop-item" onclick="buyCar('${
                  car.id
                }')" style="padding:10px;">
                    <div class="item-icon">üöó</div>
                    <div class="item-name" style="font-size:0.8em;">${
                      car.brand
                    } ${car.model}</div>
                    <div class="item-stats">
                        <span style="color:#888;">${car.year}</span><br>
                        <span style="color:#aaa;font-size:0.9em;">${
                          car.type
                        }</span>
                    </div>
                    <div class="item-price">${car.price.toLocaleString()} ${getCurrency()}</div>
                </div>
            `
            )
            .join("");
        }

        function filterCars() {
          carSearchQuery = document.getElementById("carSearchInput").value;
          renderCarBuyList();
        }

        function buyCar(carId) {
          const cars = getCurrentCars();
          const car = cars.find((c) => c.id === carId);
          if (!car) return;

          const t = translations[currentLang] || translations.en;

          if (money < car.price) {
            alert(t.notEnoughMoney || "Nie masz wystarczajƒÖco pieniƒôdzy!");
            return;
          }

          if (
            confirm(
              `${t.buyQuestion || "Kupiƒá"} ${car.brand} ${car.model} ${
                t.forPrice || "za"
              } ${car.price.toLocaleString()} ${getCurrency()}?`
            )
          ) {
            // Dodaj do gara≈ºu
            garage.push({
              id: car.id,
              brand: car.brand,
              model: car.model,
              name: `${car.brand} ${car.model}`,
              price: car.price,
              type: car.type,
              year: car.year,
              upgradePercent: 50,
            });

            money -= car.price;
            spent += car.price;
            saveState();
            updateAllDisplays();
            playSound("buy");
            const t = translations[currentLang] || translations.en;
            alert(`üöô ${t.carBought || "Kupiono"} ${car.brand} ${car.model}!`);
            closeModal("buy");
          }
        }

        // SPRZEDA≈ª - gara≈º
        function renderGarage() {
          const list = document.getElementById("sellGarageList");
          const empty = document.getElementById("sellEmptyGarage");
          const section = document.getElementById("sellGarageSection");

          if (garage.length === 0) {
            section.style.display = "none";
            empty.style.display = "block";
            return;
          }

          empty.style.display = "none";
          section.style.display = "block";

          list.innerHTML = garage
            .map((car, i) => {
              const upgradePercent = car.upgradePercent || 50;
              const sellPrice = Math.floor(car.price * (upgradePercent / 100));
              return `
                <div class="garage-item" onclick="sellCar(${i})" ${
                car.broken ? 'style="opacity:0.5;pointer-events:none;"' : ""
              }>
                    <div>
                        <div class="car-name">üöó ${
                          car.name || car.brand + " " + car.model
                        }</div>
                        <div class="car-price">${car.year || ""}</div>
                    </div>
                    <div style="text-align:right;">
                        ${
                          car.broken
                            ? '<div style="color:#ef4444;">üîß Zepsute</div>'
                            : `
                            <div style="color:#4ade80;font-weight:bold;">+${sellPrice.toLocaleString()} ${getCurrency()}</div>
                            <div style="color:#888;font-size:0.8em;">${upgradePercent.toFixed(
                              1
                            )}%</div>
                        `
                        }
                    </div>
                </div>
            `;
            })
            .join("");
        }

        function sellCar(index) {
          if (index < 0 || index >= garage.length) return;

          const car = garage[index];
          const t = translations[currentLang] || translations.en;

          if (car.broken) {
            alert(t.cantSellBroken || "Nie mo≈ºna sprzedaƒá zepsutego auta!");
            return;
          }

          const upgradePercent = car.upgradePercent || 50;
          const sellPrice = Math.floor(car.price * (upgradePercent / 100));

          const carName = car.name || car.brand + " " + car.model;
          if (
            confirm(
              `${t.confirmSell || "Sprzedaƒá"} ${carName} ${
                t.forPrice || "za"
              } ${sellPrice.toLocaleString()} ${getCurrency()}?`
            )
          ) {
            money += sellPrice;
            garage.splice(index, 1);
            saveState();
            updateAllDisplays();
            renderGarage();
            playSound("sell");
            alert(
              `üí∏ Sprzedano za ${sellPrice.toLocaleString()} ${getCurrency()}!`
            );

            if (garage.length === 0) {
              closeModal("sell");
            }
          }
        }

        // Inicjalizacja input√≥w - zarobek km
        function initEarnInputs() {
          const kmInput = document.getElementById("kmInput");
          const btn = document.getElementById("earnBtn");

          if (kmInput) kmInput.value = "";
          if (btn) btn.classList.remove("active");

          const calcSpan = document.getElementById("kmCalc");
          if (calcSpan) calcSpan.textContent = "0";
        }

        // Event listener dla km
        document.addEventListener("input", function (e) {
          if (e.target.id === "kmInput") {
            const km = parseFloat(e.target.value) || 0;
            document.getElementById("kmCalc").textContent = (
              km * 100
            ).toLocaleString();
            currentEarnAmount = Math.floor(km * 100);
            document
              .getElementById("earnBtn")
              .classList.toggle("active", km > 0);
          }
        });

        function showSuccess(type, text, amount, amountClass) {
          const response = document.getElementById(type + "Response");
          const icon = type === "earn" ? "üõ£Ô∏è" : type === "buy" ? "üöô" : "üí∏";

          response.innerHTML = `
                <div class="result-icon">${icon}</div>
                <div class="result-text">${text}</div>
                <div class="result-amount ${amountClass}">${amount}</div>
            `;
          document.getElementById(type + "Btn").classList.add("active");
        }

        function showError(type) {
          const response = document.getElementById(type + "Response");
          response.innerHTML = `
                <div class="result-icon">‚ùå</div>
                <div class="result-text" style="color: #f87171;">${
                  translations[currentLang].invalidScreenshot ||
                  "Nie rozpoznano danych!"
                }</div>
            `;
          document.getElementById(type + "Btn").classList.remove("active");
        }

        // ==================== SYSTEM WERYFIKACJI QR ====================
        let peer = null;
        let currentVerifyType = null;
        let currentImageData = null;
        let verifyResolve = null;

        // Sprawd≈∫ czy to strona weryfikatora
        function checkIfVerifier() {
          const params = new URLSearchParams(window.location.search);
          const peerId = params.get("verify");
          const type = params.get("type");
          const img = params.get("img");

          if (peerId && type) {
            showVerifierPage(peerId, type, img);
            return true;
          }
          return false;
        }

        function showVerifierPage(peerId, type, imgData) {
          document.body.innerHTML = `
                <div class="verify-page">
                    <h2>üîç Weryfikacja transakcji</h2>
                    <p id="verifyQuestion">${getVerifyQuestion(type)}</p>
                    <img id="verifyImage" src="${imgData || ""}" style="${
            imgData ? "" : "display:none"
          }">
                    <div id="verifyStatus">
                        <div class="loader" style="width:40px;height:40px;border:3px solid #333;border-top-color:#ff6b35;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto;"></div>
                        <p>≈ÅƒÖczenie z graczem...</p>
                    </div>
                    <div class="verify-buttons" id="verifyButtons" style="display:none;">
                        <button class="verify-btn yes" onclick="sendVerifyResponse(true)">‚úÖ TAK</button>
                        <button class="verify-btn no" onclick="sendVerifyResponse(false)">‚ùå NIE</button>
                    </div>
                    <div id="verifyResult" style="display:none;"></div>
                </div>
            `;

          // Po≈ÇƒÖcz z graczem
          connectToPlayer(peerId);
        }

        function getVerifyQuestion(type) {
          const questions = {
            repair: "Czy na tym obrazku widaƒá uszkodzone auto?",
            sell: "Czy na tym obrazku widaƒá auto?",
            sellDamage: "Czy auto na obrazku jest ZNISZCZONE?",
          };
          return questions[type] || "Czy obrazek jest prawid≈Çowy?";
        }

        let verifierConn = null;

        function connectToPlayer(peerId) {
          const verifierPeer = new Peer();

          verifierPeer.on("open", () => {
            verifierConn = verifierPeer.connect(peerId);

            verifierConn.on("open", () => {
              document.getElementById("verifyStatus").innerHTML =
                '<p style="color:#4ade80;">‚úÖ Po≈ÇƒÖczono!</p>';
              document.getElementById("verifyButtons").style.display = "flex";
            });

            verifierConn.on("data", (data) => {
              if (data.type === "image") {
                document.getElementById("verifyImage").src = data.image;
                document.getElementById("verifyImage").style.display = "block";
              }
            });

            verifierConn.on("error", (err) => {
              document.getElementById("verifyStatus").innerHTML =
                '<p style="color:#ef4444;">‚ùå B≈ÇƒÖd po≈ÇƒÖczenia</p>';
            });
          });

          verifierPeer.on("error", (err) => {
            document.getElementById("verifyStatus").innerHTML =
              '<p style="color:#ef4444;">‚ùå Nie mo≈ºna po≈ÇƒÖczyƒá</p>';
          });
        }

        function sendVerifyResponse(approved) {
          if (verifierConn) {
            verifierConn.send({ type: "response", approved: approved });

            document.getElementById("verifyButtons").style.display = "none";
            document.getElementById("verifyResult").style.display = "block";
            document.getElementById("verifyResult").innerHTML = approved
              ? '<div class="verify-result">‚úÖ</div><p style="color:#4ade80;font-size:1.5em;">Transakcja potwierdzona!</p>'
              : '<div class="verify-result">‚ùå</div><p style="color:#ef4444;font-size:1.5em;">Transakcja odrzucona!</p>';
          }
        }

        // Funkcja do generowania QR i czekania na weryfikacjƒô
        function startVerification(type, imageData) {
          return new Promise((resolve) => {
            verifyResolve = resolve;
            currentVerifyType = type;
            currentImageData = imageData;

            // Stw√≥rz peer dla gracza
            if (peer) {
              peer.destroy();
            }

            peer = new Peer();

            peer.on("open", (id) => {
              // Generuj URL dla weryfikatora
              const baseUrl = window.location.href.split("?")[0];
              const verifyUrl = `${baseUrl}?verify=${id}&type=${type}`;

              // Poka≈º QR
              showQRCode(type, verifyUrl, imageData);
            });

            peer.on("connection", (conn) => {
              conn.on("open", () => {
                // Wy≈õlij obrazek do weryfikatora
                conn.send({ type: "image", image: imageData });
                updateQRStatus("connected");
              });

              conn.on("data", (data) => {
                if (data.type === "response") {
                  if (data.approved) {
                    updateQRStatus("approved");
                    resolve(true);
                  } else {
                    updateQRStatus("rejected");
                    resolve(false);
                  }
                }
              });
            });

            peer.on("error", (err) => {
              console.error("Peer error:", err);
              updateQRStatus("error");
              resolve(false);
            });
          });
        }

        function showQRCode(type, url, imageData) {
          const response = document.getElementById(type + "Response");

          response.innerHTML = `
                <div class="qr-section">
                    <h4>üì± Popro≈õ kogo≈õ o weryfikacjƒô</h4>
                    <p>Niech zeskanuje kod QR telefonem</p>
                    <div class="qr-container" id="qr-${type}"></div>
                    <div class="qr-status waiting" id="qrStatus-${type}">
                        ‚è≥ Oczekiwanie na weryfikatora...
                    </div>
                </div>
            `;

          // Generuj QR kod
          new QRCode(document.getElementById(`qr-${type}`), {
            text: url,
            width: 180,
            height: 180,
            colorDark: "#1a1a2e",
            colorLight: "#ffffff",
          });
        }

        function updateQRStatus(status) {
          const statusEl = document.querySelector('[id^="qrStatus-"]');
          if (!statusEl) return;

          const type = currentVerifyType;
          const btn = document.getElementById(type + "Btn");

          switch (status) {
            case "connected":
              statusEl.className = "qr-status waiting";
              statusEl.innerHTML =
                "üîó Weryfikator po≈ÇƒÖczony, czekam na odpowied≈∫...";
              break;
            case "approved":
              statusEl.className = "qr-status success";
              statusEl.innerHTML = "‚úÖ Transakcja potwierdzona!";
              if (btn) btn.classList.add("active");

              // Poka≈º te≈º koszt/cenƒô
              setTimeout(() => {
                showVerifiedResult(type);
              }, 1000);
              break;
            case "rejected":
              statusEl.className = "qr-status rejected";
              statusEl.innerHTML = "‚ùå Transakcja odrzucona!";
              if (btn) btn.classList.remove("active");
              break;
            case "error":
              statusEl.className = "qr-status rejected";
              statusEl.innerHTML = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia";
              break;
          }
        }

        function showVerifiedResult(type) {
          const response = document.getElementById(type + "Response");

          if (type === "repair") {
            response.innerHTML = `
                    <div class="result-icon">üîß‚úÖ</div>
                    <div class="result-text">${
                      translations[currentLang].repairCostInfo ||
                      "Koszt naprawy:"
                    }</div>
                    <div class="result-amount cost">-5,000 ${getCurrency()}</div>
                    <div style="color:#4ade80;margin-top:10px;font-size:0.9em;">Zweryfikowano!</div>
                `;
          } else if (type === "buy") {
            response.innerHTML = `
                    <div class="result-icon">üöô‚úÖ</div>
                    <div class="result-text">${
                      translations[currentLang].foundPrice || "Cena auta:"
                    } ${currentBuyPrice.toLocaleString()} ${getCurrency()}</div>
                    <div class="result-amount cost">-${currentBuyPrice.toLocaleString()} ${getCurrency()}</div>
                    <div style="color:#4ade80;margin-top:10px;font-size:0.9em;">Zweryfikowano!</div>
                `;
          } else if (type === "sell") {
            response.innerHTML = `
                    <div class="result-icon">üí∏‚úÖ</div>
                    <div class="result-text">${
                      translations[currentLang].foundPrice || "Cena auta:"
                    } (50%)</div>
                    <div class="result-amount earn">+${currentSellPrice.toLocaleString()} ${getCurrency()}</div>
                    <div style="color:#4ade80;margin-top:10px;font-size:0.9em;">Zweryfikowano!</div>
                `;
          }
        }

        // Zmodyfikowana funkcja naprawy z QR
        async function analyzeRepairImage(input) {
          if (!input.files || !input.files[0]) return;

          const file = input.files[0];
          const preview = document.getElementById("repairPreview");
          const response = document.getElementById("repairResponse");
          const btn = document.getElementById("repairBtn");

          const reader = new FileReader();
          reader.onload = async function (e) {
            const imageData = e.target.result;
            preview.src = imageData;
            preview.style.display = "block";
            document.getElementById("repairUpload").style.display = "none";

            response.classList.add("active");

            // Uruchom weryfikacjƒô QR
            const approved = await startVerification("repair", imageData);

            if (!approved) {
              btn.classList.remove("active");
            }
          };
          reader.readAsDataURL(file);
        }

        function confirmCarVisible(type) {
          const response = document.getElementById(type + "Response");
          const btn = document.getElementById(type + "Btn");

          if (type === "repair") {
            response.innerHTML = `
                    <div class="result-icon">üîß</div>
                    <div class="result-text">${
                      translations[currentLang].repairCostInfo ||
                      "Koszt naprawy:"
                    }</div>
                    <div class="result-amount cost">-5,000 ${getCurrency()}</div>
                `;
            btn.classList.add("active");
          }
        }

        function denyCarVisible(type) {
          const response = document.getElementById(type + "Response");
          response.innerHTML = `
                <div class="result-icon">‚ùå</div>
                <div class="result-text" style="color: #f87171;">${
                  translations[currentLang].noCarOnScreen ||
                  "Wy≈õlij screenshot z widocznym autem!"
                }</div>
            `;
          // Reset uploadu
          setTimeout(() => {
            resetUploadForm(type);
          }, 2000);
        }

        // ==================== AKCJE ====================
        function confirmEarn() {
          money += currentEarnAmount;
          saveState();
          updateAllDisplays();
          alert(`üí∞ +${currentEarnAmount.toLocaleString()} ${getCurrency()}!`);
          closeModal("earn");
        }

        // ==================== PODATKI ====================
        function checkMissedTaxes() {
          const now = Date.now();
          const elapsed = now - lastTaxTime;
          const missedTaxes = Math.floor(elapsed / (5 * 60 * 1000)); // Co 5 minut

          if (missedTaxes > 0) {
            const totalTax = missedTaxes * 500; // 500 z≈Ç za ka≈ºde 5 min

            if (autoPay) {
              if (money >= totalTax) {
                money -= totalTax;
                totalTaxPaid += totalTax;
              } else {
                const paid = money;
                money = 0;
                totalTaxPaid += paid;
                addDebt(totalTax - paid);
              }
            } else {
              addDebt(totalTax);
            }

            lastTaxTime = now;
            saveState();
          }
        }

        function startTaxTimer() {
          setInterval(updateNextTaxDisplay, 1000);
          setInterval(collectTax, 5 * 60 * 1000); // Co 5 minut
        }

        function collectTax() {
          if (autoPay) {
            if (money >= 500) {
              money -= 500;
              totalTaxPaid += 500;
            } else {
              totalTaxPaid += money;
              addDebt(500 - money);
              money = 0;
            }
          } else {
            addDebt(500);
          }

          lastTaxTime = Date.now();
          saveState();
          updateAllDisplays();
        }

        function addDebt(amount) {
          debt += amount;
          if (!debtDeadline) {
            const deadline = new Date();
            deadline.setDate(deadline.getDate() + 7);
            debtDeadline = deadline.toISOString();
          }
          saveState();
        }

        function updateNextTaxDisplay() {
          const elapsed = Date.now() - lastTaxTime;
          const remaining = 5 * 60 * 1000 - elapsed; // 5 minut

          if (remaining > 0) {
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            document.getElementById("nextTaxTime").textContent = `${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          }
        }

        function toggleAutoPay() {
          autoPay = !autoPay;
          document
            .getElementById("autoPayToggle")
            .classList.toggle("active", autoPay);
          saveState();
        }

        function payDebt() {
          if (money >= debt) {
            money -= debt;
            debt = 0;
            debtDeadline = null;
            saveState();
            updateAllDisplays();
            alert("‚úÖ D≈Çug sp≈Çacony!");
          } else {
            alert(
              translations[currentLang].notEnoughMoney ||
                "Nie masz wystarczajƒÖco pieniƒôdzy!"
            );
          }
        }

        // ==================== G≈Å√ìD I PRAGNIENIE ====================
        function checkMissedHunger() {
          const now = Date.now();
          const elapsed = now - lastHungerTime;
          const missedIntervals = Math.floor(elapsed / HUNGER_INTERVAL);

          if (missedIntervals > 0) {
            // Zmniejsz jedzenie i picie
            food = Math.max(0, food - FOOD_DECAY * missedIntervals);
            water = Math.max(0, water - WATER_DECAY * missedIntervals);

            // Je≈õli g≈Çodny/spragniony - traƒá zdrowie
            if (food <= 0 || water <= 0) {
              const healthLoss = missedIntervals * 5;
              health = Math.max(0, health - healthLoss);
            }

            lastHungerTime = now;
            saveState();
          }
        }

        function startHungerTimer() {
          // Sprawdzaj co sekundƒô dla aktualizacji wy≈õwietlania
          setInterval(updateHungerDisplay, 1000);
          // Zu≈ºywaj g≈Ç√≥d/pragnienie co 5 minut
          setInterval(consumeHunger, HUNGER_INTERVAL);
        }

        function consumeHunger() {
          food = Math.max(0, food - FOOD_DECAY);
          water = Math.max(0, water - WATER_DECAY);

          // Je≈õli g≈Çodny/spragniony - traƒá zdrowie
          if (food <= 0 || water <= 0) {
            health = Math.max(0, health - 5);
          }

          lastHungerTime = Date.now();
          saveState();
          updateAllDisplays();

          // Sprawd≈∫ ≈õmierƒá
          checkDeath();

          // Ostrze≈ºenie gdy niski poziom - ciche
        }

        function checkDeath() {
          if (health <= 0) {
            playerDied();
          }
        }

        function playerDied() {
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();

          // Zatrzymaj wszystkie ulepszania
          Object.keys(upgradeIntervals).forEach((idx) => {
            clearInterval(upgradeIntervals[idx]);
          });
          upgradeIntervals = {};

          // Sprawd≈∫ czy jest checkpoint
          const modeKey =
            gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";
          const checkpoint = save[modeKey];

          if (checkpoint) {
            // Przywr√≥ƒá z checkpointu
            alert(
              `üíÄ ${t.youDied || "ZginƒÖ≈Çe≈õ!"}\n\n${
                t.loadingCheckpoint || "Wczytywanie ostatniego checkpointu..."
              }`
            );
            loadCheckpoint();
          } else {
            // Brak checkpointu - reset do poczƒÖtku
            alert(
              `üíÄ ${t.youDied || "ZginƒÖ≈Çe≈õ!"}\n\n${
                t.noCheckpoint || "Brak checkpointu - zaczynasz od nowa!"
              }`
            );
            resetModeProgress();
          }

          updateAllDisplays();
          renderGarageModal();
        }

        function createCheckpoint() {
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();
          if (!save) return;

          const modeKey =
            gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";

          // Zapisz aktualny stan jako checkpoint
          save[modeKey] = {
            money: money,
            garage: JSON.parse(JSON.stringify(garage)),
            spent: spent,
            debt: debt,
            debtDeadline: debtDeadline,
            totalTaxPaid: totalTaxPaid,
            health: health,
            food: food,
            water: water,
            backpack: JSON.parse(JSON.stringify(backpack)),
            activeInsurances: JSON.parse(JSON.stringify(activeInsurances)),
            createdAt: Date.now(),
          };

          localStorage.setItem("beamng_saves", JSON.stringify(saves));

          alert(
            `‚úÖ ${t.checkpointCreated || "Checkpoint utworzony!"}\n\n${
              t.checkpointInfo || "Je≈õli zginiesz, wr√≥cisz do tego momentu."
            }`
          );
          renderSavesList();
        }

        function loadCheckpoint() {
          const save = getCurrentSave();
          if (!save) return;

          const modeKey =
            gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";
          const checkpoint = save[modeKey];

          if (!checkpoint) return;

          money = checkpoint.money;
          garage = JSON.parse(JSON.stringify(checkpoint.garage));
          spent = checkpoint.spent;
          debt = checkpoint.debt;
          debtDeadline = checkpoint.debtDeadline;
          totalTaxPaid = checkpoint.totalTaxPaid;
          health = checkpoint.health;
          food = checkpoint.food;
          water = checkpoint.water;
          backpack = JSON.parse(JSON.stringify(checkpoint.backpack));
          activeInsurances = JSON.parse(
            JSON.stringify(checkpoint.activeInsurances)
          );

          // Wzn√≥w ulepszania
          resumeUpgrades();
          saveState();
        }

        function resetModeProgress() {
          money = 1500;
          garage = [];
          spent = 0;
          debt = 0;
          debtDeadline = null;
          totalTaxPaid = 0;
          health = 100;
          food = 1000;
          water = 1000;
          backpack = [];
          activeInsurances = [];

          saveState();
        }

        function deleteCheckpoint() {
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();
          if (!save) return;

          const modeKey =
            gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";

          if (!save[modeKey]) {
            alert(
              t.noCheckpointToDelete || "Nie masz checkpointu do usuniƒôcia!"
            );
            return;
          }

          if (
            confirm(
              t.confirmDeleteCheckpoint ||
                "UsunƒÖƒá checkpoint? Je≈õli zginiesz, stracisz ca≈Çy postƒôp!"
            )
          ) {
            delete save[modeKey];
            localStorage.setItem("beamng_saves", JSON.stringify(saves));
            alert(t.checkpointDeleted || "Checkpoint usuniƒôty!");
            renderSavesList();
          }
        }

        function updateHungerDisplay() {
          // Mo≈ºna tu dodaƒá timer do nastƒôpnego zu≈ºycia
        }

        // ==================== UBEZPIECZENIA ====================
        let selectedInsurancePackage = null;

        function renderInsuranceList() {
          const list = document.getElementById("insuranceList");
          const activeSection = document.getElementById(
            "activeInsurancesSection"
          );
          const activeList = document.getElementById("activeInsurancesList");
          const activeCount = document.getElementById("activeCount");

          const t = translations[currentLang] || translations.en;

          // Poka≈º aktywne ubezpieczenia
          if (activeInsurances.length > 0) {
            activeSection.style.display = "block";
            activeCount.textContent = activeInsurances.length;

            activeList.innerHTML = activeInsurances
              .map((ins, idx) => {
                const pkg = insurancePackages.find(
                  (p) => p.id === ins.packageId
                );
                if (!pkg) return "";

                const periodText =
                  ins.period === "hour"
                    ? t.perHour || "/godz"
                    : ins.period === "day"
                    ? t.perDay || "/dzie≈Ñ"
                    : t.perWeek || "/tydzie≈Ñ";

                const remaining = ins.nextPaymentAt - Date.now();
                const hoursLeft = Math.max(
                  0,
                  Math.floor(remaining / (60 * 60 * 1000))
                );
                const minsLeft = Math.max(
                  0,
                  Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000))
                );

                return `
                        <div style="background:rgba(74,222,128,0.1);border:1px solid #4ade80;border-radius:8px;padding:8px;margin-bottom:5px;display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:bold;font-size:0.9em;">${
                                  pkg.icon
                                } ${getInsuranceName(pkg)}</div>
                                <div style="font-size:0.75em;color:#888;">${ins.price.toLocaleString()} ${getCurrency()} ${periodText}</div>
                                <div style="font-size:0.7em;color:#aaa;">‚è±Ô∏è ${hoursLeft}h ${minsLeft}m | ${
                  ins.autoPay ? "‚úÖ" : "‚ùå"
                } Auto</div>
                            </div>
                            <button onclick="showInsuranceDetails(${idx})" style="padding:5px 10px;background:#ff6b35;color:white;border:none;border-radius:5px;font-size:0.8em;cursor:pointer;">üìã</button>
                        </div>
                    `;
              })
              .join("");
          } else {
            activeSection.style.display = "none";
          }

          // Lista pakiet√≥w do kupienia
          list.innerHTML = insurancePackages
            .map((pkg) => {
              const isOwned = activeInsurances.some(
                (i) => i.packageId === pkg.id
              );

              return `
                <div class="garage-item" onclick="${
                  isOwned ? "" : `showInsurancePeriods('${pkg.id}')`
                }" style="${
                isOwned
                  ? "opacity:0.5;cursor:default;border-color:#4ade80;"
                  : ""
              }">
                    <div>
                        <div class="car-name">${pkg.icon} ${getInsuranceName(
                pkg
              )}</div>
                        <div style="font-size:0.75em;color:#aaa;">${getInsuranceDesc(
                          pkg
                        )} ${t.every || "co"} ${pkg.interval} min</div>
                    </div>
                    <div style="text-align:right;font-size:0.75em;">
                        <div style="color:#ff6b35;">${
                          pkg.prices.hour
                        } ${getCurrency()}<span style="color:#666;">${
                t.perHourShort || "/h"
              }</span></div>
                        <div style="color:#ff6b35;">${
                          pkg.prices.day
                        } ${getCurrency()}<span style="color:#666;">${
                t.perDayShort || "/d"
              }</span></div>
                        <div style="color:#ff6b35;">${
                          pkg.prices.week
                        } ${getCurrency()}<span style="color:#666;">${
                t.perWeekShort || "/tyg"
              }</span></div>
                        ${
                          isOwned
                            ? '<div style="color:#4ade80;margin-top:2px;">‚úÖ</div>'
                            : ""
                        }
                    </div>
                </div>
            `;
            })
            .join("");
        }

        function showInsurancePeriods(packageId) {
          selectedInsurancePackage = insurancePackages.find(
            (p) => p.id === packageId
          );
          if (!selectedInsurancePackage) return;

          const pkg = selectedInsurancePackage;
          const t = translations[currentLang] || translations.en;

          document.getElementById("insurancePeriodDetails").innerHTML = `
                <div style="font-size:2em;">${pkg.icon}</div>
                <div style="font-weight:bold;font-size:1.2em;">${getInsuranceName(
                  pkg
                )}</div>
                <div style="color:#aaa;font-size:0.9em;">${getInsuranceDesc(
                  pkg
                )} ${t.every || "co"} ${pkg.interval} min</div>
            `;

          document.getElementById("periodOptions").innerHTML = `
                <button onclick="buyInsurance('hour')" style="padding:15px;background:linear-gradient(145deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span>‚è∞ ${t.hour || "Godzina"}</span>
                    <span style="font-weight:bold;">${pkg.prices.hour.toLocaleString()} ${getCurrency()}</span>
                </button>
                <button onclick="buyInsurance('day')" style="padding:15px;background:linear-gradient(145deg,#3b82f6,#2563eb);color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span>üìÖ ${t.day || "Dzie≈Ñ"}</span>
                    <span style="font-weight:bold;">${pkg.prices.day.toLocaleString()} ${getCurrency()}</span>
                </button>
                <button onclick="buyInsurance('week')" style="padding:15px;background:linear-gradient(145deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span>üìÜ ${t.week || "Tydzie≈Ñ"}</span>
                    <span style="font-weight:bold;">${pkg.prices.week.toLocaleString()} ${getCurrency()}</span>
                </button>
            `;

          openModal("insurancePeriod");
        }

        function buyInsurance(period) {
          if (!selectedInsurancePackage) return;

          const pkg = selectedInsurancePackage;
          let price, duration;

          if (period === "hour") {
            price = pkg.prices.hour;
            duration = 60 * 60 * 1000; // 1 godzina
          } else if (period === "day") {
            price = pkg.prices.day;
            duration = 24 * 60 * 60 * 1000; // 1 dzie≈Ñ
          } else {
            price = pkg.prices.week;
            duration = 7 * 24 * 60 * 60 * 1000; // 1 tydzie≈Ñ
          }

          if (money < price) {
            alert(
              translations[currentLang].notEnoughMoney ||
                "Nie masz wystarczajƒÖco pieniƒôdzy!"
            );
            return;
          }

          // Sprawd≈∫ czy ju≈º ma to ubezpieczenie
          if (activeInsurances.some((i) => i.packageId === pkg.id)) {
            alert(
              translations[currentLang].alreadyHaveInsurance ||
                "Ju≈º masz to ubezpieczenie!"
            );
            return;
          }

          money -= price;
          activeInsurances.push({
            packageId: pkg.id,
            period: period,
            price: price,
            totalPaid: price,
            benefitCount: 0,
            autoPay: true,
            startedAt: Date.now(),
            lastBenefitAt: Date.now(),
            nextPaymentAt: Date.now() + duration,
          });

          playSound("insurance");
          saveState();
          updateAllDisplays();
          closeModal("insurancePeriod");
          renderInsuranceList();

          const t = translations[currentLang] || translations.en;
          alert(
            `üè• ${getInsuranceName(pkg)} - ${t.activated || "Aktywowane"}!`
          );
        }

        function showInsuranceDetails(index) {
          if (index < 0 || index >= activeInsurances.length) return;

          const ins = activeInsurances[index];
          const pkg = insurancePackages.find((p) => p.id === ins.packageId);
          if (!pkg) return;

          const t = translations[currentLang] || translations.en;
          const periodText =
            ins.period === "hour"
              ? t.perHour || "/godz"
              : ins.period === "day"
              ? t.perDay || "/dzie≈Ñ"
              : t.perWeek || "/tydzie≈Ñ";

          const remaining = ins.nextPaymentAt - Date.now();
          const daysLeft = Math.floor(remaining / (24 * 60 * 60 * 1000));
          const hoursLeft = Math.floor(
            (remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000)
          );
          const minsLeft = Math.floor(
            (remaining % (60 * 60 * 1000)) / (60 * 1000)
          );

          // Oblicz zwrot (10% je≈õli u≈ºyto 3+ razy)
          const refund =
            ins.benefitCount >= 3 ? Math.floor(ins.totalPaid * 0.1) : 0;

          document.getElementById("insuranceDetailsContent").innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:3em;">${pkg.icon}</div>
                    <div style="font-weight:bold;font-size:1.3em;">${getInsuranceName(
                      pkg
                    )}</div>
                    <div style="color:#aaa;">${getInsuranceDesc(pkg)} ${
            t.every || "co"
          } ${pkg.interval} min</div>
                </div>
                
                <div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:15px;margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${t.price || "Cena"}:</span>
                        <span style="color:#ff6b35;font-weight:bold;">${ins.price.toLocaleString()} ${getCurrency()} ${periodText}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${t.totalPaid || "Zap≈Çacono ≈ÇƒÖcznie"}:</span>
                        <span>${ins.totalPaid.toLocaleString()} ${getCurrency()}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${
                          t.benefitsReceived || "Otrzymane korzy≈õci"
                        }:</span>
                        <span>${ins.benefitCount}x</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span>${t.nextPayment || "Nastƒôpna p≈Çatno≈õƒá"}:</span>
                        <span>${
                          daysLeft > 0 ? daysLeft + "d " : ""
                        }${hoursLeft}h ${minsLeft}m</span>
                    </div>
                </div>
                
                <div class="tax-toggle" style="margin-bottom:15px;">
                    <div>
                        <strong>${t.autoPay || "Automatyczne p≈Çacenie"}</strong>
                    </div>
                    <div class="toggle-switch ${
                      ins.autoPay ? "active" : ""
                    }" onclick="toggleInsuranceAutoPay(${index})"></div>
                </div>
                
                <button onclick="cancelInsurance(${index})" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;">
                    ‚ùå ${t.cancelInsurance || "Zrezygnuj"} ${
            refund > 0
              ? `(${
                  t.refund || "zwrot"
                }: ${refund.toLocaleString()} ${getCurrency()})`
              : `(${t.noRefund || "brak zwrotu"})`
          }
                </button>
            `;

          openModal("insuranceDetails");
        }

        function toggleInsuranceAutoPay(index) {
          if (index < 0 || index >= activeInsurances.length) return;
          activeInsurances[index].autoPay = !activeInsurances[index].autoPay;
          saveState();
          showInsuranceDetails(index);
          updateCardDisplay();
        }

        function cancelInsurance(index) {
          if (index < 0 || index >= activeInsurances.length) return;

          const ins = activeInsurances[index];
          const pkg = insurancePackages.find((p) => p.id === ins.packageId);
          const t = translations[currentLang] || translations.en;

          // Oblicz zwrot
          const refund =
            ins.benefitCount >= 3 ? Math.floor(ins.totalPaid * 0.1) : 0;

          const confirmMsg =
            refund > 0
              ? `${
                  t.confirmCancelWithRefund || "Zrezygnowaƒá? Zwrot"
                }: ${refund.toLocaleString()} ${getCurrency()}`
              : t.confirmCancelNoRefund ||
                "Zrezygnowaƒá? Brak zwrotu (u≈ºyto mniej ni≈º 3 razy)";

          if (confirm(confirmMsg)) {
            if (refund > 0) {
              money += refund;
            }
            activeInsurances.splice(index, 1);
            saveState();
            updateAllDisplays();
            closeModal("insuranceDetails");
            renderInsuranceList();
          }
        }

        function checkInsuranceBenefits() {
          const now = Date.now();
          let needsSave = false;

          for (let i = activeInsurances.length - 1; i >= 0; i--) {
            const ins = activeInsurances[i];
            const pkg = insurancePackages.find((p) => p.id === ins.packageId);
            if (!pkg) continue;

            // Sprawd≈∫ czy czas na p≈Çatno≈õƒá
            if (now >= ins.nextPaymentAt) {
              let duration;
              if (ins.period === "hour") duration = 60 * 60 * 1000;
              else if (ins.period === "day") duration = 24 * 60 * 60 * 1000;
              else duration = 7 * 24 * 60 * 60 * 1000;

              if (ins.autoPay) {
                // Auto-pay: p≈Çaƒá lub id≈∫ na d≈Çug, ale ZAWSZE kontynuuj ubezpieczenie
                if (money >= ins.price) {
                  money -= ins.price;
                  ins.totalPaid += ins.price;
                } else {
                  // Nie ma kasy - p≈Çaƒá ile mo≈ºesz, reszta na d≈Çug
                  const paid = money;
                  money = 0;
                  ins.totalPaid += paid;
                  addDebt(ins.price - paid);
                }
                ins.nextPaymentAt = now + duration;
                needsSave = true;
              } else {
                // Nie auto-pay = d≈Çug i usu≈Ñ ubezpieczenie
                addDebt(ins.price);
                activeInsurances.splice(i, 1);
                needsSave = true;
                continue;
              }
            }

            // Przyznaj korzy≈õci
            const intervalMs = pkg.interval * 60 * 1000;
            if (now - ins.lastBenefitAt >= intervalMs) {
              if (pkg.benefits.hp > 0)
                health = Math.min(MAX_HEALTH, health + pkg.benefits.hp);
              if (pkg.benefits.kcal > 0)
                food = Math.min(MAX_FOOD, food + pkg.benefits.kcal);
              if (pkg.benefits.ml > 0)
                water = Math.min(MAX_WATER, water + pkg.benefits.ml);

              ins.lastBenefitAt = now;
              ins.benefitCount++;
              needsSave = true;
            }
          }

          if (needsSave) {
            saveState();
            updateAllDisplays();
          }
        }

        function startInsuranceTimer() {
          setInterval(checkInsuranceBenefits, 60 * 1000);
        }

        // ==================== WY≈öWIETLANIE ====================
        function updateAllDisplays() {
          updateMoneyDisplay();
          updateCardDisplay();
          updateDebtDisplay();
          updateTaxDisplay();
          updateStatusBars();
        }

        function updateStatusBars() {
          // Zdrowie
          const healthPercent = (health / MAX_HEALTH) * 100;
          document.getElementById("healthBar").style.width =
            healthPercent + "%";
          document.getElementById(
            "healthValue"
          ).textContent = `${health}/${MAX_HEALTH}`;

          // Jedzenie
          const foodPercent = (food / MAX_FOOD) * 100;
          document.getElementById("foodBar").style.width = foodPercent + "%";
          document.getElementById(
            "foodValue"
          ).textContent = `${food}/${MAX_FOOD} kcal`;

          // Picie
          const waterPercent = (water / MAX_WATER) * 100;
          document.getElementById("waterBar").style.width = waterPercent + "%";
          document.getElementById(
            "waterValue"
          ).textContent = `${water}/${MAX_WATER} ml`;
        }

        function updateInventoryDisplay() {
          document.getElementById(
            "invHealth"
          ).textContent = `${health}/${MAX_HEALTH} HP`;
          document.getElementById(
            "invFood"
          ).textContent = `${food}/${MAX_FOOD} kcal`;
          document.getElementById(
            "invWater"
          ).textContent = `${water}/${MAX_WATER} ml`;
        }

        function showShopTab(tab) {
          currentShopTab = tab;
          document
            .querySelectorAll("#modalShop .inv-tab")
            .forEach((t) => t.classList.remove("active"));
          event.target.classList.add("active");
          renderShopItems();
        }

        // SKLEP - kupowanie do plecaka
        function renderShopItems() {
          const grid = document.getElementById("shopGrid");
          const items = currentShopTab === "food" ? foodItems : drinkItems;

          grid.innerHTML = items
            .map(
              (item) => `
                <div class="shop-item" onclick="buyToBackpack('${
                  item.id
                }', '${currentShopTab}')">
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${getItemName(item)}</div>
                    <div class="item-stats">
                        ${
                          item.kcal > 0
                            ? `<span class="positive">+${item.kcal} kcal</span><br>`
                            : ""
                        }
                        ${
                          item.ml > 0
                            ? `<span class="positive">+${item.ml} ml</span><br>`
                            : ""
                        }
                        ${
                          item.hp > 0
                            ? `<span class="positive">+${item.hp} HP</span>`
                            : ""
                        }
                        ${
                          item.hp < 0
                            ? `<span class="negative">${item.hp} HP</span>`
                            : ""
                        }
                    </div>
                    <div class="item-price">${item.price} z≈Ç</div>
                </div>
            `
            )
            .join("");
        }

        function buyToBackpack(itemId, type) {
          const items = type === "food" ? foodItems : drinkItems;
          const item = items.find((i) => i.id === itemId);
          if (!item) return;

          if (money < item.price) {
            alert(
              translations[currentLang].notEnoughMoney ||
                "Nie masz wystarczajƒÖco pieniƒôdzy!"
            );
            return;
          }

          // Kup i dodaj do plecaka
          money -= item.price;
          backpack.push({ ...item, type: type });

          playSound("buy");
          saveState();
          updateAllDisplays();

          alert(`${item.icon} ${getItemName(item)} ‚Üí üéí`);
        }

        // EKWIPUNEK - zawarto≈õƒá plecaka
        function renderBackpack() {
          const grid = document.getElementById("backpackGrid");
          const empty = document.getElementById("emptyBackpack");

          if (backpack.length === 0) {
            grid.style.display = "none";
            empty.style.display = "block";
            return;
          }

          grid.style.display = "grid";
          empty.style.display = "none";

          // Grupuj przedmioty
          const grouped = {};
          backpack.forEach((item, index) => {
            if (!grouped[item.id]) {
              grouped[item.id] = { ...item, count: 0, indices: [] };
            }
            grouped[item.id].count++;
            grouped[item.id].indices.push(index);
          });

          grid.innerHTML = Object.values(grouped)
            .map((item) => {
              // Sprawd≈∫ czy mo≈ºna u≈ºyƒá
              const foodPercent = (food / MAX_FOOD) * 100;
              const waterPercent = (water / MAX_WATER) * 100;
              const canUse =
                (item.kcal > 0 && foodPercent < 98) ||
                (item.ml > 0 && waterPercent < 98) ||
                (item.kcal === 0 && item.ml === 0);
              const blocked = !canUse;

              return `
                <div class="shop-item ${blocked ? "blocked" : ""}" onclick="${
                blocked ? "" : `useItem('${item.id}')`
              }" style="${blocked ? "opacity:0.5;cursor:not-allowed;" : ""}">
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${getItemName(item)} ${
                item.count > 1
                  ? `<span style="color:#ff6b35;">x${item.count}</span>`
                  : ""
              }</div>
                    <div class="item-stats">
                        ${
                          item.kcal > 0
                            ? `<span class="positive">+${item.kcal} kcal</span><br>`
                            : ""
                        }
                        ${
                          item.ml > 0
                            ? `<span class="positive">+${item.ml} ml</span><br>`
                            : ""
                        }
                        ${
                          item.hp > 0
                            ? `<span class="positive">+${item.hp} HP</span>`
                            : ""
                        }
                        ${
                          item.hp < 0
                            ? `<span class="negative">${item.hp} HP</span>`
                            : ""
                        }
                    </div>
                    ${
                      blocked
                        ? `<div style="color:#f87171;font-size:0.8em;margin-top:5px;">‚õî ${
                            translations[currentLang].tooFull || "Jeste≈õ pe≈Çny!"
                          }</div>`
                        : `<div style="color:#4ade80;font-size:0.85em;margin-top:5px;">‚ñ∂ ${
                            translations[currentLang].useItem || "U≈ºyj"
                          }</div>`
                    }
                </div>
            `;
            })
            .join("");
        }

        function useItem(itemId) {
          const index = backpack.findIndex((i) => i.id === itemId);
          if (index === -1) return;

          const item = backpack[index];

          // Sprawd≈∫ czy mo≈ºna u≈ºyƒá (pasek < 98%)
          const foodPercent = (food / MAX_FOOD) * 100;
          const waterPercent = (water / MAX_WATER) * 100;

          if (item.kcal > 0 && foodPercent >= 98) {
            alert(
              translations[currentLang].foodFull || "Nie mo≈ºesz wiƒôcej je≈õƒá!"
            );
            return;
          }
          if (item.ml > 0 && waterPercent >= 98) {
            alert(
              translations[currentLang].waterFull || "Nie mo≈ºesz wiƒôcej piƒá!"
            );
            return;
          }

          // U≈ºyj przedmiotu
          food = Math.min(food + item.kcal, MAX_FOOD);
          water = Math.min(water + item.ml, MAX_WATER);
          health = Math.max(0, Math.min(health + item.hp, MAX_HEALTH));

          // D≈∫wiƒôk
          if (item.ml > 0) {
            playSound("drink");
          } else {
            playSound("eat");
          }

          // Usu≈Ñ z plecaka
          backpack.splice(index, 1);

          saveState();
          updateAllDisplays();
          updateInventoryDisplay();
          renderBackpack();

          let effectText = "";
          if (item.kcal > 0) effectText += `+${item.kcal} kcal `;
          if (item.ml > 0) effectText += `+${item.ml} ml `;
          if (item.hp > 0) effectText += `+${item.hp} HP`;
          if (item.hp < 0) effectText += `${item.hp} HP`;

          alert(`${item.icon} ${getItemName(item)}\n${effectText}`);
        }

        function formatCurrency(amount) {
          const symbol = currentLang === "en" ? "$" : "z≈Ç";
          return amount.toLocaleString() + " " + symbol;
        }

        function getCurrency() {
          return currentLang === "en" ? "$" : "z≈Ç";
        }

        function updateMoneyDisplay() {
          const display = document.getElementById("moneyDisplay");
          display.textContent = formatCurrency(money);
          display.classList.toggle("low", money < 5000);
        }

        function updateCardDisplay() {
          document.getElementById("cardCode").textContent = cardCode;
          document.getElementById("cardBalance").textContent =
            formatCurrency(money);
          document.getElementById("limitValue").textContent =
            formatCurrency(limit);
          document.getElementById("spentValue").textContent =
            formatCurrency(spent);
          document.getElementById("remainingValue").textContent =
            formatCurrency(limit - spent);
          document.getElementById("limitBar").style.width =
            Math.min((spent / limit) * 100, 100) + "%";

          // Lista ubezpiecze≈Ñ na karcie
          const listEl = document.getElementById("insuranceAutoPayList");
          const noInsEl = document.getElementById("noInsurancesCard");
          const t = translations[currentLang] || translations.en;

          if (activeInsurances.length > 0) {
            noInsEl.style.display = "none";
            listEl.innerHTML = activeInsurances
              .map((ins, idx) => {
                const pkg = insurancePackages.find(
                  (p) => p.id === ins.packageId
                );
                if (!pkg) return "";

                const periodText =
                  ins.period === "day"
                    ? t.perDay || "/d"
                    : ins.period === "week"
                    ? t.perWeek || "/tyg"
                    : t.perMonth || "/mies";

                return `
                        <div class="tax-toggle" style="margin-bottom:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px;">
                            <div>
                                <strong style="font-size:0.9em;">${
                                  pkg.icon
                                } ${getInsuranceName(pkg)}</strong>
                                <p style="font-size:0.7em;color:#888;margin:0;">${
                                  ins.price
                                } z≈Ç ${periodText}</p>
                            </div>
                            <div class="toggle-switch ${
                              ins.autoPay ? "active" : ""
                            }" onclick="toggleInsuranceAutoPayFromCard(${idx})"></div>
                        </div>
                    `;
              })
              .join("");
          } else {
            noInsEl.style.display = "block";
            listEl.innerHTML = "";
          }
        }

        function toggleInsuranceAutoPayFromCard(index) {
          if (index < 0 || index >= activeInsurances.length) return;
          activeInsurances[index].autoPay = !activeInsurances[index].autoPay;
          saveState();
          updateCardDisplay();
        }

        function updateDebtDisplay() {
          const debtDisplay = document.getElementById("debtDisplay");

          if (debt > 0) {
            debtDisplay.classList.add("active");
            document.getElementById("debtAmount").textContent =
              debt.toLocaleString() + " " + getCurrency();

            if (debtDeadline) {
              const daysLeft = Math.ceil(
                (new Date(debtDeadline) - new Date()) / (1000 * 60 * 60 * 24)
              );
              document.getElementById(
                "debtDeadline"
              ).textContent = `${daysLeft} ${
                translations[currentLang].daysLeft || "dni do sp≈Çaty"
              }`;
            }

            document.getElementById("currentDebt").textContent =
              debt.toLocaleString() + " " + getCurrency();
            document.getElementById("payDebtBtn").style.display = "block";
          } else {
            debtDisplay.classList.remove("active");
            document.getElementById("currentDebt").textContent =
              "0 " + getCurrency();
            document.getElementById("payDebtBtn").style.display = "none";
          }
        }

        function updateTaxDisplay() {
          document.getElementById("totalTaxPaid").textContent =
            totalTaxPaid.toLocaleString() + " " + getCurrency();
          document
            .getElementById("autoPayToggle")
            .classList.toggle("active", autoPay);
        }

        // ==================== MODALS ====================
        function openModal(type) {
          document
            .getElementById(
              "modal" + type.charAt(0).toUpperCase() + type.slice(1)
            )
            .classList.add("active");

          if (type === "card") updateCardDisplay();
          if (type === "tax") {
            updateTaxDisplay();
            updateDebtDisplay();
          }
          if (type === "pin") {
            currentPin = "";
            updatePinDisplay();
          }
          if (type === "sell") {
            renderGarage();
          }
          if (type === "buy") {
            carSearchQuery = "";
            document.getElementById("carSearchInput").value = "";
            renderCarBuyList();
          }
          if (type === "earn") initEarnInputs();
          if (type === "repair") {
            selectedRepairCarIndex = null;
            renderRepairCarList();
          }
          if (type === "shop") {
            currentShopTab = "food";
            renderShopItems();
            document
              .querySelectorAll("#modalShop .inv-tab")
              .forEach((t, i) => t.classList.toggle("active", i === 0));
          }
          if (type === "inventory") {
            updateInventoryDisplay();
            renderBackpack();
          }
          if (type === "insurance") {
            renderInsuranceList();
          }
          if (type === "saves") {
            renderSavesList();
          }
          if (type === "vouchers") {
            renderVouchersList();
          }
          if (type === "garage") {
            renderGarageModal();
          }
          if (type === "work") {
            renderJobsList();
          }
          if (type === "onlineAccount") {
            renderOnlineAccount();
          }
          if (type === "notifications") {
            renderNotifications();
          }
        }

        function closeModal(type) {
          document
            .getElementById(
              "modal" + type.charAt(0).toUpperCase() + type.slice(1)
            )
            .classList.remove("active");
        }

        function resetUploadForm(type) {
          const fileEl = document.getElementById(type + "File");
          const previewEl = document.getElementById(type + "Preview");
          const uploadEl = document.getElementById(type + "Upload");
          const responseEl = document.getElementById(type + "Response");
          const btnEl = document.getElementById(type + "Btn");

          if (fileEl) fileEl.value = "";
          if (previewEl) previewEl.style.display = "none";
          if (uploadEl) uploadEl.style.display = "block";
          if (responseEl) responseEl.classList.remove("active");
          if (btnEl) btnEl.classList.remove("active");
        }

        // ==================== PIN ====================
        function updatePinDisplay() {
          for (let i = 1; i <= 6; i++) {
            const digit = document.getElementById("pin" + i);
            digit.textContent = currentPin.length >= i ? "‚óè" : "";
            digit.classList.toggle("filled", currentPin.length >= i);
          }
        }

        function addPinDigit(d) {
          if (currentPin.length < 6) {
            currentPin += d;
            updatePinDisplay();
          }
        }
        function deletePinDigit() {
          currentPin = currentPin.slice(0, -1);
          updatePinDisplay();
        }

        function confirmPin() {
          if (currentPin === pin) {
            if (pendingAction === "resetLimit") {
              spent = 0;
              saveState();
              updateCardDisplay();
              alert("‚úÖ");
            } else if (pendingAction === "setLimit") {
              const newLimit = parseInt(
                document.getElementById("newLimitInput").value
              );
              if (newLimit >= 100) {
                limit = newLimit;
                saveState();
                updateCardDisplay();
                alert("‚úÖ");
              }
            } else if (pendingAction === "repair") {
              money -= REPAIR_COST;
              spent += REPAIR_COST;
              saveState();
              updateAllDisplays();
              alert(`üîß -5,000 ${getCurrency()}`);
              closeModal("repair");
            } else if (pendingAction === "buy") {
              money -= currentBuyPrice;
              spent += currentBuyPrice;
              saveState();
              updateAllDisplays();
              alert(`üöô -${currentBuyPrice.toLocaleString()} ${getCurrency()}`);
              closeModal("buy");
            } else if (pendingAction === "buyAuction" && pendingAuctionId) {
              completePurchaseWithPin(pendingAuctionId);
            }
            pendingAction = null;
            closeModal("pin");
          } else {
            alert("‚ùå PIN");
            currentPin = "";
            updatePinDisplay();
          }
        }

        function setNewLimit() {
          const newLimit = parseInt(
            document.getElementById("newLimitInput").value
          );
          if (newLimit >= 100) {
            pendingAction = "setLimit";
            closeModal("setLimit");
            openModal("pin");
          } else {
            alert("‚ùå Min. 100 z≈Ç");
          }
        }

        // ==================== JƒòZYKI ====================
        function generateLangGrid() {
          const grid = document.getElementById("langGrid");
          grid.innerHTML = "";
          Object.entries(languages).forEach(([code, lang]) => {
            const option = document.createElement("div");
            option.className =
              "lang-option" + (code === currentLang ? " selected" : "");
            option.innerHTML = `${lang.flag} ${lang.name}`;
            option.onclick = () => {
              currentLang = code;
              saveState();
              applyLanguage();
              updateAllDisplays();
              generateLangGrid();
              closeModal("language");
            };
            grid.appendChild(option);
          });
        }

        function applyLanguage() {
          const trans = translations[currentLang] || translations.en;
          document.querySelectorAll("[data-translate]").forEach((el) => {
            if (trans[el.getAttribute("data-translate")]) {
              el.textContent = trans[el.getAttribute("data-translate")];
            }
          });
          // Aktualizuj te≈º ekran blokady mobilnej
          if (typeof updateMobileBlockLanguage === "function") {
            updateMobileBlockLanguage();
          }
        }

        // ==================== DRAG & DROP ====================
        ["repair", "sell"].forEach((type) => {
          const area = document.getElementById(type + "Upload");
          if (!area) return;
          area.addEventListener("dragover", (e) => {
            e.preventDefault();
            area.classList.add("dragover");
          });
          area.addEventListener("dragleave", () =>
            area.classList.remove("dragover")
          );
          area.addEventListener("drop", (e) => {
            e.preventDefault();
            area.classList.remove("dragover");
            const file = e.dataTransfer.files[0];
            if (file?.type.startsWith("image/")) {
              const input = document.getElementById(type + "File");
              const dt = new DataTransfer();
              dt.items.add(file);
              input.files = dt.files;
              if (type === "repair") analyzeRepairImage(input);
              else if (type === "sell") startSellQR(input);
            }
          });
        });

        // Background tax
        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) {
            checkMissedTaxes();
            updateAllDisplays();
            processBusinessWeeklyPayments();
          }
        });
        window.addEventListener("beforeunload", saveState);

        // ==================== SYSTEM FIRM ====================

        // Kategorie firm - z t≈Çumaczeniami
        function getBusinessCategories() {
          const isEn = currentLang === "en";
          return {
            gastronomy: {
              name: isEn ? "üçî Gastronomy" : "üçî Gastronomia",
              types: [
                {
                  id: "fastfood",
                  name: "Fast Food",
                  icon: "üçü",
                  startCost: 25000,
                  clientsPerDay: 10,
                  avgIncome: 50,
                },
                {
                  id: "restaurant",
                  name: isEn ? "Restaurant" : "Restauracja",
                  icon: "üçΩÔ∏è",
                  startCost: 75000,
                  clientsPerDay: 8,
                  avgIncome: 150,
                },
                {
                  id: "cafe",
                  name: isEn ? "Cafe" : "Kawiarnia",
                  icon: "‚òï",
                  startCost: 35000,
                  clientsPerDay: 15,
                  avgIncome: 30,
                },
                {
                  id: "pizzeria",
                  name: "Pizzeria",
                  icon: "üçï",
                  startCost: 45000,
                  clientsPerDay: 12,
                  avgIncome: 60,
                },
                {
                  id: "bar",
                  name: "Bar",
                  icon: "üç∫",
                  startCost: 55000,
                  clientsPerDay: 20,
                  avgIncome: 40,
                },
              ],
            },
            retail: {
              name: isEn ? "üõí Retail" : "üõí Handel",
              types: [
                {
                  id: "grocery",
                  name: isEn ? "Grocery Store" : "Sklep spo≈ºywczy",
                  icon: "üõí",
                  startCost: 40000,
                  clientsPerDay: 25,
                  avgIncome: 20,
                },
                {
                  id: "electronics",
                  name: isEn ? "Electronics Store" : "Sklep elektroniczny",
                  icon: "üì±",
                  startCost: 100000,
                  clientsPerDay: 5,
                  avgIncome: 500,
                },
                {
                  id: "clothes",
                  name: isEn ? "Clothing Boutique" : "Butik odzie≈ºowy",
                  icon: "üëï",
                  startCost: 60000,
                  clientsPerDay: 8,
                  avgIncome: 120,
                },
                {
                  id: "autoparts",
                  name: isEn ? "Auto Parts Store" : "Sklep z czƒô≈õciami",
                  icon: "üîß",
                  startCost: 80000,
                  clientsPerDay: 6,
                  avgIncome: 200,
                },
                {
                  id: "pharmacy",
                  name: isEn ? "Pharmacy" : "Apteka",
                  icon: "üíä",
                  startCost: 120000,
                  clientsPerDay: 15,
                  avgIncome: 80,
                },
              ],
            },
            services: {
              name: isEn ? "üîß Services" : "üîß Us≈Çugi",
              types: [
                {
                  id: "carwash",
                  name: isEn ? "Car Wash" : "Myjnia samochodowa",
                  icon: "üöø",
                  startCost: 30000,
                  clientsPerDay: 20,
                  avgIncome: 35,
                },
                {
                  id: "mechanic",
                  name: isEn ? "Auto Workshop" : "Warsztat samochodowy",
                  icon: "üîß",
                  startCost: 70000,
                  clientsPerDay: 5,
                  avgIncome: 300,
                },
                {
                  id: "hairdresser",
                  name: isEn ? "Hair Salon" : "Salon fryzjerski",
                  icon: "üíá",
                  startCost: 25000,
                  clientsPerDay: 12,
                  avgIncome: 50,
                },
                {
                  id: "gym",
                  name: isEn ? "Gym" : "Si≈Çownia",
                  icon: "üèãÔ∏è",
                  startCost: 90000,
                  clientsPerDay: 30,
                  avgIncome: 25,
                },
                {
                  id: "hotel",
                  name: "Hotel",
                  icon: "üè®",
                  startCost: 200000,
                  clientsPerDay: 10,
                  avgIncome: 200,
                },
              ],
            },
            finance: {
              name: isEn ? "üí∞ Finance" : "üí∞ Finanse",
              types: [
                {
                  id: "bank",
                  name: isEn ? "Bank" : "Bank",
                  icon: "üè¶",
                  startCost: 500000,
                  clientsPerDay: 15,
                  avgIncome: 100,
                  special: "bank",
                },
                {
                  id: "insurance",
                  name: isEn ? "Insurance Company" : "Firma ubezpieczeniowa",
                  icon: "üõ°Ô∏è",
                  startCost: 300000,
                  clientsPerDay: 8,
                  avgIncome: 250,
                  special: "insurance",
                },
                {
                  id: "exchange",
                  name: isEn ? "Currency Exchange" : "Kantor",
                  icon: "üí±",
                  startCost: 150000,
                  clientsPerDay: 20,
                  avgIncome: 50,
                },
                {
                  id: "loans",
                  name: isEn ? "Loan Company" : "Firma po≈ºyczkowa",
                  icon: "üí≥",
                  startCost: 250000,
                  clientsPerDay: 10,
                  avgIncome: 150,
                  special: "loans",
                },
              ],
            },
            transport: {
              name: "üöö Transport",
              types: [
                {
                  id: "taxi",
                  name: isEn ? "Taxi Company" : "Firma taks√≥wkowa",
                  icon: "üöï",
                  startCost: 50000,
                  clientsPerDay: 25,
                  avgIncome: 40,
                },
                {
                  id: "delivery",
                  name: isEn ? "Delivery Company" : "Firma kurierska",
                  icon: "üì¶",
                  startCost: 80000,
                  clientsPerDay: 30,
                  avgIncome: 25,
                },
                {
                  id: "trucking",
                  name: isEn ? "Trucking Company" : "Firma transportowa",
                  icon: "üöõ",
                  startCost: 200000,
                  clientsPerDay: 5,
                  avgIncome: 500,
                },
                {
                  id: "rental",
                  name: isEn ? "Car Rental" : "Wypo≈ºyczalnia aut",
                  icon: "üöó",
                  startCost: 150000,
                  clientsPerDay: 8,
                  avgIncome: 150,
                },
              ],
            },
            tech: {
              name: isEn ? "üíª Technology" : "üíª Technologia",
              types: [
                {
                  id: "software",
                  name: "Software House",
                  icon: "üíª",
                  startCost: 100000,
                  clientsPerDay: 3,
                  avgIncome: 1000,
                },
                {
                  id: "itservice",
                  name: isEn ? "IT Service" : "Serwis IT",
                  icon: "üñ•Ô∏è",
                  startCost: 40000,
                  clientsPerDay: 8,
                  avgIncome: 150,
                },
                {
                  id: "webagency",
                  name: isEn ? "Web Agency" : "Agencja webowa",
                  icon: "üåê",
                  startCost: 60000,
                  clientsPerDay: 5,
                  avgIncome: 300,
                },
                {
                  id: "gaming",
                  name: isEn ? "Game Studio" : "Studio gier",
                  icon: "üéÆ",
                  startCost: 150000,
                  clientsPerDay: 2,
                  avgIncome: 2000,
                },
              ],
            },
            entertainment: {
              name: isEn ? "üé¨ Entertainment" : "üé¨ Rozrywka",
              types: [
                {
                  id: "cinema",
                  name: isEn ? "Cinema" : "Kino",
                  icon: "üé¨",
                  startCost: 300000,
                  clientsPerDay: 100,
                  avgIncome: 30,
                },
                {
                  id: "club",
                  name: isEn ? "Night Club" : "Klub nocny",
                  icon: "üéµ",
                  startCost: 200000,
                  clientsPerDay: 50,
                  avgIncome: 40,
                },
                {
                  id: "arcade",
                  name: isEn ? "Arcade" : "Salon gier",
                  icon: "üïπÔ∏è",
                  startCost: 80000,
                  clientsPerDay: 40,
                  avgIncome: 15,
                },
                {
                  id: "escape",
                  name: "Escape Room",
                  icon: "üîê",
                  startCost: 50000,
                  clientsPerDay: 6,
                  avgIncome: 100,
                },
              ],
            },
            construction: {
              name: isEn ? "üèóÔ∏è Construction" : "üèóÔ∏è Budownictwo",
              types: [
                {
                  id: "construction",
                  name: isEn ? "Construction Company" : "Firma budowlana",
                  icon: "üèóÔ∏è",
                  startCost: 250000,
                  clientsPerDay: 2,
                  avgIncome: 2000,
                },
                {
                  id: "renovation",
                  name: isEn ? "Renovation Company" : "Firma remontowa",
                  icon: "üî®",
                  startCost: 80000,
                  clientsPerDay: 4,
                  avgIncome: 500,
                },
                {
                  id: "architecture",
                  name: isEn ? "Architecture Office" : "Biuro architektoniczne",
                  icon: "üìê",
                  startCost: 120000,
                  clientsPerDay: 3,
                  avgIncome: 800,
                },
              ],
            },
          };
        }

        // Imiona pracownik√≥w
        const WORKER_NAMES = {
          male: [
            "Adam",
            "Piotr",
            "Marcin",
            "Tomasz",
            "Micha≈Ç",
            "Krzysztof",
            "Jan",
            "Pawe≈Ç",
            "Andrzej",
            "Marek",
            "Robert",
            "Kamil",
            "≈Åukasz",
            "Jakub",
            "Mateusz",
            "John",
            "Mike",
            "David",
            "James",
            "Robert",
          ],
          female: [
            "Anna",
            "Maria",
            "Katarzyna",
            "Magdalena",
            "Agnieszka",
            "Joanna",
            "Monika",
            "Ewa",
            "Aleksandra",
            "Natalia",
            "Karolina",
            "Patrycja",
            "Justyna",
            "Dominika",
            "Weronika",
            "Sarah",
            "Emily",
            "Jessica",
            "Ashley",
            "Amanda",
          ],
        };

        const WORKER_SURNAMES = [
          "Kowalski",
          "Nowak",
          "Wi≈õniewski",
          "W√≥jcik",
          "Kowalczyk",
          "Kami≈Ñski",
          "Lewandowski",
          "Zieli≈Ñski",
          "Szyma≈Ñski",
          "Wo≈∫niak",
          "Smith",
          "Johnson",
          "Williams",
          "Brown",
          "Jones",
        ];

        // Typy osobowo≈õci pracownik√≥w z t≈Çumaczeniami
        function getWorkerPersonalities() {
          const isEn = currentLang === "en";
          return [
            {
              id: "ambitious",
              name: isEn ? "Ambitious" : "Ambitny",
              salaryMod: 1.3,
              productivityMod: 1.4,
              traits: isEn
                ? ["Wants promotion", "Works hard", "Demands more"]
                : ["Chce awansowaƒá", "Pracuje ciƒô≈ºko", "Wymaga wiƒôcej"],
            },
            {
              id: "lazy",
              name: isEn ? "Lazy" : "Leniwy",
              salaryMod: 0.8,
              productivityMod: 0.6,
              traits: isEn
                ? ["Minimizes effort", "Cheap", "Slow"]
                : ["Minimalizuje wysi≈Çek", "Tani", "Wolny"],
            },
            {
              id: "friendly",
              name: isEn ? "Friendly" : "Przyjazny",
              salaryMod: 1.0,
              productivityMod: 1.0,
              traits: isEn
                ? ["Good atmosphere", "Likes clients", "Stable"]
                : ["Dobra atmosfera", "Lubi klient√≥w", "Stabilny"],
            },
            {
              id: "perfectionist",
              name: isEn ? "Perfectionist" : "Perfekcjonista",
              salaryMod: 1.2,
              productivityMod: 1.3,
              traits: isEn
                ? ["High quality", "Slower", "Precise"]
                : ["Wysoka jako≈õƒá", "Wolniejszy", "Dok≈Çadny"],
            },
            {
              id: "experienced",
              name: isEn ? "Experienced" : "Do≈õwiadczony",
              salaryMod: 1.5,
              productivityMod: 1.5,
              traits: isEn
                ? ["Very effective", "Expensive", "Reliable"]
                : ["Bardzo skuteczny", "Drogi", "Niezawodny"],
            },
            {
              id: "newbie",
              name: isEn ? "Newbie" : "PoczƒÖtkujƒÖcy",
              salaryMod: 0.6,
              productivityMod: 0.7,
              traits: isEn
                ? ["Cheap", "Learning", "Makes mistakes"]
                : ["Tani", "Uczy siƒô", "Pope≈Çnia b≈Çƒôdy"],
            },
          ];
        }

        // Pobierz przet≈ÇumaczonƒÖ osobowo≈õƒá po ID
        function getTranslatedPersonality(personalityId) {
          const personalities = getWorkerPersonalities();
          return (
            personalities.find((p) => p.id === personalityId) ||
            personalities[0]
          );
        }

        // Pobierz przet≈Çumaczone stanowisko po ID
        function getTranslatedPosition(positionId) {
          const positions = getWorkerPositions();
          return positions[positionId] || positions.regular;
        }

        // Stanowiska z t≈Çumaczeniami
        function getWorkerPositions() {
          const isEn = currentLang === "en";
          return {
            manager: {
              name: isEn ? "Manager" : "Kierownik",
              baseSalary: 800,
              required: true,
            },
            senior: {
              name: isEn ? "Senior Worker" : "Starszy pracownik",
              baseSalary: 500,
            },
            regular: { name: isEn ? "Worker" : "Pracownik", baseSalary: 350 },
            junior: {
              name: isEn ? "Junior Worker" : "M≈Çodszy pracownik",
              baseSalary: 250,
            },
            intern: { name: isEn ? "Intern" : "Sta≈ºysta", baseSalary: 150 },
          };
        }

        // Generuj losowego pracownika
        function generateWorker(position = "regular") {
          const isMale = Math.random() > 0.5;
          const names = isMale ? WORKER_NAMES.male : WORKER_NAMES.female;
          const name = names[Math.floor(Math.random() * names.length)];
          let surname =
            WORKER_SURNAMES[Math.floor(Math.random() * WORKER_SURNAMES.length)];
          if (!isMale && surname.endsWith("ski"))
            surname = surname.slice(0, -1) + "a";
          if (!isMale && surname.endsWith("cki"))
            surname = surname.slice(0, -2) + "ka";

          const personalities = getWorkerPersonalities();
          const positions = getWorkerPositions();
          const personality =
            personalities[Math.floor(Math.random() * personalities.length)];
          const pos = positions[position];

          const expectedSalary = Math.floor(
            pos.baseSalary * personality.salaryMod * (0.9 + Math.random() * 0.3)
          );
          const minSalary = Math.floor(expectedSalary * 0.7);
          const bonusPercent = Math.floor(5 + Math.random() * 20);

          return {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            name: `${name} ${surname}`,
            gender: isMale ? "male" : "female",
            position: position,
            positionName: pos.name,
            personality: personality,
            expectedSalary: expectedSalary,
            minSalary: minSalary,
            currentSalary: null,
            bonusPercent: bonusPercent,
            hired: false,
            productivity: personality.productivityMod,
            satisfaction: 100,
            daysWorked: 0,
            totalEarned: 0,
            chatHistory: [],
            negotiationState: "initial", // initial, negotiating, accepted, rejected
          };
        }

        // Generuj klienta dla firmy
        function generateClient(businessType) {
          const isMale = Math.random() > 0.5;
          const names = isMale ? WORKER_NAMES.male : WORKER_NAMES.female;
          const name = names[Math.floor(Math.random() * names.length)];

          const moods = ["happy", "neutral", "impatient", "demanding"];
          const mood = moods[Math.floor(Math.random() * moods.length)];

          return {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            name: name,
            gender: isMale ? "male" : "female",
            mood: mood,
            chatHistory: [],
            resolved: false,
            spending: 0,
          };
        }

        // Stan czatu z botem
        let currentBusinessChat = {
          type: null, // "worker" lub "client"
          businessId: null,
          targetId: null,
          awaitingInput: null,
        };

        // ========== G≈Å√ìWNE FUNKCJE FIRM ==========

        function getBusinesses() {
          const save = getCurrentSave();
          if (!save.data.businesses) save.data.businesses = [];
          return save.data.businesses;
        }

        function saveBusinesses(businesses) {
          const save = getCurrentSave();
          save.data.businesses = businesses;
          saveState();
        }

        function renderBusinessModal() {
          const content = document.getElementById("businessContent");
          const t = translations[currentLang] || translations.en;
          const businesses = getBusinesses();

          if (businesses.length === 0) {
            content.innerHTML = `
            <div style="text-align: center; padding: 30px;">
              <div style="font-size: 4em; margin-bottom: 15px;">üè¢</div>
              <p style="color: #888; margin-bottom: 20px;">${t.noBusinesses}</p>
              <button onclick="showCreateBusiness()" style="padding: 15px 30px; background: linear-gradient(145deg, #f59e0b, #d97706); color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer;">
                üèóÔ∏è ${t.createBusiness}
              </button>
            </div>
          `;
            return;
          }

          let totalIncome = 0;
          let totalExpenses = 0;
          businesses.forEach((b) => {
            totalIncome += b.weeklyIncome || 0;
            totalExpenses += b.weeklyExpenses || 0;
          });

          content.innerHTML = `
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: #888;">${t.totalIncomeWeek}:</span>
              <span style="color: #4ade80; font-weight: bold;">+${totalIncome.toLocaleString()} ${getCurrency()}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #888;">${t.totalExpensesWeek}:</span>
              <span style="color: #ef4444; font-weight: bold;">-${totalExpenses.toLocaleString()} ${getCurrency()}</span>
            </div>
            <div style="border-top: 1px solid #333; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
              <span style="color: #888;">${t.netProfitWeek}:</span>
              <span style="color: ${
                totalIncome - totalExpenses >= 0 ? "#4ade80" : "#ef4444"
              }; font-weight: bold;">
                ${totalIncome - totalExpenses >= 0 ? "+" : ""}${(
            totalIncome - totalExpenses
          ).toLocaleString()} ${getCurrency()}
              </span>
            </div>
          </div>

          <div style="max-height: 300px; overflow-y: auto;">
            ${businesses
              .map(
                (b, i) => `
              <div onclick="showBusinessDetail(${i})" style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" 
                   onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1em; font-weight: bold;">${
                      b.icon
                    } ${b.name}</div>
                    <div style="color: #888; font-size: 0.85em;">${
                      b.typeName
                    }</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #4ade80;">+${(
                      b.weeklyIncome || 0
                    ).toLocaleString()}/${
                  currentLang === "en" ? "wk" : "tyg"
                }</div>
                    <div style="color: #888; font-size: 0.85em;">üë• ${
                      b.workers?.filter((w) => w.hired).length || 0
                    } ${t.workers}</div>
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>

          <button onclick="showCreateBusiness()" style="width: 100%; padding: 15px; background: linear-gradient(145deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; margin-top: 15px;">
            ‚ûï ${t.createNextBusiness}
          </button>
        `;
        }

        function showCreateBusiness() {
          closeModal("business");
          openModal("createBusiness");
          renderCreateBusinessStep1();
        }

        function renderCreateBusinessStep1() {
          const content = document.getElementById("createBusinessContent");
          const t = translations[currentLang] || translations.en;

          content.innerHTML = `
          <p style="color: #888; margin-bottom: 15px; text-align: center;">${
            t.selectCategory
          }:</p>
          <div style="max-height: 400px; overflow-y: auto;">
            ${Object.entries(getBusinessCategories())
              .map(
                ([catId, cat]) => `
              <div onclick="renderCreateBusinessStep2('${catId}')" style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                   onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                <div style="font-size: 1.1em; font-weight: bold;">${cat.name}</div>
                <div style="color: #888; font-size: 0.85em;">${cat.types.length} ${t.businessTypes}</div>
              </div>
            `
              )
              .join("")}
          </div>
          <button onclick="closeModal('createBusiness'); openModal('business');" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer;">
            ‚Üê ${t.back}
          </button>
        `;
        }

        function renderCreateBusinessStep2(categoryId) {
          const content = document.getElementById("createBusinessContent");
          const category = getBusinessCategories()[categoryId];
          const t = translations[currentLang] || translations.en;

          content.innerHTML = `
          <p style="color: #888; margin-bottom: 15px; text-align: center;">${
            category.name
          } - ${t.selectType}:</p>
          <div style="max-height: 400px; overflow-y: auto;">
            ${category.types
              .map(
                (type) => `
              <div onclick="renderCreateBusinessStep3('${categoryId}', '${
                  type.id
                }')" style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                   onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1em; font-weight: bold;">${
                      type.icon
                    } ${type.name}</div>
                    <div style="color: #888; font-size: 0.85em;">~${
                      type.clientsPerDay
                    } ${t.clientsPerDay}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #f59e0b; font-weight: bold;">${type.startCost.toLocaleString()} ${getCurrency()}</div>
                    <div style="color: #4ade80; font-size: 0.85em;">~${
                      type.avgIncome
                    } ${getCurrency()}/${
                  currentLang === "en" ? "client" : "klient"
                }</div>
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
          <button onclick="renderCreateBusinessStep1()" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer;">
            ‚Üê ${t.backToCategories}
          </button>
        `;
        }

        function renderCreateBusinessStep3(categoryId, typeId) {
          const content = document.getElementById("createBusinessContent");
          const category = getBusinessCategories()[categoryId];
          const type = category.types.find((tp) => tp.id === typeId);
          const t = translations[currentLang] || translations.en;

          const canAfford = money >= type.startCost;

          content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em;">${type.icon}</div>
            <div style="font-size: 1.3em; font-weight: bold; margin-top: 10px;">${
              type.name
            }</div>
          </div>

          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: #888;">${t.startCost}:</span>
              <span style="color: #f59e0b; font-weight: bold;">${type.startCost.toLocaleString()} ${getCurrency()}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: #888;">${t.clientsPerDay}:</span>
              <span>~${type.clientsPerDay}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #888;">${t.avgIncomeClient}:</span>
              <span style="color: #4ade80;">~${
                type.avgIncome
              } ${getCurrency()}</span>
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="color: #888; font-size: 0.9em;">${
              t.businessName
            }:</label>
            <input type="text" id="newBusinessName" placeholder="${
              type.name
            }" maxlength="30" 
                   style="width: 100%; padding: 12px; background: #1a1a2e; border: 2px solid #333; border-radius: 8px; color: white; margin-top: 5px; font-size: 1em;">
          </div>

          ${
            !canAfford
              ? `
            <div style="background: rgba(239,68,68,0.2); border: 1px solid #ef4444; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
              <span style="color: #ef4444;">‚ùå ${
                t.notEnoughMoneyBusiness
              }</span>
              <div style="color: #888; font-size: 0.85em; margin-top: 5px;">${
                t.youNeed
              }: ${type.startCost.toLocaleString()} ${getCurrency()}</div>
            </div>
          `
              : ""
          }

          <button onclick="createBusiness('${categoryId}', '${typeId}')" ${
            !canAfford ? "disabled" : ""
          } 
                  style="width: 100%; padding: 15px; background: ${
                    canAfford
                      ? "linear-gradient(145deg, #10b981, #059669)"
                      : "#333"
                  }; color: white; border: none; border-radius: 10px; font-size: 1em; cursor: ${
            canAfford ? "pointer" : "not-allowed"
          };">
            üèóÔ∏è ${
              t.createBusinessFor
            } ${type.startCost.toLocaleString()} ${getCurrency()}
          </button>

          <button onclick="renderCreateBusinessStep2('${categoryId}')" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer;">
            ‚Üê ${t.back}
          </button>
        `;
        }

        function createBusiness(categoryId, typeId) {
          const category = getBusinessCategories()[categoryId];
          const type = category.types.find((tp) => tp.id === typeId);
          const nameInput = document.getElementById("newBusinessName");
          const name = nameInput?.value.trim() || type.name;
          const t = translations[currentLang] || translations.en;

          if (money < type.startCost) {
            showToast("‚ùå " + t.notEnoughMoneyBusiness);
            return;
          }

          money -= type.startCost;

          // Generuj poczƒÖtkowych kandydat√≥w na pracownik√≥w
          const candidates = [];
          candidates.push(generateWorker("manager")); // Zawsze jeden kierownik
          for (let i = 0; i < 3; i++) {
            candidates.push(generateWorker("regular"));
          }
          for (let i = 0; i < 2; i++) {
            candidates.push(generateWorker("junior"));
          }

          const newBusiness = {
            id: Date.now().toString(),
            name: name,
            categoryId: categoryId,
            typeId: typeId,
            typeName: type.name,
            icon: type.icon,
            startCost: type.startCost,
            clientsPerDay: type.clientsPerDay,
            avgIncome: type.avgIncome,
            special: type.special || null,
            createdAt: Date.now(),
            workers: candidates,
            clients: [],
            weeklyIncome: 0,
            weeklyExpenses: 0,
            totalIncome: 0,
            totalExpenses: 0,
            lastPaymentTime: Date.now(),
            reputation: 50, // 0-100
            insurances: [], // Dla firm ubezpieczeniowych
          };

          const businesses = getBusinesses();
          businesses.push(newBusiness);
          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          closeModal("createBusiness");
          openModal("business");
          renderBusinessModal();
          showToast(`üè¢ ${t.businessCreated}: ${name}!`);
        }

        function showBusinessDetail(index) {
          const businesses = getBusinesses();
          const business = businesses[index];
          if (!business) return;

          closeModal("business");
          openModal("businessDetail");
          renderBusinessDetail(index);
        }

        function renderBusinessDetail(index) {
          const content = document.getElementById("businessDetailContent");
          const businesses = getBusinesses();
          const business = businesses[index];
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          const hiredWorkers = business.workers.filter((w) => w.hired);
          const candidateWorkers = business.workers.filter((w) => !w.hired);
          const weeklyProfit =
            (business.weeklyIncome || 0) - (business.weeklyExpenses || 0);

          content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 2.5em;">${business.icon}</div>
            <h2 style="color: #ff6b35; margin-top: 10px;">${business.name}</h2>
            <div style="color: #888;">${business.typeName}</div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
            <div style="background: rgba(74,222,128,0.1); border: 1px solid #4ade80; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="color: #4ade80; font-size: 1.3em; font-weight: bold;">+${(
                business.weeklyIncome || 0
              ).toLocaleString()}</div>
              <div style="color: #888; font-size: 0.8em;">${
                isEn ? "income/week" : "przych√≥d/tydzie≈Ñ"
              }</div>
            </div>
            <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="color: #ef4444; font-size: 1.3em; font-weight: bold;">-${(
                business.weeklyExpenses || 0
              ).toLocaleString()}</div>
              <div style="color: #888; font-size: 0.8em;">${
                isEn ? "expenses/week" : "wydatki/tydzie≈Ñ"
              }</div>
            </div>
          </div>

          <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>${t.netProfitWeek}:</span>
              <span style="color: ${
                weeklyProfit >= 0 ? "#4ade80" : "#ef4444"
              }; font-weight: bold; font-size: 1.2em;">
                ${
                  weeklyProfit >= 0 ? "+" : ""
                }${weeklyProfit.toLocaleString()} ${getCurrency()}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
              <span style="color: #888;">${t.reputation}:</span>
              <span>${"‚≠ê".repeat(Math.floor(business.reputation / 20))} ${
            business.reputation
          }%</span>
            </div>
            ${
              hiredWorkers.length > 0
                ? (() => {
                    const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
                    const nextPay =
                      (business.lastPaymentTime || Date.now()) + WEEK_MS;
                    const remaining = nextPay - Date.now();
                    let timeStr = isEn ? "Now!" : "Teraz!";
                    if (remaining > 0) {
                      const days = Math.floor(
                        remaining / (24 * 60 * 60 * 1000)
                      );
                      const hours = Math.floor(
                        (remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000)
                      );
                      timeStr =
                        days > 0 ? days + "d " + hours + "h" : hours + "h";
                    }
                    return `
              <div style="border-top: 1px solid #333; margin-top: 10px; padding-top: 10px;">
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: #888;">üí∞ ${
                    isEn ? "Next payday" : "Nastƒôpna wyp≈Çata"
                  }:</span>
                  <span style="color: #ef4444;">${timeStr} (-${
                      business.weeklyExpenses || 0
                    } ${getCurrency()})</span>
                </div>
              </div>`;
                  })()
                : ""
            }
          </div>

          <h3 style="color: #f59e0b; margin: 20px 0 10px;">üë• ${
            t.hiredWorkers
          } (${hiredWorkers.length})</h3>
          ${
            hiredWorkers.length === 0
              ? `
            <p style="color: #666; text-align: center; padding: 15px;">${t.noWorkersYet}</p>
          `
              : `
            <div style="max-height: 150px; overflow-y: auto;">
              ${hiredWorkers
                .map((w) => {
                  const translatedPersonality = getTranslatedPersonality(
                    w.personality.id
                  );
                  const translatedPosition = getTranslatedPosition(w.position);
                  return `
                <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-weight: bold;">${
                      w.gender === "male" ? "üë®" : "üë©"
                    } ${w.name}</div>
                    <div style="color: #888; font-size: 0.85em;">${
                      translatedPosition.name
                    } ‚Ä¢ ${translatedPersonality.name}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #ef4444;">${w.currentSalary}/${
                    isEn ? "wk" : "tyg"
                  }</div>
                    <button onclick="talkToWorker(${index}, '${
                    w.id
                  }')" style="padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; font-size: 0.8em; cursor: pointer; margin-top: 5px;">üí¨</button>
                    <button onclick="fireWorker(${index}, '${
                    w.id
                  }')" style="padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 5px; font-size: 0.8em; cursor: pointer; margin-top: 5px;">üö´</button>
                  </div>
                </div>
              `;
                })
                .join("")}
            </div>
          `
          }

          <h3 style="color: #10b981; margin: 20px 0 10px;">üÜï ${
            t.candidates
          } (${candidateWorkers.length})</h3>
          ${
            candidateWorkers.length === 0
              ? `
            <p style="color: #666; text-align: center; padding: 15px;">${
              t.noCandidates
            }</p>
            <p style="color: #888; text-align: center; font-size: 0.85em;">
              ${
                isEn
                  ? "New candidates appear every 5 minutes"
                  : "Nowi kandydaci pojawiajƒÖ siƒô co 5 minut"
              }
            </p>
          `
              : `
            <div style="max-height: 200px; overflow-y: auto;">
              ${candidateWorkers
                .map((w) => {
                  const translatedPersonality = getTranslatedPersonality(
                    w.personality.id
                  );
                  const translatedPosition = getTranslatedPosition(w.position);
                  return `
                <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-weight: bold;">${
                        w.gender === "male" ? "üë®" : "üë©"
                      } ${w.name}</div>
                      <div style="color: #888; font-size: 0.85em;">${
                        translatedPosition.name
                      }</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="color: #f59e0b;">${
                        translatedPersonality.name
                      }</div>
                      <div style="color: #888; font-size: 0.8em;">${
                        t.expects
                      }: ~${w.expectedSalary}/${isEn ? "wk" : "tyg"}</div>
                    </div>
                  </div>
                  <div style="color: #666; font-size: 0.8em; margin-top: 5px;">
                    ${translatedPersonality.traits.join(" ‚Ä¢ ")}
                  </div>
                  <button onclick="negotiateWithWorker(${index}, '${
                    w.id
                  }')" style="width: 100%; padding: 10px; background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                    üí¨ ${t.negotiateTerms}
                  </button>
                </div>
              `;
                })
                .join("")}
            </div>
          `
          }

          ${
            business.clients && business.clients.length > 0
              ? `
            <h3 style="color: #8b5cf6; margin: 20px 0 10px;">üßë‚Äçü§ù‚Äçüßë ${
              t.activeClients
            } (${business.clients.length})</h3>
            <div style="max-height: 150px; overflow-y: auto;">
              ${business.clients
                .map(
                  (c) => `
                <div onclick="talkToClient(${index}, '${
                    c.id
                  }')" style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div>${c.gender === "male" ? "üë®" : "üë©"} ${c.name}</div>
                    <div style="color: #888; font-size: 0.85em;">${
                      c.mood === "happy"
                        ? "üòä"
                        : c.mood === "impatient"
                        ? "üò§"
                        : c.mood === "demanding"
                        ? "üò†"
                        : "üòê"
                    } ${c.mood}</div>
                  </div>
                  <button style="padding: 8px 15px; background: #8b5cf6; color: white; border: none; border-radius: 6px;">üí¨ ${
                    t.serve
                  }</button>
                </div>
              `
                )
                .join("")}
            </div>
          `
              : ""
          }

          ${(() => {
            // Info o nastƒôpnym dniu roboczym
            const lastDayTime = business.lastDayProcessed || Date.now();
            const DAY_MS = 24 * 60 * 60 * 1000; // 24h w rzeczywisto≈õci
            const nextDay = lastDayTime + DAY_MS;
            const remaining = nextDay - Date.now();
            let timeStr = isEn ? "Processing..." : "Przetwarzanie...";
            if (remaining > 0) {
              const hours = Math.floor(remaining / (60 * 60 * 1000));
              const mins = Math.floor(
                (remaining % (60 * 60 * 1000)) / (60 * 1000)
              );
              timeStr = hours + "h " + mins + "min";
            }
            return `
              <div style="background: rgba(139,92,246,0.1); border: 1px solid #8b5cf6; padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <div style="color: #8b5cf6; font-weight: bold;">üìÖ ${
                  isEn ? "Next work day in" : "Nastƒôpny dzie≈Ñ roboczy za"
                }:</div>
                <div style="font-size: 1.3em; margin-top: 5px;">${timeStr}</div>
                <div style="color: #666; font-size: 0.8em; margin-top: 5px;">${
                  isEn
                    ? "Days pass automatically every 24h"
                    : "Dni mijajƒÖ automatycznie co 24h"
                }</div>
              </div>
            `;
          })()}

          <button onclick="closeBusiness(${index})" style="width: 100%; padding: 12px; background: #333; color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; cursor: pointer; margin-top: 10px;">
            üóëÔ∏è ${t.closeBusiness}
          </button>

          <button onclick="closeModal('businessDetail'); openModal('business'); renderBusinessModal();" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
            ‚Üê ${t.backToList}
          </button>
        `;
        }

        function generateNewCandidates(businessIndex) {
          const t = translations[currentLang] || translations.en;
          if (money < 500) {
            showToast(
              "‚ùå " + t.needForRecruitment + " 500 " + getCurrency() + "!"
            );
            return;
          }
          money -= 500;

          const businesses = getBusinesses();
          const business = businesses[businessIndex];

          // Usu≈Ñ nieprzyjƒôtych kandydat√≥w
          business.workers = business.workers.filter((w) => w.hired);

          // Dodaj nowych
          const positions = [
            "manager",
            "senior",
            "regular",
            "regular",
            "junior",
            "junior",
            "intern",
          ];
          for (let i = 0; i < 4; i++) {
            const pos = positions[Math.floor(Math.random() * positions.length)];
            business.workers.push(generateWorker(pos));
          }

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();
          renderBusinessDetail(businessIndex);
          showToast("üîÑ " + t.foundCandidates);
        }

        // ========== SYSTEM CZATU Z AI (PRACOWNICY/KLIENCI) ==========

        function negotiateWithWorker(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const t = translations[currentLang] || translations.en;

          currentBusinessChat = {
            type: "worker_negotiate",
            businessId: businessIndex,
            targetId: workerId,
            awaitingInput: null,
          };

          closeModal("businessDetail");
          openModal("businessChat");

          document.getElementById(
            "businessChatTitle"
          ).textContent = `üí¨ ${t.chatWith} ${worker.name}`;

          // Reset historii czatu dla nowej negocjacji
          worker.chatHistory = [];
          worker.negotiationState = "initial";

          continueWorkerNegotiation(businessIndex, workerId);
        }

        function continueWorkerNegotiation(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          const messagesDiv = document.getElementById("businessChatMessages");
          const optionsDiv = document.getElementById("businessChatOptions");
          const inputDiv = document.getElementById("businessChatInput");

          // Renderuj historiƒô
          messagesDiv.innerHTML = worker.chatHistory
            .map(
              (msg) => `
          <div style="margin-bottom: 12px; ${
            msg.from === "player" ? "text-align: right;" : ""
          }">
            <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: ${
              msg.from === "player" ? "#3b82f6" : "#333"
            };">
              ${msg.text}
            </div>
          </div>
        `
            )
            .join("");
          messagesDiv.scrollTop = messagesDiv.scrollHeight;

          inputDiv.style.display = "none";
          optionsDiv.innerHTML = "";

          // Je≈õli ju≈º zatrudniony lub odrzucony - poka≈º tylko przycisk powrotu
          if (
            worker.negotiationState === "accepted" ||
            worker.negotiationState === "rejected"
          ) {
            optionsDiv.innerHTML = `
            <button onclick="closeModal('businessChat'); openModal('businessDetail'); renderBusinessDetail(${businessIndex});" style="padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ‚Üê ${t.backToBusinessBtn}
            </button>
          `;
            return;
          }

          // Stan negocjacji
          if (worker.negotiationState === "initial") {
            // Pierwsze powitanie pracownika
            const greetings = [
              t.greeting1
                .replace("{name}", worker.name)
                .replace("{position}", worker.positionName.toLowerCase()),
              t.greeting2.replace("{name}", worker.name),
              t.greeting3
                .replace("{name}", worker.name)
                .replace("{position}", worker.positionName.toLowerCase()),
            ];

            if (worker.chatHistory.length === 0) {
              worker.chatHistory.push({
                from: "worker",
                text: greetings[Math.floor(Math.random() * greetings.length)],
              });
              worker.chatHistory.push({
                from: "worker",
                text: t.salaryExpectation
                  .replace("{salary}", worker.expectedSalary)
                  .replace("{currency}", getCurrency())
                  .replace("{bonus}", worker.bonusPercent),
              });
              saveBusinesses(businesses);

              // Od≈õwie≈º wiadomo≈õci
              messagesDiv.innerHTML = worker.chatHistory
                .map(
                  (msg) => `
              <div style="margin-bottom: 12px; ${
                msg.from === "player" ? "text-align: right;" : ""
              }">
                <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: ${
                  msg.from === "player" ? "#3b82f6" : "#333"
                };">
                  ${msg.text}
                </div>
              </div>
            `
                )
                .join("");
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            // Opcje odpowiedzi - zawsze dostƒôpne
            optionsDiv.innerHTML = `
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'accept')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ‚úÖ ${t.acceptTermsBtn} (${worker.expectedSalary}/${
              isEn ? "wk" : "tyg"
            } + ${worker.bonusPercent}%)
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'counter_salary')" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
              üí∞ ${isEn ? "Propose different salary" : "Zaproponuj innƒÖ pensjƒô"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'counter_bonus')" style="padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer;">
              üìä ${
                isEn
                  ? "Propose different commission"
                  : "Zaproponuj innƒÖ prowizjƒô"
              }
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ‚ùå ${t.rejectBtn}
            </button>
          `;
          } else if (worker.negotiationState === "awaiting_salary") {
            inputDiv.style.display = "block";
            document.getElementById("businessChatInputField").placeholder = isEn
              ? "Enter weekly salary..."
              : "Wpisz tygodni√≥wkƒô...";
            document.getElementById("businessChatInputField").value = "";
            currentBusinessChat.awaitingInput = "salary_offer";

            optionsDiv.innerHTML = `
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'back')" style="padding: 10px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ‚Üê ${isEn ? "Back to options" : "Wr√≥ƒá do opcji"}
            </button>
          `;
          } else if (worker.negotiationState === "awaiting_bonus") {
            inputDiv.style.display = "block";
            document.getElementById("businessChatInputField").placeholder = isEn
              ? "Enter commission % (e.g. 5)..."
              : "Wpisz prowizjƒô % (np. 5)...";
            document.getElementById("businessChatInputField").value = "";
            currentBusinessChat.awaitingInput = "bonus_offer";

            optionsDiv.innerHTML = `
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'back')" style="padding: 10px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ‚Üê ${isEn ? "Back to options" : "Wr√≥ƒá do opcji"}
            </button>
          `;
          } else if (worker.negotiationState === "final_offer") {
            // Pracownik da≈Ç ostatecznƒÖ ofertƒô
            optionsDiv.innerHTML = `
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'accept_final')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ‚úÖ ${
                isEn ? "Accept final offer" : "Akceptuj ostatecznƒÖ ofertƒô"
              } (${worker.expectedSalary}/${isEn ? "wk" : "tyg"} + ${
              worker.bonusPercent
            }%)
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'counter_salary')" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
              üí∞ ${isEn ? "Try different salary" : "Spr√≥buj innƒÖ pensjƒô"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ‚ùå ${t.rejectBtn}
            </button>
          `;
          } else if (worker.negotiationState === "awaiting_offer") {
            // Kompatybilno≈õƒá wsteczna
            inputDiv.style.display = "block";
            document.getElementById("businessChatInputField").placeholder =
              t.enterSalaryPrompt;
            currentBusinessChat.awaitingInput = "salary_offer";
          }
        }

        function respondToWorker(businessIndex, workerId, response) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          if (response === "accept" || response === "accept_final") {
            worker.chatHistory.push({
              from: "player",
              text: t.acceptMsg
                .replace("{salary}", worker.expectedSalary)
                .replace("{currency}", getCurrency())
                .replace("{bonus}", worker.bonusPercent),
            });
            worker.chatHistory.push({
              from: "worker",
              text: t.workerAcceptMsg,
            });
            worker.chatHistory.push({ from: "player", text: t.startNowMsg });
            worker.chatHistory.push({
              from: "worker",
              text: t.workerThanksMsg,
            });

            worker.hired = true;
            worker.currentSalary = worker.expectedSalary;
            worker.negotiationState = "accepted";

            recalculateBusinessExpenses(businessIndex);
            saveBusinesses(businesses);
            saveState();

            showToast(`‚úÖ ${t.hired} ${worker.name}!`);
          } else if (response === "counter_salary") {
            worker.chatHistory.push({
              from: "player",
              text: isEn
                ? "I'd like to propose a different salary..."
                : "Chcia≈Çbym zaproponowaƒá innƒÖ pensjƒô...",
            });
            worker.negotiationState = "awaiting_salary";
            saveBusinesses(businesses);
          } else if (response === "counter_bonus") {
            worker.chatHistory.push({
              from: "player",
              text: isEn
                ? "Let's discuss the commission rate..."
                : "Porozmawiajmy o wysoko≈õci prowizji...",
            });
            worker.negotiationState = "awaiting_bonus";
            saveBusinesses(businesses);
          } else if (response === "back") {
            worker.negotiationState = "initial";
            saveBusinesses(businesses);
          } else if (response === "reject") {
            worker.chatHistory.push({ from: "player", text: t.rejectMsg });
            worker.chatHistory.push({
              from: "worker",
              text: t.workerUnderstandMsg,
            });
            worker.negotiationState = "rejected";

            // Usu≈Ñ kandydata
            business.workers = business.workers.filter(
              (w) => w.id !== workerId
            );
            saveBusinesses(businesses);

            setTimeout(() => {
              closeModal("businessChat");
              openModal("businessDetail");
              renderBusinessDetail(businessIndex);
            }, 1500);
          }

          continueWorkerNegotiation(businessIndex, workerId);
        }

        function sendBusinessChatInput() {
          const input = document.getElementById("businessChatInputField");
          const value = input.value.trim();
          if (!value) return;
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          const { businessId, targetId, awaitingInput } = currentBusinessChat;
          const businesses = getBusinesses();
          const business = businesses[businessId];
          const worker = business.workers.find((w) => w.id === targetId);
          if (!worker) return;

          if (awaitingInput === "salary_offer") {
            const offer = parseInt(value);
            if (isNaN(offer) || offer <= 0) {
              showToast(
                isEn ? "‚ùå Enter a valid amount!" : "‚ùå Wpisz prawid≈ÇowƒÖ kwotƒô!"
              );
              return;
            }

            worker.chatHistory.push({
              from: "player",
              text:
                (isEn ? "I propose " : "Proponujƒô ") +
                offer +
                " " +
                getCurrency() +
                (isEn ? " weekly." : " tygodniowo."),
            });

            // Reakcja pracownika
            if (offer >= worker.expectedSalary) {
              worker.chatHistory.push({
                from: "worker",
                text: t.workerGreatOffer,
              });
              worker.expectedSalary = offer;
              worker.hired = true;
              worker.currentSalary = offer;
              worker.negotiationState = "accepted";
              recalculateBusinessExpenses(businessId);
              saveBusinesses(businesses);
              saveState();
              showToast(`‚úÖ ${t.hired} ${worker.name}!`);
            } else if (offer >= worker.minSalary) {
              const diff = worker.expectedSalary - offer;
              if (diff < 50) {
                worker.chatHistory.push({
                  from: "worker",
                  text: t.workerAcceptLower,
                });
                worker.expectedSalary = offer;
                worker.hired = true;
                worker.currentSalary = offer;
                worker.negotiationState = "accepted";
                recalculateBusinessExpenses(businessId);
                saveBusinesses(businesses);
                saveState();
                showToast(`‚úÖ ${t.hired} ${worker.name}!`);
              } else {
                const counter = Math.floor((offer + worker.expectedSalary) / 2);
                worker.chatHistory.push({
                  from: "worker",
                  text: t.workerCounterOffer
                    .replace("{counter}", counter)
                    .replace("{currency}", getCurrency()),
                });
                worker.expectedSalary = counter;
                worker.negotiationState = "initial";
                saveBusinesses(businesses);
              }
            } else {
              worker.chatHistory.push({
                from: "worker",
                text: t.workerTooLow
                  .replace("{min}", worker.minSalary)
                  .replace("{currency}", getCurrency()),
              });
              worker.negotiationState = "initial";
              saveBusinesses(businesses);
            }

            input.value = "";
            currentBusinessChat.awaitingInput = null;
            continueWorkerNegotiation(businessId, targetId);
          } else if (awaitingInput === "bonus_offer") {
            const bonusOffer = parseInt(value);
            if (isNaN(bonusOffer) || bonusOffer < 0 || bonusOffer > 50) {
              showToast(
                isEn
                  ? "‚ùå Enter valid % (0-50)!"
                  : "‚ùå Wpisz poprawny % (0-50)!"
              );
              return;
            }

            worker.chatHistory.push({
              from: "player",
              text:
                (isEn ? "How about " : "Co powiesz na ") +
                bonusOffer +
                (isEn ? "% commission?" : "% prowizji?"),
            });

            // Reakcja pracownika na prowizjƒô
            const expectedBonus = worker.bonusPercent;
            if (bonusOffer >= expectedBonus) {
              worker.chatHistory.push({
                from: "worker",
                text: isEn ? "That works for me!" : "To mi odpowiada!",
              });
              worker.bonusPercent = bonusOffer;
              worker.negotiationState = "initial";
              saveBusinesses(businesses);
            } else if (bonusOffer >= expectedBonus * 0.5) {
              // Akceptuje je≈õli minimum po≈Çowa oczekiwanej
              const newSalary = Math.floor(
                worker.expectedSalary *
                  (1 + (expectedBonus - bonusOffer) * 0.02)
              );
              worker.chatHistory.push({
                from: "worker",
                text:
                  (isEn ? "I can accept " : "Mogƒô zaakceptowaƒá ") +
                  bonusOffer +
                  (isEn ? "%, but I'd need " : "%, ale potrzebowa≈Çbym ") +
                  newSalary +
                  " " +
                  getCurrency() +
                  (isEn ? " base salary then." : " podstawy wtedy."),
              });
              worker.bonusPercent = bonusOffer;
              worker.expectedSalary = newSalary;
              worker.negotiationState = "initial";
              saveBusinesses(businesses);
            } else {
              worker.chatHistory.push({
                from: "worker",
                text:
                  (isEn
                    ? "That's too low. I need at least "
                    : "To za ma≈Ço. Potrzebujƒô minimum ") +
                  Math.floor(expectedBonus * 0.7) +
                  "%.",
              });
              worker.negotiationState = "initial";
              saveBusinesses(businesses);
            }

            input.value = "";
            currentBusinessChat.awaitingInput = null;
            continueWorkerNegotiation(businessId, targetId);
          }
        }

        function talkToWorker(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker || !worker.hired) return;

          currentBusinessChat = {
            type: "worker_talk",
            businessId: businessIndex,
            targetId: workerId,
            awaitingInput: null,
          };

          closeModal("businessDetail");
          openModal("businessChat");

          document.getElementById(
            "businessChatTitle"
          ).textContent = `üí¨ Rozmowa z ${worker.name}`;

          const messagesDiv = document.getElementById("businessChatMessages");
          const optionsDiv = document.getElementById("businessChatOptions");

          const satisfaction = worker.satisfaction || 100;
          const satEmoji =
            satisfaction > 70 ? "üòä" : satisfaction > 40 ? "üòê" : "üòû";

          messagesDiv.innerHTML = `
          <div style="margin-bottom: 12px;">
            <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: #333;">
              ${satEmoji} Cze≈õƒá szefie! W czym mogƒô pom√≥c?
            </div>
          </div>
          <div style="margin-bottom: 12px;">
            <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: #333;">
              Moje obecne warunki: ${
                worker.currentSalary
              } ${getCurrency()}/tyg + ${worker.bonusPercent}% prowizji.
              <br>Satysfakcja: ${satisfaction}%
            </div>
          </div>
        `;

          optionsDiv.innerHTML = `
          <button onclick="giveRaise(${businessIndex}, '${workerId}')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
            üí∞ Daj podwy≈ºkƒô (+10%)
          </button>
          <button onclick="closeModal('businessChat'); openModal('businessDetail'); renderBusinessDetail(${businessIndex});" style="padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
            ‚Üê Wr√≥ƒá
          </button>
        `;
        }

        function giveRaise(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;

          worker.currentSalary = Math.floor(worker.currentSalary * 1.1);
          worker.satisfaction = Math.min(
            100,
            (worker.satisfaction || 100) + 15
          );

          recalculateBusinessExpenses(businessIndex);
          saveBusinesses(businesses);
          saveState();

          showToast(
            `üí∞ ${worker.name} dosta≈Ç podwy≈ºkƒô do ${worker.currentSalary}/tyg!`
          );
          closeModal("businessChat");
          openModal("businessDetail");
          renderBusinessDetail(businessIndex);
        }

        function fireWorker(businessIndex, workerId) {
          if (!confirm("Na pewno zwolniƒá tego pracownika?")) return;

          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          business.workers = business.workers.filter((w) => w.id !== workerId);

          recalculateBusinessExpenses(businessIndex);
          saveBusinesses(businesses);
          saveState();

          renderBusinessDetail(businessIndex);
          showToast(
            "üö´ " + (translations[currentLang] || translations.en).workerFired
          );
        }

        function recalculateBusinessExpenses(businessIndex) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];

          let weeklyExpenses = 0;
          business.workers
            .filter((w) => w.hired)
            .forEach((w) => {
              weeklyExpenses += w.currentSalary || 0;
            });

          business.weeklyExpenses = weeklyExpenses;
          saveBusinesses(businesses);
        }

        function simulateBusinessDay(businessIndex) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          const hiredWorkers = business.workers.filter((w) => w.hired);
          if (hiredWorkers.length === 0) {
            showToast("‚ùå " + t.needWorkers);
            return;
          }

          // Oblicz produktywno≈õƒá
          let totalProductivity = 0;
          hiredWorkers.forEach((w) => {
            totalProductivity += w.productivity || 1;
          });
          const avgProductivity = totalProductivity / hiredWorkers.length;

          // Symuluj klient√≥w
          const clientCount = Math.floor(
            business.clientsPerDay *
              avgProductivity *
              (0.7 + Math.random() * 0.6)
          );
          let dayIncome = 0;

          for (let i = 0; i < clientCount; i++) {
            const clientSpend = Math.floor(
              business.avgIncome * (0.5 + Math.random())
            );
            dayIncome += clientSpend;
          }

          // Oblicz prowizje dla pracownik√≥w
          let bonusesPaid = 0;
          const workerReports = [];
          hiredWorkers.forEach((w) => {
            const workerBonus = Math.floor(
              (dayIncome * (w.bonusPercent / 100)) / hiredWorkers.length
            );
            bonusesPaid += workerBonus;
            w.totalEarned = (w.totalEarned || 0) + workerBonus;
            w.daysWorked = (w.daysWorked || 0) + 1;
            workerReports.push({
              name: w.name,
              bonus: workerBonus,
              productivity: Math.round((w.productivity || 1) * 100),
            });
          });

          // RACHUNKI - zale≈ºne od wielko≈õci firmy
          const electricityCost = Math.floor(
            50 + business.clientsPerDay * 3 + Math.random() * 30
          );
          const waterCost = Math.floor(
            20 + business.clientsPerDay * 1.5 + Math.random() * 15
          );
          const gasCost = Math.floor(
            30 + business.clientsPerDay * 2 + Math.random() * 20
          );
          const internetCost = 50;
          const rentCost = Math.floor(business.startCost * 0.002); // 0.2% kosztu startu dziennie
          const totalBills =
            electricityCost + waterCost + gasCost + internetCost + rentCost;

          const netIncome = dayIncome - bonusesPaid - totalBills;
          business.weeklyIncome = (business.weeklyIncome || 0) + netIncome;
          business.totalIncome = (business.totalIncome || 0) + dayIncome;
          business.totalExpenses =
            (business.totalExpenses || 0) + totalBills + bonusesPaid;

          // Dodaj do pieniƒôdzy gracza
          money += netIncome;

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          // Poka≈º modal z paragonem
          showDayReport({
            businessName: business.name,
            clients: clientCount,
            income: dayIncome,
            workers: workerReports,
            bonusesPaid: bonusesPaid,
            bills: {
              electricity: electricityCost,
              water: waterCost,
              gas: gasCost,
              internet: internetCost,
              rent: rentCost,
              total: totalBills,
            },
            netIncome: netIncome,
            businessIndex: businessIndex,
          });
        }

        function showDayReport(report) {
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          // Stw√≥rz modal raportu
          let modal = document.getElementById("modalDayReport");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "modalDayReport";
            modal.className = "modal";
            modal.innerHTML = `<div class="modal-content" style="max-width: 400px;"><div id="dayReportContent"></div></div>`;
            document.body.appendChild(modal);
          }

          const content = document.getElementById("dayReportContent");
          content.innerHTML = `
          <div style="background: #1a1a2e; border-radius: 10px; padding: 20px; font-family: 'Courier New', monospace;">
            <div style="text-align: center; border-bottom: 2px dashed #444; padding-bottom: 15px; margin-bottom: 15px;">
              <div style="font-size: 1.5em; font-weight: bold;">üßæ ${
                isEn ? "DAILY REPORT" : "RAPORT DZIENNY"
              }</div>
              <div style="color: #888; margin-top: 5px;">${
                report.businessName
              }</div>
              <div style="color: #666; font-size: 0.85em;">${new Date().toLocaleDateString()}</div>
            </div>
            
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #4ade80; font-weight: bold; margin-bottom: 8px;">üìà ${
                isEn ? "INCOME" : "PRZYCH√ìD"
              }</div>
              <div style="display: flex; justify-content: space-between;">
                <span>üë• ${isEn ? "Clients" : "Klienci"}: ${
            report.clients
          }</span>
                <span style="color: #4ade80;">+${report.income.toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #f59e0b; font-weight: bold; margin-bottom: 8px;">üë∑ ${
                isEn ? "WORKERS" : "PRACOWNICY"
              }</div>
              ${report.workers
                .map(
                  (w) => `
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 3px;">
                  <span>${w.name} (${w.productivity}%)</span>
                  <span style="color: #ef4444;">-${
                    w.bonus
                  } ${getCurrency()}</span>
                </div>
              `
                )
                .join("")}
              <div style="display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold;">
                <span>${isEn ? "Commissions total" : "Prowizje razem"}:</span>
                <span style="color: #ef4444;">-${report.bonusesPaid.toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #ef4444; font-weight: bold; margin-bottom: 8px;">üìã ${
                isEn ? "BILLS" : "RACHUNKI"
              }</div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>‚ö° ${isEn ? "Electricity" : "PrƒÖd"}</span>
                <span>-${report.bills.electricity} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>üíß ${isEn ? "Water" : "Woda"}</span>
                <span>-${report.bills.water} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>üî• ${isEn ? "Gas" : "Gaz"}</span>
                <span>-${report.bills.gas} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>üåê Internet</span>
                <span>-${report.bills.internet} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>üè† ${isEn ? "Rent" : "Czynsz"}</span>
                <span>-${report.bills.rent} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold;">
                <span>${isEn ? "Bills total" : "Rachunki razem"}:</span>
                <span style="color: #ef4444;">-${report.bills.total.toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <div style="text-align: center; padding-top: 10px; border-top: 2px dashed #444;">
              <div style="font-size: 1.3em; font-weight: bold; color: ${
                report.netIncome >= 0 ? "#4ade80" : "#ef4444"
              };">
                ${isEn ? "NET PROFIT" : "ZYSK NETTO"}: ${
            report.netIncome >= 0 ? "+" : ""
          }${report.netIncome.toLocaleString()} ${getCurrency()}
              </div>
            </div>
            
            <button onclick="closeDayReport(${
              report.businessIndex
            })" style="width: 100%; padding: 15px; background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 1.1em;">
              ‚úÖ OK
            </button>
          </div>
        `;

          modal.style.display = "flex";
        }

        function closeDayReport(businessIndex) {
          const modal = document.getElementById("modalDayReport");
          if (modal) modal.style.display = "none";
          renderBusinessDetail(businessIndex);
        }

        function closeBusiness(businessIndex) {
          const t = translations[currentLang] || translations.en;
          if (
            !confirm(
              currentLang === "en"
                ? "Close this business? You won't recover the startup cost."
                : "Na pewno zamknƒÖƒá tƒô firmƒô? Nie odzyskasz koszt√≥w za≈Ço≈ºenia."
            )
          )
            return;

          const businesses = getBusinesses();
          businesses.splice(businessIndex, 1);
          saveBusinesses(businesses);
          saveState();

          closeModal("businessDetail");
          openModal("business");
          renderBusinessModal();
          showToast(
            "üóëÔ∏è " +
              (translations[currentLang] || translations.en).businessClosed
          );
        }

        function talkToClient(businessIndex, clientId) {
          // Implementacja obs≈Çugi klienta
          showToast("üí¨ System klient√≥w w budowie...");
        }

        // ==================== SYSTEM BANKU I KREDYT√ìW ====================

        function getCredits() {
          const save = getCurrentSave();
          if (!save.data.credits) save.data.credits = [];
          return save.data.credits;
        }

        function saveCredits(credits) {
          const save = getCurrentSave();
          save.data.credits = credits;
          saveState();
        }

        function renderBankModal() {
          const content = document.getElementById("bankContent");
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";
          const credits = getCredits();

          // Opcje kredyt√≥w
          const creditOptions = [
            { amount: 1000, interest: 5, months: 3 },
            { amount: 5000, interest: 8, months: 6 },
            { amount: 10000, interest: 10, months: 12 },
            { amount: 25000, interest: 12, months: 12 },
            { amount: 50000, interest: 15, months: 24 },
            { amount: 100000, interest: 18, months: 36 },
          ];

          content.innerHTML = `
          <div style="background: rgba(16,185,129,0.1); border: 1px solid #10b981; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #10b981; margin-bottom: 15px;">üí∞ ${
              t.takeCredit
            }</h3>
            <div style="max-height: 200px; overflow-y: auto;">
              ${creditOptions
                .map((opt, i) => {
                  const monthlyRate = Math.ceil(
                    (opt.amount * (1 + opt.interest / 100)) / opt.months
                  );
                  const total = monthlyRate * opt.months;
                  return `
                <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-size: 1.2em; font-weight: bold; color: #4ade80;">${opt.amount.toLocaleString()} ${getCurrency()}</div>
                      <div style="color: #888; font-size: 0.85em;">${
                        opt.interest
                      }% ‚Ä¢ ${opt.months} ${t.months}</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="color: #f59e0b;">${monthlyRate}/${
                    isEn ? "mo" : "msc"
                  }</div>
                      <button onclick="takeCredit(${opt.amount}, ${
                    opt.interest
                  }, ${
                    opt.months
                  })" style="padding: 8px 15px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px;">
                        ${t.takeCredit}
                      </button>
                    </div>
                  </div>
                </div>
              `;
                })
                .join("")}
            </div>
          </div>
          
          <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 15px; border-radius: 10px;">
            <h3 style="color: #ef4444; margin-bottom: 15px;">üìã ${
              t.yourCredits
            } (${credits.length})</h3>
            ${
              credits.length === 0
                ? `
              <p style="color: #666; text-align: center;">${t.noCredits}</p>
            `
                : `
              <div style="max-height: 250px; overflow-y: auto;">
                ${credits
                  .map((cr, i) => {
                    // Oblicz czas do nastƒôpnej raty lub termin p≈Çatno≈õci
                    const now = Date.now();
                    const MONTH_MS = 30 * 24 * 60 * 60 * 1000;
                    let statusHtml = "";

                    if (cr.rateDue && cr.rateDueDate) {
                      // Rata do zap≈Çaty!
                      const remaining = cr.rateDueDate - now;
                      if (remaining > 0) {
                        const days = Math.floor(
                          remaining / (24 * 60 * 60 * 1000)
                        );
                        const hours = Math.floor(
                          (remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000)
                        );
                        statusHtml =
                          '<div style="background: #ef4444; color: white; padding: 5px 10px; border-radius: 5px; margin-top: 8px; text-align: center; font-weight: bold;">‚ö†Ô∏è ' +
                          (isEn ? "PAY NOW! " : "ZAP≈ÅAƒÜ! ") +
                          days +
                          "d " +
                          hours +
                          "h " +
                          (isEn ? "left" : "zosta≈Ço") +
                          "</div>";
                      } else {
                        statusHtml =
                          '<div style="background: #dc2626; color: white; padding: 5px 10px; border-radius: 5px; margin-top: 8px; text-align: center; font-weight: bold;">üö® ' +
                          (isEn ? "OVERDUE!" : "PO TERMINIE!") +
                          "</div>";
                      }
                    } else {
                      // Czas do nastƒôpnej raty
                      const timeSince = now - (cr.lastPayment || cr.takenAt);
                      const timeToNext = MONTH_MS - timeSince;
                      if (timeToNext > 0) {
                        const days = Math.floor(
                          timeToNext / (24 * 60 * 60 * 1000)
                        );
                        statusHtml =
                          '<div style="color: #888; font-size: 0.8em; margin-top: 5px;">üìÖ ' +
                          (isEn
                            ? "Next installment in "
                            : "Nastƒôpna rata za ") +
                          days +
                          (isEn ? " days" : " dni") +
                          "</div>";
                      }
                    }

                    return `
                  <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; ${
                    cr.rateDue ? "border: 2px solid #ef4444;" : ""
                  } ${
                      (cr.missedPayments || 0) >= 2
                        ? "border: 2px solid #dc2626; box-shadow: 0 0 10px rgba(220,38,38,0.5);"
                        : ""
                    }">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-weight: bold;">${cr.originalAmount.toLocaleString()} ${getCurrency()}</div>
                        <div style="color: #888; font-size: 0.85em;">${
                          t.remaining
                        }: ${cr.remainingAmount.toLocaleString()} ${getCurrency()}</div>
                        <div style="color: #888; font-size: 0.85em;">${
                          cr.remainingMonths
                        } ${t.months} ‚Ä¢ ${cr.monthlyPayment}/${
                      isEn ? "mo" : "msc"
                    }</div>
                        ${
                          (cr.missedPayments || 0) > 0
                            ? '<div style="color: #ef4444; font-size: 0.85em; margin-top: 3px;">‚ö†Ô∏è ' +
                              (isEn ? "Warnings: " : "Ostrze≈ºenia: ") +
                              cr.missedPayments +
                              "/3</div>"
                            : ""
                        }
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button onclick="payCreditRate(${i})" style="padding: 6px 12px; background: ${
                      cr.rateDue ? "#ef4444" : "#f59e0b"
                    }; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                          ${t.payRate} (${cr.monthlyPayment})
                        </button>
                        <button onclick="payCreditOff(${i})" style="padding: 6px 12px; background: #333; color: white; border: 1px solid #666; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                          ${t.payOff} (${cr.remainingAmount})
                        </button>
                      </div>
                    </div>
                    ${statusHtml}
                    ${
                      (cr.missedPayments || 0) >= 2
                        ? '<div style="background: #dc2626; color: white; padding: 8px; border-radius: 5px; margin-top: 8px; text-align: center; font-weight: bold;">üöî ' +
                          (isEn
                            ? "DEBT COLLECTOR COMING SOON!"
                            : "WINDYKACJA JU≈ª NIED≈ÅUGO!") +
                          "</div>"
                        : ""
                    }
                  </div>
                `;
                  })
                  .join("")}
              </div>
            `
            }
          </div>
        `;
        }

        function takeCredit(amount, interest, months) {
          const t = translations[currentLang] || translations.en;
          const monthlyPayment = Math.ceil(
            (amount * (1 + interest / 100)) / months
          );
          const totalToRepay = monthlyPayment * months;

          const credit = {
            id: Date.now().toString(),
            originalAmount: amount,
            totalToRepay: totalToRepay,
            remainingAmount: totalToRepay,
            monthlyPayment: monthlyPayment,
            remainingMonths: months,
            interest: interest,
            takenAt: Date.now(),
            lastPayment: Date.now(),
          };

          const credits = getCredits();
          credits.push(credit);
          saveCredits(credits);

          money += amount;
          saveState();
          updateAllDisplays();
          renderBankModal();

          showToast(
            `‚úÖ ${t.creditTaken} +${amount.toLocaleString()} ${getCurrency()}`
          );
        }

        function payCreditRate(creditIndex) {
          const t = translations[currentLang] || translations.en;
          const credits = getCredits();
          const credit = credits[creditIndex];
          if (!credit) return;

          if (money < credit.monthlyPayment) {
            showToast(`‚ùå ${t.notEnoughForRate}`);
            return;
          }

          money -= credit.monthlyPayment;
          credit.remainingAmount -= credit.monthlyPayment;
          credit.remainingMonths--;
          credit.lastPayment = Date.now();
          credit.rateDue = false;
          credit.rateDueDate = null;

          if (credit.remainingMonths <= 0 || credit.remainingAmount <= 0) {
            credits.splice(creditIndex, 1);
            showToast(`üéâ ${t.creditPaidOff}`);
          } else {
            showToast(
              `‚úÖ ${t.ratePaid}: -${credit.monthlyPayment} ${getCurrency()}`
            );
          }

          saveCredits(credits);
          saveState();
          updateAllDisplays();
          renderBankModal();
        }

        function payCreditOff(creditIndex) {
          const t = translations[currentLang] || translations.en;
          const credits = getCredits();
          const credit = credits[creditIndex];
          if (!credit) return;

          if (money < credit.remainingAmount) {
            showToast(`‚ùå ${t.notEnoughForRate}`);
            return;
          }

          money -= credit.remainingAmount;
          credits.splice(creditIndex, 1);

          saveCredits(credits);
          saveState();
          updateAllDisplays();
          renderBankModal();

          showToast(`üéâ ${t.creditPaidOff}`);
        }

        // Automatyczne raty kredyt√≥w (co miesiƒÖc = 30 dni w grze)
        function processCreditPayments() {
          const credits = getCredits();
          const now = Date.now();
          const MONTH_MS = 30 * 24 * 60 * 60 * 1000; // 30 dni - cykl raty
          const GRACE_PERIOD_MS = 7 * 24 * 60 * 60 * 1000; // 7 dni na sp≈Çatƒô
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";
          let changed = false;

          credits.forEach((credit, i) => {
            const timeSincePayment =
              now - (credit.lastPayment || credit.takenAt);

            // Sprawd≈∫ czy minƒÖ≈Ç miesiƒÖc - czas na nowƒÖ ratƒô
            if (timeSincePayment >= MONTH_MS && !credit.rateDue) {
              credit.rateDue = true;
              credit.rateDueDate = now + GRACE_PERIOD_MS;
              credit.missedPayments = credit.missedPayments || 0;
              changed = true;
              showToast(
                `üí≥ ${
                  isEn ? "Loan installment due!" : "Rata kredytu do zap≈Çaty!"
                } ${credit.monthlyPayment} ${getCurrency()} (7 ${
                  isEn ? "days" : "dni"
                })`
              );
            }

            // Sprawd≈∫ czy minƒÖ≈Ç termin p≈Çatno≈õci raty
            if (credit.rateDue && now > credit.rateDueDate) {
              // Termin minƒÖ≈Ç - kara!
              credit.remainingAmount = Math.ceil(credit.remainingAmount * 1.05);
              credit.rateDue = false;
              credit.rateDueDate = null;
              credit.lastPayment = now;
              credit.missedPayments = (credit.missedPayments || 0) + 1;
              changed = true;

              // Konsekwencje za niesp≈Çacanie
              if (credit.missedPayments === 1) {
                showToast(
                  `‚ö†Ô∏è ${
                    isEn
                      ? "Missed payment! +5% penalty. Warning!"
                      : "Nieop≈Çacona rata! +5% kary. Ostrze≈ºenie!"
                  }`
                );
              } else if (credit.missedPayments === 2) {
                showToast(
                  `üö® ${
                    isEn
                      ? "2nd missed payment! Debt collector warning!"
                      : "Druga nieop≈Çacona rata! Ostrze≈ºenie od windykacji!"
                  }`
                );
              } else if (credit.missedPayments >= 3) {
                // Windykacja - zabierajƒÖ co majƒÖ
                showToast(
                  `üöî ${
                    isEn
                      ? "DEBT COLLECTOR! Seizing assets..."
                      : "WINDYKACJA! Zajmowanie majƒÖtku..."
                  }`
                );

                // Zabierz pieniƒÖdze
                const seized = Math.min(money, credit.monthlyPayment * 2);
                if (seized > 0) {
                  money -= seized;
                  credit.remainingAmount -= seized;
                  showToast(
                    `üí∏ ${
                      isEn ? "Seized" : "Zajƒôto"
                    }: ${seized} ${getCurrency()}`
                  );
                }

                // Zabierz samoch√≥d je≈õli jest
                const save = getCurrentSave();
                if (save.data.cars && save.data.cars.length > 0) {
                  const carValue = Math.floor(
                    (save.data.cars[0].price || 10000) * 0.3
                  );
                  credit.remainingAmount -= carValue;
                  showToast(
                    `üöó ${
                      isEn ? "Car seized! Value" : "Samoch√≥d zajƒôty! Warto≈õƒá"
                    }: ${carValue} ${getCurrency()}`
                  );
                  save.data.cars = [];
                  save.data.currentCar = null;
                }

                // Zamknij firmy je≈õli d≈Çug wciƒÖ≈º du≈ºy
                if (credit.remainingAmount > credit.monthlyPayment * 3) {
                  const businesses = getBusinesses();
                  if (businesses.length > 0) {
                    const biz = businesses[0];
                    const bizValue = Math.floor(biz.startCost * 0.2);
                    credit.remainingAmount -= bizValue;
                    businesses.splice(0, 1);
                    saveBusinesses(businesses);
                    showToast(
                      `üè¢ ${isEn ? "Business seized!" : "Firma zajƒôta!"} ${
                        biz.name
                      } (-${bizValue} ${getCurrency()})`
                    );
                  }
                }

                credit.missedPayments = 0; // Reset po windykacji
                saveState();
              }
            }
          });

          // Usu≈Ñ sp≈Çacone kredyty
          const activeCredits = credits.filter((c) => c.remainingAmount > 0);

          if (changed) {
            saveCredits(activeCredits);
            updateAllDisplays();
          }
        }

        // Uruchom sprawdzanie rat co minutƒô
        setInterval(processCreditPayments, 60000);

        // Cotygodniowe p≈Çatno≈õci pracownik√≥w
        function processBusinessWeeklyPayments() {
          const businesses = getBusinesses();
          const now = Date.now();
          const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          businesses.forEach((business, index) => {
            if (now - (business.lastPaymentTime || 0) >= WEEK_MS) {
              const hiredWorkers = business.workers.filter((w) => w.hired);
              let totalPayment = 0;

              hiredWorkers.forEach((w) => {
                totalPayment += w.currentSalary || 0;
              });

              if (totalPayment > 0) {
                if (money >= totalPayment) {
                  // Masz kasƒô - wyp≈Çaƒá wszystkim
                  money -= totalPayment;
                  business.totalExpenses =
                    (business.totalExpenses || 0) + totalPayment;
                  hiredWorkers.forEach((w) => {
                    w.satisfaction = Math.min(100, (w.satisfaction || 50) + 5);
                  });
                  showToast(
                    `üíº ${t.salariesIn} ${
                      business.name
                    }: -${totalPayment.toLocaleString()} ${getCurrency()}`
                  );
                } else {
                  // Brak kasy - pracownicy nie dostajƒÖ wyp≈Çaty!
                  hiredWorkers.forEach((w) => {
                    w.satisfaction = Math.max(0, (w.satisfaction || 50) - 25);
                    w.unpaidWeeks = (w.unpaidWeeks || 0) + 1;
                  });
                  business.reputation = Math.max(
                    0,
                    (business.reputation || 50) - 10
                  );

                  const needed = totalPayment - money;
                  showToast(
                    `‚ö†Ô∏è ${
                      isEn
                        ? "Can't pay salaries in"
                        : "Nie staƒá Ciƒô na wyp≈Çaty w"
                    } ${business.name}! ${
                      isEn ? "Need" : "Potrzebujesz"
                    }: ${needed.toLocaleString()} ${getCurrency()}`
                  );

                  // Sprawd≈∫ czy kto≈õ odchodzi z powodu braku wyp≈Çat
                  hiredWorkers.forEach((w) => {
                    if (w.unpaidWeeks >= 2 || w.satisfaction <= 10) {
                      // Pracownik odchodzi!
                      business.workers = business.workers.filter(
                        (worker) => worker.id !== w.id
                      );
                      showToast(
                        `üö™ ${w.name} ${
                          isEn
                            ? "quit due to unpaid wages!"
                            : "odszed≈Ç z powodu braku wyp≈Çat!"
                        }`
                      );
                    }
                  });
                }
              }

              business.lastPaymentTime = now;
              business.weeklyIncome = 0; // Reset tygodniowego przychodu
            }
          });

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();
        }

        // Dodaj obs≈Çugƒô modalu firm i banku do openModal
        const originalOpenModal = openModal;
        openModal = function (type) {
          originalOpenModal(type);
          if (type === "business") {
            renderBusinessModal();
          } else if (type === "bank") {
            renderBankModal();
          }
        };

        // Uruchom sprawdzanie p≈Çatno≈õci co minutƒô
        setInterval(processBusinessWeeklyPayments, 60000);

        // ==================== AUTOMATYCZNE DNI ROBOCZE ====================

        function processAutomaticBusinessDays() {
          const businesses = getBusinesses();
          const now = Date.now();
          const DAY_MS = 24 * 60 * 60 * 1000; // 24h rzeczywiste
          let anyProcessed = false;

          businesses.forEach((business, index) => {
            const lastDay = business.lastDayProcessed || now - DAY_MS - 1000; // Je≈õli nowa firma, przetw√≥rz od razu

            if (now - lastDay >= DAY_MS) {
              const hiredWorkers = business.workers.filter((w) => w.hired);

              if (hiredWorkers.length > 0) {
                // Przetw√≥rz dzie≈Ñ dla tej firmy
                processBusinessDayAuto(index);
                anyProcessed = true;
              }

              business.lastDayProcessed = now;
            }
          });

          if (anyProcessed) {
            saveBusinesses(businesses);
          }
        }

        function processBusinessDayAuto(businessIndex) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          const hiredWorkers = business.workers.filter((w) => w.hired);
          if (hiredWorkers.length === 0) return;

          // Oblicz produktywno≈õƒá
          let totalProductivity = 0;
          hiredWorkers.forEach((w) => {
            totalProductivity += w.productivity || 1;
          });
          const avgProductivity = totalProductivity / hiredWorkers.length;

          // Symuluj klient√≥w
          const clientCount = Math.floor(
            business.clientsPerDay *
              avgProductivity *
              (0.7 + Math.random() * 0.6)
          );
          let dayIncome = 0;

          for (let i = 0; i < clientCount; i++) {
            const clientSpend = Math.floor(
              business.avgIncome * (0.5 + Math.random())
            );
            dayIncome += clientSpend;
          }

          // Oblicz prowizje dla pracownik√≥w
          let bonusesPaid = 0;
          const workerReports = [];
          hiredWorkers.forEach((w) => {
            const workerBonus = Math.floor(
              (dayIncome * (w.bonusPercent / 100)) / hiredWorkers.length
            );
            bonusesPaid += workerBonus;
            w.totalEarned = (w.totalEarned || 0) + workerBonus;
            w.daysWorked = (w.daysWorked || 0) + 1;
            workerReports.push({
              name: w.name,
              bonus: workerBonus,
              productivity: Math.round((w.productivity || 1) * 100),
            });
          });

          // RACHUNKI
          const electricityCost = Math.floor(
            50 + business.clientsPerDay * 3 + Math.random() * 30
          );
          const waterCost = Math.floor(
            20 + business.clientsPerDay * 1.5 + Math.random() * 15
          );
          const gasCost = Math.floor(
            30 + business.clientsPerDay * 2 + Math.random() * 20
          );
          const internetCost = 50;
          const rentCost = Math.floor(business.startCost * 0.002);
          const totalBills =
            electricityCost + waterCost + gasCost + internetCost + rentCost;

          const netIncome = dayIncome - bonusesPaid - totalBills;
          business.weeklyIncome = (business.weeklyIncome || 0) + netIncome;
          business.totalIncome = (business.totalIncome || 0) + dayIncome;
          business.totalExpenses =
            (business.totalExpenses || 0) + totalBills + bonusesPaid;
          business.lastDayProcessed = Date.now();

          // Dodaj do pieniƒôdzy gracza
          money += netIncome;

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          // Poka≈º paragon
          showDayReport({
            businessName: business.name,
            clients: clientCount,
            income: dayIncome,
            workers: workerReports,
            bonusesPaid: bonusesPaid,
            bills: {
              electricity: electricityCost,
              water: waterCost,
              gas: gasCost,
              internet: internetCost,
              rent: rentCost,
              total: totalBills,
            },
            netIncome: netIncome,
            businessIndex: businessIndex,
          });
        }

        // Sprawdzaj dni co 30 sekund
        setInterval(processAutomaticBusinessDays, 30000);

        // ==================== AUTOMATYCZNE GENEROWANIE KANDYDAT√ìW ====================

        function autoGenerateCandidates() {
          const businesses = getBusinesses();
          const now = Date.now();
          const FIVE_MIN_MS = 5 * 60 * 1000; // 5 minut
          let anyGenerated = false;
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          businesses.forEach((business, index) => {
            const lastGen = business.lastCandidateGen || 0;

            if (now - lastGen >= FIVE_MIN_MS) {
              // Sprawd≈∫ ile jest kandydat√≥w (nie zatrudnionych)
              const candidates = business.workers.filter((w) => !w.hired);

              // Generuj nowych je≈õli mniej ni≈º 3 kandydat√≥w
              if (candidates.length < 3) {
                const positions = [
                  "manager",
                  "senior",
                  "regular",
                  "regular",
                  "junior",
                  "junior",
                  "intern",
                ];
                const toGenerate = 3 - candidates.length;

                for (let i = 0; i < toGenerate; i++) {
                  const pos =
                    positions[Math.floor(Math.random() * positions.length)];
                  business.workers.push(generateWorker(pos));
                }

                anyGenerated = true;
                showToast(
                  `üìã ${business.name}: ${
                    isEn
                      ? "New candidates available!"
                      : "Nowi kandydaci dostƒôpni!"
                  }`
                );
              }

              business.lastCandidateGen = now;
            }
          });

          if (anyGenerated) {
            saveBusinesses(businesses);
          }
        }

        // Sprawdzaj kandydat√≥w co minutƒô
        setInterval(autoGenerateCandidates, 60000);

        // Sprawd≈∫ od razu przy starcie (po 5 sekundach)
        setTimeout(autoGenerateCandidates, 5000);

        // Sprawd≈∫ od razu przy starcie
        setTimeout(processAutomaticBusinessDays, 2000);

        // START - sprawd≈∫ czy to strona weryfikatora
        if (!checkIfVerifier()) {
          init();
        }

        // T≈Çumaczenie ekranu blokady mobilnej
        function updateMobileBlockLanguage() {
          const isEn = currentLang === "en";
          const title = document.getElementById("mobileBlockTitle");
          const text = document.getElementById("mobileBlockText");

          if (title && text) {
            title.textContent = isEn
              ? "Game unavailable on mobile devices"
              : "Gra niedostƒôpna na urzƒÖdzeniach mobilnych";
            text.innerHTML = isEn
              ? "Due to the complexity of mechanics and interface, optimizing this game for mobile devices is not possible.<br><br>The game requires precise controls and a large screen, which are only available on desktop computers and laptops.<br><br>Please play on a computer! üñ•Ô∏è"
              : "Ze wzglƒôdu na z≈Ço≈ºono≈õƒá mechanik i interfejsu, optymalizacja tej gry na urzƒÖdzenia mobilne nie jest mo≈ºliwa.<br><br>Gra wymaga precyzyjnego sterowania i du≈ºego ekranu, kt√≥re sƒÖ dostƒôpne tylko na komputerach stacjonarnych i laptopach.<br><br>Zapraszamy do gry na komputerze! üñ•Ô∏è";
          }
        }

        // Wywo≈Çaj przy starcie
        updateMobileBlockLanguage();
      </script>
    </div>
    <!-- koniec gameContainer -->
  </body>
</html>
