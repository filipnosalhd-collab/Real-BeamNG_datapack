<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>BeamNG Drive - Datapack PL</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* Ekran blokady mobilnej */
      #mobileBlockScreen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        z-index: 99999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 30px;
        text-align: center;
      }

      #mobileBlockScreen .block-icon {
        font-size: 80px;
        margin-bottom: 30px;
      }

      #mobileBlockScreen h1 {
        color: #ef4444;
        font-size: 1.8em;
        margin-bottom: 20px;
      }

      #mobileBlockScreen p {
        color: #888;
        font-size: 1em;
        line-height: 1.6;
        max-width: 400px;
      }

      #mobileBlockScreen .desktop-icon {
        margin-top: 40px;
        font-size: 60px;
        opacity: 0.5;
      }

      /* Ukryj grÄ™ na mobile */
      @media (max-width: 768px), (hover: none) and (pointer: coarse) {
        #mobileBlockScreen {
          display: flex !important;
        }
        
        #gameContainer, .container, header, .btn-grid, .modal {
          display: none !important;
        }
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        min-height: 100vh;
        color: #fff;
        padding: 10px;
        transition: background 0.5s ease;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        padding: 20px;
        padding-top: 50px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 15px;
        margin-bottom: 15px;
        border: 2px solid #ff6b35;
        position: relative;
      }

      header h1 {
        font-size: clamp(1.5em, 5vw, 2.2em);
        color: #ff6b35;
        text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
      }

      header h2 {
        font-size: clamp(0.9em, 3vw, 1.1em);
        color: #ffd700;
      }

      .header-btns-left,
      .header-btns-right {
        position: absolute;
        top: 10px;
        display: flex;
        gap: 5px;
      }

      .header-btns-left {
        left: 10px;
      }

      .header-btns-right {
        right: 10px;
      }

      .lang-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #555;
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lang-btn:hover,
      .lang-btn:active {
        background: rgba(255, 255, 255, 0.2);
      }

      @media (max-width: 400px) {
        .lang-btn {
          padding: 6px 10px;
          font-size: 1em;
          min-width: 40px;
          min-height: 40px;
        }

        header {
          padding-top: 45px;
        }
      }

      .money-display {
        background: linear-gradient(145deg, #2d2d2d, #1a1a1a);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 15px;
        border: 2px solid #444;
      }

      .money-display h3 {
        color: #888;
        font-size: 0.9em;
        margin-bottom: 5px;
      }

      .money-amount {
        font-size: clamp(2em, 8vw, 3em);
        font-weight: bold;
        color: #4ade80;
        text-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
      }

      .money-amount.low {
        color: #f87171;
      }

      .debt-display {
        background: rgba(239, 68, 68, 0.2);
        border: 2px solid #ef4444;
        border-radius: 10px;
        padding: 10px;
        margin-top: 10px;
        display: none;
      }

      .debt-display.active {
        display: block;
      }

      .debt-display h4 {
        color: #ef4444;
        font-size: 0.9em;
      }

      .debt-amount {
        font-size: 1.5em;
        color: #ef4444;
        font-weight: bold;
      }

      .debt-deadline {
        font-size: 0.8em;
        color: #f87171;
      }

      .buttons-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 15px;
      }

      .btn {
        padding: 15px 10px;
        font-size: clamp(0.85em, 2.5vw, 1em);
        font-weight: bold;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn-icon {
        font-size: 1.8em;
      }

      .btn-instruction {
        background: linear-gradient(145deg, #3b82f6, #2563eb);
        color: white;
      }
      .btn-repair {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        color: white;
      }
      .btn-buy {
        background: linear-gradient(145deg, #10b981, #059669);
        color: white;
      }
      .btn-sell {
        background: linear-gradient(145deg, #ec4899, #db2777);
        color: white;
      }
      .btn-earn {
        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        color: white;
      }
      .btn-tax {
        background: linear-gradient(145deg, #ef4444, #dc2626);
        color: white;
      }
      .btn-card {
        background: linear-gradient(145deg, #06b6d4, #0891b2);
        color: white;
      }
      .btn-inventory {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        color: white;
      }
      .btn-shop {
        background: linear-gradient(145deg, #10b981, #059669);
        color: white;
      }
      .btn-insurance {
        background: linear-gradient(145deg, #ec4899, #db2777);
        color: white;
      }

      /* Paski statusu */
      .status-bars {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 12px 15px;
        margin-bottom: 15px;
      }

      .status-bar {
        margin: 8px 0;
      }

      .status-bar:first-child {
        margin-top: 0;
      }
      .status-bar:last-child {
        margin-bottom: 0;
      }

      .status-label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8em;
        margin-bottom: 4px;
        color: #ccc;
      }

      .status-track {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        height: 16px;
        overflow: hidden;
      }

      .status-fill {
        height: 100%;
        border-radius: 8px;
        transition: width 0.3s ease;
      }

      .status-fill.health {
        background: linear-gradient(90deg, #ef4444, #f87171);
      }
      .status-fill.food {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
      }
      .status-fill.water {
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
      }

      .status-value {
        font-size: 0.7em;
        color: #888;
        text-align: right;
        margin-top: 2px;
      }

      /* Sklep/Ekwipunek */
      .shop-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        max-height: 350px;
        overflow-y: auto;
        padding: 5px;
      }

      .shop-item {
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid #444;
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .shop-item:hover {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.15);
        transform: scale(1.02);
      }

      .shop-item .item-icon {
        font-size: 1.8em;
      }
      .shop-item .item-name {
        font-weight: bold;
        font-size: 0.85em;
        margin: 5px 0;
      }
      .shop-item .item-stats {
        font-size: 0.7em;
        color: #aaa;
        line-height: 1.3;
      }
      .shop-item .item-stats .positive {
        color: #4ade80;
      }
      .shop-item .item-stats .negative {
        color: #f87171;
      }
      .shop-item .item-price {
        margin-top: 6px;
        font-weight: bold;
        color: #ff6b35;
        font-size: 0.9em;
      }

      .inventory-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .inv-tab {
        flex: 1;
        padding: 10px 5px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        color: #888;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.85em;
        transition: all 0.2s;
      }

      .inv-tab.active {
        background: #ff6b35;
        color: white;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 10px;
        overflow-y: auto;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: linear-gradient(145deg, #2d2d2d, #1a1a1a);
        border-radius: 15px;
        padding: 20px;
        max-width: 450px;
        width: calc(100% - 20px);
        margin: 10px;
        border: 2px solid #ff6b35;
        max-height: 90vh;
        overflow-y: auto;
      }

      @media (max-width: 480px) {
        .modal-content {
          padding: 15px;
          border-radius: 12px;
        }
      }

      .modal-content h2 {
        color: #ff6b35;
        text-align: center;
        margin-bottom: 15px;
        font-size: clamp(1.3em, 4vw, 1.6em);
      }

      .modal-close {
        background: #ef4444;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-size: 1em;
        cursor: pointer;
        width: 100%;
        margin-top: 15px;
      }

      .instruction-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .instruction-section h3 {
        color: #ffd700;
        margin-bottom: 8px;
        font-size: 1em;
      }

      .instruction-section ul {
        list-style: none;
      }

      .instruction-section li {
        padding: 6px 0;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
      }

      .instruction-section li:last-child {
        border-bottom: none;
      }

      .price.earn {
        color: #4ade80;
        font-weight: bold;
      }
      .price.cost {
        color: #f87171;
        font-weight: bold;
      }

      .upload-section {
        text-align: center;
      }

      .upload-section > p {
        color: #aaa;
        margin-bottom: 10px;
        font-size: 0.9em;
      }

      .upload-area {
        border: 3px dashed #555;
        border-radius: 15px;
        padding: 25px 15px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s;
      }

      .upload-area:hover,
      .upload-area.dragover {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.1);
      }

      .upload-icon {
        font-size: 2.5em;
        margin-bottom: 5px;
      }

      .preview-image {
        max-width: 100%;
        max-height: 150px;
        border-radius: 10px;
        margin: 10px 0;
        object-fit: contain;
      }

      .ai-response {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        text-align: center;
        display: none;
      }

      .ai-response.active {
        display: block;
      }

      .ai-response .loader {
        width: 35px;
        height: 35px;
        border: 3px solid #333;
        border-top-color: #ff6b35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
        15% {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
        85% {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
      }

      .ai-response .result-icon {
        font-size: 2.5em;
        margin-bottom: 5px;
      }

      .ai-response .result-text {
        font-size: 1em;
        margin-bottom: 5px;
      }

      .ai-response .result-amount {
        font-size: 2em;
        font-weight: bold;
      }

      .ai-response .result-amount.cost {
        color: #f87171;
      }
      .ai-response .result-amount.earn {
        color: #4ade80;
      }

      .qr-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin: 15px 0;
        text-align: center;
      }

      .qr-section h4 {
        color: #1a1a2e;
        margin-bottom: 10px;
        font-size: 1em;
      }

      .qr-section p {
        color: #666;
        font-size: 0.85em;
        margin-bottom: 15px;
      }

      #qrcode,
      .qr-container {
        display: flex;
        justify-content: center;
        margin: 10px 0;
      }

      .qr-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
      }

      .qr-status.waiting {
        background: rgba(251, 191, 36, 0.2);
        color: #f59e0b;
      }

      .qr-status.success {
        background: rgba(74, 222, 128, 0.2);
        color: #22c55e;
      }

      .qr-status.rejected {
        background: rgba(248, 113, 113, 0.2);
        color: #ef4444;
      }

      .garage-item {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid #444;
        border-radius: 10px;
        padding: 12px;
        margin: 8px 0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .garage-item:hover {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.1);
      }

      .garage-item.selected {
        border-color: #4ade80;
        background: rgba(74, 222, 128, 0.1);
      }

      .garage-item .car-name {
        font-weight: bold;
        font-size: 1.1em;
      }

      .garage-item .car-price {
        color: #4ade80;
        font-size: 0.9em;
      }

      .verify-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
      }

      .verify-page img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 15px;
        margin: 20px 0;
        border: 3px solid #ff6b35;
      }

      .verify-page h2 {
        color: #ff6b35;
        margin-bottom: 10px;
      }

      .verify-page p {
        color: #aaa;
        margin-bottom: 20px;
        font-size: 1.1em;
      }

      .verify-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      .verify-btn {
        padding: 15px 40px;
        font-size: 1.2em;
        font-weight: bold;
        border: none;
        border-radius: 12px;
        cursor: pointer;
      }

      .verify-btn.yes {
        background: linear-gradient(145deg, #4ade80, #22c55e);
        color: white;
      }

      .verify-btn.no {
        background: linear-gradient(145deg, #f87171, #ef4444);
        color: white;
      }

      .verify-result {
        font-size: 3em;
        margin: 30px 0;
      }

      .confirm-btn {
        background: linear-gradient(145deg, #4ade80, #22c55e);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
        display: none;
      }

      .confirm-btn.active {
        display: block;
      }

      .confirm-btn.pay {
        background: linear-gradient(145deg, #f87171, #ef4444);
      }

      .beam-pay-card {
        width: 100%;
        aspect-ratio: 1.6;
        border-radius: 15px;
        background: linear-gradient(
          135deg,
          #1e40af,
          #3b82f6,
          #60a5fa,
          #3b82f6,
          #1e40af
        );
        background-size: 400% 400%;
        animation: cardShine 3s ease infinite;
        padding: 20px;
        position: relative;
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        overflow: hidden;
      }

      @keyframes cardShine {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      .card-logo {
        font-size: 1.2em;
        font-weight: bold;
        color: #fff;
      }

      .card-code {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: clamp(1.5em, 6vw, 2.2em);
        font-weight: bold;
        color: #fff;
        letter-spacing: 8px;
        font-family: "Courier New", monospace;
      }

      .card-balance {
        position: absolute;
        bottom: 15px;
        right: 20px;
        text-align: right;
      }

      .card-balance .label {
        font-size: 0.7em;
        color: rgba(255, 255, 255, 0.7);
      }

      .card-balance .amount {
        font-size: 1.2em;
        font-weight: bold;
        color: #fff;
      }

      .card-settings {
        margin-top: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 12px;
      }

      .card-settings h4 {
        color: #ffd700;
        margin-bottom: 10px;
        font-size: 0.95em;
      }

      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #333;
        font-size: 0.9em;
      }

      .setting-row:last-child {
        border-bottom: none;
      }

      .setting-label {
        color: #aaa;
      }
      .setting-value {
        font-weight: bold;
        color: #fff;
      }

      .limit-bar {
        width: 100%;
        height: 8px;
        background: #333;
        border-radius: 4px;
        margin-top: 8px;
        overflow: hidden;
      }

      .limit-fill {
        height: 100%;
        background: linear-gradient(90deg, #4ade80, #fbbf24, #ef4444);
        transition: width 0.3s;
      }

      .card-btn {
        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.85em;
        cursor: pointer;
        margin-top: 8px;
        width: 100%;
      }

      .tax-info {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid #ef4444;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .tax-info h4 {
        color: #ef4444;
        margin-bottom: 10px;
      }

      .tax-stat {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 0.9em;
      }

      .tax-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
        border-radius: 10px;
        margin: 10px 0;
      }

      .toggle-switch {
        width: 50px;
        height: 26px;
        background: #333;
        border-radius: 13px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
      }

      .toggle-switch.active {
        background: #4ade80;
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        width: 22px;
        height: 22px;
        background: #fff;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }

      .toggle-switch.active::after {
        transform: translateX(24px);
      }

      .pin-display {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 15px 0;
      }

      .pin-digit {
        width: 40px;
        height: 50px;
        background: #1a1a1a;
        border: 2px solid #444;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: bold;
        color: #fff;
      }

      .pin-digit.filled {
        border-color: #4ade80;
      }

      .pin-keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        max-width: 220px;
        margin: 0 auto;
      }

      .pin-key {
        padding: 12px;
        font-size: 1.3em;
        border: none;
        border-radius: 8px;
        background: #333;
        color: #fff;
        cursor: pointer;
      }

      .pin-key:active {
        transform: scale(0.95);
      }

      .pin-key.delete {
        background: #ef4444;
      }
      .pin-key.confirm {
        background: #4ade80;
      }

      .lang-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        max-height: 400px;
        overflow-y: auto;
      }

      .lang-option {
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #333;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        font-size: 0.85em;
        transition: all 0.2s;
      }

      .lang-option:hover,
      .lang-option.selected {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.2);
      }

      .input-group {
        margin: 10px 0;
      }

      .input-group label {
        display: block;
        color: #aaa;
        margin-bottom: 5px;
        font-size: 0.9em;
      }

      .input-group input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #444;
        background: #1a1a1a;
        color: #fff;
        font-size: 1.1em;
        text-align: center;
      }

      .input-group input:focus {
        outline: none;
        border-color: #ff6b35;
      }

      .ocr-progress {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        height: 6px;
        margin-top: 10px;
        overflow: hidden;
      }

      .ocr-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ff6b35, #ffd700);
        width: 0%;
        transition: width 0.3s;
      }

      @media (max-width: 400px) {
        .buttons-grid {
          gap: 8px;
        }

        .btn {
          padding: 12px 8px;
        }

        .btn-icon {
          font-size: 1.5em;
        }

        .pin-digit {
          width: 35px;
          height: 45px;
          font-size: 1.3em;
        }

        .pin-keypad {
          max-width: 180px;
        }

        .pin-key {
          padding: 10px;
          font-size: 1.1em;
        }
      }
    </style>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <!-- Ekran blokady dla urzÄ…dzeÅ„ mobilnych -->
    <div id="mobileBlockScreen">
      <div class="block-icon">ğŸ“µ</div>
      <h1 id="mobileBlockTitle">Gra niedostÄ™pna na urzÄ…dzeniach mobilnych</h1>
      <p id="mobileBlockText">
        Ze wzglÄ™du na zÅ‚oÅ¼onoÅ›Ä‡ mechanik i interfejsu, optymalizacja tej gry na urzÄ…dzenia mobilne nie jest moÅ¼liwa.
        <br><br>
        Gra wymaga precyzyjnego sterowania i duÅ¼ego ekranu, ktÃ³re sÄ… dostÄ™pne tylko na komputerach stacjonarnych i laptopach.
        <br><br>
        Zapraszamy do gry na komputerze! ğŸ–¥ï¸
      </p>
      <div class="desktop-icon">ğŸ’»</div>
    </div>

    <div id="gameContainer">
    <div class="container">
      <header>
        <div class="header-btns-left">
          <button class="lang-btn" onclick="openModal('saves')" title="Save'y">
            ğŸ’¾
          </button>
          <button class="lang-btn" onclick="openModal('vouchers')" title="Bony">
            ğŸ
          </button>
        </div>
        <div class="header-btns-right">
          <button
            class="lang-btn"
            onclick="openModal('notifications')"
            title="Powiadomienia"
            style="position: relative"
          >
            ğŸ””
            <span
              id="notificationBadge"
              style="
                display: none;
                position: absolute;
                top: -5px;
                right: -5px;
                background: #ef4444;
                color: white;
                font-size: 0.6em;
                padding: 2px 5px;
                border-radius: 10px;
                min-width: 15px;
                text-align: center;
              "
              >0</span
            >
          </button>
          <button
            class="lang-btn"
            onclick="openModal('onlineAccount')"
            title="Konto online"
            id="onlineAccountBtn"
          >
            ğŸ‘¤
          </button>
          <button
            class="lang-btn"
            onclick="openModal('language')"
            title="JÄ™zyk"
          >
            ğŸŒ
          </button>
        </div>
        <div onclick="openModal('gameMode')" style="cursor: pointer">
          <h1 id="gameModeTitle">ğŸš— BeamNG Drive</h1>
          <h2 id="gameModeSubtitle">Datapack</h2>
        </div>
        <div
          id="currentSaveDisplay"
          style="font-size: 0.8em; color: #888; margin-top: 5px"
        ></div>
      </header>

      <div class="money-display">
        <h3>ğŸ’° <span data-translate="yourMoney">TWOJE PIENIÄ„DZE</span></h3>
        <div class="money-amount" id="moneyDisplay">50 000 zÅ‚</div>

        <div class="debt-display" id="debtDisplay">
          <h4>âš ï¸ <span data-translate="debt">DÅUG</span></h4>
          <div class="debt-amount" id="debtAmount">0 zÅ‚</div>
          <div class="debt-deadline" id="debtDeadline"></div>
        </div>
      </div>

      <!-- Paski statusu -->
      <div class="status-bars">
        <div class="status-bar">
          <div class="status-label">
            â¤ï¸ <span data-translate="health">Zdrowie</span>
          </div>
          <div class="status-track">
            <div
              class="status-fill health"
              id="healthBar"
              style="width: 100%"
            ></div>
          </div>
          <div class="status-value" id="healthValue">100/100</div>
        </div>
        <div class="status-bar">
          <div class="status-label">
            ğŸ” <span data-translate="food">Jedzenie</span>
          </div>
          <div class="status-track">
            <div
              class="status-fill food"
              id="foodBar"
              style="width: 100%"
            ></div>
          </div>
          <div class="status-value" id="foodValue">1000/1000 kcal</div>
        </div>
        <div class="status-bar">
          <div class="status-label">
            ğŸ’§ <span data-translate="water">Picie</span>
          </div>
          <div class="status-track">
            <div
              class="status-fill water"
              id="waterBar"
              style="width: 100%"
            ></div>
          </div>
          <div class="status-value" id="waterValue">1000/1000 ml</div>
        </div>
      </div>

      <div class="buttons-grid">
        <button class="btn btn-instruction" onclick="openModal('instruction')">
          <span class="btn-icon">ğŸ“–</span>
          <span data-translate="instructions">Instrukcja</span>
        </button>
        <button class="btn btn-earn" onclick="openModal('work')">
          <span class="btn-icon">ğŸ’¼</span>
          <span data-translate="work">Praca</span>
        </button>
        <button class="btn btn-repair" onclick="openModal('repair')">
          <span class="btn-icon">ğŸ”§</span>
          <span data-translate="repair">Napraw Auto</span>
        </button>
        <button class="btn btn-buy" onclick="openModal('buy')">
          <span class="btn-icon">ğŸš™</span>
          <span data-translate="buyCar">Kup Auto</span>
        </button>
        <button class="btn btn-sell" onclick="openModal('sell')">
          <span class="btn-icon">ğŸ’¸</span>
          <span data-translate="sellCar">Sprzedaj Auto</span>
        </button>
        <button class="btn btn-shop" onclick="openModal('shop')">
          <span class="btn-icon">ğŸ›’</span>
          <span data-translate="shop">Sklep</span>
        </button>
        <button class="btn btn-inventory" onclick="openModal('inventory')">
          <span class="btn-icon">ğŸ’</span>
          <span data-translate="inventory">Ekwipunek</span>
        </button>
        <button
          class="btn"
          onclick="openModal('garage')"
          style="background: linear-gradient(145deg, #6366f1, #4f46e5)"
        >
          <span class="btn-icon">ğŸš—</span>
          <span data-translate="garage">GaraÅ¼</span>
        </button>
        <button class="btn btn-insurance" onclick="openModal('insurance')">
          <span class="btn-icon">ğŸ¥</span>
          <span data-translate="insurance">Ubezpieczenia</span>
        </button>
        <button class="btn" onclick="openModal('business')" style="background: linear-gradient(145deg, #f59e0b, #d97706)">
          <span class="btn-icon">ğŸ¢</span>
          <span data-translate="business">Firmy</span>
        </button>
        <button class="btn" onclick="openModal('bank')" style="background: linear-gradient(145deg, #10b981, #059669)">
          <span class="btn-icon">ğŸ¦</span>
          <span data-translate="bank">Bank</span>
        </button>
        <button class="btn btn-tax" onclick="openModal('tax')">
          <span class="btn-icon">ğŸ›ï¸</span>
          <span data-translate="taxes">Podatki</span>
        </button>
        <button class="btn btn-card" onclick="openModal('card')">
          <span class="btn-icon">ğŸ’³</span>
          <span data-translate="card">Karta Beam-Pay</span>
        </button>
      </div>
    </div>

    <!-- Modal Instrukcja -->
    <div class="modal" id="modalInstruction">
      <div class="modal-content">
        <h2>ğŸ“– <span data-translate="instructions">Instrukcja</span></h2>

        <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px">
          <div class="instruction-section">
            <h3>ğŸ’¼ <span data-translate="workSystem">System pracy</span></h3>
            <p
              style="color: #aaa; font-size: 0.9em; margin-bottom: 10px"
              data-translate="workDesc"
            >
              Wybierz zawÃ³d i pracuj 2 minuty w mini-grze:
            </p>
            <ul style="list-style: none; padding: 0">
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 4px;
                  "
                >
                  <span>ğŸ§¹ SprzÄ…tacz â†’ ğŸ‘¨â€âš•ï¸ Chirurg</span>
                  <span style="color: #4ade80">500 - 7000 zÅ‚</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="jobsRange"
                  >13 zawodÃ³w od Å‚atwych do trudnych</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div style="color: #f59e0b; margin-bottom: 4px">
                  ğŸ’° <span data-translate="coinGame">Åapanie monet</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="coinGameDesc"
                  >Klikaj spadajÄ…ce monety +100 zÅ‚ za kaÅ¼dÄ…!</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div style="color: #ef4444; margin-bottom: 4px">
                  ğŸ˜´ <span data-translate="sleepMechanic">Zasypianie</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="sleepMechanicDesc"
                  >Trzymaj ekran Å¼eby nie zasnÄ…Ä‡! Spanie = strata do 90%
                  zarobku</span
                >
              </li>
            </ul>
          </div>

          <div class="instruction-section">
            <h3>ğŸš— <span data-translate="garageSystem">System garaÅ¼u</span></h3>
            <p
              style="color: #aaa; font-size: 0.9em; margin-bottom: 10px"
              data-translate="garageDesc"
            >
              Kupuj, ulepszaj i sprzedawaj auta:
            </p>
            <ul style="list-style: none; padding: 0">
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div style="color: #6366f1; margin-bottom: 4px">
                  â¬†ï¸ <span data-translate="upgrading">Ulepszanie</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="upgradeInfo"
                  >Kliknij raz - auto ulepsza siÄ™ w tle. WartoÅ›Ä‡ roÅ›nie (50% â†’
                  1000%)</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div style="color: #ef4444; margin-bottom: 4px">
                  ğŸ’¥ <span data-translate="breakRisk">Ryzyko zepsucia</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="breakInfo"
                  >0.5%/s szansy na zepsucie. Koszt: 150 zÅ‚ + -5% wartoÅ›ci</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div style="color: #10b981; margin-bottom: 4px">
                  ğŸ’° <span data-translate="selling">SprzedaÅ¼</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="sellInfo"
                  >Cena = cena bazowa Ã— procent ulepszenia</span
                >
              </li>
            </ul>
          </div>

          <div class="instruction-section">
            <h3>
              ğŸ’³ <span data-translate="payments">PÅ‚atnoÅ›ci i opÅ‚aty</span>
            </h3>
            <ul style="list-style: none; padding: 0">
              <li
                style="
                  padding: 8px;
                  background: rgba(239, 68, 68, 0.1);
                  border-radius: 8px;
                  margin-bottom: 6px;
                  display: flex;
                  justify-content: space-between;
                  border: 1px solid #ef4444;
                "
              >
                <span>ğŸ›ï¸ <span data-translate="taxes">Podatki</span></span>
                <span style="color: #ef4444">-500 zÅ‚ / 5 min</span>
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div style="color: #f59e0b; margin-bottom: 4px">
                  âš¡ <span data-translate="autoPay">Auto-pÅ‚atnoÅ›Ä‡</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="autoPayInfo2"
                  >WÅ‚Ä…cz w ustawieniach karty - automatycznie pÅ‚aci podatki i
                  ubezpieczenia</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div style="color: #ef4444; margin-bottom: 4px">
                  âš ï¸ <span data-translate="debtSystem">System dÅ‚ugÃ³w</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="debtInfo2"
                  >Brak kasy = dÅ‚ug. Masz 7 dni na spÅ‚atÄ™!</span
                >
              </li>
            </ul>
          </div>

          <div class="instruction-section">
            <h3>ğŸ›¡ï¸ <span data-translate="insurances">Ubezpieczenia</span></h3>
            <p
              style="color: #aaa; font-size: 0.9em; margin-bottom: 10px"
              data-translate="insuranceDesc"
            >
              RÃ³Å¼ne pakiety dajÄ…ce bonusy:
            </p>
            <ul style="list-style: none; padding: 0">
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <span style="color: #4ade80">â¤ï¸ğŸ”ğŸ’§</span>
                <span data-translate="healthIns">Zdrowotne</span> -
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="healthInsDesc"
                  >regeneracja HP, jedzenia, picia</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <span style="color: #6366f1">ğŸ”§âš™ï¸</span>
                <span data-translate="upgradeIns">Na ulepszanie</span> -
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="upgradeInsDesc"
                  >szybsze ulepszanie, mniejsza szansa zepsucia</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <span style="color: #f59e0b">ğŸ›¡ï¸ğŸ©¹</span>
                <span data-translate="repairIns">Na naprawÄ™</span> -
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="repairInsDesc"
                  >pokrywa 30-100% kosztÃ³w naprawy</span
                >
              </li>
            </ul>
          </div>

          <div class="instruction-section">
            <h3>â¤ï¸ <span data-translate="survival">Przetrwanie</span></h3>
            <ul style="list-style: none; padding: 0">
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <span style="color: #ef4444"
                  >ğŸ” <span data-translate="hungerDrain">GÅ‚Ã³d</span>:</span
                >
                <span style="color: #888; font-size: 0.85em"
                  >-10 kcal / 5 min</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <span style="color: #3b82f6"
                  >ğŸ’§
                  <span data-translate="thirstDrain">Pragnienie</span>:</span
                >
                <span style="color: #888; font-size: 0.85em"
                  >-15 ml / 5 min</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(239, 68, 68, 0.2);
                  border-radius: 8px;
                  margin-bottom: 6px;
                  border: 1px solid #ef4444;
                "
              >
                <div style="color: #ef4444; margin-bottom: 4px">
                  ğŸ’€ <span data-translate="death">ÅšmierÄ‡</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="deathDesc"
                  >GÅ‚Ã³d/woda = 0 â†’ tracisz HP. HP = 0 â†’ zginiesz i wrÃ³cisz do
                  checkpointu!</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="survivalTip"
                  >Kupuj jedzenie i napoje w sklepie, lub wykup
                  ubezpieczenie!</span
                >
              </li>
            </ul>
          </div>

          <div class="instruction-section">
            <h3>
              ğŸ’¾
              <span data-translate="checkpointSystem">System checkpointÃ³w</span>
            </h3>
            <ul style="list-style: none; padding: 0">
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div style="color: #10b981; margin-bottom: 4px">
                  ğŸ’¾
                  <span data-translate="createCheckpointInfo">Tworzenie</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="createCheckpointDesc"
                  >W menu Save'Ã³w kliknij "Zapisz checkpoint" Å¼eby zapisaÄ‡
                  aktualny postÄ™p</span
                >
              </li>
              <li
                style="
                  padding: 8px;
                  background: rgba(0, 0, 0, 0.3);
                  border-radius: 8px;
                  margin-bottom: 6px;
                "
              >
                <div style="color: #f59e0b; margin-bottom: 4px">
                  ğŸ”„ <span data-translate="respawn">Odrodzenie</span>
                </div>
                <span
                  style="color: #888; font-size: 0.85em"
                  data-translate="respawnDesc"
                  >Po Å›mierci wrÃ³cisz do checkpointu. Brak checkpointu = reset
                  postÄ™pu!</span
                >
              </li>
            </ul>
          </div>

          <div class="instruction-section">
            <h3>ğŸ <span data-translate="voucherSystem">System bonÃ³w</span></h3>
            <p
              style="color: #aaa; font-size: 0.9em"
              data-translate="voucherDesc"
            >
              TwÃ³rz bony pieniÄ™Å¼ne i wysyÅ‚aj znajomym przez WhatsApp, Messenger,
              Email lub SMS. PieniÄ…dze pobierane sÄ… dopiero gdy odbiorca
              zaakceptuje bon.
            </p>
          </div>

          <div class="instruction-section">
            <h3>ğŸ® <span data-translate="gameModes">Tryby gry</span></h3>
            <p
              style="color: #aaa; font-size: 0.9em"
              data-translate="gameModesDesc"
            >
              Kliknij tytuÅ‚ gry aby przeÅ‚Ä…czyÄ‡ miÄ™dzy trybem BeamNG (fikcyjne
              auta) a Real Life (prawdziwe marki). KaÅ¼dy tryb ma osobny postÄ™p!
            </p>
          </div>
        </div>

        <button
          class="modal-close"
          onclick="closeModal('instruction')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Zarobek -->
    <div class="modal" id="modalEarn">
      <div class="modal-content">
        <h2>ğŸ›£ï¸ <span data-translate="earnKm">Zarobek za kilometry</span></h2>

        <div class="upload-section">
          <div class="ai-response active" id="earnResponse">
            <div class="result-icon">ğŸ›£ï¸</div>
            <div class="result-text" data-translate="enterKm">
              Wpisz przejechane kilometry:
            </div>
            <input
              type="number"
              id="kmInput"
              step="0.1"
              min="0.1"
              style="
                width: 120px;
                padding: 12px;
                font-size: 1.2em;
                border-radius: 8px;
                border: 2px solid #ff6b35;
                text-align: center;
                margin: 10px 0;
                background: #1a1a2e;
                color: white;
              "
              placeholder="km"
            />
            <div style="color: #888; font-size: 0.9em">
              Ã— 100 zÅ‚ = <span id="kmCalc" style="color: #4ade80">0</span> zÅ‚
            </div>
          </div>

          <button class="confirm-btn" id="earnBtn" onclick="confirmEarn()">
            ğŸ’° <span data-translate="collectEarnings">Odbierz zarobek</span>
          </button>
        </div>

        <button
          class="modal-close"
          onclick="closeModal('earn')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Naprawa -->
    <div class="modal" id="modalRepair">
      <div class="modal-content">
        <h2>ğŸ”§ <span data-translate="repair">Napraw Auto</span></h2>

        <div class="upload-section">
          <p>
            <span data-translate="selectCarToRepair"
              >Wybierz auto do naprawy:</span
            >
          </p>

          <div
            id="repairCarList"
            style="max-height: 300px; overflow-y: auto; margin-bottom: 15px"
          ></div>

          <div class="ai-response" id="repairResponse" style="display: none">
            <div class="result-icon">ğŸ”§</div>
            <div class="result-text" data-translate="repairCostInfo">
              Koszt naprawy:
            </div>
            <div class="result-amount cost" id="repairCostDisplay">
              -5,000 zÅ‚
            </div>
          </div>

          <button
            class="confirm-btn pay"
            id="repairBtn"
            onclick="confirmRepair()"
            style="display: none"
          >
            ğŸ”§ <span data-translate="payAndRepair">ZapÅ‚aÄ‡ i napraw</span>
          </button>
        </div>

        <button
          class="modal-close"
          onclick="closeModal('repair')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Kup Auto -->
    <div class="modal" id="modalBuy">
      <div class="modal-content">
        <h2>ğŸš™ <span data-translate="buyCar">Kup Auto</span></h2>

        <!-- Wyszukiwarka -->
        <input
          type="text"
          id="carSearchInput"
          placeholder="ğŸ” Szukaj auta..."
          style="
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border-radius: 10px;
            border: 2px solid #444;
            background: #1a1a2e;
            color: white;
            margin-bottom: 15px;
          "
          oninput="filterCars()"
        />

        <!-- Lista aut -->
        <div class="shop-grid" id="carBuyGrid" style="max-height: 400px"></div>

        <button
          class="modal-close"
          onclick="closeModal('buy')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Sprzedaj Auto -->
    <div class="modal" id="modalSell">
      <div class="modal-content">
        <h2>ğŸ’¸ <span data-translate="sellCar">Sprzedaj Auto</span></h2>

        <p
          style="color: #888; text-align: center; margin-bottom: 15px"
          data-translate="get50percent"
        >
          Dostaniesz 50% wartoÅ›ci
        </p>

        <div id="sellGarageSection">
          <div
            id="sellGarageList"
            style="max-height: 350px; overflow-y: auto"
          ></div>
        </div>

        <div
          id="sellEmptyGarage"
          style="text-align: center; padding: 30px; color: #888; display: none"
        >
          <div style="font-size: 3em">ğŸ…¿ï¸</div>
          <p data-translate="noCarInGarage">Nie masz Å¼adnych aut w garaÅ¼u</p>
        </div>

        <button
          class="modal-close"
          onclick="closeModal('sell')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Sklep -->
    <div class="modal" id="modalShop">
      <div class="modal-content">
        <h2>ğŸ›’ <span data-translate="shop">Sklep</span></h2>

        <!-- ZakÅ‚adki -->
        <div class="inventory-tabs">
          <button class="inv-tab active" onclick="showShopTab('food')">
            ğŸ” <span data-translate="foodTab">Jedzenie</span>
          </button>
          <button class="inv-tab" onclick="showShopTab('drinks')">
            ğŸ¥¤ <span data-translate="drinksTab">Napoje</span>
          </button>
        </div>

        <!-- Produkty do kupienia -->
        <div class="shop-grid" id="shopGrid"></div>

        <button
          class="modal-close"
          onclick="closeModal('shop')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Ekwipunek (Plecak) -->
    <!-- Modal GaraÅ¼ -->
    <div class="modal" id="modalGarage">
      <div class="modal-content">
        <h2>ğŸš— <span data-translate="garage">GaraÅ¼</span></h2>

        <div
          id="garageEmpty"
          style="text-align: center; padding: 30px; color: #888; display: none"
        >
          <div style="font-size: 3em">ğŸš—</div>
          <p data-translate="noCarInGarage">Brak aut w garaÅ¼u</p>
          <p
            style="font-size: 0.85em; margin-top: 5px"
            data-translate="buyCarFirst"
          >
            Kup auto w salonie!
          </p>
        </div>

        <div id="garageList" style="max-height: 60vh; overflow-y: auto"></div>

        <button
          class="modal-close"
          onclick="closeModal('garage')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Ulepszanie Auta -->
    <div class="modal" id="modalUpgrade">
      <div class="modal-content">
        <h2>ğŸ”§ <span data-translate="upgradeCar">Ulepszanie</span></h2>

        <div
          id="upgradeCarInfo"
          style="text-align: center; margin-bottom: 15px"
        ></div>

        <div
          style="
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 10px;
            "
          >
            <span data-translate="sellValue">WartoÅ›Ä‡ sprzedaÅ¼y:</span>
            <span
              id="upgradeSellPercent"
              style="color: #4ade80; font-weight: bold"
              >50%</span
            >
          </div>
          <div
            style="
              width: 100%;
              height: 20px;
              background: #333;
              border-radius: 10px;
              overflow: hidden;
            "
          >
            <div
              id="upgradeProgressBar"
              style="
                width: 5%;
                height: 100%;
                background: linear-gradient(90deg, #ef4444, #f59e0b, #4ade80);
                transition: width 0.1s;
              "
            ></div>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              font-size: 0.8em;
              color: #888;
              margin-top: 5px;
            "
          >
            <span>50%</span>
            <span>1000%</span>
          </div>
        </div>

        <div
          id="upgradeStatus"
          style="
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
          "
        ></div>

        <button
          id="upgradeBtn"
          onclick="toggleUpgrade()"
          style="
            width: 100%;
            padding: 15px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-bottom: 10px;
          "
        >
          â–¶ï¸ <span data-translate="startUpgrade">Rozpocznij ulepszanie</span>
        </button>

        <div
          style="
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
          "
        >
          <p style="font-size: 0.85em; color: #ef4444; text-align: center">
            âš ï¸
            <span data-translate="upgradeWarning"
              >Podczas ulepszania auto moÅ¼e siÄ™ zepsuÄ‡! (150 zÅ‚ + -5%)</span
            >
          </p>
        </div>

        <button
          class="modal-close"
          onclick="closeUpgradeModal()"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Praca -->
    <div class="modal" id="modalWork">
      <div class="modal-content">
        <h2>ğŸ’¼ <span data-translate="work">Praca</span></h2>

        <p
          style="color: #888; text-align: center; margin-bottom: 15px"
          data-translate="chooseJob"
        >
          Wybierz pracÄ™:
        </p>

        <div id="jobsList" style="max-height: 50vh; overflow-y: auto"></div>

        <button
          class="modal-close"
          onclick="closeModal('work')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Mini-gra Praca -->
    <div class="modal" id="modalWorkGame">
      <div
        class="modal-content"
        style="
          max-width: 100%;
          width: 100%;
          height: 90vh;
          padding: 10px;
          position: relative;
          overflow: hidden;
        "
      >
        <div
          id="workGameHeader"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
          "
        >
          <span
            id="workJobName"
            style="font-size: 1.2em; font-weight: bold"
          ></span>
          <div style="display: flex; align-items: center; gap: 15px">
            <span id="workTimer" style="font-size: 1.5em; color: #f59e0b"
              >2:00</span
            >
            <button
              onclick="quitWorkEarly()"
              style="
                padding: 8px 15px;
                background: #ef4444;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9em;
              "
            >
              â¹ï¸ Przerwij (-3%)
            </button>
          </div>
        </div>

        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
          "
        >
          <span>ğŸ’° <span id="workEarned">0</span> zÅ‚</span>
          <span
            >ğŸ“ˆ +<span id="workBonus">0</span> zÅ‚
            <span data-translate="bonus">bonus</span></span
          >
        </div>

        <!-- Obszar gry -->
        <div
          id="workGameArea"
          style="
            position: relative;
            width: 100%;
            height: calc(100% - 120px);
            background: #1a1a2e;
            border-radius: 10px;
            overflow: hidden;
          "
        >
          <!-- Ciemnienie (zasypianie) -->
          <div
            id="sleepOverlayTop"
            style="
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 0;
              background: linear-gradient(to bottom, #000, transparent);
              pointer-events: none;
              z-index: 10;
            "
          ></div>
          <div
            id="sleepOverlayBottom"
            style="
              position: absolute;
              bottom: 0;
              left: 0;
              right: 0;
              height: 0;
              background: linear-gradient(to top, #000, transparent);
              pointer-events: none;
              z-index: 10;
            "
          ></div>

          <!-- SpadajÄ…ce pieniÄ…dze -->
          <div
            id="coinsContainer"
            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0"
          ></div>
        </div>

        <!-- Przycisk "nie zasypiaj" - trzeba TRZYMAÄ† -->
        <button
          id="wakeUpBtn"
          onmousedown="startWakeUp()"
          onmouseup="stopWakeUp()"
          onmouseleave="stopWakeUp()"
          ontouchstart="startWakeUp()"
          ontouchend="stopWakeUp()"
          style="
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 20;
            user-select: none;
            -webkit-user-select: none;
          "
        >
          ğŸ‘ï¸ <span data-translate="stayAwake">Trzymaj Å¼eby nie zasnÄ…Ä‡!</span>
        </button>
      </div>
    </div>

    <div class="modal" id="modalInventory">
      <div class="modal-content">
        <h2>ğŸ’ <span data-translate="inventory">Ekwipunek</span></h2>

        <!-- Status gracza -->
        <div
          style="
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 8px;
            "
          >
            <span>â¤ï¸ <span data-translate="health">Zdrowie</span></span>
            <span id="invHealth">100/100 HP</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 8px;
            "
          >
            <span>ğŸ” <span data-translate="food">Jedzenie</span></span>
            <span id="invFood">1000/1000 kcal</span>
          </div>
          <div style="display: flex; justify-content: space-between">
            <span>ğŸ’§ <span data-translate="water">Picie</span></span>
            <span id="invWater">1000/1000 ml</span>
          </div>
        </div>

        <!-- ZawartoÅ›Ä‡ plecaka -->
        <h4 style="margin-bottom: 10px">
          ğŸ“¦ <span data-translate="backpackContents">ZawartoÅ›Ä‡ plecaka:</span>
        </h4>
        <div class="shop-grid" id="backpackGrid"></div>

        <div
          id="emptyBackpack"
          style="text-align: center; padding: 30px; color: #888; display: none"
        >
          <div style="font-size: 3em">ğŸ’</div>
          <p data-translate="emptyBackpack">Plecak jest pusty</p>
          <p
            style="font-size: 0.85em; margin-top: 5px"
            data-translate="goToShop"
          >
            IdÅº do sklepu kupiÄ‡ jedzenie!
          </p>
        </div>

        <button
          class="modal-close"
          onclick="closeModal('inventory')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Ubezpieczenia -->
    <div class="modal" id="modalInsurance">
      <div class="modal-content">
        <h2>ğŸ¥ <span data-translate="insurance">Ubezpieczenia</span></h2>

        <!-- Aktywne ubezpieczenia -->
        <div
          id="activeInsurancesSection"
          style="margin-bottom: 15px; display: none"
        >
          <h4 style="color: #4ade80; margin-bottom: 10px">
            âœ…
            <span data-translate="activeInsurances">Aktywne ubezpieczenia</span>
            (<span id="activeCount">0</span>)
          </h4>
          <div
            id="activeInsurancesList"
            style="max-height: 150px; overflow-y: auto"
          ></div>
        </div>

        <p
          style="color: #888; text-align: center; margin-bottom: 10px"
          data-translate="chooseInsurance"
        >
          Wybierz pakiet:
        </p>

        <!-- Lista pakietÃ³w -->
        <div
          id="insuranceList"
          style="max-height: 300px; overflow-y: auto"
        ></div>

        <button
          class="modal-close"
          onclick="closeModal('insurance')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal wyboru okresu ubezpieczenia -->
    <div class="modal" id="modalInsurancePeriod">
      <div class="modal-content">
        <h2>ğŸ“… <span data-translate="choosePeriod">Wybierz okres</span></h2>

        <div
          id="insurancePeriodDetails"
          style="text-align: center; margin-bottom: 15px"
        ></div>

        <div
          id="periodOptions"
          style="display: flex; flex-direction: column; gap: 10px"
        ></div>

        <button
          class="modal-close"
          onclick="closeModal('insurancePeriod')"
          data-translate="cancel"
        >
          Anuluj
        </button>
      </div>
    </div>

    <!-- Modal szczegÃ³Å‚Ã³w ubezpieczenia -->
    <div class="modal" id="modalInsuranceDetails">
      <div class="modal-content">
        <h2>ğŸ“‹ <span data-translate="insuranceDetails">SzczegÃ³Å‚y</span></h2>

        <div id="insuranceDetailsContent"></div>

        <button
          class="modal-close"
          onclick="closeModal('insuranceDetails')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Podatki -->
    <div class="modal" id="modalTax">
      <div class="modal-content">
        <h2>ğŸ›ï¸ <span data-translate="taxes">Podatki</span></h2>

        <div class="tax-info">
          <h4><span data-translate="taxInfo">Informacje o podatkach</span></h4>
          <div class="tax-stat">
            <span data-translate="taxRate">Stawka:</span>
            <span class="price cost">500 zÅ‚ / 5 min</span>
          </div>
          <div class="tax-stat">
            <span data-translate="totalPaid">ZapÅ‚acono Å‚Ä…cznie:</span>
            <span id="totalTaxPaid">0 zÅ‚</span>
          </div>
          <div class="tax-stat">
            <span data-translate="nextTax">NastÄ™pny podatek za:</span>
            <span id="nextTaxTime">10:00</span>
          </div>
        </div>

        <div class="tax-toggle">
          <div>
            <strong data-translate="autoPay">Automatyczne pÅ‚acenie</strong>
            <p
              style="font-size: 0.8em; color: #888"
              data-translate="autoPayDesc"
            >
              Karta pÅ‚aci automatycznie w tle
            </p>
          </div>
          <div
            class="toggle-switch"
            id="autoPayToggle"
            onclick="toggleAutoPay()"
          ></div>
        </div>

        <div class="instruction-section">
          <h3>âš ï¸ <span data-translate="debtInfo">Informacje o dÅ‚ugu</span></h3>
          <p style="font-size: 0.9em; color: #aaa" data-translate="debtDesc">
            JeÅ›li zabraknie pieniÄ™dzy na podatek, powstanie dÅ‚ug. Masz 7 dni na
            spÅ‚atÄ™ dÅ‚ugu.
          </p>
          <div class="tax-stat" style="margin-top: 10px">
            <span data-translate="currentDebt">Aktualny dÅ‚ug:</span>
            <span id="currentDebt" class="price cost">0 zÅ‚</span>
          </div>
        </div>

        <button
          class="confirm-btn active"
          onclick="payDebt()"
          id="payDebtBtn"
          style="display: none"
        >
          ğŸ’³ <span data-translate="payDebt">SpÅ‚aÄ‡ dÅ‚ug</span>
        </button>

        <button
          class="modal-close"
          onclick="closeModal('tax')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Karta -->
    <div class="modal" id="modalCard">
      <div class="modal-content">
        <h2>ğŸ’³ <span data-translate="card">Karta Beam-Pay</span></h2>

        <div class="beam-pay-card">
          <div class="card-logo">Beam-Pay</div>
          <div class="card-code" id="cardCode">000000</div>
          <div class="card-balance">
            <div class="label" data-translate="balance">Saldo</div>
            <div class="amount" id="cardBalance">50 000 zÅ‚</div>
          </div>
        </div>

        <div class="card-settings">
          <h4>
            âš™ï¸ <span data-translate="cardSettings">Ustawienia karty</span>
          </h4>

          <div class="setting-row">
            <span class="setting-label" data-translate="spendingLimit"
              >Limit wydatkÃ³w:</span
            >
            <span class="setting-value" id="limitValue">10 000 zÅ‚</span>
          </div>

          <div class="setting-row">
            <span class="setting-label" data-translate="spent"
              >Wydano z limitu:</span
            >
            <span class="setting-value" id="spentValue">0 zÅ‚</span>
          </div>

          <div class="setting-row">
            <span class="setting-label" data-translate="remaining"
              >PozostaÅ‚o:</span
            >
            <span class="setting-value" id="remainingValue">10 000 zÅ‚</span>
          </div>

          <div class="limit-bar">
            <div class="limit-fill" id="limitBar" style="width: 0%"></div>
          </div>

          <button class="card-btn" onclick="openModal('setLimit')">
            <span data-translate="setLimit">ğŸ“Š Ustaw limit</span>
          </button>
          <button
            class="card-btn"
            onclick="pendingAction = 'resetLimit'; openModal('pin');"
          >
            <span data-translate="resetSpent">ğŸ”„ Resetuj wydatki</span>
          </button>

          <div
            style="
              margin-top: 15px;
              padding-top: 15px;
              border-top: 1px solid #444;
            "
          >
            <h4 style="margin-bottom: 10px">
              ğŸ’³
              <span data-translate="autoPayments">Automatyczne pÅ‚atnoÅ›ci</span>
            </h4>
            <p
              style="font-size: 0.8em; color: #888; margin-bottom: 10px"
              data-translate="autoPayInfo"
            >
              Podatki i ubezpieczenia nie liczÄ… siÄ™ do limitu
            </p>

            <div id="insuranceAutoPayList"></div>

            <div
              id="noInsurancesCard"
              style="
                text-align: center;
                color: #888;
                padding: 10px;
                display: none;
              "
            >
              <span data-translate="noActiveInsurance"
                >Brak aktywnych ubezpieczeÅ„</span
              >
            </div>
          </div>
        </div>

        <button
          class="modal-close"
          onclick="closeModal('card')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Ustaw Limit -->
    <div class="modal" id="modalSetLimit">
      <div class="modal-content">
        <h2>ğŸ“Š <span data-translate="setLimit">Ustaw limit wydatkÃ³w</span></h2>

        <div class="input-group">
          <label data-translate="newLimit">Nowy limit (zÅ‚)</label>
          <input
            type="number"
            id="newLimitInput"
            min="100"
            placeholder="np. 10000"
          />
        </div>

        <button class="confirm-btn active" onclick="setNewLimit()">
          âœ… <span data-translate="setLimitBtn">Ustaw limit</span>
        </button>
        <button
          class="modal-close"
          onclick="closeModal('setLimit')"
          data-translate="cancel"
        >
          Anuluj
        </button>
      </div>
    </div>

    <!-- Modal PIN -->
    <div class="modal" id="modalPin">
      <div class="modal-content">
        <h2>ğŸ” <span data-translate="enterPin">Wpisz PIN</span></h2>
        <p
          style="
            text-align: center;
            color: #aaa;
            margin-bottom: 10px;
            font-size: 0.9em;
          "
          data-translate="enter6digitPin"
        >
          Wpisz 6-cyfrowy PIN z karty Beam-Pay
        </p>

        <div class="pin-display">
          <div class="pin-digit" id="pin1"></div>
          <div class="pin-digit" id="pin2"></div>
          <div class="pin-digit" id="pin3"></div>
          <div class="pin-digit" id="pin4"></div>
          <div class="pin-digit" id="pin5"></div>
          <div class="pin-digit" id="pin6"></div>
        </div>

        <div class="pin-keypad">
          <button class="pin-key" onclick="addPinDigit('1')">1</button>
          <button class="pin-key" onclick="addPinDigit('2')">2</button>
          <button class="pin-key" onclick="addPinDigit('3')">3</button>
          <button class="pin-key" onclick="addPinDigit('4')">4</button>
          <button class="pin-key" onclick="addPinDigit('5')">5</button>
          <button class="pin-key" onclick="addPinDigit('6')">6</button>
          <button class="pin-key" onclick="addPinDigit('7')">7</button>
          <button class="pin-key" onclick="addPinDigit('8')">8</button>
          <button class="pin-key" onclick="addPinDigit('9')">9</button>
          <button class="pin-key delete" onclick="deletePinDigit()">âŒ«</button>
          <button class="pin-key" onclick="addPinDigit('0')">0</button>
          <button class="pin-key confirm" onclick="confirmPin()">âœ“</button>
        </div>

        <div id="forgotPinBtnContainer" style="display: none; margin-top: 10px">
          <button
            onclick="forgotPinAuction()"
            style="
              width: 100%;
              padding: 12px;
              background: #f59e0b;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            â“ <span data-translate="forgotPin">Nie pamiÄ™tam PIN</span>
          </button>
        </div>

        <button
          class="modal-close"
          onclick="closeModal('pin'); pendingAction = null; pendingAuctionId = null;"
          data-translate="cancel"
        >
          Anuluj
        </button>
      </div>
    </div>

    <!-- Modal Limit Exceeded -->
    <div class="modal" id="modalLimitExceeded">
      <div class="modal-content">
        <h2>
          âš ï¸ <span data-translate="limitExceeded">Przekroczono limit!</span>
        </h2>

        <div
          style="
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
          "
        >
          <h3 style="color: #ef4444">
            ğŸš« <span data-translate="pinRequired">Wymagany PIN</span>
          </h3>
          <p
            style="color: #aaa; margin-top: 10px"
            data-translate="transactionExceedsLimit"
          >
            Ta transakcja przekracza TwÃ³j limit wydatkÃ³w. Wpisz PIN z karty aby
            potwierdziÄ‡.
          </p>
        </div>

        <button
          class="confirm-btn active"
          onclick="closeModal('limitExceeded'); openModal('pin');"
        >
          ğŸ” <span data-translate="enterPinBtn">Wpisz PIN</span>
        </button>
        <button
          class="modal-close"
          onclick="closeModal('limitExceeded'); pendingAction = null;"
          data-translate="cancel"
        >
          Anuluj
        </button>
      </div>
    </div>

    <!-- Modal WybÃ³r Trybu Gry -->
    <div class="modal" id="modalGameMode">
      <div class="modal-content">
        <h2>ğŸ® <span data-translate="selectMode">Wybierz tryb</span></h2>

        <div style="display: flex; flex-direction: column; gap: 15px">
          <button
            onclick="switchGameMode('beamng')"
            id="modeBeamNG"
            style="
              padding: 20px;
              background: linear-gradient(145deg, #ff6b35, #f7931e);
              border: 3px solid transparent;
              border-radius: 15px;
              cursor: pointer;
              text-align: left;
              transition: all 0.3s;
            "
          >
            <div style="font-size: 1.5em; margin-bottom: 8px">
              ğŸš— BeamNG Drive
            </div>
            <div style="font-size: 0.9em; color: rgba(255, 255, 255, 0.9)">
              Datapack
            </div>
            <div
              style="
                font-size: 0.8em;
                color: rgba(255, 255, 255, 0.7);
                margin-top: 8px;
              "
              data-translate="beamngDesc"
            >
              Auta z gry BeamNG.drive - fikcyjne marki
            </div>
          </button>

          <button
            onclick="switchGameMode('reallife')"
            id="modeRealLife"
            style="
              padding: 20px;
              background: linear-gradient(145deg, #10b981, #059669);
              border: 3px solid transparent;
              border-radius: 15px;
              cursor: pointer;
              text-align: left;
              transition: all 0.3s;
            "
          >
            <div style="font-size: 1.5em; margin-bottom: 8px">ğŸŒ Real Life</div>
            <div
              style="font-size: 0.9em; color: rgba(255, 255, 255, 0.9)"
              data-translate="simulator"
            >
              Symulator
            </div>
            <div
              style="
                font-size: 0.8em;
                color: rgba(255, 255, 255, 0.7);
                margin-top: 8px;
              "
              data-translate="reallifeDesc"
            >
              Prawdziwe marki aut w realnych cenach (-10%)
            </div>
          </button>
        </div>

        <div
          style="
            margin-top: 15px;
            padding: 12px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: 10px;
            font-size: 0.85em;
            color: #f59e0b;
          "
        >
          âš ï¸
          <span data-translate="modeWarning"
            >KaÅ¼dy tryb ma osobny postÄ™p na tym samym save'ie!</span
          >
        </div>

        <button
          class="modal-close"
          onclick="closeModal('gameMode')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal JÄ™zyki -->
    <div class="modal" id="modalLanguage">
      <div class="modal-content">
        <h2>ğŸŒ <span data-translate="selectLanguage">Wybierz jÄ™zyk</span></h2>

        <div class="lang-grid" id="langGrid"></div>

        <button
          class="modal-close"
          onclick="closeModal('language')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Save'y -->
    <div class="modal" id="modalSaves">
      <div class="modal-content">
        <h2>ğŸ’¾ <span data-translate="saves">Save'y</span></h2>

        <div
          id="savesList"
          style="
            max-height: 50vh;
            overflow-y: auto;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
          "
        ></div>

        <div
          style="
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
          "
        >
          <p style="margin-bottom: 10px; font-weight: bold; font-size: 0.95em">
            <span data-translate="createSave">Nowy save</span>
          </p>
          <input
            type="text"
            id="newSaveName"
            placeholder="Save 2"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #333;
              border-radius: 8px;
              background: #1a1a2e;
              color: white;
              margin-bottom: 10px;
              font-size: 16px;
            "
          />
          <button
            onclick="handleCreateSave()"
            style="
              width: 100%;
              padding: 14px;
              background: #10b981;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 1em;
              cursor: pointer;
              -webkit-tap-highlight-color: transparent;
            "
          >
            â• <span data-translate="createSave">Nowy save</span>
          </button>
        </div>

        <button
          class="modal-close"
          onclick="closeModal('saves')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Bony -->
    <div class="modal" id="modalVouchers">
      <div class="modal-content">
        <h2>ğŸ <span data-translate="vouchers">Bony</span></h2>

        <!-- Opisik -->
        <div
          style="
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid #8b5cf6;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #aaa;
            line-height: 1.4;
          "
        >
          <span data-translate="vouchersDescription"
            >Bony to wirtualne pieniÄ…dze ktÃ³re moÅ¼esz wysÅ‚aÄ‡ znajomym przez
            WhatsApp, Messenger, Email lub SMS. Odbiorca moÅ¼e przyjÄ…Ä‡ bon
            (dostanie pieniÄ…dze) lub przekazaÄ‡ go komuÅ› innemu.</span
          >
        </div>

        <!-- Twoje bony do wysÅ‚ania -->
        <div style="margin-bottom: 15px">
          <h3 style="font-size: 0.95em; margin-bottom: 10px">
            ğŸ“¤ <span data-translate="vouchersToSend">Bony do wysÅ‚ania</span>
          </h3>
          <div
            id="vouchersToSendList"
            style="
              max-height: 30vh;
              overflow-y: auto;
              -webkit-overflow-scrolling: touch;
            "
          ></div>
        </div>

        <!-- Otrzymane bony -->
        <div style="margin-bottom: 15px">
          <h3 style="font-size: 0.95em; margin-bottom: 10px">
            ğŸ“¥ <span data-translate="receivedVouchers">Otrzymane bony</span>
          </h3>
          <div
            id="receivedVouchersList"
            style="
              max-height: 30vh;
              overflow-y: auto;
              -webkit-overflow-scrolling: touch;
            "
          ></div>
        </div>

        <!-- UtwÃ³rz bon -->
        <div
          style="
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 15px;
          "
        >
          <p style="margin-bottom: 10px; font-weight: bold; font-size: 0.95em">
            <span data-translate="createVoucher">UtwÃ³rz bon</span>
          </p>
          <input
            type="number"
            id="voucherAmountInput"
            placeholder="100"
            min="1"
            inputmode="numeric"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #333;
              border-radius: 8px;
              background: #1a1a2e;
              color: white;
              margin-bottom: 10px;
              font-size: 16px;
            "
          />
          <input
            type="text"
            id="voucherMessageInput"
            placeholder="WiadomoÅ›Ä‡ (opcjonalna)"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #333;
              border-radius: 8px;
              background: #1a1a2e;
              color: white;
              margin-bottom: 10px;
              font-size: 16px;
            "
          />
          <button
            onclick="handleCreateVoucher()"
            style="
              width: 100%;
              padding: 14px;
              background: #8b5cf6;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 1em;
              cursor: pointer;
              -webkit-tap-highlight-color: transparent;
            "
          >
            ğŸ <span data-translate="createVoucher">UtwÃ³rz bon</span>
          </button>
        </div>

        <button
          class="modal-close"
          onclick="closeModal('vouchers')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Konto Online -->
    <!-- Modal WymuszajÄ…cy Logowanie (na starcie) -->
    <div class="modal" id="modalRequireLogin">
      <div class="modal-content" style="max-width: 400px; text-align: center">
        <h2>ğŸ® BeamNG Datapack</h2>

        <div style="font-size: 4em; margin-bottom: 15px">ğŸ‘¤</div>

        <input
          type="text"
          id="loginName"
          placeholder="Twoja nazwa..."
          maxlength="20"
          style="
            width: 100%;
            padding: 15px;
            background: #222;
            border: 2px solid #333;
            border-radius: 10px;
            color: white;
            font-size: 1.1em;
            margin-bottom: 10px;
            text-align: center;
          "
        />
        <p
          id="loginError"
          style="
            color: #ef4444;
            font-size: 0.85em;
            display: none;
            margin-bottom: 10px;
          "
        ></p>

        <button
          onclick="setPlayerName()"
          style="
            width: 100%;
            padding: 15px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
          "
        >
          âœ… Rozpocznij grÄ™
        </button>

        <p style="color: #666; font-size: 0.8em; margin-top: 15px">
          Nazwa bÄ™dzie widoczna dla innych graczy
        </p>
      </div>
    </div>

    <div class="modal" id="modalOnlineAccount">
      <div class="modal-content" style="max-width: 400px">
        <span class="close" onclick="closeModal('onlineAccount')">&times;</span>
        <h2>ğŸ‘¤ <span data-translate="onlineAccount">Konto</span></h2>
        <div id="onlineAccountContent"></div>
      </div>
    </div>

    <!-- Modal Powiadomienia -->
    <div class="modal" id="modalNotifications">
      <div class="modal-content" style="max-width: 500px">
        <span class="close" onclick="closeModal('notifications')">&times;</span>
        <h2>ğŸ”” <span data-translate="notifications">Powiadomienia</span></h2>
        <div
          id="notificationsList"
          style="max-height: 400px; overflow-y: auto"
        ></div>
      </div>
    </div>

    <!-- Modal Czat -->
    <div class="modal" id="modalChat">
      <div class="modal-content" style="max-width: 500px">
        <span class="close" onclick="closeChatModal()">&times;</span>
        <h2>
          ğŸ’¬ <span data-translate="chatWith">Czat z</span>
          <span id="chatWithName"></span>
        </h2>
        <div
          id="chatMessages"
          style="
            max-height: 300px;
            overflow-y: auto;
            background: #1a1a2e;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
          "
        ></div>
        <p
          style="
            color: #888;
            font-size: 0.75em;
            margin-bottom: 5px;
            text-align: center;
          "
        >
          ğŸ’° Koszt wiadomoÅ›ci: 5,50 zÅ‚/$
        </p>
        <div style="display: flex; gap: 10px">
          <input
            type="text"
            id="chatInput"
            placeholder="WiadomoÅ›Ä‡..."
            style="
              flex: 1;
              padding: 12px;
              background: #222;
              border: 1px solid #333;
              border-radius: 8px;
              color: white;
            "
          />
          <button
            onclick="sendChatMessage()"
            style="
              padding: 12px 20px;
              background: #3b82f6;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            ğŸ“¤
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Aukcje -->
    <div class="modal" id="modalAuction">
      <div class="modal-content" style="max-width: 600px">
        <span class="close" onclick="closeModal('auction')">&times;</span>
        <h2>ğŸª <span data-translate="auctionHouse">Dom Aukcyjny</span></h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px">
          <button
            onclick="showAuctionTab('browse')"
            class="tab-btn active"
            id="tabBrowse"
            style="
              flex: 1;
              padding: 10px;
              background: #333;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            ğŸ” <span data-translate="browseAuctions">PrzeglÄ…daj</span>
          </button>
          <button
            onclick="showAuctionTab('my')"
            class="tab-btn"
            id="tabMy"
            style="
              flex: 1;
              padding: 10px;
              background: #222;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            ğŸ“¦ <span data-translate="myAuctions">Moje</span>
          </button>
          <button
            onclick="showAuctionTab('create')"
            class="tab-btn"
            id="tabCreate"
            style="
              flex: 1;
              padding: 10px;
              background: #222;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            â• <span data-translate="createAuction">Wystaw</span>
          </button>
        </div>
        <div
          id="auctionContent"
          style="max-height: 400px; overflow-y: auto"
        ></div>
      </div>
    </div>

    <!-- Modal SzczegÃ³Å‚y Aukcji -->
    <div class="modal" id="modalAuctionDetail">
      <div class="modal-content" style="max-width: 450px">
        <span class="close" onclick="closeModal('auctionDetail')">&times;</span>
        <div id="auctionDetailContent"></div>
      </div>
    </div>

    <!-- Modal WyÅ›lij do gracza online -->
    <div class="modal" id="modalSendToPlayer">
      <div class="modal-content" style="max-width: 400px">
        <span class="close" onclick="closeModal('sendToPlayer')">&times;</span>
        <h2>ğŸ“¤ <span data-translate="sendToPlayer">WyÅ›lij do gracza</span></h2>
        <p style="color: #f59e0b; font-size: 0.9em; margin-bottom: 15px">
          âš ï¸
          <span data-translate="onlineFee">OpÅ‚ata: 250</span> ${getCurrency()}
        </p>
        <div
          id="onlinePlayersList"
          style="max-height: 300px; overflow-y: auto"
        ></div>
      </div>
    </div>

    <!-- Modal PodglÄ…d Bonu -->
    <div class="modal" id="modalVoucherPreview">
      <div class="modal-content">
        <div id="voucherPreviewContent"></div>
        <button
          class="modal-close"
          onclick="closeModal('voucherPreview')"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal UdostÄ™pnij Bon -->
    <div class="modal" id="modalShareVoucher">
      <div class="modal-content">
        <h2>ğŸ“¤ <span data-translate="shareVoucher">WyÅ›lij bon</span></h2>
        <div id="shareVoucherPreview" style="margin-bottom: 15px"></div>
        <div id="shareVoucherButtons"></div>
        <button
          class="modal-close"
          onclick="closeModal('shareVoucher')"
          style="margin-top: 15px"
          data-translate="close"
        >
          Zamknij
        </button>
      </div>
    </div>

    <!-- Modal Bank -->
    <div class="modal" id="modalBank">
      <div class="modal-content" style="max-width: 450px">
        <span class="close" onclick="closeModal('bank')">&times;</span>
        <h2>ğŸ¦ <span data-translate="bank">Bank</span></h2>
        
        <div id="bankContent">
          <!-- ZawartoÅ›Ä‡ bÄ™dzie renderowana dynamicznie -->
        </div>
      </div>
    </div>

    <!-- Modal Firmy -->
    <div class="modal" id="modalBusiness">
      <div class="modal-content" style="max-width: 550px">
        <span class="close" onclick="closeModal('business')">&times;</span>
        <h2>ğŸ¢ <span data-translate="business">Twoje Firmy</span></h2>
        
        <div id="businessContent">
          <!-- ZawartoÅ›Ä‡ bÄ™dzie renderowana dynamicznie -->
        </div>
        
        <button class="modal-close" onclick="closeModal('business')" data-translate="close">Zamknij</button>
      </div>
    </div>

    <!-- Modal Tworzenia Firmy -->
    <div class="modal" id="modalCreateBusiness">
      <div class="modal-content" style="max-width: 500px">
        <span class="close" onclick="closeModal('createBusiness')">&times;</span>
        <h2>ğŸ—ï¸ <span data-translate="createBusiness">ZaÅ‚Ã³Å¼ FirmÄ™</span></h2>
        
        <div id="createBusinessContent">
          <!-- ZawartoÅ›Ä‡ bÄ™dzie renderowana dynamicznie -->
        </div>
      </div>
    </div>

    <!-- Modal SzczegÃ³Å‚y Firmy -->
    <div class="modal" id="modalBusinessDetail">
      <div class="modal-content" style="max-width: 550px">
        <span class="close" onclick="closeModal('businessDetail')">&times;</span>
        <div id="businessDetailContent">
          <!-- ZawartoÅ›Ä‡ bÄ™dzie renderowana dynamicznie -->
        </div>
      </div>
    </div>

    <!-- Modal Czat z Pracownikiem/Klientem -->
    <div class="modal" id="modalBusinessChat">
      <div class="modal-content" style="max-width: 500px">
        <span class="close" onclick="closeModal('businessChat')">&times;</span>
        <h2 id="businessChatTitle">ğŸ’¬ Rozmowa</h2>
        
        <div id="businessChatMessages" style="max-height: 350px; overflow-y: auto; background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <!-- WiadomoÅ›ci czatu -->
        </div>
        
        <div id="businessChatOptions" style="display: flex; flex-direction: column; gap: 8px;">
          <!-- Opcje odpowiedzi -->
        </div>
        
        <div id="businessChatInput" style="display: none; margin-top: 10px;">
          <input type="text" id="businessChatInputField" placeholder="" style="width: 100%; padding: 12px; background: #222; border: 2px solid #333; border-radius: 8px; color: white; font-size: 1em;">
          <button onclick="sendBusinessChatInput()" id="businessChatSendBtn" style="width: 100%; margin-top: 8px; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;" data-translate="sendOffer">WyÅ›lij</button>
        </div>
      </div>
    </div>

    <script>
      // ==================== JÄ˜ZYKI ====================
      const languages = {
        pl: { name: "Polski", flag: "ğŸ‡µğŸ‡±" },
        en: { name: "English", flag: "ğŸ‡¬ğŸ‡§" },
      };

      const translations = {
        pl: {
          yourMoney: "TWOJE PIENIÄ„DZE",
          debt: "DÅUG",
          instructions: "Instrukcja",
          earnKm: "Zarobek (km)",
          repair: "Napraw Auto",
          buyCar: "Kup Auto",
          sellCar: "Sprzedaj Auto",
          work: "Praca",
          garage: "GaraÅ¼",
          business: "Firmy",
          createBusiness: "ZaÅ‚Ã³Å¼ FirmÄ™",
          noBusinesses: "Nie masz jeszcze Å¼adnej firmy",
          totalIncomeWeek: "ÅÄ…czny przychÃ³d/tydzieÅ„",
          totalExpensesWeek: "ÅÄ…czne wydatki/tydzieÅ„",
          netProfitWeek: "Zysk netto/tydzieÅ„",
          workers: "pracownikÃ³w",
          createNextBusiness: "ZaÅ‚Ã³Å¼ kolejnÄ… firmÄ™",
          selectCategory: "Wybierz kategoriÄ™ dziaÅ‚alnoÅ›ci",
          businessTypes: "typÃ³w firm",
          back: "WrÃ³Ä‡",
          backToCategories: "WrÃ³Ä‡ do kategorii",
          selectType: "wybierz typ",
          startCost: "Koszt zaÅ‚oÅ¼enia",
          clientsPerDay: "Klienci/dzieÅ„",
          avgIncomeClient: "Åšr. przychÃ³d/klient",
          businessName: "Nazwa firmy",
          notEnoughMoneyBusiness: "Nie masz wystarczajÄ…co pieniÄ™dzy!",
          youNeed: "Potrzebujesz",
          createBusinessFor: "ZaÅ‚Ã³Å¼ firmÄ™ za",
          hiredWorkers: "Zatrudnieni pracownicy",
          noWorkersYet: "Nie masz jeszcze pracownikÃ³w. Zatrudnij kogoÅ› poniÅ¼ej!",
          candidates: "Kandydaci do pracy",
          noCandidates: "Brak kandydatÃ³w. Nowi pojawiÄ… siÄ™ wkrÃ³tce.",
          searchCandidates: "Szukaj kandydatÃ³w",
          negotiateTerms: "Negocjuj warunki",
          expects: "Oczekuje",
          activeClients: "Aktywni klienci",
          serve: "ObsÅ‚uÅ¼",
          simulateDay: "Symuluj dzieÅ„ pracy",
          closeBusiness: "Zamknij firmÄ™",
          backToList: "WrÃ³Ä‡ do listy firm",
          reputation: "Reputacja",
          acceptTerms: "AkceptujÄ™ warunki",
          proposeAmount: "Zaproponuj innÄ… kwotÄ™",
          lowerBonus: "NiÅ¼sza prowizja, wyÅ¼sza podstawa?",
          notInterested: "DziÄ™kujÄ™, nie jesteÅ›my zainteresowani",
          giveRaise: "Daj podwyÅ¼kÄ™",
          needWorkers: "Potrzebujesz pracownikÃ³w!",
          dayReport: "DzieÅ„ pracy",
          clients: "klientÃ³w",
          afterCommission: "po prowizjach",
          hired: "Zatrudniono",
          workerFired: "Pracownik zwolniony",
          businessClosed: "Firma zamkniÄ™ta",
          businessCreated: "ZaÅ‚oÅ¼ono firmÄ™",
          salariesIn: "WypÅ‚aty w",
          cantAffordSalaries: "Nie staÄ‡ CiÄ™ na wypÅ‚aty w",
          addedToDebt: "Dodano do dÅ‚ugu",
          foundCandidates: "Znaleziono nowych kandydatÃ³w!",
          needForRecruitment: "Potrzebujesz na rekrutacjÄ™",
          chatWith: "Rozmowa z",
          greeting1: "DzieÅ„ dobry! Jestem {name}. Szukam pracy jako {position}.",
          greeting2: "CzeÅ›Ä‡! Nazywam siÄ™ {name} i zainteresowaÅ‚a mnie oferta pracy.",
          greeting3: "Witam serdecznie. {name}, szukam zatrudnienia w charakterze {position}.",
          salaryExpectation: "Moje oczekiwania to okoÅ‚o {salary} {currency} tygodniowo, plus {bonus}% prowizji od wypracowanych zyskÃ³w. Co Pan/Pani o tym sÄ…dzi?",
          acceptTermsBtn: "AkceptujÄ™ warunki",
          proposeAmountBtn: "Zaproponuj innÄ… kwotÄ™",
          lowerBonusBtn: "NiÅ¼sza prowizja, wyÅ¼sza podstawa?",
          rejectBtn: "DziÄ™kujÄ™, nie jesteÅ›my zainteresowani",
          acceptMsg: "Zgadzam siÄ™ na {salary} {currency}/tydzieÅ„ plus {bonus}% prowizji. Witam w zespole!",
          workerAcceptMsg: "Åšwietnie! Bardzo siÄ™ cieszÄ™. Kiedy mogÄ™ zaczÄ…Ä‡?",
          startNowMsg: "Od zaraz! Zapraszam do pracy.",
          workerThanksMsg: "DziÄ™kujÄ™! Nie zawiodÄ™.",
          counterOfferMsg: "Mam innÄ… propozycjÄ™ finansowÄ…...",
          enterSalaryPrompt: "Wpisz proponowanÄ… pensjÄ™ tygodniowÄ…:",
          sendOffer: "WyÅ›lij ofertÄ™",
          proposeSalaryMsg: "ProponujÄ™ {salary} {currency} tygodniowo.",
          workerGreatOffer: "To bardzo fajna oferta! Zgadzam siÄ™!",
          workerAcceptLower: "TrochÄ™ mniej niÅ¼ liczyÅ‚em, ale zgoda. Bierzemy to!",
          workerCounterOffer: "To trochÄ™ za maÅ‚o... MoÅ¼e spotkamy siÄ™ w poÅ‚owie drogi? {counter} {currency}?",
          workerTooLow: "Przepraszam, ale to znacznie poniÅ¼ej moich oczekiwaÅ„. Minimum {min} {currency}.",
          lowerBonusProposal: "Co powiesz na {salary} {currency}/tydzieÅ„, ale prowizja {bonus}%?",
          workerReasonable: "Hmm... to brzmi rozsÄ…dnie. Zgadzam siÄ™!",
          workerNotGood: "Nie bardzo mi to pasuje. MoÅ¼e jednak {salary} i {bonus}%? To moja ostateczna oferta.",
          rejectMsg: "DziÄ™kujÄ™ za rozmowÄ™, ale nie jesteÅ›my zainteresowani wspÃ³Å‚pracÄ….",
          workerUnderstandMsg: "Rozumiem. DziÄ™kujÄ™ za poÅ›wiÄ™cony czas. Powodzenia!",
          backToBusinessBtn: "WrÃ³Ä‡ do firmy",
          bank: "Bank",
          takeCredit: "WeÅº kredyt",
          creditAmount: "Kwota kredytu",
          interestRate: "Oprocentowanie",
          monthly: "miesiÄ™cznie",
          repaymentPeriod: "Okres spÅ‚aty",
          months: "miesiÄ™cy",
          monthlyPayment: "Rata miesiÄ™czna",
          totalToRepay: "Razem do spÅ‚aty",
          yourCredits: "Twoje kredyty",
          noCredits: "Nie masz Å¼adnych kredytÃ³w",
          remaining: "PozostaÅ‚o",
          payRate: "ZapÅ‚aÄ‡ ratÄ™",
          payOff: "SpÅ‚aÄ‡ caÅ‚oÅ›Ä‡",
          creditTaken: "Kredyt przyznany!",
          ratePaid: "Rata zapÅ‚acona",
          creditPaidOff: "Kredyt spÅ‚acony!",
          notEnoughForRate: "Nie masz na ratÄ™!",
          upgrade: "Ulepsz",
          sellValue: "WartoÅ›Ä‡",
          sell: "Sprzedaj",
          carBroken: "Auto zepsute!",
          cantSellBroken: "Nie moÅ¼esz sprzedaÄ‡ zepsutego auta!",
          confirmSell: "SprzedaÄ‡",
          forPrice: "za",
          sold: "Sprzedano!",
          basePrice: "Cena bazowa",
          buyQuestion: "KupiÄ‡",
          carBought: "Kupiono",
          upgradeCar: "Ulepszanie",
          startUpgrade: "Rozpocznij ulepszanie",
          stopUpgrade: "Zatrzymaj",
          upgrading: "Ulepszanie w toku...",
          upgradeStopped: "Zatrzymane",
          clickToStart: "Kliknij aby rozpoczÄ…Ä‡",
          upgradeWarning:
            "Podczas ulepszania auto moÅ¼e siÄ™ zepsuÄ‡! (150 zÅ‚ + -5%)",
          carBrokeMsg: "Auto siÄ™ zepsuÅ‚o! -150 zÅ‚, -5%",
          carBreakDebt: "Zepsucie auta",
          buyCarFirst: "Kup auto w salonie!",
          chooseJob: "Wybierz pracÄ™:",
          bonuses: "bonusy",
          bonus: "bonus",
          stayAwake: "Trzymaj Å¼eby nie zasnÄ…Ä‡!",
          workDone: "Praca zakoÅ„czona!",
          basePay: "Podstawa",
          sleepPenalty: "Kara za spanie",
          total: "Razem",
          taxes: "Podatki",
          card: "Karta Beam-Pay",
          cardRealLife: "Karta Real-Card",
          howToEarn: "Jak zdobyÄ‡ pieniÄ…dze?",
          perKm: "Za kaÅ¼dy km",
          sellCarTo: "SprzedaÅ¼ auta",
          carPrice: "ceny auta",
          fees: "OpÅ‚aty",
          fuel: "Paliwo (max 10 PkA)",
          startFuel: "Start: 10 punktÃ³w paliwa",
          taxesPer2km: "Podatki (co 2 km)",
          taxesPer10min: "Podatki (co 10 min)",
          repairCost: "Naprawa auta",
          fine: "Mandat",
          close: "Zamknij",
          sendScreenshotKm: "WyÅ›lij screenshot z przejechanych kilometrÃ³w",
          clickOrDrag: "Kliknij lub przeciÄ…gnij screenshot",
          analyzing: "AnalizujÄ™ screenshot...",
          collectEarnings: "Odbierz zarobek",
          sendScreenshotDamage: "WyÅ›lij screenshot uszkodzonego auta",
          repairCostInfo: "Koszt naprawy:",
          payAndRepair: "ZapÅ‚aÄ‡ i napraw",
          sendScreenshotCar: "WyÅ›lij screenshot z cenÄ… auta",
          get50percent: "Dostaniesz 50% wartoÅ›ci",
          buyCarBtn: "Kup auto",
          sellCarBtn: "Sprzedaj auto",
          taxInfo: "Informacje o podatkach",
          taxRate: "Stawka:",
          totalPaid: "ZapÅ‚acono Å‚Ä…cznie:",
          nextTax: "NastÄ™pny podatek za:",
          autoPay: "Automatyczne pÅ‚acenie",
          autoPayDesc: "Karta pÅ‚aci automatycznie w tle",
          debtInfo: "Informacje o dÅ‚ugu",
          debtDesc:
            "JeÅ›li zabraknie pieniÄ™dzy na podatek, powstanie dÅ‚ug. Masz 7 dni na spÅ‚atÄ™ dÅ‚ugu.",
          currentDebt: "Aktualny dÅ‚ug:",
          payDebt: "SpÅ‚aÄ‡ dÅ‚ug",
          balance: "Saldo",
          cardSettings: "Ustawienia karty",
          spendingLimit: "Limit wydatkÃ³w:",
          spent: "Wydano z limitu:",
          remaining: "PozostaÅ‚o:",
          setLimit: "ğŸ“Š Ustaw limit",
          resetSpent: "ğŸ”„ Resetuj wydatki",
          newLimit: "Nowy limit (zÅ‚)",
          setLimitBtn: "Ustaw limit",
          cancel: "Anuluj",
          enterPin: "Wpisz PIN",
          enter6digitPin: "Wpisz 6-cyfrowy PIN z karty Beam-Pay",
          limitExceeded: "Przekroczono limit!",
          pinRequired: "Wymagany PIN",
          transactionExceedsLimit:
            "Ta transakcja przekracza TwÃ³j limit. Wpisz PIN aby potwierdziÄ‡.",
          enterPinBtn: "Wpisz PIN",
          selectLanguage: "Wybierz jÄ™zyk",
          daysLeft: "dni do spÅ‚aty",
          notEnoughMoney: "Nie masz wystarczajÄ…co pieniÄ™dzy!",
          invalidScreenshot: "Nie rozpoznano danych!",
          foundKm: "Znaleziono:",
          foundPrice: "Cena auta:",
          noCarFound: "Nie znaleziono auta na obrazku!",
          enterKm: "Wpisz przejechane kilometry:",
          enterPrice: "Wpisz cenÄ™ auta:",
          youGet50: "Dostaniesz 50%:",
          youPay: "ZapÅ‚acisz:",
          generateQR: "Generuj kod QR",
          carName: "Nazwa auta (np. ETK 800)",
          carPricePlaceholder: "Cena ze screena",
          selectCarToSell: "Wybierz auto z garaÅ¼u:",
          sendCarPhoto: "WyÅ›lij zdjÄ™cie tego auta",
          noCarInGarage: "Nie masz Å¼adnych aut w garaÅ¼u",
          boughtFor: "Kupiono za",
          inventory: "Ekwipunek",
          health: "Zdrowie",
          food: "Jedzenie",
          water: "Picie",
          foodTab: "Jedzenie",
          drinksTab: "Napoje",
          foodFull: "Nie moÅ¼esz wiÄ™cej jeÅ›Ä‡!",
          waterFull: "Nie moÅ¼esz wiÄ™cej piÄ‡!",
          shop: "Sklep",
          backpackContents: "ZawartoÅ›Ä‡ plecaka:",
          emptyBackpack: "Plecak jest pusty",
          goToShop: "IdÅº do sklepu kupiÄ‡ jedzenie!",
          useItem: "UÅ¼yj",
          tooFull: "JesteÅ› peÅ‚ny!",
          insurance: "Ubezpieczenia",
          activeInsurances: "Aktywne ubezpieczenia",
          chooseInsurance: "Wybierz pakiet:",
          cancelInsurance: "Zrezygnuj",
          confirmCancelWithRefund: "ZrezygnowaÄ‡? Zwrot",
          confirmCancelNoRefund:
            "ZrezygnowaÄ‡? Brak zwrotu (uÅ¼yto mniej niÅ¼ 3 razy)",
          choosePeriod: "Wybierz okres",
          hour: "Godzina",
          day: "DzieÅ„",
          week: "TydzieÅ„",
          month: "MiesiÄ…c",
          perHour: "/godz",
          perDay: "/dzieÅ„",
          perWeek: "/tydzieÅ„",
          perMonth: "/miesiÄ…c",
          activated: "Aktywowane",
          perHourShort: "/h",
          perDayShort: "/d",
          perWeekShort: "/tyg",
          every: "co",
          hour: "Godzina",
          day: "DzieÅ„",
          week: "TydzieÅ„",
          remaining: "PozostaÅ‚o",
          expired: "WygasÅ‚o",
          autoPayments: "Automatyczne pÅ‚atnoÅ›ci",
          autoPayInfo: "Podatki i ubezpieczenia nie liczÄ… siÄ™ do limitu",
          autoPay: "Auto-pÅ‚aÄ‡",
          noActiveInsurance: "Brak aktywnych ubezpieczeÅ„",
          alreadyHaveInsurance: "JuÅ¼ masz to ubezpieczenie!",
          insuranceDetails: "SzczegÃ³Å‚y",
          price: "Cena",
          totalPaid: "ZapÅ‚acono Å‚Ä…cznie",
          benefitsReceived: "Otrzymane korzyÅ›ci",
          nextPayment: "NastÄ™pna pÅ‚atnoÅ›Ä‡",
          refund: "zwrot",
          noRefund: "brak zwrotu",
          // Produkty - jedzenie
          itemBurger: "Burger",
          itemPizza: "Pizza",
          itemHotdog: "Hot Dog",
          itemFries: "Frytki",
          itemSandwich: "Kanapka",
          itemSalad: "SaÅ‚atka",
          itemApple: "JabÅ‚ko",
          itemBanana: "Banan",
          itemWatermelon: "Arbuz",
          itemChicken: "Kurczak",
          itemSteak: "Stek",
          itemSushi: "Sushi",
          itemDonut: "PÄ…czek",
          itemIcecream: "Lody",
          itemChocolate: "Czekolada",
          // Produkty - napoje
          itemWater: "Woda",
          itemCola: "Cola",
          itemJuice: "Sok",
          itemCoffee: "Kawa",
          itemTea: "Herbata",
          itemMilk: "Mleko",
          itemBeer: "Piwo",
          itemWine: "Wino",
          itemSmoothie: "Smoothie",
          itemEnergyDrink: "Energetyk",
          itemLemonade: "Lemoniada",
          itemCoconut: "Woda kokosowa",
          // Ubezpieczenia - nazwy
          insBasic: "Basic",
          insStandard: "Standard",
          insPremium: "Premium",
          insVip: "VIP",
          insUltimate: "Ultimate",
          insHealthBasic: "Zdrowie Basic",
          insHealthPlus: "Zdrowie Plus",
          insFoodBasic: "Jedzenie Basic",
          insFoodPlus: "Jedzenie Plus",
          insWaterBasic: "Picie Basic",
          insWaterPlus: "Picie Plus",
          insHealthFood: "Zdrowie + Jedzenie",
          insHealthWater: "Zdrowie + Picie",
          insFoodWater: "Jedzenie + Picie",
          // Ubezpieczenia ulepszanie
          insUpgradeBasic: "Ulepszanie Basic",
          insUpgradePlus: "Ulepszanie Plus",
          insUpgradePro: "Ulepszanie Pro",
          insUpgradeMax: "Ulepszanie Max",
          insUpgradeBasicDesc: "+0.05%/s, -10% szansy zepsucia",
          insUpgradePlusDesc: "+0.1%/s, -20% szansy zepsucia",
          insUpgradeProDesc: "+0.15%/s, -30% szansy zepsucia",
          insUpgradeMaxDesc: "+0.2%/s, -40% szansy zepsucia",
          // Ubezpieczenia naprawa
          insRepairBasic: "Naprawa Basic",
          insRepairPlus: "Naprawa Plus",
          insRepairFull: "Naprawa Full",
          insRepairBasicDesc: "30% kosztÃ³w naprawy pokryte",
          insRepairPlusDesc: "50% kosztÃ³w naprawy pokryte",
          insRepairFullDesc: "100% kosztÃ³w naprawy pokryte",
          noBrokenCars: "Wszystkie auta sÄ… sprawne!",
          goToGarage: "IdÅº do GaraÅ¼u Å¼eby ulepszaÄ‡ auta",
          carNotBroken: "To auto nie jest zepsute!",
          repairDebt: "Naprawa auta",
          addedToDebt: "Dodano do dÅ‚ugu",
          insuranceCovered: "Ubezpieczenie pokryÅ‚o",
          coinsCollected: "Zebrane monety",
          // Save'y
          saves: "Save'y",
          currentSave: "Aktualny save",
          createSave: "Nowy save",
          deleteSave: "UsuÅ„ save",
          switchSave: "PrzeÅ‚Ä…cz",
          saveName: "Nazwa save'a",
          confirmDeleteSave: "UsunÄ…Ä‡ ten save?",
          cannotDeleteLastSave: "Nie moÅ¼na usunÄ…Ä‡ ostatniego save'a!",
          saveCreated: "Save utworzony!",
          active: "aktywny",
          enterNewName: "WprowadÅº nowÄ… nazwÄ™:",
          // Bony
          vouchers: "Bony",
          vouchersRealLife: "Kupony",
          createVoucher: "UtwÃ³rz bon",
          createVoucherRealLife: "UtwÃ³rz kupon",
          voucherAmount: "Kwota bonu",
          voucherMessage: "WiadomoÅ›Ä‡ (opcjonalna)",
          redeemVoucher: "Zrealizuj bon",
          enterVoucherCode: "WprowadÅº kod bonu",
          voucherRedeemed: "Bon zrealizowany!",
          invalidVoucher: "NieprawidÅ‚owy kod bonu!",
          voucherCreated: "Bon utworzony! Kod:",
          voucherFrom: "Od:",
          yourVouchers: "Twoje bony",
          noVouchers: "Brak bonÃ³w",
          // Naprawa
          selectCarToRepair: "Wybierz auto do naprawy:",
          repairSelectedCar: "Napraw wybrane auto",
          repaired: "Naprawione!",
          // Bony - rozszerzone
          vouchersToSend: "Bony do wysÅ‚ania",
          receivedVouchers: "Otrzymane bony",
          sendVoucher: "WyÅ›lij",
          acceptVoucher: "Przyjmij",
          rejectVoucher: "PrzekaÅ¼ dalej",
          shareVoucher: "WyÅ›lij bon",
          copyLink: "Kopiuj link",
          linkCopied: "Link skopiowany!",
          cancelVoucherConfirm: "AnulowaÄ‡ bon? PieniÄ…dze wrÃ³cÄ… na konto.",
          youReceivedVoucher: "DostaÅ‚eÅ›/aÅ› bon o wartoÅ›ci",
          voucherAccepted: "Bon przyjÄ™ty!",
          noReceivedVouchers: "Brak otrzymanych bonÃ³w",
          invalidAmount: "WprowadÅº prawidÅ‚owÄ… kwotÄ™!",
          pendingVoucher: "WysÅ‚ano - oczekuje",
          cancelVoucherConfirm: "AnulowaÄ‡ bon?",
          voucherAlreadyUsed: "Ten bon zostaÅ‚ juÅ¼ wykorzystany!",
          voucherExpired: "Czas minÄ…Å‚! Link wygasÅ‚.",
          voucherNotFound: "Nie znaleziono bonu!",
          voucherCancelled: "Ten bon zostaÅ‚ anulowany przez nadawcÄ™.",
          cancelAndRefund: "Anuluj (zwrot dla nadawcy)",
          cancelled: "anulowany",
          refundToSender: "Zwrot dla nadawcy",
          // System online
          onlineAccount: "Konto Online",
          notifications: "Powiadomienia",
          auctionHouse: "Dom Aukcyjny",
          browseAuctions: "PrzeglÄ…daj",
          myAuctions: "Moje",
          createAuction: "Wystaw",
          chooseNameAndPin: "Wybierz nazwÄ™ i PIN (4 cyfry)",
          playerName: "Nazwa gracza",
          register: "Zarejestruj siÄ™",
          login: "Zaloguj siÄ™",
          logout: "Wyloguj",
          onlinePlayers: "Gracze online",
          noPlayersOnline: "Brak graczy online",
          nameTooShort: "Nazwa musi mieÄ‡ min. 2 znaki",
          pinMustBe4: "PIN musi mieÄ‡ 4 cyfry",
          nameTaken: "Ta nazwa jest juÅ¼ zajÄ™ta!",
          registered: "Zarejestrowano!",
          welcome: "Witaj",
          loggedIn: "Zalogowano!",
          playerNotFound: "Nie znaleziono gracza",
          deleteAccount: "UsuÅ„ konto",
          addFriend: "Dodaj znajomego",
          friends: "Znajomi",
          noFriends: "Brak znajomych",
          sendToFriend: "WyÅ›lij do znajomego",
          noFriendsToSend: "Brak znajomych. Dodaj znajomych w Konto Online!",
          wrongPin: "BÅ‚Ä™dny PIN!",
          loginFirst: "Najpierw siÄ™ zaloguj",
          noNotifications: "Brak powiadomieÅ„",
          sentYouVoucher: "wysÅ‚aÅ‚ Ci bon",
          bidOn: "zalicytowaÅ‚",
          wantsToNegotiate: "chce negocjowaÄ‡",
          yourOfferAccepted: "Twoja oferta zaakceptowana!",
          yourOfferRejected: "Twoja oferta odrzucona",
          seller: "Sprzedawca",
          price: "Cena",
          buyNow: "Kup teraz",
          negotiate: "Negocjuj",
          noAuctions: "Brak aukcji",
          noMyAuctions: "Nie masz wystawionych przedmiotÃ³w",
          nothingToSell: "Nie masz nic do wystawienia",
          selectToSell: "Wybierz co chcesz wystawiÄ‡:",
          enterPrice: "Podaj cenÄ™:",
          invalidPrice: "NieprawidÅ‚owa cena",
          auctionCreated: "Wystawiono!",
          enterYourOffer: "Podaj swojÄ… ofertÄ™:",
          offerSent: "WysÅ‚ano ofertÄ™!",
          purchaseSuccess: "Zakup udany!",
          waitingForSeller: "Czekaj na odpowiedÅº sprzedawcy...",
          enterPin: "Wpisz PIN",
          forgotPin: "Nie pamiÄ™tam",
          allow: "PozwÃ³l",
          deny: "OdmÃ³w",
          buyerForgotPin: "KupujÄ…cy nie pamiÄ™ta PIN",
          allowedWithoutPin: "pozwoliÅ‚ kupiÄ‡ bez PIN",
          deniedWithoutPin: "nie pozwoliÅ‚ kupiÄ‡ bez PIN",
          counterOffer: "kontr-oferta",
          enterCounterOffer: "Podaj kontr-ofertÄ™:",
          negotiations: "negocjacji",
          boughtYourItem: "kupiÅ‚ TwÃ³j przedmiot",
          sendToPlayer: "WyÅ›lij do gracza",
          onlineFee: "OpÅ‚ata: 250",
          // Aukcje pakietowe
          selectItemsToSell: "Zaznacz co chcesz wystawiÄ‡:",
          cars: "Auta",
          food: "Jedzenie",
          customInsurance: "WÅ‚asne ubezpieczenie",
          createInsurance: "StwÃ³rz ubezpieczenie",
          selectedItems: "Wybrane",
          totalPrice: "Cena za pakiet",
          listForSale: "Wystaw na sprzedaÅ¼",
          noCars: "Brak aut",
          noFood: "Brak jedzenia",
          selectSomething: "Wybierz coÅ› do wystawienia!",
          insuranceName: "Nazwa ubezpieczenia",
          myInsurance: "Moje ubezpieczenie",
          whatItGives: "Co daje",
          coveragePercent: "Pokrycie napraw",
          paymentInterval: "OpÅ‚ata co ile minut",
          paymentAmount: "Kwota opÅ‚aty",
          add: "Dodaj",
          contents: "ZawartoÅ›Ä‡",
          creationCost: "Koszt stworzenia",
          auctionSummary: "Podsumowanie",
          sellingPrice: "Cena sprzedaÅ¼y",
          youPay: "PÅ‚acisz",
          confirmListing: "WystawiÄ‡?",
          cost: "Koszt",
          confirmCancelAuction: "AnulowaÄ‡ aukcjÄ™? Przedmioty wrÃ³cÄ… do Ciebie.",
          notYourAuction: "To nie Twoja aukcja!",
          auctionCancelled: "Aukcja anulowana!",
          repairs: "napraw",
          chatWith: "Czat z",
          reply: "Odpowiedz",
          noMessages: "Brak wiadomoÅ›ci",
          sendToOnlinePlayer: "WyÅ›lij do gracza online",
          voucherSentTo: "Bon wysÅ‚any do",
          acceptedYourVoucher: "przyjÄ…Å‚ TwÃ³j bon",
          rejectedYourVoucher: "odrzuciÅ‚ TwÃ³j bon",
          voucherRejected: "Bon odrzucony",
          sendToPlayer: "WyÅ›lij do gracza",
          enterPlayerName: "Wpisz nazwÄ™ gracza...",
          orSelectPlayer: "Lub wybierz z listy:",
          allPlayers: "Wszyscy gracze",
          noPlayersYet: "Brak innych graczy",
          findPlayer: "ZnajdÅº gracza",
          nameOrCardNumber: "Numer karty (6 cyfr)...",
          cardNumber: "Numer karty",
          wantsToBeYourFriend: "chce dodaÄ‡ CiÄ™ do znajomych!",
          acceptedYourFriendRequest:
            "zaakceptowaÅ‚ zaproszenie! JesteÅ›cie znajomymi.",
          rejectedYourFriendRequest: "odrzuciÅ‚ zaproszenie do znajomych",
          accept: "Akceptuj",
          reject: "OdrzuÄ‡",
          playerNotFound: "Nie znaleziono gracza",
          cantReceiveOwnVoucher: "Nie moÅ¼esz odebraÄ‡ wÅ‚asnego bonu!",
          sent: "wysÅ‚any",
          total: "Å‚Ä…cznie",
          shippingFee: "opÅ‚ata za przesyÅ‚kÄ™",
          shippingInfo: "Online: +100 zÅ‚ | 30 sek od otwarcia!",
          noShippingFee: "Bez opÅ‚aty za przesyÅ‚kÄ™",
          // Logowanie
          loginTitle: "Zaloguj siÄ™",
          loginDesc:
            "Podaj swÃ³j email Å¼eby mÃ³c wysyÅ‚aÄ‡ i odbieraÄ‡ bony/kupony.",
          loginBtn: "Zaloguj",
          loginPrivacy:
            "Email jest zapisywany tylko lokalnie na Twoim urzÄ…dzeniu.",
          invalidEmail: "Podaj prawidÅ‚owy email!",
          loggedInAs: "Zalogowany jako",
          sameEmailVoucher:
            "Nie moÅ¼esz odebraÄ‡ bonu wysÅ‚anego z tego samego konta!",
          mustLoginFirst: "Musisz siÄ™ najpierw zalogowaÄ‡!",
          shareTo: "UdostÄ™pnij do:",
          sendToOtherSave: "Lub wyÅ›lij na inny zapis:",
          voucherSentToSave: "Bon wysÅ‚any do",
          selectSaveForVoucher: "Na ktÃ³ry zapis przyjÄ…Ä‡ bon?",
          cannotAcceptOwnVoucher: "Nie moÅ¼esz przyjÄ…Ä‡ wÅ‚asnego bonu!",
          vouchersDescription:
            "Bony to wirtualne pieniÄ…dze ktÃ³re moÅ¼esz wysÅ‚aÄ‡ znajomym przez WhatsApp, Messenger, Email lub SMS. Odbiorca moÅ¼e przyjÄ…Ä‡ bon (dostanie pieniÄ…dze) lub przekazaÄ‡ go komuÅ› innemu.",
          // Tryb gry
          selectMode: "Wybierz tryb",
          beamngDesc: "Auta z gry BeamNG.drive - fikcyjne marki",
          simulator: "Symulator",
          reallifeDesc: "Prawdziwe marki aut w realnych cenach (-10%)",
          modeWarning: "KaÅ¼dy tryb ma osobny postÄ™p na tym samym save'ie!",
          // Instrukcje
          earnDesc: "Wykonuj prace aby zarabiaÄ‡ pieniÄ…dze:",
          driverJob: "Kierowca",
          factoryJob: "Praca w fabryce",
          sleepJob: "Sen (AFK)",
          sellCarProfit: "SprzedaÅ¼ auta",
          ofValue: "wartoÅ›ci",
          garageSystem: "System garaÅ¼u",
          garageDesc: "Kupuj, ulepszaj i sprzedawaj auta:",
          upgradeInfo:
            "Kliknij raz - auto ulepsza siÄ™ w tle. WartoÅ›Ä‡ roÅ›nie (50% â†’ 1000%)",
          breakRisk: "Ryzyko zepsucia",
          breakInfo: "0.5%/s szansy na zepsucie. Koszt: 150 zÅ‚ + -5% wartoÅ›ci",
          selling: "SprzedaÅ¼",
          sellInfo: "Cena = cena bazowa Ã— procent ulepszenia",
          payments: "PÅ‚atnoÅ›ci i opÅ‚aty",
          autoPayInfo2:
            "WÅ‚Ä…cz w ustawieniach karty - automatycznie pÅ‚aci podatki i ubezpieczenia",
          debtSystem: "System dÅ‚ugÃ³w",
          debtInfo2: "Brak kasy = dÅ‚ug. Masz 7 dni na spÅ‚atÄ™!",
          insurances: "Ubezpieczenia",
          insuranceDesc: "RÃ³Å¼ne pakiety dajÄ…ce bonusy:",
          healthIns: "Zdrowotne",
          healthInsDesc: "regeneracja HP, jedzenia, picia",
          upgradeIns: "Na ulepszanie",
          upgradeInsDesc: "szybsze ulepszanie, mniejsza szansa zepsucia",
          repairIns: "Na naprawÄ™",
          repairInsDesc: "pokrywa 30-100% kosztÃ³w naprawy",
          survival: "Przetrwanie",
          hungerDrain: "GÅ‚Ã³d",
          thirstDrain: "Pragnienie",
          survivalTip:
            "Kupuj jedzenie i napoje w sklepie, lub wykup ubezpieczenie!",
          voucherSystem: "System bonÃ³w",
          voucherDesc:
            "TwÃ³rz bony pieniÄ™Å¼ne i wysyÅ‚aj znajomym przez WhatsApp, Messenger, Email lub SMS. PieniÄ…dze pobierane sÄ… dopiero gdy odbiorca zaakceptuje bon.",
          value: "wartoÅ›ci",
          // Nowa instrukcja
          workSystem: "System pracy",
          workDesc: "Wybierz zawÃ³d i pracuj 2 minuty w mini-grze:",
          jobsRange: "13 zawodÃ³w od Å‚atwych do trudnych",
          coinGame: "Åapanie monet",
          coinGameDesc: "Klikaj spadajÄ…ce monety +100 zÅ‚ za kaÅ¼dÄ…!",
          sleepMechanic: "Zasypianie",
          sleepMechanicDesc:
            "Trzymaj ekran Å¼eby nie zasnÄ…Ä‡! Spanie = strata do 90% zarobku",
          gameModes: "Tryby gry",
          gameModesDesc:
            "Kliknij tytuÅ‚ gry aby przeÅ‚Ä…czyÄ‡ miÄ™dzy trybem BeamNG (fikcyjne auta) a Real Life (prawdziwe marki). KaÅ¼dy tryb ma osobny postÄ™p!",
          coinsCollected: "Zebrane monety",
          // ÅšmierÄ‡ i checkpointy
          youDied: "ZginÄ…Å‚eÅ›!",
          loadingCheckpoint: "Wczytywanie ostatniego checkpointu...",
          noCheckpoint: "Brak checkpointu",
          noCheckpointReset: "Brak checkpointu - zaczynasz od nowa!",
          checkpoint: "Checkpoint",
          saveCheckpoint: "Zapisz checkpoint",
          checkpointCreated: "Checkpoint utworzony!",
          checkpointInfo: "JeÅ›li zginiesz, wrÃ³cisz do tego momentu.",
          confirmDeleteCheckpoint:
            "UsunÄ…Ä‡ checkpoint? JeÅ›li zginiesz, stracisz caÅ‚y postÄ™p!",
          checkpointDeleted: "Checkpoint usuniÄ™ty!",
          noCheckpointToDelete: "Nie masz checkpointu do usuniÄ™cia!",
          deathWarning: "Uwaga! Jak zdrowie spadnie do 0 - zginiesz!",
          death: "ÅšmierÄ‡",
          deathDesc:
            "GÅ‚Ã³d/woda = 0 â†’ tracisz HP. HP = 0 â†’ zginiesz i wrÃ³cisz do checkpointu!",
          checkpointSystem: "System checkpointÃ³w",
          createCheckpointInfo: "Tworzenie",
          createCheckpointDesc:
            "W menu Save'Ã³w kliknij 'Zapisz checkpoint' Å¼eby zapisaÄ‡ aktualny postÄ™p",
          respawn: "Odrodzenie",
          respawnDesc:
            "Po Å›mierci wrÃ³cisz do checkpointu. Brak checkpointu = reset postÄ™pu!",
        },
        en: {
          yourMoney: "YOUR MONEY",
          debt: "DEBT",
          instructions: "Instructions",
          earnKm: "Earnings (km)",
          repair: "Repair Car",
          buyCar: "Buy Car",
          sellCar: "Sell Car",
          work: "Work",
          garage: "Garage",
          business: "Business",
          createBusiness: "Create Business",
          noBusinesses: "You don't have any businesses yet",
          totalIncomeWeek: "Total income/week",
          totalExpensesWeek: "Total expenses/week",
          netProfitWeek: "Net profit/week",
          workers: "workers",
          createNextBusiness: "Create another business",
          selectCategory: "Select business category",
          businessTypes: "business types",
          back: "Back",
          backToCategories: "Back to categories",
          selectType: "select type",
          startCost: "Start cost",
          clientsPerDay: "Clients/day",
          avgIncomeClient: "Avg. income/client",
          businessName: "Business name",
          notEnoughMoneyBusiness: "You don't have enough money!",
          youNeed: "You need",
          createBusinessFor: "Create business for",
          hiredWorkers: "Hired workers",
          noWorkersYet: "You don't have any workers yet. Hire someone below!",
          candidates: "Job candidates",
          noCandidates: "No candidates. New ones will appear soon.",
          searchCandidates: "Search candidates",
          negotiateTerms: "Negotiate terms",
          expects: "Expects",
          activeClients: "Active clients",
          serve: "Serve",
          simulateDay: "Simulate work day",
          closeBusiness: "Close business",
          backToList: "Back to business list",
          reputation: "Reputation",
          acceptTerms: "Accept terms",
          proposeAmount: "Propose different amount",
          lowerBonus: "Lower commission, higher base?",
          notInterested: "Thank you, we're not interested",
          giveRaise: "Give a raise",
          needWorkers: "You need workers!",
          dayReport: "Work day",
          clients: "clients",
          afterCommission: "after commissions",
          hired: "Hired",
          workerFired: "Worker fired",
          businessClosed: "Business closed",
          businessCreated: "Business created",
          salariesIn: "Salaries in",
          cantAffordSalaries: "Can't afford salaries in",
          addedToDebt: "Added to debt",
          foundCandidates: "Found new candidates!",
          needForRecruitment: "Need for recruitment",
          chatWith: "Chat with",
          greeting1: "Hello! I'm {name}. I'm looking for a job as {position}.",
          greeting2: "Hi! My name is {name} and I'm interested in your job offer.",
          greeting3: "Good day. {name}, looking for employment as {position}.",
          salaryExpectation: "My expectations are about {salary} {currency} weekly, plus {bonus}% commission from generated profits. What do you think?",
          acceptTermsBtn: "Accept terms",
          proposeAmountBtn: "Propose different amount",
          lowerBonusBtn: "Lower commission, higher base?",
          rejectBtn: "Thank you, we're not interested",
          acceptMsg: "I agree to {salary} {currency}/week plus {bonus}% commission. Welcome to the team!",
          workerAcceptMsg: "Great! I'm very happy. When can I start?",
          startNowMsg: "Right away! Welcome aboard.",
          workerThanksMsg: "Thank you! I won't let you down.",
          counterOfferMsg: "I have a different financial proposal...",
          enterSalaryPrompt: "Enter proposed weekly salary:",
          sendOffer: "Send offer",
          proposeSalaryMsg: "I propose {salary} {currency} weekly.",
          workerGreatOffer: "That's a great offer! I accept!",
          workerAcceptLower: "A bit less than I hoped, but deal. Let's do it!",
          workerCounterOffer: "That's a bit low... How about meeting in the middle? {counter} {currency}?",
          workerTooLow: "Sorry, but that's well below my expectations. Minimum {min} {currency}.",
          lowerBonusProposal: "How about {salary} {currency}/week, but {bonus}% commission?",
          workerReasonable: "Hmm... that sounds reasonable. I agree!",
          workerNotGood: "That doesn't work for me. How about {salary} and {bonus}%? That's my final offer.",
          rejectMsg: "Thank you for the conversation, but we're not interested in cooperation.",
          workerUnderstandMsg: "I understand. Thank you for your time. Good luck!",
          backToBusinessBtn: "Back to business",
          bank: "Bank",
          takeCredit: "Take a loan",
          creditAmount: "Loan amount",
          interestRate: "Interest rate",
          monthly: "monthly",
          repaymentPeriod: "Repayment period",
          months: "months",
          monthlyPayment: "Monthly payment",
          totalToRepay: "Total to repay",
          yourCredits: "Your loans",
          noCredits: "You have no loans",
          remaining: "Remaining",
          payRate: "Pay installment",
          payOff: "Pay off",
          creditTaken: "Loan approved!",
          ratePaid: "Installment paid",
          creditPaidOff: "Loan paid off!",
          notEnoughForRate: "Not enough for installment!",
          upgrade: "Upgrade",
          sellValue: "Value",
          sell: "Sell",
          carBroken: "Car broken!",
          cantSellBroken: "Cannot sell broken car!",
          confirmSell: "Sell",
          forPrice: "for",
          sold: "Sold!",
          basePrice: "Base price",
          buyQuestion: "Buy",
          carBought: "Bought",
          upgradeCar: "Upgrading",
          startUpgrade: "Start upgrading",
          stopUpgrade: "Stop",
          upgrading: "Upgrading...",
          upgradeStopped: "Stopped",
          clickToStart: "Click to start",
          upgradeWarning: "Car may break during upgrade! ($150 + -5%)",
          carBrokeMsg: "Car broke! -$150, -5%",
          carBreakDebt: "Car break",
          buyCarFirst: "Buy a car first!",
          chooseJob: "Choose job:",
          bonuses: "bonuses",
          bonus: "bonus",
          stayAwake: "Hold to stay awake!",
          workDone: "Work done!",
          basePay: "Base pay",
          sleepPenalty: "Sleep penalty",
          total: "Total",
          taxes: "Taxes",
          card: "Beam-Pay Card",
          cardRealLife: "Real-Card",
          howToEarn: "How to earn money?",
          perKm: "Per km",
          sellCarTo: "Sell car",
          carPrice: "car price",
          fees: "Fees",
          fuel: "Fuel (max 10)",
          startFuel: "Start: 10 fuel points",
          taxesPer2km: "Taxes (per 2 km)",
          taxesPer10min: "Taxes (per 10 min)",
          repairCost: "Car repair",
          fine: "Fine",
          close: "Close",
          sendScreenshotKm: "Send screenshot with kilometers",
          clickOrDrag: "Click or drag screenshot",
          analyzing: "Analyzing...",
          collectEarnings: "Collect",
          sendScreenshotDamage: "Send screenshot of damaged car",
          repairCostInfo: "Repair cost:",
          payAndRepair: "Pay and repair",
          sendScreenshotCar: "Send screenshot with car price",
          get50percent: "You get 50%",
          buyCarBtn: "Buy",
          sellCarBtn: "Sell",
          taxInfo: "Tax info",
          taxRate: "Rate:",
          totalPaid: "Total paid:",
          nextTax: "Next tax in:",
          autoPay: "Auto pay",
          autoPayDesc: "Card pays automatically",
          debtInfo: "Debt info",
          debtDesc: "No money for tax = debt. 7 days to pay.",
          currentDebt: "Current debt:",
          payDebt: "Pay debt",
          balance: "Balance",
          cardSettings: "Card settings",
          spendingLimit: "Limit:",
          spent: "Spent:",
          remaining: "Left:",
          setLimit: "ğŸ“Š Set limit",
          resetSpent: "ğŸ”„ Reset",
          newLimit: "New limit",
          setLimitBtn: "Set",
          cancel: "Cancel",
          enterPin: "Enter PIN",
          enter6digitPin: "Enter 6-digit PIN",
          limitExceeded: "Limit exceeded!",
          pinRequired: "PIN required",
          transactionExceedsLimit: "Exceeds limit. Enter PIN.",
          enterPinBtn: "Enter PIN",
          selectLanguage: "Select language",
          daysLeft: "days left",
          notEnoughMoney: "Not enough money!",
          invalidScreenshot: "Cannot read data!",
          foundKm: "Found:",
          foundPrice: "Price:",
          noCarFound: "No car found in image!",
          enterKm: "Enter kilometers:",
          enterPrice: "Enter car price:",
          youGet50: "You get 50%:",
          youPay: "You pay:",
          generateQR: "Generate QR code",
          carName: "Car name (e.g. ETK 800)",
          carPricePlaceholder: "Price from screenshot",
          selectCarToSell: "Select car from garage:",
          sendCarPhoto: "Send photo of this car",
          noCarInGarage: "No cars in garage",
          boughtFor: "Bought for",
          inventory: "Inventory",
          health: "Health",
          food: "Food",
          water: "Water",
          foodTab: "Food",
          drinksTab: "Drinks",
          foodFull: "You can't eat more!",
          waterFull: "You can't drink more!",
          shop: "Shop",
          backpackContents: "Backpack contents:",
          emptyBackpack: "Backpack is empty",
          goToShop: "Go to shop to buy food!",
          useItem: "Use",
          tooFull: "You're full!",
          insurance: "Insurance",
          activeInsurances: "Active insurances",
          chooseInsurance: "Choose package:",
          cancelInsurance: "Cancel",
          confirmCancelWithRefund: "Cancel? Refund",
          confirmCancelNoRefund: "Cancel? No refund (used less than 3 times)",
          choosePeriod: "Choose period",
          hour: "Hour",
          day: "Day",
          week: "Week",
          month: "Month",
          perHour: "/hour",
          perDay: "/day",
          perWeek: "/week",
          perMonth: "/month",
          activated: "Activated",
          perHourShort: "/h",
          perDayShort: "/d",
          perWeekShort: "/wk",
          every: "every",
          hour: "Hour",
          day: "Day",
          week: "Week",
          remaining: "Remaining",
          expired: "Expired",
          autoPayments: "Auto payments",
          autoPayInfo: "Taxes and insurance don't count toward limit",
          autoPay: "Auto-pay",
          noActiveInsurance: "No active insurances",
          alreadyHaveInsurance: "You already have this insurance!",
          insuranceDetails: "Details",
          price: "Price",
          totalPaid: "Total paid",
          benefitsReceived: "Benefits received",
          nextPayment: "Next payment",
          refund: "refund",
          noRefund: "no refund",
          // Products - food
          itemBurger: "Burger",
          itemPizza: "Pizza",
          itemHotdog: "Hot Dog",
          itemFries: "Fries",
          itemSandwich: "Sandwich",
          itemSalad: "Salad",
          itemApple: "Apple",
          itemBanana: "Banana",
          itemWatermelon: "Watermelon",
          itemChicken: "Chicken",
          itemSteak: "Steak",
          itemSushi: "Sushi",
          itemDonut: "Donut",
          itemIcecream: "Ice cream",
          itemChocolate: "Chocolate",
          // Products - drinks
          itemWater: "Water",
          itemCola: "Cola",
          itemJuice: "Juice",
          itemCoffee: "Coffee",
          itemTea: "Tea",
          itemMilk: "Milk",
          itemBeer: "Beer",
          itemWine: "Wine",
          itemSmoothie: "Smoothie",
          itemEnergyDrink: "Energy Drink",
          itemLemonade: "Lemonade",
          itemCoconut: "Coconut water",
          // Insurance - names
          insBasic: "Basic",
          insStandard: "Standard",
          insPremium: "Premium",
          insVip: "VIP",
          insUltimate: "Ultimate",
          insHealthBasic: "Health Basic",
          insHealthPlus: "Health Plus",
          insFoodBasic: "Food Basic",
          insFoodPlus: "Food Plus",
          insWaterBasic: "Water Basic",
          insWaterPlus: "Water Plus",
          insHealthFood: "Health + Food",
          insHealthWater: "Health + Water",
          insFoodWater: "Food + Water",
          // Upgrade insurances
          insUpgradeBasic: "Upgrade Basic",
          insUpgradePlus: "Upgrade Plus",
          insUpgradePro: "Upgrade Pro",
          insUpgradeMax: "Upgrade Max",
          insUpgradeBasicDesc: "+0.05%/s, -10% break chance",
          insUpgradePlusDesc: "+0.1%/s, -20% break chance",
          insUpgradeProDesc: "+0.15%/s, -30% break chance",
          insUpgradeMaxDesc: "+0.2%/s, -40% break chance",
          // Repair insurances
          insRepairBasic: "Repair Basic",
          insRepairPlus: "Repair Plus",
          insRepairFull: "Repair Full",
          insRepairBasicDesc: "30% repair costs covered",
          insRepairPlusDesc: "50% repair costs covered",
          insRepairFullDesc: "100% repair costs covered",
          noBrokenCars: "All cars are working!",
          goToGarage: "Go to Garage to upgrade cars",
          carNotBroken: "This car is not broken!",
          repairDebt: "Car repair",
          addedToDebt: "Added to debt",
          insuranceCovered: "Insurance covered",
          coinsCollected: "Coins collected",
          // Saves
          saves: "Saves",
          currentSave: "Current save",
          createSave: "New save",
          deleteSave: "Delete save",
          switchSave: "Switch",
          saveName: "Save name",
          confirmDeleteSave: "Delete this save?",
          cannotDeleteLastSave: "Cannot delete the last save!",
          saveCreated: "Save created!",
          active: "active",
          enterNewName: "Enter new name:",
          // Vouchers
          vouchers: "Vouchers",
          vouchersRealLife: "Coupons",
          createVoucher: "Create voucher",
          createVoucherRealLife: "Create coupon",
          voucherAmount: "Voucher amount",
          voucherMessage: "Message (optional)",
          redeemVoucher: "Redeem voucher",
          enterVoucherCode: "Enter voucher code",
          voucherRedeemed: "Voucher redeemed!",
          invalidVoucher: "Invalid voucher code!",
          voucherCreated: "Voucher created! Code:",
          voucherFrom: "From:",
          yourVouchers: "Your vouchers",
          noVouchers: "No vouchers",
          // Repair
          selectCarToRepair: "Select car to repair:",
          repairSelectedCar: "Repair selected car",
          repaired: "Repaired!",
          // Vouchers - extended
          vouchersToSend: "Vouchers to send",
          receivedVouchers: "Received vouchers",
          sendVoucher: "Send",
          acceptVoucher: "Accept",
          rejectVoucher: "Pass on",
          shareVoucher: "Send voucher",
          copyLink: "Copy link",
          linkCopied: "Link copied!",
          cancelVoucherConfirm: "Cancel voucher? Money will be refunded.",
          youReceivedVoucher: "You received a voucher worth",
          voucherAccepted: "Voucher accepted!",
          noReceivedVouchers: "No received vouchers",
          invalidAmount: "Enter a valid amount!",
          pendingVoucher: "Sent - waiting",
          cancelVoucherConfirm: "Cancel voucher?",
          voucherAlreadyUsed: "This voucher has already been used!",
          voucherExpired: "Time's up! Link expired.",
          voucherNotFound: "Voucher not found!",
          voucherCancelled: "This voucher was cancelled by the sender.",
          cancelAndRefund: "Cancel (refund to sender)",
          cancelled: "cancelled",
          refundToSender: "Refund to sender",
          // Online system
          onlineAccount: "Online Account",
          notifications: "Notifications",
          auctionHouse: "Auction House",
          browseAuctions: "Browse",
          myAuctions: "My auctions",
          createAuction: "Create",
          chooseNameAndPin: "Choose name and PIN (4 digits)",
          playerName: "Player name",
          register: "Register",
          login: "Log in",
          logout: "Log out",
          onlinePlayers: "Players online",
          noPlayersOnline: "No players online",
          nameTooShort: "Name must be at least 2 characters",
          pinMustBe4: "PIN must be 4 digits",
          nameTaken: "This name is already taken!",
          registered: "Registered!",
          welcome: "Welcome",
          loggedIn: "Logged in!",
          playerNotFound: "Player not found",
          deleteAccount: "Delete account",
          addFriend: "Add friend",
          friends: "Friends",
          noFriends: "No friends",
          sendToFriend: "Send to friend",
          noFriendsToSend: "No friends. Add friends in Online Account!",
          wrongPin: "Wrong PIN!",
          loginFirst: "Log in first",
          noNotifications: "No notifications",
          sentYouVoucher: "sent you a voucher",
          bidOn: "bid on",
          wantsToNegotiate: "wants to negotiate",
          yourOfferAccepted: "Your offer was accepted!",
          yourOfferRejected: "Your offer was rejected",
          seller: "Seller",
          price: "Price",
          buyNow: "Buy now",
          negotiate: "Negotiate",
          noAuctions: "No auctions",
          noMyAuctions: "You have no listed items",
          nothingToSell: "Nothing to sell",
          selectToSell: "Select item to sell:",
          enterPrice: "Enter price:",
          invalidPrice: "Invalid price",
          auctionCreated: "Listed!",
          enterYourOffer: "Enter your offer:",
          offerSent: "Offer sent!",
          purchaseSuccess: "Purchase successful!",
          waitingForSeller: "Waiting for seller response...",
          enterPin: "Enter PIN",
          forgotPin: "Forgot PIN",
          allow: "Allow",
          deny: "Deny",
          buyerForgotPin: "Buyer forgot PIN",
          allowedWithoutPin: "allowed purchase without PIN",
          deniedWithoutPin: "denied purchase without PIN",
          counterOffer: "counter-offer",
          enterCounterOffer: "Enter counter-offer:",
          negotiations: "negotiations",
          boughtYourItem: "bought your item",
          sendToPlayer: "Send to player",
          onlineFee: "Fee: 250",
          // Package auctions
          selectItemsToSell: "Select items to sell:",
          cars: "Cars",
          food: "Food",
          customInsurance: "Custom insurance",
          createInsurance: "Create insurance",
          selectedItems: "Selected",
          totalPrice: "Package price",
          listForSale: "List for sale",
          noCars: "No cars",
          noFood: "No food",
          selectSomething: "Select something to sell!",
          insuranceName: "Insurance name",
          myInsurance: "My insurance",
          whatItGives: "What it gives",
          coveragePercent: "Repair coverage",
          paymentInterval: "Payment every X minutes",
          paymentAmount: "Payment amount",
          add: "Add",
          contents: "Contents",
          creationCost: "Creation cost",
          auctionSummary: "Summary",
          sellingPrice: "Selling price",
          youPay: "You pay",
          confirmListing: "List it?",
          cost: "Cost",
          confirmCancelAuction:
            "Cancel auction? Items will be returned to you.",
          notYourAuction: "This is not your auction!",
          auctionCancelled: "Auction cancelled!",
          repairs: "repairs",
          chatWith: "Chat with",
          reply: "Reply",
          noMessages: "No messages",
          sendToOnlinePlayer: "Send to online player",
          voucherSentTo: "Voucher sent to",
          acceptedYourVoucher: "accepted your voucher",
          rejectedYourVoucher: "rejected your voucher",
          voucherRejected: "Voucher rejected",
          sendToPlayer: "Send to player",
          enterPlayerName: "Enter player name...",
          orSelectPlayer: "Or select from list:",
          allPlayers: "All players",
          noPlayersYet: "No other players yet",
          findPlayer: "Find player",
          nameOrCardNumber: "Card number (6 digits)...",
          cardNumber: "Card number",
          wantsToBeYourFriend: "wants to add you as a friend!",
          acceptedYourFriendRequest:
            "accepted your invite! You are now friends.",
          rejectedYourFriendRequest: "rejected your friend request",
          accept: "Accept",
          reject: "Reject",
          playerNotFound: "Player not found",
          cantReceiveOwnVoucher: "You cannot receive your own voucher!",
          sent: "sent",
          total: "total",
          shippingFee: "shipping fee",
          shippingInfo: "Online: +100 fee | 30 sec from opening!",
          noShippingFee: "No shipping fee",
          // Login
          loginTitle: "Log in",
          loginDesc: "Enter your email to send and receive vouchers/coupons.",
          loginBtn: "Log in",
          loginPrivacy: "Email is saved only locally on your device.",
          invalidEmail: "Enter a valid email!",
          loggedInAs: "Logged in as",
          sameEmailVoucher:
            "You cannot receive a voucher sent from the same account!",
          mustLoginFirst: "You must log in first!",
          shareTo: "Share to:",
          sendToOtherSave: "Or send to another save:",
          voucherSentToSave: "Voucher sent to",
          selectSaveForVoucher: "Which save to accept voucher?",
          cannotAcceptOwnVoucher: "Cannot accept your own voucher!",
          vouchersDescription:
            "Vouchers are virtual money you can send to friends via WhatsApp, Messenger, Email or SMS. The recipient can accept the voucher (get the money) or pass it on to someone else.",
          // Game mode
          selectMode: "Select mode",
          beamngDesc: "Cars from BeamNG.drive game - fictional brands",
          simulator: "Simulator",
          reallifeDesc: "Real car brands at realistic prices (-10%)",
          modeWarning: "Each mode has separate progress on the same save!",
          // Instructions
          earnDesc: "Do jobs to earn money:",
          driverJob: "Driver",
          factoryJob: "Factory work",
          sleepJob: "Sleep (AFK)",
          sellCarProfit: "Sell car",
          ofValue: "of value",
          garageSystem: "Garage system",
          garageDesc: "Buy, upgrade and sell cars:",
          upgradeInfo:
            "Click once - car upgrades in background. Value grows (50% â†’ 1000%)",
          breakRisk: "Break risk",
          breakInfo: "0.5%/s chance to break. Cost: 150 zÅ‚ + -5% value",
          selling: "Selling",
          sellInfo: "Price = base price Ã— upgrade percentage",
          payments: "Payments & fees",
          autoPayInfo2:
            "Enable in card settings - auto-pays taxes and insurances",
          debtSystem: "Debt system",
          debtInfo2: "No cash = debt. You have 7 days to pay!",
          insurances: "Insurances",
          insuranceDesc: "Various packages with bonuses:",
          healthIns: "Health",
          healthInsDesc: "regenerates HP, food, water",
          upgradeIns: "Upgrade",
          upgradeInsDesc: "faster upgrading, lower break chance",
          repairIns: "Repair",
          repairInsDesc: "covers 30-100% of repair costs",
          survival: "Survival",
          hungerDrain: "Hunger",
          thirstDrain: "Thirst",
          survivalTip: "Buy food and drinks in shop, or get insurance!",
          voucherSystem: "Voucher system",
          voucherDesc:
            "Create money vouchers and send to friends via WhatsApp, Messenger, Email or SMS. Money is deducted only when recipient accepts the voucher.",
          value: "value",
          // New instructions
          workSystem: "Work system",
          workDesc: "Choose a job and work 2 minutes in mini-game:",
          jobsRange: "13 jobs from easy to hard",
          coinGame: "Catching coins",
          coinGameDesc: "Click falling coins +100 zÅ‚ each!",
          sleepMechanic: "Falling asleep",
          sleepMechanicDesc:
            "Hold screen to stay awake! Sleeping = lose up to 90% of earnings",
          gameModes: "Game modes",
          gameModesDesc:
            "Click game title to switch between BeamNG mode (fictional cars) and Real Life (real brands). Each mode has separate progress!",
          coinsCollected: "Coins collected",
          // Death and checkpoints
          youDied: "You died!",
          loadingCheckpoint: "Loading last checkpoint...",
          noCheckpoint: "No checkpoint",
          noCheckpointReset: "No checkpoint - starting over!",
          checkpoint: "Checkpoint",
          saveCheckpoint: "Save checkpoint",
          checkpointCreated: "Checkpoint created!",
          checkpointInfo: "If you die, you'll return to this moment.",
          confirmDeleteCheckpoint:
            "Delete checkpoint? If you die, you'll lose all progress!",
          checkpointDeleted: "Checkpoint deleted!",
          noCheckpointToDelete: "No checkpoint to delete!",
          deathWarning: "Warning! If health drops to 0 - you die!",
          death: "Death",
          deathDesc:
            "Hunger/water = 0 â†’ lose HP. HP = 0 â†’ you die and return to checkpoint!",
          checkpointSystem: "Checkpoint system",
          createCheckpointInfo: "Creating",
          createCheckpointDesc:
            "In Saves menu click 'Save checkpoint' to save current progress",
          respawn: "Respawn",
          respawnDesc:
            "After death you'll return to checkpoint. No checkpoint = progress reset!",
        },
      };

      Object.keys(languages).forEach((lang) => {
        if (!translations[lang]) translations[lang] = translations.en;
      });

      let currentLang = localStorage.getItem("beamng_lang") || "pl";

      // ==================== SYSTEM SAVE'Ã“W ====================
      let saves = JSON.parse(localStorage.getItem("beamng_saves")) || [];
      let currentSaveId = localStorage.getItem("beamng_currentSave") || null;

      // Upewnij siÄ™ Å¼e jest minimum 1 save
      function ensureDefaultSave() {
        if (saves.length === 0) {
          const newSave = createNewSaveData("Save 1");
          saves.push(newSave);
          currentSaveId = newSave.id;
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          localStorage.setItem("beamng_currentSave", currentSaveId);
        }
        if (!currentSaveId || !saves.find((s) => s.id === currentSaveId)) {
          currentSaveId = saves[0].id;
          localStorage.setItem("beamng_currentSave", currentSaveId);
        }
      }

      function createNewSaveData(name) {
        const defaultModeData = {
          money: 1500,
          garage: [],
          spent: 0,
          debt: 0,
          debtDeadline: null,
          totalTaxPaid: 0,
          health: 100,
          food: 1000,
          water: 1000,
          backpack: [],
          activeInsurances: [],
          businesses: [],
          credits: [],
          workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
          vouchersToSend: [],
          receivedVouchers: [],
        };
        
        return {
          id: "save_" + Date.now(),
          name: name,
          createdAt: Date.now(),
          data: {
            limit: 10000,
            autoPay: false,
            lastTaxTime: Date.now(),
            lastHungerTime: Date.now(),
          },
          // Osobne dane dla kaÅ¼dego trybu
          beamngData: { ...defaultModeData },
          realLifeData: { ...defaultModeData },
        };
      }

      // InterwaÅ‚y ulepszania aut - musi byÄ‡ przed loadSaveData
      let upgradeIntervals = {};

      // Tryb gry - musi byÄ‡ przed loadSaveData
      let gameMode = localStorage.getItem("beamng_gameMode") || "beamng";

      // getCurrentCars() jest zdefiniowane po listach aut (beamngCars, realLifeCars)

      function getCurrentSave() {
        return saves.find((s) => s.id === currentSaveId);
      }

      function loadSaveData() {
        const save = getCurrentSave();
        if (!save) return;

        // Zatrzymaj wszystkie aktywne ulepszania przed zaÅ‚adowaniem nowego save'a
        Object.keys(upgradeIntervals).forEach((idx) => {
          clearInterval(upgradeIntervals[idx]);
        });
        upgradeIntervals = {};

        // ZaÅ‚aduj dane wspÃ³lne (limit, autoPay, lastTaxTime)
        // cardCode jest globalny dla urzÄ…dzenia - nie Å‚aduj z save
        const d = save.data || {};
        pin = cardCode;
        limit = d.limit || 10000;
        autoPay = d.autoPay || false;
        lastTaxTime = d.lastTaxTime || Date.now();
        lastHungerTime = d.lastHungerTime || Date.now();

        // ZaÅ‚aduj dane specyficzne dla trybu
        const modeKey = gameMode === "reallife" ? "realLifeData" : "beamngData";
        
        // UtwÃ³rz strukturÄ™ modeData jeÅ›li nie istnieje
        if (!save[modeKey]) {
          save[modeKey] = {
            money: 1500, garage: [], spent: 0, debt: 0, debtDeadline: null,
            totalTaxPaid: 0, health: 100, food: 1000, water: 1000, backpack: [],
            activeInsurances: [], businesses: [], credits: [],
            workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
            vouchersToSend: [], receivedVouchers: []
          };
          // Migruj stare dane jeÅ›li istniejÄ…
          if (d.money !== undefined) {
            save[modeKey].money = d.money;
            save[modeKey].garage = d.garage || [];
            save[modeKey].spent = d.spent || 0;
            save[modeKey].debt = d.debt || 0;
            save[modeKey].debtDeadline = d.debtDeadline || null;
            save[modeKey].totalTaxPaid = d.totalTaxPaid || 0;
            save[modeKey].health = d.health || 100;
            save[modeKey].food = d.food || 1000;
            save[modeKey].water = d.water || 1000;
            save[modeKey].backpack = d.backpack || [];
            save[modeKey].activeInsurances = d.insurances || [];
            save[modeKey].businesses = d.businesses || [];
            save[modeKey].credits = d.credits || [];
            save[modeKey].workExperience = d.workExperience || { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            save[modeKey].vouchersToSend = d.vouchersToSend || [];
            save[modeKey].receivedVouchers = d.receivedVouchers || [];
          }
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
        }
        
        const modeData = save[modeKey];

        money = modeData.money !== undefined ? modeData.money : 1500;
        garage = modeData.garage || [];
        spent = modeData.spent || 0;
        debt = modeData.debt || 0;
        debtDeadline = modeData.debtDeadline || null;
        totalTaxPaid = modeData.totalTaxPaid || 0;
        health = modeData.health || 100;
        food = modeData.food || 1000;
        water = modeData.water || 1000;
        backpack = modeData.backpack || [];
        activeInsurances = modeData.activeInsurances || [];

        // WznÃ³w ulepszania aut
        resumeUpgrades();
      }

      function saveSaveData() {
        const save = getCurrentSave();
        if (!save) return;

        // Zapisz dane wspÃ³lne (cardCode jest globalny w localStorage)
        save.data.limit = limit;
        save.data.autoPay = autoPay;
        save.data.lastTaxTime = lastTaxTime;
        save.data.lastHungerTime = lastHungerTime;

        // Zapisz dane specyficzne dla trybu - ZACHOWAJ istniejÄ…ce dane jak businesses, credits
        const modeKey = gameMode === "reallife" ? "realLifeData" : "beamngData";
        
        // Najpierw zachowaj istniejÄ…ce dane ktÃ³re sÄ… zapisywane osobno
        const existingBusinesses = save[modeKey]?.businesses || [];
        const existingCredits = save[modeKey]?.credits || [];
        const existingWorkExp = save[modeKey]?.workExperience || { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        const existingVouchersToSend = save[modeKey]?.vouchersToSend || [];
        const existingReceivedVouchers = save[modeKey]?.receivedVouchers || [];
        
        save[modeKey] = {
          money: money,
          garage: [...garage],
          spent: spent,
          debt: debt,
          debtDeadline: debtDeadline,
          totalTaxPaid: totalTaxPaid,
          health: health,
          food: food,
          water: water,
          backpack: [...backpack],
          activeInsurances: [...activeInsurances],
          // Zachowaj dane zapisywane przez inne funkcje
          businesses: existingBusinesses,
          credits: existingCredits,
          workExperience: existingWorkExp,
          vouchersToSend: existingVouchersToSend,
          receivedVouchers: existingReceivedVouchers,
        };

        localStorage.setItem("beamng_saves", JSON.stringify(saves));
      }

      function createSave(name) {
        const newSave = createNewSaveData(name);
        saves.push(newSave);
        localStorage.setItem("beamng_saves", JSON.stringify(saves));
        return newSave;
      }

      function deleteSave(saveId) {
        if (saves.length <= 1) {
          alert(
            translations[currentLang].cannotDeleteLastSave ||
              "Nie moÅ¼na usunÄ…Ä‡ ostatniego save!"
          );
          return false;
        }
        const idx = saves.findIndex((s) => s.id === saveId);
        if (idx === -1) return false;

        saves.splice(idx, 1);
        localStorage.setItem("beamng_saves", JSON.stringify(saves));

        if (currentSaveId === saveId) {
          currentSaveId = saves[0].id;
          localStorage.setItem("beamng_currentSave", currentSaveId);
          loadSaveData();
        }
        return true;
      }

      function switchSave(saveId) {
        if (currentSaveId === saveId) return;

        // Zapisz obecny stan
        saveSaveData();

        // PrzeÅ‚Ä…cz na nowy save
        currentSaveId = saveId;
        localStorage.setItem("beamng_currentSave", currentSaveId);

        // ZaÅ‚aduj dane nowego save'a
        loadSaveData();
        updateAllDisplays();
      }

      // ==================== DÅ¹WIÄ˜KI ====================
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      let audioCtx = null;

      function initAudio() {
        if (!audioCtx) {
          audioCtx = new AudioContext();
        }
        if (audioCtx.state === "suspended") {
          audioCtx.resume();
        }
      }

      // Generowanie dÅºwiÄ™kÃ³w syntetycznych
      function playSound(type) {
        initAudio();
        if (!audioCtx) return;

        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        switch (type) {
          case "coin": // ZÅ‚apanie monety - wysoki dÅºwiÄ™k
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(
              1760,
              audioCtx.currentTime + 0.1
            );
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.15
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.15);
            break;

          case "buy": // Kupno - kasa
            oscillator.frequency.setValueAtTime(523, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(
              659,
              audioCtx.currentTime + 0.1
            );
            oscillator.frequency.setValueAtTime(
              784,
              audioCtx.currentTime + 0.2
            );
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.3
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.3);
            break;

          case "sell": // SprzedaÅ¼ - cha-ching
            oscillator.frequency.setValueAtTime(1318, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(
              1568,
              audioCtx.currentTime + 0.08
            );
            gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.2
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.2);
            break;

          case "error": // BÅ‚Ä…d - niski dÅºwiÄ™k
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(
              100,
              audioCtx.currentTime + 0.2
            );
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.25
            );
            oscillator.type = "sawtooth";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.25);
            break;

          case "success": // Sukces - fanfara
            oscillator.frequency.setValueAtTime(523, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(
              659,
              audioCtx.currentTime + 0.1
            );
            oscillator.frequency.setValueAtTime(
              784,
              audioCtx.currentTime + 0.2
            );
            oscillator.frequency.setValueAtTime(
              1047,
              audioCtx.currentTime + 0.3
            );
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.5
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
            break;

          case "click": // KlikniÄ™cie przycisku
            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.05
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.05);
            break;

          case "eat": // Jedzenie
            oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(
              350,
              audioCtx.currentTime + 0.05
            );
            oscillator.frequency.setValueAtTime(
              300,
              audioCtx.currentTime + 0.1
            );
            gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.15
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.15);
            break;

          case "drink": // Picie
            oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(
              200,
              audioCtx.currentTime + 0.2
            );
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.25
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.25);
            break;

          case "repair": // Naprawa
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(
              400,
              audioCtx.currentTime + 0.1
            );
            oscillator.frequency.setValueAtTime(
              300,
              audioCtx.currentTime + 0.2
            );
            oscillator.frequency.setValueAtTime(
              500,
              audioCtx.currentTime + 0.3
            );
            gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.4
            );
            oscillator.type = "square";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.4);
            break;

          case "break": // Zepsucie
            oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(
              50,
              audioCtx.currentTime + 0.5
            );
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.5
            );
            oscillator.type = "sawtooth";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
            break;

          case "upgrade": // Ulepszenie tick
            oscillator.frequency.setValueAtTime(
              800 + Math.random() * 200,
              audioCtx.currentTime
            );
            gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.05
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.05);
            break;

          case "workStart": // Start pracy
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(
              554,
              audioCtx.currentTime + 0.15
            );
            oscillator.frequency.setValueAtTime(
              659,
              audioCtx.currentTime + 0.3
            );
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.45
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.45);
            break;

          case "workEnd": // Koniec pracy
            oscillator.frequency.setValueAtTime(659, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(
              784,
              audioCtx.currentTime + 0.15
            );
            oscillator.frequency.setValueAtTime(
              1047,
              audioCtx.currentTime + 0.3
            );
            gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.5
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
            break;

          case "voucher": // Bon
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(
              1100,
              audioCtx.currentTime + 0.1
            );
            oscillator.frequency.setValueAtTime(
              1320,
              audioCtx.currentTime + 0.2
            );
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.35
            );
            oscillator.type = "sine";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.35);
            break;

          case "insurance": // Ubezpieczenie
            oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(
              600,
              audioCtx.currentTime + 0.1
            );
            oscillator.frequency.setValueAtTime(
              700,
              audioCtx.currentTime + 0.2
            );
            gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + 0.3
            );
            oscillator.type = "triangle";
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.3);
            break;
        }
      }

      // ==================== STAN GRY ====================
      let money = 1500;
      // Kod karty - globalny dla urzÄ…dzenia (nie per save)
      let cardCode = localStorage.getItem("beamng_device_card_code");
      if (!cardCode) {
        cardCode = generateCardCodeSync();
        localStorage.setItem("beamng_device_card_code", cardCode);
      }
      let pin = cardCode;
      let limit = 10000;
      let spent = 0;
      let debt = 0;
      let debtDeadline = null;
      let totalTaxPaid = 0;
      let autoPay = false;
      let lastTaxTime = Date.now();
      let garage = [];

      // Jedzenie/Picie/Zdrowie
      let health = 100;
      let food = 1000;
      let water = 1000;
      let backpack = [];
      let lastHungerTime = Date.now();
      const MAX_HEALTH = 100;
      const MAX_FOOD = 1000;
      const MAX_WATER = 1000;
      const HUNGER_INTERVAL = 5 * 60 * 1000; // Co 5 minut
      const FOOD_DECAY = 50; // -50 kcal co 5 min
      const WATER_DECAY = 80; // -80 ml co 5 min

      // Ubezpieczenia - wiele aktywnych, pÅ‚atnoÅ›ci cykliczne (godzina/dzieÅ„/tydzieÅ„)
      let activeInsurances = [];

      const insurancePackages = [
        // Combo
        {
          id: "basic",
          nameKey: "insBasic",
          icon: "ğŸ’Š",
          prices: { hour: 50, day: 200, week: 1000 },
          interval: 10,
          benefits: { hp: 3, kcal: 20, ml: 30 },
          descKey: "insBasicDesc",
        },

        {
          id: "standard",
          nameKey: "insStandard",
          icon: "ğŸ¥",
          prices: { hour: 100, day: 400, week: 2000 },
          interval: 10,
          benefits: { hp: 5, kcal: 40, ml: 50 },
          descKey: "insStandardDesc",
        },

        {
          id: "premium",
          nameKey: "insPremium",
          icon: "â­",
          prices: { hour: 180, day: 700, week: 3500 },
          interval: 8,
          benefits: { hp: 8, kcal: 50, ml: 60 },
          descKey: "insPremiumDesc",
        },

        {
          id: "vip",
          nameKey: "insVip",
          icon: "ğŸ‘‘",
          prices: { hour: 300, day: 1200, week: 6000 },
          interval: 5,
          benefits: { hp: 10, kcal: 60, ml: 80 },
          descKey: "insVipDesc",
        },

        {
          id: "ultimate",
          nameKey: "insUltimate",
          icon: "ğŸ’",
          prices: { hour: 500, day: 2000, week: 10000 },
          interval: 5,
          benefits: { hp: 15, kcal: 80, ml: 100 },
          descKey: "insUltimateDesc",
        },

        // Zdrowie
        {
          id: "health_basic",
          nameKey: "insHealthBasic",
          icon: "â¤ï¸",
          prices: { hour: 40, day: 150, week: 800 },
          interval: 10,
          benefits: { hp: 8, kcal: 0, ml: 0 },
          descKey: "insHealthBasicDesc",
        },

        {
          id: "health_plus",
          nameKey: "insHealthPlus",
          icon: "â¤ï¸â€ğŸ”¥",
          prices: { hour: 80, day: 300, week: 1500 },
          interval: 8,
          benefits: { hp: 15, kcal: 0, ml: 0 },
          descKey: "insHealthPlusDesc",
        },

        // Jedzenie
        {
          id: "food_basic",
          nameKey: "insFoodBasic",
          icon: "ğŸ",
          prices: { hour: 30, day: 120, week: 600 },
          interval: 10,
          benefits: { hp: 0, kcal: 60, ml: 0 },
          descKey: "insFoodBasicDesc",
        },

        {
          id: "food_plus",
          nameKey: "insFoodPlus",
          icon: "ğŸ”",
          prices: { hour: 70, day: 280, week: 1400 },
          interval: 8,
          benefits: { hp: 0, kcal: 120, ml: 0 },
          descKey: "insFoodPlusDesc",
        },

        // Picie
        {
          id: "water_basic",
          nameKey: "insWaterBasic",
          icon: "ğŸ’§",
          prices: { hour: 25, day: 100, week: 500 },
          interval: 10,
          benefits: { hp: 0, kcal: 0, ml: 80 },
          descKey: "insWaterBasicDesc",
        },

        {
          id: "water_plus",
          nameKey: "insWaterPlus",
          icon: "ğŸŒŠ",
          prices: { hour: 60, day: 250, week: 1200 },
          interval: 8,
          benefits: { hp: 0, kcal: 0, ml: 150 },
          descKey: "insWaterPlusDesc",
        },

        // Mix 2 w 1
        {
          id: "health_food",
          nameKey: "insHealthFood",
          icon: "ğŸ",
          prices: { hour: 60, day: 250, week: 1200 },
          interval: 10,
          benefits: { hp: 5, kcal: 50, ml: 0 },
          descKey: "insHealthFoodDesc",
        },

        {
          id: "health_water",
          nameKey: "insHealthWater",
          icon: "ğŸ’¦",
          prices: { hour: 55, day: 220, week: 1100 },
          interval: 10,
          benefits: { hp: 5, kcal: 0, ml: 60 },
          descKey: "insHealthWaterDesc",
        },

        {
          id: "food_water",
          nameKey: "insFoodWater",
          icon: "ğŸ¥—",
          prices: { hour: 50, day: 200, week: 1000 },
          interval: 10,
          benefits: { hp: 0, kcal: 50, ml: 60 },
          descKey: "insFoodWaterDesc",
        },

        // === UBEZPIECZENIA NA ULEPSZANIE AUT ===
        {
          id: "upgrade_basic",
          nameKey: "insUpgradeBasic",
          icon: "ğŸ”§",
          type: "upgrade",
          prices: { hour: 80, day: 300, week: 1500 },
          rateBonus: 0.05,
          safetyBonus: 0.001,
          descKey: "insUpgradeBasicDesc",
        },

        {
          id: "upgrade_plus",
          nameKey: "insUpgradePlus",
          icon: "âš™ï¸",
          type: "upgrade",
          prices: { hour: 150, day: 600, week: 3000 },
          rateBonus: 0.1,
          safetyBonus: 0.002,
          descKey: "insUpgradePlusDesc",
        },

        {
          id: "upgrade_pro",
          nameKey: "insUpgradePro",
          icon: "ğŸ› ï¸",
          type: "upgrade",
          prices: { hour: 250, day: 1000, week: 5000 },
          rateBonus: 0.15,
          safetyBonus: 0.003,
          descKey: "insUpgradeProDesc",
        },

        {
          id: "upgrade_max",
          nameKey: "insUpgradeMax",
          icon: "ğŸï¸",
          type: "upgrade",
          prices: { hour: 400, day: 1600, week: 8000 },
          rateBonus: 0.2,
          safetyBonus: 0.004,
          descKey: "insUpgradeMaxDesc",
        },

        // === UBEZPIECZENIA NA NAPRAWÄ˜ ===
        {
          id: "repair_basic",
          nameKey: "insRepairBasic",
          icon: "ğŸ©¹",
          type: "repair",
          prices: { hour: 30, day: 120, week: 600 },
          coveragePercent: 30,
          descKey: "insRepairBasicDesc",
        },

        {
          id: "repair_plus",
          nameKey: "insRepairPlus",
          icon: "ğŸ—ï¸",
          type: "repair",
          prices: { hour: 60, day: 240, week: 1200 },
          coveragePercent: 50,
          descKey: "insRepairPlusDesc",
        },

        {
          id: "repair_full",
          nameKey: "insRepairFull",
          icon: "ğŸ›¡ï¸",
          type: "repair",
          prices: { hour: 100, day: 400, week: 2000 },
          coveragePercent: 100,
          descKey: "insRepairFullDesc",
        },
      ];

      // Funkcja do pobierania nazwy ubezpieczenia
      function getInsuranceName(pkg) {
        const t = translations[currentLang] || translations.en;
        return t[pkg.nameKey] || pkg.nameKey;
      }

      function getInsuranceDesc(pkg) {
        const t = translations[currentLang] || translations.en;
        if (t[pkg.descKey]) return t[pkg.descKey];

        if (pkg.type === "upgrade") {
          return `+${pkg.rateBonus}%/s, -${Math.floor(
            ((pkg.safetyBonus * 1000) / 0.005) * 10
          )}% ${t.breakChance || "szansy zepsucia"}`;
        }
        if (pkg.type === "repair") {
          return `${pkg.coveragePercent}% ${
            t.repairCovered || "kosztÃ³w naprawy pokryte"
          }`;
        }

        return `+${pkg.benefits.hp} HP, +${pkg.benefits.kcal} kcal, +${pkg.benefits.ml} ml`;
      }

      let currentPin = "";
      let pendingAction = null;
      let currentEarnAmount = 0;
      let currentBuyPrice = 0;
      let currentSellPrice = 0;
      let selectedCarIndex = -1;
      const REPAIR_COST = 5000;

      // Produkty - jedzenie
      const foodItems = [
        {
          id: "burger",
          icon: "ğŸ”",
          nameKey: "itemBurger",
          price: 150,
          kcal: 350,
          ml: 0,
          hp: -5,
        },
        {
          id: "pizza",
          icon: "ğŸ•",
          nameKey: "itemPizza",
          price: 200,
          kcal: 400,
          ml: 0,
          hp: -5,
        },
        {
          id: "hotdog",
          icon: "ğŸŒ­",
          nameKey: "itemHotdog",
          price: 100,
          kcal: 250,
          ml: 0,
          hp: -3,
        },
        {
          id: "fries",
          icon: "ğŸŸ",
          nameKey: "itemFries",
          price: 80,
          kcal: 300,
          ml: 0,
          hp: -5,
        },
        {
          id: "sandwich",
          icon: "ğŸ¥ª",
          nameKey: "itemSandwich",
          price: 120,
          kcal: 280,
          ml: 0,
          hp: 0,
        },
        {
          id: "salad",
          icon: "ğŸ¥—",
          nameKey: "itemSalad",
          price: 180,
          kcal: 150,
          ml: 50,
          hp: 10,
        },
        {
          id: "apple",
          icon: "ğŸ",
          nameKey: "itemApple",
          price: 30,
          kcal: 80,
          ml: 50,
          hp: 5,
        },
        {
          id: "banana",
          icon: "ğŸŒ",
          nameKey: "itemBanana",
          price: 25,
          kcal: 100,
          ml: 20,
          hp: 3,
        },
        {
          id: "watermelon",
          icon: "ğŸ‰",
          nameKey: "itemWatermelon",
          price: 60,
          kcal: 50,
          ml: 200,
          hp: 8,
        },
        {
          id: "chicken",
          icon: "ğŸ—",
          nameKey: "itemChicken",
          price: 220,
          kcal: 350,
          ml: 0,
          hp: 5,
        },
        {
          id: "steak",
          icon: "ğŸ¥©",
          nameKey: "itemSteak",
          price: 350,
          kcal: 450,
          ml: 0,
          hp: 10,
        },
        {
          id: "sushi",
          icon: "ğŸ£",
          nameKey: "itemSushi",
          price: 280,
          kcal: 200,
          ml: 30,
          hp: 8,
        },
        {
          id: "donut",
          icon: "ğŸ©",
          nameKey: "itemDonut",
          price: 40,
          kcal: 250,
          ml: 0,
          hp: -8,
        },
        {
          id: "icecream",
          icon: "ğŸ¦",
          nameKey: "itemIcecream",
          price: 50,
          kcal: 200,
          ml: 30,
          hp: -3,
        },
        {
          id: "chocolate",
          icon: "ğŸ«",
          nameKey: "itemChocolate",
          price: 35,
          kcal: 300,
          ml: 0,
          hp: -5,
        },
      ];

      // Produkty - napoje
      const drinkItems = [
        {
          id: "water",
          icon: "ğŸ’§",
          nameKey: "itemWater",
          price: 20,
          kcal: 0,
          ml: 500,
          hp: 5,
        },
        {
          id: "cola",
          icon: "ğŸ¥¤",
          nameKey: "itemCola",
          price: 40,
          kcal: 150,
          ml: 330,
          hp: -5,
        },
        {
          id: "juice",
          icon: "ğŸ§ƒ",
          nameKey: "itemJuice",
          price: 50,
          kcal: 100,
          ml: 250,
          hp: 3,
        },
        {
          id: "coffee",
          icon: "â˜•",
          nameKey: "itemCoffee",
          price: 60,
          kcal: 20,
          ml: 200,
          hp: 0,
        },
        {
          id: "tea",
          icon: "ğŸµ",
          nameKey: "itemTea",
          price: 40,
          kcal: 5,
          ml: 250,
          hp: 5,
        },
        {
          id: "milk",
          icon: "ğŸ¥›",
          nameKey: "itemMilk",
          price: 35,
          kcal: 80,
          ml: 300,
          hp: 5,
        },
        {
          id: "beer",
          icon: "ğŸº",
          nameKey: "itemBeer",
          price: 80,
          kcal: 150,
          ml: 500,
          hp: -10,
        },
        {
          id: "wine",
          icon: "ğŸ·",
          nameKey: "itemWine",
          price: 150,
          kcal: 120,
          ml: 150,
          hp: -8,
        },
        {
          id: "smoothie",
          icon: "ğŸ¥¤",
          nameKey: "itemSmoothie",
          price: 100,
          kcal: 180,
          ml: 400,
          hp: 10,
        },
        {
          id: "energydrink",
          icon: "âš¡",
          nameKey: "itemEnergyDrink",
          price: 70,
          kcal: 100,
          ml: 250,
          hp: -15,
        },
        {
          id: "lemonade",
          icon: "ğŸ‹",
          nameKey: "itemLemonade",
          price: 45,
          kcal: 80,
          ml: 300,
          hp: 3,
        },
        {
          id: "coconut",
          icon: "ğŸ¥¥",
          nameKey: "itemCoconut",
          price: 90,
          kcal: 50,
          ml: 350,
          hp: 8,
        },
      ];

      // Funkcja do pobierania nazwy produktu
      function getItemName(item) {
        const t = translations[currentLang] || translations.en;
        return t[item.nameKey] || item.nameKey;
      }

      let currentShopTab = "food";

      // Lista wszystkich aut z BeamNG.drive z cenami
      const beamngCars = [
        // Autobello
        {
          id: "autobuggy",
          brand: "Autobello",
          model: "Autobuggy",
          year: "2018-2022",
          price: 45000,
          type: "buggy",
        },
        {
          id: "piccolina",
          brand: "Autobello",
          model: "Piccolina",
          year: "1957-1973",
          price: 8000,
          type: "classic",
        },
        {
          id: "stambecco",
          brand: "Autobello",
          model: "Stambecco",
          year: "1971-1988",
          price: 15000,
          type: "offroad",
        },

        // Bruckell
        {
          id: "bastion",
          brand: "Bruckell",
          model: "Bastion",
          year: "2016-2022",
          price: 42000,
          type: "muscle",
        },
        {
          id: "legran",
          brand: "Bruckell",
          model: "LeGran",
          year: "1984-1993",
          price: 12000,
          type: "sedan",
        },
        {
          id: "moonhawk",
          brand: "Bruckell",
          model: "Moonhawk",
          year: "1973-1978",
          price: 25000,
          type: "muscle",
        },
        {
          id: "nine",
          brand: "Bruckell",
          model: "Nine",
          year: "1933-1934",
          price: 35000,
          type: "classic",
        },

        // Burnside
        {
          id: "special",
          brand: "Burnside",
          model: "Special",
          year: "1952-1954",
          price: 28000,
          type: "classic",
        },

        // Cherrier
        {
          id: "tograc",
          brand: "Cherrier",
          model: "Tograc",
          year: "2020-2024",
          price: 38000,
          type: "suv",
        },
        {
          id: "vivace",
          brand: "Cherrier",
          model: "Vivace",
          year: "2020-2024",
          price: 32000,
          type: "hatchback",
        },

        // Civetta
        {
          id: "bolide",
          brand: "Civetta",
          model: "Bolide",
          year: "1981-1988",
          price: 85000,
          type: "supercar",
        },
        {
          id: "scintilla",
          brand: "Civetta",
          model: "Scintilla",
          year: "2020-2022",
          price: 120000,
          type: "supercar",
        },

        // ETK
        {
          id: "etk800",
          brand: "ETK",
          model: "800 Series",
          year: "2013-2018",
          price: 55000,
          type: "sedan",
        },
        {
          id: "etkiseries",
          brand: "ETK",
          model: "I-Series",
          year: "1985-1993",
          price: 18000,
          type: "coupe",
        },
        {
          id: "etkkseries",
          brand: "ETK",
          model: "K-Series",
          year: "2015-2021",
          price: 75000,
          type: "suv",
        },

        // FPU
        {
          id: "wydra",
          brand: "FPU",
          model: "Wydra",
          year: "2008-2023",
          price: 22000,
          type: "military",
        },

        // Gavril
        {
          id: "barstow",
          brand: "Gavril",
          model: "Barstow",
          year: "1969-1971",
          price: 35000,
          type: "muscle",
        },
        {
          id: "bluebuck",
          brand: "Gavril",
          model: "Bluebuck",
          year: "1962-1963",
          price: 32000,
          type: "classic",
        },
        {
          id: "dseries",
          brand: "Gavril",
          model: "D-Series",
          year: "1986-2003",
          price: 28000,
          type: "pickup",
        },
        {
          id: "grandmarshal",
          brand: "Gavril",
          model: "Grand Marshal",
          year: "1990-1997",
          price: 18000,
          type: "sedan",
        },
        {
          id: "hseries",
          brand: "Gavril",
          model: "H-Series",
          year: "1993-2017",
          price: 35000,
          type: "van",
        },
        {
          id: "roamer",
          brand: "Gavril",
          model: "Roamer",
          year: "1992-2005",
          price: 32000,
          type: "suv",
        },
        {
          id: "tseries",
          brand: "Gavril",
          model: "T-Series",
          year: "1972-1986",
          price: 65000,
          type: "truck",
        },
        {
          id: "mdseries",
          brand: "Gavril",
          model: "MD-Series",
          year: "1986-1998",
          price: 45000,
          type: "truck",
        },

        // Hirochi
        {
          id: "aurata",
          brand: "Hirochi",
          model: "Aurata",
          year: "2016-2022",
          price: 42000,
          type: "sport",
        },
        {
          id: "esbr",
          brand: "Hirochi",
          model: "eSBR",
          year: "2013-2020",
          price: 95000,
          type: "electric",
        },
        {
          id: "sbr4",
          brand: "Hirochi",
          model: "SBR4",
          year: "2013-2020",
          price: 68000,
          type: "sport",
        },
        {
          id: "sunburst",
          brand: "Hirochi",
          model: "Sunburst",
          year: "2009-2014",
          price: 28000,
          type: "sport",
        },

        // Ibishu
        {
          id: "200bx",
          brand: "Ibishu",
          model: "200BX",
          year: "1990-1994",
          price: 15000,
          type: "coupe",
        },
        {
          id: "240bx",
          brand: "Ibishu",
          model: "240BX",
          year: "1990-1994",
          price: 18000,
          type: "coupe",
        },
        {
          id: "covet",
          brand: "Ibishu",
          model: "Covet",
          year: "1986-1992",
          price: 8000,
          type: "hatchback",
        },
        {
          id: "diana",
          brand: "Ibishu",
          model: "Diana",
          year: "1990-1994",
          price: 12000,
          type: "sedan",
        },
        {
          id: "hopper",
          brand: "Ibishu",
          model: "Hopper",
          year: "1989-2001",
          price: 18000,
          type: "offroad",
        },
        {
          id: "miramar",
          brand: "Ibishu",
          model: "Miramar",
          year: "1963-1994",
          price: 22000,
          type: "classic",
        },
        {
          id: "pessima",
          brand: "Ibishu",
          model: "Pessima",
          year: "1988-2000",
          price: 10000,
          type: "sedan",
        },
        {
          id: "pigeon",
          brand: "Ibishu",
          model: "Pigeon",
          year: "1980-1989",
          price: 3000,
          type: "microcar",
        },
        {
          id: "wigeon",
          brand: "Ibishu",
          model: "Wigeon",
          year: "1980-1989",
          price: 4500,
          type: "microcar",
        },

        // Soliad
        {
          id: "wendover",
          brand: "Soliad",
          model: "Wendover",
          year: "1987-1995",
          price: 14000,
          type: "sedan",
        },
        {
          id: "lansdale",
          brand: "Soliad",
          model: "Lansdale",
          year: "1996-2007",
          price: 22000,
          type: "sedan",
        },

        // SP
        {
          id: "dunekicker",
          brand: "SP",
          model: "Dunekicker",
          year: "2008",
          price: 55000,
          type: "buggy",
        },
        {
          id: "rockbasher",
          brand: "SP",
          model: "Rockbasher",
          year: "2008-2018",
          price: 48000,
          type: "offroad",
        },

        // Wentward
        {
          id: "dt40l",
          brand: "Wentward",
          model: "DT40L",
          year: "1987-1996",
          price: 85000,
          type: "bus",
        },
      ];

      // Lista prawdziwych aut dla trybu Real Life (ceny realne -10%)
      const realLifeCars = [
        // MaÅ‚e / Miejskie
        {
          id: "fiat500",
          brand: "Fiat",
          model: "500",
          year: "2020-2024",
          price: 54000,
          type: "microcar",
        },
        {
          id: "toyota_yaris",
          brand: "Toyota",
          model: "Yaris",
          year: "2020-2024",
          price: 72000,
          type: "hatchback",
        },
        {
          id: "vw_polo",
          brand: "Volkswagen",
          model: "Polo",
          year: "2021-2024",
          price: 81000,
          type: "hatchback",
        },
        {
          id: "skoda_fabia",
          brand: "Å koda",
          model: "Fabia",
          year: "2021-2024",
          price: 67500,
          type: "hatchback",
        },
        {
          id: "opel_corsa",
          brand: "Opel",
          model: "Corsa",
          year: "2020-2024",
          price: 63000,
          type: "hatchback",
        },

        // Kompaktowe
        {
          id: "vw_golf",
          brand: "Volkswagen",
          model: "Golf",
          year: "2020-2024",
          price: 117000,
          type: "hatchback",
        },
        {
          id: "toyota_corolla",
          brand: "Toyota",
          model: "Corolla",
          year: "2020-2024",
          price: 108000,
          type: "sedan",
        },
        {
          id: "mazda3",
          brand: "Mazda",
          model: "3",
          year: "2020-2024",
          price: 99000,
          type: "hatchback",
        },
        {
          id: "honda_civic",
          brand: "Honda",
          model: "Civic",
          year: "2022-2024",
          price: 126000,
          type: "sedan",
        },
        {
          id: "ford_focus",
          brand: "Ford",
          model: "Focus",
          year: "2019-2023",
          price: 90000,
          type: "hatchback",
        },

        // Sedany
        {
          id: "bmw_3",
          brand: "BMW",
          model: "3 Series",
          year: "2020-2024",
          price: 189000,
          type: "sedan",
        },
        {
          id: "mercedes_c",
          brand: "Mercedes-Benz",
          model: "C-Class",
          year: "2021-2024",
          price: 207000,
          type: "sedan",
        },
        {
          id: "audi_a4",
          brand: "Audi",
          model: "A4",
          year: "2020-2024",
          price: 180000,
          type: "sedan",
        },
        {
          id: "skoda_octavia",
          brand: "Å koda",
          model: "Octavia",
          year: "2020-2024",
          price: 108000,
          type: "sedan",
        },
        {
          id: "toyota_camry",
          brand: "Toyota",
          model: "Camry",
          year: "2020-2024",
          price: 144000,
          type: "sedan",
        },

        // SUV
        {
          id: "toyota_rav4",
          brand: "Toyota",
          model: "RAV4",
          year: "2020-2024",
          price: 162000,
          type: "suv",
        },
        {
          id: "vw_tiguan",
          brand: "Volkswagen",
          model: "Tiguan",
          year: "2020-2024",
          price: 153000,
          type: "suv",
        },
        {
          id: "bmw_x3",
          brand: "BMW",
          model: "X3",
          year: "2021-2024",
          price: 243000,
          type: "suv",
        },
        {
          id: "mercedes_glc",
          brand: "Mercedes-Benz",
          model: "GLC",
          year: "2020-2024",
          price: 252000,
          type: "suv",
        },
        {
          id: "audi_q5",
          brand: "Audi",
          model: "Q5",
          year: "2020-2024",
          price: 234000,
          type: "suv",
        },
        {
          id: "volvo_xc60",
          brand: "Volvo",
          model: "XC60",
          year: "2020-2024",
          price: 225000,
          type: "suv",
        },
        {
          id: "hyundai_tucson",
          brand: "Hyundai",
          model: "Tucson",
          year: "2021-2024",
          price: 135000,
          type: "suv",
        },
        {
          id: "kia_sportage",
          brand: "Kia",
          model: "Sportage",
          year: "2022-2024",
          price: 126000,
          type: "suv",
        },

        // Sportowe
        {
          id: "porsche_911",
          brand: "Porsche",
          model: "911 Carrera",
          year: "2020-2024",
          price: 630000,
          type: "sport",
        },
        {
          id: "bmw_m4",
          brand: "BMW",
          model: "M4",
          year: "2021-2024",
          price: 450000,
          type: "sport",
        },
        {
          id: "audi_rs6",
          brand: "Audi",
          model: "RS6 Avant",
          year: "2020-2024",
          price: 585000,
          type: "sport",
        },
        {
          id: "mercedes_amg_gt",
          brand: "Mercedes-AMG",
          model: "GT",
          year: "2020-2024",
          price: 720000,
          type: "supercar",
        },
        {
          id: "ford_mustang",
          brand: "Ford",
          model: "Mustang GT",
          year: "2020-2024",
          price: 270000,
          type: "muscle",
        },
        {
          id: "chevrolet_camaro",
          brand: "Chevrolet",
          model: "Camaro SS",
          year: "2020-2024",
          price: 243000,
          type: "muscle",
        },
        {
          id: "nissan_gtr",
          brand: "Nissan",
          model: "GT-R",
          year: "2020-2024",
          price: 540000,
          type: "sport",
        },
        {
          id: "toyota_supra",
          brand: "Toyota",
          model: "GR Supra",
          year: "2020-2024",
          price: 270000,
          type: "sport",
        },

        // Elektryczne
        {
          id: "tesla_model3",
          brand: "Tesla",
          model: "Model 3",
          year: "2020-2024",
          price: 180000,
          type: "electric",
        },
        {
          id: "tesla_modelS",
          brand: "Tesla",
          model: "Model S",
          year: "2020-2024",
          price: 450000,
          type: "electric",
        },
        {
          id: "bmw_i4",
          brand: "BMW",
          model: "i4",
          year: "2022-2024",
          price: 270000,
          type: "electric",
        },
        {
          id: "mercedes_eqs",
          brand: "Mercedes-Benz",
          model: "EQS",
          year: "2022-2024",
          price: 540000,
          type: "electric",
        },
        {
          id: "porsche_taycan",
          brand: "Porsche",
          model: "Taycan",
          year: "2020-2024",
          price: 450000,
          type: "electric",
        },

        // Pickupy / Terenowe
        {
          id: "ford_ranger",
          brand: "Ford",
          model: "Ranger",
          year: "2020-2024",
          price: 180000,
          type: "pickup",
        },
        {
          id: "toyota_hilux",
          brand: "Toyota",
          model: "Hilux",
          year: "2020-2024",
          price: 189000,
          type: "pickup",
        },
        {
          id: "jeep_wrangler",
          brand: "Jeep",
          model: "Wrangler",
          year: "2020-2024",
          price: 270000,
          type: "offroad",
        },
        {
          id: "land_rover_defender",
          brand: "Land Rover",
          model: "Defender",
          year: "2020-2024",
          price: 315000,
          type: "offroad",
        },

        // Vany / Dostawcze
        {
          id: "vw_transporter",
          brand: "Volkswagen",
          model: "Transporter",
          year: "2020-2024",
          price: 180000,
          type: "van",
        },
        {
          id: "ford_transit",
          brand: "Ford",
          model: "Transit",
          year: "2020-2024",
          price: 162000,
          type: "van",
        },
        {
          id: "mercedes_sprinter",
          brand: "Mercedes-Benz",
          model: "Sprinter",
          year: "2020-2024",
          price: 189000,
          type: "van",
        },

        // Luksusowe
        {
          id: "bmw_7",
          brand: "BMW",
          model: "7 Series",
          year: "2020-2024",
          price: 450000,
          type: "sedan",
        },
        {
          id: "mercedes_s",
          brand: "Mercedes-Benz",
          model: "S-Class",
          year: "2021-2024",
          price: 540000,
          type: "sedan",
        },
        {
          id: "audi_a8",
          brand: "Audi",
          model: "A8",
          year: "2020-2024",
          price: 495000,
          type: "sedan",
        },
        {
          id: "bentley_continental",
          brand: "Bentley",
          model: "Continental GT",
          year: "2020-2024",
          price: 990000,
          type: "supercar",
        },
        {
          id: "rolls_royce_ghost",
          brand: "Rolls-Royce",
          model: "Ghost",
          year: "2020-2024",
          price: 1530000,
          type: "sedan",
        },
      ];

      // ==================== SYSTEM TRYBU GRY ====================
      // gameMode jest zdefiniowane wczeÅ›niej (przed loadSaveData)

      function getCurrentCars() {
        return gameMode === "reallife" ? realLifeCars : beamngCars;
      }

      function switchGameMode(mode) {
        const save = getCurrentSave();
        if (!save) return;

        // Zatrzymaj wszystkie ulepszania przed zmianÄ… trybu
        Object.keys(upgradeIntervals).forEach((idx) => {
          clearInterval(upgradeIntervals[idx]);
        });
        upgradeIntervals = {};

        // Zapisz aktualny stan do obecnego trybu
        saveModeData(gameMode);

        // ZmieÅ„ tryb
        gameMode = mode;
        localStorage.setItem("beamng_gameMode", mode);

        // ZaÅ‚aduj dane dla nowego trybu lub utwÃ³rz nowe
        loadModeData(mode);

        // Aktualizuj UI
        updateGameModeUI();
        updateAllDisplays();
        renderGarageModal();
        closeModal("gameMode");
      }

      function saveModeData(mode) {
        const save = getCurrentSave();
        if (!save) return;

        const modeKey = mode === "reallife" ? "realLifeData" : "beamngData";
        save[modeKey] = {
          money: money,
          garage: [...garage],
          spent: spent,
          debt: debt,
          debtDeadline: debtDeadline,
          totalTaxPaid: totalTaxPaid,
          health: health,
          food: food,
          water: water,
          backpack: [...backpack],
          activeInsurances: [...activeInsurances],
        };
        localStorage.setItem("beamng_saves", JSON.stringify(saves));
      }

      function loadModeData(mode) {
        const save = getCurrentSave();
        if (!save) return;

        const modeKey = mode === "reallife" ? "realLifeData" : "beamngData";
        const data = save[modeKey];

        if (data) {
          // ZaÅ‚aduj istniejÄ…ce dane
          money = data.money;
          garage = data.garage || [];
          spent = data.spent || 0;
          debt = data.debt || 0;
          debtDeadline = data.debtDeadline || null;
          totalTaxPaid = data.totalTaxPaid || 0;
          health = data.health || 100;
          food = data.food || 1000;
          water = data.water || 1000;
          backpack = data.backpack || [];
          activeInsurances = data.activeInsurances || [];
        } else {
          // Pierwszy raz w tym trybie - nowy start
          money = 1500;
          garage = [];
          spent = 0;
          debt = 0;
          debtDeadline = null;
          totalTaxPaid = 0;
          health = 100;
          food = 1000;
          water = 1000;
          backpack = [];
          activeInsurances = [];
        }

        // WznÃ³w ulepszania
        resumeUpgrades();
      }

      function updateGameModeUI() {
        const title = document.getElementById("gameModeTitle");
        const subtitle = document.getElementById("gameModeSubtitle");
        const t = translations[currentLang] || translations.en;

        // Elementy karty
        const cardBtn = document.querySelector('[data-translate="card"]');
        const cardTitle = document.querySelector(
          '#modalCard h2 [data-translate="card"]'
        );
        const cardLogo = document.querySelector(".card-logo");
        const pinInfo = document.querySelector(
          '[data-translate="enter6digitPin"]'
        );

        // Elementy bonÃ³w
        const vouchersTitle = document.querySelector(
          '#modalVouchers h2 [data-translate="vouchers"]'
        );
        const createVoucherBtns = document.querySelectorAll(
          '[data-translate="createVoucher"]'
        );
        const vouchersToSendTitle = document.querySelector(
          '[data-translate="vouchersToSend"]'
        );
        const receivedVouchersTitle = document.querySelector(
          '[data-translate="receivedVouchers"]'
        );
        const shareVoucherTitle = document.querySelector(
          '#modalShareVoucher h2 [data-translate="shareVoucher"]'
        );

        if (gameMode === "reallife") {
          title.textContent = "ğŸŒ Real Life";
          subtitle.textContent = t.simulator || "Symulator";
          document.body.style.background =
            "linear-gradient(135deg, #064e3b 0%, #022c22 100%)";

          // ZmieÅ„ nazwÄ™ karty
          if (cardBtn)
            cardBtn.textContent = t.cardRealLife || "Karta Real-Card";
          if (cardTitle)
            cardTitle.textContent = t.cardRealLife || "Karta Real-Card";
          if (cardLogo) cardLogo.textContent = "Real-Card";
          if (pinInfo)
            pinInfo.textContent =
              currentLang === "pl"
                ? "Wpisz 6-cyfrowy PIN z karty Real-Card"
                : "Enter 6-digit PIN from Real-Card";

          // ZmieÅ„ nazwy bonÃ³w na kupony
          if (vouchersTitle)
            vouchersTitle.textContent = t.vouchersRealLife || "Kupony";
          createVoucherBtns.forEach(
            (btn) =>
              (btn.textContent = t.createVoucherRealLife || "UtwÃ³rz kupon")
          );
          if (vouchersToSendTitle)
            vouchersToSendTitle.textContent =
              currentLang === "pl" ? "Kupony do wysÅ‚ania" : "Coupons to send";
          if (receivedVouchersTitle)
            receivedVouchersTitle.textContent =
              currentLang === "pl" ? "Otrzymane kupony" : "Received coupons";
          if (shareVoucherTitle)
            shareVoucherTitle.textContent =
              currentLang === "pl" ? "WyÅ›lij kupon" : "Send coupon";
        } else {
          title.textContent = "ğŸš— BeamNG Drive";
          subtitle.textContent = "Datapack";
          document.body.style.background =
            "linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)";

          // ZmieÅ„ nazwÄ™ karty
          if (cardBtn) cardBtn.textContent = t.card || "Karta Beam-Pay";
          if (cardTitle) cardTitle.textContent = t.card || "Karta Beam-Pay";
          if (cardLogo) cardLogo.textContent = "Beam-Pay";
          if (pinInfo)
            pinInfo.textContent =
              currentLang === "pl"
                ? "Wpisz 6-cyfrowy PIN z karty Beam-Pay"
                : "Enter 6-digit PIN from Beam-Pay Card";

          // ZmieÅ„ nazwy bonÃ³w
          if (vouchersTitle) vouchersTitle.textContent = t.vouchers || "Bony";
          createVoucherBtns.forEach(
            (btn) => (btn.textContent = t.createVoucher || "UtwÃ³rz bon")
          );
          if (vouchersToSendTitle)
            vouchersToSendTitle.textContent =
              currentLang === "pl" ? "Bony do wysÅ‚ania" : "Vouchers to send";
          if (receivedVouchersTitle)
            receivedVouchersTitle.textContent =
              currentLang === "pl" ? "Otrzymane bony" : "Received vouchers";
          if (shareVoucherTitle)
            shareVoucherTitle.textContent =
              currentLang === "pl" ? "WyÅ›lij bon" : "Send voucher";
        }

        // PodÅ›wietl aktywny tryb w modalu
        const beamngBtn = document.getElementById("modeBeamNG");
        const reallifeBtn = document.getElementById("modeRealLife");

        if (beamngBtn && reallifeBtn) {
          beamngBtn.style.borderColor =
            gameMode === "beamng" ? "#fff" : "transparent";
          reallifeBtn.style.borderColor =
            gameMode === "reallife" ? "#fff" : "transparent";
        }
      }

      // ==================== UI SAVE'Ã“W ====================
      function renderSavesList() {
        const list = document.getElementById("savesList");
        const t = translations[currentLang] || translations.en;
        const activeText = t.active || "aktywny";

        list.innerHTML = saves
          .map((save) => {
            const isCurrent = save.id === currentSaveId;

            // SprawdÅº checkpoint dla aktywnego save'a
            const modeKey =
              gameMode === "reallife"
                ? "realLifeCheckpoint"
                : "beamngCheckpoint";
            const hasCheckpoint = save[modeKey] ? true : false;
            const checkpointDate = hasCheckpoint
              ? new Date(save[modeKey].createdAt).toLocaleString()
              : null;

            // Pobierz dane z odpowiedniego trybu
            const modeDataKey =
              gameMode === "reallife" ? "realLifeData" : "beamngData";
            const modeData = save[modeDataKey] || save.data;
            const garageCount =
              modeData?.garage?.length || save.data?.garage?.length || 0;
            const saveMoney = modeData?.money ?? save.data?.money ?? 0;

            return `
                    <div style="padding:12px;margin-bottom:8px;background:${
                      isCurrent ? "rgba(74,222,128,0.2)" : "rgba(0,0,0,0.2)"
                    };border:2px solid ${
              isCurrent ? "#4ade80" : "#333"
            };border-radius:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                            <div style="flex:1;min-width:120px;">
                                <div style="font-weight:bold;font-size:1em;">${
                                  save.name
                                }</div>
                                <div style="font-size:0.8em;color:#888;">${saveMoney.toLocaleString()} ${getCurrency()} | ğŸš— ${garageCount}</div>
                            </div>
                            <div style="display:flex;gap:8px;flex-shrink:0;">
                                <button onclick="renameSave('${
                                  save.id
                                }')" style="padding:10px 14px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;min-width:44px;min-height:44px;-webkit-tap-highlight-color:transparent;">âœï¸</button>
                                ${
                                  !isCurrent
                                    ? `<button onclick="switchSave('${save.id}')" style="padding:10px 16px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;min-width:44px;min-height:44px;-webkit-tap-highlight-color:transparent;">â–¶</button>`
                                    : `<span style="color:#4ade80;font-size:0.85em;padding:10px;">âœ“ ${activeText}</span>`
                                }
                                ${
                                  saves.length > 1
                                    ? `<button onclick="handleDeleteSave('${save.id}')" style="padding:10px 16px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;min-width:44px;min-height:44px;-webkit-tap-highlight-color:transparent;">ğŸ—‘ï¸</button>`
                                    : ""
                                }
                            </div>
                        </div>
                        ${
                          isCurrent
                            ? `
                            <div style="margin-top:10px;padding-top:10px;border-top:1px solid #333;">
                                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                                    <div style="font-size:0.85em;">
                                        ${
                                          hasCheckpoint
                                            ? `
                                            <span style="color:#4ade80;">ğŸ’¾ ${
                                              t.checkpoint || "Checkpoint"
                                            }: ${checkpointDate}</span>
                                        `
                                            : `
                                            <span style="color:#888;">ğŸ“­ ${
                                              t.noCheckpoint ||
                                              "Brak checkpointu"
                                            }</span>
                                        `
                                        }
                                    </div>
                                    <div style="display:flex;gap:6px;">
                                        <button onclick="createCheckpoint()" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">
                                            ğŸ’¾ ${t.saveCheckpoint || "Zapisz"}
                                        </button>
                                        ${
                                          hasCheckpoint
                                            ? `
                                            <button onclick="deleteCheckpoint()" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">
                                                ğŸ—‘ï¸
                                            </button>
                                        `
                                            : ""
                                        }
                                    </div>
                                </div>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
          })
          .join("");
      }

      function renameSave(saveId) {
        const save = saves.find((s) => s.id === saveId);
        if (!save) return;

        const t = translations[currentLang] || translations.en;
        const newName = prompt(
          t.enterNewName || "WprowadÅº nowÄ… nazwÄ™:",
          save.name
        );

        if (newName && newName.trim()) {
          save.name = newName.trim();
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          renderSavesList();
          updateCurrentSaveDisplay();
        }
      }

      function handleCreateSave() {
        const nameInput = document.getElementById("newSaveName");
        const name = nameInput.value.trim() || "Save " + (saves.length + 1);

        const newSave = createSave(name);
        nameInput.value = "";

        renderSavesList();
        updateCurrentSaveDisplay();

        const t = translations[currentLang] || translations.en;
        alert(t.saveCreated || "Save utworzony!");
      }

      function handleDeleteSave(saveId) {
        const t = translations[currentLang] || translations.en;
        if (confirm(t.confirmDeleteSave || "UsunÄ…Ä‡ ten save?")) {
          if (deleteSave(saveId)) {
            renderSavesList();
            updateAllDisplays();
            updateCurrentSaveDisplay();
          }
        }
      }

      function updateCurrentSaveDisplay() {
        const display = document.getElementById("currentSaveDisplay");
        const save = getCurrentSave();
        if (display && save) {
          display.textContent = "ğŸ’¾ " + save.name;
        }
      }

      // ==================== UI BONÃ“W ====================
      let currentVoucherToShare = null;

      function renderVouchersList() {
        const toSendList = document.getElementById("vouchersToSendList");
        const receivedList = document.getElementById("receivedVouchersList");
        const t = translations[currentLang] || translations.en;
        const save = getCurrentSave();

        const noVouchersText =
          gameMode === "reallife"
            ? currentLang === "pl"
              ? "Brak kuponÃ³w"
              : "No coupons"
            : t.noVouchers || "Brak bonÃ³w";
        const noReceivedText =
          gameMode === "reallife"
            ? currentLang === "pl"
              ? "Brak otrzymanych kuponÃ³w"
              : "No received coupons"
            : t.noReceivedVouchers || "Brak otrzymanych bonÃ³w";

        if (!save || !save.data) {
          if (toSendList)
            toSendList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noVouchersText}</div>`;
          if (receivedList)
            receivedList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noReceivedText}</div>`;
          return;
        }

        // Bony do wysÅ‚ania - filtruj wedÅ‚ug aktualnego trybu
        const allVouchersToSend = save.data.vouchersToSend || [];
        const vouchersToSend = allVouchersToSend.filter(
          (v) => (v.gameMode || "beamng") === gameMode
        );

        if (vouchersToSend.length === 0) {
          toSendList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noVouchersText}</div>`;
        } else {
          toSendList.innerHTML = vouchersToSend
            .map((v, idx) => {
              // ZnajdÅº rzeczywisty indeks w peÅ‚nej tablicy
              const realIdx = allVouchersToSend.findIndex(
                (vv) => vv.id === v.id
              );
              return `
                    <div style="padding:12px;margin-bottom:8px;background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(168,85,247,0.1));border:2px solid #8b5cf6;border-radius:12px;">
                        ${renderVoucherCard(v)}
                        <div style="font-size:0.75em;color:#f59e0b;text-align:center;margin:8px 0;">â³ ${
                          t.pendingVoucher || "Oczekuje na przyjÄ™cie"
                        }</div>
                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <button onclick="openShareVoucher(${realIdx}, 'toSend')" style="flex:1;padding:10px;background:#8b5cf6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;-webkit-tap-highlight-color:transparent;">
                                ğŸ“¤ ${
                                  gameMode === "reallife"
                                    ? currentLang === "pl"
                                      ? "WyÅ›lij"
                                      : "Send"
                                    : t.sendVoucher || "WyÅ›lij"
                                }
                            </button>
                            <button onclick="cancelVoucher(${realIdx})" style="padding:10px 15px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;-webkit-tap-highlight-color:transparent;">
                                âŒ
                            </button>
                        </div>
                    </div>
                `;
            })
            .join("");
        }

        // Otrzymane bony - filtruj wedÅ‚ug aktualnego trybu
        const allReceivedVouchers = save?.data?.receivedVouchers || [];
        const receivedVouchers = allReceivedVouchers.filter(
          (v) => (v.gameMode || "beamng") === gameMode
        );

        if (receivedVouchers.length === 0) {
          receivedList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noReceivedText}</div>`;
        } else {
          receivedList.innerHTML = receivedVouchers
            .map((v, idx) => {
              // ZnajdÅº rzeczywisty indeks w peÅ‚nej tablicy
              const realIdx = allReceivedVouchers.findIndex(
                (vv) => vv.id === v.id
              );
              return `
                    <div style="padding:12px;margin-bottom:8px;background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.1));border:2px solid #10b981;border-radius:12px;">
                        ${renderVoucherCard(v)}
                        <div style="font-size:0.8em;color:#888;margin-bottom:8px;">${
                          t.voucherFrom || "Od:"
                        } ${v.fromSave || "?"}</div>
                        <div style="display:flex;gap:8px;">
                            <button onclick="acceptVoucher(${realIdx})" style="flex:1;padding:10px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;">
                                âœ… ${t.acceptVoucher || "Przyjmij"}
                            </button>
                            <button onclick="rejectVoucher(${realIdx})" style="flex:1;padding:10px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;">
                                â†©ï¸ ${t.rejectVoucher || "PrzekaÅ¼ dalej"}
                            </button>
                        </div>
                    </div>
                `;
            })
            .join("");
        }
      }

      function renderVoucherCard(voucher) {
        const voucherMode = voucher.gameMode || gameMode;
        const isRealLife = voucherMode === "reallife";
        const titleText = isRealLife
          ? currentLang === "pl"
            ? "KUPON PODARUNKOWY"
            : "GIFT COUPON"
          : currentLang === "pl"
          ? "BON PODARUNKOWY"
          : "GIFT VOUCHER";
        const bgGradient = isRealLife
          ? "linear-gradient(145deg,#064e3b,#022c22)"
          : "linear-gradient(145deg,#1a1a2e,#16213e)";
        const borderColor = isRealLife ? "#10b981" : "#8b5cf6";
        const amountColor = isRealLife ? "#10b981" : "#8b5cf6";

        return `
                <div style="background:${bgGradient};border-radius:10px;padding:15px;text-align:center;border:1px dashed ${borderColor};">
                    <div style="font-size:2.5em;margin-bottom:5px;">${
                      isRealLife ? "ğŸ«" : "ğŸ"
                    }</div>
                    <div style="font-size:0.8em;color:#888;text-transform:uppercase;letter-spacing:2px;">${titleText}</div>
                    <div style="font-size:2em;font-weight:bold;color:${amountColor};margin:10px 0;">${voucher.amount.toLocaleString()} ${getCurrency()}</div>
                    ${
                      voucher.message
                        ? `<div style="font-size:0.9em;color:#aaa;font-style:italic;">"${voucher.message}"</div>`
                        : ""
                    }
                </div>
            `;
      }

      function handleCreateVoucher() {
        const amountInput = document.getElementById("voucherAmountInput");
        const messageInput = document.getElementById("voucherMessageInput");
        const t = translations[currentLang] || translations.en;

        const amount = parseInt(amountInput.value);
        if (!amount || amount <= 0) {
          alert(t.invalidAmount || "WprowadÅº prawidÅ‚owÄ… kwotÄ™!");
          return;
        }

        // SprawdÅº czy masz tyle pieniÄ™dzy (uwzglÄ™dnij juÅ¼ utworzone bony)
        const save = getCurrentSave();
        if (!save) return;
        if (!save.data) save.data = {};

        // Filtruj bony tylko z aktualnego trybu
        const pendingTotal = (save.data.vouchersToSend || [])
          .filter((v) => v.gameMode === gameMode)
          .reduce((sum, v) => sum + v.amount, 0);

        if (money - pendingTotal < amount) {
          playSound("error");
          alert(t.notEnoughMoney || "Nie masz wystarczajÄ…co pieniÄ™dzy!");
          return;
        }

        const voucher = {
          id:
            "bon_" + Date.now() + "_" + Math.random().toString(36).substr(2, 6),
          amount: amount,
          message: messageInput.value.trim(),
          createdAt: Date.now(),
          fromSave: save.name,
          fromSaveId: save.id,
          gameMode: gameMode, // Zapisz tryb gry
        };

        // NIE odejmuj pieniÄ™dzy - tylko dodaj do listy oczekujÄ…cych
        if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
        save.data.vouchersToSend.push(voucher);

        saveSaveData();

        amountInput.value = "";
        messageInput.value = "";
        renderVouchersList();

        // Od razu otwÃ³rz udostÄ™pnianie
        currentVoucherToShare = {
          voucher,
          index: save.data.vouchersToSend.length - 1,
          source: "toSend",
        };
        openShareModal();
      }

      function cancelVoucher(idx) {
        const t = translations[currentLang] || translations.en;
        const save = getCurrentSave();

        if (!save.data.vouchersToSend || !save.data.vouchersToSend[idx]) return;

        // Bon jeszcze nie byÅ‚ przyjÄ™ty, wiÄ™c nic nie tracisz
        if (confirm(t.cancelVoucherConfirm || "AnulowaÄ‡ bon?")) {
          save.data.vouchersToSend.splice(idx, 1);
          saveSaveData();
          updateAllDisplays();
          renderVouchersList();
        }
      }

      function openShareVoucher(idx, source) {
        const save = getCurrentSave();
        const vouchers =
          source === "toSend"
            ? save.data.vouchersToSend
            : save.data.receivedVouchers;

        if (!vouchers || !vouchers[idx]) return;

        currentVoucherToShare = { voucher: vouchers[idx], index: idx, source };
        openShareModal();
      }

      function openShareModal() {
        if (!currentVoucherToShare) return;

        const v = currentVoucherToShare.voucher;
        const t = translations[currentLang] || translations.en;

        document.getElementById("shareVoucherPreview").innerHTML =
          renderVoucherCard(v);

        // Generuj przyciski udostÄ™pniania
        const buttonsDiv = document.getElementById("shareVoucherButtons");

        // Lista innych save'Ã³w (nie aktualny)
        const otherSaves = saves.filter((s) => s.id !== currentSaveId);

        // Pobierz znajomych (lokalnie)
        const friends = getFriendsList();

        buttonsDiv.innerHTML = `
                <!-- WyÅ›lij do znajomego -->
                ${
                  friends.length > 0
                    ? `
                    <p style="margin-bottom:5px;font-weight:bold;">â­ ${
                      t.sendToFriend || "WyÅ›lij do znajomego:"
                    }</p>
                    <p style="color:#f59e0b;font-size:0.8em;margin-bottom:10px;">ğŸ’° OpÅ‚ata: ${VOUCHER_SEND_FEE} ${getCurrency()}</p>
                    <div style="display:flex;flex-direction:column;gap:6px;max-height:150px;overflow-y:auto;margin-bottom:15px;">
                        ${friends
                          .map(
                            (name) => `
                            <button onclick="sendVoucherToFriend('${name}')" style="padding:12px;background:#222;color:white;border:1px solid #333;border-radius:8px;cursor:pointer;text-align:left;">
                                ğŸ‘¤ ${name}
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                `
                    : `
                    <p style="color:#666;text-align:center;padding:15px;margin-bottom:15px;">${
                      t.noFriends || "Brak znajomych"
                    }<br><small>Dodaj znajomych w Konto Online!</small></p>
                `
                }
                
                <!-- WyÅ›lij przez link -->
                <p style="margin-bottom:10px;font-weight:bold;border-top:1px solid #333;padding-top:15px;">ğŸ”— ${
                  t.shareViaLink || "Lub wyÅ›lij przez link:"
                }</p>
                <div style="display:flex;gap:8px;margin-bottom:15px;">
                    <button onclick="shareVoucherVia('copy')" style="flex:1;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;">ğŸ“‹</button>
                    <button onclick="shareVoucherVia('whatsapp')" style="flex:1;padding:12px;background:#25D366;color:white;border:none;border-radius:8px;cursor:pointer;">ğŸ’¬</button>
                </div>
                
                ${
                  otherSaves.length > 0
                    ? `
                    <p style="margin-bottom:5px;font-weight:bold;border-top:1px solid #333;padding-top:15px;">ğŸ’¾ ${
                      t.sendToOtherSave || "Lub na inny zapis:"
                    }</p>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        ${otherSaves
                          .map(
                            (s) => `
                            <button onclick="sendVoucherToSave('${s.id}')" style="padding:12px;background:rgba(0,0,0,0.3);color:white;border:2px solid #333;border-radius:10px;cursor:pointer;text-align:left;">
                                ğŸ’¾ ${s.name}
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                `
                    : ""
                }
            `;

        openModal("shareVoucher");
      }

      // WyÅ›lij bon do znajomego (lokalnie - bez serwera)
      function sendVoucherToFriend(friendName) {
        if (!currentVoucherToShare) return;

        const v = currentVoucherToShare.voucher;
        const idx = currentVoucherToShare.index;
        const save = getCurrentSave();
        const t = translations[currentLang] || translations.en;

        // SprawdÅº czy staÄ‡ na opÅ‚atÄ™
        if (save.data.money < VOUCHER_SEND_FEE) {
          showToast(
            `âŒ ${
              t.notEnoughMoney || "Brak Å›rodkÃ³w"
            } (${VOUCHER_SEND_FEE} ${getCurrency()})`
          );
          return;
        }

        // Pobierz opÅ‚atÄ™
        save.data.money -= VOUCHER_SEND_FEE;

        // Zapisz bon jako wysÅ‚any do znajomego
        v.sentToFriend = friendName;
        v.sentAt = Date.now();

        // Zapisz info o bonie w localStorage dla znajomego
        let pendingVouchers = JSON.parse(
          localStorage.getItem("beamng_pending_vouchers") || "[]"
        );
        pendingVouchers.push({
          id: v.id,
          amount: v.amount,
          message: v.message,
          from: playerName,
          to: friendName,
          gameMode: v.gameMode || gameMode,
          sentAt: Date.now(),
        });
        localStorage.setItem(
          "beamng_pending_vouchers",
          JSON.stringify(pendingVouchers)
        );

        saveSaveData();
        updateAllDisplays();

        showToast(
          `âœ… Bon wysÅ‚any do ${friendName}! (opÅ‚ata: ${VOUCHER_SEND_FEE} ${getCurrency()})`
        );
        closeModal("shareVoucher");
        renderVouchersList();
      }

      function getVoucherLink(voucher) {
        // Generuj czytelny link z parametrami
        const baseUrl =
          "https://filipnosalhd-collab.github.io/Real-BeamNG_datapack/";
        const params = new URLSearchParams();
        params.set("vid", voucher.id);
        params.set("amount", voucher.amount);
        params.set("from", voucher.fromSave);
        params.set("fromId", voucher.fromSaveId);
        params.set("mode", voucher.gameMode || gameMode);
        if (voucher.message) params.set("msg", voucher.message);
        return baseUrl + "?" + params.toString();
      }

      function getShareMessage(voucher) {
        const t = translations[currentLang] || translations.en;
        const genderMsg = t.youReceivedVoucher || "DostaÅ‚eÅ›/aÅ› bon o wartoÅ›ci";
        return `ğŸ ${genderMsg} ${voucher.amount.toLocaleString()} ${getCurrency()}!\n\n`;
      }

      async function shareVoucherVia(method) {
        if (!currentVoucherToShare) return;

        const v = currentVoucherToShare.voucher;
        const idx = currentVoucherToShare.index;
        const save = getCurrentSave();
        const t = translations[currentLang] || translations.en;
        const voucherMode = v.gameMode || gameMode;

        const SHIPPING_FEE = 100; // OpÅ‚ata za przesyÅ‚kÄ™ bonu
        const totalCost = v.amount + SHIPPING_FEE;

        // PokaÅ¼ Å‚adowanie
        const loadingMsg = currentLang === "pl" ? "WysyÅ‚anie..." : "Sending...";

        // Zapisz bon online do JSONBin
        saveVoucherOnline({
          id: v.id,
          amount: v.amount,
          message: v.message,
          fromSave: v.fromSave,
          fromSaveId: v.fromSaveId,
          gameMode: voucherMode,
        });

        // ONLINE - od razu odejmij pieniÄ…dze (wartoÅ›Ä‡ bonu + opÅ‚ata za przesyÅ‚kÄ™)
        const modeKey =
          voucherMode === "reallife" ? "realLifeData" : "beamngData";

        // Odejmij pieniÄ…dze z odpowiedniego trybu (bon + przesyÅ‚ka)
        if (save[modeKey]) {
          save[modeKey].money = (save[modeKey].money || 0) - totalCost;
        }
        // JeÅ›li jesteÅ›my w tym trybie, aktualizuj teÅ¼ lokalnÄ… zmiennÄ…
        if (voucherMode === gameMode) {
          money -= totalCost;
        }

        // UsuÅ„ bon z listy (juÅ¼ wysÅ‚any online)
        if (save.data.vouchersToSend && save.data.vouchersToSend[idx]) {
          save.data.vouchersToSend.splice(idx, 1);
        }

        // Oznacz bon jako wysÅ‚any online (nie moÅ¼na go odebraÄ‡ samemu)
        markVoucherAsUsed(v.id + "_sender_" + save.id);

        localStorage.setItem("beamng_saves", JSON.stringify(saves));
        updateAllDisplays();

        const link = getVoucherLink(v);
        const message = getShareMessage(v);
        const fullText = message + link;

        switch (method) {
          case "whatsapp":
            window.open(
              "https://wa.me/?text=" + encodeURIComponent(fullText),
              "_blank"
            );
            break;
          case "messenger":
            window.open(
              "https://www.facebook.com/dialog/send?link=" +
                encodeURIComponent(link) +
                "&app_id=0&redirect_uri=" +
                encodeURIComponent(window.location.href),
              "_blank"
            );
            break;
          case "email":
            const subject =
              voucherMode === "reallife"
                ? currentLang === "pl"
                  ? "Kupon podarunkowy Real Life"
                  : "Real Life Gift Coupon"
                : currentLang === "pl"
                ? "Bon podarunkowy BeamNG"
                : "BeamNG Gift Voucher";
            window.open(
              "mailto:?subject=" +
                encodeURIComponent(subject) +
                "&body=" +
                encodeURIComponent(fullText),
              "_blank"
            );
            break;
          case "sms":
            window.open("sms:?body=" + encodeURIComponent(fullText), "_blank");
            break;
        }

        closeModal("shareVoucher");
        renderVouchersList();

        // PokaÅ¼ potwierdzenie z opÅ‚atÄ… za przesyÅ‚kÄ™
        const voucherName =
          voucherMode === "reallife"
            ? currentLang === "pl"
              ? "Kupon"
              : "Coupon"
            : currentLang === "pl"
            ? "Bon"
            : "Voucher";
        const shippingText =
          currentLang === "pl" ? "opÅ‚ata za przesyÅ‚kÄ™" : "shipping fee";
        alert(
          `ğŸ“¤ ${voucherName} ${
            t.sent || "wysÅ‚any"
          }!\n-${v.amount.toLocaleString()} ${getCurrency()} (${voucherName.toLowerCase()})\n-${SHIPPING_FEE} ${getCurrency()} (${shippingText})\nâ”â”â”â”â”â”â”â”â”â”â”â”\n-${totalCost.toLocaleString()} ${getCurrency()} ${
            t.total || "Å‚Ä…cznie"
          }`
        );
      }

      function sendVoucherToSave(targetSaveId) {
        if (!currentVoucherToShare) return;

        const t = translations[currentLang] || translations.en;
        const v = currentVoucherToShare.voucher;
        const targetSave = saves.find((s) => s.id === targetSaveId);

        if (!targetSave) return;

        // Dodaj bon do receivedVouchers w docelowym save'ie
        if (!targetSave.data.receivedVouchers)
          targetSave.data.receivedVouchers = [];
        targetSave.data.receivedVouchers.push({
          id: v.id,
          amount: v.amount,
          message: v.message,
          fromSave: v.fromSave,
          fromSaveId: v.fromSaveId,
          gameMode: v.gameMode || gameMode, // Dodaj tryb gry
          receivedAt: Date.now(),
          isLocal: true, // Oznacz Å¼e wysÅ‚ane lokalnie (moÅ¼na anulowaÄ‡)
        });

        localStorage.setItem("beamng_saves", JSON.stringify(saves));

        const voucherName =
          (v.gameMode || gameMode) === "reallife"
            ? currentLang === "pl"
              ? "Kupon wysÅ‚any do"
              : "Coupon sent to"
            : t.voucherSentToSave || "Bon wysÅ‚any do";
        alert(`${voucherName} "${targetSave.name}"!`);
        closeModal("shareVoucher");
        renderVouchersList();
      }

      function acceptVoucher(idx) {
        const save = getCurrentSave();
        if (!save.data.receivedVouchers || !save.data.receivedVouchers[idx])
          return;

        const voucher = save.data.receivedVouchers[idx];

        // ZnajdÅº save nadawcy i odejmij mu pieniÄ…dze
        const senderSave = saves.find((s) => s.id === voucher.fromSaveId);
        if (senderSave) {
          // UsuÅ„ bon z listy oczekujÄ…cych nadawcy
          if (senderSave.data.vouchersToSend) {
            const vIdx = senderSave.data.vouchersToSend.findIndex(
              (v) => v.id === voucher.id
            );
            if (vIdx !== -1) {
              senderSave.data.vouchersToSend.splice(vIdx, 1);
            }
          }
          // Odejmij pieniÄ…dze nadawcy
          senderSave.data.money = (senderSave.data.money || 0) - voucher.amount;
        }

        // Dodaj pieniÄ…dze odbiorcy
        money += voucher.amount;
        save.data.receivedVouchers.splice(idx, 1);

        saveSaveData();
        localStorage.setItem("beamng_saves", JSON.stringify(saves));
        updateAllDisplays();
        renderVouchersList();

        playSound("voucher");
        const t = translations[currentLang] || translations.en;
        alert(
          `âœ… ${
            t.voucherAccepted || "Bon przyjÄ™ty!"
          }\n+${voucher.amount.toLocaleString()} ${getCurrency()}`
        );
      }

      function rejectVoucher(idx) {
        const save = getCurrentSave();
        if (!save.data.receivedVouchers || !save.data.receivedVouchers[idx])
          return;

        // PrzenieÅ› do bonÃ³w do wysÅ‚ania (przekaÅ¼ dalej)
        const voucher = save.data.receivedVouchers[idx];
        voucher.fromSave = save.name;
        voucher.fromSaveId = save.id; // Teraz to ty wysyÅ‚asz

        if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
        save.data.vouchersToSend.push(voucher);
        save.data.receivedVouchers.splice(idx, 1);

        saveSaveData();
        renderVouchersList();

        // Od razu otwÃ³rz udostÄ™pnianie
        currentVoucherToShare = {
          voucher,
          index: save.data.vouchersToSend.length - 1,
          source: "toSend",
        };
        openShareModal();
      }

      // SprawdÅº czy w URL jest bon do odebrania
      // ==================== SYSTEM LOKALNY ====================
      const VOUCHER_EXPIRY_SECONDS = 30;
      const LINK_SEND_FEE = 100; // OpÅ‚ata za wysÅ‚anie linkiem

      let playerName = localStorage.getItem("beamng_player_name") || null;

      // OpÅ‚aty
      const CHAT_MESSAGE_FEE = 5.5; // OpÅ‚ata za wiadomoÅ›Ä‡
      const VOUCHER_SEND_FEE = 250; // OpÅ‚ata za wysÅ‚anie bonu

      // ========== SYSTEM NAZWY GRACZA ==========
      function checkRequireLogin() {
        if (!playerName) {
          document.getElementById("modalRequireLogin").classList.add("active");
          return true;
        }
        return false;
      }

      function showLoginError(msg) {
        const errorEl = document.getElementById("loginError");
        errorEl.textContent = msg;
        errorEl.style.display = "block";
      }

      function hideLoginError() {
        document.getElementById("loginError").style.display = "none";
      }

      function setPlayerName() {
        const name = document.getElementById("loginName").value.trim();
        hideLoginError();

        if (name.length < 2) {
          showLoginError("Nazwa musi mieÄ‡ min. 2 znaki");
          return;
        }
        if (name.length > 20) {
          showLoginError("Nazwa moÅ¼e mieÄ‡ max. 20 znakÃ³w");
          return;
        }

        playerName = name;
        localStorage.setItem("beamng_player_name", playerName);

        document.getElementById("modalRequireLogin").classList.remove("active");
        updateAllDisplays();

        showToast(`ğŸ® Witaj ${playerName}!`);
      }

      function editPlayerName() {
        const newName = prompt("Nowa nazwa:", playerName);
        if (!newName || newName.trim().length < 2) {
          showToast("âŒ Nazwa musi mieÄ‡ min. 2 znaki");
          return;
        }
        if (newName.trim().length > 20) {
          showToast("âŒ Nazwa moÅ¼e mieÄ‡ max. 20 znakÃ³w");
          return;
        }

        playerName = newName.trim();
        localStorage.setItem("beamng_player_name", playerName);
        showToast(`âœ… Nazwa zmieniona na ${playerName}`);
        renderOnlineAccount();
      }

      function showToast(message) {
        const oldToast = document.getElementById("toast");
        if (oldToast) oldToast.remove();

        const toast = document.createElement("div");
        toast.id = "toast";
        toast.textContent = message;
        toast.style.cssText =
          "position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#10b981;color:white;padding:15px 30px;border-radius:10px;font-size:1.1em;z-index:9999;animation:fadeInOut 2s forwards;";
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      }

      // ========== DANE LOKALNE (bez serwera) ==========
      function getOnlineData() {
        const saved = localStorage.getItem("beamng_online_data");
        if (saved) {
          return JSON.parse(saved);
        }
        return {
          vouchers: {},
          players: {},
          notifications: {},
          chats: {},
          shop: { lastReset: 0, items: {} },
        };
      }

      function saveOnlineData(data) {
        localStorage.setItem("beamng_online_data", JSON.stringify(data));
        return true;
      }

      // ========== SYSTEM GRACZY ==========
      async function updatePlayerStatus() {
        if (!playerName) return;
        const data = getOnlineData();
        if (data.players && data.players[playerName]) {
          data.players[playerName].online = true;
          data.players[playerName].lastSeen = Date.now();
          data.players[playerName].gameMode = gameMode;
          data.players[playerName].cardNumber = cardCode;
          saveOnlineData(data);
        }
      }

      async function getOnlinePlayers() {
        const data = getOnlineData();
        if (!data.players) return [];
        const now = Date.now();
        const ONLINE_TIMEOUT = 2 * 60 * 1000; // 2 minuty
        return Object.entries(data.players)
          .filter(
            ([name, p]) =>
              p.online &&
              now - p.lastSeen < ONLINE_TIMEOUT &&
              name !== playerName
          )
          .map(([name, p]) => ({
            name,
            gameMode: p.gameMode,
            photoURL: p.photoURL || null,
          }));
      }

      // ========== SYSTEM BONÃ“W ==========
      async function getOnlineVouchers() {
        const data = getOnlineData();
        return data.vouchers || {};
      }

      function saveVoucherOnline(voucher) {
        const data = getOnlineData();
        if (!data.vouchers) data.vouchers = {};
        data.vouchers[voucher.id] = {
          amount: voucher.amount,
          message: voucher.message || "",
          fromPlayer: playerName,
          fromSaveId: voucher.fromSaveId,
          toPlayer: voucher.toPlayer || null,
          gameMode: voucher.gameMode,
          sentAt: Date.now(),
          firstOpenedAt: null,
          status: "pending",
        };
        saveOnlineData(data);
      }

      function checkVoucherOnline(voucherId) {
        const data = getOnlineData();
        return data.vouchers ? data.vouchers[voucherId] : null;
      }

      function markVoucherOpened(voucherId) {
        const data = getOnlineData();
        if (
          data.vouchers &&
          data.vouchers[voucherId] &&
          !data.vouchers[voucherId].firstOpenedAt
        ) {
          data.vouchers[voucherId].firstOpenedAt = Date.now();
          data.vouchers[voucherId].status = "opened";
          saveOnlineData(data);
        }
        return data.vouchers ? data.vouchers[voucherId] : null;
      }

      function markVoucherUsedOnline(voucherId) {
        const data = getOnlineData();
        if (data.vouchers && data.vouchers[voucherId]) {
          data.vouchers[voucherId].status = "used";
          data.vouchers[voucherId].usedAt = Date.now();
          saveOnlineData(data);
        }
      }

      function cancelVoucherOnline(voucherId) {
        const data = getOnlineData();
        if (data.vouchers && data.vouchers[voucherId]) {
          data.vouchers[voucherId].status = "cancelled";
          data.vouchers[voucherId].cancelledAt = Date.now();
          saveOnlineData(data);
          return data.vouchers[voucherId];
        }
        return null;
      }

      // ========== SYSTEM POWIADOMIEÅƒ ==========
      function sendNotification(toPlayer, notification) {
        const data = getOnlineData();
        if (!data.notifications) data.notifications = {};
        if (!data.notifications[toPlayer]) data.notifications[toPlayer] = [];

        notification.id =
          "notif_" + Date.now() + "_" + Math.random().toString(36).substr(2, 6);
        notification.timestamp = Date.now();
        notification.read = false;

        data.notifications[toPlayer].push(notification);
        saveOnlineData(data);
      }

      function getMyNotifications() {
        if (!playerName) return [];
        const data = getOnlineData();
        return data.notifications && data.notifications[playerName]
          ? data.notifications[playerName]
          : [];
      }

      function markNotificationRead(notifId) {
        const data = getOnlineData();
        if (data.notifications && data.notifications[playerName]) {
          const notif = data.notifications[playerName].find(
            (n) => n.id === notifId
          );
          if (notif) notif.read = true;
          saveOnlineData(data);
        }
      }

      function removeNotification(notifId) {
        const data = getOnlineData();
        if (data.notifications && data.notifications[playerName]) {
          data.notifications[playerName] = data.notifications[
            playerName
          ].filter((n) => n.id !== notifId);
          saveOnlineData(data);
        }
      }

      async function checkNotifications() {
        if (!playerName) return;
        const notifs = getMyNotifications();
        unreadNotifications = notifs.filter((n) => !n.read).length;
        updateNotificationBadge();
      }

      function updateNotificationBadge() {
        const badge = document.getElementById("notificationBadge");
        if (badge) {
          badge.textContent = unreadNotifications;
          badge.style.display = unreadNotifications > 0 ? "flex" : "none";
        }
      }

      // ========== SYSTEM AUKCJI ==========
      async function createAuction(item) {
        const data = getOnlineData();
        if (!data.auctions) data.auctions = {};

        const auctionId =
          "auction_" +
          Date.now() +
          "_" +
          Math.random().toString(36).substr(2, 6);
        data.auctions[auctionId] = {
          seller: playerName,
          item: item,
          price: item.price,
          createdAt: Date.now(),
          status: "active",
          bids: [],
          negotiations: [],
        };
        saveOnlineData(data);
        return auctionId;
      }

      async function getActiveAuctions() {
        const data = getOnlineData();
        if (!data.auctions) return [];
        return Object.entries(data.auctions)
          .filter(([id, a]) => a.status === "active")
          .map(([id, a]) => ({ id, ...a }));
      }

      async function bidOnAuction(auctionId, amount, pin) {
        const data = getOnlineData();
        if (!data.auctions || !data.auctions[auctionId])
          return { success: false, error: "notFound" };

        const auction = data.auctions[auctionId];
        if (auction.seller === playerName)
          return { success: false, error: "ownAuction" };

        // SprawdÅº limit karty
        const save = getCurrentSave();
        if (amount > limit && pin !== playerPin) {
          // WyÅ›lij powiadomienie do sprzedawcy o braku PIN
          sendNotification(auction.seller, {
            type: "pinRequired",
            from: playerName,
            auctionId: auctionId,
            amount: amount,
            message:
              currentLang === "pl"
                ? "KupujÄ…cy nie pamiÄ™ta PIN"
                : "Buyer forgot PIN",
          });
          return { success: false, error: "pinRequired" };
        }

        auction.bids.push({
          bidder: playerName,
          amount: amount,
          timestamp: Date.now(),
        });

        // Powiadom sprzedawcÄ™
        sendNotification(auction.seller, {
          type: "newBid",
          from: playerName,
          auctionId: auctionId,
          amount: amount,
        });

        saveOnlineData(data);
        return { success: true };
      }

      async function negotiateAuction(auctionId, offeredPrice) {
        const data = getOnlineData();
        if (!data.auctions || !data.auctions[auctionId])
          return { success: false };

        const auction = data.auctions[auctionId];

        auction.negotiations.push({
          from: playerName,
          price: offeredPrice,
          timestamp: Date.now(),
          status: "pending",
        });

        // Powiadom sprzedawcÄ™
        sendNotification(auction.seller, {
          type: "negotiation",
          from: playerName,
          auctionId: auctionId,
          offeredPrice: offeredPrice,
        });

        saveOnlineData(data);
        return { success: true };
      }

      async function respondToNegotiation(
        auctionId,
        negotiationIndex,
        response,
        counterOffer
      ) {
        const data = getOnlineData();
        if (!data.auctions || !data.auctions[auctionId])
          return { success: false };

        const auction = data.auctions[auctionId];
        const negotiation = auction.negotiations[negotiationIndex];

        if (response === "accept") {
          negotiation.status = "accepted";
          auction.status = "sold";
          auction.soldTo = negotiation.from;
          auction.soldPrice = negotiation.price;

          sendNotification(negotiation.from, {
            type: "negotiationAccepted",
            auctionId: auctionId,
            price: negotiation.price,
          });
        } else if (response === "reject") {
          negotiation.status = "rejected";

          sendNotification(negotiation.from, {
            type: "negotiationRejected",
            auctionId: auctionId,
          });
        } else if (response === "counter") {
          negotiation.status = "countered";
          negotiation.counterOffer = counterOffer;

          sendNotification(negotiation.from, {
            type: "counterOffer",
            from: playerName,
            auctionId: auctionId,
            counterOffer: counterOffer,
          });
        }

        saveOnlineData(data);
        return { success: true };
      }

      async function acceptAuction(auctionId, pinInput) {
        const data = getOnlineData();
        if (!data.auctions || !data.auctions[auctionId])
          return { success: false };

        const auction = data.auctions[auctionId];

        // SprawdÅº hajs
        if (money < auction.price) {
          return { success: false, error: "noMoney" };
        }

        auction.status = "sold";
        auction.soldTo = playerName;
        auction.soldPrice = auction.price;

        sendNotification(auction.seller, {
          type: "auctionSold",
          from: playerName,
          auctionId: auctionId,
          price: auction.price,
        });

        saveOnlineData(data);
        return {
          success: true,
          items: auction.items,
          item: auction.item,
          price: auction.price,
        };
      }

      async function allowWithoutPin(notifId, auctionId, buyerName) {
        const data = getOnlineData();

        sendNotification(buyerName, {
          type: "pinBypassed",
          auctionId: auctionId,
          from: playerName,
        });

        removeNotification(notifId);
        return { success: true };
      }

      async function denyWithoutPin(notifId, buyerName) {
        sendNotification(buyerName, {
          type: "pinDenied",
          from: playerName,
        });

        removeNotification(notifId);
        return { success: true };
      }

      // ========== WÅASNE UBEZPIECZENIA ==========
      async function createCustomInsurance(insurance) {
        const auctionId = await createAuction({
          type: "customInsurance",
          name: insurance.name,
          coverage: insurance.coverage,
          interval: insurance.interval,
          price: insurance.price,
          createdBy: playerName,
        });
        return auctionId;
      }

      // ========== SKLEP Z LIMITEM ==========
      async function checkShopReset() {
        const data = getOnlineData();
        if (!data.shop) data.shop = { lastReset: 0, items: {} };

        const now = Date.now();
        const lastReset = data.shop.lastReset || 0;
        const monday = getLastMonday();

        if (lastReset < monday) {
          // Reset sklepu
          data.shop.lastReset = now;
          data.shop.items = {}; // Resetuj iloÅ›ci
          saveOnlineData(data);
        }
      }

      function getLastMonday() {
        const now = new Date();
        const day = now.getDay();
        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(now.setDate(diff));
        monday.setHours(0, 0, 0, 0);
        return monday.getTime();
      }

      // ========== LOKALNE FUNKCJE BONÃ“W ==========
      function getUsedVoucherIds() {
        try {
          return JSON.parse(
            localStorage.getItem("beamng_used_vouchers") || "[]"
          );
        } catch (e) {
          return [];
        }
      }

      function markVoucherAsUsed(voucherId) {
        const used = getUsedVoucherIds();
        if (!used.includes(voucherId)) {
          used.push(voucherId);
          localStorage.setItem("beamng_used_vouchers", JSON.stringify(used));
        }
      }

      function isVoucherUsed(voucherId) {
        return getUsedVoucherIds().includes(voucherId);
      }

      async function checkUrlForVoucher() {
        const urlParams = new URLSearchParams(window.location.search);
        const t = translations[currentLang] || translations.en;

        const vid = urlParams.get("vid");
        const amount = urlParams.get("amount");
        const from = urlParams.get("from");
        const fromId = urlParams.get("fromId");
        const msg = urlParams.get("msg");
        const mode = urlParams.get("mode");

        if (vid && amount && fromId) {
          // UsuÅ„ parametry z URL od razu
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );

          // SprawdÅº status bonu online
          const onlineVoucher = checkVoucherOnline(vid);

          if (!onlineVoucher) {
            alert(t.voucherNotFound || "Nie znaleziono bonu!");
            return;
          }

          // SprawdÅº czy bon juÅ¼ wykorzystany lub anulowany
          if (onlineVoucher.status === "used") {
            alert(t.voucherAlreadyUsed || "Ten bon zostaÅ‚ juÅ¼ wykorzystany!");
            return;
          }

          if (onlineVoucher.status === "cancelled") {
            alert(
              t.voucherCancelled || "Ten bon zostaÅ‚ anulowany przez nadawcÄ™."
            );
            return;
          }

          // SprawdÅº czy link wygasÅ‚ (30 sekund od pierwszego wejÅ›cia)
          if (onlineVoucher.firstOpenedAt) {
            const timeSinceOpened = Date.now() - onlineVoucher.firstOpenedAt;
            if (timeSinceOpened > VOUCHER_EXPIRY_SECONDS * 1000) {
              alert(
                t.voucherExpired ||
                  "Ten link wygasÅ‚! Masz tylko 30 sekund od pierwszego otwarcia."
              );
              return;
            }
          }

          // Oznacz jako otwarty (pierwsze wejÅ›cie)
          markVoucherOpened(vid);

          // SprawdÅº czy nadawca nie prÃ³buje odebraÄ‡ swojego bonu
          const save = getCurrentSave();
          if (save && save.id === fromId) {
            alert(
              t.cantReceiveOwnVoucher || "Nie moÅ¼esz odebraÄ‡ wÅ‚asnego bonu!"
            );
            return;
          }

          if (isVoucherUsed(vid + "_sender_" + (save ? save.id : ""))) {
            alert(
              t.cantReceiveOwnVoucher || "Nie moÅ¼esz odebraÄ‡ wÅ‚asnego bonu!"
            );
            return;
          }

          const voucher = {
            id: vid,
            amount: parseInt(amount),
            fromSave: from || "?",
            fromSaveId: fromId,
            message: msg || "",
            gameMode: mode || "beamng",
            isFromLink: true,
          };
          showReceivedVoucherModal(voucher);
        }
      }

      function showReceivedVoucherModal(voucher) {
        const t = translations[currentLang] || translations.en;

        // Nazwa trybu gry
        const modeName =
          voucher.gameMode === "reallife"
            ? currentLang === "pl"
              ? "Real Life"
              : "Real Life"
            : "BeamNG";
        const voucherTypeName =
          voucher.gameMode === "reallife"
            ? currentLang === "pl"
              ? "kupon"
              : "coupon"
            : currentLang === "pl"
            ? "bon"
            : "voucher";

        document.getElementById("voucherPreviewContent").innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:1.2em;color:#888;margin-bottom:15px;">${
                      t.youReceivedVoucher || "DostaÅ‚eÅ›/aÅ› bon o wartoÅ›ci"
                    }</div>
                    ${renderVoucherCard(voucher)}
                    <div style="font-size:0.9em;color:#888;margin-top:10px;">${
                      t.voucherFrom || "Od:"
                    } ${voucher.fromSave || "?"}</div>
                    <div style="font-size:0.85em;margin-top:8px;padding:6px 12px;background:${
                      voucher.gameMode === "reallife"
                        ? "rgba(16,185,129,0.2)"
                        : "rgba(255,107,53,0.2)"
                    };border-radius:20px;display:inline-block;">
                        ${
                          voucher.gameMode === "reallife" ? "ğŸŒ" : "ğŸš—"
                        } ${modeName}
                    </div>
                    ${
                      voucher.isFromLink
                        ? `
                        <div id="voucherCountdown" style="font-size:1.1em;color:#ef4444;margin-top:15px;font-weight:bold;">
                            â±ï¸ <span id="countdownSeconds">30</span>s
                        </div>
                    `
                        : ""
                    }
                </div>
                
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div style="display:flex;gap:10px;">
                        <button onclick="acceptReceivedVoucher()" style="flex:1;padding:15px;background:#10b981;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;">
                            âœ… ${t.acceptVoucher || "Przyjmij"}
                        </button>
                        <button onclick="rejectReceivedVoucher()" style="flex:1;padding:15px;background:#f59e0b;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;">
                            â†©ï¸ ${t.rejectVoucher || "PrzekaÅ¼ dalej"}
                        </button>
                    </div>
                    ${
                      voucher.isFromLink
                        ? `
                        <button onclick="cancelReceivedVoucher()" style="padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-size:0.95em;cursor:pointer;">
                            âŒ ${
                              t.cancelAndRefund || "Anuluj (zwrot dla nadawcy)"
                            }
                        </button>
                    `
                        : ""
                    }
                </div>
            `;

        // Zapisz tymczasowo
        window.tempReceivedVoucher = voucher;
        openModal("voucherPreview");

        // Uruchom odliczanie 30 sekund (tylko dla linkÃ³w online)
        if (voucher.isFromLink) {
          startVoucherCountdown(voucher.id);
        }
      }

      // Odliczanie 30 sekund
      let voucherCountdownInterval = null;
      async function startVoucherCountdown(voucherId) {
        if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

        // Pobierz czas otwarcia z serwera
        const onlineVoucher = checkVoucherOnline(voucherId);
        if (!onlineVoucher || !onlineVoucher.firstOpenedAt) return;

        const startTime = onlineVoucher.firstOpenedAt;
        const endTime = startTime + VOUCHER_EXPIRY_SECONDS * 1000;

        voucherCountdownInterval = setInterval(async () => {
          const remaining = Math.max(
            0,
            Math.ceil((endTime - Date.now()) / 1000)
          );
          const countdownEl = document.getElementById("countdownSeconds");
          if (countdownEl) {
            countdownEl.textContent = remaining;
          }

          if (remaining <= 0) {
            clearInterval(voucherCountdownInterval);
            closeModal("voucherPreview");
            const t = translations[currentLang] || translations.en;
            alert(t.voucherExpired || "Czas minÄ…Å‚! Link wygasÅ‚.");
            window.tempReceivedVoucher = null;
          }
        }, 500);
      }

      // Anuluj bon i zwrÃ³Ä‡ hajs nadawcy
      async function cancelReceivedVoucher() {
        if (!window.tempReceivedVoucher) return;

        const voucher = window.tempReceivedVoucher;
        const t = translations[currentLang] || translations.en;

        // Zatrzymaj odliczanie
        if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

        // Oznacz bon jako anulowany online
        cancelVoucherOnline(voucher.id);
        markVoucherAsUsed(voucher.id);

        closeModal("voucherPreview");

        const voucherName =
          voucher.gameMode === "reallife"
            ? currentLang === "pl"
              ? "Kupon"
              : "Coupon"
            : currentLang === "pl"
            ? "Bon"
            : "Voucher";
        alert(
          `âŒ ${voucherName} ${t.cancelled || "anulowany"}!\n${
            t.refundToSender || "Zwrot dla nadawcy"
          }: ${voucher.amount.toLocaleString()} ${getCurrency()}`
        );

        window.tempReceivedVoucher = null;
      }

      async function acceptReceivedVoucher() {
        if (!window.tempReceivedVoucher) return;

        const voucher = window.tempReceivedVoucher;
        const save = getCurrentSave();
        const t = translations[currentLang] || translations.en;
        const voucherMode = voucher.gameMode || "beamng";

        // Zatrzymaj odliczanie
        if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

        // Oznacz bon jako wykorzystany
        if (voucher.isFromLink) {
          markVoucherUsedOnline(voucher.id);
          markVoucherAsUsed(voucher.id);
        } else {
          // Bon lokalny - teraz odejmij pieniÄ…dze nadawcy
          const senderSave = saves.find((s) => s.id === voucher.fromSaveId);
          if (senderSave) {
            if (senderSave.data.vouchersToSend) {
              const vIdx = senderSave.data.vouchersToSend.findIndex(
                (v) => v.id === voucher.id
              );
              if (vIdx !== -1) {
                senderSave.data.vouchersToSend.splice(vIdx, 1);
              }
            }
            const senderModeKey =
              voucherMode === "reallife" ? "realLifeData" : "beamngData";
            if (senderSave[senderModeKey]) {
              senderSave[senderModeKey].money =
                (senderSave[senderModeKey].money || 0) - voucher.amount;
            }
          }
        }

        // Dodaj pieniÄ…dze odbiorcy do odpowiedniego trybu
        const receiverModeKey =
          voucherMode === "reallife" ? "realLifeData" : "beamngData";

        if (!save[receiverModeKey]) {
          save[receiverModeKey] = {
            money: 1500,
            garage: [],
            spent: 0,
            debt: 0,
            health: 100,
            food: 1000,
            water: 1000,
            backpack: [],
            activeInsurances: [],
          };
        }
        save[receiverModeKey].money =
          (save[receiverModeKey].money || 0) + voucher.amount;

        if (voucherMode === gameMode) {
          money += voucher.amount;
        }

        localStorage.setItem("beamng_saves", JSON.stringify(saves));
        updateAllDisplays();
        closeModal("voucherPreview");

        playSound("voucher");
        const modeName = voucherMode === "reallife" ? "Real Life" : "BeamNG";
        const voucherTypeName =
          voucherMode === "reallife"
            ? currentLang === "pl"
              ? "Kupon przyjÄ™ty!"
              : "Coupon accepted!"
            : currentLang === "pl"
            ? "Bon przyjÄ™ty!"
            : "Voucher accepted!";
        alert(
          `âœ… ${voucherTypeName}\n+${voucher.amount.toLocaleString()} ${getCurrency()} (${modeName})`
        );

        window.tempReceivedVoucher = null;
      }

      async function rejectReceivedVoucher() {
        if (!window.tempReceivedVoucher) return;

        const voucher = window.tempReceivedVoucher;
        const save = getCurrentSave();

        // Zatrzymaj odliczanie
        if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

        // Oznacz stary bon jako wykorzystany
        if (voucher.isFromLink) {
          markVoucherUsedOnline(voucher.id);
          markVoucherAsUsed(voucher.id);
        }

        // UtwÃ³rz nowy bon z nowym ID (bo przekazujesz dalej)
        const newVoucher = {
          id:
            "bon_" + Date.now() + "_" + Math.random().toString(36).substr(2, 6),
          amount: voucher.amount,
          message: voucher.message,
          createdAt: Date.now(),
          fromSave: save.name,
          fromSaveId: save.id,
          gameMode: voucher.gameMode || gameMode,
          originalFrom: voucher.fromSave,
        };

        if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
        save.data.vouchersToSend.push(newVoucher);

        saveSaveData();
        closeModal("voucherPreview");

        // Od razu otwÃ³rz udostÄ™pnianie
        currentVoucherToShare = {
          voucher: newVoucher,
          index: save.data.vouchersToSend.length - 1,
          source: "toSend",
        };
        openShareModal();

        window.tempReceivedVoucher = null;
      }

      // ==================== UI NAPRAWY ====================
      let selectedRepairCarIndex = null;

      function renderRepairCarList() {
        const list = document.getElementById("repairCarList");
        const t = translations[currentLang] || translations.en;

        // Filtruj tylko zepsute auta
        const brokenCars = garage.filter((car) => car.broken);

        if (brokenCars.length === 0) {
          list.innerHTML = `<div style="color:#888;text-align:center;padding:20px;">
                    <div style="font-size:3em;margin-bottom:10px;">âœ…</div>
                    <p>${t.noBrokenCars || "Wszystkie auta sÄ… sprawne!"}</p>
                    <p style="font-size:0.85em;margin-top:10px;">${
                      t.goToGarage || "IdÅº do GaraÅ¼u Å¼eby ulepszaÄ‡ auta"
                    }</p>
                </div>`;
          document.getElementById("repairResponse").style.display = "none";
          document.getElementById("repairBtn").style.display = "none";
          return;
        }

        list.innerHTML = brokenCars
          .map((car, idx) => {
            const realIdx = garage.findIndex((c) => c.id === car.id);
            return `
                    <div class="garage-item" onclick="selectCarForRepair(${realIdx})" style="cursor:pointer;background:rgba(239,68,68,0.1);border:2px solid ${
              selectedRepairCarIndex === realIdx ? "#f59e0b" : "#ef4444"
            };${
              selectedRepairCarIndex === realIdx
                ? "background:rgba(245,158,11,0.1);"
                : ""
            }">
                        <div>
                            <div class="car-name">ğŸ”§ ${car.brand} ${
              car.model
            }</div>
                            <div style="font-size:0.8em;color:#888;">${
                              car.year || ""
                            }</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#ef4444;font-size:0.9em;">${
                              t.repairCost || "Koszt"
                            }: 150 ${getCurrency()}</div>
                            ${
                              selectedRepairCarIndex === realIdx
                                ? '<span style="color:#f59e0b;">âœ“ wybrane</span>'
                                : ""
                            }
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function selectCarForRepair(idx) {
        selectedRepairCarIndex = idx;
        renderRepairCarList();
        document.getElementById("repairResponse").style.display = "block";
        document.getElementById("repairBtn").style.display = "block";

        // Aktualizuj wyÅ›wietlany koszt
        const insuranceHelp = getRepairInsuranceHelp();
        const finalCost = Math.max(0, 150 - insuranceHelp);
        document.getElementById(
          "repairCostDisplay"
        ).textContent = `-${finalCost.toLocaleString()} ${getCurrency()}`;
      }

      function confirmRepair() {
        const t = translations[currentLang] || translations.en;
        const repairCost = 150; // Koszt naprawy zepsutego auta

        if (
          selectedRepairCarIndex === null ||
          selectedRepairCarIndex >= garage.length
        ) {
          alert(t.selectCarToRepair || "Wybierz auto do naprawy!");
          return;
        }

        const car = garage[selectedRepairCarIndex];

        if (!car.broken) {
          alert(t.carNotBroken || "To auto nie jest zepsute!");
          return;
        }

        // SprawdÅº czy ma ubezpieczenie na naprawÄ™
        const insuranceHelp = getRepairInsuranceHelp();
        const finalCost = Math.max(0, repairCost - insuranceHelp);

        if (money < finalCost) {
          // Dodaj do dÅ‚ugÃ³w
          const save = getCurrentSave();
          if (!save.data.debts) save.data.debts = [];
          save.data.debts.push({
            type: "repair",
            amount: finalCost,
            description: `${t.repairDebt || "Naprawa auta"}: ${car.brand} ${
              car.model
            }`,
            date: Date.now(),
          });
          car.broken = false;
          saveState();
          updateAllDisplays();
          closeModal("repair");
          playSound("repair");
          alert(
            `ğŸ”§ ${car.brand} ${car.model} - ${
              t.repaired || "Naprawione!"
            }\nğŸ’³ ${
              t.addedToDebt || "Dodano do dÅ‚ugu"
            }: ${finalCost.toLocaleString()} ${getCurrency()}`
          );
        } else {
          money -= finalCost;
          spent += finalCost;
          car.broken = false;
          saveState();
          updateAllDisplays();
          closeModal("repair");
          playSound("repair");

          let msg = `ğŸ”§ ${car.brand} ${car.model} - ${
            t.repaired || "Naprawione!"
          }\n-${finalCost.toLocaleString()} ${getCurrency()}`;
          if (insuranceHelp > 0) {
            msg += `\nğŸ›¡ï¸ ${
              t.insuranceCovered || "Ubezpieczenie pokryÅ‚o"
            }: ${insuranceHelp.toLocaleString()} ${getCurrency()}`;
          }
          alert(msg);
        }

        selectedRepairCarIndex = null;
      }

      function getRepairInsuranceHelp() {
        const save = getCurrentSave();
        const activeIns = save.data.activeInsurances || [];
        let help = 0;

        activeIns.forEach((ins) => {
          if (ins.type === "repair" && ins.coveragePercent) {
            help = Math.max(help, 150 * (ins.coveragePercent / 100));
          }
        });

        return Math.floor(help);
      }

      // ==================== GARAÅ» ====================

      function renderGarageModal() {
        const list = document.getElementById("garageList");
        const empty = document.getElementById("garageEmpty");
        const t = translations[currentLang] || translations.en;

        if (garage.length === 0) {
          list.style.display = "none";
          empty.style.display = "block";
          return;
        }

        list.style.display = "block";
        empty.style.display = "none";

        list.innerHTML = garage
          .map((car, idx) => {
            const upgradePercent = car.upgradePercent || 50;
            const sellPrice = Math.floor(car.price * (upgradePercent / 100));
            const isBroken = car.broken;
            const isUpgrading = car.isUpgrading || false;

            return `
                    <div style="padding:15px;margin-bottom:10px;background:${
                      isBroken
                        ? "rgba(239,68,68,0.2)"
                        : isUpgrading
                        ? "rgba(99,102,241,0.2)"
                        : "rgba(0,0,0,0.3)"
                    };border:2px solid ${
              isBroken ? "#ef4444" : isUpgrading ? "#6366f1" : "#333"
            };border-radius:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <div>
                                <div style="font-size:1.1em;font-weight:bold;">${
                                  car.brand
                                } ${car.model}</div>
                                <div style="font-size:0.85em;color:#888;">${
                                  car.year || ""
                                }</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.8em;color:#888;">${
                                  t.sellValue || "WartoÅ›Ä‡"
                                }:</div>
                                <div style="color:#4ade80;font-weight:bold;">${sellPrice.toLocaleString()} ${getCurrency()}</div>
                                <div style="font-size:0.75em;color:${
                                  upgradePercent > 100 ? "#4ade80" : "#f59e0b"
                                };">(${upgradePercent.toFixed(1)}%)</div>
                            </div>
                        </div>
                        ${
                          isBroken
                            ? `
                            <div style="background:rgba(239,68,68,0.3);padding:8px;border-radius:8px;text-align:center;margin-bottom:10px;">
                                <span style="color:#ef4444;">ğŸ”§ ${
                                  t.carBroken || "Auto zepsute!"
                                }</span>
                            </div>
                        `
                            : isUpgrading
                            ? `
                            <div style="background:rgba(99,102,241,0.3);padding:8px;border-radius:8px;text-align:center;margin-bottom:10px;">
                                <span style="color:#6366f1;">âš¡ ${
                                  t.upgrading || "Ulepszanie w toku..."
                                }</span>
                            </div>
                        `
                            : ""
                        }
                        <div style="display:flex;gap:8px;">
                            ${
                              isBroken
                                ? `
                                <button onclick="goToRepair()" style="flex:1;padding:10px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;">
                                    ğŸ”§ ${t.repair || "Napraw"}
                                </button>
                            `
                                : isUpgrading
                                ? `
                                <button onclick="stopCarUpgrade(${idx})" style="flex:1;padding:10px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;">
                                    â¸ï¸ ${t.stopUpgrade || "Zatrzymaj"}
                                </button>
                            `
                                : `
                                <button onclick="startCarUpgrade(${idx})" style="flex:1;padding:10px;background:#6366f1;color:white;border:none;border-radius:8px;cursor:pointer;">
                                    â¬†ï¸ ${t.startUpgrade || "Ulepszaj"}
                                </button>
                            `
                            }
                            <button onclick="sellCarFromGarage(${idx})" style="padding:10px 15px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;">
                                ğŸ’° ${t.sell || "Sprzedaj"}
                            </button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function goToRepair() {
        closeModal("garage");
        openModal("repair");
      }

      function sellCarFromGarage(idx) {
        const t = translations[currentLang] || translations.en;
        const car = garage[idx];
        if (!car) return;

        if (car.broken) {
          alert(
            t.cantSellBroken ||
              "Nie moÅ¼esz sprzedaÄ‡ zepsutego auta! Najpierw je napraw."
          );
          return;
        }

        // Zatrzymaj ulepszanie przed sprzedaÅ¼Ä…
        if (car.isUpgrading) {
          stopCarUpgrade(idx);
        }

        const upgradePercent = car.upgradePercent || 50;
        const sellPrice = Math.floor(car.price * (upgradePercent / 100));

        if (
          confirm(
            `${t.confirmSell || "SprzedaÄ‡"} ${car.brand} ${car.model} ${
              t.forPrice || "za"
            } ${sellPrice.toLocaleString()} ${getCurrency()}?`
          )
        ) {
          money += sellPrice;
          garage.splice(idx, 1);
          saveState();
          updateAllDisplays();
          renderGarageModal();
          renderGarage();
          alert(
            `âœ… ${
              t.sold || "Sprzedano!"
            } +${sellPrice.toLocaleString()} ${getCurrency()}`
          );
        }
      }

      // === NOWY SYSTEM ULEPSZANIA - jedno klikniÄ™cie, dziaÅ‚a w tle ===
      function startCarUpgrade(idx) {
        const car = garage[idx];
        if (!car || car.broken) return;

        car.isUpgrading = true;

        // Pobierz bonus z ubezpieczenia
        const upgradeBonus = getUpgradeBonus();
        const baseRate = 0.1 + upgradeBonus.rateBonus;
        const breakChance = 0.005 - upgradeBonus.safetyBonus;

        // Uruchom interwaÅ‚ dla tego auta
        upgradeIntervals[idx] = setInterval(() => {
          const currentCar = garage[idx];
          if (!currentCar || currentCar.broken) {
            stopCarUpgrade(idx);
            return;
          }

          // SprawdÅº czy siÄ™ zepsuÅ‚o
          if (Math.random() < Math.max(0.001, breakChance)) {
            carBrokeNew(idx);
            return;
          }

          // Ulepszaj
          currentCar.upgradePercent = Math.min(
            1000,
            (currentCar.upgradePercent || 50) + baseRate
          );
          playSound("upgrade");
          saveState();
        }, 1000);

        saveState();
        renderGarageModal();
      }

      function stopCarUpgrade(idx) {
        const car = garage[idx];
        if (!car) return;

        car.isUpgrading = false;

        if (upgradeIntervals[idx]) {
          clearInterval(upgradeIntervals[idx]);
          delete upgradeIntervals[idx];
        }

        saveState();
        renderGarageModal();
      }

      function carBrokeNew(idx) {
        const t = translations[currentLang] || translations.en;
        const car = garage[idx];
        if (!car) return;

        // Zatrzymaj ulepszanie
        car.isUpgrading = false;
        if (upgradeIntervals[idx]) {
          clearInterval(upgradeIntervals[idx]);
          delete upgradeIntervals[idx];
        }

        // Oznacz jako zepsute
        car.broken = true;
        car.upgradePercent = Math.max(50, (car.upgradePercent || 50) - 5);

        playSound("break");

        // Koszty zepsucia
        const repairDebt = 150;
        if (money >= repairDebt) {
          money -= repairDebt;
          spent += repairDebt;
        } else {
          addDebt(repairDebt - money);
          money = 0;
        }

        saveState();
        updateAllDisplays();
        renderGarageModal();

        alert(
          `ğŸ’¥ ${car.brand} ${car.model} ${
            t.carBrokeMsg || "siÄ™ zepsuÅ‚o!"
          }\n-150 ${getCurrency()}, -5% ${t.value || "wartoÅ›ci"}`
        );
      }

      // WznÃ³w ulepszanie po zaÅ‚adowaniu save'a
      function resumeUpgrades() {
        garage.forEach((car, idx) => {
          if (car.isUpgrading && !car.broken) {
            // Uruchom ponownie interwaÅ‚
            const upgradeBonus = getUpgradeBonus();
            const baseRate = 0.1 + upgradeBonus.rateBonus;
            const breakChance = 0.005 - upgradeBonus.safetyBonus;

            upgradeIntervals[idx] = setInterval(() => {
              const currentCar = garage[idx];
              if (!currentCar || currentCar.broken) {
                stopCarUpgrade(idx);
                return;
              }

              if (Math.random() < Math.max(0.001, breakChance)) {
                carBrokeNew(idx);
                return;
              }

              currentCar.upgradePercent = Math.min(
                1000,
                (currentCar.upgradePercent || 50) + baseRate
              );
              playSound("upgrade");
              saveState();
            }, 1000);
          }
        });
      }

      // Stary system - do usuniÄ™cia lub zostawienia dla kompatybilnoÅ›ci
      let upgradingCarIndex = null;
      let isUpgrading = false;
      let upgradeInterval = null;

      function openUpgradeModal(idx) {
        upgradingCarIndex = idx;
        const car = garage[idx];
        const t = translations[currentLang] || translations.en;

        document.getElementById("upgradeCarInfo").innerHTML = `
                <div style="font-size:2em;">ğŸš—</div>
                <div style="font-size:1.3em;font-weight:bold;">${car.brand} ${
          car.model
        }</div>
                <div style="color:#888;">${car.year || ""} â€¢ ${
          car.type || ""
        }</div>
                <div style="color:#4ade80;margin-top:5px;">${
                  t.basePrice || "Cena bazowa"
                }: ${car.price.toLocaleString()} ${getCurrency()}</div>
            `;

        updateUpgradeDisplay();
        document.getElementById(
          "upgradeStatus"
        ).innerHTML = `<span style="color:#888;">${
          t.clickToStart || "Kliknij aby rozpoczÄ…Ä‡ ulepszanie"
        }</span>`;
        document.getElementById(
          "upgradeBtn"
        ).innerHTML = `â–¶ï¸ <span data-translate="startUpgrade">${
          t.startUpgrade || "Rozpocznij ulepszanie"
        }</span>`;

        closeModal("garage");
        openModal("upgrade");
      }

      function updateUpgradeDisplay() {
        if (upgradingCarIndex === null) return;
        const car = garage[upgradingCarIndex];
        const percent = car.upgradePercent || 50;

        document.getElementById("upgradeSellPercent").textContent =
          percent.toFixed(1) + "%";
        document.getElementById("upgradeProgressBar").style.width =
          ((percent - 50) / 950) * 100 + "%";
      }

      function toggleUpgrade() {
        const t = translations[currentLang] || translations.en;

        if (isUpgrading) {
          stopUpgrade();
        } else {
          startUpgrade();
        }
      }

      function startUpgrade() {
        if (upgradingCarIndex === null) return;
        const t = translations[currentLang] || translations.en;

        isUpgrading = true;
        document.getElementById("upgradeBtn").innerHTML = `â¸ï¸ <span>${
          t.stopUpgrade || "Zatrzymaj"
        }</span>`;
        document.getElementById("upgradeBtn").style.background = "#ef4444";
        document.getElementById(
          "upgradeStatus"
        ).innerHTML = `<span style="color:#4ade80;">âš¡ ${
          t.upgrading || "Ulepszanie w toku..."
        }</span>`;

        // Pobierz bonus z ubezpieczenia
        const upgradeBonus = getUpgradeBonus();
        const baseRate = 0.1 + upgradeBonus.rateBonus;
        const breakChance = 0.005 - upgradeBonus.safetyBonus; // 0.5% co sekundÄ™ bazowo

        upgradeInterval = setInterval(() => {
          const car = garage[upgradingCarIndex];
          if (!car) {
            stopUpgrade();
            return;
          }

          // SprawdÅº czy siÄ™ zepsuÅ‚o
          if (Math.random() < Math.max(0.001, breakChance)) {
            carBroke();
            return;
          }

          // Ulepszaj
          car.upgradePercent = Math.min(
            1000,
            (car.upgradePercent || 50) + baseRate
          );
          playSound("upgrade");
          updateUpgradeDisplay();
          saveState();
        }, 1000);
      }

      function stopUpgrade() {
        const t = translations[currentLang] || translations.en;
        isUpgrading = false;
        if (upgradeInterval) clearInterval(upgradeInterval);
        upgradeInterval = null;

        document.getElementById("upgradeBtn").innerHTML = `â–¶ï¸ <span>${
          t.startUpgrade || "Rozpocznij ulepszanie"
        }</span>`;
        document.getElementById("upgradeBtn").style.background = "#10b981";
        document.getElementById(
          "upgradeStatus"
        ).innerHTML = `<span style="color:#888;">${
          t.upgradeStopped || "Ulepszanie zatrzymane"
        }</span>`;
      }

      function carBroke() {
        const t = translations[currentLang] || translations.en;
        stopUpgrade();
        playSound("break");

        const car = garage[upgradingCarIndex];
        car.broken = true;
        car.upgradePercent = Math.max(50, (car.upgradePercent || 50) - 5);

        const repairDebt = 150;
        if (money >= repairDebt) {
          money -= repairDebt;
          spent += repairDebt;
        } else {
          // Dodaj do dÅ‚ugÃ³w
          const save = getCurrentSave();
          if (!save.data.debts) save.data.debts = [];
          save.data.debts.push({
            type: "carBreak",
            amount: repairDebt,
            description: `${t.carBreakDebt || "Zepsucie auta"}: ${car.brand} ${
              car.model
            }`,
            date: Date.now(),
          });
        }

        saveState();
        updateAllDisplays();
        updateUpgradeDisplay();

        document.getElementById(
          "upgradeStatus"
        ).innerHTML = `<span style="color:#ef4444;">ğŸ’¥ ${
          t.carBrokeMsg || "Auto siÄ™ zepsuÅ‚o! -150 zÅ‚, -5%"
        }</span>`;

        alert(
          `ğŸ’¥ ${
            t.carBrokeMsg || "Auto siÄ™ zepsuÅ‚o!"
          }\n-150 ${getCurrency()}\n-5% wartoÅ›ci`
        );
      }

      function getUpgradeBonus() {
        // SprawdÅº aktywne ubezpieczenia na ulepszanie
        const save = getCurrentSave();
        const activeIns = save.data.activeInsurances || [];

        let rateBonus = 0;
        let safetyBonus = 0;

        activeIns.forEach((ins) => {
          if (ins.type === "upgrade") {
            rateBonus += ins.rateBonus || 0;
            safetyBonus += ins.safetyBonus || 0;
          }
        });

        return { rateBonus, safetyBonus };
      }

      function closeUpgradeModal() {
        stopUpgrade();
        upgradingCarIndex = null;
        closeModal("upgrade");
      }

      // ==================== PRACA ====================
      const jobs = [
        {
          id: "cleaner",
          name: "SprzÄ…tacz",
          nameEn: "Cleaner",
          basePay: 500,
          difficulty: 1,
        },
        {
          id: "cashier",
          name: "Kasjer",
          nameEn: "Cashier",
          basePay: 600,
          difficulty: 1,
        },
        {
          id: "waiter",
          name: "Kelner",
          nameEn: "Waiter",
          basePay: 700,
          difficulty: 1,
        },
        {
          id: "cook",
          name: "Kucharz",
          nameEn: "Cook",
          basePay: 900,
          difficulty: 2,
        },
        {
          id: "driver",
          name: "Kierowca",
          nameEn: "Driver",
          basePay: 1100,
          difficulty: 2,
        },
        {
          id: "mechanic",
          name: "Mechanik",
          nameEn: "Mechanic",
          basePay: 1300,
          difficulty: 2,
        },
        {
          id: "electrician",
          name: "Elektryk",
          nameEn: "Electrician",
          basePay: 1500,
          difficulty: 3,
        },
        {
          id: "programmer",
          name: "Programista",
          nameEn: "Programmer",
          basePay: 2200,
          difficulty: 3,
        },
        {
          id: "lawyer",
          name: "Prawnik",
          nameEn: "Lawyer",
          basePay: 2800,
          difficulty: 4,
        },
        {
          id: "doctor",
          name: "Lekarz",
          nameEn: "Doctor",
          basePay: 3200,
          difficulty: 4,
        },
        {
          id: "surgeon",
          name: "Chirurg",
          nameEn: "Surgeon",
          basePay: 4500,
          difficulty: 5,
        },
        {
          id: "pilot",
          name: "Pilot",
          nameEn: "Pilot",
          basePay: 5500,
          difficulty: 5,
        },
        {
          id: "ceo",
          name: "Dyrektor",
          nameEn: "CEO",
          basePay: 7000,
          difficulty: 5,
        },
      ];

      // Wymagane doÅ›wiadczenie na kaÅ¼dy poziom gwiazdek
      const JOBS_REQUIRED_PER_STAR = 3; // 3 prace na poprzednim poziomie = odblokowanie nastÄ™pnego

      function getWorkExperience() {
        const save = getCurrentSave();
        if (!save) return { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        const modeKey = gameMode === "reallife" ? "realLifeData" : "beamngData";
        if (!save[modeKey]) {
          save[modeKey] = {
            money: 1500, garage: [], spent: 0, debt: 0, debtDeadline: null,
            totalTaxPaid: 0, health: 100, food: 1000, water: 1000, backpack: [],
            activeInsurances: [], businesses: [], credits: [],
            workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
            vouchersToSend: [], receivedVouchers: []
          };
        }
        if (!save[modeKey].workExperience) {
          save[modeKey].workExperience = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        }
        return save[modeKey].workExperience;
      }

      function saveWorkExperience(exp) {
        const save = getCurrentSave();
        if (!save) return;
        const modeKey = gameMode === "reallife" ? "realLifeData" : "beamngData";
        if (!save[modeKey]) save[modeKey] = {};
        save[modeKey].workExperience = exp;
        saveState();
      }

      function getUnlockedStars() {
        const exp = getWorkExperience();
        let unlocked = 1; // 1 gwiazdka zawsze odblokowana
        
        if (exp[1] >= JOBS_REQUIRED_PER_STAR) unlocked = 2;
        if (exp[1] >= JOBS_REQUIRED_PER_STAR && exp[2] >= JOBS_REQUIRED_PER_STAR) unlocked = 3;
        if (exp[1] >= JOBS_REQUIRED_PER_STAR && exp[2] >= JOBS_REQUIRED_PER_STAR && exp[3] >= JOBS_REQUIRED_PER_STAR) unlocked = 4;
        if (exp[1] >= JOBS_REQUIRED_PER_STAR && exp[2] >= JOBS_REQUIRED_PER_STAR && exp[3] >= JOBS_REQUIRED_PER_STAR && exp[4] >= JOBS_REQUIRED_PER_STAR) unlocked = 5;
        
        return unlocked;
      }

      function addWorkExperience(difficulty) {
        const exp = getWorkExperience();
        exp[difficulty] = (exp[difficulty] || 0) + 1;
        saveWorkExperience(exp);
      }

      let workInterval = null;
      let sleepInterval = null;
      let coinInterval = null;
      let workTimeLeft = 120;
      let workEarned = 0;
      let workBonus = 0;
      let sleepLevel = 0;
      let currentJob = null;

      function renderJobsList() {
        const list = document.getElementById("jobsList");
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';
        const unlockedStars = getUnlockedStars();
        const exp = getWorkExperience();

        list.innerHTML = jobs
          .map((job) => {
            const difficultyStars = "â­".repeat(job.difficulty);
            const jobName = currentLang === "pl" ? job.name : job.nameEn;
            const isLocked = job.difficulty > unlockedStars;
            
            // Oblicz ile jeszcze prac potrzeba
            let lockInfo = '';
            if (isLocked) {
              const prevLevel = job.difficulty - 1;
              const done = exp[prevLevel] || 0;
              const needed = JOBS_REQUIRED_PER_STAR - done;
              lockInfo = isEn 
                ? `ğŸ”’ Complete ${needed} more ${prevLevel}â­ jobs to unlock`
                : `ğŸ”’ Wykonaj jeszcze ${needed} prac ${prevLevel}â­ aby odblokowaÄ‡`;
            }

            // PokaÅ¼ postÄ™p na aktualnym poziomie
            const currentExp = exp[job.difficulty] || 0;
            const progressInfo = !isLocked && job.difficulty < 5
              ? `<div style="font-size:0.7em;color:#666;margin-top:3px;">${isEn ? 'Progress' : 'PostÄ™p'}: ${currentExp}/${JOBS_REQUIRED_PER_STAR}</div>`
              : '';

            if (isLocked) {
              return `
                <div style="padding:15px;margin-bottom:10px;background:rgba(0,0,0,0.5);border:2px solid #444;border-radius:12px;opacity:0.5;cursor:not-allowed;">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                      <div style="font-size:1.1em;font-weight:bold;color:#666;">ğŸ”’ ${jobName}</div>
                      <div style="font-size:0.85em;color:#555;">${difficultyStars}</div>
                    </div>
                    <div style="text-align:right;">
                      <div style="color:#666;font-weight:bold;">${job.basePay.toLocaleString()} ${getCurrency()}</div>
                    </div>
                  </div>
                  <div style="font-size:0.8em;color:#f59e0b;margin-top:8px;text-align:center;">${lockInfo}</div>
                </div>
              `;
            }

            return `
              <div onclick="startWork('${job.id}')" style="padding:15px;margin-bottom:10px;background:rgba(0,0,0,0.3);border:2px solid #333;border-radius:12px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='#333'">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div>
                    <div style="font-size:1.1em;font-weight:bold;">${jobName}</div>
                    <div style="font-size:0.85em;color:#888;">${difficultyStars}</div>
                    ${progressInfo}
                  </div>
                  <div style="text-align:right;">
                    <div style="color:#4ade80;font-weight:bold;">${job.basePay.toLocaleString()} ${getCurrency()}</div>
                    <div style="font-size:0.75em;color:#888;">+ ${t.bonuses || "bonusy"}</div>
                    <div style="font-size:0.7em;color:#f59e0b;">ğŸ’° x${job.difficulty} ${isEn ? 'bonus' : 'bonus'}</div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function startWork(jobId) {
        currentJob = jobs.find((j) => j.id === jobId);
        if (!currentJob) return;

        // SprawdÅº czy praca jest odblokowana
        const unlockedStars = getUnlockedStars();
        if (currentJob.difficulty > unlockedStars) {
          const isEn = currentLang === 'en';
          showToast(`ğŸ”’ ${isEn ? 'This job is locked! Complete more lower-level jobs first.' : 'Ta praca jest zablokowana! Wykonaj wiÄ™cej prac niÅ¼szego poziomu.'}`);
          return;
        }

        const t = translations[currentLang] || translations.en;
        workTimeLeft = 120;
        workEarned = 0;
        workBonus = 0;
        sleepLevel = 0;

        document.getElementById("workJobName").textContent =
          currentLang === "pl" ? currentJob.name : currentJob.nameEn;
        document.getElementById("workTimer").textContent = "2:00";
        document.getElementById("workEarned").textContent = "0";
        document.getElementById("workBonus").textContent = "0";
        document.getElementById("sleepOverlayTop").style.height = "0";
        document.getElementById("sleepOverlayBottom").style.height = "0";
        document.getElementById("coinsContainer").innerHTML = "";

        closeModal("work");
        openModal("workGame");
        playSound("workStart");

        // Timer
        workInterval = setInterval(() => {
          workTimeLeft--;
          const mins = Math.floor(workTimeLeft / 60);
          const secs = workTimeLeft % 60;
          document.getElementById("workTimer").textContent = `${mins}:${secs
            .toString()
            .padStart(2, "0")}`;

          if (workTimeLeft <= 0) {
            endWork();
          }
        }, 1000);

        // Zasypianie - im trudniejsza praca tym WOLNIEJ zasypiasz (bo jesteÅ› skupiony)
        // Ale Å‚atwiejsze prace = szybciej zasypiasz z nudÃ³w
        const sleepRate = 1.5 - currentJob.difficulty * 0.2; // 1â­ = 1.3, 5â­ = 0.5 - szybsze zasypianie
        sleepInterval = setInterval(() => {
          sleepLevel = Math.min(48, sleepLevel + sleepRate); // max 48% - prawie nic nie widaÄ‡
          updateSleepVisuals();
        }, 300); // szybsze tickowanie

        // SpadajÄ…ce monety - trudniejsza praca = wiÄ™cej monet (bo wiÄ™cej okazji)
        const coinRate = 800 + currentJob.difficulty * 200; // 1â­ = 1000ms, 5â­ = 1800ms miÄ™dzy monetami
        coinInterval = setInterval(() => {
          spawnCoin();
        }, coinRate);
      }

      function spawnCoin() {
        const container = document.getElementById("coinsContainer");
        const coin = document.createElement("div");
        coin.className = "falling-coin";
        coin.innerHTML = "ğŸ’°";
        coin.style.cssText = `
                position: absolute;
                top: -60px;
                left: ${Math.random() * 80 + 10}%;
                font-size: 4em;
                cursor: pointer;
                z-index: 5;
                transition: top 3s linear;
            `;

        coin.onclick = () => {
          playSound("coin");
          workBonus += 100;
          document.getElementById("workBonus").textContent =
            workBonus.toLocaleString();
          coin.innerHTML = "+100";
          coin.style.color = "#4ade80";
          coin.style.fontSize = "2em";
          setTimeout(() => coin.remove(), 300);
        };

        container.appendChild(coin);

        setTimeout(() => {
          coin.style.top = "calc(100% + 60px)";
        }, 50);

        setTimeout(() => {
          if (coin.parentNode) coin.remove();
        }, 3500);
      }

      function updateSleepVisuals() {
        document.getElementById("sleepOverlayTop").style.height =
          sleepLevel + "%";
        document.getElementById("sleepOverlayBottom").style.height =
          sleepLevel + "%";

        // Monety prawie niewidoczne przy max Å›nie
        const coinsOpacity = 1 - (sleepLevel / 48) * 0.95; // od 1 do 0.05
        document.getElementById("coinsContainer").style.opacity = coinsOpacity;
      }

      // PÅ‚ynne otwieranie oczu - im wiÄ™cej Å›pisz tym wolniej siÄ™ otwierajÄ…
      let wakeUpInterval = null;

      function startWakeUp() {
        if (wakeUpInterval) return;
        wakeUpInterval = setInterval(() => {
          // Im wiÄ™cej Å›pisz, tym wolniej otwierasz oczy (mniejszy krok)
          const openSpeed = Math.max(0.5, 3 - (sleepLevel / 48) * 2.5); // od 3 do 0.5
          sleepLevel = Math.max(0, sleepLevel - openSpeed);
          updateSleepVisuals();
        }, 50); // pÅ‚ynna animacja
      }

      function stopWakeUp() {
        if (wakeUpInterval) {
          clearInterval(wakeUpInterval);
          wakeUpInterval = null;
        }
      }

      function wakeUp() {
        // Pojedyncze klikniÄ™cie - maÅ‚e otwarcie
        const openSpeed = Math.max(0.5, 3 - (sleepLevel / 48) * 2.5);
        sleepLevel = Math.max(0, sleepLevel - openSpeed * 2);
        updateSleepVisuals();
      }

      // Przerwij pracÄ™ wczeÅ›niej (-3% wypÅ‚aty)
      function quitWorkEarly() {
        if (!confirm("PrzerwaÄ‡ pracÄ™? Dostaniesz 3% mniej wypÅ‚aty.")) return;

        clearInterval(workInterval);
        clearInterval(sleepInterval);
        clearInterval(coinInterval);
        stopWakeUp();

        const t = translations[currentLang] || translations.en;
        const basePay = currentJob.basePay;

        // Proporcja przepracowanego czasu (120s = peÅ‚ny czas)
        const timeWorked = 120 - workTimeLeft;
        const timeRatio = timeWorked / 120;

        // Podstawa proporcjonalna do czasu
        const proportionalBase = Math.round(basePay * timeRatio);

        // Bonus za zebrane monety
        const totalEarned = proportionalBase + workBonus;

        // Kara za spanie
        const sleepPenalty = (sleepLevel / 45) * 0.9;
        const moneyLostSleep = Math.round(totalEarned * sleepPenalty);

        // Kara 3% za wczeÅ›niejsze przerwanie
        const earlyPenalty = 0.03;
        const moneyLostEarly = Math.round(
          (totalEarned - moneyLostSleep) * earlyPenalty
        );

        // Finalna wypÅ‚ata (zaokrÄ…glona)
        const finalPay = Math.round(
          totalEarned - moneyLostSleep - moneyLostEarly
        );

        money += finalPay;
        saveState();
        updateAllDisplays();

        closeModal("workGame");
        playSound("workEnd");

        let msg = `ğŸ’¼ ${t.workInterrupted || "Praca przerwana!"}\n\n`;
        msg += `â±ï¸ Przepracowano: ${Math.floor(timeWorked / 60)}:${(
          timeWorked % 60
        )
          .toString()
          .padStart(2, "0")}\n`;
        msg += `${
          t.basePay || "Podstawa"
        }: ${proportionalBase.toLocaleString()} ${getCurrency()}\n`;
        msg += `ğŸ’° ${
          t.coinsCollected || "Zebrane monety"
        }: +${workBonus.toLocaleString()} ${getCurrency()}\n`;
        if (moneyLostSleep > 0) {
          msg += `ğŸ˜´ ${
            t.sleepPenalty || "Strata za spanie"
          }: -${moneyLostSleep.toLocaleString()} ${getCurrency()}\n`;
        }
        msg += `â¹ï¸ Kara za przerwanie: -${moneyLostEarly.toLocaleString()} ${getCurrency()} (3%)\n`;
        msg += `\n${
          t.total || "Razem"
        }: ${finalPay.toLocaleString()} ${getCurrency()}`;

        alert(msg);
        currentJob = null;
      }

      function endWork() {
        clearInterval(workInterval);
        clearInterval(sleepInterval);
        clearInterval(coinInterval);
        stopWakeUp(); // Zatrzymaj otwieranie oczu

        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';
        const basePay = currentJob.basePay;

        // Bonus za gwiazdki - im wiÄ™cej gwiazdek tym wiÄ™kszy mnoÅ¼nik bonusu
        const starMultiplier = currentJob.difficulty;
        const starBonus = Math.floor(workBonus * (starMultiplier - 1)); // dodatkowy bonus za gwiazdki
        
        // Bonus za klikanie monet + bonus za gwiazdki
        const totalEarned = basePay + workBonus + starBonus;

        // Im wiÄ™cej Å›pisz (sleepLevel 0-45), tym wiÄ™cej TRACISZ (0-90%)
        const sleepPenalty = (sleepLevel / 45) * 0.9;
        const moneyLost = Math.floor(totalEarned * sleepPenalty);
        const finalPay = totalEarned - moneyLost;

        money += finalPay;
        
        // Dodaj doÅ›wiadczenie za ukoÅ„czonÄ… pracÄ™
        addWorkExperience(currentJob.difficulty);
        
        saveState();
        updateAllDisplays();

        closeModal("workGame");
        playSound("workEnd");

        const penaltyPercent = Math.floor(sleepPenalty * 100);
        let msg = `ğŸ’¼ ${t.workDone || "Praca zakoÅ„czona!"}\n\n`;
        msg += `${t.basePay || "Podstawa"}: ${basePay.toLocaleString()} ${getCurrency()}\n`;
        msg += `ğŸ’° ${t.coinsCollected || "Zebrane monety"}: +${workBonus.toLocaleString()} ${getCurrency()}\n`;
        if (starBonus > 0) {
          msg += `â­ ${isEn ? "Star bonus" : "Bonus za gwiazdki"} (x${starMultiplier}): +${starBonus.toLocaleString()} ${getCurrency()}\n`;
        }
        if (moneyLost > 0) {
          msg += `ğŸ˜´ ${t.sleepPenalty || "Strata za spanie"}: -${moneyLost.toLocaleString()} ${getCurrency()} (${penaltyPercent}%)\n`;
        }
        msg += `\n${t.total || "Razem"}: ${finalPay.toLocaleString()} ${getCurrency()}`;
        
        // Info o postÄ™pie
        const exp = getWorkExperience();
        const currentExp = exp[currentJob.difficulty] || 0;
        if (currentJob.difficulty < 5) {
          msg += `\n\nğŸ“Š ${isEn ? "Progress" : "PostÄ™p"} ${currentJob.difficulty}â­: ${currentExp}/${JOBS_REQUIRED_PER_STAR}`;
          if (currentExp >= JOBS_REQUIRED_PER_STAR && currentJob.difficulty < 5) {
            msg += `\nğŸ‰ ${isEn ? "Next level unlocked!" : "NastÄ™pny poziom odblokowany!"}`;
          }
        }

        alert(msg);
        currentJob = null;
      }

      // ==================== UI SYSTEMU ONLINE ====================

      // Renderuj konto online
      function renderOnlineAccount() {
        const t = translations[currentLang] || translations.en;
        const content = document.getElementById("onlineAccountContent");

        // Pobierz znajomych z localStorage
        const friends = JSON.parse(
          localStorage.getItem("beamng_friends") || "[]"
        );

        content.innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:3em;margin-bottom:10px;">ğŸ‘¤</div>
                    <div style="font-size:1.3em;font-weight:bold;">${playerName}</div>
                    <button onclick="editPlayerName()" style="margin-top:8px;padding:6px 15px;background:#333;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">
                        âœï¸ ${t.editName || "ZmieÅ„ nazwÄ™"}
                    </button>
                </div>
                
                <!-- ZaproÅ› znajomego -->
                <div style="background:#1a1a2e;padding:15px;border-radius:10px;margin-bottom:15px;">
                    <div style="font-weight:bold;margin-bottom:10px;">â• ${
                      t.inviteFriend || "ZaproÅ› znajomego"
                    }</div>
                    <button onclick="generateFriendInviteLink()" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;">
                        ğŸ”— ${t.generateLink || "Wygeneruj link zaproszenia"}
                    </button>
                </div>
                
                <!-- Lista znajomych -->
                <div style="background:#1a1a2e;padding:15px;border-radius:10px;margin-bottom:15px;">
                    <div style="font-weight:bold;margin-bottom:10px;">â­ ${
                      t.friends || "Znajomi"
                    }: ${friends.length}</div>
                    ${
                      friends.length > 0
                        ? `
                        <div style="max-height:200px;overflow-y:auto;">
                            ${friends
                              .map(
                                (f) => `
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#222;border-radius:6px;margin-bottom:5px;">
                                    <span style="flex:1;">ğŸ‘¤ ${f}</span>
                                    <div style="display:flex;gap:5px;">
                                        <button onclick="openChat('${f}')" style="padding:6px 12px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">ğŸ’¬</button>
                                        <button onclick="removeFriend('${f}')" style="padding:6px 12px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">âœ–</button>
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        <p style="color:#888;font-size:0.75em;margin-top:8px;text-align:center;">ğŸ’¬ WiadomoÅ›Ä‡: ${CHAT_MESSAGE_FEE.toFixed(
                          2
                        )} ${getCurrency()}</p>
                    `
                        : `<div style="color:#666;text-align:center;padding:15px;">${
                            t.noFriends || "Brak znajomych"
                          }<br><span style="font-size:0.85em;">WyÅ›lij link zaproszenia!</span></div>`
                    }
                </div>
            `;
      }

      // ========== SYSTEM ZNAJOMYCH (przez link) ==========
      function generateFriendInviteLink() {
        const baseUrl = window.location.href.split("?")[0];
        const link = `${baseUrl}?friend_invite=${encodeURIComponent(
          playerName
        )}`;

        if (navigator.share) {
          navigator.share({
            title: "Zaproszenie do znajomych - BeamNG Datapack",
            text: `${playerName} zaprasza CiÄ™ do znajomych!`,
            url: link,
          });
        } else {
          navigator.clipboard.writeText(link);
          showToast("ğŸ“‹ Link skopiowany!");
        }
      }

      function checkFriendInvite() {
        const params = new URLSearchParams(window.location.search);
        const inviteFrom = params.get("friend_invite");

        if (inviteFrom && playerName && inviteFrom !== playerName) {
          // UsuÅ„ parametr z URL
          window.history.replaceState({}, "", window.location.pathname);

          // PokaÅ¼ modal potwierdzenia
          if (
            confirm(
              `ğŸ‘‹ ${inviteFrom} zaprasza CiÄ™ do znajomych!\n\nCzy chcesz dodaÄ‡ ${inviteFrom} do znajomych?`
            )
          ) {
            addFriendDirect(inviteFrom);
          }
        }
      }

      function addFriendDirect(friendName) {
        let friends = JSON.parse(
          localStorage.getItem("beamng_friends") || "[]"
        );

        if (friends.includes(friendName)) {
          showToast("â„¹ï¸ JuÅ¼ jest znajomym");
          return;
        }

        friends.push(friendName);
        localStorage.setItem("beamng_friends", JSON.stringify(friends));

        showToast(`âœ… Dodano ${friendName} do znajomych!`);
        renderOnlineAccount();
      }

      function removeFriend(friendName) {
        if (!confirm(`UsunÄ…Ä‡ ${friendName} ze znajomych?`)) return;

        let friends = JSON.parse(
          localStorage.getItem("beamng_friends") || "[]"
        );
        friends = friends.filter((f) => f !== friendName);
        localStorage.setItem("beamng_friends", JSON.stringify(friends));

        showToast(`ğŸ—‘ï¸ UsuniÄ™to ${friendName}`);
        renderOnlineAccount();
      }

      function getFriendsList() {
        return JSON.parse(localStorage.getItem("beamng_friends") || "[]");
      }

      // Powiadomienia - uproszczone (lokalne)
      function renderNotifications() {
        const t = translations[currentLang] || translations.en;
        const list = document.getElementById("notificationsList");
        list.innerHTML = `<p style="color:#888;text-align:center;">${
          t.noNotifications || "Brak powiadomieÅ„"
        }</p>`;
      }

      // ========== SYSTEM CZATU ==========
      let currentChatUser = null;
      let chatInterval = null;

      function openChat(username) {
        if (!playerName) return;

        // SprawdÅº czy to znajomy
        const friends = getFriendsList();
        const isFriend = friends.includes(username);

        if (!isFriend) {
          showToast("âŒ MoÅ¼esz pisaÄ‡ tylko ze znajomymi!");
          return;
        }

        currentChatUser = username;
        document.getElementById("chatWithName").textContent = username;
        closeModal("notifications");
        closeModal("onlineAccount");
        openModal("chat");
        loadChatMessages();

        // OdÅ›wieÅ¼aj czat co 3 sekundy
        if (chatInterval) clearInterval(chatInterval);
        chatInterval = setInterval(loadChatMessages, 3000);
      }

      function closeChatModal() {
        if (chatInterval) clearInterval(chatInterval);
        chatInterval = null;
        currentChatUser = null;
        closeModal("chat");
      }

      function loadChatMessages() {
        if (!currentChatUser || !playerName) return;

        const data = getOnlineData();
        if (!data.chats) data.chats = {};

        // Chat ID to posortowane nazwy uÅ¼ytkownikÃ³w
        const chatId = [playerName, currentChatUser].sort().join("_");
        const chat = data.chats[chatId] || { messages: [] };

        const container = document.getElementById("chatMessages");
        if (!container) return;

        if (chat.messages.length === 0) {
          container.innerHTML =
            '<p style="color:#666;text-align:center;">Brak wiadomoÅ›ci</p>';
          return;
        }

        container.innerHTML = chat.messages
          .map((m) => {
            const isMe = m.from === playerName;
            return `
                    <div style="margin-bottom:8px;text-align:${
                      isMe ? "right" : "left"
                    };">
                        <div style="display:inline-block;max-width:80%;padding:8px 12px;border-radius:12px;background:${
                          isMe ? "#3b82f6" : "#333"
                        };">
                            ${m.text}
                        </div>
                        <div style="font-size:0.7em;color:#666;margin-top:2px;">${formatTimeAgo(
                          m.timestamp
                        )}</div>
                    </div>
                `;
          })
          .join("");

        container.scrollTop = container.scrollHeight;
      }

      function sendChatMessage() {
        const input = document.getElementById("chatInput");
        const text = input.value.trim();
        if (!text || !currentChatUser || !playerName) return;

        const save = getCurrentSave();
        const t = translations[currentLang] || translations.en;

        // SprawdÅº czy staÄ‡ na wiadomoÅ›Ä‡
        if (save.data.money < CHAT_MESSAGE_FEE) {
          showToast(
            `âŒ ${
              t.notEnoughMoney || "Brak Å›rodkÃ³w"
            } (${CHAT_MESSAGE_FEE.toFixed(2)} ${getCurrency()})`
          );
          return;
        }

        // Pobierz opÅ‚atÄ™
        save.data.money -= CHAT_MESSAGE_FEE;
        saveSaveData();
        updateAllDisplays();

        const data = getOnlineData();
        if (!data.chats) data.chats = {};

        const chatId = [playerName, currentChatUser].sort().join("_");
        if (!data.chats[chatId]) {
          data.chats[chatId] = {
            messages: [],
            participants: [playerName, currentChatUser],
          };
        }

        data.chats[chatId].messages.push({
          from: playerName,
          text: text,
          timestamp: Date.now(),
        });

        // Ogranicz do 100 ostatnich wiadomoÅ›ci
        if (data.chats[chatId].messages.length > 100) {
          data.chats[chatId].messages = data.chats[chatId].messages.slice(-100);
        }

        saveOnlineData(data);

        // WyÅ›lij powiadomienie do drugiej osoby
        sendNotification(currentChatUser, {
          type: "chatMessage",
          from: playerName,
          preview: text.substring(0, 50),
        });

        input.value = "";
        loadChatMessages();
      }

      // Enter wysyÅ‚a wiadomoÅ›Ä‡
      document.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && e.target.id === "chatInput") {
          sendChatMessage();
        }
      });

      // Renderuj aukcje
      let currentAuctionTab = "browse";

      async function showAuctionTab(tab) {
        currentAuctionTab = tab;
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => (b.style.background = "#222"));
        document.getElementById(
          "tab" + tab.charAt(0).toUpperCase() + tab.slice(1)
        ).style.background = "#333";
      }

      async function renderAuctionContent() {
        const t = translations[currentLang] || translations.en;
        const content = document.getElementById("auctionContent");

        if (!playerName) {
          content.innerHTML = `<p style="color:#888;text-align:center;padding:20px;">${
            t.loginFirst || "Najpierw siÄ™ zaloguj"
          }</p>`;
          return;
        }

        if (currentAuctionTab === "browse") {
          const auctions = await getActiveAuctions();
          const otherAuctions = auctions.filter((a) => a.seller !== playerName);

          if (otherAuctions.length === 0) {
            content.innerHTML = `<p style="color:#888;text-align:center;padding:20px;">${
              t.noAuctions || "Brak aukcji"
            }</p>`;
            return;
          }

          content.innerHTML = otherAuctions
            .map((a) => {
              const displayName =
                a.name ||
                (a.item
                  ? a.item.name || a.item.brand + " " + a.item.model
                  : "Pakiet");
              const icon =
                a.items && a.items.length > 1
                  ? "ğŸ“¦"
                  : a.items && a.items[0]
                  ? getItemIcon(a.items[0])
                  : "ğŸ“¦";
              return `
                    <div onclick="showAuctionDetail('${
                      a.id
                    }')" style="background:#1a1a2e;padding:12px;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:bold;">${icon} ${displayName}</div>
                            <div style="color:#888;font-size:0.85em;">${
                              t.seller || "Sprzedawca"
                            }: ${a.seller}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#10b981;font-weight:bold;">${a.price.toLocaleString()} ${getCurrency()}</div>
                        </div>
                    </div>
                `;
            })
            .join("");
        } else if (currentAuctionTab === "my") {
          const auctions = await getActiveAuctions();
          const myAuctions = auctions.filter((a) => a.seller === playerName);

          if (myAuctions.length === 0) {
            content.innerHTML = `<p style="color:#888;text-align:center;padding:20px;">${
              t.noMyAuctions || "Nie masz wystawionych przedmiotÃ³w"
            }</p>`;
            return;
          }

          content.innerHTML = myAuctions
            .map((a) => {
              const displayName =
                a.name ||
                (a.item
                  ? a.item.name || a.item.brand + " " + a.item.model
                  : "Pakiet");
              const icon =
                a.items && a.items.length > 1
                  ? "ğŸ“¦"
                  : a.items && a.items[0]
                  ? getItemIcon(a.items[0])
                  : "ğŸ“¦";
              return `
                    <div style="background:#1a1a2e;padding:12px;border-radius:8px;margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:bold;">${icon} ${displayName}</div>
                                <div style="color:#10b981;">${a.price.toLocaleString()} ${getCurrency()}</div>
                            </div>
                            <button onclick="cancelAuction('${
                              a.id
                            }')" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;">âŒ</button>
                        </div>
                        ${
                          a.negotiations && a.negotiations.length > 0
                            ? `<div style="color:#f59e0b;font-size:0.85em;margin-top:8px;">ğŸ’¬ ${
                                a.negotiations.length
                              } ${t.negotiations || "negocjacji"}</div>`
                            : ""
                        }
                    </div>
                `;
            })
            .join("");
        } else if (currentAuctionTab === "create") {
          // Lista rzeczy do wystawienia
          const save = getCurrentSave();

          content.innerHTML = `
                    <div style="margin-bottom:15px;">
                        <p style="color:#888;margin-bottom:10px;">${
                          t.selectItemsToSell || "Zaznacz co chcesz wystawiÄ‡:"
                        }</p>
                        
                        <div style="font-weight:bold;margin:15px 0 8px;color:#f59e0b;">ğŸš— ${
                          t.cars || "Auta"
                        }</div>
                        <div id="auctionCarsList"></div>
                        
                        <div style="font-weight:bold;margin:15px 0 8px;color:#10b981;">ğŸ” ${
                          t.food || "Jedzenie"
                        }</div>
                        <div id="auctionFoodList"></div>
                        
                        <div style="font-weight:bold;margin:15px 0 8px;color:#8b5cf6;">ğŸ›¡ï¸ ${
                          t.customInsurance || "WÅ‚asne ubezpieczenie"
                        }</div>
                        <button onclick="showCreateInsuranceForm()" style="width:100%;padding:12px;background:#1a1a2e;border:2px dashed #8b5cf6;border-radius:8px;color:#8b5cf6;cursor:pointer;">
                            â• ${t.createInsurance || "StwÃ³rz ubezpieczenie"}
                        </button>
                        <div id="customInsurancePreview" style="margin-top:10px;"></div>
                    </div>
                    
                    <div id="auctionSelectedItems" style="background:#1a1a2e;padding:12px;border-radius:8px;margin:15px 0;display:none;">
                        <div style="font-weight:bold;margin-bottom:8px;">ğŸ“¦ ${
                          t.selectedItems || "Wybrane"
                        }:</div>
                        <div id="selectedItemsList"></div>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <label style="color:#888;font-size:0.9em;">${
                          t.totalPrice || "Cena za pakiet"
                        }:</label>
                        <input type="number" id="auctionPackagePrice" placeholder="0" style="width:100%;padding:12px;background:#1a1a2e;border:2px solid #333;border-radius:8px;color:white;font-size:1.2em;margin-top:5px;">
                    </div>
                    
                    <button onclick="createAuctionPackage()" style="width:100%;padding:15px;background:#10b981;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;margin-top:15px;">
                        âœ… ${t.listForSale || "Wystaw na sprzedaÅ¼"}
                    </button>
                `;

          renderAuctionItemLists();
        }
      }

      // Wybrane przedmioty do aukcji
      let auctionSelectedCars = [];
      let auctionSelectedFood = [];
      let auctionCustomInsurance = null;

      function renderAuctionItemLists() {
        const t = translations[currentLang] || translations.en;

        // Auta - uÅ¼ywaj globalnej zmiennej garage
        const carsList = document.getElementById("auctionCarsList");
        if (!carsList) return;

        if (garage.length === 0) {
          carsList.innerHTML = `<p style="color:#666;font-size:0.9em;">${
            t.noCars || "Brak aut"
          }</p>`;
        } else {
          carsList.innerHTML = garage
            .map(
              (car, i) => `
                    <div onclick="toggleAuctionCar(${i})" style="background:${
                auctionSelectedCars.includes(i) ? "#2a4a2a" : "#222"
              };padding:10px;border-radius:6px;margin-bottom:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:2px solid ${
                auctionSelectedCars.includes(i) ? "#10b981" : "transparent"
              };">
                        <span>${car.brand} ${car.model}</span>
                        <span style="color:#888;">${car.price.toLocaleString()} ${getCurrency()}</span>
                    </div>
                `
            )
            .join("");
        }

        // Jedzenie - uÅ¼ywaj globalnej zmiennej backpack
        const foodList = document.getElementById("auctionFoodList");
        if (!foodList) return;

        if (backpack.length === 0) {
          foodList.innerHTML = `<p style="color:#666;font-size:0.9em;">${
            t.noFood || "Brak jedzenia"
          }</p>`;
        } else {
          // Grupuj jedzenie wedÅ‚ug id
          const groupedFood = {};
          for (let i = 0; i < backpack.length; i++) {
            const item = backpack[i];
            const key = item.id || item.nameKey || "item_" + i;
            if (!groupedFood[key]) {
              groupedFood[key] = { item: item, indices: [], count: 0 };
            }
            groupedFood[key].indices.push(i);
            groupedFood[key].count++;
          }

          let html = "";
          for (const key in groupedFood) {
            const data = groupedFood[key];
            const item = data.item;
            const itemName = item.nameKey
              ? translations[currentLang][item.nameKey] || item.nameKey
              : item.name || "Przedmiot";
            const icon = item.icon || "ğŸ“¦";
            const selectedCount = data.indices.filter((i) =>
              auctionSelectedFood.includes(i)
            ).length;
            const isSelected = selectedCount > 0;
            const allSelected = selectedCount === data.count;

            html += `
                    <div onclick="toggleAuctionFoodGroup('${key}')" style="background:${
              isSelected ? "#2a4a2a" : "#222"
            };padding:10px;border-radius:6px;margin-bottom:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:2px solid ${
              allSelected ? "#10b981" : isSelected ? "#4a7a4a" : "transparent"
            };">
                        <span>${icon} ${itemName} ${
              data.count > 1
                ? '<span style="color:#ff6b35;">x' + data.count + "</span>"
                : ""
            }</span>
                        <span style="color:#888;">${(
                          item.price || 0
                        ).toLocaleString()} ${getCurrency()}</span>
                    </div>`;
          }
          foodList.innerHTML = html;
        }

        updateSelectedItemsPreview();
      }

      // Przechowuj grupowanie
      let foodGroups = {};

      function updateFoodGroups() {
        foodGroups = {};
        backpack.forEach((item, i) => {
          const key = item.id || item.nameKey || item.name;
          if (!foodGroups[key]) {
            foodGroups[key] = [];
          }
          foodGroups[key].push(i);
        });
      }

      function toggleAuctionFoodGroup(key) {
        updateFoodGroups();
        const indices = foodGroups[key] || [];

        // SprawdÅº ile jest juÅ¼ zaznaczonych
        const selectedCount = indices.filter((i) =>
          auctionSelectedFood.includes(i)
        ).length;

        if (selectedCount === indices.length) {
          // Wszystkie zaznaczone - odznacz wszystkie
          indices.forEach((i) => {
            auctionSelectedFood = auctionSelectedFood.filter((x) => x !== i);
          });
        } else {
          // Nie wszystkie zaznaczone - zaznacz wszystkie
          indices.forEach((i) => {
            if (!auctionSelectedFood.includes(i)) {
              auctionSelectedFood.push(i);
            }
          });
        }

        renderAuctionItemLists();
      }

      function toggleAuctionCar(index) {
        if (auctionSelectedCars.includes(index)) {
          auctionSelectedCars = auctionSelectedCars.filter((i) => i !== index);
        } else {
          auctionSelectedCars.push(index);
        }
        renderAuctionItemLists();
      }

      function updateSelectedItemsPreview() {
        const t = translations[currentLang] || translations.en;

        const container = document.getElementById("auctionSelectedItems");
        const list = document.getElementById("selectedItemsList");

        if (!container || !list) return;

        const hasItems =
          auctionSelectedCars.length > 0 ||
          auctionSelectedFood.length > 0 ||
          auctionCustomInsurance;
        container.style.display = hasItems ? "block" : "none";

        if (!hasItems) return;

        let html = "";
        let totalValue = 0;

        auctionSelectedCars.forEach((i) => {
          const car = garage[i];
          if (car) {
            html += `<div style="color:#f59e0b;">ğŸš— ${car.brand} ${car.model}</div>`;
            totalValue += car.price;
          }
        });

        auctionSelectedFood.forEach((i) => {
          const item = backpack[i];
          if (item) {
            const itemName = item.nameKey ? getItemName(item) : item.name;
            const icon = item.icon || "ğŸ”";
            html += `<div style="color:#10b981;">${icon} ${itemName}</div>`;
            totalValue += item.price || 0;
          }
        });

        if (auctionCustomInsurance) {
          html += `<div style="color:#8b5cf6;">ğŸ›¡ï¸ ${auctionCustomInsurance.name}</div>`;
          if (auctionCustomInsurance.creationCost) {
            html += `<div style="color:#f59e0b;font-size:0.85em;margin-left:20px;">ğŸ’° ${
              t.creationCost || "Koszt"
            }: ${auctionCustomInsurance.creationCost.toLocaleString()} ${getCurrency()}</div>`;
          }
        }

        list.innerHTML = html;

        // Ustaw sugerowanÄ… cenÄ™
        const priceInput = document.getElementById("auctionPackagePrice");
        if (priceInput && !priceInput.value) {
          priceInput.placeholder = totalValue.toLocaleString();
        }
      }

      function showCreateInsuranceForm() {
        const t = translations[currentLang] || translations.en;
        const preview = document.getElementById("customInsurancePreview");

        preview.innerHTML = `
                <div style="background:#2a2a4e;padding:15px;border-radius:8px;border:2px solid #8b5cf6;">
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.insuranceName || "Nazwa ubezpieczenia"
                        }:</label>
                        <input type="text" id="customInsName" placeholder="${
                          t.myInsurance || "Moje ubezpieczenie"
                        }" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.whatItGives || "Co daje"
                        } (HP/jedzenie/woda):</label>
                        <div style="display:flex;gap:10px;margin-top:3px;">
                            <input type="number" id="customInsHP" placeholder="HP" style="flex:1;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;">
                            <input type="number" id="customInsFood" placeholder="ğŸ”" style="flex:1;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;">
                            <input type="number" id="customInsWater" placeholder="ğŸ’§" style="flex:1;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.coveragePercent || "Pokrycie napraw"
                        } (%):</label>
                        <input type="number" id="customInsCoverage" placeholder="50" min="0" max="100" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.paymentInterval || "OpÅ‚ata co ile minut"
                        }:</label>
                        <input type="number" id="customInsInterval" placeholder="60" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.paymentAmount || "Kwota opÅ‚aty"
                        }:</label>
                        <input type="number" id="customInsPayment" placeholder="100" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="display:flex;gap:10px;">
                        <button onclick="addCustomInsurance()" style="flex:1;padding:10px;background:#8b5cf6;color:white;border:none;border-radius:6px;cursor:pointer;">âœ… ${
                          t.add || "Dodaj"
                        }</button>
                        <button onclick="cancelCustomInsurance()" style="flex:1;padding:10px;background:#333;color:white;border:none;border-radius:6px;cursor:pointer;">âŒ ${
                          t.cancel || "Anuluj"
                        }</button>
                    </div>
                </div>
            `;
      }

      // Ceny za tworzenie ubezpieczenia
      const INSURANCE_COST_PER_FOOD = 5; // 5 zÅ‚ za 1 kaloriÄ™
      const INSURANCE_COST_PER_WATER = 15; // 15 zÅ‚ za 1 ml
      const INSURANCE_COST_PER_HP = 20; // 20 zÅ‚ za 1 HP
      const INSURANCE_MAX_VALUE = 1000; // Max dla kaÅ¼dego

      function calculateInsuranceCost(ins) {
        const foodCost = (ins.food || 0) * INSURANCE_COST_PER_FOOD;
        const waterCost = (ins.water || 0) * INSURANCE_COST_PER_WATER;
        const hpCost = (ins.hp || 0) * INSURANCE_COST_PER_HP;
        return foodCost + waterCost + hpCost;
      }

      function addCustomInsurance() {
        const t = translations[currentLang] || translations.en;

        const name =
          document.getElementById("customInsName").value.trim() ||
          t.myInsurance ||
          "Moje ubezpieczenie";
        let hp = parseInt(document.getElementById("customInsHP").value) || 0;
        let food =
          parseInt(document.getElementById("customInsFood").value) || 0;
        let water =
          parseInt(document.getElementById("customInsWater").value) || 0;
        const coverage =
          parseInt(document.getElementById("customInsCoverage").value) || 0;
        const interval =
          parseInt(document.getElementById("customInsInterval").value) || 60;
        const payment =
          parseInt(document.getElementById("customInsPayment").value) || 100;

        // Limity max 1000
        hp = Math.min(INSURANCE_MAX_VALUE, Math.max(0, hp));
        food = Math.min(INSURANCE_MAX_VALUE, Math.max(0, food));
        water = Math.min(INSURANCE_MAX_VALUE, Math.max(0, water));

        const insuranceData = {
          type: "customInsurance",
          name: name,
          hp: hp,
          food: food,
          water: water,
          coverage: Math.min(100, Math.max(0, coverage)),
          interval: interval,
          payment: payment,
        };

        const creationCost = calculateInsuranceCost(insuranceData);

        // SprawdÅº czy staÄ‡ gracza
        if (creationCost > money) {
          alert(
            `${t.notEnoughMoney || "Nie masz wystarczajÄ…co pieniÄ™dzy!"}\n${
              t.cost || "Koszt"
            }: ${creationCost.toLocaleString()} ${getCurrency()}`
          );
          return;
        }

        auctionCustomInsurance = insuranceData;
        auctionCustomInsurance.creationCost = creationCost;

        const preview = document.getElementById("customInsurancePreview");
        preview.innerHTML = `
                <div style="background:#2a2a4e;padding:12px;border-radius:8px;border:2px solid #8b5cf6;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:bold;color:#8b5cf6;">ğŸ›¡ï¸ ${name}</div>
                            <div style="color:#888;font-size:0.85em;">
                                ${hp > 0 ? `+${hp} HP ` : ""}${
          food > 0 ? `+${food} ğŸ” ` : ""
        }${water > 0 ? `+${water} ğŸ’§ ` : ""}${
          coverage > 0 ? `${coverage}% napraw ` : ""
        }
                            </div>
                            <div style="color:#666;font-size:0.8em;">${payment} ${getCurrency()} / ${interval} min</div>
                        </div>
                        <button onclick="removeCustomInsurance()" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;">âŒ</button>
                    </div>
                    <div style="margin-top:8px;padding-top:8px;border-top:1px solid #444;color:#f59e0b;font-size:0.85em;">
                        ğŸ’° ${
                          t.creationCost || "Koszt stworzenia"
                        }: ${creationCost.toLocaleString()} ${getCurrency()}
                    </div>
                </div>
            `;

        updateSelectedItemsPreview();
      }

      function cancelCustomInsurance() {
        document.getElementById("customInsurancePreview").innerHTML = "";
      }

      function removeCustomInsurance() {
        auctionCustomInsurance = null;
        document.getElementById("customInsurancePreview").innerHTML = "";
        updateSelectedItemsPreview();
      }

      async function createAuctionPackage() {
        const t = translations[currentLang] || translations.en;
        const save = getCurrentSave();

        // SprawdÅº czy zalogowany
        if (!playerName) {
          alert(t.loginFirst || "Najpierw siÄ™ zaloguj!");
          openModal("onlineAccount");
          return;
        }

        const hasItems =
          auctionSelectedCars.length > 0 ||
          auctionSelectedFood.length > 0 ||
          auctionCustomInsurance;
        if (!hasItems) {
          alert(t.selectSomething || "Wybierz coÅ› do wystawienia!");
          return;
        }

        const price = parseInt(
          document.getElementById("auctionPackagePrice").value
        );
        if (!price || price <= 0) {
          alert(t.enterPrice || "Podaj cenÄ™!");
          return;
        }

        // Oblicz koszt stworzenia (tylko za ubezpieczenie)
        let creationCost = 0;
        if (auctionCustomInsurance && auctionCustomInsurance.creationCost) {
          creationCost = auctionCustomInsurance.creationCost;
        }

        // SprawdÅº czy staÄ‡
        if (creationCost > money) {
          alert(
            `${t.notEnoughMoney || "Nie masz wystarczajÄ…co pieniÄ™dzy!"}\n${
              t.creationCost || "Koszt stworzenia"
            }: ${creationCost.toLocaleString()} ${getCurrency()}`
          );
          return;
        }

        // Podsumowanie przed wystawieniem
        let summary = `ğŸ“¦ ${
          t.auctionSummary || "Podsumowanie"
        }\nâ”â”â”â”â”â”â”â”â”â”â”â”\n`;

        auctionSelectedCars.forEach((i) => {
          const car = garage[i];
          summary += `ğŸš— ${car.brand} ${car.model}\n`;
        });

        auctionSelectedFood.forEach((i) => {
          const item = backpack[i];
          const itemName = item.nameKey ? getItemName(item) : item.name;
          const icon = item.icon || "ğŸ”";
          summary += `${icon} ${itemName}\n`;
        });

        if (auctionCustomInsurance) {
          summary += `ğŸ›¡ï¸ ${auctionCustomInsurance.name}\n`;
          if (creationCost > 0) {
            summary += `   ğŸ’° ${
              t.creationCost || "Koszt"
            }: -${creationCost.toLocaleString()} ${getCurrency()}\n`;
          }
        }

        summary += `â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        summary += `ğŸ’µ ${
          t.sellingPrice || "Cena sprzedaÅ¼y"
        }: ${price.toLocaleString()} ${getCurrency()}\n`;
        if (creationCost > 0) {
          summary += `ğŸ’¸ ${
            t.youPay || "PÅ‚acisz"
          }: -${creationCost.toLocaleString()} ${getCurrency()}\n`;
        }
        summary += `\n${t.confirmListing || "WystawiÄ‡?"}`;

        if (!confirm(summary)) {
          return;
        }

        // Pobierz opÅ‚atÄ™ za ubezpieczenie
        if (creationCost > 0) {
          money -= creationCost;
          spent += creationCost;
        }

        // Zbierz przedmioty
        const packageItems = [];
        let packageName = "";

        // Auta (sortuj malejÄ…co Å¼eby usuwaÄ‡ od koÅ„ca)
        auctionSelectedCars
          .sort((a, b) => b - a)
          .forEach((i) => {
            const car = garage[i];
            packageItems.push({ type: "car", data: car });
            packageName +=
              (packageName ? " + " : "") + car.brand + " " + car.model;
          });

        // Jedzenie
        auctionSelectedFood
          .sort((a, b) => b - a)
          .forEach((i) => {
            const item = backpack[i];
            packageItems.push({ type: "food", data: item });
            const itemName = item.nameKey ? getItemName(item) : item.name;
            packageName += (packageName ? " + " : "") + itemName;
          });

        // Ubezpieczenie (bez creationCost w danych)
        if (auctionCustomInsurance) {
          const insData = { ...auctionCustomInsurance };
          delete insData.creationCost;
          packageItems.push({ type: "customInsurance", data: insData });
          packageName +=
            (packageName ? " + " : "") + auctionCustomInsurance.name;
        }

        // UtwÃ³rz aukcjÄ™
        const data = getOnlineData();
        if (!data.auctions) data.auctions = {};

        const auctionId =
          "auction_" +
          Date.now() +
          "_" +
          Math.random().toString(36).substr(2, 6);
        data.auctions[auctionId] = {
          seller: playerName,
          name: packageName,
          items: packageItems,
          price: price,
          createdAt: Date.now(),
          status: "active",
          bids: [],
          negotiations: [],
        };

        saveOnlineData(data);

        // UsuÅ„ przedmioty z inwentarza
        auctionSelectedCars
          .sort((a, b) => b - a)
          .forEach((i) => {
            garage.splice(i, 1);
          });
        auctionSelectedFood
          .sort((a, b) => b - a)
          .forEach((i) => {
            backpack.splice(i, 1);
          });

        saveState();

        // Reset
        auctionSelectedCars = [];
        auctionSelectedFood = [];
        auctionCustomInsurance = null;

        let resultMsg = `âœ… ${
          t.auctionCreated || "Wystawiono!"
        }\n${packageName}`;
        if (creationCost > 0) {
          resultMsg += `\nğŸ’¸ -${creationCost.toLocaleString()} ${getCurrency()}`;
        }
        alert(resultMsg);
        updateAllDisplays();
      }

      function getItemIcon(item) {
        if (!item) return "ğŸ“¦";
        if (item.type === "car") return "ğŸš—";
        if (item.type === "food") return item.data?.icon || "ğŸ”";
        if (item.type === "customInsurance") return "ğŸ›¡ï¸";
        if (item.icon) return item.icon;
        return "ğŸ“¦";
      }

      async function cancelAuction(auctionId) {
        const t = translations[currentLang] || translations.en;

        if (
          !confirm(
            t.confirmCancelAuction ||
              "AnulowaÄ‡ aukcjÄ™? Przedmioty wrÃ³cÄ… do Ciebie."
          )
        ) {
          return;
        }

        const data = getOnlineData();
        if (!data.auctions || !data.auctions[auctionId]) return;

        const auction = data.auctions[auctionId];

        // SprawdÅº czy to Twoja aukcja
        if (auction.seller !== playerName) {
          alert(t.notYourAuction || "To nie Twoja aukcja!");
          return;
        }

        // ZwrÃ³Ä‡ przedmioty
        const save = getCurrentSave();
        if (!save.data.backpack) save.data.backpack = [];

        if (auction.items) {
          auction.items.forEach((item) => {
            if (item.type === "car") {
              garage.push(item.data);
            } else if (item.type === "food") {
              save.data.backpack.push(item.data);
            }
            // Ubezpieczenie przepada (opÅ‚ata za stworzenie byÅ‚a pobrana)
          });
        }

        // UsuÅ„ aukcjÄ™
        delete data.auctions[auctionId];
        saveOnlineData(data);

        saveState();
        updateAllDisplays();

        alert(`âœ… ${t.auctionCancelled || "Aukcja anulowana!"}`);
      }

      async function showAuctionDetail(auctionId) {
        const t = translations[currentLang] || translations.en;
        const data = getOnlineData();
        const auction = data.auctions[auctionId];
        if (!auction) return;

        // Generuj listÄ™ przedmiotÃ³w w pakiecie
        let itemsHtml = "";
        if (auction.items && auction.items.length > 0) {
          itemsHtml = auction.items
            .map((item) => {
              if (item.type === "car") {
                return `<div style="padding:8px;background:#222;border-radius:6px;margin-bottom:5px;">ğŸš— ${item.data.brand} ${item.data.model}</div>`;
              } else if (item.type === "food") {
                const itemName = item.data.nameKey
                  ? t[item.data.nameKey] || item.data.nameKey
                  : item.data.name;
                const icon = item.data.icon || "ğŸ”";
                const kcal = item.data.kcal || item.data.food || 0;
                const ml = item.data.ml || item.data.water || 0;
                return `<div style="padding:8px;background:#222;border-radius:6px;margin-bottom:5px;">${icon} ${itemName} (+${kcal} ğŸ” +${ml} ğŸ’§)</div>`;
              } else if (item.type === "customInsurance") {
                const ins = item.data;
                return `<div style="padding:8px;background:#222;border-radius:6px;margin-bottom:5px;">
                            ğŸ›¡ï¸ ${ins.name}<br>
                            <span style="color:#888;font-size:0.85em;">
                                ${ins.hp > 0 ? `+${ins.hp} HP ` : ""}${
                  ins.food > 0 ? `+${ins.food} ğŸ” ` : ""
                }${ins.water > 0 ? `+${ins.water} ğŸ’§ ` : ""}${
                  ins.coverage > 0
                    ? `${ins.coverage}% ${t.repairs || "napraw"}`
                    : ""
                }<br>
                                ${ins.payment} ${getCurrency()} / ${
                  ins.interval
                } min
                            </span>
                        </div>`;
              }
              return "";
            })
            .join("");
        } else if (auction.item) {
          // Stary format - pojedynczy przedmiot
          itemsHtml = `<div style="padding:8px;background:#222;border-radius:6px;">${getItemIcon(
            auction.item
          )} ${
            auction.item.name || auction.item.brand + " " + auction.item.model
          }</div>`;
        }

        const content = document.getElementById("auctionDetailContent");
        content.innerHTML = `
                <h3>ğŸ“¦ ${auction.name || "Pakiet"}</h3>
                <div style="background:#1a1a2e;padding:15px;border-radius:10px;margin:15px 0;">
                    <div style="font-weight:bold;margin-bottom:10px;">${
                      t.contents || "ZawartoÅ›Ä‡"
                    }:</div>
                    ${itemsHtml}
                    <div style="display:flex;justify-content:space-between;margin-top:15px;padding-top:10px;border-top:1px solid #333;">
                        <span style="color:#888;">${
                          t.seller || "Sprzedawca"
                        }:</span>
                        <span>${auction.seller}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:8px;">
                        <span style="color:#888;">${t.price || "Cena"}:</span>
                        <span style="color:#10b981;font-weight:bold;font-size:1.2em;">${auction.price.toLocaleString()} ${getCurrency()}</span>
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <button onclick="buyAuctionItem('${auctionId}')" style="padding:15px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;">
                        ğŸ’° ${t.buyNow || "Kup teraz"}
                    </button>
                    <button onclick="showNegotiateModal('${auctionId}')" style="padding:15px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;">
                        ğŸ¤ ${t.negotiate || "Negocjuj cenÄ™"}
                    </button>
                </div>
            `;
        openModal("auctionDetail");
      }

      let pendingAuctionId = null;

      async function buyAuctionItem(auctionId) {
        const t = translations[currentLang] || translations.en;
        const data = getOnlineData();
        const auction = data.auctions[auctionId];

        if (auction.price > limit) {
          pendingAction = "buyAuction";
          pendingAuctionId = auctionId;
          closeModal("auctionDetail");
          openModal("pin");
          return;
        }

        await completePurchaseWithPin(auctionId);
      }

      async function completePurchaseWithPin(auctionId) {
        const t = translations[currentLang] || translations.en;
        const result = await acceptAuction(auctionId, pin);

        if (result.success) {
          money -= result.price;
          spent += result.price;

          const save = getCurrentSave();
          if (!save.data.backpack) save.data.backpack = [];
          if (!save.data.customInsurances) save.data.customInsurances = [];

          // Dodaj przedmioty z pakietu
          if (result.items && result.items.length > 0) {
            result.items.forEach((item) => {
              if (item.type === "car") {
                garage.push(item.data);
              } else if (item.type === "food") {
                save.data.backpack.push(item.data);
              } else if (item.type === "customInsurance") {
                save.data.customInsurances.push(item.data);
              }
            });
          } else if (result.item) {
            // Stary format
            if (result.item.type === "car") {
              garage.push(result.item.item || result.item);
            } else if (result.item.type === "food") {
              save.data.backpack.push(result.item.item || result.item);
            }
          }

          saveState();
          updateAllDisplays();
          closeModal("auctionDetail");
          alert(`âœ… ${t.purchaseSuccess || "Zakup udany!"}`);
        } else if (result.error === "noMoney") {
          alert(t.notEnoughMoney || "Nie masz wystarczajÄ…co pieniÄ™dzy!");
        }
        pendingAuctionId = null;
      }

      async function forgotPinAuction() {
        const t = translations[currentLang] || translations.en;
        closeModal("pin");

        if (pendingAuctionId) {
          const data = getOnlineData();
          const auction = data.auctions[pendingAuctionId];

          sendNotification(auction.seller, {
            type: "pinRequired",
            from: playerName,
            auctionId: pendingAuctionId,
            amount: auction.price,
            message: t.buyerForgotPin || "KupujÄ…cy nie pamiÄ™ta PIN",
          });

          alert(t.waitingForSeller || "WysÅ‚ano proÅ›bÄ™ do sprzedawcy...");
        }
        pendingAction = null;
        pendingAuctionId = null;
      }

      async function showNegotiateModal(auctionId) {
        const t = translations[currentLang] || translations.en;
        const price = prompt(t.enterYourOffer || "Podaj swojÄ… ofertÄ™:");
        if (!price) return;

        const priceNum = parseInt(price);
        if (isNaN(priceNum) || priceNum <= 0) return;

        await negotiateAuction(auctionId, priceNum);
        closeModal("auctionDetail");
        alert(`âœ… ${t.offerSent || "WysÅ‚ano ofertÄ™!"}`);
      }

      async function allowWithoutPinUI(notifId, auctionId, buyerName) {
        await allowWithoutPin(notifId, auctionId, buyerName);
        renderNotifications();
      }

      async function denyWithoutPinUI(notifId, buyerName) {
        await denyWithoutPin(notifId, buyerName);
        renderNotifications();
      }

      async function respondNegotiation(notifId, auctionId, response) {
        const data = getOnlineData();
        const auction = data.auctions[auctionId];
        if (!auction) return;

        const negIndex = auction.negotiations.length - 1;
        await respondToNegotiation(auctionId, negIndex, response, null);
        removeNotification(notifId);
        renderNotifications();
      }

      async function showCounterOffer(notifId, auctionId, fromPlayer) {
        const t = translations[currentLang] || translations.en;
        const price = prompt(t.enterCounterOffer || "Podaj kontr-ofertÄ™:");
        if (!price) return;

        const priceNum = parseInt(price);
        if (isNaN(priceNum) || priceNum <= 0) return;

        const data = getOnlineData();
        const auction = data.auctions[auctionId];
        const negIndex = auction.negotiations.length - 1;

        await respondToNegotiation(auctionId, negIndex, "counter", priceNum);
        removeNotification(notifId);
        renderNotifications();
      }

      // ==================== INIT ====================
      function init() {
        ensureDefaultSave();
        loadSaveData();
        generateLangGrid();
        applyLanguage();
        updateGameModeUI();
        updateAllDisplays();
        updateCurrentSaveDisplay();
        checkMissedTaxes();
        checkMissedHunger();
        checkInsuranceBenefits();
        startTaxTimer();
        startHungerTimer();
        startInsuranceTimer();
        checkUrlForVoucher();

        // SprawdÅº czy zalogowany - jeÅ›li nie, pokaÅ¼ ekran logowania
        if (!checkRequireLogin()) {
          // SprawdÅº zaproszenie do znajomych
          checkFriendInvite();
        }

        // Event listenery dla modali
        document
          .getElementById("modalOnlineAccount")
          ?.addEventListener("click", (e) => {
            if (e.target.id === "modalOnlineAccount")
              closeModal("onlineAccount");
          });
        document
          .getElementById("modalNotifications")
          ?.addEventListener("click", (e) => {
            if (e.target.id === "modalNotifications")
              closeModal("notifications");
          });
        document.getElementById("modalChat")?.addEventListener("click", (e) => {
          if (e.target.id === "modalChat") closeChatModal();
        });
        document
          .getElementById("modalAuction")
          ?.addEventListener("click", (e) => {
            if (e.target.id === "modalAuction") closeModal("auction");
          });
      }

      function saveState() {
        saveSaveData();
        localStorage.setItem("beamng_lang", currentLang);
      }

      async function generateCardCode() {
        const data = getOnlineData();
        const existingCards = new Set();

        // Zbierz wszystkie istniejÄ…ce numery kart
        if (data.players) {
          for (const player of Object.values(data.players)) {
            if (player.cardNumber) {
              existingCards.add(player.cardNumber);
            }
          }
        }

        // Generuj unikalny kod 6 cyfr
        let code;
        let attempts = 0;
        do {
          code = "";
          for (let i = 0; i < 6; i++) code += Math.floor(Math.random() * 10);
          attempts++;
        } while (existingCards.has(code) && attempts < 100);

        return code;
      }

      function generateCardCodeSync() {
        // Wersja synchroniczna dla kompatybilnoÅ›ci - 6 cyfr
        let code = "";
        for (let i = 0; i < 6; i++) code += Math.floor(Math.random() * 10);
        return code;
      }

      // ==================== OBSÅUGA FORMULARZY ====================
      let currentImageDataForVerify = null;
      let carSearchQuery = "";

      // Renderuj listÄ™ aut do kupienia
      function renderCarBuyList() {
        const grid = document.getElementById("carBuyGrid");
        const query = carSearchQuery.toLowerCase();
        const cars = getCurrentCars();

        const filtered = cars.filter(
          (car) =>
            car.brand.toLowerCase().includes(query) ||
            car.model.toLowerCase().includes(query) ||
            car.type.toLowerCase().includes(query)
        );

        if (filtered.length === 0) {
          grid.innerHTML =
            '<div style="text-align:center;padding:20px;color:#888;grid-column:span 2;">Nie znaleziono aut</div>';
          return;
        }

        grid.innerHTML = filtered
          .map(
            (car) => `
                <div class="shop-item" onclick="buyCar('${
                  car.id
                }')" style="padding:10px;">
                    <div class="item-icon">ğŸš—</div>
                    <div class="item-name" style="font-size:0.8em;">${
                      car.brand
                    } ${car.model}</div>
                    <div class="item-stats">
                        <span style="color:#888;">${car.year}</span><br>
                        <span style="color:#aaa;font-size:0.9em;">${
                          car.type
                        }</span>
                    </div>
                    <div class="item-price">${car.price.toLocaleString()} ${getCurrency()}</div>
                </div>
            `
          )
          .join("");
      }

      function filterCars() {
        carSearchQuery = document.getElementById("carSearchInput").value;
        renderCarBuyList();
      }

      function buyCar(carId) {
        const cars = getCurrentCars();
        const car = cars.find((c) => c.id === carId);
        if (!car) return;

        const t = translations[currentLang] || translations.en;

        if (money < car.price) {
          alert(t.notEnoughMoney || "Nie masz wystarczajÄ…co pieniÄ™dzy!");
          return;
        }

        if (
          confirm(
            `${t.buyQuestion || "KupiÄ‡"} ${car.brand} ${car.model} ${
              t.forPrice || "za"
            } ${car.price.toLocaleString()} ${getCurrency()}?`
          )
        ) {
          // Dodaj do garaÅ¼u
          garage.push({
            id: car.id,
            brand: car.brand,
            model: car.model,
            name: `${car.brand} ${car.model}`,
            price: car.price,
            type: car.type,
            year: car.year,
            upgradePercent: 50,
          });

          money -= car.price;
          spent += car.price;
          saveState();
          updateAllDisplays();
          playSound("buy");
          const t = translations[currentLang] || translations.en;
          alert(`ğŸš™ ${t.carBought || "Kupiono"} ${car.brand} ${car.model}!`);
          closeModal("buy");
        }
      }

      // SPRZEDAÅ» - garaÅ¼
      function renderGarage() {
        const list = document.getElementById("sellGarageList");
        const empty = document.getElementById("sellEmptyGarage");
        const section = document.getElementById("sellGarageSection");

        if (garage.length === 0) {
          section.style.display = "none";
          empty.style.display = "block";
          return;
        }

        empty.style.display = "none";
        section.style.display = "block";

        list.innerHTML = garage
          .map((car, i) => {
            const upgradePercent = car.upgradePercent || 50;
            const sellPrice = Math.floor(car.price * (upgradePercent / 100));
            return `
                <div class="garage-item" onclick="sellCar(${i})" ${
              car.broken ? 'style="opacity:0.5;pointer-events:none;"' : ""
            }>
                    <div>
                        <div class="car-name">ğŸš— ${
                          car.name || car.brand + " " + car.model
                        }</div>
                        <div class="car-price">${car.year || ""}</div>
                    </div>
                    <div style="text-align:right;">
                        ${
                          car.broken
                            ? '<div style="color:#ef4444;">ğŸ”§ Zepsute</div>'
                            : `
                            <div style="color:#4ade80;font-weight:bold;">+${sellPrice.toLocaleString()} ${getCurrency()}</div>
                            <div style="color:#888;font-size:0.8em;">${upgradePercent.toFixed(
                              1
                            )}%</div>
                        `
                        }
                    </div>
                </div>
            `;
          })
          .join("");
      }

      function sellCar(index) {
        if (index < 0 || index >= garage.length) return;

        const car = garage[index];
        const t = translations[currentLang] || translations.en;

        if (car.broken) {
          alert(t.cantSellBroken || "Nie moÅ¼na sprzedaÄ‡ zepsutego auta!");
          return;
        }

        const upgradePercent = car.upgradePercent || 50;
        const sellPrice = Math.floor(car.price * (upgradePercent / 100));

        const carName = car.name || car.brand + " " + car.model;
        if (
          confirm(
            `${t.confirmSell || "SprzedaÄ‡"} ${carName} ${
              t.forPrice || "za"
            } ${sellPrice.toLocaleString()} ${getCurrency()}?`
          )
        ) {
          money += sellPrice;
          garage.splice(index, 1);
          saveState();
          updateAllDisplays();
          renderGarage();
          playSound("sell");
          alert(
            `ğŸ’¸ Sprzedano za ${sellPrice.toLocaleString()} ${getCurrency()}!`
          );

          if (garage.length === 0) {
            closeModal("sell");
          }
        }
      }

      // Inicjalizacja inputÃ³w - zarobek km
      function initEarnInputs() {
        const kmInput = document.getElementById("kmInput");
        const btn = document.getElementById("earnBtn");

        if (kmInput) kmInput.value = "";
        if (btn) btn.classList.remove("active");

        const calcSpan = document.getElementById("kmCalc");
        if (calcSpan) calcSpan.textContent = "0";
      }

      // Event listener dla km
      document.addEventListener("input", function (e) {
        if (e.target.id === "kmInput") {
          const km = parseFloat(e.target.value) || 0;
          document.getElementById("kmCalc").textContent = (
            km * 100
          ).toLocaleString();
          currentEarnAmount = Math.floor(km * 100);
          document.getElementById("earnBtn").classList.toggle("active", km > 0);
        }
      });

      function showSuccess(type, text, amount, amountClass) {
        const response = document.getElementById(type + "Response");
        const icon = type === "earn" ? "ğŸ›£ï¸" : type === "buy" ? "ğŸš™" : "ğŸ’¸";

        response.innerHTML = `
                <div class="result-icon">${icon}</div>
                <div class="result-text">${text}</div>
                <div class="result-amount ${amountClass}">${amount}</div>
            `;
        document.getElementById(type + "Btn").classList.add("active");
      }

      function showError(type) {
        const response = document.getElementById(type + "Response");
        response.innerHTML = `
                <div class="result-icon">âŒ</div>
                <div class="result-text" style="color: #f87171;">${
                  translations[currentLang].invalidScreenshot ||
                  "Nie rozpoznano danych!"
                }</div>
            `;
        document.getElementById(type + "Btn").classList.remove("active");
      }

      // ==================== SYSTEM WERYFIKACJI QR ====================
      let peer = null;
      let currentVerifyType = null;
      let currentImageData = null;
      let verifyResolve = null;

      // SprawdÅº czy to strona weryfikatora
      function checkIfVerifier() {
        const params = new URLSearchParams(window.location.search);
        const peerId = params.get("verify");
        const type = params.get("type");
        const img = params.get("img");

        if (peerId && type) {
          showVerifierPage(peerId, type, img);
          return true;
        }
        return false;
      }

      function showVerifierPage(peerId, type, imgData) {
        document.body.innerHTML = `
                <div class="verify-page">
                    <h2>ğŸ” Weryfikacja transakcji</h2>
                    <p id="verifyQuestion">${getVerifyQuestion(type)}</p>
                    <img id="verifyImage" src="${imgData || ""}" style="${
          imgData ? "" : "display:none"
        }">
                    <div id="verifyStatus">
                        <div class="loader" style="width:40px;height:40px;border:3px solid #333;border-top-color:#ff6b35;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto;"></div>
                        <p>ÅÄ…czenie z graczem...</p>
                    </div>
                    <div class="verify-buttons" id="verifyButtons" style="display:none;">
                        <button class="verify-btn yes" onclick="sendVerifyResponse(true)">âœ… TAK</button>
                        <button class="verify-btn no" onclick="sendVerifyResponse(false)">âŒ NIE</button>
                    </div>
                    <div id="verifyResult" style="display:none;"></div>
                </div>
            `;

        // PoÅ‚Ä…cz z graczem
        connectToPlayer(peerId);
      }

      function getVerifyQuestion(type) {
        const questions = {
          repair: "Czy na tym obrazku widaÄ‡ uszkodzone auto?",
          sell: "Czy na tym obrazku widaÄ‡ auto?",
          sellDamage: "Czy auto na obrazku jest ZNISZCZONE?",
        };
        return questions[type] || "Czy obrazek jest prawidÅ‚owy?";
      }

      let verifierConn = null;

      function connectToPlayer(peerId) {
        const verifierPeer = new Peer();

        verifierPeer.on("open", () => {
          verifierConn = verifierPeer.connect(peerId);

          verifierConn.on("open", () => {
            document.getElementById("verifyStatus").innerHTML =
              '<p style="color:#4ade80;">âœ… PoÅ‚Ä…czono!</p>';
            document.getElementById("verifyButtons").style.display = "flex";
          });

          verifierConn.on("data", (data) => {
            if (data.type === "image") {
              document.getElementById("verifyImage").src = data.image;
              document.getElementById("verifyImage").style.display = "block";
            }
          });

          verifierConn.on("error", (err) => {
            document.getElementById("verifyStatus").innerHTML =
              '<p style="color:#ef4444;">âŒ BÅ‚Ä…d poÅ‚Ä…czenia</p>';
          });
        });

        verifierPeer.on("error", (err) => {
          document.getElementById("verifyStatus").innerHTML =
            '<p style="color:#ef4444;">âŒ Nie moÅ¼na poÅ‚Ä…czyÄ‡</p>';
        });
      }

      function sendVerifyResponse(approved) {
        if (verifierConn) {
          verifierConn.send({ type: "response", approved: approved });

          document.getElementById("verifyButtons").style.display = "none";
          document.getElementById("verifyResult").style.display = "block";
          document.getElementById("verifyResult").innerHTML = approved
            ? '<div class="verify-result">âœ…</div><p style="color:#4ade80;font-size:1.5em;">Transakcja potwierdzona!</p>'
            : '<div class="verify-result">âŒ</div><p style="color:#ef4444;font-size:1.5em;">Transakcja odrzucona!</p>';
        }
      }

      // Funkcja do generowania QR i czekania na weryfikacjÄ™
      function startVerification(type, imageData) {
        return new Promise((resolve) => {
          verifyResolve = resolve;
          currentVerifyType = type;
          currentImageData = imageData;

          // StwÃ³rz peer dla gracza
          if (peer) {
            peer.destroy();
          }

          peer = new Peer();

          peer.on("open", (id) => {
            // Generuj URL dla weryfikatora
            const baseUrl = window.location.href.split("?")[0];
            const verifyUrl = `${baseUrl}?verify=${id}&type=${type}`;

            // PokaÅ¼ QR
            showQRCode(type, verifyUrl, imageData);
          });

          peer.on("connection", (conn) => {
            conn.on("open", () => {
              // WyÅ›lij obrazek do weryfikatora
              conn.send({ type: "image", image: imageData });
              updateQRStatus("connected");
            });

            conn.on("data", (data) => {
              if (data.type === "response") {
                if (data.approved) {
                  updateQRStatus("approved");
                  resolve(true);
                } else {
                  updateQRStatus("rejected");
                  resolve(false);
                }
              }
            });
          });

          peer.on("error", (err) => {
            console.error("Peer error:", err);
            updateQRStatus("error");
            resolve(false);
          });
        });
      }

      function showQRCode(type, url, imageData) {
        const response = document.getElementById(type + "Response");

        response.innerHTML = `
                <div class="qr-section">
                    <h4>ğŸ“± PoproÅ› kogoÅ› o weryfikacjÄ™</h4>
                    <p>Niech zeskanuje kod QR telefonem</p>
                    <div class="qr-container" id="qr-${type}"></div>
                    <div class="qr-status waiting" id="qrStatus-${type}">
                        â³ Oczekiwanie na weryfikatora...
                    </div>
                </div>
            `;

        // Generuj QR kod
        new QRCode(document.getElementById(`qr-${type}`), {
          text: url,
          width: 180,
          height: 180,
          colorDark: "#1a1a2e",
          colorLight: "#ffffff",
        });
      }

      function updateQRStatus(status) {
        const statusEl = document.querySelector('[id^="qrStatus-"]');
        if (!statusEl) return;

        const type = currentVerifyType;
        const btn = document.getElementById(type + "Btn");

        switch (status) {
          case "connected":
            statusEl.className = "qr-status waiting";
            statusEl.innerHTML =
              "ğŸ”— Weryfikator poÅ‚Ä…czony, czekam na odpowiedÅº...";
            break;
          case "approved":
            statusEl.className = "qr-status success";
            statusEl.innerHTML = "âœ… Transakcja potwierdzona!";
            if (btn) btn.classList.add("active");

            // PokaÅ¼ teÅ¼ koszt/cenÄ™
            setTimeout(() => {
              showVerifiedResult(type);
            }, 1000);
            break;
          case "rejected":
            statusEl.className = "qr-status rejected";
            statusEl.innerHTML = "âŒ Transakcja odrzucona!";
            if (btn) btn.classList.remove("active");
            break;
          case "error":
            statusEl.className = "qr-status rejected";
            statusEl.innerHTML = "âŒ BÅ‚Ä…d poÅ‚Ä…czenia";
            break;
        }
      }

      function showVerifiedResult(type) {
        const response = document.getElementById(type + "Response");

        if (type === "repair") {
          response.innerHTML = `
                    <div class="result-icon">ğŸ”§âœ…</div>
                    <div class="result-text">${
                      translations[currentLang].repairCostInfo ||
                      "Koszt naprawy:"
                    }</div>
                    <div class="result-amount cost">-5,000 ${getCurrency()}</div>
                    <div style="color:#4ade80;margin-top:10px;font-size:0.9em;">Zweryfikowano!</div>
                `;
        } else if (type === "buy") {
          response.innerHTML = `
                    <div class="result-icon">ğŸš™âœ…</div>
                    <div class="result-text">${
                      translations[currentLang].foundPrice || "Cena auta:"
                    } ${currentBuyPrice.toLocaleString()} ${getCurrency()}</div>
                    <div class="result-amount cost">-${currentBuyPrice.toLocaleString()} ${getCurrency()}</div>
                    <div style="color:#4ade80;margin-top:10px;font-size:0.9em;">Zweryfikowano!</div>
                `;
        } else if (type === "sell") {
          response.innerHTML = `
                    <div class="result-icon">ğŸ’¸âœ…</div>
                    <div class="result-text">${
                      translations[currentLang].foundPrice || "Cena auta:"
                    } (50%)</div>
                    <div class="result-amount earn">+${currentSellPrice.toLocaleString()} ${getCurrency()}</div>
                    <div style="color:#4ade80;margin-top:10px;font-size:0.9em;">Zweryfikowano!</div>
                `;
        }
      }

      // Zmodyfikowana funkcja naprawy z QR
      async function analyzeRepairImage(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const preview = document.getElementById("repairPreview");
        const response = document.getElementById("repairResponse");
        const btn = document.getElementById("repairBtn");

        const reader = new FileReader();
        reader.onload = async function (e) {
          const imageData = e.target.result;
          preview.src = imageData;
          preview.style.display = "block";
          document.getElementById("repairUpload").style.display = "none";

          response.classList.add("active");

          // Uruchom weryfikacjÄ™ QR
          const approved = await startVerification("repair", imageData);

          if (!approved) {
            btn.classList.remove("active");
          }
        };
        reader.readAsDataURL(file);
      }

      function confirmCarVisible(type) {
        const response = document.getElementById(type + "Response");
        const btn = document.getElementById(type + "Btn");

        if (type === "repair") {
          response.innerHTML = `
                    <div class="result-icon">ğŸ”§</div>
                    <div class="result-text">${
                      translations[currentLang].repairCostInfo ||
                      "Koszt naprawy:"
                    }</div>
                    <div class="result-amount cost">-5,000 ${getCurrency()}</div>
                `;
          btn.classList.add("active");
        }
      }

      function denyCarVisible(type) {
        const response = document.getElementById(type + "Response");
        response.innerHTML = `
                <div class="result-icon">âŒ</div>
                <div class="result-text" style="color: #f87171;">${
                  translations[currentLang].noCarOnScreen ||
                  "WyÅ›lij screenshot z widocznym autem!"
                }</div>
            `;
        // Reset uploadu
        setTimeout(() => {
          resetUploadForm(type);
        }, 2000);
      }

      // ==================== AKCJE ====================
      function confirmEarn() {
        money += currentEarnAmount;
        saveState();
        updateAllDisplays();
        alert(`ğŸ’° +${currentEarnAmount.toLocaleString()} ${getCurrency()}!`);
        closeModal("earn");
      }

      // ==================== PODATKI ====================
      function checkMissedTaxes() {
        const now = Date.now();
        const elapsed = now - lastTaxTime;
        const missedTaxes = Math.floor(elapsed / (5 * 60 * 1000)); // Co 5 minut

        if (missedTaxes > 0) {
          const totalTax = missedTaxes * 500; // 500 zÅ‚ za kaÅ¼de 5 min

          if (autoPay) {
            if (money >= totalTax) {
              money -= totalTax;
              totalTaxPaid += totalTax;
            } else {
              const paid = money;
              money = 0;
              totalTaxPaid += paid;
              addDebt(totalTax - paid);
            }
          } else {
            addDebt(totalTax);
          }

          lastTaxTime = now;
          saveState();
        }
      }

      function startTaxTimer() {
        setInterval(updateNextTaxDisplay, 1000);
        setInterval(collectTax, 5 * 60 * 1000); // Co 5 minut
      }

      function collectTax() {
        if (autoPay) {
          if (money >= 500) {
            money -= 500;
            totalTaxPaid += 500;
          } else {
            totalTaxPaid += money;
            addDebt(500 - money);
            money = 0;
          }
        } else {
          addDebt(500);
        }

        lastTaxTime = Date.now();
        saveState();
        updateAllDisplays();
      }

      function addDebt(amount) {
        debt += amount;
        if (!debtDeadline) {
          const deadline = new Date();
          deadline.setDate(deadline.getDate() + 7);
          debtDeadline = deadline.toISOString();
        }
        saveState();
      }

      function updateNextTaxDisplay() {
        const elapsed = Date.now() - lastTaxTime;
        const remaining = 5 * 60 * 1000 - elapsed; // 5 minut

        if (remaining > 0) {
          const minutes = Math.floor(remaining / 60000);
          const seconds = Math.floor((remaining % 60000) / 1000);
          document.getElementById("nextTaxTime").textContent = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }
      }

      function toggleAutoPay() {
        autoPay = !autoPay;
        document
          .getElementById("autoPayToggle")
          .classList.toggle("active", autoPay);
        saveState();
      }

      function payDebt() {
        if (money >= debt) {
          money -= debt;
          debt = 0;
          debtDeadline = null;
          saveState();
          updateAllDisplays();
          alert("âœ… DÅ‚ug spÅ‚acony!");
        } else {
          alert(
            translations[currentLang].notEnoughMoney ||
              "Nie masz wystarczajÄ…co pieniÄ™dzy!"
          );
        }
      }

      // ==================== GÅÃ“D I PRAGNIENIE ====================
      function checkMissedHunger() {
        const now = Date.now();
        const elapsed = now - lastHungerTime;
        const missedIntervals = Math.floor(elapsed / HUNGER_INTERVAL);

        if (missedIntervals > 0) {
          // Zmniejsz jedzenie i picie
          food = Math.max(0, food - FOOD_DECAY * missedIntervals);
          water = Math.max(0, water - WATER_DECAY * missedIntervals);

          // JeÅ›li gÅ‚odny/spragniony - traÄ‡ zdrowie
          if (food <= 0 || water <= 0) {
            const healthLoss = missedIntervals * 5;
            health = Math.max(0, health - healthLoss);
          }

          lastHungerTime = now;
          saveState();
        }
      }

      function startHungerTimer() {
        // Sprawdzaj co sekundÄ™ dla aktualizacji wyÅ›wietlania
        setInterval(updateHungerDisplay, 1000);
        // ZuÅ¼ywaj gÅ‚Ã³d/pragnienie co 5 minut
        setInterval(consumeHunger, HUNGER_INTERVAL);
      }

      function consumeHunger() {
        food = Math.max(0, food - FOOD_DECAY);
        water = Math.max(0, water - WATER_DECAY);

        // JeÅ›li gÅ‚odny/spragniony - traÄ‡ zdrowie
        if (food <= 0 || water <= 0) {
          health = Math.max(0, health - 5);
        }

        lastHungerTime = Date.now();
        saveState();
        updateAllDisplays();

        // SprawdÅº Å›mierÄ‡
        checkDeath();

        // OstrzeÅ¼enie gdy niski poziom - ciche
      }

      function checkDeath() {
        if (health <= 0) {
          playerDied();
        }
      }

      function playerDied() {
        const t = translations[currentLang] || translations.en;
        const save = getCurrentSave();

        // Zatrzymaj wszystkie ulepszania
        Object.keys(upgradeIntervals).forEach((idx) => {
          clearInterval(upgradeIntervals[idx]);
        });
        upgradeIntervals = {};

        // SprawdÅº czy jest checkpoint
        const modeKey =
          gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";
        const checkpoint = save[modeKey];

        if (checkpoint) {
          // PrzywrÃ³Ä‡ z checkpointu
          alert(
            `ğŸ’€ ${t.youDied || "ZginÄ…Å‚eÅ›!"}\n\n${
              t.loadingCheckpoint || "Wczytywanie ostatniego checkpointu..."
            }`
          );
          loadCheckpoint();
        } else {
          // Brak checkpointu - reset do poczÄ…tku
          alert(
            `ğŸ’€ ${t.youDied || "ZginÄ…Å‚eÅ›!"}\n\n${
              t.noCheckpoint || "Brak checkpointu - zaczynasz od nowa!"
            }`
          );
          resetModeProgress();
        }

        updateAllDisplays();
        renderGarageModal();
      }

      function createCheckpoint() {
        const t = translations[currentLang] || translations.en;
        const save = getCurrentSave();
        if (!save) return;

        const modeKey =
          gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";

        // Zapisz aktualny stan jako checkpoint
        save[modeKey] = {
          money: money,
          garage: JSON.parse(JSON.stringify(garage)),
          spent: spent,
          debt: debt,
          debtDeadline: debtDeadline,
          totalTaxPaid: totalTaxPaid,
          health: health,
          food: food,
          water: water,
          backpack: JSON.parse(JSON.stringify(backpack)),
          activeInsurances: JSON.parse(JSON.stringify(activeInsurances)),
          createdAt: Date.now(),
        };

        localStorage.setItem("beamng_saves", JSON.stringify(saves));

        alert(
          `âœ… ${t.checkpointCreated || "Checkpoint utworzony!"}\n\n${
            t.checkpointInfo || "JeÅ›li zginiesz, wrÃ³cisz do tego momentu."
          }`
        );
        renderSavesList();
      }

      function loadCheckpoint() {
        const save = getCurrentSave();
        if (!save) return;

        const modeKey =
          gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";
        const checkpoint = save[modeKey];

        if (!checkpoint) return;

        money = checkpoint.money;
        garage = JSON.parse(JSON.stringify(checkpoint.garage));
        spent = checkpoint.spent;
        debt = checkpoint.debt;
        debtDeadline = checkpoint.debtDeadline;
        totalTaxPaid = checkpoint.totalTaxPaid;
        health = checkpoint.health;
        food = checkpoint.food;
        water = checkpoint.water;
        backpack = JSON.parse(JSON.stringify(checkpoint.backpack));
        activeInsurances = JSON.parse(
          JSON.stringify(checkpoint.activeInsurances)
        );

        // WznÃ³w ulepszania
        resumeUpgrades();
        saveState();
      }

      function resetModeProgress() {
        money = 1500;
        garage = [];
        spent = 0;
        debt = 0;
        debtDeadline = null;
        totalTaxPaid = 0;
        health = 100;
        food = 1000;
        water = 1000;
        backpack = [];
        activeInsurances = [];

        saveState();
      }

      function deleteCheckpoint() {
        const t = translations[currentLang] || translations.en;
        const save = getCurrentSave();
        if (!save) return;

        const modeKey =
          gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";

        if (!save[modeKey]) {
          alert(t.noCheckpointToDelete || "Nie masz checkpointu do usuniÄ™cia!");
          return;
        }

        if (
          confirm(
            t.confirmDeleteCheckpoint ||
              "UsunÄ…Ä‡ checkpoint? JeÅ›li zginiesz, stracisz caÅ‚y postÄ™p!"
          )
        ) {
          delete save[modeKey];
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          alert(t.checkpointDeleted || "Checkpoint usuniÄ™ty!");
          renderSavesList();
        }
      }

      function updateHungerDisplay() {
        // MoÅ¼na tu dodaÄ‡ timer do nastÄ™pnego zuÅ¼ycia
      }

      // ==================== UBEZPIECZENIA ====================
      let selectedInsurancePackage = null;

      function renderInsuranceList() {
        const list = document.getElementById("insuranceList");
        const activeSection = document.getElementById(
          "activeInsurancesSection"
        );
        const activeList = document.getElementById("activeInsurancesList");
        const activeCount = document.getElementById("activeCount");

        const t = translations[currentLang] || translations.en;

        // PokaÅ¼ aktywne ubezpieczenia
        if (activeInsurances.length > 0) {
          activeSection.style.display = "block";
          activeCount.textContent = activeInsurances.length;

          activeList.innerHTML = activeInsurances
            .map((ins, idx) => {
              const pkg = insurancePackages.find((p) => p.id === ins.packageId);
              if (!pkg) return "";

              const periodText =
                ins.period === "hour"
                  ? t.perHour || "/godz"
                  : ins.period === "day"
                  ? t.perDay || "/dzieÅ„"
                  : t.perWeek || "/tydzieÅ„";

              const remaining = ins.nextPaymentAt - Date.now();
              const hoursLeft = Math.max(
                0,
                Math.floor(remaining / (60 * 60 * 1000))
              );
              const minsLeft = Math.max(
                0,
                Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000))
              );

              return `
                        <div style="background:rgba(74,222,128,0.1);border:1px solid #4ade80;border-radius:8px;padding:8px;margin-bottom:5px;display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:bold;font-size:0.9em;">${
                                  pkg.icon
                                } ${getInsuranceName(pkg)}</div>
                                <div style="font-size:0.75em;color:#888;">${ins.price.toLocaleString()} ${getCurrency()} ${periodText}</div>
                                <div style="font-size:0.7em;color:#aaa;">â±ï¸ ${hoursLeft}h ${minsLeft}m | ${
                ins.autoPay ? "âœ…" : "âŒ"
              } Auto</div>
                            </div>
                            <button onclick="showInsuranceDetails(${idx})" style="padding:5px 10px;background:#ff6b35;color:white;border:none;border-radius:5px;font-size:0.8em;cursor:pointer;">ğŸ“‹</button>
                        </div>
                    `;
            })
            .join("");
        } else {
          activeSection.style.display = "none";
        }

        // Lista pakietÃ³w do kupienia
        list.innerHTML = insurancePackages
          .map((pkg) => {
            const isOwned = activeInsurances.some(
              (i) => i.packageId === pkg.id
            );

            return `
                <div class="garage-item" onclick="${
                  isOwned ? "" : `showInsurancePeriods('${pkg.id}')`
                }" style="${
              isOwned ? "opacity:0.5;cursor:default;border-color:#4ade80;" : ""
            }">
                    <div>
                        <div class="car-name">${pkg.icon} ${getInsuranceName(
              pkg
            )}</div>
                        <div style="font-size:0.75em;color:#aaa;">${getInsuranceDesc(
                          pkg
                        )} ${t.every || "co"} ${pkg.interval} min</div>
                    </div>
                    <div style="text-align:right;font-size:0.75em;">
                        <div style="color:#ff6b35;">${
                          pkg.prices.hour
                        } ${getCurrency()}<span style="color:#666;">${
              t.perHourShort || "/h"
            }</span></div>
                        <div style="color:#ff6b35;">${
                          pkg.prices.day
                        } ${getCurrency()}<span style="color:#666;">${
              t.perDayShort || "/d"
            }</span></div>
                        <div style="color:#ff6b35;">${
                          pkg.prices.week
                        } ${getCurrency()}<span style="color:#666;">${
              t.perWeekShort || "/tyg"
            }</span></div>
                        ${
                          isOwned
                            ? '<div style="color:#4ade80;margin-top:2px;">âœ…</div>'
                            : ""
                        }
                    </div>
                </div>
            `;
          })
          .join("");
      }

      function showInsurancePeriods(packageId) {
        selectedInsurancePackage = insurancePackages.find(
          (p) => p.id === packageId
        );
        if (!selectedInsurancePackage) return;

        const pkg = selectedInsurancePackage;
        const t = translations[currentLang] || translations.en;

        document.getElementById("insurancePeriodDetails").innerHTML = `
                <div style="font-size:2em;">${pkg.icon}</div>
                <div style="font-weight:bold;font-size:1.2em;">${getInsuranceName(
                  pkg
                )}</div>
                <div style="color:#aaa;font-size:0.9em;">${getInsuranceDesc(
                  pkg
                )} ${t.every || "co"} ${pkg.interval} min</div>
            `;

        document.getElementById("periodOptions").innerHTML = `
                <button onclick="buyInsurance('hour')" style="padding:15px;background:linear-gradient(145deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span>â° ${t.hour || "Godzina"}</span>
                    <span style="font-weight:bold;">${pkg.prices.hour.toLocaleString()} ${getCurrency()}</span>
                </button>
                <button onclick="buyInsurance('day')" style="padding:15px;background:linear-gradient(145deg,#3b82f6,#2563eb);color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span>ğŸ“… ${t.day || "DzieÅ„"}</span>
                    <span style="font-weight:bold;">${pkg.prices.day.toLocaleString()} ${getCurrency()}</span>
                </button>
                <button onclick="buyInsurance('week')" style="padding:15px;background:linear-gradient(145deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span>ğŸ“† ${t.week || "TydzieÅ„"}</span>
                    <span style="font-weight:bold;">${pkg.prices.week.toLocaleString()} ${getCurrency()}</span>
                </button>
            `;

        openModal("insurancePeriod");
      }

      function buyInsurance(period) {
        if (!selectedInsurancePackage) return;

        const pkg = selectedInsurancePackage;
        let price, duration;

        if (period === "hour") {
          price = pkg.prices.hour;
          duration = 60 * 60 * 1000; // 1 godzina
        } else if (period === "day") {
          price = pkg.prices.day;
          duration = 24 * 60 * 60 * 1000; // 1 dzieÅ„
        } else {
          price = pkg.prices.week;
          duration = 7 * 24 * 60 * 60 * 1000; // 1 tydzieÅ„
        }

        if (money < price) {
          alert(
            translations[currentLang].notEnoughMoney ||
              "Nie masz wystarczajÄ…co pieniÄ™dzy!"
          );
          return;
        }

        // SprawdÅº czy juÅ¼ ma to ubezpieczenie
        if (activeInsurances.some((i) => i.packageId === pkg.id)) {
          alert(
            translations[currentLang].alreadyHaveInsurance ||
              "JuÅ¼ masz to ubezpieczenie!"
          );
          return;
        }

        money -= price;
        activeInsurances.push({
          packageId: pkg.id,
          period: period,
          price: price,
          totalPaid: price,
          benefitCount: 0,
          autoPay: true,
          startedAt: Date.now(),
          lastBenefitAt: Date.now(),
          nextPaymentAt: Date.now() + duration,
        });

        playSound("insurance");
        saveState();
        updateAllDisplays();
        closeModal("insurancePeriod");
        renderInsuranceList();

        const t = translations[currentLang] || translations.en;
        alert(`ğŸ¥ ${getInsuranceName(pkg)} - ${t.activated || "Aktywowane"}!`);
      }

      function showInsuranceDetails(index) {
        if (index < 0 || index >= activeInsurances.length) return;

        const ins = activeInsurances[index];
        const pkg = insurancePackages.find((p) => p.id === ins.packageId);
        if (!pkg) return;

        const t = translations[currentLang] || translations.en;
        const periodText =
          ins.period === "hour"
            ? t.perHour || "/godz"
            : ins.period === "day"
            ? t.perDay || "/dzieÅ„"
            : t.perWeek || "/tydzieÅ„";

        const remaining = ins.nextPaymentAt - Date.now();
        const daysLeft = Math.floor(remaining / (24 * 60 * 60 * 1000));
        const hoursLeft = Math.floor(
          (remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000)
        );
        const minsLeft = Math.floor(
          (remaining % (60 * 60 * 1000)) / (60 * 1000)
        );

        // Oblicz zwrot (10% jeÅ›li uÅ¼yto 3+ razy)
        const refund =
          ins.benefitCount >= 3 ? Math.floor(ins.totalPaid * 0.1) : 0;

        document.getElementById("insuranceDetailsContent").innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:3em;">${pkg.icon}</div>
                    <div style="font-weight:bold;font-size:1.3em;">${getInsuranceName(
                      pkg
                    )}</div>
                    <div style="color:#aaa;">${getInsuranceDesc(pkg)} ${
          t.every || "co"
        } ${pkg.interval} min</div>
                </div>
                
                <div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:15px;margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${t.price || "Cena"}:</span>
                        <span style="color:#ff6b35;font-weight:bold;">${ins.price.toLocaleString()} ${getCurrency()} ${periodText}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${t.totalPaid || "ZapÅ‚acono Å‚Ä…cznie"}:</span>
                        <span>${ins.totalPaid.toLocaleString()} ${getCurrency()}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${
                          t.benefitsReceived || "Otrzymane korzyÅ›ci"
                        }:</span>
                        <span>${ins.benefitCount}x</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span>${t.nextPayment || "NastÄ™pna pÅ‚atnoÅ›Ä‡"}:</span>
                        <span>${
                          daysLeft > 0 ? daysLeft + "d " : ""
                        }${hoursLeft}h ${minsLeft}m</span>
                    </div>
                </div>
                
                <div class="tax-toggle" style="margin-bottom:15px;">
                    <div>
                        <strong>${t.autoPay || "Automatyczne pÅ‚acenie"}</strong>
                    </div>
                    <div class="toggle-switch ${
                      ins.autoPay ? "active" : ""
                    }" onclick="toggleInsuranceAutoPay(${index})"></div>
                </div>
                
                <button onclick="cancelInsurance(${index})" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;">
                    âŒ ${t.cancelInsurance || "Zrezygnuj"} ${
          refund > 0
            ? `(${
                t.refund || "zwrot"
              }: ${refund.toLocaleString()} ${getCurrency()})`
            : `(${t.noRefund || "brak zwrotu"})`
        }
                </button>
            `;

        openModal("insuranceDetails");
      }

      function toggleInsuranceAutoPay(index) {
        if (index < 0 || index >= activeInsurances.length) return;
        activeInsurances[index].autoPay = !activeInsurances[index].autoPay;
        saveState();
        showInsuranceDetails(index);
        updateCardDisplay();
      }

      function cancelInsurance(index) {
        if (index < 0 || index >= activeInsurances.length) return;

        const ins = activeInsurances[index];
        const pkg = insurancePackages.find((p) => p.id === ins.packageId);
        const t = translations[currentLang] || translations.en;

        // Oblicz zwrot
        const refund =
          ins.benefitCount >= 3 ? Math.floor(ins.totalPaid * 0.1) : 0;

        const confirmMsg =
          refund > 0
            ? `${
                t.confirmCancelWithRefund || "ZrezygnowaÄ‡? Zwrot"
              }: ${refund.toLocaleString()} ${getCurrency()}`
            : t.confirmCancelNoRefund ||
              "ZrezygnowaÄ‡? Brak zwrotu (uÅ¼yto mniej niÅ¼ 3 razy)";

        if (confirm(confirmMsg)) {
          if (refund > 0) {
            money += refund;
          }
          activeInsurances.splice(index, 1);
          saveState();
          updateAllDisplays();
          closeModal("insuranceDetails");
          renderInsuranceList();
        }
      }

      function checkInsuranceBenefits() {
        const now = Date.now();
        let needsSave = false;

        for (let i = activeInsurances.length - 1; i >= 0; i--) {
          const ins = activeInsurances[i];
          const pkg = insurancePackages.find((p) => p.id === ins.packageId);
          if (!pkg) continue;

          // SprawdÅº czy czas na pÅ‚atnoÅ›Ä‡
          if (now >= ins.nextPaymentAt) {
            let duration;
            if (ins.period === "hour") duration = 60 * 60 * 1000;
            else if (ins.period === "day") duration = 24 * 60 * 60 * 1000;
            else duration = 7 * 24 * 60 * 60 * 1000;

            if (ins.autoPay) {
              // Auto-pay: pÅ‚aÄ‡ lub idÅº na dÅ‚ug, ale ZAWSZE kontynuuj ubezpieczenie
              if (money >= ins.price) {
                money -= ins.price;
                ins.totalPaid += ins.price;
              } else {
                // Nie ma kasy - pÅ‚aÄ‡ ile moÅ¼esz, reszta na dÅ‚ug
                const paid = money;
                money = 0;
                ins.totalPaid += paid;
                addDebt(ins.price - paid);
              }
              ins.nextPaymentAt = now + duration;
              needsSave = true;
            } else {
              // Nie auto-pay = dÅ‚ug i usuÅ„ ubezpieczenie
              addDebt(ins.price);
              activeInsurances.splice(i, 1);
              needsSave = true;
              continue;
            }
          }

          // Przyznaj korzyÅ›ci
          const intervalMs = pkg.interval * 60 * 1000;
          if (now - ins.lastBenefitAt >= intervalMs) {
            if (pkg.benefits.hp > 0)
              health = Math.min(MAX_HEALTH, health + pkg.benefits.hp);
            if (pkg.benefits.kcal > 0)
              food = Math.min(MAX_FOOD, food + pkg.benefits.kcal);
            if (pkg.benefits.ml > 0)
              water = Math.min(MAX_WATER, water + pkg.benefits.ml);

            ins.lastBenefitAt = now;
            ins.benefitCount++;
            needsSave = true;
          }
        }

        if (needsSave) {
          saveState();
          updateAllDisplays();
        }
      }

      function startInsuranceTimer() {
        setInterval(checkInsuranceBenefits, 60 * 1000);
      }

      // ==================== WYÅšWIETLANIE ====================
      function updateAllDisplays() {
        updateMoneyDisplay();
        updateCardDisplay();
        updateDebtDisplay();
        updateTaxDisplay();
        updateStatusBars();
      }

      function updateStatusBars() {
        // Zdrowie
        const healthPercent = (health / MAX_HEALTH) * 100;
        document.getElementById("healthBar").style.width = healthPercent + "%";
        document.getElementById(
          "healthValue"
        ).textContent = `${health}/${MAX_HEALTH}`;

        // Jedzenie
        const foodPercent = (food / MAX_FOOD) * 100;
        document.getElementById("foodBar").style.width = foodPercent + "%";
        document.getElementById(
          "foodValue"
        ).textContent = `${food}/${MAX_FOOD} kcal`;

        // Picie
        const waterPercent = (water / MAX_WATER) * 100;
        document.getElementById("waterBar").style.width = waterPercent + "%";
        document.getElementById(
          "waterValue"
        ).textContent = `${water}/${MAX_WATER} ml`;
      }

      function updateInventoryDisplay() {
        document.getElementById(
          "invHealth"
        ).textContent = `${health}/${MAX_HEALTH} HP`;
        document.getElementById(
          "invFood"
        ).textContent = `${food}/${MAX_FOOD} kcal`;
        document.getElementById(
          "invWater"
        ).textContent = `${water}/${MAX_WATER} ml`;
      }

      function showShopTab(tab) {
        currentShopTab = tab;
        document
          .querySelectorAll("#modalShop .inv-tab")
          .forEach((t) => t.classList.remove("active"));
        event.target.classList.add("active");
        renderShopItems();
      }

      // SKLEP - kupowanie do plecaka
      function renderShopItems() {
        const grid = document.getElementById("shopGrid");
        const items = currentShopTab === "food" ? foodItems : drinkItems;

        grid.innerHTML = items
          .map(
            (item) => `
                <div class="shop-item" onclick="buyToBackpack('${
                  item.id
                }', '${currentShopTab}')">
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${getItemName(item)}</div>
                    <div class="item-stats">
                        ${
                          item.kcal > 0
                            ? `<span class="positive">+${item.kcal} kcal</span><br>`
                            : ""
                        }
                        ${
                          item.ml > 0
                            ? `<span class="positive">+${item.ml} ml</span><br>`
                            : ""
                        }
                        ${
                          item.hp > 0
                            ? `<span class="positive">+${item.hp} HP</span>`
                            : ""
                        }
                        ${
                          item.hp < 0
                            ? `<span class="negative">${item.hp} HP</span>`
                            : ""
                        }
                    </div>
                    <div class="item-price">${item.price} zÅ‚</div>
                </div>
            `
          )
          .join("");
      }

      function buyToBackpack(itemId, type) {
        const items = type === "food" ? foodItems : drinkItems;
        const item = items.find((i) => i.id === itemId);
        if (!item) return;

        if (money < item.price) {
          alert(
            translations[currentLang].notEnoughMoney ||
              "Nie masz wystarczajÄ…co pieniÄ™dzy!"
          );
          return;
        }

        // Kup i dodaj do plecaka
        money -= item.price;
        backpack.push({ ...item, type: type });

        playSound("buy");
        saveState();
        updateAllDisplays();

        alert(`${item.icon} ${getItemName(item)} â†’ ğŸ’`);
      }

      // EKWIPUNEK - zawartoÅ›Ä‡ plecaka
      function renderBackpack() {
        const grid = document.getElementById("backpackGrid");
        const empty = document.getElementById("emptyBackpack");

        if (backpack.length === 0) {
          grid.style.display = "none";
          empty.style.display = "block";
          return;
        }

        grid.style.display = "grid";
        empty.style.display = "none";

        // Grupuj przedmioty
        const grouped = {};
        backpack.forEach((item, index) => {
          if (!grouped[item.id]) {
            grouped[item.id] = { ...item, count: 0, indices: [] };
          }
          grouped[item.id].count++;
          grouped[item.id].indices.push(index);
        });

        grid.innerHTML = Object.values(grouped)
          .map((item) => {
            // SprawdÅº czy moÅ¼na uÅ¼yÄ‡
            const foodPercent = (food / MAX_FOOD) * 100;
            const waterPercent = (water / MAX_WATER) * 100;
            const canUse =
              (item.kcal > 0 && foodPercent < 98) ||
              (item.ml > 0 && waterPercent < 98) ||
              (item.kcal === 0 && item.ml === 0);
            const blocked = !canUse;

            return `
                <div class="shop-item ${blocked ? "blocked" : ""}" onclick="${
              blocked ? "" : `useItem('${item.id}')`
            }" style="${blocked ? "opacity:0.5;cursor:not-allowed;" : ""}">
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${getItemName(item)} ${
              item.count > 1
                ? `<span style="color:#ff6b35;">x${item.count}</span>`
                : ""
            }</div>
                    <div class="item-stats">
                        ${
                          item.kcal > 0
                            ? `<span class="positive">+${item.kcal} kcal</span><br>`
                            : ""
                        }
                        ${
                          item.ml > 0
                            ? `<span class="positive">+${item.ml} ml</span><br>`
                            : ""
                        }
                        ${
                          item.hp > 0
                            ? `<span class="positive">+${item.hp} HP</span>`
                            : ""
                        }
                        ${
                          item.hp < 0
                            ? `<span class="negative">${item.hp} HP</span>`
                            : ""
                        }
                    </div>
                    ${
                      blocked
                        ? `<div style="color:#f87171;font-size:0.8em;margin-top:5px;">â›” ${
                            translations[currentLang].tooFull || "JesteÅ› peÅ‚ny!"
                          }</div>`
                        : `<div style="color:#4ade80;font-size:0.85em;margin-top:5px;">â–¶ ${
                            translations[currentLang].useItem || "UÅ¼yj"
                          }</div>`
                    }
                </div>
            `;
          })
          .join("");
      }

      function useItem(itemId) {
        const index = backpack.findIndex((i) => i.id === itemId);
        if (index === -1) return;

        const item = backpack[index];

        // SprawdÅº czy moÅ¼na uÅ¼yÄ‡ (pasek < 98%)
        const foodPercent = (food / MAX_FOOD) * 100;
        const waterPercent = (water / MAX_WATER) * 100;

        if (item.kcal > 0 && foodPercent >= 98) {
          alert(
            translations[currentLang].foodFull || "Nie moÅ¼esz wiÄ™cej jeÅ›Ä‡!"
          );
          return;
        }
        if (item.ml > 0 && waterPercent >= 98) {
          alert(
            translations[currentLang].waterFull || "Nie moÅ¼esz wiÄ™cej piÄ‡!"
          );
          return;
        }

        // UÅ¼yj przedmiotu
        food = Math.min(food + item.kcal, MAX_FOOD);
        water = Math.min(water + item.ml, MAX_WATER);
        health = Math.max(0, Math.min(health + item.hp, MAX_HEALTH));

        // DÅºwiÄ™k
        if (item.ml > 0) {
          playSound("drink");
        } else {
          playSound("eat");
        }

        // UsuÅ„ z plecaka
        backpack.splice(index, 1);

        saveState();
        updateAllDisplays();
        updateInventoryDisplay();
        renderBackpack();

        let effectText = "";
        if (item.kcal > 0) effectText += `+${item.kcal} kcal `;
        if (item.ml > 0) effectText += `+${item.ml} ml `;
        if (item.hp > 0) effectText += `+${item.hp} HP`;
        if (item.hp < 0) effectText += `${item.hp} HP`;

        alert(`${item.icon} ${getItemName(item)}\n${effectText}`);
      }

      function formatCurrency(amount) {
        const symbol = currentLang === "en" ? "$" : "zÅ‚";
        return amount.toLocaleString() + " " + symbol;
      }

      function getCurrency() {
        return currentLang === "en" ? "$" : "zÅ‚";
      }

      function updateMoneyDisplay() {
        const display = document.getElementById("moneyDisplay");
        display.textContent = formatCurrency(money);
        display.classList.toggle("low", money < 5000);
      }

      function updateCardDisplay() {
        document.getElementById("cardCode").textContent = cardCode;
        document.getElementById("cardBalance").textContent =
          formatCurrency(money);
        document.getElementById("limitValue").textContent =
          formatCurrency(limit);
        document.getElementById("spentValue").textContent =
          formatCurrency(spent);
        document.getElementById("remainingValue").textContent = formatCurrency(
          limit - spent
        );
        document.getElementById("limitBar").style.width =
          Math.min((spent / limit) * 100, 100) + "%";

        // Lista ubezpieczeÅ„ na karcie
        const listEl = document.getElementById("insuranceAutoPayList");
        const noInsEl = document.getElementById("noInsurancesCard");
        const t = translations[currentLang] || translations.en;

        if (activeInsurances.length > 0) {
          noInsEl.style.display = "none";
          listEl.innerHTML = activeInsurances
            .map((ins, idx) => {
              const pkg = insurancePackages.find((p) => p.id === ins.packageId);
              if (!pkg) return "";

              const periodText =
                ins.period === "day"
                  ? t.perDay || "/d"
                  : ins.period === "week"
                  ? t.perWeek || "/tyg"
                  : t.perMonth || "/mies";

              return `
                        <div class="tax-toggle" style="margin-bottom:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px;">
                            <div>
                                <strong style="font-size:0.9em;">${
                                  pkg.icon
                                } ${getInsuranceName(pkg)}</strong>
                                <p style="font-size:0.7em;color:#888;margin:0;">${
                                  ins.price
                                } zÅ‚ ${periodText}</p>
                            </div>
                            <div class="toggle-switch ${
                              ins.autoPay ? "active" : ""
                            }" onclick="toggleInsuranceAutoPayFromCard(${idx})"></div>
                        </div>
                    `;
            })
            .join("");
        } else {
          noInsEl.style.display = "block";
          listEl.innerHTML = "";
        }
      }

      function toggleInsuranceAutoPayFromCard(index) {
        if (index < 0 || index >= activeInsurances.length) return;
        activeInsurances[index].autoPay = !activeInsurances[index].autoPay;
        saveState();
        updateCardDisplay();
      }

      function updateDebtDisplay() {
        const debtDisplay = document.getElementById("debtDisplay");

        if (debt > 0) {
          debtDisplay.classList.add("active");
          document.getElementById("debtAmount").textContent =
            debt.toLocaleString() + " " + getCurrency();

          if (debtDeadline) {
            const daysLeft = Math.ceil(
              (new Date(debtDeadline) - new Date()) / (1000 * 60 * 60 * 24)
            );
            document.getElementById(
              "debtDeadline"
            ).textContent = `${daysLeft} ${
              translations[currentLang].daysLeft || "dni do spÅ‚aty"
            }`;
          }

          document.getElementById("currentDebt").textContent =
            debt.toLocaleString() + " " + getCurrency();
          document.getElementById("payDebtBtn").style.display = "block";
        } else {
          debtDisplay.classList.remove("active");
          document.getElementById("currentDebt").textContent =
            "0 " + getCurrency();
          document.getElementById("payDebtBtn").style.display = "none";
        }
      }

      function updateTaxDisplay() {
        document.getElementById("totalTaxPaid").textContent =
          totalTaxPaid.toLocaleString() + " " + getCurrency();
        document
          .getElementById("autoPayToggle")
          .classList.toggle("active", autoPay);
      }

      // ==================== MODALS ====================
      function openModal(type) {
        document
          .getElementById(
            "modal" + type.charAt(0).toUpperCase() + type.slice(1)
          )
          .classList.add("active");

        if (type === "card") updateCardDisplay();
        if (type === "tax") {
          updateTaxDisplay();
          updateDebtDisplay();
        }
        if (type === "pin") {
          currentPin = "";
          updatePinDisplay();
        }
        if (type === "sell") {
          renderGarage();
        }
        if (type === "buy") {
          carSearchQuery = "";
          document.getElementById("carSearchInput").value = "";
          renderCarBuyList();
        }
        if (type === "earn") initEarnInputs();
        if (type === "repair") {
          selectedRepairCarIndex = null;
          renderRepairCarList();
        }
        if (type === "shop") {
          currentShopTab = "food";
          renderShopItems();
          document
            .querySelectorAll("#modalShop .inv-tab")
            .forEach((t, i) => t.classList.toggle("active", i === 0));
        }
        if (type === "inventory") {
          updateInventoryDisplay();
          renderBackpack();
        }
        if (type === "insurance") {
          renderInsuranceList();
        }
        if (type === "saves") {
          renderSavesList();
        }
        if (type === "vouchers") {
          renderVouchersList();
        }
        if (type === "garage") {
          renderGarageModal();
        }
        if (type === "work") {
          renderJobsList();
        }
        if (type === "onlineAccount") {
          renderOnlineAccount();
        }
        if (type === "notifications") {
          renderNotifications();
        }
      }

      function closeModal(type) {
        document
          .getElementById(
            "modal" + type.charAt(0).toUpperCase() + type.slice(1)
          )
          .classList.remove("active");
      }

      function resetUploadForm(type) {
        const fileEl = document.getElementById(type + "File");
        const previewEl = document.getElementById(type + "Preview");
        const uploadEl = document.getElementById(type + "Upload");
        const responseEl = document.getElementById(type + "Response");
        const btnEl = document.getElementById(type + "Btn");

        if (fileEl) fileEl.value = "";
        if (previewEl) previewEl.style.display = "none";
        if (uploadEl) uploadEl.style.display = "block";
        if (responseEl) responseEl.classList.remove("active");
        if (btnEl) btnEl.classList.remove("active");
      }

      // ==================== PIN ====================
      function updatePinDisplay() {
        for (let i = 1; i <= 6; i++) {
          const digit = document.getElementById("pin" + i);
          digit.textContent = currentPin.length >= i ? "â—" : "";
          digit.classList.toggle("filled", currentPin.length >= i);
        }
      }

      function addPinDigit(d) {
        if (currentPin.length < 6) {
          currentPin += d;
          updatePinDisplay();
        }
      }
      function deletePinDigit() {
        currentPin = currentPin.slice(0, -1);
        updatePinDisplay();
      }

      function confirmPin() {
        if (currentPin === pin) {
          if (pendingAction === "resetLimit") {
            spent = 0;
            saveState();
            updateCardDisplay();
            alert("âœ…");
          } else if (pendingAction === "setLimit") {
            const newLimit = parseInt(
              document.getElementById("newLimitInput").value
            );
            if (newLimit >= 100) {
              limit = newLimit;
              saveState();
              updateCardDisplay();
              alert("âœ…");
            }
          } else if (pendingAction === "repair") {
            money -= REPAIR_COST;
            spent += REPAIR_COST;
            saveState();
            updateAllDisplays();
            alert(`ğŸ”§ -5,000 ${getCurrency()}`);
            closeModal("repair");
          } else if (pendingAction === "buy") {
            money -= currentBuyPrice;
            spent += currentBuyPrice;
            saveState();
            updateAllDisplays();
            alert(`ğŸš™ -${currentBuyPrice.toLocaleString()} ${getCurrency()}`);
            closeModal("buy");
          } else if (pendingAction === "buyAuction" && pendingAuctionId) {
            completePurchaseWithPin(pendingAuctionId);
          }
          pendingAction = null;
          closeModal("pin");
        } else {
          alert("âŒ PIN");
          currentPin = "";
          updatePinDisplay();
        }
      }

      function setNewLimit() {
        const newLimit = parseInt(
          document.getElementById("newLimitInput").value
        );
        if (newLimit >= 100) {
          pendingAction = "setLimit";
          closeModal("setLimit");
          openModal("pin");
        } else {
          alert("âŒ Min. 100 zÅ‚");
        }
      }

      // ==================== JÄ˜ZYKI ====================
      function generateLangGrid() {
        const grid = document.getElementById("langGrid");
        grid.innerHTML = "";
        Object.entries(languages).forEach(([code, lang]) => {
          const option = document.createElement("div");
          option.className =
            "lang-option" + (code === currentLang ? " selected" : "");
          option.innerHTML = `${lang.flag} ${lang.name}`;
          option.onclick = () => {
            currentLang = code;
            saveState();
            applyLanguage();
            updateAllDisplays();
            generateLangGrid();
            closeModal("language");
          };
          grid.appendChild(option);
        });
      }

      function applyLanguage() {
        const trans = translations[currentLang] || translations.en;
        document.querySelectorAll("[data-translate]").forEach((el) => {
          if (trans[el.getAttribute("data-translate")]) {
            el.textContent = trans[el.getAttribute("data-translate")];
          }
        });
        // Aktualizuj teÅ¼ ekran blokady mobilnej
        if (typeof updateMobileBlockLanguage === 'function') {
          updateMobileBlockLanguage();
        }
      }

      // ==================== DRAG & DROP ====================
      ["repair", "sell"].forEach((type) => {
        const area = document.getElementById(type + "Upload");
        if (!area) return;
        area.addEventListener("dragover", (e) => {
          e.preventDefault();
          area.classList.add("dragover");
        });
        area.addEventListener("dragleave", () =>
          area.classList.remove("dragover")
        );
        area.addEventListener("drop", (e) => {
          e.preventDefault();
          area.classList.remove("dragover");
          const file = e.dataTransfer.files[0];
          if (file?.type.startsWith("image/")) {
            const input = document.getElementById(type + "File");
            const dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;
            if (type === "repair") analyzeRepairImage(input);
            else if (type === "sell") startSellQR(input);
          }
        });
      });

      // Background tax
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          checkMissedTaxes();
          updateAllDisplays();
          processBusinessWeeklyPayments();
        }
      });
      window.addEventListener("beforeunload", saveState);

      // ==================== SYSTEM FIRM ====================
      
      // Kategorie firm - z tÅ‚umaczeniami
      function getBusinessCategories() {
        const isEn = currentLang === 'en';
        return {
          gastronomy: {
            name: isEn ? "ğŸ” Gastronomy" : "ğŸ” Gastronomia",
            types: [
              { id: "fastfood", name: "Fast Food", icon: "ğŸŸ", startCost: 25000, clientsPerDay: 10, avgIncome: 50 },
              { id: "restaurant", name: isEn ? "Restaurant" : "Restauracja", icon: "ğŸ½ï¸", startCost: 75000, clientsPerDay: 8, avgIncome: 150 },
              { id: "cafe", name: isEn ? "Cafe" : "Kawiarnia", icon: "â˜•", startCost: 35000, clientsPerDay: 15, avgIncome: 30 },
              { id: "pizzeria", name: "Pizzeria", icon: "ğŸ•", startCost: 45000, clientsPerDay: 12, avgIncome: 60 },
              { id: "bar", name: "Bar", icon: "ğŸº", startCost: 55000, clientsPerDay: 20, avgIncome: 40 },
            ]
          },
          retail: {
            name: isEn ? "ğŸ›’ Retail" : "ğŸ›’ Handel",
            types: [
              { id: "grocery", name: isEn ? "Grocery Store" : "Sklep spoÅ¼ywczy", icon: "ğŸ›’", startCost: 40000, clientsPerDay: 25, avgIncome: 20 },
              { id: "electronics", name: isEn ? "Electronics Store" : "Sklep elektroniczny", icon: "ğŸ“±", startCost: 100000, clientsPerDay: 5, avgIncome: 500 },
              { id: "clothes", name: isEn ? "Clothing Boutique" : "Butik odzieÅ¼owy", icon: "ğŸ‘•", startCost: 60000, clientsPerDay: 8, avgIncome: 120 },
              { id: "autoparts", name: isEn ? "Auto Parts Store" : "Sklep z czÄ™Å›ciami", icon: "ğŸ”§", startCost: 80000, clientsPerDay: 6, avgIncome: 200 },
              { id: "pharmacy", name: isEn ? "Pharmacy" : "Apteka", icon: "ğŸ’Š", startCost: 120000, clientsPerDay: 15, avgIncome: 80 },
            ]
          },
          services: {
            name: isEn ? "ğŸ”§ Services" : "ğŸ”§ UsÅ‚ugi",
            types: [
              { id: "carwash", name: isEn ? "Car Wash" : "Myjnia samochodowa", icon: "ğŸš¿", startCost: 30000, clientsPerDay: 20, avgIncome: 35 },
              { id: "mechanic", name: isEn ? "Auto Workshop" : "Warsztat samochodowy", icon: "ğŸ”§", startCost: 70000, clientsPerDay: 5, avgIncome: 300 },
              { id: "hairdresser", name: isEn ? "Hair Salon" : "Salon fryzjerski", icon: "ğŸ’‡", startCost: 25000, clientsPerDay: 12, avgIncome: 50 },
              { id: "gym", name: isEn ? "Gym" : "SiÅ‚ownia", icon: "ğŸ‹ï¸", startCost: 90000, clientsPerDay: 30, avgIncome: 25 },
              { id: "hotel", name: "Hotel", icon: "ğŸ¨", startCost: 200000, clientsPerDay: 10, avgIncome: 200 },
            ]
          },
          finance: {
            name: isEn ? "ğŸ’° Finance" : "ğŸ’° Finanse",
            types: [
              { id: "bank", name: isEn ? "Bank" : "Bank", icon: "ğŸ¦", startCost: 500000, clientsPerDay: 15, avgIncome: 100, special: "bank" },
              { id: "insurance", name: isEn ? "Insurance Company" : "Firma ubezpieczeniowa", icon: "ğŸ›¡ï¸", startCost: 300000, clientsPerDay: 8, avgIncome: 250, special: "insurance" },
              { id: "exchange", name: isEn ? "Currency Exchange" : "Kantor", icon: "ğŸ’±", startCost: 150000, clientsPerDay: 20, avgIncome: 50 },
              { id: "loans", name: isEn ? "Loan Company" : "Firma poÅ¼yczkowa", icon: "ğŸ’³", startCost: 250000, clientsPerDay: 10, avgIncome: 150, special: "loans" },
            ]
          },
          transport: {
            name: "ğŸšš Transport",
            types: [
              { id: "taxi", name: isEn ? "Taxi Company" : "Firma taksÃ³wkowa", icon: "ğŸš•", startCost: 50000, clientsPerDay: 25, avgIncome: 40 },
              { id: "delivery", name: isEn ? "Delivery Company" : "Firma kurierska", icon: "ğŸ“¦", startCost: 80000, clientsPerDay: 30, avgIncome: 25 },
              { id: "trucking", name: isEn ? "Trucking Company" : "Firma transportowa", icon: "ğŸš›", startCost: 200000, clientsPerDay: 5, avgIncome: 500 },
              { id: "rental", name: isEn ? "Car Rental" : "WypoÅ¼yczalnia aut", icon: "ğŸš—", startCost: 150000, clientsPerDay: 8, avgIncome: 150 },
            ]
          },
          tech: {
            name: isEn ? "ğŸ’» Technology" : "ğŸ’» Technologia",
            types: [
              { id: "software", name: "Software House", icon: "ğŸ’»", startCost: 100000, clientsPerDay: 3, avgIncome: 1000 },
              { id: "itservice", name: isEn ? "IT Service" : "Serwis IT", icon: "ğŸ–¥ï¸", startCost: 40000, clientsPerDay: 8, avgIncome: 150 },
              { id: "webagency", name: isEn ? "Web Agency" : "Agencja webowa", icon: "ğŸŒ", startCost: 60000, clientsPerDay: 5, avgIncome: 300 },
              { id: "gaming", name: isEn ? "Game Studio" : "Studio gier", icon: "ğŸ®", startCost: 150000, clientsPerDay: 2, avgIncome: 2000 },
            ]
          },
          entertainment: {
            name: isEn ? "ğŸ¬ Entertainment" : "ğŸ¬ Rozrywka",
            types: [
              { id: "cinema", name: isEn ? "Cinema" : "Kino", icon: "ğŸ¬", startCost: 300000, clientsPerDay: 100, avgIncome: 30 },
              { id: "club", name: isEn ? "Night Club" : "Klub nocny", icon: "ğŸµ", startCost: 200000, clientsPerDay: 50, avgIncome: 40 },
              { id: "arcade", name: isEn ? "Arcade" : "Salon gier", icon: "ğŸ•¹ï¸", startCost: 80000, clientsPerDay: 40, avgIncome: 15 },
              { id: "escape", name: "Escape Room", icon: "ğŸ”", startCost: 50000, clientsPerDay: 6, avgIncome: 100 },
            ]
          },
          construction: {
            name: isEn ? "ğŸ—ï¸ Construction" : "ğŸ—ï¸ Budownictwo",
            types: [
              { id: "construction", name: isEn ? "Construction Company" : "Firma budowlana", icon: "ğŸ—ï¸", startCost: 250000, clientsPerDay: 2, avgIncome: 2000 },
              { id: "renovation", name: isEn ? "Renovation Company" : "Firma remontowa", icon: "ğŸ”¨", startCost: 80000, clientsPerDay: 4, avgIncome: 500 },
              { id: "architecture", name: isEn ? "Architecture Office" : "Biuro architektoniczne", icon: "ğŸ“", startCost: 120000, clientsPerDay: 3, avgIncome: 800 },
            ]
          }
        };
      }

      // Imiona pracownikÃ³w
      const WORKER_NAMES = {
        male: ["Adam", "Piotr", "Marcin", "Tomasz", "MichaÅ‚", "Krzysztof", "Jan", "PaweÅ‚", "Andrzej", "Marek", "Robert", "Kamil", "Åukasz", "Jakub", "Mateusz", "John", "Mike", "David", "James", "Robert"],
        female: ["Anna", "Maria", "Katarzyna", "Magdalena", "Agnieszka", "Joanna", "Monika", "Ewa", "Aleksandra", "Natalia", "Karolina", "Patrycja", "Justyna", "Dominika", "Weronika", "Sarah", "Emily", "Jessica", "Ashley", "Amanda"]
      };
      
      const WORKER_SURNAMES = ["Kowalski", "Nowak", "WiÅ›niewski", "WÃ³jcik", "Kowalczyk", "KamiÅ„ski", "Lewandowski", "ZieliÅ„ski", "SzymaÅ„ski", "WoÅºniak", "Smith", "Johnson", "Williams", "Brown", "Jones"];

      // Typy osobowoÅ›ci pracownikÃ³w z tÅ‚umaczeniami
      function getWorkerPersonalities() {
        const isEn = currentLang === 'en';
        return [
          { id: "ambitious", name: isEn ? "Ambitious" : "Ambitny", salaryMod: 1.3, productivityMod: 1.4, traits: isEn ? ["Wants promotion", "Works hard", "Demands more"] : ["Chce awansowaÄ‡", "Pracuje ciÄ™Å¼ko", "Wymaga wiÄ™cej"] },
          { id: "lazy", name: isEn ? "Lazy" : "Leniwy", salaryMod: 0.8, productivityMod: 0.6, traits: isEn ? ["Minimizes effort", "Cheap", "Slow"] : ["Minimalizuje wysiÅ‚ek", "Tani", "Wolny"] },
          { id: "friendly", name: isEn ? "Friendly" : "Przyjazny", salaryMod: 1.0, productivityMod: 1.0, traits: isEn ? ["Good atmosphere", "Likes clients", "Stable"] : ["Dobra atmosfera", "Lubi klientÃ³w", "Stabilny"] },
          { id: "perfectionist", name: isEn ? "Perfectionist" : "Perfekcjonista", salaryMod: 1.2, productivityMod: 1.3, traits: isEn ? ["High quality", "Slower", "Precise"] : ["Wysoka jakoÅ›Ä‡", "Wolniejszy", "DokÅ‚adny"] },
          { id: "experienced", name: isEn ? "Experienced" : "DoÅ›wiadczony", salaryMod: 1.5, productivityMod: 1.5, traits: isEn ? ["Very effective", "Expensive", "Reliable"] : ["Bardzo skuteczny", "Drogi", "Niezawodny"] },
          { id: "newbie", name: isEn ? "Newbie" : "PoczÄ…tkujÄ…cy", salaryMod: 0.6, productivityMod: 0.7, traits: isEn ? ["Cheap", "Learning", "Makes mistakes"] : ["Tani", "Uczy siÄ™", "PopeÅ‚nia bÅ‚Ä™dy"] },
        ];
      }

      // Pobierz przetÅ‚umaczonÄ… osobowoÅ›Ä‡ po ID
      function getTranslatedPersonality(personalityId) {
        const personalities = getWorkerPersonalities();
        return personalities.find(p => p.id === personalityId) || personalities[0];
      }

      // Pobierz przetÅ‚umaczone stanowisko po ID
      function getTranslatedPosition(positionId) {
        const positions = getWorkerPositions();
        return positions[positionId] || positions.regular;
      }

      // Stanowiska z tÅ‚umaczeniami
      function getWorkerPositions() {
        const isEn = currentLang === 'en';
        return {
          manager: { name: isEn ? "Manager" : "Kierownik", baseSalary: 800, required: true },
          senior: { name: isEn ? "Senior Worker" : "Starszy pracownik", baseSalary: 500 },
          regular: { name: isEn ? "Worker" : "Pracownik", baseSalary: 350 },
          junior: { name: isEn ? "Junior Worker" : "MÅ‚odszy pracownik", baseSalary: 250 },
          intern: { name: isEn ? "Intern" : "StaÅ¼ysta", baseSalary: 150 },
        };
      }

      // Generuj losowego pracownika
      function generateWorker(position = "regular") {
        const isMale = Math.random() > 0.5;
        const names = isMale ? WORKER_NAMES.male : WORKER_NAMES.female;
        const name = names[Math.floor(Math.random() * names.length)];
        let surname = WORKER_SURNAMES[Math.floor(Math.random() * WORKER_SURNAMES.length)];
        if (!isMale && surname.endsWith("ski")) surname = surname.slice(0, -1) + "a";
        if (!isMale && surname.endsWith("cki")) surname = surname.slice(0, -2) + "ka";
        
        const personalities = getWorkerPersonalities();
        const positions = getWorkerPositions();
        const personality = personalities[Math.floor(Math.random() * personalities.length)];
        const pos = positions[position];
        
        const expectedSalary = Math.floor(pos.baseSalary * personality.salaryMod * (0.9 + Math.random() * 0.3));
        const minSalary = Math.floor(expectedSalary * 0.7);
        const bonusPercent = Math.floor(5 + Math.random() * 20);
        
        return {
          id: Date.now() + Math.random().toString(36).substr(2, 9),
          name: `${name} ${surname}`,
          gender: isMale ? "male" : "female",
          position: position,
          positionName: pos.name,
          personality: personality,
          expectedSalary: expectedSalary,
          minSalary: minSalary,
          currentSalary: null,
          bonusPercent: bonusPercent,
          hired: false,
          productivity: personality.productivityMod,
          satisfaction: 100,
          daysWorked: 0,
          totalEarned: 0,
          chatHistory: [],
          negotiationState: "initial", // initial, negotiating, accepted, rejected
        };
      }

      // Generuj klienta dla firmy
      function generateClient(businessType) {
        const isMale = Math.random() > 0.5;
        const names = isMale ? WORKER_NAMES.male : WORKER_NAMES.female;
        const name = names[Math.floor(Math.random() * names.length)];
        
        const moods = ["happy", "neutral", "impatient", "demanding"];
        const mood = moods[Math.floor(Math.random() * moods.length)];
        
        return {
          id: Date.now() + Math.random().toString(36).substr(2, 9),
          name: name,
          gender: isMale ? "male" : "female",
          mood: mood,
          chatHistory: [],
          resolved: false,
          spending: 0,
        };
      }

      // Stan czatu z botem
      let currentBusinessChat = {
        type: null, // "worker" lub "client"
        businessId: null,
        targetId: null,
        awaitingInput: null,
      };

      // ========== GÅÃ“WNE FUNKCJE FIRM ==========
      
      function getBusinesses() {
        const save = getCurrentSave();
        if (!save) return [];
        const modeKey = gameMode === "reallife" ? "realLifeData" : "beamngData";
        if (!save[modeKey]) {
          save[modeKey] = {
            money: 1500, garage: [], spent: 0, debt: 0, debtDeadline: null,
            totalTaxPaid: 0, health: 100, food: 1000, water: 1000, backpack: [],
            activeInsurances: [], businesses: [], credits: [],
            workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
            vouchersToSend: [], receivedVouchers: []
          };
        }
        if (!save[modeKey].businesses) save[modeKey].businesses = [];
        return save[modeKey].businesses;
      }

      function saveBusinesses(businesses) {
        const save = getCurrentSave();
        if (!save) return;
        const modeKey = gameMode === "reallife" ? "realLifeData" : "beamngData";
        if (!save[modeKey]) save[modeKey] = {};
        save[modeKey].businesses = businesses;
        saveState();
      }

      function renderBusinessModal() {
        const content = document.getElementById("businessContent");
        const t = translations[currentLang] || translations.en;
        const businesses = getBusinesses();

        if (businesses.length === 0) {
          content.innerHTML = `
            <div style="text-align: center; padding: 30px;">
              <div style="font-size: 4em; margin-bottom: 15px;">ğŸ¢</div>
              <p style="color: #888; margin-bottom: 20px;">${t.noBusinesses}</p>
              <button onclick="showCreateBusiness()" style="padding: 15px 30px; background: linear-gradient(145deg, #f59e0b, #d97706); color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer;">
                ğŸ—ï¸ ${t.createBusiness}
              </button>
            </div>
          `;
          return;
        }

        let totalIncome = 0;
        let totalExpenses = 0;
        businesses.forEach(b => {
          totalIncome += b.weeklyIncome || 0;
          totalExpenses += b.weeklyExpenses || 0;
        });

        content.innerHTML = `
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: #888;">${t.totalIncomeWeek}:</span>
              <span style="color: #4ade80; font-weight: bold;">+${totalIncome.toLocaleString()} ${getCurrency()}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #888;">${t.totalExpensesWeek}:</span>
              <span style="color: #ef4444; font-weight: bold;">-${totalExpenses.toLocaleString()} ${getCurrency()}</span>
            </div>
            <div style="border-top: 1px solid #333; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
              <span style="color: #888;">${t.netProfitWeek}:</span>
              <span style="color: ${totalIncome - totalExpenses >= 0 ? '#4ade80' : '#ef4444'}; font-weight: bold;">
                ${(totalIncome - totalExpenses >= 0 ? '+' : '')}${(totalIncome - totalExpenses).toLocaleString()} ${getCurrency()}
              </span>
            </div>
          </div>

          <div style="max-height: 300px; overflow-y: auto;">
            ${businesses.map((b, i) => `
              <div onclick="showBusinessDetail(${i})" style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" 
                   onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1em; font-weight: bold;">${b.icon} ${b.name}</div>
                    <div style="color: #888; font-size: 0.85em;">${b.typeName}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #4ade80;">+${(b.weeklyIncome || 0).toLocaleString()}/${currentLang === 'en' ? 'wk' : 'tyg'}</div>
                    <div style="color: #888; font-size: 0.85em;">ğŸ‘¥ ${b.workers?.filter(w => w.hired).length || 0} ${t.workers}</div>
                  </div>
                </div>
              </div>
            `).join("")}
          </div>

          <button onclick="showCreateBusiness()" style="width: 100%; padding: 15px; background: linear-gradient(145deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; margin-top: 15px;">
            â• ${t.createNextBusiness}
          </button>
        `;
      }

      function showCreateBusiness() {
        closeModal("business");
        openModal("createBusiness");
        renderCreateBusinessStep1();
      }

      function renderCreateBusinessStep1() {
        const content = document.getElementById("createBusinessContent");
        const t = translations[currentLang] || translations.en;

        content.innerHTML = `
          <p style="color: #888; margin-bottom: 15px; text-align: center;">${t.selectCategory}:</p>
          <div style="max-height: 400px; overflow-y: auto;">
            ${Object.entries(getBusinessCategories()).map(([catId, cat]) => `
              <div onclick="renderCreateBusinessStep2('${catId}')" style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                   onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                <div style="font-size: 1.1em; font-weight: bold;">${cat.name}</div>
                <div style="color: #888; font-size: 0.85em;">${cat.types.length} ${t.businessTypes}</div>
              </div>
            `).join("")}
          </div>
          <button onclick="closeModal('createBusiness'); openModal('business');" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer;">
            â† ${t.back}
          </button>
        `;
      }

      function renderCreateBusinessStep2(categoryId) {
        const content = document.getElementById("createBusinessContent");
        const category = getBusinessCategories()[categoryId];
        const t = translations[currentLang] || translations.en;

        content.innerHTML = `
          <p style="color: #888; margin-bottom: 15px; text-align: center;">${category.name} - ${t.selectType}:</p>
          <div style="max-height: 400px; overflow-y: auto;">
            ${category.types.map(type => `
              <div onclick="renderCreateBusinessStep3('${categoryId}', '${type.id}')" style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                   onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1em; font-weight: bold;">${type.icon} ${type.name}</div>
                    <div style="color: #888; font-size: 0.85em;">~${type.clientsPerDay} ${t.clientsPerDay}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #f59e0b; font-weight: bold;">${type.startCost.toLocaleString()} ${getCurrency()}</div>
                    <div style="color: #4ade80; font-size: 0.85em;">~${type.avgIncome} ${getCurrency()}/${currentLang === 'en' ? 'client' : 'klient'}</div>
                  </div>
                </div>
              </div>
            `).join("")}
          </div>
          <button onclick="renderCreateBusinessStep1()" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer;">
            â† ${t.backToCategories}
          </button>
        `;
      }

      function renderCreateBusinessStep3(categoryId, typeId) {
        const content = document.getElementById("createBusinessContent");
        const category = getBusinessCategories()[categoryId];
        const type = category.types.find(tp => tp.id === typeId);
        const t = translations[currentLang] || translations.en;

        const canAfford = money >= type.startCost;

        content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em;">${type.icon}</div>
            <div style="font-size: 1.3em; font-weight: bold; margin-top: 10px;">${type.name}</div>
          </div>

          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: #888;">${t.startCost}:</span>
              <span style="color: #f59e0b; font-weight: bold;">${type.startCost.toLocaleString()} ${getCurrency()}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: #888;">${t.clientsPerDay}:</span>
              <span>~${type.clientsPerDay}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #888;">${t.avgIncomeClient}:</span>
              <span style="color: #4ade80;">~${type.avgIncome} ${getCurrency()}</span>
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="color: #888; font-size: 0.9em;">${t.businessName}:</label>
            <input type="text" id="newBusinessName" placeholder="${type.name}" maxlength="30" 
                   style="width: 100%; padding: 12px; background: #1a1a2e; border: 2px solid #333; border-radius: 8px; color: white; margin-top: 5px; font-size: 1em;">
          </div>

          ${!canAfford ? `
            <div style="background: rgba(239,68,68,0.2); border: 1px solid #ef4444; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
              <span style="color: #ef4444;">âŒ ${t.notEnoughMoneyBusiness}</span>
              <div style="color: #888; font-size: 0.85em; margin-top: 5px;">${t.youNeed}: ${type.startCost.toLocaleString()} ${getCurrency()}</div>
            </div>
          ` : ''}

          <button onclick="createBusiness('${categoryId}', '${typeId}')" ${!canAfford ? 'disabled' : ''} 
                  style="width: 100%; padding: 15px; background: ${canAfford ? 'linear-gradient(145deg, #10b981, #059669)' : '#333'}; color: white; border: none; border-radius: 10px; font-size: 1em; cursor: ${canAfford ? 'pointer' : 'not-allowed'};">
            ğŸ—ï¸ ${t.createBusinessFor} ${type.startCost.toLocaleString()} ${getCurrency()}
          </button>

          <button onclick="renderCreateBusinessStep2('${categoryId}')" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer;">
            â† ${t.back}
          </button>
        `;
      }

      function createBusiness(categoryId, typeId) {
        const category = getBusinessCategories()[categoryId];
        const type = category.types.find(tp => tp.id === typeId);
        const nameInput = document.getElementById("newBusinessName");
        const name = nameInput?.value.trim() || type.name;
        const t = translations[currentLang] || translations.en;

        if (money < type.startCost) {
          showToast("âŒ " + t.notEnoughMoneyBusiness);
          return;
        }

        money -= type.startCost;

        // Generuj poczÄ…tkowych kandydatÃ³w na pracownikÃ³w
        const candidates = [];
        candidates.push(generateWorker("manager")); // Zawsze jeden kierownik
        for (let i = 0; i < 3; i++) {
          candidates.push(generateWorker("regular"));
        }
        for (let i = 0; i < 2; i++) {
          candidates.push(generateWorker("junior"));
        }

        const newBusiness = {
          id: Date.now().toString(),
          name: name,
          categoryId: categoryId,
          typeId: typeId,
          typeName: type.name,
          icon: type.icon,
          startCost: type.startCost,
          clientsPerDay: type.clientsPerDay,
          avgIncome: type.avgIncome,
          special: type.special || null,
          createdAt: Date.now(),
          workers: candidates,
          clients: [],
          weeklyIncome: 0,
          weeklyExpenses: 0,
          totalIncome: 0,
          totalExpenses: 0,
          lastPaymentTime: Date.now(),
          reputation: 50, // 0-100
          insurances: [], // Dla firm ubezpieczeniowych
        };

        const businesses = getBusinesses();
        businesses.push(newBusiness);
        saveBusinesses(businesses);
        saveState();
        updateAllDisplays();

        closeModal("createBusiness");
        openModal("business");
        renderBusinessModal();
        showToast(`ğŸ¢ ${t.businessCreated}: ${name}!`);
      }

      function showBusinessDetail(index) {
        const businesses = getBusinesses();
        const business = businesses[index];
        if (!business) return;

        closeModal("business");
        openModal("businessDetail");
        renderBusinessDetail(index);
      }

      function renderBusinessDetail(index) {
        const content = document.getElementById("businessDetailContent");
        const businesses = getBusinesses();
        const business = businesses[index];
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';

        const hiredWorkers = business.workers.filter(w => w.hired);
        const candidateWorkers = business.workers.filter(w => !w.hired);
        const weeklyProfit = (business.weeklyIncome || 0) - (business.weeklyExpenses || 0);

        content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 2.5em;">${business.icon}</div>
            <h2 style="color: #ff6b35; margin-top: 10px;">${business.name}</h2>
            <div style="color: #888;">${business.typeName}</div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
            <div style="background: rgba(74,222,128,0.1); border: 1px solid #4ade80; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="color: #4ade80; font-size: 1.3em; font-weight: bold;">+${(business.weeklyIncome || 0).toLocaleString()}</div>
              <div style="color: #888; font-size: 0.8em;">${isEn ? 'income/week' : 'przychÃ³d/tydzieÅ„'}</div>
            </div>
            <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="color: #ef4444; font-size: 1.3em; font-weight: bold;">-${(business.weeklyExpenses || 0).toLocaleString()}</div>
              <div style="color: #888; font-size: 0.8em;">${isEn ? 'expenses/week' : 'wydatki/tydzieÅ„'}</div>
            </div>
          </div>

          <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>${t.netProfitWeek}:</span>
              <span style="color: ${weeklyProfit >= 0 ? '#4ade80' : '#ef4444'}; font-weight: bold; font-size: 1.2em;">
                ${weeklyProfit >= 0 ? '+' : ''}${weeklyProfit.toLocaleString()} ${getCurrency()}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
              <span style="color: #888;">${t.reputation}:</span>
              <span>${'â­'.repeat(Math.floor(business.reputation / 20))} ${business.reputation}%</span>
            </div>
            ${hiredWorkers.length > 0 ? (() => {
              const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
              const nextPay = (business.lastPaymentTime || Date.now()) + WEEK_MS;
              const remaining = nextPay - Date.now();
              let timeStr = isEn ? "Now!" : "Teraz!";
              if (remaining > 0) {
                const days = Math.floor(remaining / (24 * 60 * 60 * 1000));
                const hours = Math.floor((remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                timeStr = days > 0 ? days + "d " + hours + "h" : hours + "h";
              }
              return `
              <div style="border-top: 1px solid #333; margin-top: 10px; padding-top: 10px;">
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: #888;">ğŸ’° ${isEn ? "Next payday" : "NastÄ™pna wypÅ‚ata"}:</span>
                  <span style="color: #ef4444;">${timeStr} (-${business.weeklyExpenses || 0} ${getCurrency()})</span>
                </div>
              </div>`;
            })() : ''}
          </div>

          <h3 style="color: #f59e0b; margin: 20px 0 10px;">ğŸ‘¥ ${t.hiredWorkers} (${hiredWorkers.length})</h3>
          ${hiredWorkers.length === 0 ? `
            <p style="color: #666; text-align: center; padding: 15px;">${t.noWorkersYet}</p>
          ` : `
            <div style="max-height: 150px; overflow-y: auto;">
              ${hiredWorkers.map(w => {
                const translatedPersonality = getTranslatedPersonality(w.personality.id);
                const translatedPosition = getTranslatedPosition(w.position);
                return `
                <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-weight: bold;">${w.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'} ${w.name}</div>
                    <div style="color: #888; font-size: 0.85em;">${translatedPosition.name} â€¢ ${translatedPersonality.name}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #ef4444;">${w.currentSalary}/${isEn ? 'wk' : 'tyg'}</div>
                    <button onclick="talkToWorker(${index}, '${w.id}')" style="padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; font-size: 0.8em; cursor: pointer; margin-top: 5px;">ğŸ’¬</button>
                    <button onclick="fireWorker(${index}, '${w.id}')" style="padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 5px; font-size: 0.8em; cursor: pointer; margin-top: 5px;">ğŸš«</button>
                  </div>
                </div>
              `}).join("")}
            </div>
          `}

          <h3 style="color: #10b981; margin: 20px 0 10px;">ğŸ†• ${t.candidates} (${candidateWorkers.length})</h3>
          ${candidateWorkers.length === 0 ? `
            <p style="color: #666; text-align: center; padding: 15px;">${t.noCandidates}</p>
            <p style="color: #888; text-align: center; font-size: 0.85em;">
              ${isEn ? "New candidates appear every 5 minutes" : "Nowi kandydaci pojawiajÄ… siÄ™ co 5 minut"}
            </p>
          ` : `
            <div style="max-height: 200px; overflow-y: auto;">
              ${candidateWorkers.map(w => {
                const translatedPersonality = getTranslatedPersonality(w.personality.id);
                const translatedPosition = getTranslatedPosition(w.position);
                return `
                <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-weight: bold;">${w.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'} ${w.name}</div>
                      <div style="color: #888; font-size: 0.85em;">${translatedPosition.name}</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="color: #f59e0b;">${translatedPersonality.name}</div>
                      <div style="color: #888; font-size: 0.8em;">${t.expects}: ~${w.expectedSalary}/${isEn ? 'wk' : 'tyg'}</div>
                    </div>
                  </div>
                  <div style="color: #666; font-size: 0.8em; margin-top: 5px;">
                    ${translatedPersonality.traits.join(" â€¢ ")}
                  </div>
                  <button onclick="negotiateWithWorker(${index}, '${w.id}')" style="width: 100%; padding: 10px; background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                    ğŸ’¬ ${t.negotiateTerms}
                  </button>
                </div>
              `}).join("")}
            </div>
          `}

          ${business.clients && business.clients.length > 0 ? `
            <h3 style="color: #8b5cf6; margin: 20px 0 10px;">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ${t.activeClients} (${business.clients.length})</h3>
            <div style="max-height: 150px; overflow-y: auto;">
              ${business.clients.map(c => `
                <div onclick="talkToClient(${index}, '${c.id}')" style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div>${c.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'} ${c.name}</div>
                    <div style="color: #888; font-size: 0.85em;">${c.mood === 'happy' ? 'ğŸ˜Š' : c.mood === 'impatient' ? 'ğŸ˜¤' : c.mood === 'demanding' ? 'ğŸ˜ ' : 'ğŸ˜'} ${c.mood}</div>
                  </div>
                  <button style="padding: 8px 15px; background: #8b5cf6; color: white; border: none; border-radius: 6px;">ğŸ’¬ ${t.serve}</button>
                </div>
              `).join("")}
            </div>
          ` : ''}

          ${(() => {
            // Info o nastÄ™pnym dniu roboczym
            const lastDayTime = business.lastDayProcessed || Date.now();
            const DAY_MS = 24 * 60 * 60 * 1000; // 24h w rzeczywistoÅ›ci
            const nextDay = lastDayTime + DAY_MS;
            const remaining = nextDay - Date.now();
            let timeStr = isEn ? "Processing..." : "Przetwarzanie...";
            if (remaining > 0) {
              const hours = Math.floor(remaining / (60 * 60 * 1000));
              const mins = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
              timeStr = hours + "h " + mins + "min";
            }
            return `
              <div style="background: rgba(139,92,246,0.1); border: 1px solid #8b5cf6; padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <div style="color: #8b5cf6; font-weight: bold;">ğŸ“… ${isEn ? "Next work day in" : "NastÄ™pny dzieÅ„ roboczy za"}:</div>
                <div style="font-size: 1.3em; margin-top: 5px;">${timeStr}</div>
                <div style="color: #666; font-size: 0.8em; margin-top: 5px;">${isEn ? "Days pass automatically every 24h" : "Dni mijajÄ… automatycznie co 24h"}</div>
              </div>
            `;
          })()}

          <button onclick="closeBusiness(${index})" style="width: 100%; padding: 12px; background: #333; color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; cursor: pointer; margin-top: 10px;">
            ğŸ—‘ï¸ ${t.closeBusiness}
          </button>

          <button onclick="closeModal('businessDetail'); openModal('business'); renderBusinessModal();" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
            â† ${t.backToList}
          </button>
        `;
      }

      function generateNewCandidates(businessIndex) {
        const t = translations[currentLang] || translations.en;
        if (money < 500) {
          showToast("âŒ " + t.needForRecruitment + " 500 " + getCurrency() + "!");
          return;
        }
        money -= 500;
        
        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        
        // UsuÅ„ nieprzyjÄ™tych kandydatÃ³w
        business.workers = business.workers.filter(w => w.hired);
        
        // Dodaj nowych
        const positions = ["manager", "senior", "regular", "regular", "junior", "junior", "intern"];
        for (let i = 0; i < 4; i++) {
          const pos = positions[Math.floor(Math.random() * positions.length)];
          business.workers.push(generateWorker(pos));
        }
        
        saveBusinesses(businesses);
        saveState();
        updateAllDisplays();
        renderBusinessDetail(businessIndex);
        showToast("ğŸ”„ " + t.foundCandidates);
      }

      // ========== SYSTEM CZATU Z AI (PRACOWNICY/KLIENCI) ==========

      function negotiateWithWorker(businessIndex, workerId) {
        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        const worker = business.workers.find(w => w.id === workerId);
        if (!worker) return;
        const t = translations[currentLang] || translations.en;

        currentBusinessChat = {
          type: "worker_negotiate",
          businessId: businessIndex,
          targetId: workerId,
          awaitingInput: null,
        };

        closeModal("businessDetail");
        openModal("businessChat");
        
        document.getElementById("businessChatTitle").textContent = `ğŸ’¬ ${t.chatWith} ${worker.name}`;
        
        // Reset historii czatu dla nowej negocjacji
        worker.chatHistory = [];
        worker.negotiationState = "initial";
        
        continueWorkerNegotiation(businessIndex, workerId);
      }

      function continueWorkerNegotiation(businessIndex, workerId) {
        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        const worker = business.workers.find(w => w.id === workerId);
        if (!worker) return;
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';

        const messagesDiv = document.getElementById("businessChatMessages");
        const optionsDiv = document.getElementById("businessChatOptions");
        const inputDiv = document.getElementById("businessChatInput");

        // Renderuj historiÄ™
        messagesDiv.innerHTML = worker.chatHistory.map(msg => `
          <div style="margin-bottom: 12px; ${msg.from === 'player' ? 'text-align: right;' : ''}">
            <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: ${msg.from === 'player' ? '#3b82f6' : '#333'};">
              ${msg.text}
            </div>
          </div>
        `).join("");
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        inputDiv.style.display = "none";
        optionsDiv.innerHTML = "";

        // JeÅ›li juÅ¼ zatrudniony lub odrzucony - pokaÅ¼ tylko przycisk powrotu
        if (worker.negotiationState === "accepted" || worker.negotiationState === "rejected") {
          optionsDiv.innerHTML = `
            <button onclick="closeModal('businessChat'); openModal('businessDetail'); renderBusinessDetail(${businessIndex});" style="padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
              â† ${t.backToBusinessBtn}
            </button>
          `;
          return;
        }

        // Stan negocjacji
        if (worker.negotiationState === "initial") {
          // Pierwsze powitanie pracownika
          const greetings = [
            t.greeting1.replace("{name}", worker.name).replace("{position}", worker.positionName.toLowerCase()),
            t.greeting2.replace("{name}", worker.name),
            t.greeting3.replace("{name}", worker.name).replace("{position}", worker.positionName.toLowerCase()),
          ];
          
          if (worker.chatHistory.length === 0) {
            worker.chatHistory.push({
              from: "worker",
              text: greetings[Math.floor(Math.random() * greetings.length)]
            });
            worker.chatHistory.push({
              from: "worker", 
              text: t.salaryExpectation.replace("{salary}", worker.expectedSalary).replace("{currency}", getCurrency()).replace("{bonus}", worker.bonusPercent)
            });
            saveBusinesses(businesses);
            
            // OdÅ›wieÅ¼ wiadomoÅ›ci
            messagesDiv.innerHTML = worker.chatHistory.map(msg => `
              <div style="margin-bottom: 12px; ${msg.from === 'player' ? 'text-align: right;' : ''}">
                <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: ${msg.from === 'player' ? '#3b82f6' : '#333'};">
                  ${msg.text}
                </div>
              </div>
            `).join("");
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }

          // Opcje odpowiedzi - zawsze dostÄ™pne
          optionsDiv.innerHTML = `
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'accept')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
              âœ… ${t.acceptTermsBtn} (${worker.expectedSalary}/${isEn ? 'wk' : 'tyg'} + ${worker.bonusPercent}%)
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'counter_salary')" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ğŸ’° ${isEn ? "Propose different salary" : "Zaproponuj innÄ… pensjÄ™"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'counter_bonus')" style="padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ğŸ“Š ${isEn ? "Propose different commission" : "Zaproponuj innÄ… prowizjÄ™"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">
              âŒ ${t.rejectBtn}
            </button>
          `;
          
        } else if (worker.negotiationState === "awaiting_salary") {
          inputDiv.style.display = "block";
          document.getElementById("businessChatInputField").placeholder = isEn ? "Enter weekly salary..." : "Wpisz tygodniÃ³wkÄ™...";
          document.getElementById("businessChatInputField").value = "";
          currentBusinessChat.awaitingInput = "salary_offer";
          
          optionsDiv.innerHTML = `
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'back')" style="padding: 10px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
              â† ${isEn ? "Back to options" : "WrÃ³Ä‡ do opcji"}
            </button>
          `;
          
        } else if (worker.negotiationState === "awaiting_bonus") {
          inputDiv.style.display = "block";
          document.getElementById("businessChatInputField").placeholder = isEn ? "Enter commission % (e.g. 5)..." : "Wpisz prowizjÄ™ % (np. 5)...";
          document.getElementById("businessChatInputField").value = "";
          currentBusinessChat.awaitingInput = "bonus_offer";
          
          optionsDiv.innerHTML = `
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'back')" style="padding: 10px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
              â† ${isEn ? "Back to options" : "WrÃ³Ä‡ do opcji"}
            </button>
          `;
          
        } else if (worker.negotiationState === "final_offer") {
          // Pracownik daÅ‚ ostatecznÄ… ofertÄ™
          optionsDiv.innerHTML = `
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'accept_final')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
              âœ… ${isEn ? "Accept final offer" : "Akceptuj ostatecznÄ… ofertÄ™"} (${worker.expectedSalary}/${isEn ? 'wk' : 'tyg'} + ${worker.bonusPercent}%)
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'counter_salary')" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ğŸ’° ${isEn ? "Try different salary" : "SprÃ³buj innÄ… pensjÄ™"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">
              âŒ ${t.rejectBtn}
            </button>
          `;
          
        } else if (worker.negotiationState === "awaiting_offer") {
          // KompatybilnoÅ›Ä‡ wsteczna
          inputDiv.style.display = "block";
          document.getElementById("businessChatInputField").placeholder = t.enterSalaryPrompt;
          currentBusinessChat.awaitingInput = "salary_offer";
        }
      }

      function respondToWorker(businessIndex, workerId, response) {
        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        const worker = business.workers.find(w => w.id === workerId);
        if (!worker) return;
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';

        if (response === "accept" || response === "accept_final") {
          worker.chatHistory.push({ from: "player", text: t.acceptMsg.replace("{salary}", worker.expectedSalary).replace("{currency}", getCurrency()).replace("{bonus}", worker.bonusPercent) });
          worker.chatHistory.push({ from: "worker", text: t.workerAcceptMsg });
          worker.chatHistory.push({ from: "player", text: t.startNowMsg });
          worker.chatHistory.push({ from: "worker", text: t.workerThanksMsg });
          
          worker.hired = true;
          worker.currentSalary = worker.expectedSalary;
          worker.negotiationState = "accepted";
          
          recalculateBusinessExpenses(businessIndex);
          saveBusinesses(businesses);
          saveState();
          
          showToast(`âœ… ${t.hired} ${worker.name}!`);
          
        } else if (response === "counter_salary") {
          worker.chatHistory.push({ from: "player", text: isEn ? "I'd like to propose a different salary..." : "ChciaÅ‚bym zaproponowaÄ‡ innÄ… pensjÄ™..." });
          worker.negotiationState = "awaiting_salary";
          saveBusinesses(businesses);
          
        } else if (response === "counter_bonus") {
          worker.chatHistory.push({ from: "player", text: isEn ? "Let's discuss the commission rate..." : "Porozmawiajmy o wysokoÅ›ci prowizji..." });
          worker.negotiationState = "awaiting_bonus";
          saveBusinesses(businesses);
          
        } else if (response === "back") {
          worker.negotiationState = "initial";
          saveBusinesses(businesses);
          
        } else if (response === "reject") {
          worker.chatHistory.push({ from: "player", text: t.rejectMsg });
          worker.chatHistory.push({ from: "worker", text: t.workerUnderstandMsg });
          worker.negotiationState = "rejected";
          
          // UsuÅ„ kandydata
          business.workers = business.workers.filter(w => w.id !== workerId);
          saveBusinesses(businesses);
          
          setTimeout(() => {
            closeModal("businessChat");
            openModal("businessDetail");
            renderBusinessDetail(businessIndex);
          }, 1500);
        }

        continueWorkerNegotiation(businessIndex, workerId);
      }

      function sendBusinessChatInput() {
        const input = document.getElementById("businessChatInputField");
        const value = input.value.trim();
        if (!value) return;
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';

        const { businessId, targetId, awaitingInput } = currentBusinessChat;
        const businesses = getBusinesses();
        const business = businesses[businessId];
        const worker = business.workers.find(w => w.id === targetId);
        if (!worker) return;

        if (awaitingInput === "salary_offer") {
          const offer = parseInt(value);
          if (isNaN(offer) || offer <= 0) {
            showToast(isEn ? "âŒ Enter a valid amount!" : "âŒ Wpisz prawidÅ‚owÄ… kwotÄ™!");
            return;
          }

          worker.chatHistory.push({ from: "player", text: (isEn ? "I propose " : "ProponujÄ™ ") + offer + " " + getCurrency() + (isEn ? " weekly." : " tygodniowo.") });

          // Reakcja pracownika
          if (offer >= worker.expectedSalary) {
            worker.chatHistory.push({ from: "worker", text: t.workerGreatOffer });
            worker.expectedSalary = offer;
            worker.hired = true;
            worker.currentSalary = offer;
            worker.negotiationState = "accepted";
            recalculateBusinessExpenses(businessId);
            saveBusinesses(businesses);
            saveState();
            showToast(`âœ… ${t.hired} ${worker.name}!`);
          } else if (offer >= worker.minSalary) {
            const diff = worker.expectedSalary - offer;
            if (diff < 50) {
              worker.chatHistory.push({ from: "worker", text: t.workerAcceptLower });
              worker.expectedSalary = offer;
              worker.hired = true;
              worker.currentSalary = offer;
              worker.negotiationState = "accepted";
              recalculateBusinessExpenses(businessId);
              saveBusinesses(businesses);
              saveState();
              showToast(`âœ… ${t.hired} ${worker.name}!`);
            } else {
              const counter = Math.floor((offer + worker.expectedSalary) / 2);
              worker.chatHistory.push({ from: "worker", text: t.workerCounterOffer.replace("{counter}", counter).replace("{currency}", getCurrency()) });
              worker.expectedSalary = counter;
              worker.negotiationState = "initial";
              saveBusinesses(businesses);
            }
          } else {
            worker.chatHistory.push({ from: "worker", text: t.workerTooLow.replace("{min}", worker.minSalary).replace("{currency}", getCurrency()) });
            worker.negotiationState = "initial";
            saveBusinesses(businesses);
          }

          input.value = "";
          currentBusinessChat.awaitingInput = null;
          continueWorkerNegotiation(businessId, targetId);
          
        } else if (awaitingInput === "bonus_offer") {
          const bonusOffer = parseInt(value);
          if (isNaN(bonusOffer) || bonusOffer < 0 || bonusOffer > 50) {
            showToast(isEn ? "âŒ Enter valid % (0-50)!" : "âŒ Wpisz poprawny % (0-50)!");
            return;
          }

          worker.chatHistory.push({ from: "player", text: (isEn ? "How about " : "Co powiesz na ") + bonusOffer + (isEn ? "% commission?" : "% prowizji?") });

          // Reakcja pracownika na prowizjÄ™
          const expectedBonus = worker.bonusPercent;
          if (bonusOffer >= expectedBonus) {
            worker.chatHistory.push({ from: "worker", text: isEn ? "That works for me!" : "To mi odpowiada!" });
            worker.bonusPercent = bonusOffer;
            worker.negotiationState = "initial";
            saveBusinesses(businesses);
          } else if (bonusOffer >= expectedBonus * 0.5) {
            // Akceptuje jeÅ›li minimum poÅ‚owa oczekiwanej
            const newSalary = Math.floor(worker.expectedSalary * (1 + (expectedBonus - bonusOffer) * 0.02));
            worker.chatHistory.push({ from: "worker", text: (isEn ? "I can accept " : "MogÄ™ zaakceptowaÄ‡ ") + bonusOffer + (isEn ? "%, but I'd need " : "%, ale potrzebowaÅ‚bym ") + newSalary + " " + getCurrency() + (isEn ? " base salary then." : " podstawy wtedy.") });
            worker.bonusPercent = bonusOffer;
            worker.expectedSalary = newSalary;
            worker.negotiationState = "initial";
            saveBusinesses(businesses);
          } else {
            worker.chatHistory.push({ from: "worker", text: (isEn ? "That's too low. I need at least " : "To za maÅ‚o. PotrzebujÄ™ minimum ") + Math.floor(expectedBonus * 0.7) + "%." });
            worker.negotiationState = "initial";
            saveBusinesses(businesses);
          }

          input.value = "";
          currentBusinessChat.awaitingInput = null;
          continueWorkerNegotiation(businessId, targetId);
        }
      }

      function talkToWorker(businessIndex, workerId) {
        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        const worker = business.workers.find(w => w.id === workerId);
        if (!worker || !worker.hired) return;

        currentBusinessChat = {
          type: "worker_talk",
          businessId: businessIndex,
          targetId: workerId,
          awaitingInput: null,
        };

        closeModal("businessDetail");
        openModal("businessChat");
        
        document.getElementById("businessChatTitle").textContent = `ğŸ’¬ Rozmowa z ${worker.name}`;
        
        const messagesDiv = document.getElementById("businessChatMessages");
        const optionsDiv = document.getElementById("businessChatOptions");

        const satisfaction = worker.satisfaction || 100;
        const satEmoji = satisfaction > 70 ? "ğŸ˜Š" : satisfaction > 40 ? "ğŸ˜" : "ğŸ˜";
        
        messagesDiv.innerHTML = `
          <div style="margin-bottom: 12px;">
            <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: #333;">
              ${satEmoji} CzeÅ›Ä‡ szefie! W czym mogÄ™ pomÃ³c?
            </div>
          </div>
          <div style="margin-bottom: 12px;">
            <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: #333;">
              Moje obecne warunki: ${worker.currentSalary} ${getCurrency()}/tyg + ${worker.bonusPercent}% prowizji.
              <br>Satysfakcja: ${satisfaction}%
            </div>
          </div>
        `;

        optionsDiv.innerHTML = `
          <button onclick="giveRaise(${businessIndex}, '${workerId}')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
            ğŸ’° Daj podwyÅ¼kÄ™ (+10%)
          </button>
          <button onclick="closeModal('businessChat'); openModal('businessDetail'); renderBusinessDetail(${businessIndex});" style="padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
            â† WrÃ³Ä‡
          </button>
        `;
      }

      function giveRaise(businessIndex, workerId) {
        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        const worker = business.workers.find(w => w.id === workerId);
        if (!worker) return;

        worker.currentSalary = Math.floor(worker.currentSalary * 1.1);
        worker.satisfaction = Math.min(100, (worker.satisfaction || 100) + 15);
        
        recalculateBusinessExpenses(businessIndex);
        saveBusinesses(businesses);
        saveState();

        showToast(`ğŸ’° ${worker.name} dostaÅ‚ podwyÅ¼kÄ™ do ${worker.currentSalary}/tyg!`);
        closeModal("businessChat");
        openModal("businessDetail");
        renderBusinessDetail(businessIndex);
      }

      function fireWorker(businessIndex, workerId) {
        if (!confirm("Na pewno zwolniÄ‡ tego pracownika?")) return;

        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        business.workers = business.workers.filter(w => w.id !== workerId);
        
        recalculateBusinessExpenses(businessIndex);
        saveBusinesses(businesses);
        saveState();
        
        renderBusinessDetail(businessIndex);
        showToast("ğŸš« " + (translations[currentLang] || translations.en).workerFired);
      }

      function recalculateBusinessExpenses(businessIndex) {
        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        
        let weeklyExpenses = 0;
        business.workers.filter(w => w.hired).forEach(w => {
          weeklyExpenses += w.currentSalary || 0;
        });
        
        business.weeklyExpenses = weeklyExpenses;
        saveBusinesses(businesses);
      }

      function simulateBusinessDay(businessIndex) {
        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';
        
        const hiredWorkers = business.workers.filter(w => w.hired);
        if (hiredWorkers.length === 0) {
          showToast("âŒ " + t.needWorkers);
          return;
        }

        // Oblicz produktywnoÅ›Ä‡
        let totalProductivity = 0;
        hiredWorkers.forEach(w => {
          totalProductivity += w.productivity || 1;
        });
        const avgProductivity = totalProductivity / hiredWorkers.length;

        // Symuluj klientÃ³w
        const clientCount = Math.floor(business.clientsPerDay * avgProductivity * (0.7 + Math.random() * 0.6));
        let dayIncome = 0;
        
        for (let i = 0; i < clientCount; i++) {
          const clientSpend = Math.floor(business.avgIncome * (0.5 + Math.random()));
          dayIncome += clientSpend;
        }

        // Oblicz prowizje dla pracownikÃ³w
        let bonusesPaid = 0;
        const workerReports = [];
        hiredWorkers.forEach(w => {
          const workerBonus = Math.floor(dayIncome * (w.bonusPercent / 100) / hiredWorkers.length);
          bonusesPaid += workerBonus;
          w.totalEarned = (w.totalEarned || 0) + workerBonus;
          w.daysWorked = (w.daysWorked || 0) + 1;
          workerReports.push({
            name: w.name,
            bonus: workerBonus,
            productivity: Math.round((w.productivity || 1) * 100)
          });
        });

        // RACHUNKI - zaleÅ¼ne od wielkoÅ›ci firmy
        const electricityCost = Math.floor(50 + business.clientsPerDay * 3 + Math.random() * 30);
        const waterCost = Math.floor(20 + business.clientsPerDay * 1.5 + Math.random() * 15);
        const gasCost = Math.floor(30 + business.clientsPerDay * 2 + Math.random() * 20);
        const internetCost = 50;
        const rentCost = Math.floor(business.startCost * 0.002); // 0.2% kosztu startu dziennie
        const totalBills = electricityCost + waterCost + gasCost + internetCost + rentCost;

        const netIncome = dayIncome - bonusesPaid - totalBills;
        business.weeklyIncome = (business.weeklyIncome || 0) + netIncome;
        business.totalIncome = (business.totalIncome || 0) + dayIncome;
        business.totalExpenses = (business.totalExpenses || 0) + totalBills + bonusesPaid;

        // Dodaj do pieniÄ™dzy gracza
        money += netIncome;

        saveBusinesses(businesses);
        saveState();
        updateAllDisplays();

        // PokaÅ¼ modal z paragonem
        showDayReport({
          businessName: business.name,
          clients: clientCount,
          income: dayIncome,
          workers: workerReports,
          bonusesPaid: bonusesPaid,
          bills: {
            electricity: electricityCost,
            water: waterCost,
            gas: gasCost,
            internet: internetCost,
            rent: rentCost,
            total: totalBills
          },
          netIncome: netIncome,
          businessIndex: businessIndex
        });
      }

      function showDayReport(report) {
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';
        
        // StwÃ³rz modal raportu
        let modal = document.getElementById("modalDayReport");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "modalDayReport";
          modal.className = "modal";
          modal.innerHTML = `<div class="modal-content" style="max-width: 400px;"><div id="dayReportContent"></div></div>`;
          document.body.appendChild(modal);
        }
        
        const content = document.getElementById("dayReportContent");
        content.innerHTML = `
          <div style="background: #1a1a2e; border-radius: 10px; padding: 20px; font-family: 'Courier New', monospace;">
            <div style="text-align: center; border-bottom: 2px dashed #444; padding-bottom: 15px; margin-bottom: 15px;">
              <div style="font-size: 1.5em; font-weight: bold;">ğŸ§¾ ${isEn ? "DAILY REPORT" : "RAPORT DZIENNY"}</div>
              <div style="color: #888; margin-top: 5px;">${report.businessName}</div>
              <div style="color: #666; font-size: 0.85em;">${new Date().toLocaleDateString()}</div>
            </div>
            
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #4ade80; font-weight: bold; margin-bottom: 8px;">ğŸ“ˆ ${isEn ? "INCOME" : "PRZYCHÃ“D"}</div>
              <div style="display: flex; justify-content: space-between;">
                <span>ğŸ‘¥ ${isEn ? "Clients" : "Klienci"}: ${report.clients}</span>
                <span style="color: #4ade80;">+${report.income.toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #f59e0b; font-weight: bold; margin-bottom: 8px;">ğŸ‘· ${isEn ? "WORKERS" : "PRACOWNICY"}</div>
              ${report.workers.map(w => `
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 3px;">
                  <span>${w.name} (${w.productivity}%)</span>
                  <span style="color: #ef4444;">-${w.bonus} ${getCurrency()}</span>
                </div>
              `).join("")}
              <div style="display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold;">
                <span>${isEn ? "Commissions total" : "Prowizje razem"}:</span>
                <span style="color: #ef4444;">-${report.bonusesPaid.toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #ef4444; font-weight: bold; margin-bottom: 8px;">ğŸ“‹ ${isEn ? "BILLS" : "RACHUNKI"}</div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>âš¡ ${isEn ? "Electricity" : "PrÄ…d"}</span>
                <span>-${report.bills.electricity} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>ğŸ’§ ${isEn ? "Water" : "Woda"}</span>
                <span>-${report.bills.water} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>ğŸ”¥ ${isEn ? "Gas" : "Gaz"}</span>
                <span>-${report.bills.gas} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>ğŸŒ Internet</span>
                <span>-${report.bills.internet} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <span>ğŸ  ${isEn ? "Rent" : "Czynsz"}</span>
                <span>-${report.bills.rent} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold;">
                <span>${isEn ? "Bills total" : "Rachunki razem"}:</span>
                <span style="color: #ef4444;">-${report.bills.total.toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <div style="text-align: center; padding-top: 10px; border-top: 2px dashed #444;">
              <div style="font-size: 1.3em; font-weight: bold; color: ${report.netIncome >= 0 ? '#4ade80' : '#ef4444'};">
                ${isEn ? "NET PROFIT" : "ZYSK NETTO"}: ${report.netIncome >= 0 ? '+' : ''}${report.netIncome.toLocaleString()} ${getCurrency()}
              </div>
            </div>
            
            <button onclick="closeDayReport(${report.businessIndex})" style="width: 100%; padding: 15px; background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 1.1em;">
              âœ… OK
            </button>
          </div>
        `;
        
        modal.style.display = "flex";
      }

      function closeDayReport(businessIndex) {
        const modal = document.getElementById("modalDayReport");
        if (modal) modal.style.display = "none";
        renderBusinessDetail(businessIndex);
      }

      function closeBusiness(businessIndex) {
        const t = translations[currentLang] || translations.en;
        if (!confirm(currentLang === 'en' ? "Close this business? You won't recover the startup cost." : "Na pewno zamknÄ…Ä‡ tÄ™ firmÄ™? Nie odzyskasz kosztÃ³w zaÅ‚oÅ¼enia.")) return;

        const businesses = getBusinesses();
        businesses.splice(businessIndex, 1);
        saveBusinesses(businesses);
        saveState();

        closeModal("businessDetail");
        openModal("business");
        renderBusinessModal();
        showToast("ğŸ—‘ï¸ " + (translations[currentLang] || translations.en).businessClosed);
      }

      function talkToClient(businessIndex, clientId) {
        // Implementacja obsÅ‚ugi klienta
        showToast("ğŸ’¬ System klientÃ³w w budowie...");
      }

      // ==================== SYSTEM BANKU I KREDYTÃ“W ====================
      
      function getCredits() {
        const save = getCurrentSave();
        if (!save) return [];
        const modeKey = gameMode === "reallife" ? "realLifeData" : "beamngData";
        if (!save[modeKey]) {
          save[modeKey] = {
            money: 1500, garage: [], spent: 0, debt: 0, debtDeadline: null,
            totalTaxPaid: 0, health: 100, food: 1000, water: 1000, backpack: [],
            activeInsurances: [], businesses: [], credits: [],
            workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
            vouchersToSend: [], receivedVouchers: []
          };
        }
        if (!save[modeKey].credits) save[modeKey].credits = [];
        return save[modeKey].credits;
      }
      
      function saveCredits(credits) {
        const save = getCurrentSave();
        if (!save) return;
        const modeKey = gameMode === "reallife" ? "realLifeData" : "beamngData";
        if (!save[modeKey]) save[modeKey] = {};
        save[modeKey].credits = credits;
        saveState();
      }
      
      function renderBankModal() {
        const content = document.getElementById("bankContent");
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';
        const credits = getCredits();
        
        // Opcje kredytÃ³w
        const creditOptions = [
          { amount: 1000, interest: 5, months: 3 },
          { amount: 5000, interest: 8, months: 6 },
          { amount: 10000, interest: 10, months: 12 },
          { amount: 25000, interest: 12, months: 12 },
          { amount: 50000, interest: 15, months: 24 },
          { amount: 100000, interest: 18, months: 36 },
        ];
        
        content.innerHTML = `
          <div style="background: rgba(16,185,129,0.1); border: 1px solid #10b981; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #10b981; margin-bottom: 15px;">ğŸ’° ${t.takeCredit}</h3>
            <div style="max-height: 200px; overflow-y: auto;">
              ${creditOptions.map((opt, i) => {
                const monthlyRate = Math.ceil((opt.amount * (1 + opt.interest / 100)) / opt.months);
                const total = monthlyRate * opt.months;
                return `
                <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-size: 1.2em; font-weight: bold; color: #4ade80;">${opt.amount.toLocaleString()} ${getCurrency()}</div>
                      <div style="color: #888; font-size: 0.85em;">${opt.interest}% â€¢ ${opt.months} ${t.months}</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="color: #f59e0b;">${monthlyRate}/${isEn ? 'mo' : 'msc'}</div>
                      <button onclick="takeCredit(${opt.amount}, ${opt.interest}, ${opt.months})" style="padding: 8px 15px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px;">
                        ${t.takeCredit}
                      </button>
                    </div>
                  </div>
                </div>
              `}).join("")}
            </div>
          </div>
          
          <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 15px; border-radius: 10px;">
            <h3 style="color: #ef4444; margin-bottom: 15px;">ğŸ“‹ ${t.yourCredits} (${credits.length})</h3>
            ${credits.length === 0 ? `
              <p style="color: #666; text-align: center;">${t.noCredits}</p>
            ` : `
              <div style="max-height: 250px; overflow-y: auto;">
                ${credits.map((cr, i) => {
                  // Oblicz czas do nastÄ™pnej raty lub termin pÅ‚atnoÅ›ci
                  const now = Date.now();
                  const MONTH_MS = 30 * 24 * 60 * 60 * 1000;
                  let statusHtml = '';
                  
                  if (cr.rateDue && cr.rateDueDate) {
                    // Rata do zapÅ‚aty!
                    const remaining = cr.rateDueDate - now;
                    if (remaining > 0) {
                      const days = Math.floor(remaining / (24 * 60 * 60 * 1000));
                      const hours = Math.floor((remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                      statusHtml = '<div style="background: #ef4444; color: white; padding: 5px 10px; border-radius: 5px; margin-top: 8px; text-align: center; font-weight: bold;">âš ï¸ ' + (isEn ? 'PAY NOW! ' : 'ZAPÅAÄ†! ') + days + 'd ' + hours + 'h ' + (isEn ? 'left' : 'zostaÅ‚o') + '</div>';
                    } else {
                      statusHtml = '<div style="background: #dc2626; color: white; padding: 5px 10px; border-radius: 5px; margin-top: 8px; text-align: center; font-weight: bold;">ğŸš¨ ' + (isEn ? 'OVERDUE!' : 'PO TERMINIE!') + '</div>';
                    }
                  } else {
                    // Czas do nastÄ™pnej raty
                    const timeSince = now - (cr.lastPayment || cr.takenAt);
                    const timeToNext = MONTH_MS - timeSince;
                    if (timeToNext > 0) {
                      const days = Math.floor(timeToNext / (24 * 60 * 60 * 1000));
                      statusHtml = '<div style="color: #888; font-size: 0.8em; margin-top: 5px;">ğŸ“… ' + (isEn ? 'Next installment in ' : 'NastÄ™pna rata za ') + days + (isEn ? ' days' : ' dni') + '</div>';
                    }
                  }
                  
                  return `
                  <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; ${cr.rateDue ? 'border: 2px solid #ef4444;' : ''} ${(cr.missedPayments || 0) >= 2 ? 'border: 2px solid #dc2626; box-shadow: 0 0 10px rgba(220,38,38,0.5);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-weight: bold;">${cr.originalAmount.toLocaleString()} ${getCurrency()}</div>
                        <div style="color: #888; font-size: 0.85em;">${t.remaining}: ${cr.remainingAmount.toLocaleString()} ${getCurrency()}</div>
                        <div style="color: #888; font-size: 0.85em;">${cr.remainingMonths} ${t.months} â€¢ ${cr.monthlyPayment}/${isEn ? 'mo' : 'msc'}</div>
                        ${(cr.missedPayments || 0) > 0 ? '<div style="color: #ef4444; font-size: 0.85em; margin-top: 3px;">âš ï¸ ' + (isEn ? 'Warnings: ' : 'OstrzeÅ¼enia: ') + cr.missedPayments + '/3</div>' : ''}
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button onclick="payCreditRate(${i})" style="padding: 6px 12px; background: ${cr.rateDue ? '#ef4444' : '#f59e0b'}; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                          ${t.payRate} (${cr.monthlyPayment})
                        </button>
                        <button onclick="payCreditOff(${i})" style="padding: 6px 12px; background: #333; color: white; border: 1px solid #666; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                          ${t.payOff} (${cr.remainingAmount})
                        </button>
                      </div>
                    </div>
                    ${statusHtml}
                    ${(cr.missedPayments || 0) >= 2 ? '<div style="background: #dc2626; color: white; padding: 8px; border-radius: 5px; margin-top: 8px; text-align: center; font-weight: bold;">ğŸš” ' + (isEn ? 'DEBT COLLECTOR COMING SOON!' : 'WINDYKACJA JUÅ» NIEDÅUGO!') + '</div>' : ''}
                  </div>
                `}).join("")}
              </div>
            `}
          </div>
        `;
      }
      
      function takeCredit(amount, interest, months) {
        const t = translations[currentLang] || translations.en;
        const monthlyPayment = Math.ceil((amount * (1 + interest / 100)) / months);
        const totalToRepay = monthlyPayment * months;
        
        const credit = {
          id: Date.now().toString(),
          originalAmount: amount,
          totalToRepay: totalToRepay,
          remainingAmount: totalToRepay,
          monthlyPayment: monthlyPayment,
          remainingMonths: months,
          interest: interest,
          takenAt: Date.now(),
          lastPayment: Date.now()
        };
        
        const credits = getCredits();
        credits.push(credit);
        saveCredits(credits);
        
        money += amount;
        saveState();
        updateAllDisplays();
        renderBankModal();
        
        showToast(`âœ… ${t.creditTaken} +${amount.toLocaleString()} ${getCurrency()}`);
      }
      
      function payCreditRate(creditIndex) {
        const t = translations[currentLang] || translations.en;
        const credits = getCredits();
        const credit = credits[creditIndex];
        if (!credit) return;
        
        if (money < credit.monthlyPayment) {
          showToast(`âŒ ${t.notEnoughForRate}`);
          return;
        }
        
        money -= credit.monthlyPayment;
        credit.remainingAmount -= credit.monthlyPayment;
        credit.remainingMonths--;
        credit.lastPayment = Date.now();
        credit.rateDue = false;
        credit.rateDueDate = null;
        
        if (credit.remainingMonths <= 0 || credit.remainingAmount <= 0) {
          credits.splice(creditIndex, 1);
          showToast(`ğŸ‰ ${t.creditPaidOff}`);
        } else {
          showToast(`âœ… ${t.ratePaid}: -${credit.monthlyPayment} ${getCurrency()}`);
        }
        
        saveCredits(credits);
        saveState();
        updateAllDisplays();
        renderBankModal();
      }
      
      function payCreditOff(creditIndex) {
        const t = translations[currentLang] || translations.en;
        const credits = getCredits();
        const credit = credits[creditIndex];
        if (!credit) return;
        
        if (money < credit.remainingAmount) {
          showToast(`âŒ ${t.notEnoughForRate}`);
          return;
        }
        
        money -= credit.remainingAmount;
        credits.splice(creditIndex, 1);
        
        saveCredits(credits);
        saveState();
        updateAllDisplays();
        renderBankModal();
        
        showToast(`ğŸ‰ ${t.creditPaidOff}`);
      }
      
      // Automatyczne raty kredytÃ³w (co miesiÄ…c = 30 dni w grze)
      function processCreditPayments() {
        const credits = getCredits();
        const now = Date.now();
        const MONTH_MS = 30 * 24 * 60 * 60 * 1000; // 30 dni - cykl raty
        const GRACE_PERIOD_MS = 7 * 24 * 60 * 60 * 1000; // 7 dni na spÅ‚atÄ™
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';
        let changed = false;
        
        credits.forEach((credit, i) => {
          const timeSincePayment = now - (credit.lastPayment || credit.takenAt);
          
          // SprawdÅº czy minÄ…Å‚ miesiÄ…c - czas na nowÄ… ratÄ™
          if (timeSincePayment >= MONTH_MS && !credit.rateDue) {
            credit.rateDue = true;
            credit.rateDueDate = now + GRACE_PERIOD_MS;
            credit.missedPayments = credit.missedPayments || 0;
            changed = true;
            showToast(`ğŸ’³ ${isEn ? "Loan installment due!" : "Rata kredytu do zapÅ‚aty!"} ${credit.monthlyPayment} ${getCurrency()} (7 ${isEn ? "days" : "dni"})`);
          }
          
          // SprawdÅº czy minÄ…Å‚ termin pÅ‚atnoÅ›ci raty
          if (credit.rateDue && now > credit.rateDueDate) {
            // Termin minÄ…Å‚ - kara!
            credit.remainingAmount = Math.ceil(credit.remainingAmount * 1.05);
            credit.rateDue = false;
            credit.rateDueDate = null;
            credit.lastPayment = now;
            credit.missedPayments = (credit.missedPayments || 0) + 1;
            changed = true;
            
            // Konsekwencje za niespÅ‚acanie
            if (credit.missedPayments === 1) {
              showToast(`âš ï¸ ${isEn ? "Missed payment! +5% penalty. Warning!" : "NieopÅ‚acona rata! +5% kary. OstrzeÅ¼enie!"}`);
            } else if (credit.missedPayments === 2) {
              showToast(`ğŸš¨ ${isEn ? "2nd missed payment! Debt collector warning!" : "Druga nieopÅ‚acona rata! OstrzeÅ¼enie od windykacji!"}`);
            } else if (credit.missedPayments >= 3) {
              // Windykacja - zabierajÄ… co majÄ…
              showToast(`ğŸš” ${isEn ? "DEBT COLLECTOR! Seizing assets..." : "WINDYKACJA! Zajmowanie majÄ…tku..."}`);
              
              // Zabierz pieniÄ…dze
              const seized = Math.min(money, credit.monthlyPayment * 2);
              if (seized > 0) {
                money -= seized;
                credit.remainingAmount -= seized;
                showToast(`ğŸ’¸ ${isEn ? "Seized" : "ZajÄ™to"}: ${seized} ${getCurrency()}`);
              }
              
              // Zabierz samochÃ³d jeÅ›li jest
              const save = getCurrentSave();
              if (save.data.cars && save.data.cars.length > 0) {
                const carValue = Math.floor((save.data.cars[0].price || 10000) * 0.3);
                credit.remainingAmount -= carValue;
                showToast(`ğŸš— ${isEn ? "Car seized! Value" : "SamochÃ³d zajÄ™ty! WartoÅ›Ä‡"}: ${carValue} ${getCurrency()}`);
                save.data.cars = [];
                save.data.currentCar = null;
              }
              
              // Zamknij firmy jeÅ›li dÅ‚ug wciÄ…Å¼ duÅ¼y
              if (credit.remainingAmount > credit.monthlyPayment * 3) {
                const businesses = getBusinesses();
                if (businesses.length > 0) {
                  const biz = businesses[0];
                  const bizValue = Math.floor(biz.startCost * 0.2);
                  credit.remainingAmount -= bizValue;
                  businesses.splice(0, 1);
                  saveBusinesses(businesses);
                  showToast(`ğŸ¢ ${isEn ? "Business seized!" : "Firma zajÄ™ta!"} ${biz.name} (-${bizValue} ${getCurrency()})`);
                }
              }
              
              credit.missedPayments = 0; // Reset po windykacji
              saveState();
            }
          }
        });
        
        // UsuÅ„ spÅ‚acone kredyty
        const activeCredits = credits.filter(c => c.remainingAmount > 0);
        
        if (changed) {
          saveCredits(activeCredits);
          updateAllDisplays();
        }
      }
      
      // Uruchom sprawdzanie rat co minutÄ™
      setInterval(processCreditPayments, 60000);

      // Cotygodniowe pÅ‚atnoÅ›ci pracownikÃ³w
      function processBusinessWeeklyPayments() {
        const businesses = getBusinesses();
        const now = Date.now();
        const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';
        
        businesses.forEach((business, index) => {
          if (now - (business.lastPaymentTime || 0) >= WEEK_MS) {
            const hiredWorkers = business.workers.filter(w => w.hired);
            let totalPayment = 0;
            
            hiredWorkers.forEach(w => {
              totalPayment += w.currentSalary || 0;
            });

            if (totalPayment > 0) {
              if (money >= totalPayment) {
                // Masz kasÄ™ - wypÅ‚aÄ‡ wszystkim
                money -= totalPayment;
                business.totalExpenses = (business.totalExpenses || 0) + totalPayment;
                hiredWorkers.forEach(w => {
                  w.satisfaction = Math.min(100, (w.satisfaction || 50) + 5);
                });
                showToast(`ğŸ’¼ ${t.salariesIn} ${business.name}: -${totalPayment.toLocaleString()} ${getCurrency()}`);
              } else {
                // Brak kasy - pracownicy nie dostajÄ… wypÅ‚aty!
                hiredWorkers.forEach(w => {
                  w.satisfaction = Math.max(0, (w.satisfaction || 50) - 25);
                  w.unpaidWeeks = (w.unpaidWeeks || 0) + 1;
                });
                business.reputation = Math.max(0, (business.reputation || 50) - 10);
                
                const needed = totalPayment - money;
                showToast(`âš ï¸ ${isEn ? "Can't pay salaries in" : "Nie staÄ‡ CiÄ™ na wypÅ‚aty w"} ${business.name}! ${isEn ? "Need" : "Potrzebujesz"}: ${needed.toLocaleString()} ${getCurrency()}`);
                
                // SprawdÅº czy ktoÅ› odchodzi z powodu braku wypÅ‚at
                hiredWorkers.forEach(w => {
                  if (w.unpaidWeeks >= 2 || w.satisfaction <= 10) {
                    // Pracownik odchodzi!
                    business.workers = business.workers.filter(worker => worker.id !== w.id);
                    showToast(`ğŸšª ${w.name} ${isEn ? "quit due to unpaid wages!" : "odszedÅ‚ z powodu braku wypÅ‚at!"}`);
                  }
                });
              }
            }
            
            business.lastPaymentTime = now;
            business.weeklyIncome = 0; // Reset tygodniowego przychodu
          }
        });
        
        saveBusinesses(businesses);
        saveState();
        updateAllDisplays();
      }

      // Dodaj obsÅ‚ugÄ™ modalu firm i banku do openModal
      const originalOpenModal = openModal;
      openModal = function(type) {
        originalOpenModal(type);
        if (type === "business") {
          renderBusinessModal();
        } else if (type === "bank") {
          renderBankModal();
        }
      };

      // Uruchom sprawdzanie pÅ‚atnoÅ›ci co minutÄ™
      setInterval(processBusinessWeeklyPayments, 60000);

      // ==================== AUTOMATYCZNE DNI ROBOCZE ====================
      
      function processAutomaticBusinessDays() {
        const businesses = getBusinesses();
        const now = Date.now();
        const DAY_MS = 24 * 60 * 60 * 1000; // 24h rzeczywiste
        let anyProcessed = false;
        
        businesses.forEach((business, index) => {
          const lastDay = business.lastDayProcessed || (now - DAY_MS - 1000); // JeÅ›li nowa firma, przetwÃ³rz od razu
          
          if (now - lastDay >= DAY_MS) {
            const hiredWorkers = business.workers.filter(w => w.hired);
            
            if (hiredWorkers.length > 0) {
              // PrzetwÃ³rz dzieÅ„ dla tej firmy
              processBusinessDayAuto(index);
              anyProcessed = true;
            }
            
            business.lastDayProcessed = now;
          }
        });
        
        if (anyProcessed) {
          saveBusinesses(businesses);
        }
      }
      
      function processBusinessDayAuto(businessIndex) {
        const businesses = getBusinesses();
        const business = businesses[businessIndex];
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';
        
        const hiredWorkers = business.workers.filter(w => w.hired);
        if (hiredWorkers.length === 0) return;

        // Oblicz produktywnoÅ›Ä‡
        let totalProductivity = 0;
        hiredWorkers.forEach(w => {
          totalProductivity += w.productivity || 1;
        });
        const avgProductivity = totalProductivity / hiredWorkers.length;

        // Symuluj klientÃ³w
        const clientCount = Math.floor(business.clientsPerDay * avgProductivity * (0.7 + Math.random() * 0.6));
        let dayIncome = 0;
        
        for (let i = 0; i < clientCount; i++) {
          const clientSpend = Math.floor(business.avgIncome * (0.5 + Math.random()));
          dayIncome += clientSpend;
        }

        // Oblicz prowizje dla pracownikÃ³w
        let bonusesPaid = 0;
        const workerReports = [];
        hiredWorkers.forEach(w => {
          const workerBonus = Math.floor(dayIncome * (w.bonusPercent / 100) / hiredWorkers.length);
          bonusesPaid += workerBonus;
          w.totalEarned = (w.totalEarned || 0) + workerBonus;
          w.daysWorked = (w.daysWorked || 0) + 1;
          workerReports.push({
            name: w.name,
            bonus: workerBonus,
            productivity: Math.round((w.productivity || 1) * 100)
          });
        });

        // RACHUNKI
        const electricityCost = Math.floor(50 + business.clientsPerDay * 3 + Math.random() * 30);
        const waterCost = Math.floor(20 + business.clientsPerDay * 1.5 + Math.random() * 15);
        const gasCost = Math.floor(30 + business.clientsPerDay * 2 + Math.random() * 20);
        const internetCost = 50;
        const rentCost = Math.floor(business.startCost * 0.002);
        const totalBills = electricityCost + waterCost + gasCost + internetCost + rentCost;

        const netIncome = dayIncome - bonusesPaid - totalBills;
        business.weeklyIncome = (business.weeklyIncome || 0) + netIncome;
        business.totalIncome = (business.totalIncome || 0) + dayIncome;
        business.totalExpenses = (business.totalExpenses || 0) + totalBills + bonusesPaid;
        business.lastDayProcessed = Date.now();

        // Dodaj do pieniÄ™dzy gracza
        money += netIncome;

        saveBusinesses(businesses);
        saveState();
        updateAllDisplays();

        // PokaÅ¼ paragon
        showDayReport({
          businessName: business.name,
          clients: clientCount,
          income: dayIncome,
          workers: workerReports,
          bonusesPaid: bonusesPaid,
          bills: {
            electricity: electricityCost,
            water: waterCost,
            gas: gasCost,
            internet: internetCost,
            rent: rentCost,
            total: totalBills
          },
          netIncome: netIncome,
          businessIndex: businessIndex
        });
      }
      
      // Sprawdzaj dni co 30 sekund
      setInterval(processAutomaticBusinessDays, 30000);
      
      // ==================== AUTOMATYCZNE GENEROWANIE KANDYDATÃ“W ====================
      
      function autoGenerateCandidates() {
        const businesses = getBusinesses();
        const now = Date.now();
        const FIVE_MIN_MS = 5 * 60 * 1000; // 5 minut
        let anyGenerated = false;
        const t = translations[currentLang] || translations.en;
        const isEn = currentLang === 'en';
        
        businesses.forEach((business, index) => {
          const lastGen = business.lastCandidateGen || 0;
          
          if (now - lastGen >= FIVE_MIN_MS) {
            // SprawdÅº ile jest kandydatÃ³w (nie zatrudnionych)
            const candidates = business.workers.filter(w => !w.hired);
            
            // Generuj nowych jeÅ›li mniej niÅ¼ 3 kandydatÃ³w
            if (candidates.length < 3) {
              const positions = ["manager", "senior", "regular", "regular", "junior", "junior", "intern"];
              const toGenerate = 3 - candidates.length;
              
              for (let i = 0; i < toGenerate; i++) {
                const pos = positions[Math.floor(Math.random() * positions.length)];
                business.workers.push(generateWorker(pos));
              }
              
              anyGenerated = true;
              showToast(`ğŸ“‹ ${business.name}: ${isEn ? "New candidates available!" : "Nowi kandydaci dostÄ™pni!"}`);
            }
            
            business.lastCandidateGen = now;
          }
        });
        
        if (anyGenerated) {
          saveBusinesses(businesses);
        }
      }
      
      // Sprawdzaj kandydatÃ³w co minutÄ™
      setInterval(autoGenerateCandidates, 60000);
      
      // SprawdÅº od razu przy starcie (po 5 sekundach)
      setTimeout(autoGenerateCandidates, 5000);
      
      // SprawdÅº od razu przy starcie
      setTimeout(processAutomaticBusinessDays, 2000);

      // START - sprawdÅº czy to strona weryfikatora
      if (!checkIfVerifier()) {
        init();
      }

      // TÅ‚umaczenie ekranu blokady mobilnej
      function updateMobileBlockLanguage() {
        const isEn = currentLang === 'en';
        const title = document.getElementById('mobileBlockTitle');
        const text = document.getElementById('mobileBlockText');
        
        if (title && text) {
          title.textContent = isEn 
            ? "Game unavailable on mobile devices" 
            : "Gra niedostÄ™pna na urzÄ…dzeniach mobilnych";
          text.innerHTML = isEn
            ? "Due to the complexity of mechanics and interface, optimizing this game for mobile devices is not possible.<br><br>The game requires precise controls and a large screen, which are only available on desktop computers and laptops.<br><br>Please play on a computer! ğŸ–¥ï¸"
            : "Ze wzglÄ™du na zÅ‚oÅ¼onoÅ›Ä‡ mechanik i interfejsu, optymalizacja tej gry na urzÄ…dzenia mobilne nie jest moÅ¼liwa.<br><br>Gra wymaga precyzyjnego sterowania i duÅ¼ego ekranu, ktÃ³re sÄ… dostÄ™pne tylko na komputerach stacjonarnych i laptopach.<br><br>Zapraszamy do gry na komputerze! ğŸ–¥ï¸";
        }
      }
      
      // WywoÅ‚aj przy starcie
      updateMobileBlockLanguage();
    </script>
    </div><!-- koniec gameContainer -->
  </body>
</html>