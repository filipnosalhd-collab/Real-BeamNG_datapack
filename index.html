<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>BeamNG Drive - Datapack PL</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* ==================== MEGA UPGRADE GRAFICZNY ==================== */

      /* Animacje globalne */
      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 5px currentColor, 0 0 10px currentColor;
        }
        50% {
          box-shadow: 0 0 15px currentColor, 0 0 30px currentColor;
        }
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      @keyframes bell-ring {
        0%,
        100% {
          transform: rotate(0deg);
        }
        10%,
        30% {
          transform: rotate(15deg);
        }
        20%,
        40% {
          transform: rotate(-15deg);
        }
        50% {
          transform: rotate(0deg);
        }
      }

      @keyframes notification-pop {
        0% {
          transform: scale(0.3);
          opacity: 0;
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes slide-in-right {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slide-out-right {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @keyframes gradient-flow {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      @keyframes badge-pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
      }

      /* ==================== DZWONECZEK POWIADOMIEŃ ==================== */
      .notification-bell-container {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .notification-bell-btn {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.15),
          rgba(255, 255, 255, 0.05)
        );
        border: 2px solid transparent;
        border-image: linear-gradient(135deg, #ffd700, #ff6b35, #ffd700) 1;
        color: #ffd700;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1.3em;
        min-width: 48px;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .notification-bell-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 215, 0, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .notification-bell-btn:hover::before {
        left: 100%;
      }

      .notification-bell-btn:hover {
        background: linear-gradient(
          145deg,
          rgba(255, 215, 0, 0.3),
          rgba(255, 107, 53, 0.2)
        );
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
      }

      .notification-bell-btn.has-notifications {
        animation: pulse-glow 2s infinite;
        color: #ffd700;
      }

      .notification-bell-btn.has-notifications .bell-icon {
        animation: bell-ring 1s ease-in-out infinite;
      }

      .bell-icon {
        display: inline-block;
        transition: transform 0.3s;
      }

      /* ==================== BADGE POWIADOMIEŃ ==================== */
      .notification-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
        color: white;
        font-size: 0.65em;
        font-weight: bold;
        padding: 4px 7px;
        border-radius: 12px;
        min-width: 22px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.6), 0 0 0 2px #1a1a2e;
        animation: notification-pop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
        display: none;
        align-items: center;
        justify-content: center;
      }

      .notification-badge.active {
        display: flex;
        animation: notification-pop 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          badge-pulse 2s infinite 0.5s;
      }

      .notification-badge.many {
        background: linear-gradient(135deg, #dc2626, #991b1b, #7f1d1d);
        font-size: 0.6em;
        padding: 3px 6px;
      }

      /* ==================== TOAST POWIADOMIENIA (POPUP) ==================== */
      .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 320px;
        max-width: 420px;
        background: linear-gradient(145deg, #1e293b, #0f172a);
        border-radius: 16px;
        padding: 0;
        z-index: 10000;
        animation: slide-in-right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.1);
        overflow: hidden;
        cursor: pointer;
        transform-origin: top right;
      }

      .toast-notification.closing {
        animation: slide-out-right 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      .toast-notification::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          #ffd700,
          #ff6b35,
          #ef4444,
          #8b5cf6,
          #3b82f6
        );
        background-size: 200% 100%;
        animation: gradient-flow 3s linear infinite;
      }

      .toast-content {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
      }

      .toast-icon {
        font-size: 2em;
        flex-shrink: 0;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
      }

      .toast-body {
        flex: 1;
        min-width: 0;
      }

      .toast-title {
        font-weight: bold;
        font-size: 0.95em;
        margin-bottom: 4px;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .toast-message {
        font-size: 0.85em;
        color: #94a3b8;
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .toast-time {
        font-size: 0.7em;
        color: #64748b;
        margin-top: 4px;
      }

      .toast-close {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #64748b;
        width: 24px;
        height: 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        opacity: 0;
      }

      .toast-notification:hover .toast-close {
        opacity: 1;
      }

      .toast-close:hover {
        background: rgba(239, 68, 68, 0.3);
        color: #ef4444;
      }

      .toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: linear-gradient(90deg, #4ade80, #22c55e);
        transition: width 0.1s linear;
      }

      /* ==================== MODAL POWIADOMIEŃ ==================== */
      .notifications-modal-content {
        background: linear-gradient(145deg, #1e293b, #0f172a) !important;
        border: 2px solid transparent !important;
        border-radius: 20px !important;
        max-width: 550px !important;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6),
          0 0 0 1px rgba(255, 255, 255, 0.1);
        overflow: hidden;
      }

      .notifications-header {
        background: linear-gradient(
          135deg,
          rgba(255, 107, 53, 0.2),
          rgba(255, 215, 0, 0.1)
        );
        padding: 20px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .notifications-header h2 {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.3em;
        color: #fff;
        margin: 0;
      }

      .notifications-header .notif-count {
        background: linear-gradient(135deg, #ff6b35, #f97316);
        color: white;
        font-size: 0.65em;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: bold;
      }

      .notifications-actions {
        display: flex;
        gap: 8px;
      }

      .notif-action-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #94a3b8;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.8em;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .notif-action-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }

      .notif-action-btn.danger:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.3);
      }

      .notifications-list {
        max-height: 500px;
        overflow-y: auto;
        padding: 16px;
      }

      .notifications-list::-webkit-scrollbar {
        width: 6px;
      }

      .notifications-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
      }

      .notifications-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
      }

      .notifications-list::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* ==================== POJEDYNCZE POWIADOMIENIE ==================== */
      .notification-item {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.02)
        );
        border-radius: 14px;
        padding: 14px 16px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: 1px solid transparent;
        overflow: hidden;
      }

      .notification-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        border-radius: 4px 0 0 4px;
        transition: width 0.3s;
      }

      .notification-item.unread {
        background: linear-gradient(
          145deg,
          rgba(59, 130, 246, 0.15),
          rgba(59, 130, 246, 0.05)
        );
        border-color: rgba(59, 130, 246, 0.3);
      }

      .notification-item.unread::before {
        background: linear-gradient(180deg, #3b82f6, #2563eb);
      }

      .notification-item:hover {
        transform: translateX(5px);
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.08),
          rgba(255, 255, 255, 0.04)
        );
        border-color: rgba(255, 255, 255, 0.15);
      }

      .notification-item:hover::before {
        width: 6px;
      }

      /* Kolory według typu */
      .notification-item.type-raise_request::before,
      .notification-item.type-budget_request::before {
        background: linear-gradient(180deg, #f59e0b, #d97706);
      }
      .notification-item.type-unhappy::before,
      .notification-item.type-quit_warning::before,
      .notification-item.type-client_review_bad::before,
      .notification-item.type-low_cleanliness::before {
        background: linear-gradient(180deg, #ef4444, #dc2626);
      }
      .notification-item.type-client_review_good::before,
      .notification-item.type-day_end::before,
      .notification-item.type-cleaning_done::before {
        background: linear-gradient(180deg, #4ade80, #22c55e);
      }
      .notification-item.type-promotion_bought::before,
      .notification-item.type-test_welcome::before {
        background: linear-gradient(180deg, #8b5cf6, #7c3aed);
      }
      .notification-item.type-price_change::before,
      .notification-item.type-new_candidate::before {
        background: linear-gradient(180deg, #3b82f6, #2563eb);
      }
      .notification-item.type-hours_complaint::before {
        background: linear-gradient(180deg, #f59e0b, #d97706);
      }
      .notification-item.type-client_review_neutral::before {
        background: linear-gradient(180deg, #6b7280, #4b5563);
      }

      .notification-item-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }

      .notification-icon {
        font-size: 1.6em;
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        flex-shrink: 0;
      }

      .notification-content {
        flex: 1;
        min-width: 0;
      }

      .notification-title {
        font-weight: 600;
        font-size: 0.95em;
        color: #fff;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .notification-title .action-hint {
        font-size: 0.8em;
        opacity: 0.6;
      }

      .notification-text {
        font-size: 0.85em;
        color: #94a3b8;
        line-height: 1.5;
        margin-bottom: 6px;
      }

      .notification-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.75em;
        color: #64748b;
      }

      .notification-meta .business-tag {
        display: flex;
        align-items: center;
        gap: 4px;
        background: rgba(255, 255, 255, 0.05);
        padding: 2px 8px;
        border-radius: 6px;
      }

      .notification-actions-row {
        display: flex;
        gap: 8px;
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .notification-item:hover .notification-actions-row {
        opacity: 1;
      }

      .notif-delete-btn {
        background: none;
        border: none;
        color: #64748b;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.85em;
        transition: all 0.2s;
      }

      .notif-delete-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
      }

      /* ==================== PUSTA LISTA POWIADOMIEŃ ==================== */
      .notifications-empty {
        text-align: center;
        padding: 60px 30px;
        color: #64748b;
      }

      .notifications-empty-icon {
        font-size: 4em;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .notifications-empty h3 {
        color: #94a3b8;
        font-size: 1.1em;
        margin-bottom: 8px;
      }

      .notifications-empty p {
        font-size: 0.9em;
        line-height: 1.5;
      }

      /* ==================== FILTERY POWIADOMIEŃ ==================== */
      .notifications-filters {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        overflow-x: auto;
        flex-wrap: nowrap;
      }

      .notif-filter-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #94a3b8;
        padding: 6px 14px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.8em;
        white-space: nowrap;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .notif-filter-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .notif-filter-btn.active {
        background: linear-gradient(135deg, #ff6b35, #f97316);
        border-color: transparent;
        color: white;
      }

      .notif-filter-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 1px 6px;
        border-radius: 10px;
        font-size: 0.85em;
      }

      /* Ekran blokady mobilnej */
      #mobileBlockScreen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        z-index: 99999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 30px;
        text-align: center;
      }

      #mobileBlockScreen .block-icon {
        font-size: 80px;
        margin-bottom: 30px;
      }

      #mobileBlockScreen h1 {
        color: #ef4444;
        font-size: 1.8em;
        margin-bottom: 20px;
      }

      #mobileBlockScreen p {
        color: #888;
        font-size: 1em;
        line-height: 1.6;
        max-width: 400px;
      }

      #mobileBlockScreen .desktop-icon {
        margin-top: 40px;
        font-size: 60px;
        opacity: 0.5;
      }

      /* Ukryj grę na mobile */
      @media (max-width: 768px), (hover: none) and (pointer: coarse) {
        #mobileBlockScreen {
          display: flex !important;
        }

        #gameContainer,
        .container,
        header,
        .btn-grid,
        .modal {
          display: none !important;
        }
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #0f0f1a 0%,
          #1a1a2e 30%,
          #16213e 60%,
          #0f3460 100%
        );
        background-attachment: fixed;
        min-height: 100vh;
        color: #fff;
        padding: 10px;
        transition: background 0.5s ease;
        overflow-x: hidden;
      }

      /* Animated particles background */
      #particlesBackground {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }

      .bg-particle {
        position: absolute;
        border-radius: 50%;
        opacity: 0.3;
        animation: floatParticle linear infinite;
      }

      @keyframes floatParticle {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 0.3;
        }
        90% {
          opacity: 0.3;
        }
        100% {
          transform: translateY(-100px) rotate(720deg);
          opacity: 0;
        }
      }

      /* Efekt particles w tle */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: radial-gradient(
            circle at 20% 80%,
            rgba(255, 107, 53, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(59, 130, 246, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 40%,
            rgba(139, 92, 246, 0.1) 0%,
            transparent 30%
          ),
          radial-gradient(
            circle at 60% 60%,
            rgba(74, 222, 128, 0.08) 0%,
            transparent 40%
          );
        pointer-events: none;
        z-index: 0;
        animation: bgPulse 10s ease-in-out infinite;
      }

      @keyframes bgPulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }

      header {
        text-align: center;
        padding: 20px;
        padding-top: 50px;
        background: linear-gradient(
          145deg,
          rgba(0, 0, 0, 0.7),
          rgba(0, 0, 0, 0.4)
        );
        backdrop-filter: blur(15px);
        border-radius: 24px;
        margin-bottom: 15px;
        border: 2px solid rgba(255, 107, 53, 0.4);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4),
          0 0 80px rgba(255, 107, 53, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
      }

      header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          transparent,
          #ff6b35,
          #ffd700,
          #ff6b35,
          transparent
        );
        animation: headerGlow 3s ease-in-out infinite;
      }

      @keyframes headerGlow {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }

      header::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
      }

      header h1 {
        font-size: clamp(1.5em, 5vw, 2.2em);
        color: #ff6b35;
        text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
      }

      header h2 {
        font-size: clamp(0.9em, 3vw, 1.1em);
        color: #ffd700;
      }

      .header-btns-left,
      .header-btns-right {
        position: absolute;
        top: 10px;
        display: flex;
        gap: 5px;
      }

      .header-btns-left {
        left: 10px;
      }

      .header-btns-right {
        right: 10px;
      }

      .lang-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #555;
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lang-btn:hover,
      .lang-btn:active {
        background: rgba(255, 255, 255, 0.2);
      }

      @media (max-width: 400px) {
        .lang-btn {
          padding: 6px 10px;
          font-size: 1em;
          min-width: 40px;
          min-height: 40px;
        }

        header {
          padding-top: 45px;
        }
      }

      .money-display {
        background: linear-gradient(
          145deg,
          rgba(45, 45, 45, 0.9),
          rgba(26, 26, 26, 0.9)
        );
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 24px;
        text-align: center;
        margin-bottom: 15px;
        border: 2px solid rgba(68, 68, 68, 0.5);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
      }

      .money-display::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(74, 222, 128, 0.03),
          transparent
        );
        animation: shimmer 8s ease-in-out infinite;
      }

      .money-display h3 {
        color: #888;
        font-size: 0.9em;
        margin-bottom: 5px;
      }

      .money-amount {
        font-size: clamp(2em, 8vw, 3em);
        font-weight: bold;
        color: #4ade80;
        text-shadow: 0 0 20px rgba(74, 222, 128, 0.5),
          0 0 40px rgba(74, 222, 128, 0.3);
        animation: moneyGlow 2s ease-in-out infinite;
        position: relative;
      }

      @keyframes moneyGlow {
        0%,
        100% {
          text-shadow: 0 0 20px rgba(74, 222, 128, 0.5),
            0 0 40px rgba(74, 222, 128, 0.3);
        }
        50% {
          text-shadow: 0 0 30px rgba(74, 222, 128, 0.8),
            0 0 60px rgba(74, 222, 128, 0.5), 0 0 80px rgba(74, 222, 128, 0.3);
        }
      }

      .money-amount.low {
        color: #f87171;
        text-shadow: 0 0 20px rgba(248, 113, 113, 0.5);
        animation: moneyLowPulse 1s ease-in-out infinite;
      }

      @keyframes moneyLowPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      /* ==================== ULEPSZENIA PRZYCISKÓW ==================== */
      .buttons-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 15px;
        perspective: 1000px;
      }

      .btn-instruction {
        background: linear-gradient(145deg, #3b82f6, #2563eb);
        color: white;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
      }
      .btn-instruction:hover {
        box-shadow: 0 8px 30px rgba(59, 130, 246, 0.6),
          0 0 20px rgba(59, 130, 246, 0.3);
      }

      .btn-repair {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        color: white;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
      }
      .btn-repair:hover {
        box-shadow: 0 8px 30px rgba(245, 158, 11, 0.6),
          0 0 20px rgba(245, 158, 11, 0.3);
      }

      .btn-buy {
        background: linear-gradient(145deg, #10b981, #059669);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
      }
      .btn-buy:hover {
        box-shadow: 0 8px 30px rgba(16, 185, 129, 0.6),
          0 0 20px rgba(16, 185, 129, 0.3);
      }

      .btn-sell {
        background: linear-gradient(145deg, #ec4899, #db2777);
        color: white;
        box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
      }
      .btn-sell:hover {
        box-shadow: 0 8px 30px rgba(236, 72, 153, 0.6),
          0 0 20px rgba(236, 72, 153, 0.3);
      }

      .btn-earn {
        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        color: white;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
      }
      .btn-earn:hover {
        box-shadow: 0 8px 30px rgba(139, 92, 246, 0.6),
          0 0 20px rgba(139, 92, 246, 0.3);
      }

      .btn-tax {
        background: linear-gradient(145deg, #ef4444, #dc2626);
        color: white;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
      }
      .btn-tax:hover {
        box-shadow: 0 8px 30px rgba(239, 68, 68, 0.6),
          0 0 20px rgba(239, 68, 68, 0.3);
      }

      .btn-card {
        background: linear-gradient(145deg, #06b6d4, #0891b2);
        color: white;
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
      }
      .btn-card:hover {
        box-shadow: 0 8px 30px rgba(6, 182, 212, 0.6),
          0 0 20px rgba(6, 182, 212, 0.3);
      }

      .btn-inventory {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        color: white;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
      }

      .btn-shop {
        background: linear-gradient(145deg, #10b981, #059669);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
      }

      .btn-insurance {
        background: linear-gradient(145deg, #ec4899, #db2777);
        color: white;
        box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
      }

      /* ==================== ANIMOWANE TŁO NAGŁÓWKA ==================== */
      header h1 {
        font-size: clamp(1.5em, 5vw, 2.2em);
        color: #ff6b35;
        text-shadow: 0 0 20px rgba(255, 107, 53, 0.5),
          0 0 40px rgba(255, 107, 53, 0.3);
        animation: titleGlow 3s ease-in-out infinite;
      }

      @keyframes titleGlow {
        0%,
        100% {
          text-shadow: 0 0 20px rgba(255, 107, 53, 0.5),
            0 0 40px rgba(255, 107, 53, 0.3);
        }
        50% {
          text-shadow: 0 0 30px rgba(255, 107, 53, 0.8),
            0 0 60px rgba(255, 107, 53, 0.5), 0 0 80px rgba(255, 107, 53, 0.3);
        }
      }

      header h2 {
        font-size: clamp(0.9em, 3vw, 1.1em);
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      }

      /* ==================== ULEPSZONY LANG BUTTON ==================== */
      .lang-btn {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.15),
          rgba(255, 255, 255, 0.05)
        );
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.1em;
        min-width: 46px;
        min-height: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(5px);
      }

      .lang-btn:hover,
      .lang-btn:active {
        background: linear-gradient(
          145deg,
          rgba(255, 107, 53, 0.3),
          rgba(255, 107, 53, 0.15)
        );
        border-color: rgba(255, 107, 53, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
      }

      /* ==================== DEBT DISPLAY ULEPSZONE ==================== */
      .debt-display {
        background: linear-gradient(
          145deg,
          rgba(239, 68, 68, 0.25),
          rgba(239, 68, 68, 0.1)
        );
        border: 2px solid #ef4444;
        border-radius: 12px;
        padding: 12px;
        margin-top: 12px;
        display: none;
        animation: debtPulse 2s ease-in-out infinite;
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.3),
          inset 0 0 30px rgba(239, 68, 68, 0.1);
      }

      @keyframes debtPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(239, 68, 68, 0.3),
            inset 0 0 30px rgba(239, 68, 68, 0.1);
        }
        50% {
          box-shadow: 0 0 30px rgba(239, 68, 68, 0.5),
            inset 0 0 40px rgba(239, 68, 68, 0.2);
        }
      }

      .debt-display.active {
        display: block;
      }

      .debt-display h4 {
        color: #ef4444;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .debt-amount {
        font-size: 1.6em;
        color: #ef4444;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
      }

      .debt-deadline {
        font-size: 0.85em;
        color: #f87171;
      }

      /* ==================== SCROLLBAR STYLING ==================== */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #ff6b35, #f97316);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #f97316, #ff6b35);
      }

      /* ==================== SHOP ITEMS ULEPSZONE ==================== */

      .btn {
        padding: 15px 10px;
        font-size: clamp(0.85em, 2.5vw, 1em);
        font-weight: bold;
        border: none;
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 20px currentColor;
      }

      .btn:active {
        transform: scale(0.96);
      }

      .btn-icon {
        font-size: 1.8em;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      }

      .btn-instruction {
        background: linear-gradient(145deg, #3b82f6, #2563eb);
        color: white;
      }
      .btn-repair {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        color: white;
      }
      .btn-buy {
        background: linear-gradient(145deg, #10b981, #059669);
        color: white;
      }
      .btn-sell {
        background: linear-gradient(145deg, #ec4899, #db2777);
        color: white;
      }
      .btn-earn {
        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        color: white;
      }
      .btn-tax {
        background: linear-gradient(145deg, #ef4444, #dc2626);
        color: white;
      }
      .btn-card {
        background: linear-gradient(145deg, #06b6d4, #0891b2);
        color: white;
      }
      .btn-inventory {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        color: white;
      }
      .btn-shop {
        background: linear-gradient(145deg, #10b981, #059669);
        color: white;
      }
      .btn-insurance {
        background: linear-gradient(145deg, #ec4899, #db2777);
        color: white;
      }

      /* Paski statusu */
      .status-bars {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.08),
          rgba(255, 255, 255, 0.03)
        );
        backdrop-filter: blur(10px);
        border-radius: 18px;
        padding: 14px 18px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .status-bar {
        margin: 10px 0;
      }

      .status-bar:first-child {
        margin-top: 0;
      }
      .status-bar:last-child {
        margin-bottom: 0;
      }

      .status-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8em;
        margin-bottom: 6px;
        color: #ddd;
        font-weight: 500;
      }

      .status-track {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 10px;
        height: 18px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .status-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .status-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        border-radius: 10px 10px 0 0;
      }

      .status-fill.health {
        background: linear-gradient(90deg, #dc2626, #ef4444, #f87171);
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
      }
      .status-fill.food {
        background: linear-gradient(90deg, #d97706, #f59e0b, #fbbf24);
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
      }
      .status-fill.water {
        background: linear-gradient(90deg, #2563eb, #3b82f6, #60a5fa);
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
      }

      .status-value {
        font-size: 0.7em;
        color: #888;
        text-align: right;
        margin-top: 2px;
      }

      /* ==================== SHOP ITEMS ULEPSZONE ==================== */
      /* Sklep/Ekwipunek */
      .shop-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        max-height: 350px;
        overflow-y: auto;
        padding: 8px;
      }

      .shop-item {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.03)
        );
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .shop-item::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(255, 255, 255, 0.05),
          transparent
        );
        transform: rotate(45deg);
        transition: all 0.5s;
        opacity: 0;
      }

      .shop-item:hover {
        border-color: #ff6b35;
        background: linear-gradient(
          145deg,
          rgba(255, 107, 53, 0.2),
          rgba(255, 107, 53, 0.05)
        );
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3),
          0 0 20px rgba(255, 107, 53, 0.1);
      }

      .shop-item:hover::before {
        opacity: 1;
        animation: shine 0.8s ease-out;
      }

      @keyframes shine {
        0% {
          left: -50%;
        }
        100% {
          left: 150%;
        }
      }

      .shop-item .item-icon {
        font-size: 2.2em;
        margin-bottom: 5px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      }
      .shop-item .item-name {
        font-weight: bold;
        font-size: 0.9em;
        margin: 6px 0;
        color: #fff;
      }
      .shop-item .item-stats {
        font-size: 0.75em;
        color: #aaa;
        line-height: 1.4;
      }
      .shop-item .item-stats .positive {
        color: #4ade80;
        font-weight: bold;
      }
      .shop-item .item-stats .negative {
        color: #f87171;
        font-weight: bold;
      }
      .shop-item .item-price {
        margin-top: 8px;
        font-weight: bold;
        color: #ff6b35;
        font-size: 1em;
        text-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
      }

      .inventory-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 14px;
      }

      .inv-tab {
        flex: 1;
        padding: 12px 8px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        color: #888;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.85em;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
      }

      .inv-tab:hover {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.15),
          rgba(255, 255, 255, 0.08)
        );
        color: #fff;
      }

      .inv-tab.active {
        background: linear-gradient(145deg, #ff6b35, #f97316);
        color: white;
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
      }

      /* ==================== GARAGE ITEMS ULEPSZONE ==================== */
      .garage-item {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.03)
        );
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 14px;
        margin: 10px 0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .garage-item:hover {
        border-color: #ff6b35;
        background: linear-gradient(
          145deg,
          rgba(255, 107, 53, 0.15),
          rgba(255, 107, 53, 0.05)
        );
        transform: translateX(5px);
        box-shadow: 0 5px 20px rgba(255, 107, 53, 0.2);
      }

      .garage-item.selected {
        border-color: #4ade80;
        background: linear-gradient(
          145deg,
          rgba(74, 222, 128, 0.15),
          rgba(74, 222, 128, 0.05)
        );
        box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
      }

      .garage-item .car-name {
        font-weight: bold;
        font-size: 1.1em;
        color: #fff;
      }

      .garage-item .car-price {
        color: #4ade80;
        font-size: 0.95em;
        font-weight: bold;
      }

      /* ==================== BEAM PAY CARD ULEPSZONA ==================== */
      .beam-pay-card {
        width: 100%;
        aspect-ratio: 1.6;
        border-radius: 18px;
        background: linear-gradient(
          135deg,
          #1e40af,
          #3b82f6,
          #60a5fa,
          #3b82f6,
          #1e40af
        );
        background-size: 400% 400%;
        animation: cardShine 3s ease infinite;
        padding: 22px;
        position: relative;
        box-shadow: 0 10px 40px rgba(59, 130, 246, 0.5),
          0 0 60px rgba(59, 130, 246, 0.2);
        overflow: hidden;
      }

      .beam-pay-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          transparent 30%,
          rgba(255, 255, 255, 0.1) 50%,
          transparent 70%
        );
        animation: cardGlare 3s ease-in-out infinite;
      }

      @keyframes cardGlare {
        0%,
        100% {
          transform: translateX(-100%) rotate(45deg);
        }
        50% {
          transform: translateX(100%) rotate(45deg);
        }
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 10px;
        overflow-y: auto;
      }

      .modal.active {
        display: flex;
        animation: modalFadeIn 0.3s ease;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: linear-gradient(145deg, #1e293b, #0f172a);
        border-radius: 20px;
        padding: 24px;
        max-width: 450px;
        width: calc(100% - 20px);
        margin: 10px;
        border: 2px solid rgba(255, 107, 53, 0.5);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6),
          0 0 60px rgba(255, 107, 53, 0.1);
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-20px) scale(0.95);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      @media (max-width: 480px) {
        .modal-content {
          padding: 15px;
          border-radius: 12px;
        }
      }

      .modal-content h2 {
        color: #ff6b35;
        text-align: center;
        margin-bottom: 15px;
        font-size: clamp(1.3em, 4vw, 1.6em);
      }

      .modal-close {
        background: #ef4444;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-size: 1em;
        cursor: pointer;
        width: 100%;
        margin-top: 15px;
      }

      .instruction-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .instruction-section h3 {
        color: #ffd700;
        margin-bottom: 8px;
        font-size: 1em;
      }

      .instruction-section ul {
        list-style: none;
      }

      .instruction-section li {
        padding: 6px 0;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
      }

      .instruction-section li:last-child {
        border-bottom: none;
      }

      .price.earn {
        color: #4ade80;
        font-weight: bold;
      }
      .price.cost {
        color: #f87171;
        font-weight: bold;
      }

      .upload-section {
        text-align: center;
      }

      .upload-section > p {
        color: #aaa;
        margin-bottom: 10px;
        font-size: 0.9em;
      }

      .upload-area {
        border: 3px dashed #555;
        border-radius: 15px;
        padding: 25px 15px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s;
      }

      .upload-area:hover,
      .upload-area.dragover {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.1);
      }

      .upload-icon {
        font-size: 2.5em;
        margin-bottom: 5px;
      }

      .preview-image {
        max-width: 100%;
        max-height: 150px;
        border-radius: 10px;
        margin: 10px 0;
        object-fit: contain;
      }

      .ai-response {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        text-align: center;
        display: none;
      }

      .ai-response.active {
        display: block;
      }

      .ai-response .loader {
        width: 35px;
        height: 35px;
        border: 3px solid #333;
        border-top-color: #ff6b35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
        15% {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
        85% {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
      }

      @keyframes fadeUp {
        0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -100%) scale(1.5);
        }
      }

      .ai-response .result-icon {
        font-size: 2.5em;
        margin-bottom: 5px;
      }

      .ai-response .result-text {
        font-size: 1em;
        margin-bottom: 5px;
      }

      .ai-response .result-amount {
        font-size: 2em;
        font-weight: bold;
      }

      .ai-response .result-amount.cost {
        color: #f87171;
      }
      .ai-response .result-amount.earn {
        color: #4ade80;
      }

      .qr-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin: 15px 0;
        text-align: center;
      }

      .qr-section h4 {
        color: #1a1a2e;
        margin-bottom: 10px;
        font-size: 1em;
      }

      .qr-section p {
        color: #666;
        font-size: 0.85em;
        margin-bottom: 15px;
      }

      #qrcode,
      .qr-container {
        display: flex;
        justify-content: center;
        margin: 10px 0;
      }

      .qr-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
      }

      .qr-status.waiting {
        background: rgba(251, 191, 36, 0.2);
        color: #f59e0b;
      }

      .qr-status.success {
        background: rgba(74, 222, 128, 0.2);
        color: #22c55e;
      }

      .qr-status.rejected {
        background: rgba(248, 113, 113, 0.2);
        color: #ef4444;
      }

      .garage-item {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid #444;
        border-radius: 10px;
        padding: 12px;
        margin: 8px 0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .garage-item:hover {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.1);
      }

      .garage-item.selected {
        border-color: #4ade80;
        background: rgba(74, 222, 128, 0.1);
      }

      .garage-item .car-name {
        font-weight: bold;
        font-size: 1.1em;
      }

      .garage-item .car-price {
        color: #4ade80;
        font-size: 0.9em;
      }

      .verify-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
      }

      .verify-page img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 15px;
        margin: 20px 0;
        border: 3px solid #ff6b35;
      }

      .verify-page h2 {
        color: #ff6b35;
        margin-bottom: 10px;
      }

      .verify-page p {
        color: #aaa;
        margin-bottom: 20px;
        font-size: 1.1em;
      }

      .verify-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      .verify-btn {
        padding: 15px 40px;
        font-size: 1.2em;
        font-weight: bold;
        border: none;
        border-radius: 12px;
        cursor: pointer;
      }

      .verify-btn.yes {
        background: linear-gradient(145deg, #4ade80, #22c55e);
        color: white;
      }

      .verify-btn.no {
        background: linear-gradient(145deg, #f87171, #ef4444);
        color: white;
      }

      .verify-result {
        font-size: 3em;
        margin: 30px 0;
      }

      .confirm-btn {
        background: linear-gradient(145deg, #4ade80, #22c55e);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
        display: none;
      }

      .confirm-btn.active {
        display: block;
      }

      .confirm-btn.pay {
        background: linear-gradient(145deg, #f87171, #ef4444);
      }

      .beam-pay-card {
        width: 100%;
        aspect-ratio: 1.6;
        border-radius: 15px;
        background: linear-gradient(
          135deg,
          #1e40af,
          #3b82f6,
          #60a5fa,
          #3b82f6,
          #1e40af
        );
        background-size: 400% 400%;
        animation: cardShine 3s ease infinite;
        padding: 20px;
        position: relative;
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        overflow: hidden;
      }

      @keyframes cardShine {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      .card-logo {
        font-size: 1.2em;
        font-weight: bold;
        color: #fff;
      }

      .card-code {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: clamp(1.5em, 6vw, 2.2em);
        font-weight: bold;
        color: #fff;
        letter-spacing: 8px;
        font-family: "Courier New", monospace;
      }

      .card-balance {
        position: absolute;
        bottom: 15px;
        right: 20px;
        text-align: right;
      }

      .card-balance .label {
        font-size: 0.7em;
        color: rgba(255, 255, 255, 0.7);
      }

      .card-balance .amount {
        font-size: 1.2em;
        font-weight: bold;
        color: #fff;
      }

      .card-settings {
        margin-top: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 12px;
      }

      .card-settings h4 {
        color: #ffd700;
        margin-bottom: 10px;
        font-size: 0.95em;
      }

      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #333;
        font-size: 0.9em;
      }

      .setting-row:last-child {
        border-bottom: none;
      }

      .setting-label {
        color: #aaa;
      }
      .setting-value {
        font-weight: bold;
        color: #fff;
      }

      .limit-bar {
        width: 100%;
        height: 8px;
        background: #333;
        border-radius: 4px;
        margin-top: 8px;
        overflow: hidden;
      }

      .limit-fill {
        height: 100%;
        background: linear-gradient(90deg, #4ade80, #fbbf24, #ef4444);
        transition: width 0.3s;
      }

      .card-btn {
        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.85em;
        cursor: pointer;
        margin-top: 8px;
        width: 100%;
      }

      .tax-info {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid #ef4444;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .tax-info h4 {
        color: #ef4444;
        margin-bottom: 10px;
      }

      .tax-stat {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 0.9em;
      }

      .tax-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
        border-radius: 10px;
        margin: 10px 0;
      }

      .toggle-switch {
        width: 50px;
        height: 26px;
        background: #333;
        border-radius: 13px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
      }

      .toggle-switch.active {
        background: #4ade80;
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        width: 22px;
        height: 22px;
        background: #fff;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }

      .toggle-switch.active::after {
        transform: translateX(24px);
      }

      .pin-display {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 15px 0;
      }

      .pin-digit {
        width: 40px;
        height: 50px;
        background: #1a1a1a;
        border: 2px solid #444;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: bold;
        color: #fff;
      }

      .pin-digit.filled {
        border-color: #4ade80;
      }

      .pin-keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        max-width: 220px;
        margin: 0 auto;
      }

      .pin-key {
        padding: 12px;
        font-size: 1.3em;
        border: none;
        border-radius: 8px;
        background: #333;
        color: #fff;
        cursor: pointer;
      }

      .pin-key:active {
        transform: scale(0.95);
      }

      .pin-key.delete {
        background: #ef4444;
      }
      .pin-key.confirm {
        background: #4ade80;
      }

      .lang-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        max-height: 400px;
        overflow-y: auto;
      }

      .lang-option {
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #333;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        font-size: 0.85em;
        transition: all 0.2s;
      }

      .lang-option:hover,
      .lang-option.selected {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.2);
      }

      .input-group {
        margin: 10px 0;
      }

      .input-group label {
        display: block;
        color: #aaa;
        margin-bottom: 5px;
        font-size: 0.9em;
      }

      .input-group input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #444;
        background: #1a1a1a;
        color: #fff;
        font-size: 1.1em;
        text-align: center;
      }

      .input-group input:focus {
        outline: none;
        border-color: #ff6b35;
      }

      .ocr-progress {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        height: 6px;
        margin-top: 10px;
        overflow: hidden;
      }

      .ocr-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ff6b35, #ffd700);
        width: 0%;
        transition: width 0.3s;
      }

      @media (max-width: 400px) {
        .buttons-grid {
          gap: 8px;
        }

        .btn {
          padding: 12px 8px;
        }

        .btn-icon {
          font-size: 1.5em;
        }

        .pin-digit {
          width: 35px;
          height: 45px;
          font-size: 1.3em;
        }

        .pin-keypad {
          max-width: 180px;
        }

        .pin-key {
          padding: 10px;
          font-size: 1.1em;
        }
      }
    </style>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <!-- Ekran blokady dla urządzeń mobilnych -->
    <div id="mobileBlockScreen">
      <div class="block-icon">📵</div>
      <h1 id="mobileBlockTitle">Gra niedostępna na urządzeniach mobilnych</h1>
      <p id="mobileBlockText">
        Ze względu na złożoność mechanik i interfejsu, optymalizacja tej gry na
        urządzenia mobilne nie jest możliwa.
        <br /><br />
        Gra wymaga precyzyjnego sterowania i dużego ekranu, które są dostępne
        tylko na komputerach stacjonarnych i laptopach.
        <br /><br />
        Zapraszamy do gry na komputerze! 🖥️
      </p>
      <div class="desktop-icon">💻</div>
    </div>

    <div id="gameContainer">
      <div class="container">
        <header>
          <div class="header-btns-left">
            <button
              class="lang-btn"
              onclick="openModal('saves')"
              title="Save'y"
            >
              💾
            </button>
            <button
              class="lang-btn"
              onclick="openModal('vouchers')"
              title="Bony"
            >
              🎁
            </button>
          </div>
          <div class="header-btns-right">
            <button
              class="lang-btn"
              onclick="openModal('onlineAccount')"
              title="Konto online"
              id="onlineAccountBtn"
            >
              👤
            </button>
            <button
              class="lang-btn"
              onclick="openModal('language')"
              title="Język"
            >
              🌐
            </button>
          </div>
          <div onclick="openModal('gameMode')" style="cursor: pointer">
            <h1 id="gameModeTitle">🚗 BeamNG Drive</h1>
            <h2 id="gameModeSubtitle">Datapack</h2>
          </div>
          <div
            id="currentSaveDisplay"
            style="font-size: 0.8em; color: #888; margin-top: 5px"
          ></div>
        </header>

        <div class="money-display">
          <h3>💰 <span data-translate="yourMoney">TWOJE PIENIĄDZE</span></h3>
          <div class="money-amount" id="moneyDisplay">50 000 zł</div>

          <div class="debt-display" id="debtDisplay">
            <h4>⚠️ <span data-translate="debt">DŁUG</span></h4>
            <div class="debt-amount" id="debtAmount">0 zł</div>
            <div class="debt-deadline" id="debtDeadline"></div>
          </div>
        </div>

        <!-- Paski statusu -->
        <div class="status-bars">
          <div class="status-bar">
            <div class="status-label">
              ❤️ <span data-translate="health">Zdrowie</span>
            </div>
            <div class="status-track">
              <div
                class="status-fill health"
                id="healthBar"
                style="width: 100%"
              ></div>
            </div>
            <div class="status-value" id="healthValue">100/100</div>
          </div>
          <div class="status-bar">
            <div class="status-label">
              🍔 <span data-translate="food">Jedzenie</span>
            </div>
            <div class="status-track">
              <div
                class="status-fill food"
                id="foodBar"
                style="width: 100%"
              ></div>
            </div>
            <div class="status-value" id="foodValue">1000/1000 kcal</div>
          </div>
          <div class="status-bar">
            <div class="status-label">
              💧 <span data-translate="water">Picie</span>
            </div>
            <div class="status-track">
              <div
                class="status-fill water"
                id="waterBar"
                style="width: 100%"
              ></div>
            </div>
            <div class="status-value" id="waterValue">1000/1000 ml</div>
          </div>
        </div>

        <div class="buttons-grid">
          <button
            class="btn btn-instruction"
            onclick="openModal('instruction')"
          >
            <span class="btn-icon">📖</span>
            <span data-translate="instructions">Instrukcja</span>
          </button>
          <button class="btn btn-earn" onclick="openModal('work')">
            <span class="btn-icon">💼</span>
            <span data-translate="work">Praca</span>
          </button>
          <button class="btn btn-repair" onclick="openModal('repair')">
            <span class="btn-icon">🔧</span>
            <span data-translate="repair">Napraw Auto</span>
          </button>
          <button class="btn btn-buy" onclick="openModal('buy')">
            <span class="btn-icon">🚙</span>
            <span data-translate="buyCar">Kup Auto</span>
          </button>
          <button class="btn btn-sell" onclick="openModal('sell')">
            <span class="btn-icon">💸</span>
            <span data-translate="sellCar">Sprzedaj Auto</span>
          </button>
          <button class="btn btn-shop" onclick="openModal('shop')">
            <span class="btn-icon">🛒</span>
            <span data-translate="shop">Sklep</span>
          </button>
          <button class="btn btn-inventory" onclick="openModal('inventory')">
            <span class="btn-icon">🎒</span>
            <span data-translate="inventory">Ekwipunek</span>
          </button>
          <button
            class="btn"
            onclick="openModal('garage')"
            style="background: linear-gradient(145deg, #6366f1, #4f46e5)"
          >
            <span class="btn-icon">🚗</span>
            <span data-translate="garage">Garaż</span>
          </button>
          <button class="btn btn-insurance" onclick="openModal('insurance')">
            <span class="btn-icon">🏥</span>
            <span data-translate="insurance">Ubezpieczenia</span>
          </button>
          <button
            class="btn"
            onclick="openModal('business')"
            style="background: linear-gradient(145deg, #f59e0b, #d97706)"
          >
            <span class="btn-icon">🏢</span>
            <span data-translate="business">Firmy</span>
          </button>
          <button
            class="btn"
            onclick="openModal('bank')"
            style="background: linear-gradient(145deg, #10b981, #059669)"
          >
            <span class="btn-icon">🏦</span>
            <span data-translate="bank">Bank</span>
          </button>
          <button class="btn btn-tax" onclick="openModal('tax')">
            <span class="btn-icon">🏛️</span>
            <span data-translate="taxes">Podatki</span>
          </button>
          <button class="btn btn-card" onclick="openModal('card')">
            <span class="btn-icon">💳</span>
            <span data-translate="card">Karta Beam-Pay</span>
          </button>
        </div>
      </div>

      <!-- Modal Instrukcja -->
      <div class="modal" id="modalInstruction">
        <div class="modal-content">
          <h2>📖 <span data-translate="instructions">Instrukcja</span></h2>

          <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px">
            <div class="instruction-section">
              <h3>💼 <span data-translate="workSystem">System pracy</span></h3>
              <p
                style="color: #aaa; font-size: 0.9em; margin-bottom: 10px"
                data-translate="workDesc"
              >
                Wybierz zawód i pracuj 2 minuty w mini-grze:
              </p>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      margin-bottom: 4px;
                    "
                  >
                    <span>🧹 Sprzątacz → 👨‍⚕️ Chirurg</span>
                    <span style="color: #4ade80">500 - 7000 zł</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="jobsRange"
                    >13 zawodów od łatwych do trudnych</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #f59e0b; margin-bottom: 4px">
                    💰 <span data-translate="coinGame">Łapanie monet</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="coinGameDesc"
                    >Klikaj spadające monety +100 zł za każdą!</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #ef4444; margin-bottom: 4px">
                    😴 <span data-translate="sleepMechanic">Zasypianie</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="sleepMechanicDesc"
                    >Trzymaj ekran żeby nie zasnąć! Spanie = strata do 90%
                    zarobku</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>
                🚗 <span data-translate="garageSystem">System garażu</span>
              </h3>
              <p
                style="color: #aaa; font-size: 0.9em; margin-bottom: 10px"
                data-translate="garageDesc"
              >
                Kupuj, ulepszaj i sprzedawaj auta:
              </p>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #6366f1; margin-bottom: 4px">
                    ⬆️ <span data-translate="upgrading">Ulepszanie</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="upgradeInfo"
                    >Kliknij raz - auto ulepsza się w tle. Wartość rośnie (50% →
                    1000%)</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #ef4444; margin-bottom: 4px">
                    💥 <span data-translate="breakRisk">Ryzyko zepsucia</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="breakInfo"
                    >0.5%/s szansy na zepsucie. Koszt: 150 zł + -5%
                    wartości</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #10b981; margin-bottom: 4px">
                    💰 <span data-translate="selling">Sprzedaż</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="sellInfo"
                    >Cena = cena bazowa × procent ulepszenia</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>
                💳 <span data-translate="payments">Płatności i opłaty</span>
              </h3>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(239, 68, 68, 0.1);
                    border-radius: 8px;
                    margin-bottom: 6px;
                    display: flex;
                    justify-content: space-between;
                    border: 1px solid #ef4444;
                  "
                >
                  <span>🏛️ <span data-translate="taxes">Podatki</span></span>
                  <span style="color: #ef4444">-500 zł / 5 min</span>
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #f59e0b; margin-bottom: 4px">
                    ⚡ <span data-translate="autoPay">Auto-płatność</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="autoPayInfo2"
                    >Włącz w ustawieniach karty - automatycznie płaci podatki i
                    ubezpieczenia</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #ef4444; margin-bottom: 4px">
                    ⚠️ <span data-translate="debtSystem">System długów</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="debtInfo2"
                    >Brak kasy = dług. Masz 7 dni na spłatę!</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>🛡️ <span data-translate="insurances">Ubezpieczenia</span></h3>
              <p
                style="color: #aaa; font-size: 0.9em; margin-bottom: 10px"
                data-translate="insuranceDesc"
              >
                Różne pakiety dające bonusy:
              </p>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #4ade80">❤️🍔💧</span>
                  <span data-translate="healthIns">Zdrowotne</span> -
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="healthInsDesc"
                    >regeneracja HP, jedzenia, picia</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #6366f1">🔧⚙️</span>
                  <span data-translate="upgradeIns">Na ulepszanie</span> -
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="upgradeInsDesc"
                    >szybsze ulepszanie, mniejsza szansa zepsucia</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #f59e0b">🛡️🩹</span>
                  <span data-translate="repairIns">Na naprawę</span> -
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="repairInsDesc"
                    >pokrywa 30-100% kosztów naprawy</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>❤️ <span data-translate="survival">Przetrwanie</span></h3>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #ef4444"
                    >🍔 <span data-translate="hungerDrain">Głód</span>:</span
                  >
                  <span style="color: #888; font-size: 0.85em"
                    >-10 kcal / 5 min</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span style="color: #3b82f6"
                    >💧
                    <span data-translate="thirstDrain">Pragnienie</span>:</span
                  >
                  <span style="color: #888; font-size: 0.85em"
                    >-15 ml / 5 min</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(239, 68, 68, 0.2);
                    border-radius: 8px;
                    margin-bottom: 6px;
                    border: 1px solid #ef4444;
                  "
                >
                  <div style="color: #ef4444; margin-bottom: 4px">
                    💀 <span data-translate="death">Śmierć</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="deathDesc"
                    >Głód/woda = 0 → tracisz HP. HP = 0 → zginiesz i wrócisz do
                    checkpointu!</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="survivalTip"
                    >Kupuj jedzenie i napoje w sklepie, lub wykup
                    ubezpieczenie!</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>
                💾
                <span data-translate="checkpointSystem"
                  >System checkpointów</span
                >
              </h3>
              <ul style="list-style: none; padding: 0">
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #10b981; margin-bottom: 4px">
                    💾
                    <span data-translate="createCheckpointInfo">Tworzenie</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="createCheckpointDesc"
                    >W menu Save'ów kliknij "Zapisz checkpoint" żeby zapisać
                    aktualny postęp</span
                  >
                </li>
                <li
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    margin-bottom: 6px;
                  "
                >
                  <div style="color: #f59e0b; margin-bottom: 4px">
                    🔄 <span data-translate="respawn">Odrodzenie</span>
                  </div>
                  <span
                    style="color: #888; font-size: 0.85em"
                    data-translate="respawnDesc"
                    >Po śmierci wrócisz do checkpointu. Brak checkpointu = reset
                    postępu!</span
                  >
                </li>
              </ul>
            </div>

            <div class="instruction-section">
              <h3>
                🎁 <span data-translate="voucherSystem">System bonów</span>
              </h3>
              <p
                style="color: #aaa; font-size: 0.9em"
                data-translate="voucherDesc"
              >
                Twórz bony pieniężne i wysyłaj znajomym przez WhatsApp,
                Messenger, Email lub SMS. Pieniądze pobierane są dopiero gdy
                odbiorca zaakceptuje bon.
              </p>
            </div>

            <div class="instruction-section">
              <h3>🎮 <span data-translate="gameModes">Tryby gry</span></h3>
              <p
                style="color: #aaa; font-size: 0.9em"
                data-translate="gameModesDesc"
              >
                Kliknij tytuł gry aby przełączyć między trybem BeamNG (fikcyjne
                auta) a Real Life (prawdziwe marki). Każdy tryb ma osobny
                postęp!
              </p>
            </div>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('instruction')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Zarobek -->
      <div class="modal" id="modalEarn">
        <div class="modal-content">
          <h2>🛣️ <span data-translate="earnKm">Zarobek za kilometry</span></h2>

          <div class="upload-section">
            <div class="ai-response active" id="earnResponse">
              <div class="result-icon">🛣️</div>
              <div class="result-text" data-translate="enterKm">
                Wpisz przejechane kilometry:
              </div>
              <input
                type="number"
                id="kmInput"
                step="0.1"
                min="0.1"
                style="
                  width: 120px;
                  padding: 12px;
                  font-size: 1.2em;
                  border-radius: 8px;
                  border: 2px solid #ff6b35;
                  text-align: center;
                  margin: 10px 0;
                  background: #1a1a2e;
                  color: white;
                "
                placeholder="km"
              />
              <div style="color: #888; font-size: 0.9em">
                × 100 zł = <span id="kmCalc" style="color: #4ade80">0</span> zł
              </div>
            </div>

            <button class="confirm-btn" id="earnBtn" onclick="confirmEarn()">
              💰 <span data-translate="collectEarnings">Odbierz zarobek</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('earn')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Naprawa -->
      <div class="modal" id="modalRepair">
        <div class="modal-content">
          <h2>🔧 <span data-translate="repair">Napraw Auto</span></h2>

          <div class="upload-section">
            <p>
              <span data-translate="selectCarToRepair"
                >Wybierz auto do naprawy:</span
              >
            </p>

            <div
              id="repairCarList"
              style="max-height: 300px; overflow-y: auto; margin-bottom: 15px"
            ></div>

            <div class="ai-response" id="repairResponse" style="display: none">
              <div class="result-icon">🔧</div>
              <div class="result-text" data-translate="repairCostInfo">
                Koszt naprawy:
              </div>
              <div class="result-amount cost" id="repairCostDisplay">
                -5,000 zł
              </div>
            </div>

            <button
              class="confirm-btn pay"
              id="repairBtn"
              onclick="confirmRepair()"
              style="display: none"
            >
              🔧 <span data-translate="payAndRepair">Zapłać i napraw</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('repair')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Kup Auto -->
      <div class="modal" id="modalBuy">
        <div class="modal-content">
          <h2>🚙 <span data-translate="buyCar">Kup Auto</span></h2>

          <!-- Wyszukiwarka -->
          <input
            type="text"
            id="carSearchInput"
            placeholder="🔍 Szukaj auta..."
            style="
              width: 100%;
              padding: 12px;
              font-size: 1em;
              border-radius: 10px;
              border: 2px solid #444;
              background: #1a1a2e;
              color: white;
              margin-bottom: 15px;
            "
            oninput="filterCars()"
          />

          <!-- Lista aut -->
          <div
            class="shop-grid"
            id="carBuyGrid"
            style="max-height: 400px"
          ></div>

          <button
            class="modal-close"
            onclick="closeModal('buy')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Sprzedaj Auto -->
      <div class="modal" id="modalSell">
        <div class="modal-content">
          <h2>💸 <span data-translate="sellCar">Sprzedaj Auto</span></h2>

          <p
            style="color: #888; text-align: center; margin-bottom: 15px"
            data-translate="get50percent"
          >
            Dostaniesz 50% wartości
          </p>

          <div id="sellGarageSection">
            <div
              id="sellGarageList"
              style="max-height: 350px; overflow-y: auto"
            ></div>
          </div>

          <div
            id="sellEmptyGarage"
            style="
              text-align: center;
              padding: 30px;
              color: #888;
              display: none;
            "
          >
            <div style="font-size: 3em">🅿️</div>
            <p data-translate="noCarInGarage">Nie masz żadnych aut w garażu</p>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('sell')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Sklep -->
      <div class="modal" id="modalShop">
        <div class="modal-content">
          <h2>🛒 <span data-translate="shop">Sklep</span></h2>

          <!-- Zakładki -->
          <div class="inventory-tabs">
            <button class="inv-tab active" onclick="showShopTab('food')">
              🍔 <span data-translate="foodTab">Jedzenie</span>
            </button>
            <button class="inv-tab" onclick="showShopTab('drinks')">
              🥤 <span data-translate="drinksTab">Napoje</span>
            </button>
          </div>

          <!-- Produkty do kupienia -->
          <div class="shop-grid" id="shopGrid"></div>

          <button
            class="modal-close"
            onclick="closeModal('shop')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Ekwipunek (Plecak) -->
      <!-- Modal Garaż -->
      <div class="modal" id="modalGarage">
        <div class="modal-content">
          <h2>🚗 <span data-translate="garage">Garaż</span></h2>

          <div
            id="garageEmpty"
            style="
              text-align: center;
              padding: 30px;
              color: #888;
              display: none;
            "
          >
            <div style="font-size: 3em">🚗</div>
            <p data-translate="noCarInGarage">Brak aut w garażu</p>
            <p
              style="font-size: 0.85em; margin-top: 5px"
              data-translate="buyCarFirst"
            >
              Kup auto w salonie!
            </p>
          </div>

          <div id="garageList" style="max-height: 60vh; overflow-y: auto"></div>

          <button
            class="modal-close"
            onclick="closeModal('garage')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Ulepszanie Auta -->
      <div class="modal" id="modalUpgrade">
        <div class="modal-content">
          <h2>🔧 <span data-translate="upgradeCar">Ulepszanie</span></h2>

          <div
            id="upgradeCarInfo"
            style="text-align: center; margin-bottom: 15px"
          ></div>

          <div
            style="
              background: rgba(0, 0, 0, 0.3);
              border-radius: 10px;
              padding: 15px;
              margin-bottom: 15px;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
              "
            >
              <span data-translate="sellValue">Wartość sprzedaży:</span>
              <span
                id="upgradeSellPercent"
                style="color: #4ade80; font-weight: bold"
                >50%</span
              >
            </div>
            <div
              style="
                width: 100%;
                height: 20px;
                background: #333;
                border-radius: 10px;
                overflow: hidden;
              "
            >
              <div
                id="upgradeProgressBar"
                style="
                  width: 5%;
                  height: 100%;
                  background: linear-gradient(90deg, #ef4444, #f59e0b, #4ade80);
                  transition: width 0.1s;
                "
              ></div>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                font-size: 0.8em;
                color: #888;
                margin-top: 5px;
              "
            >
              <span>50%</span>
              <span>1000%</span>
            </div>
          </div>

          <div
            id="upgradeStatus"
            style="
              text-align: center;
              margin-bottom: 15px;
              padding: 10px;
              background: rgba(0, 0, 0, 0.2);
              border-radius: 8px;
            "
          ></div>

          <button
            id="upgradeBtn"
            onclick="toggleUpgrade()"
            style="
              width: 100%;
              padding: 15px;
              background: #10b981;
              color: white;
              border: none;
              border-radius: 10px;
              font-size: 1.1em;
              cursor: pointer;
              margin-bottom: 10px;
            "
          >
            ▶️ <span data-translate="startUpgrade">Rozpocznij ulepszanie</span>
          </button>

          <div
            style="
              background: rgba(239, 68, 68, 0.1);
              border: 1px solid #ef4444;
              border-radius: 8px;
              padding: 10px;
              margin-bottom: 15px;
            "
          >
            <p style="font-size: 0.85em; color: #ef4444; text-align: center">
              ⚠️
              <span data-translate="upgradeWarning"
                >Podczas ulepszania auto może się zepsuć! (150 zł + -5%)</span
              >
            </p>
          </div>

          <button
            class="modal-close"
            onclick="closeUpgradeModal()"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Praca -->
      <div class="modal" id="modalWork">
        <div class="modal-content">
          <h2>💼 <span data-translate="work">Praca</span></h2>

          <p
            style="color: #888; text-align: center; margin-bottom: 15px"
            data-translate="chooseJob"
          >
            Wybierz pracę:
          </p>

          <div id="jobsList" style="max-height: 50vh; overflow-y: auto"></div>

          <button
            class="modal-close"
            onclick="closeModal('work')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Mini-gra Praca -->
      <div class="modal" id="modalWorkGame">
        <div
          class="modal-content"
          style="
            max-width: 100%;
            width: 100%;
            height: 90vh;
            padding: 10px;
            position: relative;
            overflow: hidden;
          "
        >
          <div
            id="workGameHeader"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <span
              id="workJobName"
              style="font-size: 1.2em; font-weight: bold"
            ></span>
            <div style="display: flex; align-items: center; gap: 15px">
              <span id="workTimer" style="font-size: 1.5em; color: #f59e0b"
                >2:00</span
              >
              <button
                onclick="quitWorkEarly()"
                style="
                  padding: 8px 15px;
                  background: #ef4444;
                  color: white;
                  border: none;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 0.9em;
                "
              >
                ⏹️ Przerwij (-3%)
              </button>
            </div>
          </div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 10px;
            "
          >
            <span>💰 <span id="workEarned">0</span> zł</span>
            <span
              >📈 +<span id="workBonus">0</span> zł
              <span data-translate="bonus">bonus</span></span
            >
          </div>

          <!-- Obszar gry -->
          <div
            id="workGameArea"
            style="
              position: relative;
              width: 100%;
              height: calc(100% - 120px);
              background: #1a1a2e;
              border-radius: 10px;
              overflow: hidden;
            "
          >
            <!-- Ciemnienie (zasypianie) -->
            <div
              id="sleepOverlayTop"
              style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 0;
                background: linear-gradient(to bottom, #000, transparent);
                pointer-events: none;
                z-index: 10;
              "
            ></div>
            <div
              id="sleepOverlayBottom"
              style="
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 0;
                background: linear-gradient(to top, #000, transparent);
                pointer-events: none;
                z-index: 10;
              "
            ></div>

            <!-- Spadające pieniądze -->
            <div
              id="coinsContainer"
              style="position: absolute; top: 0; left: 0; right: 0; bottom: 0"
            ></div>
          </div>

          <!-- Przycisk "nie zasypiaj" - trzeba TRZYMAĆ -->
          <button
            id="wakeUpBtn"
            onmousedown="startWakeUp()"
            onmouseup="stopWakeUp()"
            onmouseleave="stopWakeUp()"
            ontouchstart="startWakeUp()"
            ontouchend="stopWakeUp()"
            style="
              position: absolute;
              bottom: 20px;
              left: 50%;
              transform: translateX(-50%);
              padding: 15px 40px;
              background: #ef4444;
              color: white;
              border: none;
              border-radius: 50px;
              font-size: 1.2em;
              cursor: pointer;
              z-index: 20;
              user-select: none;
              -webkit-user-select: none;
            "
          >
            👁️ <span data-translate="stayAwake">Trzymaj żeby nie zasnąć!</span>
          </button>
        </div>
      </div>

      <div class="modal" id="modalInventory">
        <div class="modal-content">
          <h2>🎒 <span data-translate="inventory">Ekwipunek</span></h2>

          <!-- Status gracza -->
          <div
            style="
              background: rgba(0, 0, 0, 0.3);
              border-radius: 10px;
              padding: 12px;
              margin-bottom: 15px;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span>❤️ <span data-translate="health">Zdrowie</span></span>
              <span id="invHealth">100/100 HP</span>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span>🍔 <span data-translate="food">Jedzenie</span></span>
              <span id="invFood">1000/1000 kcal</span>
            </div>
            <div style="display: flex; justify-content: space-between">
              <span>💧 <span data-translate="water">Picie</span></span>
              <span id="invWater">1000/1000 ml</span>
            </div>
          </div>

          <!-- Zawartość plecaka -->
          <h4 style="margin-bottom: 10px">
            📦 <span data-translate="backpackContents">Zawartość plecaka:</span>
          </h4>
          <div class="shop-grid" id="backpackGrid"></div>

          <div
            id="emptyBackpack"
            style="
              text-align: center;
              padding: 30px;
              color: #888;
              display: none;
            "
          >
            <div style="font-size: 3em">🎒</div>
            <p data-translate="emptyBackpack">Plecak jest pusty</p>
            <p
              style="font-size: 0.85em; margin-top: 5px"
              data-translate="goToShop"
            >
              Idź do sklepu kupić jedzenie!
            </p>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('inventory')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Ubezpieczenia -->
      <div class="modal" id="modalInsurance">
        <div class="modal-content">
          <h2>🏥 <span data-translate="insurance">Ubezpieczenia</span></h2>

          <!-- Aktywne ubezpieczenia -->
          <div
            id="activeInsurancesSection"
            style="margin-bottom: 15px; display: none"
          >
            <h4 style="color: #4ade80; margin-bottom: 10px">
              ✅
              <span data-translate="activeInsurances"
                >Aktywne ubezpieczenia</span
              >
              (<span id="activeCount">0</span>)
            </h4>
            <div
              id="activeInsurancesList"
              style="max-height: 150px; overflow-y: auto"
            ></div>
          </div>

          <p
            style="color: #888; text-align: center; margin-bottom: 10px"
            data-translate="chooseInsurance"
          >
            Wybierz pakiet:
          </p>

          <!-- Lista pakietów -->
          <div
            id="insuranceList"
            style="max-height: 300px; overflow-y: auto"
          ></div>

          <button
            class="modal-close"
            onclick="closeModal('insurance')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal wyboru okresu ubezpieczenia -->
      <div class="modal" id="modalInsurancePeriod">
        <div class="modal-content">
          <h2>📅 <span data-translate="choosePeriod">Wybierz okres</span></h2>

          <div
            id="insurancePeriodDetails"
            style="text-align: center; margin-bottom: 15px"
          ></div>

          <div
            id="periodOptions"
            style="display: flex; flex-direction: column; gap: 10px"
          ></div>

          <button
            class="modal-close"
            onclick="closeModal('insurancePeriod')"
            data-translate="cancel"
          >
            Anuluj
          </button>
        </div>
      </div>

      <!-- Modal szczegółów ubezpieczenia -->
      <div class="modal" id="modalInsuranceDetails">
        <div class="modal-content">
          <h2>📋 <span data-translate="insuranceDetails">Szczegóły</span></h2>

          <div id="insuranceDetailsContent"></div>

          <button
            class="modal-close"
            onclick="closeModal('insuranceDetails')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Podatki -->
      <div class="modal" id="modalTax">
        <div class="modal-content">
          <h2>🏛️ <span data-translate="taxes">Podatki</span></h2>

          <div class="tax-info">
            <h4>
              <span data-translate="taxInfo">Informacje o podatkach</span>
            </h4>
            <div class="tax-stat">
              <span data-translate="taxRate">System:</span>
              <span class="price" style="color: #4ade80"
                >Podatek dzienny od pracy</span
              >
            </div>
            <div class="tax-stat">
              <span>Bazowa stawka:</span>
              <span class="price cost">5% od zarobków</span>
            </div>
            <div class="tax-stat">
              <span>Za każdą dodatkową pracę:</span>
              <span class="price cost">+2%</span>
            </div>
            <div class="tax-stat">
              <span>Maksymalna stawka:</span>
              <span class="price cost">25%</span>
            </div>
            <div class="tax-stat">
              <span data-translate="totalPaid">Zapłacono łącznie:</span>
              <span id="totalTaxPaid">0 zł</span>
            </div>
          </div>

          <div
            style="
              background: rgba(59, 130, 246, 0.1);
              border: 1px solid #3b82f6;
              padding: 15px;
              border-radius: 10px;
              margin: 15px 0;
            "
          >
            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 10px">
              ℹ️ Jak działa nowy system?
            </div>
            <p style="font-size: 0.85em; color: #aaa; margin: 0">
              Podatek naliczany jest raz dziennie (realnie) od zarobków z pracy.
              Im więcej razy pracujesz w ciągu dnia, tym wyższa stawka
              podatkowa. Paragon podatkowy pojawi się gdy wejdziesz do gry
              następnego dnia.
            </p>
          </div>

          <div class="instruction-section">
            <h3>
              ⚠️ <span data-translate="debtInfo">Informacje o długu</span>
            </h3>
            <p style="font-size: 0.9em; color: #aaa" data-translate="debtDesc">
              Jeśli zabraknie pieniędzy na podatek, powstanie dług. Masz 7 dni
              na spłatę długu.
            </p>
            <div class="tax-stat" style="margin-top: 10px">
              <span data-translate="currentDebt">Aktualny dług:</span>
              <span id="currentDebt" class="price cost">0 zł</span>
            </div>
          </div>

          <button
            class="confirm-btn active"
            onclick="payDebt()"
            id="payDebtBtn"
            style="display: none"
          >
            💳 <span data-translate="payDebt">Spłać dług</span>
          </button>

          <button
            class="modal-close"
            onclick="closeModal('tax')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Karta -->
      <div class="modal" id="modalCard">
        <div class="modal-content">
          <h2>💳 <span data-translate="card">Karta Beam-Pay</span></h2>

          <div class="beam-pay-card">
            <div class="card-logo">Beam-Pay</div>
            <div class="card-code" id="cardCode">000000</div>
            <div class="card-balance">
              <div class="label" data-translate="balance">Saldo</div>
              <div class="amount" id="cardBalance">50 000 zł</div>
            </div>
          </div>

          <div class="card-settings">
            <h4>
              ⚙️ <span data-translate="cardSettings">Ustawienia karty</span>
            </h4>

            <div class="setting-row">
              <span class="setting-label" data-translate="spendingLimit"
                >Limit wydatków:</span
              >
              <span class="setting-value" id="limitValue">10 000 zł</span>
            </div>

            <div class="setting-row">
              <span class="setting-label" data-translate="spent"
                >Wydano z limitu:</span
              >
              <span class="setting-value" id="spentValue">0 zł</span>
            </div>

            <div class="setting-row">
              <span class="setting-label" data-translate="remaining"
                >Pozostało:</span
              >
              <span class="setting-value" id="remainingValue">10 000 zł</span>
            </div>

            <div class="limit-bar">
              <div class="limit-fill" id="limitBar" style="width: 0%"></div>
            </div>

            <button class="card-btn" onclick="openModal('setLimit')">
              <span data-translate="setLimit">📊 Ustaw limit</span>
            </button>
            <button
              class="card-btn"
              onclick="pendingAction = 'resetLimit'; openModal('pin');"
            >
              <span data-translate="resetSpent">🔄 Resetuj wydatki</span>
            </button>

            <div
              style="
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #444;
              "
            >
              <h4 style="margin-bottom: 10px">
                💳
                <span data-translate="autoPayments"
                  >Automatyczne płatności</span
                >
              </h4>
              <p
                style="font-size: 0.8em; color: #888; margin-bottom: 10px"
                data-translate="autoPayInfo"
              >
                Podatki i ubezpieczenia nie liczą się do limitu
              </p>

              <div id="insuranceAutoPayList"></div>

              <div
                id="noInsurancesCard"
                style="
                  text-align: center;
                  color: #888;
                  padding: 10px;
                  display: none;
                "
              >
                <span data-translate="noActiveInsurance"
                  >Brak aktywnych ubezpieczeń</span
                >
              </div>
            </div>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('card')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Ustaw Limit -->
      <div class="modal" id="modalSetLimit">
        <div class="modal-content">
          <h2>
            📊 <span data-translate="setLimit">Ustaw limit wydatków</span>
          </h2>

          <div class="input-group">
            <label data-translate="newLimit">Nowy limit (zł)</label>
            <input
              type="number"
              id="newLimitInput"
              min="100"
              placeholder="np. 10000"
            />
          </div>

          <button class="confirm-btn active" onclick="setNewLimit()">
            ✅ <span data-translate="setLimitBtn">Ustaw limit</span>
          </button>
          <button
            class="modal-close"
            onclick="closeModal('setLimit')"
            data-translate="cancel"
          >
            Anuluj
          </button>
        </div>
      </div>

      <!-- Modal PIN -->
      <div class="modal" id="modalPin">
        <div class="modal-content">
          <h2>🔐 <span data-translate="enterPin">Wpisz PIN</span></h2>
          <p
            style="
              text-align: center;
              color: #aaa;
              margin-bottom: 10px;
              font-size: 0.9em;
            "
            data-translate="enter6digitPin"
          >
            Wpisz 6-cyfrowy PIN z karty Beam-Pay
          </p>

          <div class="pin-display">
            <div class="pin-digit" id="pin1"></div>
            <div class="pin-digit" id="pin2"></div>
            <div class="pin-digit" id="pin3"></div>
            <div class="pin-digit" id="pin4"></div>
            <div class="pin-digit" id="pin5"></div>
            <div class="pin-digit" id="pin6"></div>
          </div>

          <div class="pin-keypad">
            <button class="pin-key" onclick="addPinDigit('1')">1</button>
            <button class="pin-key" onclick="addPinDigit('2')">2</button>
            <button class="pin-key" onclick="addPinDigit('3')">3</button>
            <button class="pin-key" onclick="addPinDigit('4')">4</button>
            <button class="pin-key" onclick="addPinDigit('5')">5</button>
            <button class="pin-key" onclick="addPinDigit('6')">6</button>
            <button class="pin-key" onclick="addPinDigit('7')">7</button>
            <button class="pin-key" onclick="addPinDigit('8')">8</button>
            <button class="pin-key" onclick="addPinDigit('9')">9</button>
            <button class="pin-key delete" onclick="deletePinDigit()">⌫</button>
            <button class="pin-key" onclick="addPinDigit('0')">0</button>
            <button class="pin-key confirm" onclick="confirmPin()">✓</button>
          </div>

          <div
            id="forgotPinBtnContainer"
            style="display: none; margin-top: 10px"
          >
            <button
              onclick="forgotPinAuction()"
              style="
                width: 100%;
                padding: 12px;
                background: #f59e0b;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              ❓ <span data-translate="forgotPin">Nie pamiętam PIN</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('pin'); pendingAction = null; pendingAuctionId = null;"
            data-translate="cancel"
          >
            Anuluj
          </button>
        </div>
      </div>

      <!-- Modal Limit Exceeded -->
      <div class="modal" id="modalLimitExceeded">
        <div class="modal-content">
          <h2>
            ⚠️ <span data-translate="limitExceeded">Przekroczono limit!</span>
          </h2>

          <div
            style="
              background: rgba(239, 68, 68, 0.2);
              border: 2px solid #ef4444;
              border-radius: 10px;
              padding: 15px;
              text-align: center;
            "
          >
            <h3 style="color: #ef4444">
              🚫 <span data-translate="pinRequired">Wymagany PIN</span>
            </h3>
            <p
              style="color: #aaa; margin-top: 10px"
              data-translate="transactionExceedsLimit"
            >
              Ta transakcja przekracza Twój limit wydatków. Wpisz PIN z karty
              aby potwierdzić.
            </p>
          </div>

          <button
            class="confirm-btn active"
            onclick="closeModal('limitExceeded'); openModal('pin');"
          >
            🔐 <span data-translate="enterPinBtn">Wpisz PIN</span>
          </button>
          <button
            class="modal-close"
            onclick="closeModal('limitExceeded'); pendingAction = null;"
            data-translate="cancel"
          >
            Anuluj
          </button>
        </div>
      </div>

      <!-- Modal Wybór Trybu Gry -->
      <div class="modal" id="modalGameMode">
        <div class="modal-content">
          <h2>🎮 <span data-translate="selectMode">Wybierz tryb</span></h2>

          <div style="display: flex; flex-direction: column; gap: 15px">
            <button
              onclick="switchGameMode('beamng')"
              id="modeBeamNG"
              style="
                padding: 20px;
                background: linear-gradient(145deg, #ff6b35, #f7931e);
                border: 3px solid transparent;
                border-radius: 15px;
                cursor: pointer;
                text-align: left;
                transition: all 0.3s;
              "
            >
              <div style="font-size: 1.5em; margin-bottom: 8px">
                🚗 BeamNG Drive
              </div>
              <div style="font-size: 0.9em; color: rgba(255, 255, 255, 0.9)">
                Datapack
              </div>
              <div
                style="
                  font-size: 0.8em;
                  color: rgba(255, 255, 255, 0.7);
                  margin-top: 8px;
                "
                data-translate="beamngDesc"
              >
                Auta z gry BeamNG.drive - fikcyjne marki
              </div>
            </button>

            <button
              onclick="switchGameMode('reallife')"
              id="modeRealLife"
              style="
                padding: 20px;
                background: linear-gradient(145deg, #10b981, #059669);
                border: 3px solid transparent;
                border-radius: 15px;
                cursor: pointer;
                text-align: left;
                transition: all 0.3s;
              "
            >
              <div style="font-size: 1.5em; margin-bottom: 8px">
                🌍 Real Life
              </div>
              <div
                style="font-size: 0.9em; color: rgba(255, 255, 255, 0.9)"
                data-translate="simulator"
              >
                Symulator
              </div>
              <div
                style="
                  font-size: 0.8em;
                  color: rgba(255, 255, 255, 0.7);
                  margin-top: 8px;
                "
                data-translate="reallifeDesc"
              >
                Prawdziwe marki aut w realnych cenach (-10%)
              </div>
            </button>
          </div>

          <div
            style="
              margin-top: 15px;
              padding: 12px;
              background: rgba(245, 158, 11, 0.1);
              border: 1px solid #f59e0b;
              border-radius: 10px;
              font-size: 0.85em;
              color: #f59e0b;
            "
          >
            ⚠️
            <span data-translate="modeWarning"
              >Każdy tryb ma osobny postęp na tym samym save'ie!</span
            >
          </div>

          <button
            class="modal-close"
            onclick="closeModal('gameMode')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Języki -->
      <div class="modal" id="modalLanguage">
        <div class="modal-content">
          <h2>🌐 <span data-translate="selectLanguage">Wybierz język</span></h2>

          <div class="lang-grid" id="langGrid"></div>

          <button
            class="modal-close"
            onclick="closeModal('language')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Save'y -->
      <div class="modal" id="modalSaves">
        <div class="modal-content">
          <h2>💾 <span data-translate="saves">Save'y</span></h2>

          <div
            id="savesList"
            style="
              max-height: 50vh;
              overflow-y: auto;
              margin-bottom: 15px;
              -webkit-overflow-scrolling: touch;
            "
          ></div>

          <div
            style="
              padding: 12px;
              background: rgba(0, 0, 0, 0.2);
              border-radius: 10px;
            "
          >
            <p
              style="margin-bottom: 10px; font-weight: bold; font-size: 0.95em"
            >
              <span data-translate="createSave">Nowy save</span>
            </p>
            <input
              type="text"
              id="newSaveName"
              placeholder="Save 2"
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid #333;
                border-radius: 8px;
                background: #1a1a2e;
                color: white;
                margin-bottom: 10px;
                font-size: 16px;
              "
            />
            <button
              onclick="handleCreateSave()"
              style="
                width: 100%;
                padding: 14px;
                background: #10b981;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 1em;
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
              "
            >
              ➕ <span data-translate="createSave">Nowy save</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('saves')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Bony -->
      <div class="modal" id="modalVouchers">
        <div class="modal-content">
          <h2>🎁 <span data-translate="vouchers">Bony</span></h2>

          <!-- Opisik -->
          <div
            style="
              background: rgba(139, 92, 246, 0.1);
              border: 1px solid #8b5cf6;
              border-radius: 10px;
              padding: 12px;
              margin-bottom: 15px;
              font-size: 0.85em;
              color: #aaa;
              line-height: 1.4;
            "
          >
            <span data-translate="vouchersDescription"
              >Bony to wirtualne pieniądze które możesz wysłać znajomym przez
              WhatsApp, Messenger, Email lub SMS. Odbiorca może przyjąć bon
              (dostanie pieniądze) lub przekazać go komuś innemu.</span
            >
          </div>

          <!-- Twoje bony do wysłania -->
          <div style="margin-bottom: 15px">
            <h3 style="font-size: 0.95em; margin-bottom: 10px">
              📤 <span data-translate="vouchersToSend">Bony do wysłania</span>
            </h3>
            <div
              id="vouchersToSendList"
              style="
                max-height: 30vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
              "
            ></div>
          </div>

          <!-- Otrzymane bony -->
          <div style="margin-bottom: 15px">
            <h3 style="font-size: 0.95em; margin-bottom: 10px">
              📥 <span data-translate="receivedVouchers">Otrzymane bony</span>
            </h3>
            <div
              id="receivedVouchersList"
              style="
                max-height: 30vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
              "
            ></div>
          </div>

          <!-- Utwórz bon -->
          <div
            style="
              padding: 12px;
              background: rgba(0, 0, 0, 0.2);
              border-radius: 10px;
              margin-bottom: 15px;
            "
          >
            <p
              style="margin-bottom: 10px; font-weight: bold; font-size: 0.95em"
            >
              <span data-translate="createVoucher">Utwórz bon</span>
            </p>
            <input
              type="number"
              id="voucherAmountInput"
              placeholder="100"
              min="1"
              inputmode="numeric"
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid #333;
                border-radius: 8px;
                background: #1a1a2e;
                color: white;
                margin-bottom: 10px;
                font-size: 16px;
              "
            />
            <input
              type="text"
              id="voucherMessageInput"
              placeholder="Wiadomość (opcjonalna)"
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid #333;
                border-radius: 8px;
                background: #1a1a2e;
                color: white;
                margin-bottom: 10px;
                font-size: 16px;
              "
            />
            <button
              onclick="handleCreateVoucher()"
              style="
                width: 100%;
                padding: 14px;
                background: #8b5cf6;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 1em;
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
              "
            >
              🎁 <span data-translate="createVoucher">Utwórz bon</span>
            </button>
          </div>

          <button
            class="modal-close"
            onclick="closeModal('vouchers')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Konto Online -->
      <!-- Modal Wymuszający Logowanie (na starcie) -->
      <div class="modal" id="modalRequireLogin">
        <div class="modal-content" style="max-width: 400px; text-align: center">
          <h2>🎮 BeamNG Datapack</h2>

          <div style="font-size: 4em; margin-bottom: 15px">👤</div>

          <input
            type="text"
            id="loginName"
            placeholder="Twoja nazwa..."
            maxlength="20"
            style="
              width: 100%;
              padding: 15px;
              background: #222;
              border: 2px solid #333;
              border-radius: 10px;
              color: white;
              font-size: 1.1em;
              margin-bottom: 10px;
              text-align: center;
            "
          />
          <p
            id="loginError"
            style="
              color: #ef4444;
              font-size: 0.85em;
              display: none;
              margin-bottom: 10px;
            "
          ></p>

          <button
            onclick="setPlayerName()"
            style="
              width: 100%;
              padding: 15px;
              background: #10b981;
              color: white;
              border: none;
              border-radius: 10px;
              cursor: pointer;
              font-size: 1.1em;
            "
          >
            ✅ Rozpocznij grę
          </button>

          <p style="color: #666; font-size: 0.8em; margin-top: 15px">
            Nazwa będzie widoczna dla innych graczy
          </p>
        </div>
      </div>

      <div class="modal" id="modalOnlineAccount">
        <div class="modal-content" style="max-width: 400px">
          <span class="close" onclick="closeModal('onlineAccount')"
            >&times;</span
          >
          <h2>👤 <span data-translate="onlineAccount">Konto</span></h2>
          <div id="onlineAccountContent"></div>
        </div>
      </div>

      <!-- Modal Powiadomienia - MEGA UPGRADE -->
      <div class="modal" id="modalNotifications">
        <div class="modal-content notifications-modal-content">
          <div class="notifications-header">
            <h2>
              <span class="bell-icon">🔔</span>
              <span data-translate="notifications">Powiadomienia</span>
              <span class="notif-count" id="notifHeaderCount">0</span>
            </h2>
            <div class="notifications-actions">
              <button
                class="notif-action-btn"
                onclick="markAllNotificationsRead()"
                title="Oznacz jako przeczytane"
              >
                ✓ <span data-translate="markAllRead">Wszystkie</span>
              </button>
              <button
                class="notif-action-btn danger"
                onclick="clearAllNotifications()"
                title="Wyczyść wszystkie"
              >
                🗑️
              </button>
              <span
                class="close"
                onclick="closeModal('notifications')"
                style="
                  background: none;
                  border: none;
                  font-size: 1.5em;
                  cursor: pointer;
                  color: #94a3b8;
                "
                >&times;</span
              >
            </div>
          </div>
          <div class="notifications-filters" id="notificationFilters">
            <!-- Filtry generowane dynamicznie -->
          </div>
          <div id="notificationsList" class="notifications-list"></div>
        </div>
      </div>

      <!-- Modal Czat -->
      <div class="modal" id="modalChat">
        <div class="modal-content" style="max-width: 500px">
          <span class="close" onclick="closeChatModal()">&times;</span>
          <h2>
            💬 <span data-translate="chatWith">Czat z</span>
            <span id="chatWithName"></span>
          </h2>
          <div
            id="chatMessages"
            style="
              max-height: 300px;
              overflow-y: auto;
              background: #1a1a2e;
              padding: 10px;
              border-radius: 8px;
              margin-bottom: 10px;
            "
          ></div>
          <p
            style="
              color: #888;
              font-size: 0.75em;
              margin-bottom: 5px;
              text-align: center;
            "
          >
            💰 Koszt wiadomości: 5,50 zł/$
          </p>
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="chatInput"
              placeholder="Wiadomość..."
              style="
                flex: 1;
                padding: 12px;
                background: #222;
                border: 1px solid #333;
                border-radius: 8px;
                color: white;
              "
            />
            <button
              onclick="sendChatMessage()"
              style="
                padding: 12px 20px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              📤
            </button>
          </div>
        </div>
      </div>

      <!-- Modal Aukcje -->
      <div class="modal" id="modalAuction">
        <div class="modal-content" style="max-width: 600px">
          <span class="close" onclick="closeModal('auction')">&times;</span>
          <h2>🏪 <span data-translate="auctionHouse">Dom Aukcyjny</span></h2>
          <div style="display: flex; gap: 10px; margin-bottom: 15px">
            <button
              onclick="showAuctionTab('browse')"
              class="tab-btn active"
              id="tabBrowse"
              style="
                flex: 1;
                padding: 10px;
                background: #333;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              🔍 <span data-translate="browseAuctions">Przeglądaj</span>
            </button>
            <button
              onclick="showAuctionTab('my')"
              class="tab-btn"
              id="tabMy"
              style="
                flex: 1;
                padding: 10px;
                background: #222;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              📦 <span data-translate="myAuctions">Moje</span>
            </button>
            <button
              onclick="showAuctionTab('create')"
              class="tab-btn"
              id="tabCreate"
              style="
                flex: 1;
                padding: 10px;
                background: #222;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
            >
              ➕ <span data-translate="createAuction">Wystaw</span>
            </button>
          </div>
          <div
            id="auctionContent"
            style="max-height: 400px; overflow-y: auto"
          ></div>
        </div>
      </div>

      <!-- Modal Szczegóły Aukcji -->
      <div class="modal" id="modalAuctionDetail">
        <div class="modal-content" style="max-width: 450px">
          <span class="close" onclick="closeModal('auctionDetail')"
            >&times;</span
          >
          <div id="auctionDetailContent"></div>
        </div>
      </div>

      <!-- Modal Wyślij do gracza online -->
      <div class="modal" id="modalSendToPlayer">
        <div class="modal-content" style="max-width: 400px">
          <span class="close" onclick="closeModal('sendToPlayer')"
            >&times;</span
          >
          <h2>
            📤 <span data-translate="sendToPlayer">Wyślij do gracza</span>
          </h2>
          <p style="color: #f59e0b; font-size: 0.9em; margin-bottom: 15px">
            ⚠️
            <span data-translate="onlineFee">Opłata: 250</span> ${getCurrency()}
          </p>
          <div
            id="onlinePlayersList"
            style="max-height: 300px; overflow-y: auto"
          ></div>
        </div>
      </div>

      <!-- Modal Podgląd Bonu -->
      <div class="modal" id="modalVoucherPreview">
        <div class="modal-content">
          <div id="voucherPreviewContent"></div>
          <button
            class="modal-close"
            onclick="closeModal('voucherPreview')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Udostępnij Bon -->
      <div class="modal" id="modalShareVoucher">
        <div class="modal-content">
          <h2>📤 <span data-translate="shareVoucher">Wyślij bon</span></h2>
          <div id="shareVoucherPreview" style="margin-bottom: 15px"></div>
          <div id="shareVoucherButtons"></div>
          <button
            class="modal-close"
            onclick="closeModal('shareVoucher')"
            style="margin-top: 15px"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Bank -->
      <div class="modal" id="modalBank">
        <div class="modal-content" style="max-width: 450px">
          <span class="close" onclick="closeModal('bank')">&times;</span>
          <h2>🏦 <span data-translate="bank">Bank</span></h2>

          <div id="bankContent">
            <!-- Zawartość będzie renderowana dynamicznie -->
          </div>
        </div>
      </div>

      <!-- Modal Firmy -->
      <div class="modal" id="modalBusiness">
        <div class="modal-content" style="max-width: 550px">
          <span class="close" onclick="closeModal('business')">&times;</span>
          <h2>🏢 <span data-translate="business">Twoje Firmy</span></h2>

          <div id="businessContent">
            <!-- Zawartość będzie renderowana dynamicznie -->
          </div>

          <button
            class="modal-close"
            onclick="closeModal('business')"
            data-translate="close"
          >
            Zamknij
          </button>
        </div>
      </div>

      <!-- Modal Tworzenia Firmy -->
      <div class="modal" id="modalCreateBusiness">
        <div class="modal-content" style="max-width: 500px">
          <span class="close" onclick="closeModal('createBusiness')"
            >&times;</span
          >
          <h2>🏗️ <span data-translate="createBusiness">Załóż Firmę</span></h2>

          <div id="createBusinessContent">
            <!-- Zawartość będzie renderowana dynamicznie -->
          </div>
        </div>
      </div>

      <!-- Modal Szczegóły Firmy -->
      <div class="modal" id="modalBusinessDetail">
        <div class="modal-content" style="max-width: 550px">
          <span class="close" onclick="closeModal('businessDetail')"
            >&times;</span
          >
          <div id="businessDetailContent">
            <!-- Zawartość będzie renderowana dynamicznie -->
          </div>
        </div>
      </div>

      <!-- Modal Czat z Pracownikiem/Klientem -->
      <div class="modal" id="modalBusinessChat">
        <div class="modal-content" style="max-width: 500px">
          <span class="close" onclick="closeModal('businessChat')"
            >&times;</span
          >
          <h2 id="businessChatTitle">💬 Rozmowa</h2>

          <div
            id="businessChatMessages"
            style="
              max-height: 350px;
              overflow-y: auto;
              background: #1a1a2e;
              padding: 15px;
              border-radius: 10px;
              margin-bottom: 15px;
            "
          >
            <!-- Wiadomości czatu -->
          </div>

          <div
            id="businessChatOptions"
            style="display: flex; flex-direction: column; gap: 8px"
          >
            <!-- Opcje odpowiedzi -->
          </div>

          <div id="businessChatInput" style="display: none; margin-top: 10px">
            <input
              type="text"
              id="businessChatInputField"
              placeholder=""
              style="
                width: 100%;
                padding: 12px;
                background: #222;
                border: 2px solid #333;
                border-radius: 8px;
                color: white;
                font-size: 1em;
              "
            />
            <button
              onclick="sendBusinessChatInput()"
              id="businessChatSendBtn"
              style="
                width: 100%;
                margin-top: 8px;
                padding: 12px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              "
              data-translate="sendOffer"
            >
              Wyślij
            </button>
          </div>
        </div>
      </div>

      <script>
        // ==================== JĘZYKI ====================
        const languages = {
          pl: { name: "Polski", flag: "🇵🇱" },
          en: { name: "English", flag: "🇬🇧" },
        };

        const translations = {
          pl: {
            yourMoney: "TWOJE PIENIĄDZE",
            debt: "DŁUG",
            instructions: "Instrukcja",
            earnKm: "Zarobek (km)",
            repair: "Napraw Auto",
            buyCar: "Kup Auto",
            sellCar: "Sprzedaj Auto",
            work: "Praca",
            garage: "Garaż",
            business: "Firmy",
            createBusiness: "Załóż Firmę",
            noBusinesses: "Nie masz jeszcze żadnej firmy",
            totalIncomeWeek: "Łączny przychód/tydzień",
            totalExpensesWeek: "Łączne wydatki/tydzień",
            netProfitWeek: "Zysk netto/tydzień",
            workers: "pracowników",
            createNextBusiness: "Załóż kolejną firmę",
            selectCategory: "Wybierz kategorię działalności",
            businessTypes: "typów firm",
            back: "Wróć",
            backToCategories: "Wróć do kategorii",
            selectType: "wybierz typ",
            startCost: "Koszt założenia",
            clientsPerDay: "Klienci/dzień",
            avgIncomeClient: "Śr. przychód/klient",
            businessName: "Nazwa firmy",
            notEnoughMoneyBusiness: "Nie masz wystarczająco pieniędzy!",
            youNeed: "Potrzebujesz",
            createBusinessFor: "Załóż firmę za",
            hiredWorkers: "Zatrudnieni pracownicy",
            noWorkersYet:
              "Nie masz jeszcze pracowników. Zatrudnij kogoś poniżej!",
            candidates: "Kandydaci do pracy",
            noCandidates: "Brak kandydatów. Nowi pojawią się wkrótce.",
            searchCandidates: "Szukaj kandydatów",
            negotiateTerms: "Negocjuj warunki",
            expects: "Oczekuje",
            activeClients: "Aktywni klienci",
            serve: "Obsłuż",
            simulateDay: "Symuluj dzień pracy",
            closeBusiness: "Zamknij firmę",
            backToList: "Wróć do listy firm",
            reputation: "Reputacja",
            acceptTerms: "Akceptuję warunki",
            proposeAmount: "Zaproponuj inną kwotę",
            lowerBonus: "Niższa prowizja, wyższa podstawa?",
            notInterested: "Dziękuję, nie jesteśmy zainteresowani",
            giveRaise: "Daj podwyżkę",
            needWorkers: "Potrzebujesz pracowników!",
            dayReport: "Dzień pracy",
            clients: "klientów",
            afterCommission: "po prowizjach",
            hired: "Zatrudniono",
            workerFired: "Pracownik zwolniony",
            businessClosed: "Firma zamknięta",
            businessCreated: "Założono firmę",
            salariesIn: "Wypłaty w",
            cantAffordSalaries: "Nie stać Cię na wypłaty w",
            addedToDebt: "Dodano do długu",
            foundCandidates: "Znaleziono nowych kandydatów!",
            needForRecruitment: "Potrzebujesz na rekrutację",
            chatWith: "Rozmowa z",
            greeting1:
              "Dzień dobry! Jestem {name}. Szukam pracy jako {position}.",
            greeting2:
              "Cześć! Nazywam się {name} i zainteresowała mnie oferta pracy.",
            greeting3:
              "Witam serdecznie. {name}, szukam zatrudnienia w charakterze {position}.",
            salaryExpectation:
              "Moje oczekiwania to około {salary} {currency} tygodniowo, plus {bonus}% prowizji od wypracowanych zysków. Co Pan/Pani o tym sądzi?",
            acceptTermsBtn: "Akceptuję warunki",
            proposeAmountBtn: "Zaproponuj inną kwotę",
            lowerBonusBtn: "Niższa prowizja, wyższa podstawa?",
            rejectBtn: "Dziękuję, nie jesteśmy zainteresowani",
            acceptMsg:
              "Zgadzam się na {salary} {currency}/tydzień plus {bonus}% prowizji. Witam w zespole!",
            workerAcceptMsg: "Świetnie! Bardzo się cieszę. Kiedy mogę zacząć?",
            startNowMsg: "Od zaraz! Zapraszam do pracy.",
            workerThanksMsg: "Dziękuję! Nie zawiodę.",
            counterOfferMsg: "Mam inną propozycję finansową...",
            enterSalaryPrompt: "Wpisz proponowaną pensję tygodniową:",
            sendOffer: "Wyślij ofertę",
            proposeSalaryMsg: "Proponuję {salary} {currency} tygodniowo.",
            workerGreatOffer: "To bardzo fajna oferta! Zgadzam się!",
            workerAcceptLower:
              "Trochę mniej niż liczyłem, ale zgoda. Bierzemy to!",
            workerCounterOffer:
              "To trochę za mało... Może spotkamy się w połowie drogi? {counter} {currency}?",
            workerTooLow:
              "Przepraszam, ale to znacznie poniżej moich oczekiwań. Minimum {min} {currency}.",
            lowerBonusProposal:
              "Co powiesz na {salary} {currency}/tydzień, ale prowizja {bonus}%?",
            workerReasonable: "Hmm... to brzmi rozsądnie. Zgadzam się!",
            workerNotGood:
              "Nie bardzo mi to pasuje. Może jednak {salary} i {bonus}%? To moja ostateczna oferta.",
            rejectMsg:
              "Dziękuję za rozmowę, ale nie jesteśmy zainteresowani współpracą.",
            workerUnderstandMsg:
              "Rozumiem. Dziękuję za poświęcony czas. Powodzenia!",
            backToBusinessBtn: "Wróć do firmy",
            bank: "Bank",
            takeCredit: "Weź kredyt",
            creditAmount: "Kwota kredytu",
            interestRate: "Oprocentowanie",
            monthly: "miesięcznie",
            repaymentPeriod: "Okres spłaty",
            months: "miesięcy",
            monthlyPayment: "Rata miesięczna",
            totalToRepay: "Razem do spłaty",
            yourCredits: "Twoje kredyty",
            noCredits: "Nie masz żadnych kredytów",
            remaining: "Pozostało",
            payRate: "Zapłać ratę",
            payOff: "Spłać całość",
            creditTaken: "Kredyt przyznany!",
            ratePaid: "Rata zapłacona",
            creditPaidOff: "Kredyt spłacony!",
            notEnoughForRate: "Nie masz na ratę!",
            upgrade: "Ulepsz",
            sellValue: "Wartość",
            sell: "Sprzedaj",
            carBroken: "Auto zepsute!",
            cantSellBroken: "Nie możesz sprzedać zepsutego auta!",
            confirmSell: "Sprzedać",
            forPrice: "za",
            sold: "Sprzedano!",
            basePrice: "Cena bazowa",
            buyQuestion: "Kupić",
            carBought: "Kupiono",
            upgradeCar: "Ulepszanie",
            startUpgrade: "Rozpocznij ulepszanie",
            stopUpgrade: "Zatrzymaj",
            upgrading: "Ulepszanie w toku...",
            upgradeStopped: "Zatrzymane",
            clickToStart: "Kliknij aby rozpocząć",
            upgradeWarning:
              "Podczas ulepszania auto może się zepsuć! (150 zł + -5%)",
            carBrokeMsg: "Auto się zepsuło! -150 zł, -5%",
            carBreakDebt: "Zepsucie auta",
            buyCarFirst: "Kup auto w salonie!",
            chooseJob: "Wybierz pracę:",
            bonuses: "bonusy",
            bonus: "bonus",
            stayAwake: "Trzymaj żeby nie zasnąć!",
            workDone: "Praca zakończona!",
            basePay: "Podstawa",
            sleepPenalty: "Kara za spanie",
            total: "Razem",
            taxes: "Podatki",
            card: "Karta Beam-Pay",
            cardRealLife: "Karta Real-Card",
            howToEarn: "Jak zdobyć pieniądze?",
            perKm: "Za każdy km",
            sellCarTo: "Sprzedaż auta",
            carPrice: "ceny auta",
            fees: "Opłaty",
            fuel: "Paliwo (max 10 PkA)",
            startFuel: "Start: 10 punktów paliwa",
            taxesPer2km: "Podatki (co 2 km)",
            taxesPer10min: "Podatki (co 10 min)",
            repairCost: "Naprawa auta",
            fine: "Mandat",
            close: "Zamknij",
            sendScreenshotKm: "Wyślij screenshot z przejechanych kilometrów",
            clickOrDrag: "Kliknij lub przeciągnij screenshot",
            analyzing: "Analizuję screenshot...",
            collectEarnings: "Odbierz zarobek",
            sendScreenshotDamage: "Wyślij screenshot uszkodzonego auta",
            repairCostInfo: "Koszt naprawy:",
            payAndRepair: "Zapłać i napraw",
            sendScreenshotCar: "Wyślij screenshot z ceną auta",
            get50percent: "Dostaniesz 50% wartości",
            buyCarBtn: "Kup auto",
            sellCarBtn: "Sprzedaj auto",
            taxInfo: "Informacje o podatkach",
            taxRate: "Stawka:",
            totalPaid: "Zapłacono łącznie:",
            nextTax: "Następny podatek za:",
            autoPay: "Automatyczne płacenie",
            autoPayDesc: "Karta płaci automatycznie w tle",
            debtInfo: "Informacje o długu",
            debtDesc:
              "Jeśli zabraknie pieniędzy na podatek, powstanie dług. Masz 7 dni na spłatę długu.",
            currentDebt: "Aktualny dług:",
            payDebt: "Spłać dług",
            balance: "Saldo",
            cardSettings: "Ustawienia karty",
            spendingLimit: "Limit wydatków:",
            spent: "Wydano z limitu:",
            remaining: "Pozostało:",
            setLimit: "📊 Ustaw limit",
            resetSpent: "🔄 Resetuj wydatki",
            newLimit: "Nowy limit (zł)",
            setLimitBtn: "Ustaw limit",
            cancel: "Anuluj",
            enterPin: "Wpisz PIN",
            enter6digitPin: "Wpisz 6-cyfrowy PIN z karty Beam-Pay",
            limitExceeded: "Przekroczono limit!",
            pinRequired: "Wymagany PIN",
            transactionExceedsLimit:
              "Ta transakcja przekracza Twój limit. Wpisz PIN aby potwierdzić.",
            enterPinBtn: "Wpisz PIN",
            selectLanguage: "Wybierz język",
            daysLeft: "dni do spłaty",
            notEnoughMoney: "Nie masz wystarczająco pieniędzy!",
            invalidScreenshot: "Nie rozpoznano danych!",
            foundKm: "Znaleziono:",
            foundPrice: "Cena auta:",
            noCarFound: "Nie znaleziono auta na obrazku!",
            enterKm: "Wpisz przejechane kilometry:",
            enterPrice: "Wpisz cenę auta:",
            youGet50: "Dostaniesz 50%:",
            youPay: "Zapłacisz:",
            generateQR: "Generuj kod QR",
            carName: "Nazwa auta (np. ETK 800)",
            carPricePlaceholder: "Cena ze screena",
            selectCarToSell: "Wybierz auto z garażu:",
            sendCarPhoto: "Wyślij zdjęcie tego auta",
            noCarInGarage: "Nie masz żadnych aut w garażu",
            boughtFor: "Kupiono za",
            inventory: "Ekwipunek",
            health: "Zdrowie",
            food: "Jedzenie",
            water: "Picie",
            foodTab: "Jedzenie",
            drinksTab: "Napoje",
            foodFull: "Nie możesz więcej jeść!",
            waterFull: "Nie możesz więcej pić!",
            shop: "Sklep",
            backpackContents: "Zawartość plecaka:",
            emptyBackpack: "Plecak jest pusty",
            goToShop: "Idź do sklepu kupić jedzenie!",
            useItem: "Użyj",
            tooFull: "Jesteś pełny!",
            insurance: "Ubezpieczenia",
            activeInsurances: "Aktywne ubezpieczenia",
            chooseInsurance: "Wybierz pakiet:",
            cancelInsurance: "Zrezygnuj",
            confirmCancelWithRefund: "Zrezygnować? Zwrot",
            confirmCancelNoRefund:
              "Zrezygnować? Brak zwrotu (użyto mniej niż 3 razy)",
            choosePeriod: "Wybierz okres",
            hour: "Godzina",
            day: "Dzień",
            week: "Tydzień",
            month: "Miesiąc",
            perHour: "/godz",
            perDay: "/dzień",
            perWeek: "/tydzień",
            perMonth: "/miesiąc",
            activated: "Aktywowane",
            perHourShort: "/h",
            perDayShort: "/d",
            perWeekShort: "/tyg",
            every: "co",
            hour: "Godzina",
            day: "Dzień",
            week: "Tydzień",
            remaining: "Pozostało",
            expired: "Wygasło",
            autoPayments: "Automatyczne płatności",
            autoPayInfo: "Podatki i ubezpieczenia nie liczą się do limitu",
            autoPay: "Auto-płać",
            noActiveInsurance: "Brak aktywnych ubezpieczeń",
            alreadyHaveInsurance: "Już masz to ubezpieczenie!",
            insuranceDetails: "Szczegóły",
            price: "Cena",
            totalPaid: "Zapłacono łącznie",
            benefitsReceived: "Otrzymane korzyści",
            nextPayment: "Następna płatność",
            refund: "zwrot",
            noRefund: "brak zwrotu",
            // Produkty - jedzenie
            itemBurger: "Burger",
            itemPizza: "Pizza",
            itemHotdog: "Hot Dog",
            itemFries: "Frytki",
            itemSandwich: "Kanapka",
            itemSalad: "Sałatka",
            itemApple: "Jabłko",
            itemBanana: "Banan",
            itemWatermelon: "Arbuz",
            itemChicken: "Kurczak",
            itemSteak: "Stek",
            itemSushi: "Sushi",
            itemDonut: "Pączek",
            itemIcecream: "Lody",
            itemChocolate: "Czekolada",
            // Produkty - napoje
            itemWater: "Woda",
            itemCola: "Cola",
            itemJuice: "Sok",
            itemCoffee: "Kawa",
            itemTea: "Herbata",
            itemMilk: "Mleko",
            itemBeer: "Piwo",
            itemWine: "Wino",
            itemSmoothie: "Smoothie",
            itemEnergyDrink: "Energetyk",
            itemLemonade: "Lemoniada",
            itemCoconut: "Woda kokosowa",
            // Ubezpieczenia - nazwy
            insBasic: "Basic",
            insStandard: "Standard",
            insPremium: "Premium",
            insVip: "VIP",
            insUltimate: "Ultimate",
            insHealthBasic: "Zdrowie Basic",
            insHealthPlus: "Zdrowie Plus",
            insFoodBasic: "Jedzenie Basic",
            insFoodPlus: "Jedzenie Plus",
            insWaterBasic: "Picie Basic",
            insWaterPlus: "Picie Plus",
            insHealthFood: "Zdrowie + Jedzenie",
            insHealthWater: "Zdrowie + Picie",
            insFoodWater: "Jedzenie + Picie",
            // Ubezpieczenia ulepszanie
            insUpgradeBasic: "Ulepszanie Basic",
            insUpgradePlus: "Ulepszanie Plus",
            insUpgradePro: "Ulepszanie Pro",
            insUpgradeMax: "Ulepszanie Max",
            insUpgradeBasicDesc: "+0.05%/s, -10% szansy zepsucia",
            insUpgradePlusDesc: "+0.1%/s, -20% szansy zepsucia",
            insUpgradeProDesc: "+0.15%/s, -30% szansy zepsucia",
            insUpgradeMaxDesc: "+0.2%/s, -40% szansy zepsucia",
            // Ubezpieczenia naprawa
            insRepairBasic: "Naprawa Basic",
            insRepairPlus: "Naprawa Plus",
            insRepairFull: "Naprawa Full",
            insRepairBasicDesc: "30% kosztów naprawy pokryte",
            insRepairPlusDesc: "50% kosztów naprawy pokryte",
            insRepairFullDesc: "100% kosztów naprawy pokryte",
            noBrokenCars: "Wszystkie auta są sprawne!",
            goToGarage: "Idź do Garażu żeby ulepszać auta",
            carNotBroken: "To auto nie jest zepsute!",
            repairDebt: "Naprawa auta",
            addedToDebt: "Dodano do długu",
            insuranceCovered: "Ubezpieczenie pokryło",
            coinsCollected: "Zebrane monety",
            // Save'y
            saves: "Save'y",
            currentSave: "Aktualny save",
            createSave: "Nowy save",
            deleteSave: "Usuń save",
            switchSave: "Przełącz",
            saveName: "Nazwa save'a",
            confirmDeleteSave: "Usunąć ten save?",
            cannotDeleteLastSave: "Nie można usunąć ostatniego save'a!",
            saveCreated: "Save utworzony!",
            active: "aktywny",
            enterNewName: "Wprowadź nową nazwę:",
            // Bony
            vouchers: "Bony",
            vouchersRealLife: "Kupony",
            createVoucher: "Utwórz bon",
            createVoucherRealLife: "Utwórz kupon",
            voucherAmount: "Kwota bonu",
            voucherMessage: "Wiadomość (opcjonalna)",
            redeemVoucher: "Zrealizuj bon",
            enterVoucherCode: "Wprowadź kod bonu",
            voucherRedeemed: "Bon zrealizowany!",
            invalidVoucher: "Nieprawidłowy kod bonu!",
            voucherCreated: "Bon utworzony! Kod:",
            voucherFrom: "Od:",
            yourVouchers: "Twoje bony",
            noVouchers: "Brak bonów",
            // Naprawa
            selectCarToRepair: "Wybierz auto do naprawy:",
            repairSelectedCar: "Napraw wybrane auto",
            repaired: "Naprawione!",
            // Bony - rozszerzone
            vouchersToSend: "Bony do wysłania",
            receivedVouchers: "Otrzymane bony",
            sendVoucher: "Wyślij",
            acceptVoucher: "Przyjmij",
            rejectVoucher: "Przekaż dalej",
            shareVoucher: "Wyślij bon",
            copyLink: "Kopiuj link",
            linkCopied: "Link skopiowany!",
            cancelVoucherConfirm: "Anulować bon? Pieniądze wrócą na konto.",
            youReceivedVoucher: "Dostałeś/aś bon o wartości",
            voucherAccepted: "Bon przyjęty!",
            noReceivedVouchers: "Brak otrzymanych bonów",
            invalidAmount: "Wprowadź prawidłową kwotę!",
            pendingVoucher: "Wysłano - oczekuje",
            cancelVoucherConfirm: "Anulować bon?",
            voucherAlreadyUsed: "Ten bon został już wykorzystany!",
            voucherExpired: "Czas minął! Link wygasł.",
            voucherNotFound: "Nie znaleziono bonu!",
            voucherCancelled: "Ten bon został anulowany przez nadawcę.",
            cancelAndRefund: "Anuluj (zwrot dla nadawcy)",
            cancelled: "anulowany",
            refundToSender: "Zwrot dla nadawcy",
            // System online
            onlineAccount: "Konto Online",
            notifications: "Powiadomienia",
            markAllRead: "Wszystkie",
            allNotifications: "Wszystkie",
            workerNotifications: "Pracownicy",
            clientReviews: "Opinie",
            businessNotifications: "Firma",
            unreadNotifications: "Nieprzeczytane",
            noNotificationsTitle: "Brak powiadomień",
            noNotificationsInCategory: "Brak powiadomień w tej kategorii",
            createBusinessFirst: "Stwórz firmę aby otrzymywać powiadomienia",
            hireWorkersFirst:
              "Zatrudnij pracowników aby otrzymywać powiadomienia",
            allCaughtUp: "Wszystko przejrzane! Sprawdź później.",
            salaryRequest: "Prośba o podwyżkę",
            quitWarning: "Groźba odejścia",
            badReview: "Zła opinia",
            goodReview: "Dobra opinia",
            newCandidate: "Nowy kandydat",
            dailyReport: "Raport dzienny",
            auctionHouse: "Dom Aukcyjny",
            browseAuctions: "Przeglądaj",
            myAuctions: "Moje",
            createAuction: "Wystaw",
            chooseNameAndPin: "Wybierz nazwę i PIN (4 cyfry)",
            playerName: "Nazwa gracza",
            register: "Zarejestruj się",
            login: "Zaloguj się",
            logout: "Wyloguj",
            onlinePlayers: "Gracze online",
            noPlayersOnline: "Brak graczy online",
            nameTooShort: "Nazwa musi mieć min. 2 znaki",
            pinMustBe4: "PIN musi mieć 4 cyfry",
            nameTaken: "Ta nazwa jest już zajęta!",
            registered: "Zarejestrowano!",
            welcome: "Witaj",
            loggedIn: "Zalogowano!",
            playerNotFound: "Nie znaleziono gracza",
            deleteAccount: "Usuń konto",
            addFriend: "Dodaj znajomego",
            friends: "Znajomi",
            noFriends: "Brak znajomych",
            sendToFriend: "Wyślij do znajomego",
            noFriendsToSend: "Brak znajomych. Dodaj znajomych w Konto Online!",
            wrongPin: "Błędny PIN!",
            loginFirst: "Najpierw się zaloguj",
            noNotifications: "Brak powiadomień",
            sentYouVoucher: "wysłał Ci bon",
            bidOn: "zalicytował",
            wantsToNegotiate: "chce negocjować",
            yourOfferAccepted: "Twoja oferta zaakceptowana!",
            yourOfferRejected: "Twoja oferta odrzucona",
            seller: "Sprzedawca",
            price: "Cena",
            buyNow: "Kup teraz",
            negotiate: "Negocjuj",
            noAuctions: "Brak aukcji",
            noMyAuctions: "Nie masz wystawionych przedmiotów",
            nothingToSell: "Nie masz nic do wystawienia",
            selectToSell: "Wybierz co chcesz wystawić:",
            enterPrice: "Podaj cenę:",
            invalidPrice: "Nieprawidłowa cena",
            auctionCreated: "Wystawiono!",
            enterYourOffer: "Podaj swoją ofertę:",
            offerSent: "Wysłano ofertę!",
            purchaseSuccess: "Zakup udany!",
            waitingForSeller: "Czekaj na odpowiedź sprzedawcy...",
            enterPin: "Wpisz PIN",
            forgotPin: "Nie pamiętam",
            allow: "Pozwól",
            deny: "Odmów",
            buyerForgotPin: "Kupujący nie pamięta PIN",
            allowedWithoutPin: "pozwolił kupić bez PIN",
            deniedWithoutPin: "nie pozwolił kupić bez PIN",
            counterOffer: "kontr-oferta",
            enterCounterOffer: "Podaj kontr-ofertę:",
            negotiations: "negocjacji",
            boughtYourItem: "kupił Twój przedmiot",
            sendToPlayer: "Wyślij do gracza",
            onlineFee: "Opłata: 250",
            // Aukcje pakietowe
            selectItemsToSell: "Zaznacz co chcesz wystawić:",
            cars: "Auta",
            food: "Jedzenie",
            customInsurance: "Własne ubezpieczenie",
            createInsurance: "Stwórz ubezpieczenie",
            selectedItems: "Wybrane",
            totalPrice: "Cena za pakiet",
            listForSale: "Wystaw na sprzedaż",
            noCars: "Brak aut",
            noFood: "Brak jedzenia",
            selectSomething: "Wybierz coś do wystawienia!",
            insuranceName: "Nazwa ubezpieczenia",
            myInsurance: "Moje ubezpieczenie",
            whatItGives: "Co daje",
            coveragePercent: "Pokrycie napraw",
            paymentInterval: "Opłata co ile minut",
            paymentAmount: "Kwota opłaty",
            add: "Dodaj",
            contents: "Zawartość",
            creationCost: "Koszt stworzenia",
            auctionSummary: "Podsumowanie",
            sellingPrice: "Cena sprzedaży",
            youPay: "Płacisz",
            confirmListing: "Wystawić?",
            cost: "Koszt",
            confirmCancelAuction:
              "Anulować aukcję? Przedmioty wrócą do Ciebie.",
            notYourAuction: "To nie Twoja aukcja!",
            auctionCancelled: "Aukcja anulowana!",
            repairs: "napraw",
            chatWith: "Czat z",
            reply: "Odpowiedz",
            noMessages: "Brak wiadomości",
            sendToOnlinePlayer: "Wyślij do gracza online",
            voucherSentTo: "Bon wysłany do",
            acceptedYourVoucher: "przyjął Twój bon",
            rejectedYourVoucher: "odrzucił Twój bon",
            voucherRejected: "Bon odrzucony",
            sendToPlayer: "Wyślij do gracza",
            enterPlayerName: "Wpisz nazwę gracza...",
            orSelectPlayer: "Lub wybierz z listy:",
            allPlayers: "Wszyscy gracze",
            noPlayersYet: "Brak innych graczy",
            findPlayer: "Znajdź gracza",
            nameOrCardNumber: "Numer karty (6 cyfr)...",
            cardNumber: "Numer karty",
            wantsToBeYourFriend: "chce dodać Cię do znajomych!",
            acceptedYourFriendRequest:
              "zaakceptował zaproszenie! Jesteście znajomymi.",
            rejectedYourFriendRequest: "odrzucił zaproszenie do znajomych",
            accept: "Akceptuj",
            reject: "Odrzuć",
            playerNotFound: "Nie znaleziono gracza",
            cantReceiveOwnVoucher: "Nie możesz odebrać własnego bonu!",
            sent: "wysłany",
            total: "łącznie",
            shippingFee: "opłata za przesyłkę",
            shippingInfo: "Online: +100 zł | 30 sek od otwarcia!",
            noShippingFee: "Bez opłaty za przesyłkę",
            // Logowanie
            loginTitle: "Zaloguj się",
            loginDesc:
              "Podaj swój email żeby móc wysyłać i odbierać bony/kupony.",
            loginBtn: "Zaloguj",
            loginPrivacy:
              "Email jest zapisywany tylko lokalnie na Twoim urządzeniu.",
            invalidEmail: "Podaj prawidłowy email!",
            loggedInAs: "Zalogowany jako",
            sameEmailVoucher:
              "Nie możesz odebrać bonu wysłanego z tego samego konta!",
            mustLoginFirst: "Musisz się najpierw zalogować!",
            shareTo: "Udostępnij do:",
            sendToOtherSave: "Lub wyślij na inny zapis:",
            voucherSentToSave: "Bon wysłany do",
            selectSaveForVoucher: "Na który zapis przyjąć bon?",
            cannotAcceptOwnVoucher: "Nie możesz przyjąć własnego bonu!",
            vouchersDescription:
              "Bony to wirtualne pieniądze które możesz wysłać znajomym przez WhatsApp, Messenger, Email lub SMS. Odbiorca może przyjąć bon (dostanie pieniądze) lub przekazać go komuś innemu.",
            // Tryb gry
            selectMode: "Wybierz tryb",
            beamngDesc: "Auta z gry BeamNG.drive - fikcyjne marki",
            simulator: "Symulator",
            reallifeDesc: "Prawdziwe marki aut w realnych cenach (-10%)",
            modeWarning: "Każdy tryb ma osobny postęp na tym samym save'ie!",
            // Instrukcje
            earnDesc: "Wykonuj prace aby zarabiać pieniądze:",
            driverJob: "Kierowca",
            factoryJob: "Praca w fabryce",
            sleepJob: "Sen (AFK)",
            sellCarProfit: "Sprzedaż auta",
            ofValue: "wartości",
            garageSystem: "System garażu",
            garageDesc: "Kupuj, ulepszaj i sprzedawaj auta:",
            upgradeInfo:
              "Kliknij raz - auto ulepsza się w tle. Wartość rośnie (50% → 1000%)",
            breakRisk: "Ryzyko zepsucia",
            breakInfo:
              "0.5%/s szansy na zepsucie. Koszt: 150 zł + -5% wartości",
            selling: "Sprzedaż",
            sellInfo: "Cena = cena bazowa × procent ulepszenia",
            payments: "Płatności i opłaty",
            autoPayInfo2:
              "Włącz w ustawieniach karty - automatycznie płaci podatki i ubezpieczenia",
            debtSystem: "System długów",
            debtInfo2: "Brak kasy = dług. Masz 7 dni na spłatę!",
            insurances: "Ubezpieczenia",
            insuranceDesc: "Różne pakiety dające bonusy:",
            healthIns: "Zdrowotne",
            healthInsDesc: "regeneracja HP, jedzenia, picia",
            upgradeIns: "Na ulepszanie",
            upgradeInsDesc: "szybsze ulepszanie, mniejsza szansa zepsucia",
            repairIns: "Na naprawę",
            repairInsDesc: "pokrywa 30-100% kosztów naprawy",
            survival: "Przetrwanie",
            hungerDrain: "Głód",
            thirstDrain: "Pragnienie",
            survivalTip:
              "Kupuj jedzenie i napoje w sklepie, lub wykup ubezpieczenie!",
            voucherSystem: "System bonów",
            voucherDesc:
              "Twórz bony pieniężne i wysyłaj znajomym przez WhatsApp, Messenger, Email lub SMS. Pieniądze pobierane są dopiero gdy odbiorca zaakceptuje bon.",
            value: "wartości",
            // Nowa instrukcja
            workSystem: "System pracy",
            workDesc: "Wybierz zawód i pracuj 2 minuty w mini-grze:",
            jobsRange: "13 zawodów od łatwych do trudnych",
            coinGame: "Łapanie monet",
            coinGameDesc: "Klikaj spadające monety +100 zł za każdą!",
            sleepMechanic: "Zasypianie",
            sleepMechanicDesc:
              "Trzymaj ekran żeby nie zasnąć! Spanie = strata do 90% zarobku",
            gameModes: "Tryby gry",
            gameModesDesc:
              "Kliknij tytuł gry aby przełączyć między trybem BeamNG (fikcyjne auta) a Real Life (prawdziwe marki). Każdy tryb ma osobny postęp!",
            coinsCollected: "Zebrane monety",
            // Śmierć i checkpointy
            youDied: "Zginąłeś!",
            loadingCheckpoint: "Wczytywanie ostatniego checkpointu...",
            noCheckpoint: "Brak checkpointu",
            noCheckpointReset: "Brak checkpointu - zaczynasz od nowa!",
            checkpoint: "Checkpoint",
            saveCheckpoint: "Zapisz checkpoint",
            checkpointCreated: "Checkpoint utworzony!",
            checkpointInfo: "Jeśli zginiesz, wrócisz do tego momentu.",
            confirmDeleteCheckpoint:
              "Usunąć checkpoint? Jeśli zginiesz, stracisz cały postęp!",
            checkpointDeleted: "Checkpoint usunięty!",
            noCheckpointToDelete: "Nie masz checkpointu do usunięcia!",
            deathWarning: "Uwaga! Jak zdrowie spadnie do 0 - zginiesz!",
            death: "Śmierć",
            deathDesc:
              "Głód/woda = 0 → tracisz HP. HP = 0 → zginiesz i wrócisz do checkpointu!",
            checkpointSystem: "System checkpointów",
            createCheckpointInfo: "Tworzenie",
            createCheckpointDesc:
              "W menu Save'ów kliknij 'Zapisz checkpoint' żeby zapisać aktualny postęp",
            respawn: "Odrodzenie",
            respawnDesc:
              "Po śmierci wrócisz do checkpointu. Brak checkpointu = reset postępu!",
          },
          en: {
            yourMoney: "YOUR MONEY",
            debt: "DEBT",
            instructions: "Instructions",
            earnKm: "Earnings (km)",
            repair: "Repair Car",
            buyCar: "Buy Car",
            sellCar: "Sell Car",
            work: "Work",
            garage: "Garage",
            business: "Business",
            createBusiness: "Create Business",
            noBusinesses: "You don't have any businesses yet",
            totalIncomeWeek: "Total income/week",
            totalExpensesWeek: "Total expenses/week",
            netProfitWeek: "Net profit/week",
            workers: "workers",
            createNextBusiness: "Create another business",
            selectCategory: "Select business category",
            businessTypes: "business types",
            back: "Back",
            backToCategories: "Back to categories",
            selectType: "select type",
            startCost: "Start cost",
            clientsPerDay: "Clients/day",
            avgIncomeClient: "Avg. income/client",
            businessName: "Business name",
            notEnoughMoneyBusiness: "You don't have enough money!",
            youNeed: "You need",
            createBusinessFor: "Create business for",
            hiredWorkers: "Hired workers",
            noWorkersYet: "You don't have any workers yet. Hire someone below!",
            candidates: "Job candidates",
            noCandidates: "No candidates. New ones will appear soon.",
            searchCandidates: "Search candidates",
            negotiateTerms: "Negotiate terms",
            expects: "Expects",
            activeClients: "Active clients",
            serve: "Serve",
            simulateDay: "Simulate work day",
            closeBusiness: "Close business",
            backToList: "Back to business list",
            reputation: "Reputation",
            acceptTerms: "Accept terms",
            proposeAmount: "Propose different amount",
            lowerBonus: "Lower commission, higher base?",
            notInterested: "Thank you, we're not interested",
            giveRaise: "Give a raise",
            needWorkers: "You need workers!",
            dayReport: "Work day",
            clients: "clients",
            afterCommission: "after commissions",
            hired: "Hired",
            workerFired: "Worker fired",
            businessClosed: "Business closed",
            businessCreated: "Business created",
            salariesIn: "Salaries in",
            cantAffordSalaries: "Can't afford salaries in",
            addedToDebt: "Added to debt",
            foundCandidates: "Found new candidates!",
            needForRecruitment: "Need for recruitment",
            chatWith: "Chat with",
            greeting1:
              "Hello! I'm {name}. I'm looking for a job as {position}.",
            greeting2:
              "Hi! My name is {name} and I'm interested in your job offer.",
            greeting3:
              "Good day. {name}, looking for employment as {position}.",
            salaryExpectation:
              "My expectations are about {salary} {currency} weekly, plus {bonus}% commission from generated profits. What do you think?",
            acceptTermsBtn: "Accept terms",
            proposeAmountBtn: "Propose different amount",
            lowerBonusBtn: "Lower commission, higher base?",
            rejectBtn: "Thank you, we're not interested",
            acceptMsg:
              "I agree to {salary} {currency}/week plus {bonus}% commission. Welcome to the team!",
            workerAcceptMsg: "Great! I'm very happy. When can I start?",
            startNowMsg: "Right away! Welcome aboard.",
            workerThanksMsg: "Thank you! I won't let you down.",
            counterOfferMsg: "I have a different financial proposal...",
            enterSalaryPrompt: "Enter proposed weekly salary:",
            sendOffer: "Send offer",
            proposeSalaryMsg: "I propose {salary} {currency} weekly.",
            workerGreatOffer: "That's a great offer! I accept!",
            workerAcceptLower:
              "A bit less than I hoped, but deal. Let's do it!",
            workerCounterOffer:
              "That's a bit low... How about meeting in the middle? {counter} {currency}?",
            workerTooLow:
              "Sorry, but that's well below my expectations. Minimum {min} {currency}.",
            lowerBonusProposal:
              "How about {salary} {currency}/week, but {bonus}% commission?",
            workerReasonable: "Hmm... that sounds reasonable. I agree!",
            workerNotGood:
              "That doesn't work for me. How about {salary} and {bonus}%? That's my final offer.",
            rejectMsg:
              "Thank you for the conversation, but we're not interested in cooperation.",
            workerUnderstandMsg:
              "I understand. Thank you for your time. Good luck!",
            backToBusinessBtn: "Back to business",
            bank: "Bank",
            takeCredit: "Take a loan",
            creditAmount: "Loan amount",
            interestRate: "Interest rate",
            monthly: "monthly",
            repaymentPeriod: "Repayment period",
            months: "months",
            monthlyPayment: "Monthly payment",
            totalToRepay: "Total to repay",
            yourCredits: "Your loans",
            noCredits: "You have no loans",
            remaining: "Remaining",
            payRate: "Pay installment",
            payOff: "Pay off",
            creditTaken: "Loan approved!",
            ratePaid: "Installment paid",
            creditPaidOff: "Loan paid off!",
            notEnoughForRate: "Not enough for installment!",
            upgrade: "Upgrade",
            sellValue: "Value",
            sell: "Sell",
            carBroken: "Car broken!",
            cantSellBroken: "Cannot sell broken car!",
            confirmSell: "Sell",
            forPrice: "for",
            sold: "Sold!",
            basePrice: "Base price",
            buyQuestion: "Buy",
            carBought: "Bought",
            upgradeCar: "Upgrading",
            startUpgrade: "Start upgrading",
            stopUpgrade: "Stop",
            upgrading: "Upgrading...",
            upgradeStopped: "Stopped",
            clickToStart: "Click to start",
            upgradeWarning: "Car may break during upgrade! ($150 + -5%)",
            carBrokeMsg: "Car broke! -$150, -5%",
            carBreakDebt: "Car break",
            buyCarFirst: "Buy a car first!",
            chooseJob: "Choose job:",
            bonuses: "bonuses",
            bonus: "bonus",
            stayAwake: "Hold to stay awake!",
            workDone: "Work done!",
            basePay: "Base pay",
            sleepPenalty: "Sleep penalty",
            total: "Total",
            taxes: "Taxes",
            card: "Beam-Pay Card",
            cardRealLife: "Real-Card",
            howToEarn: "How to earn money?",
            perKm: "Per km",
            sellCarTo: "Sell car",
            carPrice: "car price",
            fees: "Fees",
            fuel: "Fuel (max 10)",
            startFuel: "Start: 10 fuel points",
            taxesPer2km: "Taxes (per 2 km)",
            taxesPer10min: "Taxes (per 10 min)",
            repairCost: "Car repair",
            fine: "Fine",
            close: "Close",
            sendScreenshotKm: "Send screenshot with kilometers",
            clickOrDrag: "Click or drag screenshot",
            analyzing: "Analyzing...",
            collectEarnings: "Collect",
            sendScreenshotDamage: "Send screenshot of damaged car",
            repairCostInfo: "Repair cost:",
            payAndRepair: "Pay and repair",
            sendScreenshotCar: "Send screenshot with car price",
            get50percent: "You get 50%",
            buyCarBtn: "Buy",
            sellCarBtn: "Sell",
            taxInfo: "Tax info",
            taxRate: "Rate:",
            totalPaid: "Total paid:",
            nextTax: "Next tax in:",
            autoPay: "Auto pay",
            autoPayDesc: "Card pays automatically",
            debtInfo: "Debt info",
            debtDesc: "No money for tax = debt. 7 days to pay.",
            currentDebt: "Current debt:",
            payDebt: "Pay debt",
            balance: "Balance",
            cardSettings: "Card settings",
            spendingLimit: "Limit:",
            spent: "Spent:",
            remaining: "Left:",
            setLimit: "📊 Set limit",
            resetSpent: "🔄 Reset",
            newLimit: "New limit",
            setLimitBtn: "Set",
            cancel: "Cancel",
            enterPin: "Enter PIN",
            enter6digitPin: "Enter 6-digit PIN",
            limitExceeded: "Limit exceeded!",
            pinRequired: "PIN required",
            transactionExceedsLimit: "Exceeds limit. Enter PIN.",
            enterPinBtn: "Enter PIN",
            selectLanguage: "Select language",
            daysLeft: "days left",
            notEnoughMoney: "Not enough money!",
            invalidScreenshot: "Cannot read data!",
            foundKm: "Found:",
            foundPrice: "Price:",
            noCarFound: "No car found in image!",
            enterKm: "Enter kilometers:",
            enterPrice: "Enter car price:",
            youGet50: "You get 50%:",
            youPay: "You pay:",
            generateQR: "Generate QR code",
            carName: "Car name (e.g. ETK 800)",
            carPricePlaceholder: "Price from screenshot",
            selectCarToSell: "Select car from garage:",
            sendCarPhoto: "Send photo of this car",
            noCarInGarage: "No cars in garage",
            boughtFor: "Bought for",
            inventory: "Inventory",
            health: "Health",
            food: "Food",
            water: "Water",
            foodTab: "Food",
            drinksTab: "Drinks",
            foodFull: "You can't eat more!",
            waterFull: "You can't drink more!",
            shop: "Shop",
            backpackContents: "Backpack contents:",
            emptyBackpack: "Backpack is empty",
            goToShop: "Go to shop to buy food!",
            useItem: "Use",
            tooFull: "You're full!",
            insurance: "Insurance",
            activeInsurances: "Active insurances",
            chooseInsurance: "Choose package:",
            cancelInsurance: "Cancel",
            confirmCancelWithRefund: "Cancel? Refund",
            confirmCancelNoRefund: "Cancel? No refund (used less than 3 times)",
            choosePeriod: "Choose period",
            hour: "Hour",
            day: "Day",
            week: "Week",
            month: "Month",
            perHour: "/hour",
            perDay: "/day",
            perWeek: "/week",
            perMonth: "/month",
            activated: "Activated",
            perHourShort: "/h",
            perDayShort: "/d",
            perWeekShort: "/wk",
            every: "every",
            hour: "Hour",
            day: "Day",
            week: "Week",
            remaining: "Remaining",
            expired: "Expired",
            autoPayments: "Auto payments",
            autoPayInfo: "Taxes and insurance don't count toward limit",
            autoPay: "Auto-pay",
            noActiveInsurance: "No active insurances",
            alreadyHaveInsurance: "You already have this insurance!",
            insuranceDetails: "Details",
            price: "Price",
            totalPaid: "Total paid",
            benefitsReceived: "Benefits received",
            nextPayment: "Next payment",
            refund: "refund",
            noRefund: "no refund",
            // Products - food
            itemBurger: "Burger",
            itemPizza: "Pizza",
            itemHotdog: "Hot Dog",
            itemFries: "Fries",
            itemSandwich: "Sandwich",
            itemSalad: "Salad",
            itemApple: "Apple",
            itemBanana: "Banana",
            itemWatermelon: "Watermelon",
            itemChicken: "Chicken",
            itemSteak: "Steak",
            itemSushi: "Sushi",
            itemDonut: "Donut",
            itemIcecream: "Ice cream",
            itemChocolate: "Chocolate",
            // Products - drinks
            itemWater: "Water",
            itemCola: "Cola",
            itemJuice: "Juice",
            itemCoffee: "Coffee",
            itemTea: "Tea",
            itemMilk: "Milk",
            itemBeer: "Beer",
            itemWine: "Wine",
            itemSmoothie: "Smoothie",
            itemEnergyDrink: "Energy Drink",
            itemLemonade: "Lemonade",
            itemCoconut: "Coconut water",
            // Insurance - names
            insBasic: "Basic",
            insStandard: "Standard",
            insPremium: "Premium",
            insVip: "VIP",
            insUltimate: "Ultimate",
            insHealthBasic: "Health Basic",
            insHealthPlus: "Health Plus",
            insFoodBasic: "Food Basic",
            insFoodPlus: "Food Plus",
            insWaterBasic: "Water Basic",
            insWaterPlus: "Water Plus",
            insHealthFood: "Health + Food",
            insHealthWater: "Health + Water",
            insFoodWater: "Food + Water",
            // Upgrade insurances
            insUpgradeBasic: "Upgrade Basic",
            insUpgradePlus: "Upgrade Plus",
            insUpgradePro: "Upgrade Pro",
            insUpgradeMax: "Upgrade Max",
            insUpgradeBasicDesc: "+0.05%/s, -10% break chance",
            insUpgradePlusDesc: "+0.1%/s, -20% break chance",
            insUpgradeProDesc: "+0.15%/s, -30% break chance",
            insUpgradeMaxDesc: "+0.2%/s, -40% break chance",
            // Repair insurances
            insRepairBasic: "Repair Basic",
            insRepairPlus: "Repair Plus",
            insRepairFull: "Repair Full",
            insRepairBasicDesc: "30% repair costs covered",
            insRepairPlusDesc: "50% repair costs covered",
            insRepairFullDesc: "100% repair costs covered",
            noBrokenCars: "All cars are working!",
            goToGarage: "Go to Garage to upgrade cars",
            carNotBroken: "This car is not broken!",
            repairDebt: "Car repair",
            addedToDebt: "Added to debt",
            insuranceCovered: "Insurance covered",
            coinsCollected: "Coins collected",
            // Saves
            saves: "Saves",
            currentSave: "Current save",
            createSave: "New save",
            deleteSave: "Delete save",
            switchSave: "Switch",
            saveName: "Save name",
            confirmDeleteSave: "Delete this save?",
            cannotDeleteLastSave: "Cannot delete the last save!",
            saveCreated: "Save created!",
            active: "active",
            enterNewName: "Enter new name:",
            // Vouchers
            vouchers: "Vouchers",
            vouchersRealLife: "Coupons",
            createVoucher: "Create voucher",
            createVoucherRealLife: "Create coupon",
            voucherAmount: "Voucher amount",
            voucherMessage: "Message (optional)",
            redeemVoucher: "Redeem voucher",
            enterVoucherCode: "Enter voucher code",
            voucherRedeemed: "Voucher redeemed!",
            invalidVoucher: "Invalid voucher code!",
            voucherCreated: "Voucher created! Code:",
            voucherFrom: "From:",
            yourVouchers: "Your vouchers",
            noVouchers: "No vouchers",
            // Repair
            selectCarToRepair: "Select car to repair:",
            repairSelectedCar: "Repair selected car",
            repaired: "Repaired!",
            // Vouchers - extended
            vouchersToSend: "Vouchers to send",
            receivedVouchers: "Received vouchers",
            sendVoucher: "Send",
            acceptVoucher: "Accept",
            rejectVoucher: "Pass on",
            shareVoucher: "Send voucher",
            copyLink: "Copy link",
            linkCopied: "Link copied!",
            cancelVoucherConfirm: "Cancel voucher? Money will be refunded.",
            youReceivedVoucher: "You received a voucher worth",
            voucherAccepted: "Voucher accepted!",
            noReceivedVouchers: "No received vouchers",
            invalidAmount: "Enter a valid amount!",
            pendingVoucher: "Sent - waiting",
            cancelVoucherConfirm: "Cancel voucher?",
            voucherAlreadyUsed: "This voucher has already been used!",
            voucherExpired: "Time's up! Link expired.",
            voucherNotFound: "Voucher not found!",
            voucherCancelled: "This voucher was cancelled by the sender.",
            cancelAndRefund: "Cancel (refund to sender)",
            cancelled: "cancelled",
            refundToSender: "Refund to sender",
            // Online system
            onlineAccount: "Online Account",
            notifications: "Notifications",
            markAllRead: "All",
            allNotifications: "All",
            workerNotifications: "Workers",
            clientReviews: "Reviews",
            businessNotifications: "Business",
            unreadNotifications: "Unread",
            noNotificationsTitle: "No notifications",
            noNotificationsInCategory: "No notifications in this category",
            createBusinessFirst: "Create a business to receive notifications",
            hireWorkersFirst: "Hire workers to get employee notifications",
            allCaughtUp: "All caught up! Check back later.",
            salaryRequest: "Salary request",
            quitWarning: "Quit warning",
            badReview: "Bad review",
            goodReview: "Good review",
            newCandidate: "New candidate",
            dailyReport: "Daily report",
            auctionHouse: "Auction House",
            browseAuctions: "Browse",
            myAuctions: "My auctions",
            createAuction: "Create",
            chooseNameAndPin: "Choose name and PIN (4 digits)",
            playerName: "Player name",
            register: "Register",
            login: "Log in",
            logout: "Log out",
            onlinePlayers: "Players online",
            noPlayersOnline: "No players online",
            nameTooShort: "Name must be at least 2 characters",
            pinMustBe4: "PIN must be 4 digits",
            nameTaken: "This name is already taken!",
            registered: "Registered!",
            welcome: "Welcome",
            loggedIn: "Logged in!",
            playerNotFound: "Player not found",
            deleteAccount: "Delete account",
            addFriend: "Add friend",
            friends: "Friends",
            noFriends: "No friends",
            sendToFriend: "Send to friend",
            noFriendsToSend: "No friends. Add friends in Online Account!",
            wrongPin: "Wrong PIN!",
            loginFirst: "Log in first",
            noNotifications: "No notifications",
            sentYouVoucher: "sent you a voucher",
            bidOn: "bid on",
            wantsToNegotiate: "wants to negotiate",
            yourOfferAccepted: "Your offer was accepted!",
            yourOfferRejected: "Your offer was rejected",
            seller: "Seller",
            price: "Price",
            buyNow: "Buy now",
            negotiate: "Negotiate",
            noAuctions: "No auctions",
            noMyAuctions: "You have no listed items",
            nothingToSell: "Nothing to sell",
            selectToSell: "Select item to sell:",
            enterPrice: "Enter price:",
            invalidPrice: "Invalid price",
            auctionCreated: "Listed!",
            enterYourOffer: "Enter your offer:",
            offerSent: "Offer sent!",
            purchaseSuccess: "Purchase successful!",
            waitingForSeller: "Waiting for seller response...",
            enterPin: "Enter PIN",
            forgotPin: "Forgot PIN",
            allow: "Allow",
            deny: "Deny",
            buyerForgotPin: "Buyer forgot PIN",
            allowedWithoutPin: "allowed purchase without PIN",
            deniedWithoutPin: "denied purchase without PIN",
            counterOffer: "counter-offer",
            enterCounterOffer: "Enter counter-offer:",
            negotiations: "negotiations",
            boughtYourItem: "bought your item",
            sendToPlayer: "Send to player",
            onlineFee: "Fee: 250",
            // Package auctions
            selectItemsToSell: "Select items to sell:",
            cars: "Cars",
            food: "Food",
            customInsurance: "Custom insurance",
            createInsurance: "Create insurance",
            selectedItems: "Selected",
            totalPrice: "Package price",
            listForSale: "List for sale",
            noCars: "No cars",
            noFood: "No food",
            selectSomething: "Select something to sell!",
            insuranceName: "Insurance name",
            myInsurance: "My insurance",
            whatItGives: "What it gives",
            coveragePercent: "Repair coverage",
            paymentInterval: "Payment every X minutes",
            paymentAmount: "Payment amount",
            add: "Add",
            contents: "Contents",
            creationCost: "Creation cost",
            auctionSummary: "Summary",
            sellingPrice: "Selling price",
            youPay: "You pay",
            confirmListing: "List it?",
            cost: "Cost",
            confirmCancelAuction:
              "Cancel auction? Items will be returned to you.",
            notYourAuction: "This is not your auction!",
            auctionCancelled: "Auction cancelled!",
            repairs: "repairs",
            chatWith: "Chat with",
            reply: "Reply",
            noMessages: "No messages",
            sendToOnlinePlayer: "Send to online player",
            voucherSentTo: "Voucher sent to",
            acceptedYourVoucher: "accepted your voucher",
            rejectedYourVoucher: "rejected your voucher",
            voucherRejected: "Voucher rejected",
            sendToPlayer: "Send to player",
            enterPlayerName: "Enter player name...",
            orSelectPlayer: "Or select from list:",
            allPlayers: "All players",
            noPlayersYet: "No other players yet",
            findPlayer: "Find player",
            nameOrCardNumber: "Card number (6 digits)...",
            cardNumber: "Card number",
            wantsToBeYourFriend: "wants to add you as a friend!",
            acceptedYourFriendRequest:
              "accepted your invite! You are now friends.",
            rejectedYourFriendRequest: "rejected your friend request",
            accept: "Accept",
            reject: "Reject",
            playerNotFound: "Player not found",
            cantReceiveOwnVoucher: "You cannot receive your own voucher!",
            sent: "sent",
            total: "total",
            shippingFee: "shipping fee",
            shippingInfo: "Online: +100 fee | 30 sec from opening!",
            noShippingFee: "No shipping fee",
            // Login
            loginTitle: "Log in",
            loginDesc: "Enter your email to send and receive vouchers/coupons.",
            loginBtn: "Log in",
            loginPrivacy: "Email is saved only locally on your device.",
            invalidEmail: "Enter a valid email!",
            loggedInAs: "Logged in as",
            sameEmailVoucher:
              "You cannot receive a voucher sent from the same account!",
            mustLoginFirst: "You must log in first!",
            shareTo: "Share to:",
            sendToOtherSave: "Or send to another save:",
            voucherSentToSave: "Voucher sent to",
            selectSaveForVoucher: "Which save to accept voucher?",
            cannotAcceptOwnVoucher: "Cannot accept your own voucher!",
            vouchersDescription:
              "Vouchers are virtual money you can send to friends via WhatsApp, Messenger, Email or SMS. The recipient can accept the voucher (get the money) or pass it on to someone else.",
            // Game mode
            selectMode: "Select mode",
            beamngDesc: "Cars from BeamNG.drive game - fictional brands",
            simulator: "Simulator",
            reallifeDesc: "Real car brands at realistic prices (-10%)",
            modeWarning: "Each mode has separate progress on the same save!",
            // Instructions
            earnDesc: "Do jobs to earn money:",
            driverJob: "Driver",
            factoryJob: "Factory work",
            sleepJob: "Sleep (AFK)",
            sellCarProfit: "Sell car",
            ofValue: "of value",
            garageSystem: "Garage system",
            garageDesc: "Buy, upgrade and sell cars:",
            upgradeInfo:
              "Click once - car upgrades in background. Value grows (50% → 1000%)",
            breakRisk: "Break risk",
            breakInfo: "0.5%/s chance to break. Cost: 150 zł + -5% value",
            selling: "Selling",
            sellInfo: "Price = base price × upgrade percentage",
            payments: "Payments & fees",
            autoPayInfo2:
              "Enable in card settings - auto-pays taxes and insurances",
            debtSystem: "Debt system",
            debtInfo2: "No cash = debt. You have 7 days to pay!",
            insurances: "Insurances",
            insuranceDesc: "Various packages with bonuses:",
            healthIns: "Health",
            healthInsDesc: "regenerates HP, food, water",
            upgradeIns: "Upgrade",
            upgradeInsDesc: "faster upgrading, lower break chance",
            repairIns: "Repair",
            repairInsDesc: "covers 30-100% of repair costs",
            survival: "Survival",
            hungerDrain: "Hunger",
            thirstDrain: "Thirst",
            survivalTip: "Buy food and drinks in shop, or get insurance!",
            voucherSystem: "Voucher system",
            voucherDesc:
              "Create money vouchers and send to friends via WhatsApp, Messenger, Email or SMS. Money is deducted only when recipient accepts the voucher.",
            value: "value",
            // New instructions
            workSystem: "Work system",
            workDesc: "Choose a job and work 2 minutes in mini-game:",
            jobsRange: "13 jobs from easy to hard",
            coinGame: "Catching coins",
            coinGameDesc: "Click falling coins +100 zł each!",
            sleepMechanic: "Falling asleep",
            sleepMechanicDesc:
              "Hold screen to stay awake! Sleeping = lose up to 90% of earnings",
            gameModes: "Game modes",
            gameModesDesc:
              "Click game title to switch between BeamNG mode (fictional cars) and Real Life (real brands). Each mode has separate progress!",
            coinsCollected: "Coins collected",
            // Death and checkpoints
            youDied: "You died!",
            loadingCheckpoint: "Loading last checkpoint...",
            noCheckpoint: "No checkpoint",
            noCheckpointReset: "No checkpoint - starting over!",
            checkpoint: "Checkpoint",
            saveCheckpoint: "Save checkpoint",
            checkpointCreated: "Checkpoint created!",
            checkpointInfo: "If you die, you'll return to this moment.",
            confirmDeleteCheckpoint:
              "Delete checkpoint? If you die, you'll lose all progress!",
            checkpointDeleted: "Checkpoint deleted!",
            noCheckpointToDelete: "No checkpoint to delete!",
            deathWarning: "Warning! If health drops to 0 - you die!",
            death: "Death",
            deathDesc:
              "Hunger/water = 0 → lose HP. HP = 0 → you die and return to checkpoint!",
            checkpointSystem: "Checkpoint system",
            createCheckpointInfo: "Creating",
            createCheckpointDesc:
              "In Saves menu click 'Save checkpoint' to save current progress",
            respawn: "Respawn",
            respawnDesc:
              "After death you'll return to checkpoint. No checkpoint = progress reset!",
          },
        };

        Object.keys(languages).forEach((lang) => {
          if (!translations[lang]) translations[lang] = translations.en;
        });

        let currentLang = localStorage.getItem("beamng_lang") || "pl";

        // ==================== SYSTEM SAVE'ÓW ====================
        let saves = JSON.parse(localStorage.getItem("beamng_saves")) || [];
        let currentSaveId = localStorage.getItem("beamng_currentSave") || null;

        // Upewnij się że jest minimum 1 save
        function ensureDefaultSave() {
          if (saves.length === 0) {
            const newSave = createNewSaveData("Save 1");
            saves.push(newSave);
            currentSaveId = newSave.id;
            localStorage.setItem("beamng_saves", JSON.stringify(saves));
            localStorage.setItem("beamng_currentSave", currentSaveId);
          }
          if (!currentSaveId || !saves.find((s) => s.id === currentSaveId)) {
            currentSaveId = saves[0].id;
            localStorage.setItem("beamng_currentSave", currentSaveId);
          }
        }

        function createNewSaveData(name) {
          const defaultModeData = {
            money: 1500,
            garage: [],
            spent: 0,
            debt: 0,
            debtDeadline: null,
            totalTaxPaid: 0,
            health: 100,
            food: 1000,
            water: 1000,
            backpack: [],
            activeInsurances: [],
            businesses: [],
            credits: [],
            workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
            vouchersToSend: [],
            receivedVouchers: [],
            // Podatki od pracy
            todayWorkCount: 0,
            lastWorkDate: null,
            pendingTaxReport: null,
          };

          return {
            id: "save_" + Date.now(),
            name: name,
            createdAt: Date.now(),
            data: {
              limit: 10000,
              autoPay: false,
              lastTaxTime: Date.now(),
              lastHungerTime: Date.now(),
            },
            // Osobne dane dla każdego trybu
            beamngData: { ...defaultModeData },
            realLifeData: { ...defaultModeData },
          };
        }

        // Interwały ulepszania aut - musi być przed loadSaveData
        let upgradeIntervals = {};

        // Tryb gry - musi być przed loadSaveData
        let gameMode = localStorage.getItem("beamng_gameMode") || "beamng";

        // getCurrentCars() jest zdefiniowane po listach aut (beamngCars, realLifeCars)

        function getCurrentSave() {
          return saves.find((s) => s.id === currentSaveId);
        }

        function loadSaveData() {
          const save = getCurrentSave();
          if (!save) return;

          // Zatrzymaj wszystkie aktywne ulepszania przed załadowaniem nowego save'a
          Object.keys(upgradeIntervals).forEach((idx) => {
            clearInterval(upgradeIntervals[idx]);
          });
          upgradeIntervals = {};

          // Załaduj dane wspólne (limit, autoPay, lastTaxTime)
          // cardCode jest globalny dla urządzenia - nie ładuj z save
          const d = save.data || {};
          pin = cardCode;
          limit = d.limit || 10000;
          autoPay = d.autoPay || false;
          lastTaxTime = d.lastTaxTime || Date.now();
          lastHungerTime = d.lastHungerTime || Date.now();

          // Załaduj dane specyficzne dla trybu
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";

          // Utwórz strukturę modeData jeśli nie istnieje
          if (!save[modeKey]) {
            save[modeKey] = {
              money: 1500,
              garage: [],
              spent: 0,
              debt: 0,
              debtDeadline: null,
              totalTaxPaid: 0,
              health: 100,
              food: 1000,
              water: 1000,
              backpack: [],
              activeInsurances: [],
              businesses: [],
              credits: [],
              workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
              vouchersToSend: [],
              receivedVouchers: [],
            };
            // Migruj stare dane jeśli istnieją
            if (d.money !== undefined) {
              save[modeKey].money = d.money;
              save[modeKey].garage = d.garage || [];
              save[modeKey].spent = d.spent || 0;
              save[modeKey].debt = d.debt || 0;
              save[modeKey].debtDeadline = d.debtDeadline || null;
              save[modeKey].totalTaxPaid = d.totalTaxPaid || 0;
              save[modeKey].health = d.health || 100;
              save[modeKey].food = d.food || 1000;
              save[modeKey].water = d.water || 1000;
              save[modeKey].backpack = d.backpack || [];
              save[modeKey].activeInsurances = d.insurances || [];
              save[modeKey].businesses = d.businesses || [];
              save[modeKey].credits = d.credits || [];
              save[modeKey].workExperience = d.workExperience || {
                1: 0,
                2: 0,
                3: 0,
                4: 0,
                5: 0,
              };
              save[modeKey].vouchersToSend = d.vouchersToSend || [];
              save[modeKey].receivedVouchers = d.receivedVouchers || [];
            }
            localStorage.setItem("beamng_saves", JSON.stringify(saves));
          }

          const modeData = save[modeKey];

          money = modeData.money !== undefined ? modeData.money : 1500;
          garage = modeData.garage || [];
          spent = modeData.spent || 0;
          debt = modeData.debt || 0;
          debtDeadline = modeData.debtDeadline || null;
          totalTaxPaid = modeData.totalTaxPaid || 0;
          health = modeData.health || 100;
          food = modeData.food || 1000;
          water = modeData.water || 1000;
          backpack = modeData.backpack || [];
          activeInsurances = modeData.activeInsurances || [];

          // Wznów ulepszania aut
          resumeUpgrades();
        }

        function saveSaveData() {
          const save = getCurrentSave();
          if (!save) return;

          // Zapisz dane wspólne (cardCode jest globalny w localStorage)
          save.data.limit = limit;
          save.data.autoPay = autoPay;
          save.data.lastTaxTime = lastTaxTime;
          save.data.lastHungerTime = lastHungerTime;

          // Zapisz dane specyficzne dla trybu - ZACHOWAJ istniejące dane jak businesses, credits
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";

          // Najpierw zachowaj istniejące dane które są zapisywane osobno
          const existingBusinesses = save[modeKey]?.businesses || [];
          const existingCredits = save[modeKey]?.credits || [];
          const existingWorkExp = save[modeKey]?.workExperience || {
            1: 0,
            2: 0,
            3: 0,
            4: 0,
            5: 0,
          };
          const existingVouchersToSend = save[modeKey]?.vouchersToSend || [];
          const existingReceivedVouchers =
            save[modeKey]?.receivedVouchers || [];

          save[modeKey] = {
            money: money,
            garage: [...garage],
            spent: spent,
            debt: debt,
            debtDeadline: debtDeadline,
            totalTaxPaid: totalTaxPaid,
            health: health,
            food: food,
            water: water,
            backpack: [...backpack],
            activeInsurances: [...activeInsurances],
            // Zachowaj dane zapisywane przez inne funkcje
            businesses: existingBusinesses,
            credits: existingCredits,
            workExperience: existingWorkExp,
            vouchersToSend: existingVouchersToSend,
            receivedVouchers: existingReceivedVouchers,
            // Podatki
            todayWorkCount: save[modeKey]?.todayWorkCount || 0,
            lastWorkDate: save[modeKey]?.lastWorkDate || null,
            pendingTaxReport: save[modeKey]?.pendingTaxReport || null,
          };

          localStorage.setItem("beamng_saves", JSON.stringify(saves));
        }

        function createSave(name) {
          const newSave = createNewSaveData(name);
          saves.push(newSave);
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          return newSave;
        }

        function deleteSave(saveId) {
          if (saves.length <= 1) {
            alert(
              translations[currentLang].cannotDeleteLastSave ||
                "Nie można usunąć ostatniego save!"
            );
            return false;
          }
          const idx = saves.findIndex((s) => s.id === saveId);
          if (idx === -1) return false;

          saves.splice(idx, 1);
          localStorage.setItem("beamng_saves", JSON.stringify(saves));

          if (currentSaveId === saveId) {
            currentSaveId = saves[0].id;
            localStorage.setItem("beamng_currentSave", currentSaveId);
            loadSaveData();
          }
          return true;
        }

        function switchSave(saveId) {
          if (currentSaveId === saveId) return;

          // Zapisz obecny stan
          saveSaveData();

          // Przełącz na nowy save
          currentSaveId = saveId;
          localStorage.setItem("beamng_currentSave", currentSaveId);

          // Załaduj dane nowego save'a
          loadSaveData();
          updateAllDisplays();
        }

        // ==================== DŹWIĘKI ====================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
          if (!audioCtx) {
            audioCtx = new AudioContext();
          }
          if (audioCtx.state === "suspended") {
            audioCtx.resume();
          }
        }

        // Generowanie dźwięków syntetycznych
        function playSound(type) {
          initAudio();
          if (!audioCtx) return;

          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);

          switch (type) {
            case "coin": // Złapanie monety - wysoki dźwięk
              oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(
                1760,
                audioCtx.currentTime + 0.1
              );
              gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.15
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.15);
              break;

            case "buy": // Kupno - kasa
              oscillator.frequency.setValueAtTime(523, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                659,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                784,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.3
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.3);
              break;

            case "sell": // Sprzedaż - cha-ching
              oscillator.frequency.setValueAtTime(1318, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                1568,
                audioCtx.currentTime + 0.08
              );
              gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.2
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.2);
              break;

            case "error": // Błąd - niski dźwięk
              oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(
                100,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.25
              );
              oscillator.type = "sawtooth";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.25);
              break;

            case "success": // Sukces - fanfara
              oscillator.frequency.setValueAtTime(523, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                659,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                784,
                audioCtx.currentTime + 0.2
              );
              oscillator.frequency.setValueAtTime(
                1047,
                audioCtx.currentTime + 0.3
              );
              gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.5
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.5);
              break;

            case "click": // Kliknięcie przycisku
              oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
              gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.05
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.05);
              break;

            case "eat": // Jedzenie
              oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                350,
                audioCtx.currentTime + 0.05
              );
              oscillator.frequency.setValueAtTime(
                300,
                audioCtx.currentTime + 0.1
              );
              gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.15
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.15);
              break;

            case "drink": // Picie
              oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(
                200,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.25
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.25);
              break;

            case "repair": // Naprawa
              oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                400,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                300,
                audioCtx.currentTime + 0.2
              );
              oscillator.frequency.setValueAtTime(
                500,
                audioCtx.currentTime + 0.3
              );
              gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.4
              );
              oscillator.type = "square";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.4);
              break;

            case "break": // Zepsucie
              oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(
                50,
                audioCtx.currentTime + 0.5
              );
              gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.5
              );
              oscillator.type = "sawtooth";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.5);
              break;

            case "upgrade": // Ulepszenie tick
              oscillator.frequency.setValueAtTime(
                800 + Math.random() * 200,
                audioCtx.currentTime
              );
              gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.05
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.05);
              break;

            case "workStart": // Start pracy
              oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                554,
                audioCtx.currentTime + 0.15
              );
              oscillator.frequency.setValueAtTime(
                659,
                audioCtx.currentTime + 0.3
              );
              gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.45
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.45);
              break;

            case "workEnd": // Koniec pracy
              oscillator.frequency.setValueAtTime(659, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                784,
                audioCtx.currentTime + 0.15
              );
              oscillator.frequency.setValueAtTime(
                1047,
                audioCtx.currentTime + 0.3
              );
              gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.5
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.5);
              break;

            case "voucher": // Bon
              oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                1100,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                1320,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.35
              );
              oscillator.type = "sine";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.35);
              break;

            case "insurance": // Ubezpieczenie
              oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
              oscillator.frequency.setValueAtTime(
                600,
                audioCtx.currentTime + 0.1
              );
              oscillator.frequency.setValueAtTime(
                700,
                audioCtx.currentTime + 0.2
              );
              gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + 0.3
              );
              oscillator.type = "triangle";
              oscillator.start(audioCtx.currentTime);
              oscillator.stop(audioCtx.currentTime + 0.3);
              break;
          }
        }

        // ==================== STAN GRY ====================
        let money = 1500;
        let unreadNotifications = 0; // Licznik nieprzeczytanych powiadomień online
        // Kod karty - globalny dla urządzenia (nie per save)
        let cardCode = localStorage.getItem("beamng_device_card_code");
        if (!cardCode) {
          cardCode = generateCardCodeSync();
          localStorage.setItem("beamng_device_card_code", cardCode);
        }
        let pin = cardCode;
        let limit = 10000;
        let spent = 0;
        let debt = 0;
        let debtDeadline = null;
        let totalTaxPaid = 0;
        let autoPay = false;
        let lastTaxTime = Date.now();
        let garage = [];

        // Jedzenie/Picie/Zdrowie
        let health = 100;
        let food = 1000;
        let water = 1000;
        let backpack = [];
        let lastHungerTime = Date.now();
        const MAX_HEALTH = 100;
        const MAX_FOOD = 1000;
        const MAX_WATER = 1000;
        const HUNGER_INTERVAL = 5 * 60 * 1000; // Co 5 minut
        const FOOD_DECAY = 50; // -50 kcal co 5 min
        const WATER_DECAY = 80; // -80 ml co 5 min

        // Ubezpieczenia - wiele aktywnych, płatności cykliczne (godzina/dzień/tydzień)
        let activeInsurances = [];

        const insurancePackages = [
          // Combo
          {
            id: "basic",
            nameKey: "insBasic",
            icon: "💊",
            prices: { hour: 50, day: 200, week: 1000 },
            interval: 10,
            benefits: { hp: 3, kcal: 20, ml: 30 },
            descKey: "insBasicDesc",
          },

          {
            id: "standard",
            nameKey: "insStandard",
            icon: "🏥",
            prices: { hour: 100, day: 400, week: 2000 },
            interval: 10,
            benefits: { hp: 5, kcal: 40, ml: 50 },
            descKey: "insStandardDesc",
          },

          {
            id: "premium",
            nameKey: "insPremium",
            icon: "⭐",
            prices: { hour: 180, day: 700, week: 3500 },
            interval: 8,
            benefits: { hp: 8, kcal: 50, ml: 60 },
            descKey: "insPremiumDesc",
          },

          {
            id: "vip",
            nameKey: "insVip",
            icon: "👑",
            prices: { hour: 300, day: 1200, week: 6000 },
            interval: 5,
            benefits: { hp: 10, kcal: 60, ml: 80 },
            descKey: "insVipDesc",
          },

          {
            id: "ultimate",
            nameKey: "insUltimate",
            icon: "💎",
            prices: { hour: 500, day: 2000, week: 10000 },
            interval: 5,
            benefits: { hp: 15, kcal: 80, ml: 100 },
            descKey: "insUltimateDesc",
          },

          // Zdrowie
          {
            id: "health_basic",
            nameKey: "insHealthBasic",
            icon: "❤️",
            prices: { hour: 40, day: 150, week: 800 },
            interval: 10,
            benefits: { hp: 8, kcal: 0, ml: 0 },
            descKey: "insHealthBasicDesc",
          },

          {
            id: "health_plus",
            nameKey: "insHealthPlus",
            icon: "❤️‍🔥",
            prices: { hour: 80, day: 300, week: 1500 },
            interval: 8,
            benefits: { hp: 15, kcal: 0, ml: 0 },
            descKey: "insHealthPlusDesc",
          },

          // Jedzenie
          {
            id: "food_basic",
            nameKey: "insFoodBasic",
            icon: "🍞",
            prices: { hour: 30, day: 120, week: 600 },
            interval: 10,
            benefits: { hp: 0, kcal: 60, ml: 0 },
            descKey: "insFoodBasicDesc",
          },

          {
            id: "food_plus",
            nameKey: "insFoodPlus",
            icon: "🍔",
            prices: { hour: 70, day: 280, week: 1400 },
            interval: 8,
            benefits: { hp: 0, kcal: 120, ml: 0 },
            descKey: "insFoodPlusDesc",
          },

          // Picie
          {
            id: "water_basic",
            nameKey: "insWaterBasic",
            icon: "💧",
            prices: { hour: 25, day: 100, week: 500 },
            interval: 10,
            benefits: { hp: 0, kcal: 0, ml: 80 },
            descKey: "insWaterBasicDesc",
          },

          {
            id: "water_plus",
            nameKey: "insWaterPlus",
            icon: "🌊",
            prices: { hour: 60, day: 250, week: 1200 },
            interval: 8,
            benefits: { hp: 0, kcal: 0, ml: 150 },
            descKey: "insWaterPlusDesc",
          },

          // Mix 2 w 1
          {
            id: "health_food",
            nameKey: "insHealthFood",
            icon: "🍎",
            prices: { hour: 60, day: 250, week: 1200 },
            interval: 10,
            benefits: { hp: 5, kcal: 50, ml: 0 },
            descKey: "insHealthFoodDesc",
          },

          {
            id: "health_water",
            nameKey: "insHealthWater",
            icon: "💦",
            prices: { hour: 55, day: 220, week: 1100 },
            interval: 10,
            benefits: { hp: 5, kcal: 0, ml: 60 },
            descKey: "insHealthWaterDesc",
          },

          {
            id: "food_water",
            nameKey: "insFoodWater",
            icon: "🥗",
            prices: { hour: 50, day: 200, week: 1000 },
            interval: 10,
            benefits: { hp: 0, kcal: 50, ml: 60 },
            descKey: "insFoodWaterDesc",
          },

          // === UBEZPIECZENIA NA ULEPSZANIE AUT ===
          {
            id: "upgrade_basic",
            nameKey: "insUpgradeBasic",
            icon: "🔧",
            type: "upgrade",
            prices: { hour: 80, day: 300, week: 1500 },
            rateBonus: 0.05,
            safetyBonus: 0.001,
            descKey: "insUpgradeBasicDesc",
          },

          {
            id: "upgrade_plus",
            nameKey: "insUpgradePlus",
            icon: "⚙️",
            type: "upgrade",
            prices: { hour: 150, day: 600, week: 3000 },
            rateBonus: 0.1,
            safetyBonus: 0.002,
            descKey: "insUpgradePlusDesc",
          },

          {
            id: "upgrade_pro",
            nameKey: "insUpgradePro",
            icon: "🛠️",
            type: "upgrade",
            prices: { hour: 250, day: 1000, week: 5000 },
            rateBonus: 0.15,
            safetyBonus: 0.003,
            descKey: "insUpgradeProDesc",
          },

          {
            id: "upgrade_max",
            nameKey: "insUpgradeMax",
            icon: "🏎️",
            type: "upgrade",
            prices: { hour: 400, day: 1600, week: 8000 },
            rateBonus: 0.2,
            safetyBonus: 0.004,
            descKey: "insUpgradeMaxDesc",
          },

          // === UBEZPIECZENIA NA NAPRAWĘ ===
          {
            id: "repair_basic",
            nameKey: "insRepairBasic",
            icon: "🩹",
            type: "repair",
            prices: { hour: 30, day: 120, week: 600 },
            coveragePercent: 30,
            descKey: "insRepairBasicDesc",
          },

          {
            id: "repair_plus",
            nameKey: "insRepairPlus",
            icon: "🏗️",
            type: "repair",
            prices: { hour: 60, day: 240, week: 1200 },
            coveragePercent: 50,
            descKey: "insRepairPlusDesc",
          },

          {
            id: "repair_full",
            nameKey: "insRepairFull",
            icon: "🛡️",
            type: "repair",
            prices: { hour: 100, day: 400, week: 2000 },
            coveragePercent: 100,
            descKey: "insRepairFullDesc",
          },
        ];

        // Funkcja do pobierania nazwy ubezpieczenia
        function getInsuranceName(pkg) {
          const t = translations[currentLang] || translations.en;
          return t[pkg.nameKey] || pkg.nameKey;
        }

        function getInsuranceDesc(pkg) {
          const t = translations[currentLang] || translations.en;
          if (t[pkg.descKey]) return t[pkg.descKey];

          if (pkg.type === "upgrade") {
            return `+${pkg.rateBonus}%/s, -${Math.floor(
              ((pkg.safetyBonus * 1000) / 0.005) * 10
            )}% ${t.breakChance || "szansy zepsucia"}`;
          }
          if (pkg.type === "repair") {
            return `${pkg.coveragePercent}% ${
              t.repairCovered || "kosztów naprawy pokryte"
            }`;
          }

          return `+${pkg.benefits.hp} HP, +${pkg.benefits.kcal} kcal, +${pkg.benefits.ml} ml`;
        }

        let currentPin = "";
        let pendingAction = null;
        let currentEarnAmount = 0;
        let currentBuyPrice = 0;
        let currentSellPrice = 0;
        let selectedCarIndex = -1;
        const REPAIR_COST = 5000;

        // Produkty - jedzenie
        const foodItems = [
          {
            id: "burger",
            icon: "🍔",
            nameKey: "itemBurger",
            price: 150,
            kcal: 350,
            ml: 0,
            hp: -5,
          },
          {
            id: "pizza",
            icon: "🍕",
            nameKey: "itemPizza",
            price: 200,
            kcal: 400,
            ml: 0,
            hp: -5,
          },
          {
            id: "hotdog",
            icon: "🌭",
            nameKey: "itemHotdog",
            price: 100,
            kcal: 250,
            ml: 0,
            hp: -3,
          },
          {
            id: "fries",
            icon: "🍟",
            nameKey: "itemFries",
            price: 80,
            kcal: 300,
            ml: 0,
            hp: -5,
          },
          {
            id: "sandwich",
            icon: "🥪",
            nameKey: "itemSandwich",
            price: 120,
            kcal: 280,
            ml: 0,
            hp: 0,
          },
          {
            id: "salad",
            icon: "🥗",
            nameKey: "itemSalad",
            price: 180,
            kcal: 150,
            ml: 50,
            hp: 10,
          },
          {
            id: "apple",
            icon: "🍎",
            nameKey: "itemApple",
            price: 30,
            kcal: 80,
            ml: 50,
            hp: 5,
          },
          {
            id: "banana",
            icon: "🍌",
            nameKey: "itemBanana",
            price: 25,
            kcal: 100,
            ml: 20,
            hp: 3,
          },
          {
            id: "watermelon",
            icon: "🍉",
            nameKey: "itemWatermelon",
            price: 60,
            kcal: 50,
            ml: 200,
            hp: 8,
          },
          {
            id: "chicken",
            icon: "🍗",
            nameKey: "itemChicken",
            price: 220,
            kcal: 350,
            ml: 0,
            hp: 5,
          },
          {
            id: "steak",
            icon: "🥩",
            nameKey: "itemSteak",
            price: 350,
            kcal: 450,
            ml: 0,
            hp: 10,
          },
          {
            id: "sushi",
            icon: "🍣",
            nameKey: "itemSushi",
            price: 280,
            kcal: 200,
            ml: 30,
            hp: 8,
          },
          {
            id: "donut",
            icon: "🍩",
            nameKey: "itemDonut",
            price: 40,
            kcal: 250,
            ml: 0,
            hp: -8,
          },
          {
            id: "icecream",
            icon: "🍦",
            nameKey: "itemIcecream",
            price: 50,
            kcal: 200,
            ml: 30,
            hp: -3,
          },
          {
            id: "chocolate",
            icon: "🍫",
            nameKey: "itemChocolate",
            price: 35,
            kcal: 300,
            ml: 0,
            hp: -5,
          },
        ];

        // Produkty - napoje
        const drinkItems = [
          {
            id: "water",
            icon: "💧",
            nameKey: "itemWater",
            price: 20,
            kcal: 0,
            ml: 500,
            hp: 5,
          },
          {
            id: "cola",
            icon: "🥤",
            nameKey: "itemCola",
            price: 40,
            kcal: 150,
            ml: 330,
            hp: -5,
          },
          {
            id: "juice",
            icon: "🧃",
            nameKey: "itemJuice",
            price: 50,
            kcal: 100,
            ml: 250,
            hp: 3,
          },
          {
            id: "coffee",
            icon: "☕",
            nameKey: "itemCoffee",
            price: 60,
            kcal: 20,
            ml: 200,
            hp: 0,
          },
          {
            id: "tea",
            icon: "🍵",
            nameKey: "itemTea",
            price: 40,
            kcal: 5,
            ml: 250,
            hp: 5,
          },
          {
            id: "milk",
            icon: "🥛",
            nameKey: "itemMilk",
            price: 35,
            kcal: 80,
            ml: 300,
            hp: 5,
          },
          {
            id: "beer",
            icon: "🍺",
            nameKey: "itemBeer",
            price: 80,
            kcal: 150,
            ml: 500,
            hp: -10,
          },
          {
            id: "wine",
            icon: "🍷",
            nameKey: "itemWine",
            price: 150,
            kcal: 120,
            ml: 150,
            hp: -8,
          },
          {
            id: "smoothie",
            icon: "🥤",
            nameKey: "itemSmoothie",
            price: 100,
            kcal: 180,
            ml: 400,
            hp: 10,
          },
          {
            id: "energydrink",
            icon: "⚡",
            nameKey: "itemEnergyDrink",
            price: 70,
            kcal: 100,
            ml: 250,
            hp: -15,
          },
          {
            id: "lemonade",
            icon: "🍋",
            nameKey: "itemLemonade",
            price: 45,
            kcal: 80,
            ml: 300,
            hp: 3,
          },
          {
            id: "coconut",
            icon: "🥥",
            nameKey: "itemCoconut",
            price: 90,
            kcal: 50,
            ml: 350,
            hp: 8,
          },
        ];

        // Funkcja do pobierania nazwy produktu
        function getItemName(item) {
          const t = translations[currentLang] || translations.en;
          return t[item.nameKey] || item.nameKey;
        }

        let currentShopTab = "food";

        // Lista wszystkich aut z BeamNG.drive z cenami
        const beamngCars = [
          // Autobello
          {
            id: "autobuggy",
            brand: "Autobello",
            model: "Autobuggy",
            year: "2018-2022",
            price: 45000,
            type: "buggy",
          },
          {
            id: "piccolina",
            brand: "Autobello",
            model: "Piccolina",
            year: "1957-1973",
            price: 8000,
            type: "classic",
          },
          {
            id: "stambecco",
            brand: "Autobello",
            model: "Stambecco",
            year: "1971-1988",
            price: 15000,
            type: "offroad",
          },

          // Bruckell
          {
            id: "bastion",
            brand: "Bruckell",
            model: "Bastion",
            year: "2016-2022",
            price: 42000,
            type: "muscle",
          },
          {
            id: "legran",
            brand: "Bruckell",
            model: "LeGran",
            year: "1984-1993",
            price: 12000,
            type: "sedan",
          },
          {
            id: "moonhawk",
            brand: "Bruckell",
            model: "Moonhawk",
            year: "1973-1978",
            price: 25000,
            type: "muscle",
          },
          {
            id: "nine",
            brand: "Bruckell",
            model: "Nine",
            year: "1933-1934",
            price: 35000,
            type: "classic",
          },

          // Burnside
          {
            id: "special",
            brand: "Burnside",
            model: "Special",
            year: "1952-1954",
            price: 28000,
            type: "classic",
          },

          // Cherrier
          {
            id: "tograc",
            brand: "Cherrier",
            model: "Tograc",
            year: "2020-2024",
            price: 38000,
            type: "suv",
          },
          {
            id: "vivace",
            brand: "Cherrier",
            model: "Vivace",
            year: "2020-2024",
            price: 32000,
            type: "hatchback",
          },

          // Civetta
          {
            id: "bolide",
            brand: "Civetta",
            model: "Bolide",
            year: "1981-1988",
            price: 85000,
            type: "supercar",
          },
          {
            id: "scintilla",
            brand: "Civetta",
            model: "Scintilla",
            year: "2020-2022",
            price: 120000,
            type: "supercar",
          },

          // ETK
          {
            id: "etk800",
            brand: "ETK",
            model: "800 Series",
            year: "2013-2018",
            price: 55000,
            type: "sedan",
          },
          {
            id: "etkiseries",
            brand: "ETK",
            model: "I-Series",
            year: "1985-1993",
            price: 18000,
            type: "coupe",
          },
          {
            id: "etkkseries",
            brand: "ETK",
            model: "K-Series",
            year: "2015-2021",
            price: 75000,
            type: "suv",
          },

          // FPU
          {
            id: "wydra",
            brand: "FPU",
            model: "Wydra",
            year: "2008-2023",
            price: 22000,
            type: "military",
          },

          // Gavril
          {
            id: "barstow",
            brand: "Gavril",
            model: "Barstow",
            year: "1969-1971",
            price: 35000,
            type: "muscle",
          },
          {
            id: "bluebuck",
            brand: "Gavril",
            model: "Bluebuck",
            year: "1962-1963",
            price: 32000,
            type: "classic",
          },
          {
            id: "dseries",
            brand: "Gavril",
            model: "D-Series",
            year: "1986-2003",
            price: 28000,
            type: "pickup",
          },
          {
            id: "grandmarshal",
            brand: "Gavril",
            model: "Grand Marshal",
            year: "1990-1997",
            price: 18000,
            type: "sedan",
          },
          {
            id: "hseries",
            brand: "Gavril",
            model: "H-Series",
            year: "1993-2017",
            price: 35000,
            type: "van",
          },
          {
            id: "roamer",
            brand: "Gavril",
            model: "Roamer",
            year: "1992-2005",
            price: 32000,
            type: "suv",
          },
          {
            id: "tseries",
            brand: "Gavril",
            model: "T-Series",
            year: "1972-1986",
            price: 65000,
            type: "truck",
          },
          {
            id: "mdseries",
            brand: "Gavril",
            model: "MD-Series",
            year: "1986-1998",
            price: 45000,
            type: "truck",
          },

          // Hirochi
          {
            id: "aurata",
            brand: "Hirochi",
            model: "Aurata",
            year: "2016-2022",
            price: 42000,
            type: "sport",
          },
          {
            id: "esbr",
            brand: "Hirochi",
            model: "eSBR",
            year: "2013-2020",
            price: 95000,
            type: "electric",
          },
          {
            id: "sbr4",
            brand: "Hirochi",
            model: "SBR4",
            year: "2013-2020",
            price: 68000,
            type: "sport",
          },
          {
            id: "sunburst",
            brand: "Hirochi",
            model: "Sunburst",
            year: "2009-2014",
            price: 28000,
            type: "sport",
          },

          // Ibishu
          {
            id: "200bx",
            brand: "Ibishu",
            model: "200BX",
            year: "1990-1994",
            price: 15000,
            type: "coupe",
          },
          {
            id: "240bx",
            brand: "Ibishu",
            model: "240BX",
            year: "1990-1994",
            price: 18000,
            type: "coupe",
          },
          {
            id: "covet",
            brand: "Ibishu",
            model: "Covet",
            year: "1986-1992",
            price: 8000,
            type: "hatchback",
          },
          {
            id: "diana",
            brand: "Ibishu",
            model: "Diana",
            year: "1990-1994",
            price: 12000,
            type: "sedan",
          },
          {
            id: "hopper",
            brand: "Ibishu",
            model: "Hopper",
            year: "1989-2001",
            price: 18000,
            type: "offroad",
          },
          {
            id: "miramar",
            brand: "Ibishu",
            model: "Miramar",
            year: "1963-1994",
            price: 22000,
            type: "classic",
          },
          {
            id: "pessima",
            brand: "Ibishu",
            model: "Pessima",
            year: "1988-2000",
            price: 10000,
            type: "sedan",
          },
          {
            id: "pigeon",
            brand: "Ibishu",
            model: "Pigeon",
            year: "1980-1989",
            price: 3000,
            type: "microcar",
          },
          {
            id: "wigeon",
            brand: "Ibishu",
            model: "Wigeon",
            year: "1980-1989",
            price: 4500,
            type: "microcar",
          },

          // Soliad
          {
            id: "wendover",
            brand: "Soliad",
            model: "Wendover",
            year: "1987-1995",
            price: 14000,
            type: "sedan",
          },
          {
            id: "lansdale",
            brand: "Soliad",
            model: "Lansdale",
            year: "1996-2007",
            price: 22000,
            type: "sedan",
          },

          // SP
          {
            id: "dunekicker",
            brand: "SP",
            model: "Dunekicker",
            year: "2008",
            price: 55000,
            type: "buggy",
          },
          {
            id: "rockbasher",
            brand: "SP",
            model: "Rockbasher",
            year: "2008-2018",
            price: 48000,
            type: "offroad",
          },

          // Wentward
          {
            id: "dt40l",
            brand: "Wentward",
            model: "DT40L",
            year: "1987-1996",
            price: 85000,
            type: "bus",
          },
        ];

        // Lista prawdziwych aut dla trybu Real Life (ceny realne -10%)
        const realLifeCars = [
          // Małe / Miejskie
          {
            id: "fiat500",
            brand: "Fiat",
            model: "500",
            year: "2020-2024",
            price: 54000,
            type: "microcar",
          },
          {
            id: "toyota_yaris",
            brand: "Toyota",
            model: "Yaris",
            year: "2020-2024",
            price: 72000,
            type: "hatchback",
          },
          {
            id: "vw_polo",
            brand: "Volkswagen",
            model: "Polo",
            year: "2021-2024",
            price: 81000,
            type: "hatchback",
          },
          {
            id: "skoda_fabia",
            brand: "Škoda",
            model: "Fabia",
            year: "2021-2024",
            price: 67500,
            type: "hatchback",
          },
          {
            id: "opel_corsa",
            brand: "Opel",
            model: "Corsa",
            year: "2020-2024",
            price: 63000,
            type: "hatchback",
          },

          // Kompaktowe
          {
            id: "vw_golf",
            brand: "Volkswagen",
            model: "Golf",
            year: "2020-2024",
            price: 117000,
            type: "hatchback",
          },
          {
            id: "toyota_corolla",
            brand: "Toyota",
            model: "Corolla",
            year: "2020-2024",
            price: 108000,
            type: "sedan",
          },
          {
            id: "mazda3",
            brand: "Mazda",
            model: "3",
            year: "2020-2024",
            price: 99000,
            type: "hatchback",
          },
          {
            id: "honda_civic",
            brand: "Honda",
            model: "Civic",
            year: "2022-2024",
            price: 126000,
            type: "sedan",
          },
          {
            id: "ford_focus",
            brand: "Ford",
            model: "Focus",
            year: "2019-2023",
            price: 90000,
            type: "hatchback",
          },

          // Sedany
          {
            id: "bmw_3",
            brand: "BMW",
            model: "3 Series",
            year: "2020-2024",
            price: 189000,
            type: "sedan",
          },
          {
            id: "mercedes_c",
            brand: "Mercedes-Benz",
            model: "C-Class",
            year: "2021-2024",
            price: 207000,
            type: "sedan",
          },
          {
            id: "audi_a4",
            brand: "Audi",
            model: "A4",
            year: "2020-2024",
            price: 180000,
            type: "sedan",
          },
          {
            id: "skoda_octavia",
            brand: "Škoda",
            model: "Octavia",
            year: "2020-2024",
            price: 108000,
            type: "sedan",
          },
          {
            id: "toyota_camry",
            brand: "Toyota",
            model: "Camry",
            year: "2020-2024",
            price: 144000,
            type: "sedan",
          },

          // SUV
          {
            id: "toyota_rav4",
            brand: "Toyota",
            model: "RAV4",
            year: "2020-2024",
            price: 162000,
            type: "suv",
          },
          {
            id: "vw_tiguan",
            brand: "Volkswagen",
            model: "Tiguan",
            year: "2020-2024",
            price: 153000,
            type: "suv",
          },
          {
            id: "bmw_x3",
            brand: "BMW",
            model: "X3",
            year: "2021-2024",
            price: 243000,
            type: "suv",
          },
          {
            id: "mercedes_glc",
            brand: "Mercedes-Benz",
            model: "GLC",
            year: "2020-2024",
            price: 252000,
            type: "suv",
          },
          {
            id: "audi_q5",
            brand: "Audi",
            model: "Q5",
            year: "2020-2024",
            price: 234000,
            type: "suv",
          },
          {
            id: "volvo_xc60",
            brand: "Volvo",
            model: "XC60",
            year: "2020-2024",
            price: 225000,
            type: "suv",
          },
          {
            id: "hyundai_tucson",
            brand: "Hyundai",
            model: "Tucson",
            year: "2021-2024",
            price: 135000,
            type: "suv",
          },
          {
            id: "kia_sportage",
            brand: "Kia",
            model: "Sportage",
            year: "2022-2024",
            price: 126000,
            type: "suv",
          },

          // Sportowe
          {
            id: "porsche_911",
            brand: "Porsche",
            model: "911 Carrera",
            year: "2020-2024",
            price: 630000,
            type: "sport",
          },
          {
            id: "bmw_m4",
            brand: "BMW",
            model: "M4",
            year: "2021-2024",
            price: 450000,
            type: "sport",
          },
          {
            id: "audi_rs6",
            brand: "Audi",
            model: "RS6 Avant",
            year: "2020-2024",
            price: 585000,
            type: "sport",
          },
          {
            id: "mercedes_amg_gt",
            brand: "Mercedes-AMG",
            model: "GT",
            year: "2020-2024",
            price: 720000,
            type: "supercar",
          },
          {
            id: "ford_mustang",
            brand: "Ford",
            model: "Mustang GT",
            year: "2020-2024",
            price: 270000,
            type: "muscle",
          },
          {
            id: "chevrolet_camaro",
            brand: "Chevrolet",
            model: "Camaro SS",
            year: "2020-2024",
            price: 243000,
            type: "muscle",
          },
          {
            id: "nissan_gtr",
            brand: "Nissan",
            model: "GT-R",
            year: "2020-2024",
            price: 540000,
            type: "sport",
          },
          {
            id: "toyota_supra",
            brand: "Toyota",
            model: "GR Supra",
            year: "2020-2024",
            price: 270000,
            type: "sport",
          },

          // Elektryczne
          {
            id: "tesla_model3",
            brand: "Tesla",
            model: "Model 3",
            year: "2020-2024",
            price: 180000,
            type: "electric",
          },
          {
            id: "tesla_modelS",
            brand: "Tesla",
            model: "Model S",
            year: "2020-2024",
            price: 450000,
            type: "electric",
          },
          {
            id: "bmw_i4",
            brand: "BMW",
            model: "i4",
            year: "2022-2024",
            price: 270000,
            type: "electric",
          },
          {
            id: "mercedes_eqs",
            brand: "Mercedes-Benz",
            model: "EQS",
            year: "2022-2024",
            price: 540000,
            type: "electric",
          },
          {
            id: "porsche_taycan",
            brand: "Porsche",
            model: "Taycan",
            year: "2020-2024",
            price: 450000,
            type: "electric",
          },

          // Pickupy / Terenowe
          {
            id: "ford_ranger",
            brand: "Ford",
            model: "Ranger",
            year: "2020-2024",
            price: 180000,
            type: "pickup",
          },
          {
            id: "toyota_hilux",
            brand: "Toyota",
            model: "Hilux",
            year: "2020-2024",
            price: 189000,
            type: "pickup",
          },
          {
            id: "jeep_wrangler",
            brand: "Jeep",
            model: "Wrangler",
            year: "2020-2024",
            price: 270000,
            type: "offroad",
          },
          {
            id: "land_rover_defender",
            brand: "Land Rover",
            model: "Defender",
            year: "2020-2024",
            price: 315000,
            type: "offroad",
          },

          // Vany / Dostawcze
          {
            id: "vw_transporter",
            brand: "Volkswagen",
            model: "Transporter",
            year: "2020-2024",
            price: 180000,
            type: "van",
          },
          {
            id: "ford_transit",
            brand: "Ford",
            model: "Transit",
            year: "2020-2024",
            price: 162000,
            type: "van",
          },
          {
            id: "mercedes_sprinter",
            brand: "Mercedes-Benz",
            model: "Sprinter",
            year: "2020-2024",
            price: 189000,
            type: "van",
          },

          // Luksusowe
          {
            id: "bmw_7",
            brand: "BMW",
            model: "7 Series",
            year: "2020-2024",
            price: 450000,
            type: "sedan",
          },
          {
            id: "mercedes_s",
            brand: "Mercedes-Benz",
            model: "S-Class",
            year: "2021-2024",
            price: 540000,
            type: "sedan",
          },
          {
            id: "audi_a8",
            brand: "Audi",
            model: "A8",
            year: "2020-2024",
            price: 495000,
            type: "sedan",
          },
          {
            id: "bentley_continental",
            brand: "Bentley",
            model: "Continental GT",
            year: "2020-2024",
            price: 990000,
            type: "supercar",
          },
          {
            id: "rolls_royce_ghost",
            brand: "Rolls-Royce",
            model: "Ghost",
            year: "2020-2024",
            price: 1530000,
            type: "sedan",
          },
        ];

        // ==================== SYSTEM TRYBU GRY ====================
        // gameMode jest zdefiniowane wcześniej (przed loadSaveData)

        function getCurrentCars() {
          return gameMode === "reallife" ? realLifeCars : beamngCars;
        }

        function switchGameMode(mode) {
          const save = getCurrentSave();
          if (!save) return;

          // Zatrzymaj wszystkie ulepszania przed zmianą trybu
          Object.keys(upgradeIntervals).forEach((idx) => {
            clearInterval(upgradeIntervals[idx]);
          });
          upgradeIntervals = {};

          // Zapisz aktualny stan do obecnego trybu
          saveModeData(gameMode);

          // Zmień tryb
          gameMode = mode;
          localStorage.setItem("beamng_gameMode", mode);

          // Załaduj dane dla nowego trybu lub utwórz nowe
          loadModeData(mode);

          // Aktualizuj UI
          updateGameModeUI();
          updateAllDisplays();
          renderGarageModal();
          closeModal("gameMode");
        }

        function saveModeData(mode) {
          const save = getCurrentSave();
          if (!save) return;

          const modeKey = mode === "reallife" ? "realLifeData" : "beamngData";
          save[modeKey] = {
            money: money,
            garage: [...garage],
            spent: spent,
            debt: debt,
            debtDeadline: debtDeadline,
            totalTaxPaid: totalTaxPaid,
            health: health,
            food: food,
            water: water,
            backpack: [...backpack],
            activeInsurances: [...activeInsurances],
          };
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
        }

        function loadModeData(mode) {
          const save = getCurrentSave();
          if (!save) return;

          const modeKey = mode === "reallife" ? "realLifeData" : "beamngData";
          const data = save[modeKey];

          if (data) {
            // Załaduj istniejące dane
            money = data.money;
            garage = data.garage || [];
            spent = data.spent || 0;
            debt = data.debt || 0;
            debtDeadline = data.debtDeadline || null;
            totalTaxPaid = data.totalTaxPaid || 0;
            health = data.health || 100;
            food = data.food || 1000;
            water = data.water || 1000;
            backpack = data.backpack || [];
            activeInsurances = data.activeInsurances || [];
          } else {
            // Pierwszy raz w tym trybie - nowy start
            money = 1500;
            garage = [];
            spent = 0;
            debt = 0;
            debtDeadline = null;
            totalTaxPaid = 0;
            health = 100;
            food = 1000;
            water = 1000;
            backpack = [];
            activeInsurances = [];
          }

          // Wznów ulepszania
          resumeUpgrades();
        }

        function updateGameModeUI() {
          const title = document.getElementById("gameModeTitle");
          const subtitle = document.getElementById("gameModeSubtitle");
          const t = translations[currentLang] || translations.en;

          // Elementy karty
          const cardBtn = document.querySelector('[data-translate="card"]');
          const cardTitle = document.querySelector(
            '#modalCard h2 [data-translate="card"]'
          );
          const cardLogo = document.querySelector(".card-logo");
          const pinInfo = document.querySelector(
            '[data-translate="enter6digitPin"]'
          );

          // Elementy bonów
          const vouchersTitle = document.querySelector(
            '#modalVouchers h2 [data-translate="vouchers"]'
          );
          const createVoucherBtns = document.querySelectorAll(
            '[data-translate="createVoucher"]'
          );
          const vouchersToSendTitle = document.querySelector(
            '[data-translate="vouchersToSend"]'
          );
          const receivedVouchersTitle = document.querySelector(
            '[data-translate="receivedVouchers"]'
          );
          const shareVoucherTitle = document.querySelector(
            '#modalShareVoucher h2 [data-translate="shareVoucher"]'
          );

          if (gameMode === "reallife") {
            title.textContent = "🌍 Real Life";
            subtitle.textContent = t.simulator || "Symulator";
            document.body.style.background =
              "linear-gradient(135deg, #064e3b 0%, #022c22 100%)";

            // Zmień nazwę karty
            if (cardBtn)
              cardBtn.textContent = t.cardRealLife || "Karta Real-Card";
            if (cardTitle)
              cardTitle.textContent = t.cardRealLife || "Karta Real-Card";
            if (cardLogo) cardLogo.textContent = "Real-Card";
            if (pinInfo)
              pinInfo.textContent =
                currentLang === "pl"
                  ? "Wpisz 6-cyfrowy PIN z karty Real-Card"
                  : "Enter 6-digit PIN from Real-Card";

            // Zmień nazwy bonów na kupony
            if (vouchersTitle)
              vouchersTitle.textContent = t.vouchersRealLife || "Kupony";
            createVoucherBtns.forEach(
              (btn) =>
                (btn.textContent = t.createVoucherRealLife || "Utwórz kupon")
            );
            if (vouchersToSendTitle)
              vouchersToSendTitle.textContent =
                currentLang === "pl" ? "Kupony do wysłania" : "Coupons to send";
            if (receivedVouchersTitle)
              receivedVouchersTitle.textContent =
                currentLang === "pl" ? "Otrzymane kupony" : "Received coupons";
            if (shareVoucherTitle)
              shareVoucherTitle.textContent =
                currentLang === "pl" ? "Wyślij kupon" : "Send coupon";
          } else {
            title.textContent = "🚗 BeamNG Drive";
            subtitle.textContent = "Datapack";
            document.body.style.background =
              "linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)";

            // Zmień nazwę karty
            if (cardBtn) cardBtn.textContent = t.card || "Karta Beam-Pay";
            if (cardTitle) cardTitle.textContent = t.card || "Karta Beam-Pay";
            if (cardLogo) cardLogo.textContent = "Beam-Pay";
            if (pinInfo)
              pinInfo.textContent =
                currentLang === "pl"
                  ? "Wpisz 6-cyfrowy PIN z karty Beam-Pay"
                  : "Enter 6-digit PIN from Beam-Pay Card";

            // Zmień nazwy bonów
            if (vouchersTitle) vouchersTitle.textContent = t.vouchers || "Bony";
            createVoucherBtns.forEach(
              (btn) => (btn.textContent = t.createVoucher || "Utwórz bon")
            );
            if (vouchersToSendTitle)
              vouchersToSendTitle.textContent =
                currentLang === "pl" ? "Bony do wysłania" : "Vouchers to send";
            if (receivedVouchersTitle)
              receivedVouchersTitle.textContent =
                currentLang === "pl" ? "Otrzymane bony" : "Received vouchers";
            if (shareVoucherTitle)
              shareVoucherTitle.textContent =
                currentLang === "pl" ? "Wyślij bon" : "Send voucher";
          }

          // Podświetl aktywny tryb w modalu
          const beamngBtn = document.getElementById("modeBeamNG");
          const reallifeBtn = document.getElementById("modeRealLife");

          if (beamngBtn && reallifeBtn) {
            beamngBtn.style.borderColor =
              gameMode === "beamng" ? "#fff" : "transparent";
            reallifeBtn.style.borderColor =
              gameMode === "reallife" ? "#fff" : "transparent";
          }
        }

        // ==================== UI SAVE'ÓW ====================
        function renderSavesList() {
          const list = document.getElementById("savesList");
          const t = translations[currentLang] || translations.en;
          const activeText = t.active || "aktywny";

          list.innerHTML = saves
            .map((save) => {
              const isCurrent = save.id === currentSaveId;

              // Sprawdź checkpoint dla aktywnego save'a
              const modeKey =
                gameMode === "reallife"
                  ? "realLifeCheckpoint"
                  : "beamngCheckpoint";
              const hasCheckpoint = save[modeKey] ? true : false;
              const checkpointDate = hasCheckpoint
                ? new Date(save[modeKey].createdAt).toLocaleString()
                : null;

              // Pobierz dane z odpowiedniego trybu
              const modeDataKey =
                gameMode === "reallife" ? "realLifeData" : "beamngData";
              const modeData = save[modeDataKey] || save.data;
              const garageCount =
                modeData?.garage?.length || save.data?.garage?.length || 0;
              const saveMoney = modeData?.money ?? save.data?.money ?? 0;

              return `
                    <div style="padding:12px;margin-bottom:8px;background:${
                      isCurrent ? "rgba(74,222,128,0.2)" : "rgba(0,0,0,0.2)"
                    };border:2px solid ${
                isCurrent ? "#4ade80" : "#333"
              };border-radius:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                            <div style="flex:1;min-width:120px;">
                                <div style="font-weight:bold;font-size:1em;">${
                                  save.name
                                }</div>
                                <div style="font-size:0.8em;color:#888;">${saveMoney.toLocaleString()} ${getCurrency()} | 🚗 ${garageCount}</div>
                            </div>
                            <div style="display:flex;gap:8px;flex-shrink:0;">
                                <button onclick="renameSave('${
                                  save.id
                                }')" style="padding:10px 14px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;min-width:44px;min-height:44px;-webkit-tap-highlight-color:transparent;">✏️</button>
                                ${
                                  !isCurrent
                                    ? `<button onclick="switchSave('${save.id}')" style="padding:10px 16px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;min-width:44px;min-height:44px;-webkit-tap-highlight-color:transparent;">▶</button>`
                                    : `<span style="color:#4ade80;font-size:0.85em;padding:10px;">✓ ${activeText}</span>`
                                }
                                ${
                                  saves.length > 1
                                    ? `<button onclick="handleDeleteSave('${save.id}')" style="padding:10px 16px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;min-width:44px;min-height:44px;-webkit-tap-highlight-color:transparent;">🗑️</button>`
                                    : ""
                                }
                            </div>
                        </div>
                        ${
                          isCurrent
                            ? `
                            <div style="margin-top:10px;padding-top:10px;border-top:1px solid #333;">
                                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                                    <div style="font-size:0.85em;">
                                        ${
                                          hasCheckpoint
                                            ? `
                                            <span style="color:#4ade80;">💾 ${
                                              t.checkpoint || "Checkpoint"
                                            }: ${checkpointDate}</span>
                                        `
                                            : `
                                            <span style="color:#888;">📭 ${
                                              t.noCheckpoint ||
                                              "Brak checkpointu"
                                            }</span>
                                        `
                                        }
                                    </div>
                                    <div style="display:flex;gap:6px;">
                                        <button onclick="createCheckpoint()" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">
                                            💾 ${t.saveCheckpoint || "Zapisz"}
                                        </button>
                                        ${
                                          hasCheckpoint
                                            ? `
                                            <button onclick="deleteCheckpoint()" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">
                                                🗑️
                                            </button>
                                        `
                                            : ""
                                        }
                                    </div>
                                </div>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
            })
            .join("");
        }

        function renameSave(saveId) {
          const save = saves.find((s) => s.id === saveId);
          if (!save) return;

          const t = translations[currentLang] || translations.en;
          const newName = prompt(
            t.enterNewName || "Wprowadź nową nazwę:",
            save.name
          );

          if (newName && newName.trim()) {
            save.name = newName.trim();
            localStorage.setItem("beamng_saves", JSON.stringify(saves));
            renderSavesList();
            updateCurrentSaveDisplay();
          }
        }

        function handleCreateSave() {
          const nameInput = document.getElementById("newSaveName");
          const name = nameInput.value.trim() || "Save " + (saves.length + 1);

          const newSave = createSave(name);
          nameInput.value = "";

          renderSavesList();
          updateCurrentSaveDisplay();

          const t = translations[currentLang] || translations.en;
          alert(t.saveCreated || "Save utworzony!");
        }

        function handleDeleteSave(saveId) {
          const t = translations[currentLang] || translations.en;
          if (confirm(t.confirmDeleteSave || "Usunąć ten save?")) {
            if (deleteSave(saveId)) {
              renderSavesList();
              updateAllDisplays();
              updateCurrentSaveDisplay();
            }
          }
        }

        function updateCurrentSaveDisplay() {
          const display = document.getElementById("currentSaveDisplay");
          const save = getCurrentSave();
          if (display && save) {
            display.textContent = "💾 " + save.name;
          }
        }

        // ==================== UI BONÓW ====================
        let currentVoucherToShare = null;

        function renderVouchersList() {
          const toSendList = document.getElementById("vouchersToSendList");
          const receivedList = document.getElementById("receivedVouchersList");
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();

          const noVouchersText =
            gameMode === "reallife"
              ? currentLang === "pl"
                ? "Brak kuponów"
                : "No coupons"
              : t.noVouchers || "Brak bonów";
          const noReceivedText =
            gameMode === "reallife"
              ? currentLang === "pl"
                ? "Brak otrzymanych kuponów"
                : "No received coupons"
              : t.noReceivedVouchers || "Brak otrzymanych bonów";

          if (!save || !save.data) {
            if (toSendList)
              toSendList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noVouchersText}</div>`;
            if (receivedList)
              receivedList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noReceivedText}</div>`;
            return;
          }

          // Bony do wysłania - filtruj według aktualnego trybu
          const allVouchersToSend = save.data.vouchersToSend || [];
          const vouchersToSend = allVouchersToSend.filter(
            (v) => (v.gameMode || "beamng") === gameMode
          );

          if (vouchersToSend.length === 0) {
            toSendList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noVouchersText}</div>`;
          } else {
            toSendList.innerHTML = vouchersToSend
              .map((v, idx) => {
                // Znajdź rzeczywisty indeks w pełnej tablicy
                const realIdx = allVouchersToSend.findIndex(
                  (vv) => vv.id === v.id
                );
                return `
                    <div style="padding:12px;margin-bottom:8px;background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(168,85,247,0.1));border:2px solid #8b5cf6;border-radius:12px;">
                        ${renderVoucherCard(v)}
                        <div style="font-size:0.75em;color:#f59e0b;text-align:center;margin:8px 0;">⏳ ${
                          t.pendingVoucher || "Oczekuje na przyjęcie"
                        }</div>
                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <button onclick="openShareVoucher(${realIdx}, 'toSend')" style="flex:1;padding:10px;background:#8b5cf6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;-webkit-tap-highlight-color:transparent;">
                                📤 ${
                                  gameMode === "reallife"
                                    ? currentLang === "pl"
                                      ? "Wyślij"
                                      : "Send"
                                    : t.sendVoucher || "Wyślij"
                                }
                            </button>
                            <button onclick="cancelVoucher(${realIdx})" style="padding:10px 15px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;-webkit-tap-highlight-color:transparent;">
                                ❌
                            </button>
                        </div>
                    </div>
                `;
              })
              .join("");
          }

          // Otrzymane bony - filtruj według aktualnego trybu
          const allReceivedVouchers = save?.data?.receivedVouchers || [];
          const receivedVouchers = allReceivedVouchers.filter(
            (v) => (v.gameMode || "beamng") === gameMode
          );

          if (receivedVouchers.length === 0) {
            receivedList.innerHTML = `<div style="color:#888;text-align:center;padding:15px;font-size:0.9em;">${noReceivedText}</div>`;
          } else {
            receivedList.innerHTML = receivedVouchers
              .map((v, idx) => {
                // Znajdź rzeczywisty indeks w pełnej tablicy
                const realIdx = allReceivedVouchers.findIndex(
                  (vv) => vv.id === v.id
                );
                return `
                    <div style="padding:12px;margin-bottom:8px;background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.1));border:2px solid #10b981;border-radius:12px;">
                        ${renderVoucherCard(v)}
                        <div style="font-size:0.8em;color:#888;margin-bottom:8px;">${
                          t.voucherFrom || "Od:"
                        } ${v.fromSave || "?"}</div>
                        <div style="display:flex;gap:8px;">
                            <button onclick="acceptVoucher(${realIdx})" style="flex:1;padding:10px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;">
                                ✅ ${t.acceptVoucher || "Przyjmij"}
                            </button>
                            <button onclick="rejectVoucher(${realIdx})" style="flex:1;padding:10px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9em;">
                                ↩️ ${t.rejectVoucher || "Przekaż dalej"}
                            </button>
                        </div>
                    </div>
                `;
              })
              .join("");
          }
        }

        function renderVoucherCard(voucher) {
          const voucherMode = voucher.gameMode || gameMode;
          const isRealLife = voucherMode === "reallife";
          const titleText = isRealLife
            ? currentLang === "pl"
              ? "KUPON PODARUNKOWY"
              : "GIFT COUPON"
            : currentLang === "pl"
            ? "BON PODARUNKOWY"
            : "GIFT VOUCHER";
          const bgGradient = isRealLife
            ? "linear-gradient(145deg,#064e3b,#022c22)"
            : "linear-gradient(145deg,#1a1a2e,#16213e)";
          const borderColor = isRealLife ? "#10b981" : "#8b5cf6";
          const amountColor = isRealLife ? "#10b981" : "#8b5cf6";

          return `
                <div style="background:${bgGradient};border-radius:10px;padding:15px;text-align:center;border:1px dashed ${borderColor};">
                    <div style="font-size:2.5em;margin-bottom:5px;">${
                      isRealLife ? "🎫" : "🎁"
                    }</div>
                    <div style="font-size:0.8em;color:#888;text-transform:uppercase;letter-spacing:2px;">${titleText}</div>
                    <div style="font-size:2em;font-weight:bold;color:${amountColor};margin:10px 0;">${voucher.amount.toLocaleString()} ${getCurrency()}</div>
                    ${
                      voucher.message
                        ? `<div style="font-size:0.9em;color:#aaa;font-style:italic;">"${voucher.message}"</div>`
                        : ""
                    }
                </div>
            `;
        }

        function handleCreateVoucher() {
          const amountInput = document.getElementById("voucherAmountInput");
          const messageInput = document.getElementById("voucherMessageInput");
          const t = translations[currentLang] || translations.en;

          const amount = parseInt(amountInput.value);
          if (!amount || amount <= 0) {
            alert(t.invalidAmount || "Wprowadź prawidłową kwotę!");
            return;
          }

          // Sprawdź czy masz tyle pieniędzy (uwzględnij już utworzone bony)
          const save = getCurrentSave();
          if (!save) return;
          if (!save.data) save.data = {};

          // Filtruj bony tylko z aktualnego trybu
          const pendingTotal = (save.data.vouchersToSend || [])
            .filter((v) => v.gameMode === gameMode)
            .reduce((sum, v) => sum + v.amount, 0);

          if (money - pendingTotal < amount) {
            playSound("error");
            alert(t.notEnoughMoney || "Nie masz wystarczająco pieniędzy!");
            return;
          }

          const voucher = {
            id:
              "bon_" +
              Date.now() +
              "_" +
              Math.random().toString(36).substr(2, 6),
            amount: amount,
            message: messageInput.value.trim(),
            createdAt: Date.now(),
            fromSave: save.name,
            fromSaveId: save.id,
            gameMode: gameMode, // Zapisz tryb gry
          };

          // NIE odejmuj pieniędzy - tylko dodaj do listy oczekujących
          if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
          save.data.vouchersToSend.push(voucher);

          saveSaveData();

          amountInput.value = "";
          messageInput.value = "";
          renderVouchersList();

          // Od razu otwórz udostępnianie
          currentVoucherToShare = {
            voucher,
            index: save.data.vouchersToSend.length - 1,
            source: "toSend",
          };
          openShareModal();
        }

        function cancelVoucher(idx) {
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();

          if (!save.data.vouchersToSend || !save.data.vouchersToSend[idx])
            return;

          // Bon jeszcze nie był przyjęty, więc nic nie tracisz
          if (confirm(t.cancelVoucherConfirm || "Anulować bon?")) {
            save.data.vouchersToSend.splice(idx, 1);
            saveSaveData();
            updateAllDisplays();
            renderVouchersList();
          }
        }

        function openShareVoucher(idx, source) {
          const save = getCurrentSave();
          const vouchers =
            source === "toSend"
              ? save.data.vouchersToSend
              : save.data.receivedVouchers;

          if (!vouchers || !vouchers[idx]) return;

          currentVoucherToShare = {
            voucher: vouchers[idx],
            index: idx,
            source,
          };
          openShareModal();
        }

        function openShareModal() {
          if (!currentVoucherToShare) return;

          const v = currentVoucherToShare.voucher;
          const t = translations[currentLang] || translations.en;

          document.getElementById("shareVoucherPreview").innerHTML =
            renderVoucherCard(v);

          // Generuj przyciski udostępniania
          const buttonsDiv = document.getElementById("shareVoucherButtons");

          // Lista innych save'ów (nie aktualny)
          const otherSaves = saves.filter((s) => s.id !== currentSaveId);

          // Pobierz znajomych (lokalnie)
          const friends = getFriendsList();

          buttonsDiv.innerHTML = `
                <!-- Wyślij do znajomego -->
                ${
                  friends.length > 0
                    ? `
                    <p style="margin-bottom:5px;font-weight:bold;">⭐ ${
                      t.sendToFriend || "Wyślij do znajomego:"
                    }</p>
                    <p style="color:#f59e0b;font-size:0.8em;margin-bottom:10px;">💰 Opłata: ${VOUCHER_SEND_FEE} ${getCurrency()}</p>
                    <div style="display:flex;flex-direction:column;gap:6px;max-height:150px;overflow-y:auto;margin-bottom:15px;">
                        ${friends
                          .map(
                            (name) => `
                            <button onclick="sendVoucherToFriend('${name}')" style="padding:12px;background:#222;color:white;border:1px solid #333;border-radius:8px;cursor:pointer;text-align:left;">
                                👤 ${name}
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                `
                    : `
                    <p style="color:#666;text-align:center;padding:15px;margin-bottom:15px;">${
                      t.noFriends || "Brak znajomych"
                    }<br><small>Dodaj znajomych w Konto Online!</small></p>
                `
                }
                
                <!-- Wyślij przez link -->
                <p style="margin-bottom:10px;font-weight:bold;border-top:1px solid #333;padding-top:15px;">🔗 ${
                  t.shareViaLink || "Lub wyślij przez link:"
                }</p>
                <div style="display:flex;gap:8px;margin-bottom:15px;">
                    <button onclick="shareVoucherVia('copy')" style="flex:1;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;">📋</button>
                    <button onclick="shareVoucherVia('whatsapp')" style="flex:1;padding:12px;background:#25D366;color:white;border:none;border-radius:8px;cursor:pointer;">💬</button>
                </div>
                
                ${
                  otherSaves.length > 0
                    ? `
                    <p style="margin-bottom:5px;font-weight:bold;border-top:1px solid #333;padding-top:15px;">💾 ${
                      t.sendToOtherSave || "Lub na inny zapis:"
                    }</p>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        ${otherSaves
                          .map(
                            (s) => `
                            <button onclick="sendVoucherToSave('${s.id}')" style="padding:12px;background:rgba(0,0,0,0.3);color:white;border:2px solid #333;border-radius:10px;cursor:pointer;text-align:left;">
                                💾 ${s.name}
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                `
                    : ""
                }
            `;

          openModal("shareVoucher");
        }

        // Wyślij bon do znajomego (lokalnie - bez serwera)
        function sendVoucherToFriend(friendName) {
          if (!currentVoucherToShare) return;

          const v = currentVoucherToShare.voucher;
          const idx = currentVoucherToShare.index;
          const save = getCurrentSave();
          const t = translations[currentLang] || translations.en;

          // Sprawdź czy stać na opłatę
          if (save.data.money < VOUCHER_SEND_FEE) {
            showToast(
              `❌ ${
                t.notEnoughMoney || "Brak środków"
              } (${VOUCHER_SEND_FEE} ${getCurrency()})`
            );
            return;
          }

          // Pobierz opłatę
          save.data.money -= VOUCHER_SEND_FEE;

          // Zapisz bon jako wysłany do znajomego
          v.sentToFriend = friendName;
          v.sentAt = Date.now();

          // Zapisz info o bonie w localStorage dla znajomego
          let pendingVouchers = JSON.parse(
            localStorage.getItem("beamng_pending_vouchers") || "[]"
          );
          pendingVouchers.push({
            id: v.id,
            amount: v.amount,
            message: v.message,
            from: playerName,
            to: friendName,
            gameMode: v.gameMode || gameMode,
            sentAt: Date.now(),
          });
          localStorage.setItem(
            "beamng_pending_vouchers",
            JSON.stringify(pendingVouchers)
          );

          saveSaveData();
          updateAllDisplays();

          showToast(
            `✅ Bon wysłany do ${friendName}! (opłata: ${VOUCHER_SEND_FEE} ${getCurrency()})`
          );
          closeModal("shareVoucher");
          renderVouchersList();
        }

        function getVoucherLink(voucher) {
          // Generuj czytelny link z parametrami
          const baseUrl =
            "https://filipnosalhd-collab.github.io/Real-BeamNG_datapack/";
          const params = new URLSearchParams();
          params.set("vid", voucher.id);
          params.set("amount", voucher.amount);
          params.set("from", voucher.fromSave);
          params.set("fromId", voucher.fromSaveId);
          params.set("mode", voucher.gameMode || gameMode);
          if (voucher.message) params.set("msg", voucher.message);
          return baseUrl + "?" + params.toString();
        }

        function getShareMessage(voucher) {
          const t = translations[currentLang] || translations.en;
          const genderMsg =
            t.youReceivedVoucher || "Dostałeś/aś bon o wartości";
          return `🎁 ${genderMsg} ${voucher.amount.toLocaleString()} ${getCurrency()}!\n\n`;
        }

        async function shareVoucherVia(method) {
          if (!currentVoucherToShare) return;

          const v = currentVoucherToShare.voucher;
          const idx = currentVoucherToShare.index;
          const save = getCurrentSave();
          const t = translations[currentLang] || translations.en;
          const voucherMode = v.gameMode || gameMode;

          const SHIPPING_FEE = 100; // Opłata za przesyłkę bonu
          const totalCost = v.amount + SHIPPING_FEE;

          // Pokaż ładowanie
          const loadingMsg =
            currentLang === "pl" ? "Wysyłanie..." : "Sending...";

          // Zapisz bon online do JSONBin
          saveVoucherOnline({
            id: v.id,
            amount: v.amount,
            message: v.message,
            fromSave: v.fromSave,
            fromSaveId: v.fromSaveId,
            gameMode: voucherMode,
          });

          // ONLINE - od razu odejmij pieniądze (wartość bonu + opłata za przesyłkę)
          const modeKey =
            voucherMode === "reallife" ? "realLifeData" : "beamngData";

          // Odejmij pieniądze z odpowiedniego trybu (bon + przesyłka)
          if (save[modeKey]) {
            save[modeKey].money = (save[modeKey].money || 0) - totalCost;
          }
          // Jeśli jesteśmy w tym trybie, aktualizuj też lokalną zmienną
          if (voucherMode === gameMode) {
            money -= totalCost;
          }

          // Usuń bon z listy (już wysłany online)
          if (save.data.vouchersToSend && save.data.vouchersToSend[idx]) {
            save.data.vouchersToSend.splice(idx, 1);
          }

          // Oznacz bon jako wysłany online (nie można go odebrać samemu)
          markVoucherAsUsed(v.id + "_sender_" + save.id);

          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          updateAllDisplays();

          const link = getVoucherLink(v);
          const message = getShareMessage(v);
          const fullText = message + link;

          switch (method) {
            case "whatsapp":
              window.open(
                "https://wa.me/?text=" + encodeURIComponent(fullText),
                "_blank"
              );
              break;
            case "messenger":
              window.open(
                "https://www.facebook.com/dialog/send?link=" +
                  encodeURIComponent(link) +
                  "&app_id=0&redirect_uri=" +
                  encodeURIComponent(window.location.href),
                "_blank"
              );
              break;
            case "email":
              const subject =
                voucherMode === "reallife"
                  ? currentLang === "pl"
                    ? "Kupon podarunkowy Real Life"
                    : "Real Life Gift Coupon"
                  : currentLang === "pl"
                  ? "Bon podarunkowy BeamNG"
                  : "BeamNG Gift Voucher";
              window.open(
                "mailto:?subject=" +
                  encodeURIComponent(subject) +
                  "&body=" +
                  encodeURIComponent(fullText),
                "_blank"
              );
              break;
            case "sms":
              window.open(
                "sms:?body=" + encodeURIComponent(fullText),
                "_blank"
              );
              break;
          }

          closeModal("shareVoucher");
          renderVouchersList();

          // Pokaż potwierdzenie z opłatą za przesyłkę
          const voucherName =
            voucherMode === "reallife"
              ? currentLang === "pl"
                ? "Kupon"
                : "Coupon"
              : currentLang === "pl"
              ? "Bon"
              : "Voucher";
          const shippingText =
            currentLang === "pl" ? "opłata za przesyłkę" : "shipping fee";
          alert(
            `📤 ${voucherName} ${
              t.sent || "wysłany"
            }!\n-${v.amount.toLocaleString()} ${getCurrency()} (${voucherName.toLowerCase()})\n-${SHIPPING_FEE} ${getCurrency()} (${shippingText})\n━━━━━━━━━━━━\n-${totalCost.toLocaleString()} ${getCurrency()} ${
              t.total || "łącznie"
            }`
          );
        }

        function sendVoucherToSave(targetSaveId) {
          if (!currentVoucherToShare) return;

          const t = translations[currentLang] || translations.en;
          const v = currentVoucherToShare.voucher;
          const targetSave = saves.find((s) => s.id === targetSaveId);

          if (!targetSave) return;

          // Dodaj bon do receivedVouchers w docelowym save'ie
          if (!targetSave.data.receivedVouchers)
            targetSave.data.receivedVouchers = [];
          targetSave.data.receivedVouchers.push({
            id: v.id,
            amount: v.amount,
            message: v.message,
            fromSave: v.fromSave,
            fromSaveId: v.fromSaveId,
            gameMode: v.gameMode || gameMode, // Dodaj tryb gry
            receivedAt: Date.now(),
            isLocal: true, // Oznacz że wysłane lokalnie (można anulować)
          });

          localStorage.setItem("beamng_saves", JSON.stringify(saves));

          const voucherName =
            (v.gameMode || gameMode) === "reallife"
              ? currentLang === "pl"
                ? "Kupon wysłany do"
                : "Coupon sent to"
              : t.voucherSentToSave || "Bon wysłany do";
          alert(`${voucherName} "${targetSave.name}"!`);
          closeModal("shareVoucher");
          renderVouchersList();
        }

        function acceptVoucher(idx) {
          const save = getCurrentSave();
          if (!save.data.receivedVouchers || !save.data.receivedVouchers[idx])
            return;

          const voucher = save.data.receivedVouchers[idx];

          // Znajdź save nadawcy i odejmij mu pieniądze
          const senderSave = saves.find((s) => s.id === voucher.fromSaveId);
          if (senderSave) {
            // Usuń bon z listy oczekujących nadawcy
            if (senderSave.data.vouchersToSend) {
              const vIdx = senderSave.data.vouchersToSend.findIndex(
                (v) => v.id === voucher.id
              );
              if (vIdx !== -1) {
                senderSave.data.vouchersToSend.splice(vIdx, 1);
              }
            }
            // Odejmij pieniądze nadawcy
            senderSave.data.money =
              (senderSave.data.money || 0) - voucher.amount;
          }

          // Dodaj pieniądze odbiorcy
          money += voucher.amount;
          save.data.receivedVouchers.splice(idx, 1);

          saveSaveData();
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          updateAllDisplays();
          renderVouchersList();

          playSound("voucher");
          const t = translations[currentLang] || translations.en;
          alert(
            `✅ ${
              t.voucherAccepted || "Bon przyjęty!"
            }\n+${voucher.amount.toLocaleString()} ${getCurrency()}`
          );
        }

        function rejectVoucher(idx) {
          const save = getCurrentSave();
          if (!save.data.receivedVouchers || !save.data.receivedVouchers[idx])
            return;

          // Przenieś do bonów do wysłania (przekaż dalej)
          const voucher = save.data.receivedVouchers[idx];
          voucher.fromSave = save.name;
          voucher.fromSaveId = save.id; // Teraz to ty wysyłasz

          if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
          save.data.vouchersToSend.push(voucher);
          save.data.receivedVouchers.splice(idx, 1);

          saveSaveData();
          renderVouchersList();

          // Od razu otwórz udostępnianie
          currentVoucherToShare = {
            voucher,
            index: save.data.vouchersToSend.length - 1,
            source: "toSend",
          };
          openShareModal();
        }

        // Sprawdź czy w URL jest bon do odebrania
        // ==================== SYSTEM LOKALNY ====================
        const VOUCHER_EXPIRY_SECONDS = 30;
        const LINK_SEND_FEE = 100; // Opłata za wysłanie linkiem

        let playerName = localStorage.getItem("beamng_player_name") || null;

        // Opłaty
        const CHAT_MESSAGE_FEE = 5.5; // Opłata za wiadomość
        const VOUCHER_SEND_FEE = 250; // Opłata za wysłanie bonu

        // ========== SYSTEM NAZWY GRACZA ==========
        function checkRequireLogin() {
          if (!playerName) {
            document
              .getElementById("modalRequireLogin")
              .classList.add("active");
            return true;
          }
          return false;
        }

        function showLoginError(msg) {
          const errorEl = document.getElementById("loginError");
          errorEl.textContent = msg;
          errorEl.style.display = "block";
        }

        function hideLoginError() {
          document.getElementById("loginError").style.display = "none";
        }

        function setPlayerName() {
          const name = document.getElementById("loginName").value.trim();
          hideLoginError();

          if (name.length < 2) {
            showLoginError("Nazwa musi mieć min. 2 znaki");
            return;
          }
          if (name.length > 20) {
            showLoginError("Nazwa może mieć max. 20 znaków");
            return;
          }

          playerName = name;
          localStorage.setItem("beamng_player_name", playerName);

          document
            .getElementById("modalRequireLogin")
            .classList.remove("active");
          updateAllDisplays();

          showToast(`🎮 Witaj ${playerName}!`);
        }

        function editPlayerName() {
          const newName = prompt("Nowa nazwa:", playerName);
          if (!newName || newName.trim().length < 2) {
            showToast("❌ Nazwa musi mieć min. 2 znaki");
            return;
          }
          if (newName.trim().length > 20) {
            showToast("❌ Nazwa może mieć max. 20 znaków");
            return;
          }

          playerName = newName.trim();
          localStorage.setItem("beamng_player_name", playerName);
          showToast(`✅ Nazwa zmieniona na ${playerName}`);
          renderOnlineAccount();
        }

        // ==================== MEGA TOAST NOTIFICATION SYSTEM ====================
        let toastQueue = [];
        let isShowingToast = false;

        function showToast(message, options = {}) {
          const {
            type = "info",
            icon = null,
            title = null,
            duration = 4000,
            onClick = null,
            businessIndex = null,
            workerId = null,
            notificationType = null,
          } = options;

          // Dodaj do kolejki
          toastQueue.push({
            message,
            type,
            icon,
            title,
            duration,
            onClick,
            businessIndex,
            workerId,
            notificationType,
          });
          processToastQueue();
        }

        function processToastQueue() {
          if (isShowingToast || toastQueue.length === 0) return;

          isShowingToast = true;
          const toast = toastQueue.shift();
          displayToastNotification(toast);
        }

        function displayToastNotification(toastData) {
          const {
            message,
            type,
            icon,
            title,
            duration,
            onClick,
            businessIndex,
            workerId,
            notificationType,
          } = toastData;

          // Usuń stary toast
          const oldToast = document.querySelector(".toast-notification");
          if (oldToast) oldToast.remove();

          // Określ ikonę i kolor
          const typeConfig = {
            success: {
              icon: "✅",
              color: "#4ade80",
              title: currentLang === "en" ? "Success" : "Sukces",
            },
            error: {
              icon: "❌",
              color: "#ef4444",
              title: currentLang === "en" ? "Error" : "Błąd",
            },
            warning: {
              icon: "⚠️",
              color: "#f59e0b",
              title: currentLang === "en" ? "Warning" : "Uwaga",
            },
            info: {
              icon: "ℹ️",
              color: "#3b82f6",
              title: currentLang === "en" ? "Info" : "Info",
            },
            money: {
              icon: "💰",
              color: "#4ade80",
              title: currentLang === "en" ? "Money" : "Pieniądze",
            },
            worker: {
              icon: "👷",
              color: "#8b5cf6",
              title: currentLang === "en" ? "Employee" : "Pracownik",
            },
            business: {
              icon: "🏢",
              color: "#f97316",
              title: currentLang === "en" ? "Business" : "Firma",
            },
            notification: {
              icon: "🔔",
              color: "#ffd700",
              title: currentLang === "en" ? "Notification" : "Powiadomienie",
            },
          };

          // Detekcja typu na podstawie wiadomości
          let detectedType = type;
          if (
            message.includes("✅") ||
            message.includes("Sukces") ||
            message.includes("Success")
          )
            detectedType = "success";
          else if (
            message.includes("❌") ||
            message.includes("Błąd") ||
            message.includes("Error")
          )
            detectedType = "error";
          else if (message.includes("⚠️") || message.includes("Uwaga"))
            detectedType = "warning";
          else if (
            message.includes("💰") ||
            message.includes("zł") ||
            message.includes("$")
          )
            detectedType = "money";
          else if (message.includes("🔔")) detectedType = "notification";
          else if (message.includes("🏢")) detectedType = "business";

          const config = typeConfig[detectedType] || typeConfig.info;
          const displayIcon = icon || config.icon;
          const displayTitle = title || config.title;

          // Wyczyść emoji z wiadomości dla czystego tekstu
          const cleanMessage = message
            .replace(/^[^\w\sąćęłńóśźżĄĆĘŁŃÓŚŹŻ]+\s*/g, "")
            .trim();

          // Stwórz HTML toasta
          const toastHtml = `
          <div class="toast-notification" id="currentToast" style="--toast-color: ${
            config.color
          }">
            <button class="toast-close" onclick="event.stopPropagation(); closeCurrentToast()">×</button>
            <div class="toast-content">
              <div class="toast-icon" style="background: ${
                config.color
              }22; color: ${config.color}">
                ${displayIcon}
              </div>
              <div class="toast-body">
                <div class="toast-title" style="color: ${config.color}">
                  ${displayTitle}
                  ${
                    businessIndex !== null
                      ? '<span style="opacity:0.6;font-size:0.8em;">• Kliknij aby otworzyć</span>'
                      : ""
                  }
                </div>
                <div class="toast-message">${cleanMessage || message}</div>
                <div class="toast-time">${new Date().toLocaleTimeString()}</div>
              </div>
            </div>
            <div class="toast-progress" id="toastProgress"></div>
          </div>
        `;

          document.body.insertAdjacentHTML("beforeend", toastHtml);

          const toastEl = document.getElementById("currentToast");
          const progressEl = document.getElementById("toastProgress");

          // Kliknięcie - przeniesienie do miejsca
          if (toastEl) {
            toastEl.onclick = function () {
              if (onClick) {
                onClick();
              } else if (businessIndex !== null) {
                closeCurrentToast();
                setTimeout(() => {
                  if (workerId) {
                    talkToWorker(businessIndex, workerId);
                  } else {
                    showBusinessDetail(businessIndex);
                  }
                }, 200);
              } else if (notificationType) {
                closeCurrentToast();
                setTimeout(() => openModal("notifications"), 200);
              }
            };
          }

          // Animacja progress bar
          let progress = 100;
          const startTime = Date.now();
          const progressInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            progress = Math.max(0, 100 - (elapsed / duration) * 100);
            if (progressEl) progressEl.style.width = progress + "%";

            if (progress <= 0) {
              clearInterval(progressInterval);
            }
          }, 50);

          // Auto-zamknięcie
          setTimeout(() => {
            closeCurrentToast();
          }, duration);
        }

        function closeCurrentToast() {
          const toast = document.querySelector(".toast-notification");
          if (toast) {
            toast.classList.add("closing");
            setTimeout(() => {
              toast.remove();
              isShowingToast = false;
              processToastQueue();
            }, 300);
          } else {
            isShowingToast = false;
            processToastQueue();
          }
        }

        // Stara kompatybilna funkcja showToast (przepakowuje do nowej)
        const originalShowToast = function (message) {
          showToast(message, { duration: 3000 });
        };

        // ========== DANE LOKALNE (bez serwera) ==========
        function getOnlineData() {
          const saved = localStorage.getItem("beamng_online_data");
          if (saved) {
            return JSON.parse(saved);
          }
          return {
            vouchers: {},
            players: {},
            notifications: {},
            chats: {},
            shop: { lastReset: 0, items: {} },
          };
        }

        function saveOnlineData(data) {
          localStorage.setItem("beamng_online_data", JSON.stringify(data));
          return true;
        }

        // ========== SYSTEM GRACZY ==========
        async function updatePlayerStatus() {
          if (!playerName) return;
          const data = getOnlineData();
          if (data.players && data.players[playerName]) {
            data.players[playerName].online = true;
            data.players[playerName].lastSeen = Date.now();
            data.players[playerName].gameMode = gameMode;
            data.players[playerName].cardNumber = cardCode;
            saveOnlineData(data);
          }
        }

        async function getOnlinePlayers() {
          const data = getOnlineData();
          if (!data.players) return [];
          const now = Date.now();
          const ONLINE_TIMEOUT = 2 * 60 * 1000; // 2 minuty
          return Object.entries(data.players)
            .filter(
              ([name, p]) =>
                p.online &&
                now - p.lastSeen < ONLINE_TIMEOUT &&
                name !== playerName
            )
            .map(([name, p]) => ({
              name,
              gameMode: p.gameMode,
              photoURL: p.photoURL || null,
            }));
        }

        // ========== SYSTEM BONÓW ==========
        async function getOnlineVouchers() {
          const data = getOnlineData();
          return data.vouchers || {};
        }

        function saveVoucherOnline(voucher) {
          const data = getOnlineData();
          if (!data.vouchers) data.vouchers = {};
          data.vouchers[voucher.id] = {
            amount: voucher.amount,
            message: voucher.message || "",
            fromPlayer: playerName,
            fromSaveId: voucher.fromSaveId,
            toPlayer: voucher.toPlayer || null,
            gameMode: voucher.gameMode,
            sentAt: Date.now(),
            firstOpenedAt: null,
            status: "pending",
          };
          saveOnlineData(data);
        }

        function checkVoucherOnline(voucherId) {
          const data = getOnlineData();
          return data.vouchers ? data.vouchers[voucherId] : null;
        }

        function markVoucherOpened(voucherId) {
          const data = getOnlineData();
          if (
            data.vouchers &&
            data.vouchers[voucherId] &&
            !data.vouchers[voucherId].firstOpenedAt
          ) {
            data.vouchers[voucherId].firstOpenedAt = Date.now();
            data.vouchers[voucherId].status = "opened";
            saveOnlineData(data);
          }
          return data.vouchers ? data.vouchers[voucherId] : null;
        }

        function markVoucherUsedOnline(voucherId) {
          const data = getOnlineData();
          if (data.vouchers && data.vouchers[voucherId]) {
            data.vouchers[voucherId].status = "used";
            data.vouchers[voucherId].usedAt = Date.now();
            saveOnlineData(data);
          }
        }

        function cancelVoucherOnline(voucherId) {
          const data = getOnlineData();
          if (data.vouchers && data.vouchers[voucherId]) {
            data.vouchers[voucherId].status = "cancelled";
            data.vouchers[voucherId].cancelledAt = Date.now();
            saveOnlineData(data);
            return data.vouchers[voucherId];
          }
          return null;
        }

        // ========== SYSTEM POWIADOMIEŃ ==========
        function sendNotification(toPlayer, notification) {
          const data = getOnlineData();
          if (!data.notifications) data.notifications = {};
          if (!data.notifications[toPlayer]) data.notifications[toPlayer] = [];

          notification.id =
            "notif_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 6);
          notification.timestamp = Date.now();
          notification.read = false;

          data.notifications[toPlayer].push(notification);
          saveOnlineData(data);
        }

        function getMyNotifications() {
          if (!playerName) return [];
          const data = getOnlineData();
          return data.notifications && data.notifications[playerName]
            ? data.notifications[playerName]
            : [];
        }

        function markNotificationRead(notifId) {
          const data = getOnlineData();
          if (data.notifications && data.notifications[playerName]) {
            const notif = data.notifications[playerName].find(
              (n) => n.id === notifId
            );
            if (notif) notif.read = true;
            saveOnlineData(data);
          }
        }

        function removeNotification(notifId) {
          const data = getOnlineData();
          if (data.notifications && data.notifications[playerName]) {
            data.notifications[playerName] = data.notifications[
              playerName
            ].filter((n) => n.id !== notifId);
            saveOnlineData(data);
          }
        }

        async function checkNotifications() {
          // Tylko worker notifications - online wyłączone
          updateNotificationBadge();
        }

        function updateNotificationBadge() {
          const badge = document.getElementById("notificationBadge");
          const bellBtn = document.getElementById("notificationBellBtn");
          const headerCount = document.getElementById("notifHeaderCount");

          if (badge) {
            // Tylko worker notifications
            let workerNotifs = [];
            try {
              workerNotifs = getWorkerNotifications() || [];
            } catch (e) {
              workerNotifs = [];
            }
            const total = workerNotifs.filter((n) => !n.read).length;

            // Aktualizuj badge
            if (total > 99) {
              badge.textContent = "99+";
              badge.classList.add("many");
            } else {
              badge.textContent = total;
              badge.classList.remove("many");
            }

            // Pokaż/ukryj badge
            if (total > 0) {
              badge.classList.add("active");
              if (bellBtn) bellBtn.classList.add("has-notifications");
            } else {
              badge.classList.remove("active");
              if (bellBtn) bellBtn.classList.remove("has-notifications");
            }

            // Aktualizuj licznik w nagłówku modala
            if (headerCount) {
              headerCount.textContent = total;
              headerCount.style.display = total > 0 ? "inline" : "none";
            }
          }
        }

        // ========== SYSTEM AUKCJI ==========
        async function createAuction(item) {
          const data = getOnlineData();
          if (!data.auctions) data.auctions = {};

          const auctionId =
            "auction_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 6);
          data.auctions[auctionId] = {
            seller: playerName,
            item: item,
            price: item.price,
            createdAt: Date.now(),
            status: "active",
            bids: [],
            negotiations: [],
          };
          saveOnlineData(data);
          return auctionId;
        }

        async function getActiveAuctions() {
          const data = getOnlineData();
          if (!data.auctions) return [];
          return Object.entries(data.auctions)
            .filter(([id, a]) => a.status === "active")
            .map(([id, a]) => ({ id, ...a }));
        }

        async function bidOnAuction(auctionId, amount, pin) {
          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId])
            return { success: false, error: "notFound" };

          const auction = data.auctions[auctionId];
          if (auction.seller === playerName)
            return { success: false, error: "ownAuction" };

          // Sprawdź limit karty
          const save = getCurrentSave();
          if (amount > limit && pin !== playerPin) {
            // Wyślij powiadomienie do sprzedawcy o braku PIN
            sendNotification(auction.seller, {
              type: "pinRequired",
              from: playerName,
              auctionId: auctionId,
              amount: amount,
              message:
                currentLang === "pl"
                  ? "Kupujący nie pamięta PIN"
                  : "Buyer forgot PIN",
            });
            return { success: false, error: "pinRequired" };
          }

          auction.bids.push({
            bidder: playerName,
            amount: amount,
            timestamp: Date.now(),
          });

          // Powiadom sprzedawcę
          sendNotification(auction.seller, {
            type: "newBid",
            from: playerName,
            auctionId: auctionId,
            amount: amount,
          });

          saveOnlineData(data);
          return { success: true };
        }

        async function negotiateAuction(auctionId, offeredPrice) {
          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId])
            return { success: false };

          const auction = data.auctions[auctionId];

          auction.negotiations.push({
            from: playerName,
            price: offeredPrice,
            timestamp: Date.now(),
            status: "pending",
          });

          // Powiadom sprzedawcę
          sendNotification(auction.seller, {
            type: "negotiation",
            from: playerName,
            auctionId: auctionId,
            offeredPrice: offeredPrice,
          });

          saveOnlineData(data);
          return { success: true };
        }

        async function respondToNegotiation(
          auctionId,
          negotiationIndex,
          response,
          counterOffer
        ) {
          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId])
            return { success: false };

          const auction = data.auctions[auctionId];
          const negotiation = auction.negotiations[negotiationIndex];

          if (response === "accept") {
            negotiation.status = "accepted";
            auction.status = "sold";
            auction.soldTo = negotiation.from;
            auction.soldPrice = negotiation.price;

            sendNotification(negotiation.from, {
              type: "negotiationAccepted",
              auctionId: auctionId,
              price: negotiation.price,
            });
          } else if (response === "reject") {
            negotiation.status = "rejected";

            sendNotification(negotiation.from, {
              type: "negotiationRejected",
              auctionId: auctionId,
            });
          } else if (response === "counter") {
            negotiation.status = "countered";
            negotiation.counterOffer = counterOffer;

            sendNotification(negotiation.from, {
              type: "counterOffer",
              from: playerName,
              auctionId: auctionId,
              counterOffer: counterOffer,
            });
          }

          saveOnlineData(data);
          return { success: true };
        }

        async function acceptAuction(auctionId, pinInput) {
          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId])
            return { success: false };

          const auction = data.auctions[auctionId];

          // Sprawdź hajs
          if (money < auction.price) {
            return { success: false, error: "noMoney" };
          }

          auction.status = "sold";
          auction.soldTo = playerName;
          auction.soldPrice = auction.price;

          sendNotification(auction.seller, {
            type: "auctionSold",
            from: playerName,
            auctionId: auctionId,
            price: auction.price,
          });

          saveOnlineData(data);
          return {
            success: true,
            items: auction.items,
            item: auction.item,
            price: auction.price,
          };
        }

        async function allowWithoutPin(notifId, auctionId, buyerName) {
          const data = getOnlineData();

          sendNotification(buyerName, {
            type: "pinBypassed",
            auctionId: auctionId,
            from: playerName,
          });

          removeNotification(notifId);
          return { success: true };
        }

        async function denyWithoutPin(notifId, buyerName) {
          sendNotification(buyerName, {
            type: "pinDenied",
            from: playerName,
          });

          removeNotification(notifId);
          return { success: true };
        }

        // ========== WŁASNE UBEZPIECZENIA ==========
        async function createCustomInsurance(insurance) {
          const auctionId = await createAuction({
            type: "customInsurance",
            name: insurance.name,
            coverage: insurance.coverage,
            interval: insurance.interval,
            price: insurance.price,
            createdBy: playerName,
          });
          return auctionId;
        }

        // ========== SKLEP Z LIMITEM ==========
        async function checkShopReset() {
          const data = getOnlineData();
          if (!data.shop) data.shop = { lastReset: 0, items: {} };

          const now = Date.now();
          const lastReset = data.shop.lastReset || 0;
          const monday = getLastMonday();

          if (lastReset < monday) {
            // Reset sklepu
            data.shop.lastReset = now;
            data.shop.items = {}; // Resetuj ilości
            saveOnlineData(data);
          }
        }

        function getLastMonday() {
          const now = new Date();
          const day = now.getDay();
          const diff = now.getDate() - day + (day === 0 ? -6 : 1);
          const monday = new Date(now.setDate(diff));
          monday.setHours(0, 0, 0, 0);
          return monday.getTime();
        }

        // ========== LOKALNE FUNKCJE BONÓW ==========
        function getUsedVoucherIds() {
          try {
            return JSON.parse(
              localStorage.getItem("beamng_used_vouchers") || "[]"
            );
          } catch (e) {
            return [];
          }
        }

        function markVoucherAsUsed(voucherId) {
          const used = getUsedVoucherIds();
          if (!used.includes(voucherId)) {
            used.push(voucherId);
            localStorage.setItem("beamng_used_vouchers", JSON.stringify(used));
          }
        }

        function isVoucherUsed(voucherId) {
          return getUsedVoucherIds().includes(voucherId);
        }

        async function checkUrlForVoucher() {
          const urlParams = new URLSearchParams(window.location.search);
          const t = translations[currentLang] || translations.en;

          const vid = urlParams.get("vid");
          const amount = urlParams.get("amount");
          const from = urlParams.get("from");
          const fromId = urlParams.get("fromId");
          const msg = urlParams.get("msg");
          const mode = urlParams.get("mode");

          if (vid && amount && fromId) {
            // Usuń parametry z URL od razu
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );

            // Sprawdź status bonu online
            const onlineVoucher = checkVoucherOnline(vid);

            if (!onlineVoucher) {
              alert(t.voucherNotFound || "Nie znaleziono bonu!");
              return;
            }

            // Sprawdź czy bon już wykorzystany lub anulowany
            if (onlineVoucher.status === "used") {
              alert(t.voucherAlreadyUsed || "Ten bon został już wykorzystany!");
              return;
            }

            if (onlineVoucher.status === "cancelled") {
              alert(
                t.voucherCancelled || "Ten bon został anulowany przez nadawcę."
              );
              return;
            }

            // Sprawdź czy link wygasł (30 sekund od pierwszego wejścia)
            if (onlineVoucher.firstOpenedAt) {
              const timeSinceOpened = Date.now() - onlineVoucher.firstOpenedAt;
              if (timeSinceOpened > VOUCHER_EXPIRY_SECONDS * 1000) {
                alert(
                  t.voucherExpired ||
                    "Ten link wygasł! Masz tylko 30 sekund od pierwszego otwarcia."
                );
                return;
              }
            }

            // Oznacz jako otwarty (pierwsze wejście)
            markVoucherOpened(vid);

            // Sprawdź czy nadawca nie próbuje odebrać swojego bonu
            const save = getCurrentSave();
            if (save && save.id === fromId) {
              alert(
                t.cantReceiveOwnVoucher || "Nie możesz odebrać własnego bonu!"
              );
              return;
            }

            if (isVoucherUsed(vid + "_sender_" + (save ? save.id : ""))) {
              alert(
                t.cantReceiveOwnVoucher || "Nie możesz odebrać własnego bonu!"
              );
              return;
            }

            const voucher = {
              id: vid,
              amount: parseInt(amount),
              fromSave: from || "?",
              fromSaveId: fromId,
              message: msg || "",
              gameMode: mode || "beamng",
              isFromLink: true,
            };
            showReceivedVoucherModal(voucher);
          }
        }

        function showReceivedVoucherModal(voucher) {
          const t = translations[currentLang] || translations.en;

          // Nazwa trybu gry
          const modeName =
            voucher.gameMode === "reallife"
              ? currentLang === "pl"
                ? "Real Life"
                : "Real Life"
              : "BeamNG";
          const voucherTypeName =
            voucher.gameMode === "reallife"
              ? currentLang === "pl"
                ? "kupon"
                : "coupon"
              : currentLang === "pl"
              ? "bon"
              : "voucher";

          document.getElementById("voucherPreviewContent").innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:1.2em;color:#888;margin-bottom:15px;">${
                      t.youReceivedVoucher || "Dostałeś/aś bon o wartości"
                    }</div>
                    ${renderVoucherCard(voucher)}
                    <div style="font-size:0.9em;color:#888;margin-top:10px;">${
                      t.voucherFrom || "Od:"
                    } ${voucher.fromSave || "?"}</div>
                    <div style="font-size:0.85em;margin-top:8px;padding:6px 12px;background:${
                      voucher.gameMode === "reallife"
                        ? "rgba(16,185,129,0.2)"
                        : "rgba(255,107,53,0.2)"
                    };border-radius:20px;display:inline-block;">
                        ${
                          voucher.gameMode === "reallife" ? "🌍" : "🚗"
                        } ${modeName}
                    </div>
                    ${
                      voucher.isFromLink
                        ? `
                        <div id="voucherCountdown" style="font-size:1.1em;color:#ef4444;margin-top:15px;font-weight:bold;">
                            ⏱️ <span id="countdownSeconds">30</span>s
                        </div>
                    `
                        : ""
                    }
                </div>
                
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div style="display:flex;gap:10px;">
                        <button onclick="acceptReceivedVoucher()" style="flex:1;padding:15px;background:#10b981;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;">
                            ✅ ${t.acceptVoucher || "Przyjmij"}
                        </button>
                        <button onclick="rejectReceivedVoucher()" style="flex:1;padding:15px;background:#f59e0b;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;">
                            ↩️ ${t.rejectVoucher || "Przekaż dalej"}
                        </button>
                    </div>
                    ${
                      voucher.isFromLink
                        ? `
                        <button onclick="cancelReceivedVoucher()" style="padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-size:0.95em;cursor:pointer;">
                            ❌ ${
                              t.cancelAndRefund || "Anuluj (zwrot dla nadawcy)"
                            }
                        </button>
                    `
                        : ""
                    }
                </div>
            `;

          // Zapisz tymczasowo
          window.tempReceivedVoucher = voucher;
          openModal("voucherPreview");

          // Uruchom odliczanie 30 sekund (tylko dla linków online)
          if (voucher.isFromLink) {
            startVoucherCountdown(voucher.id);
          }
        }

        // Odliczanie 30 sekund
        let voucherCountdownInterval = null;
        async function startVoucherCountdown(voucherId) {
          if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

          // Pobierz czas otwarcia z serwera
          const onlineVoucher = checkVoucherOnline(voucherId);
          if (!onlineVoucher || !onlineVoucher.firstOpenedAt) return;

          const startTime = onlineVoucher.firstOpenedAt;
          const endTime = startTime + VOUCHER_EXPIRY_SECONDS * 1000;

          voucherCountdownInterval = setInterval(async () => {
            const remaining = Math.max(
              0,
              Math.ceil((endTime - Date.now()) / 1000)
            );
            const countdownEl = document.getElementById("countdownSeconds");
            if (countdownEl) {
              countdownEl.textContent = remaining;
            }

            if (remaining <= 0) {
              clearInterval(voucherCountdownInterval);
              closeModal("voucherPreview");
              const t = translations[currentLang] || translations.en;
              alert(t.voucherExpired || "Czas minął! Link wygasł.");
              window.tempReceivedVoucher = null;
            }
          }, 500);
        }

        // Anuluj bon i zwróć hajs nadawcy
        async function cancelReceivedVoucher() {
          if (!window.tempReceivedVoucher) return;

          const voucher = window.tempReceivedVoucher;
          const t = translations[currentLang] || translations.en;

          // Zatrzymaj odliczanie
          if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

          // Oznacz bon jako anulowany online
          cancelVoucherOnline(voucher.id);
          markVoucherAsUsed(voucher.id);

          closeModal("voucherPreview");

          const voucherName =
            voucher.gameMode === "reallife"
              ? currentLang === "pl"
                ? "Kupon"
                : "Coupon"
              : currentLang === "pl"
              ? "Bon"
              : "Voucher";
          alert(
            `❌ ${voucherName} ${t.cancelled || "anulowany"}!\n${
              t.refundToSender || "Zwrot dla nadawcy"
            }: ${voucher.amount.toLocaleString()} ${getCurrency()}`
          );

          window.tempReceivedVoucher = null;
        }

        async function acceptReceivedVoucher() {
          if (!window.tempReceivedVoucher) return;

          const voucher = window.tempReceivedVoucher;
          const save = getCurrentSave();
          const t = translations[currentLang] || translations.en;
          const voucherMode = voucher.gameMode || "beamng";

          // Zatrzymaj odliczanie
          if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

          // Oznacz bon jako wykorzystany
          if (voucher.isFromLink) {
            markVoucherUsedOnline(voucher.id);
            markVoucherAsUsed(voucher.id);
          } else {
            // Bon lokalny - teraz odejmij pieniądze nadawcy
            const senderSave = saves.find((s) => s.id === voucher.fromSaveId);
            if (senderSave) {
              if (senderSave.data.vouchersToSend) {
                const vIdx = senderSave.data.vouchersToSend.findIndex(
                  (v) => v.id === voucher.id
                );
                if (vIdx !== -1) {
                  senderSave.data.vouchersToSend.splice(vIdx, 1);
                }
              }
              const senderModeKey =
                voucherMode === "reallife" ? "realLifeData" : "beamngData";
              if (senderSave[senderModeKey]) {
                senderSave[senderModeKey].money =
                  (senderSave[senderModeKey].money || 0) - voucher.amount;
              }
            }
          }

          // Dodaj pieniądze odbiorcy do odpowiedniego trybu
          const receiverModeKey =
            voucherMode === "reallife" ? "realLifeData" : "beamngData";

          if (!save[receiverModeKey]) {
            save[receiverModeKey] = {
              money: 1500,
              garage: [],
              spent: 0,
              debt: 0,
              health: 100,
              food: 1000,
              water: 1000,
              backpack: [],
              activeInsurances: [],
            };
          }
          save[receiverModeKey].money =
            (save[receiverModeKey].money || 0) + voucher.amount;

          if (voucherMode === gameMode) {
            money += voucher.amount;
          }

          localStorage.setItem("beamng_saves", JSON.stringify(saves));
          updateAllDisplays();
          closeModal("voucherPreview");

          playSound("voucher");
          const modeName = voucherMode === "reallife" ? "Real Life" : "BeamNG";
          const voucherTypeName =
            voucherMode === "reallife"
              ? currentLang === "pl"
                ? "Kupon przyjęty!"
                : "Coupon accepted!"
              : currentLang === "pl"
              ? "Bon przyjęty!"
              : "Voucher accepted!";
          alert(
            `✅ ${voucherTypeName}\n+${voucher.amount.toLocaleString()} ${getCurrency()} (${modeName})`
          );

          window.tempReceivedVoucher = null;
        }

        async function rejectReceivedVoucher() {
          if (!window.tempReceivedVoucher) return;

          const voucher = window.tempReceivedVoucher;
          const save = getCurrentSave();

          // Zatrzymaj odliczanie
          if (voucherCountdownInterval) clearInterval(voucherCountdownInterval);

          // Oznacz stary bon jako wykorzystany
          if (voucher.isFromLink) {
            markVoucherUsedOnline(voucher.id);
            markVoucherAsUsed(voucher.id);
          }

          // Utwórz nowy bon z nowym ID (bo przekazujesz dalej)
          const newVoucher = {
            id:
              "bon_" +
              Date.now() +
              "_" +
              Math.random().toString(36).substr(2, 6),
            amount: voucher.amount,
            message: voucher.message,
            createdAt: Date.now(),
            fromSave: save.name,
            fromSaveId: save.id,
            gameMode: voucher.gameMode || gameMode,
            originalFrom: voucher.fromSave,
          };

          if (!save.data.vouchersToSend) save.data.vouchersToSend = [];
          save.data.vouchersToSend.push(newVoucher);

          saveSaveData();
          closeModal("voucherPreview");

          // Od razu otwórz udostępnianie
          currentVoucherToShare = {
            voucher: newVoucher,
            index: save.data.vouchersToSend.length - 1,
            source: "toSend",
          };
          openShareModal();

          window.tempReceivedVoucher = null;
        }

        // ==================== UI NAPRAWY ====================
        let selectedRepairCarIndex = null;

        function renderRepairCarList() {
          const list = document.getElementById("repairCarList");
          const t = translations[currentLang] || translations.en;

          // Filtruj tylko zepsute auta
          const brokenCars = garage.filter((car) => car.broken);

          if (brokenCars.length === 0) {
            list.innerHTML = `<div style="color:#888;text-align:center;padding:20px;">
                    <div style="font-size:3em;margin-bottom:10px;">✅</div>
                    <p>${t.noBrokenCars || "Wszystkie auta są sprawne!"}</p>
                    <p style="font-size:0.85em;margin-top:10px;">${
                      t.goToGarage || "Idź do Garażu żeby ulepszać auta"
                    }</p>
                </div>`;
            document.getElementById("repairResponse").style.display = "none";
            document.getElementById("repairBtn").style.display = "none";
            return;
          }

          list.innerHTML = brokenCars
            .map((car, idx) => {
              const realIdx = garage.findIndex((c) => c.id === car.id);
              return `
                    <div class="garage-item" onclick="selectCarForRepair(${realIdx})" style="cursor:pointer;background:rgba(239,68,68,0.1);border:2px solid ${
                selectedRepairCarIndex === realIdx ? "#f59e0b" : "#ef4444"
              };${
                selectedRepairCarIndex === realIdx
                  ? "background:rgba(245,158,11,0.1);"
                  : ""
              }">
                        <div>
                            <div class="car-name">🔧 ${car.brand} ${
                car.model
              }</div>
                            <div style="font-size:0.8em;color:#888;">${
                              car.year || ""
                            }</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#ef4444;font-size:0.9em;">${
                              t.repairCost || "Koszt"
                            }: 150 ${getCurrency()}</div>
                            ${
                              selectedRepairCarIndex === realIdx
                                ? '<span style="color:#f59e0b;">✓ wybrane</span>'
                                : ""
                            }
                        </div>
                    </div>
                `;
            })
            .join("");
        }

        function selectCarForRepair(idx) {
          selectedRepairCarIndex = idx;
          renderRepairCarList();
          document.getElementById("repairResponse").style.display = "block";
          document.getElementById("repairBtn").style.display = "block";

          // Aktualizuj wyświetlany koszt
          const insuranceHelp = getRepairInsuranceHelp();
          const finalCost = Math.max(0, 150 - insuranceHelp);
          document.getElementById(
            "repairCostDisplay"
          ).textContent = `-${finalCost.toLocaleString()} ${getCurrency()}`;
        }

        function confirmRepair() {
          const t = translations[currentLang] || translations.en;
          const repairCost = 150; // Koszt naprawy zepsutego auta

          if (
            selectedRepairCarIndex === null ||
            selectedRepairCarIndex >= garage.length
          ) {
            alert(t.selectCarToRepair || "Wybierz auto do naprawy!");
            return;
          }

          const car = garage[selectedRepairCarIndex];

          if (!car.broken) {
            alert(t.carNotBroken || "To auto nie jest zepsute!");
            return;
          }

          // Sprawdź czy ma ubezpieczenie na naprawę
          const insuranceHelp = getRepairInsuranceHelp();
          const finalCost = Math.max(0, repairCost - insuranceHelp);

          if (money < finalCost) {
            // Dodaj do długów
            const save = getCurrentSave();
            if (!save.data.debts) save.data.debts = [];
            save.data.debts.push({
              type: "repair",
              amount: finalCost,
              description: `${t.repairDebt || "Naprawa auta"}: ${car.brand} ${
                car.model
              }`,
              date: Date.now(),
            });
            car.broken = false;
            saveState();
            updateAllDisplays();
            closeModal("repair");
            playSound("repair");
            alert(
              `🔧 ${car.brand} ${car.model} - ${
                t.repaired || "Naprawione!"
              }\n💳 ${
                t.addedToDebt || "Dodano do długu"
              }: ${finalCost.toLocaleString()} ${getCurrency()}`
            );
          } else {
            money -= finalCost;
            spent += finalCost;
            car.broken = false;
            saveState();
            updateAllDisplays();
            closeModal("repair");
            playSound("repair");

            let msg = `🔧 ${car.brand} ${car.model} - ${
              t.repaired || "Naprawione!"
            }\n-${finalCost.toLocaleString()} ${getCurrency()}`;
            if (insuranceHelp > 0) {
              msg += `\n🛡️ ${
                t.insuranceCovered || "Ubezpieczenie pokryło"
              }: ${insuranceHelp.toLocaleString()} ${getCurrency()}`;
            }
            alert(msg);
          }

          selectedRepairCarIndex = null;
        }

        function getRepairInsuranceHelp() {
          const save = getCurrentSave();
          const activeIns = save.data.activeInsurances || [];
          let help = 0;

          activeIns.forEach((ins) => {
            if (ins.type === "repair" && ins.coveragePercent) {
              help = Math.max(help, 150 * (ins.coveragePercent / 100));
            }
          });

          return Math.floor(help);
        }

        // ==================== GARAŻ ====================

        function renderGarageModal() {
          const list = document.getElementById("garageList");
          const empty = document.getElementById("garageEmpty");
          const t = translations[currentLang] || translations.en;

          if (garage.length === 0) {
            list.style.display = "none";
            empty.style.display = "block";
            return;
          }

          list.style.display = "block";
          empty.style.display = "none";

          list.innerHTML = garage
            .map((car, idx) => {
              const upgradePercent = car.upgradePercent || 50;
              const sellPrice = Math.floor(car.price * (upgradePercent / 100));
              const isBroken = car.broken;
              const isUpgrading = car.isUpgrading || false;

              return `
                    <div style="padding:15px;margin-bottom:10px;background:${
                      isBroken
                        ? "rgba(239,68,68,0.2)"
                        : isUpgrading
                        ? "rgba(99,102,241,0.2)"
                        : "rgba(0,0,0,0.3)"
                    };border:2px solid ${
                isBroken ? "#ef4444" : isUpgrading ? "#6366f1" : "#333"
              };border-radius:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <div>
                                <div style="font-size:1.1em;font-weight:bold;">${
                                  car.brand
                                } ${car.model}</div>
                                <div style="font-size:0.85em;color:#888;">${
                                  car.year || ""
                                }</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.8em;color:#888;">${
                                  t.sellValue || "Wartość"
                                }:</div>
                                <div style="color:#4ade80;font-weight:bold;">${sellPrice.toLocaleString()} ${getCurrency()}</div>
                                <div style="font-size:0.75em;color:${
                                  upgradePercent > 100 ? "#4ade80" : "#f59e0b"
                                };">(${upgradePercent.toFixed(1)}%)</div>
                            </div>
                        </div>
                        ${
                          isBroken
                            ? `
                            <div style="background:rgba(239,68,68,0.3);padding:8px;border-radius:8px;text-align:center;margin-bottom:10px;">
                                <span style="color:#ef4444;">🔧 ${
                                  t.carBroken || "Auto zepsute!"
                                }</span>
                            </div>
                        `
                            : isUpgrading
                            ? `
                            <div style="background:rgba(99,102,241,0.3);padding:8px;border-radius:8px;text-align:center;margin-bottom:10px;">
                                <span style="color:#6366f1;">⚡ ${
                                  t.upgrading || "Ulepszanie w toku..."
                                }</span>
                            </div>
                        `
                            : ""
                        }
                        <div style="display:flex;gap:8px;">
                            ${
                              isBroken
                                ? `
                                <button onclick="goToRepair()" style="flex:1;padding:10px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;">
                                    🔧 ${t.repair || "Napraw"}
                                </button>
                            `
                                : isUpgrading
                                ? `
                                <button onclick="stopCarUpgrade(${idx})" style="flex:1;padding:10px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;">
                                    ⏸️ ${t.stopUpgrade || "Zatrzymaj"}
                                </button>
                            `
                                : `
                                <button onclick="startCarUpgrade(${idx})" style="flex:1;padding:10px;background:#6366f1;color:white;border:none;border-radius:8px;cursor:pointer;">
                                    ⬆️ ${t.startUpgrade || "Ulepszaj"}
                                </button>
                            `
                            }
                            <button onclick="sellCarFromGarage(${idx})" style="padding:10px 15px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;">
                                💰 ${t.sell || "Sprzedaj"}
                            </button>
                        </div>
                    </div>
                `;
            })
            .join("");
        }

        function goToRepair() {
          closeModal("garage");
          openModal("repair");
        }

        function sellCarFromGarage(idx) {
          const t = translations[currentLang] || translations.en;
          const car = garage[idx];
          if (!car) return;

          if (car.broken) {
            alert(
              t.cantSellBroken ||
                "Nie możesz sprzedać zepsutego auta! Najpierw je napraw."
            );
            return;
          }

          // Zatrzymaj ulepszanie przed sprzedażą
          if (car.isUpgrading) {
            stopCarUpgrade(idx);
          }

          const upgradePercent = car.upgradePercent || 50;
          const sellPrice = Math.floor(car.price * (upgradePercent / 100));

          if (
            confirm(
              `${t.confirmSell || "Sprzedać"} ${car.brand} ${car.model} ${
                t.forPrice || "za"
              } ${sellPrice.toLocaleString()} ${getCurrency()}?`
            )
          ) {
            money += sellPrice;
            garage.splice(idx, 1);
            saveState();
            updateAllDisplays();
            renderGarageModal();
            renderGarage();
            alert(
              `✅ ${
                t.sold || "Sprzedano!"
              } +${sellPrice.toLocaleString()} ${getCurrency()}`
            );
          }
        }

        // === NOWY SYSTEM ULEPSZANIA - jedno kliknięcie, działa w tle ===
        function startCarUpgrade(idx) {
          const car = garage[idx];
          if (!car || car.broken) return;

          car.isUpgrading = true;

          // Pobierz bonus z ubezpieczenia
          const upgradeBonus = getUpgradeBonus();
          const baseRate = 0.1 + upgradeBonus.rateBonus;
          const breakChance = 0.005 - upgradeBonus.safetyBonus;

          // Uruchom interwał dla tego auta
          upgradeIntervals[idx] = setInterval(() => {
            const currentCar = garage[idx];
            if (!currentCar || currentCar.broken) {
              stopCarUpgrade(idx);
              return;
            }

            // Sprawdź czy się zepsuło
            if (Math.random() < Math.max(0.001, breakChance)) {
              carBrokeNew(idx);
              return;
            }

            // Ulepszaj
            currentCar.upgradePercent = Math.min(
              1000,
              (currentCar.upgradePercent || 50) + baseRate
            );
            playSound("upgrade");
            saveState();
          }, 1000);

          saveState();
          renderGarageModal();
        }

        function stopCarUpgrade(idx) {
          const car = garage[idx];
          if (!car) return;

          car.isUpgrading = false;

          if (upgradeIntervals[idx]) {
            clearInterval(upgradeIntervals[idx]);
            delete upgradeIntervals[idx];
          }

          saveState();
          renderGarageModal();
        }

        function carBrokeNew(idx) {
          const t = translations[currentLang] || translations.en;
          const car = garage[idx];
          if (!car) return;

          // Zatrzymaj ulepszanie
          car.isUpgrading = false;
          if (upgradeIntervals[idx]) {
            clearInterval(upgradeIntervals[idx]);
            delete upgradeIntervals[idx];
          }

          // Oznacz jako zepsute
          car.broken = true;
          car.upgradePercent = Math.max(50, (car.upgradePercent || 50) - 5);

          playSound("break");

          // Koszty zepsucia
          const repairDebt = 150;
          if (money >= repairDebt) {
            money -= repairDebt;
            spent += repairDebt;
          } else {
            addDebt(repairDebt - money);
            money = 0;
          }

          saveState();
          updateAllDisplays();
          renderGarageModal();

          alert(
            `💥 ${car.brand} ${car.model} ${
              t.carBrokeMsg || "się zepsuło!"
            }\n-150 ${getCurrency()}, -5% ${t.value || "wartości"}`
          );
        }

        // Wznów ulepszanie po załadowaniu save'a
        function resumeUpgrades() {
          garage.forEach((car, idx) => {
            if (car.isUpgrading && !car.broken) {
              // Uruchom ponownie interwał
              const upgradeBonus = getUpgradeBonus();
              const baseRate = 0.1 + upgradeBonus.rateBonus;
              const breakChance = 0.005 - upgradeBonus.safetyBonus;

              upgradeIntervals[idx] = setInterval(() => {
                const currentCar = garage[idx];
                if (!currentCar || currentCar.broken) {
                  stopCarUpgrade(idx);
                  return;
                }

                if (Math.random() < Math.max(0.001, breakChance)) {
                  carBrokeNew(idx);
                  return;
                }

                currentCar.upgradePercent = Math.min(
                  1000,
                  (currentCar.upgradePercent || 50) + baseRate
                );
                playSound("upgrade");
                saveState();
              }, 1000);
            }
          });
        }

        // Stary system - do usunięcia lub zostawienia dla kompatybilności
        let upgradingCarIndex = null;
        let isUpgrading = false;
        let upgradeInterval = null;

        function openUpgradeModal(idx) {
          upgradingCarIndex = idx;
          const car = garage[idx];
          const t = translations[currentLang] || translations.en;

          document.getElementById("upgradeCarInfo").innerHTML = `
                <div style="font-size:2em;">🚗</div>
                <div style="font-size:1.3em;font-weight:bold;">${car.brand} ${
            car.model
          }</div>
                <div style="color:#888;">${car.year || ""} • ${
            car.type || ""
          }</div>
                <div style="color:#4ade80;margin-top:5px;">${
                  t.basePrice || "Cena bazowa"
                }: ${car.price.toLocaleString()} ${getCurrency()}</div>
            `;

          updateUpgradeDisplay();
          document.getElementById(
            "upgradeStatus"
          ).innerHTML = `<span style="color:#888;">${
            t.clickToStart || "Kliknij aby rozpocząć ulepszanie"
          }</span>`;
          document.getElementById(
            "upgradeBtn"
          ).innerHTML = `▶️ <span data-translate="startUpgrade">${
            t.startUpgrade || "Rozpocznij ulepszanie"
          }</span>`;

          closeModal("garage");
          openModal("upgrade");
        }

        function updateUpgradeDisplay() {
          if (upgradingCarIndex === null) return;
          const car = garage[upgradingCarIndex];
          const percent = car.upgradePercent || 50;

          document.getElementById("upgradeSellPercent").textContent =
            percent.toFixed(1) + "%";
          document.getElementById("upgradeProgressBar").style.width =
            ((percent - 50) / 950) * 100 + "%";
        }

        function toggleUpgrade() {
          const t = translations[currentLang] || translations.en;

          if (isUpgrading) {
            stopUpgrade();
          } else {
            startUpgrade();
          }
        }

        function startUpgrade() {
          if (upgradingCarIndex === null) return;
          const t = translations[currentLang] || translations.en;

          isUpgrading = true;
          document.getElementById("upgradeBtn").innerHTML = `⏸️ <span>${
            t.stopUpgrade || "Zatrzymaj"
          }</span>`;
          document.getElementById("upgradeBtn").style.background = "#ef4444";
          document.getElementById(
            "upgradeStatus"
          ).innerHTML = `<span style="color:#4ade80;">⚡ ${
            t.upgrading || "Ulepszanie w toku..."
          }</span>`;

          // Pobierz bonus z ubezpieczenia
          const upgradeBonus = getUpgradeBonus();
          const baseRate = 0.1 + upgradeBonus.rateBonus;
          const breakChance = 0.005 - upgradeBonus.safetyBonus; // 0.5% co sekundę bazowo

          upgradeInterval = setInterval(() => {
            const car = garage[upgradingCarIndex];
            if (!car) {
              stopUpgrade();
              return;
            }

            // Sprawdź czy się zepsuło
            if (Math.random() < Math.max(0.001, breakChance)) {
              carBroke();
              return;
            }

            // Ulepszaj
            car.upgradePercent = Math.min(
              1000,
              (car.upgradePercent || 50) + baseRate
            );
            playSound("upgrade");
            updateUpgradeDisplay();
            saveState();
          }, 1000);
        }

        function stopUpgrade() {
          const t = translations[currentLang] || translations.en;
          isUpgrading = false;
          if (upgradeInterval) clearInterval(upgradeInterval);
          upgradeInterval = null;

          document.getElementById("upgradeBtn").innerHTML = `▶️ <span>${
            t.startUpgrade || "Rozpocznij ulepszanie"
          }</span>`;
          document.getElementById("upgradeBtn").style.background = "#10b981";
          document.getElementById(
            "upgradeStatus"
          ).innerHTML = `<span style="color:#888;">${
            t.upgradeStopped || "Ulepszanie zatrzymane"
          }</span>`;
        }

        function carBroke() {
          const t = translations[currentLang] || translations.en;
          stopUpgrade();
          playSound("break");

          const car = garage[upgradingCarIndex];
          car.broken = true;
          car.upgradePercent = Math.max(50, (car.upgradePercent || 50) - 5);

          const repairDebt = 150;
          if (money >= repairDebt) {
            money -= repairDebt;
            spent += repairDebt;
          } else {
            // Dodaj do długów
            const save = getCurrentSave();
            if (!save.data.debts) save.data.debts = [];
            save.data.debts.push({
              type: "carBreak",
              amount: repairDebt,
              description: `${t.carBreakDebt || "Zepsucie auta"}: ${
                car.brand
              } ${car.model}`,
              date: Date.now(),
            });
          }

          saveState();
          updateAllDisplays();
          updateUpgradeDisplay();

          document.getElementById(
            "upgradeStatus"
          ).innerHTML = `<span style="color:#ef4444;">💥 ${
            t.carBrokeMsg || "Auto się zepsuło! -150 zł, -5%"
          }</span>`;

          alert(
            `💥 ${
              t.carBrokeMsg || "Auto się zepsuło!"
            }\n-150 ${getCurrency()}\n-5% wartości`
          );
        }

        function getUpgradeBonus() {
          // Sprawdź aktywne ubezpieczenia na ulepszanie
          const save = getCurrentSave();
          const activeIns = save.data.activeInsurances || [];

          let rateBonus = 0;
          let safetyBonus = 0;

          activeIns.forEach((ins) => {
            if (ins.type === "upgrade") {
              rateBonus += ins.rateBonus || 0;
              safetyBonus += ins.safetyBonus || 0;
            }
          });

          return { rateBonus, safetyBonus };
        }

        function closeUpgradeModal() {
          stopUpgrade();
          upgradingCarIndex = null;
          closeModal("upgrade");
        }

        // ==================== PRACA ====================
        const jobs = [
          {
            id: "cleaner",
            name: "Sprzątacz",
            nameEn: "Cleaner",
            basePay: 500,
            difficulty: 1,
          },
          {
            id: "cashier",
            name: "Kasjer",
            nameEn: "Cashier",
            basePay: 600,
            difficulty: 1,
          },
          {
            id: "waiter",
            name: "Kelner",
            nameEn: "Waiter",
            basePay: 700,
            difficulty: 1,
          },
          {
            id: "cook",
            name: "Kucharz",
            nameEn: "Cook",
            basePay: 900,
            difficulty: 2,
          },
          {
            id: "driver",
            name: "Kierowca",
            nameEn: "Driver",
            basePay: 1100,
            difficulty: 2,
          },
          {
            id: "mechanic",
            name: "Mechanik",
            nameEn: "Mechanic",
            basePay: 1300,
            difficulty: 2,
          },
          {
            id: "electrician",
            name: "Elektryk",
            nameEn: "Electrician",
            basePay: 1500,
            difficulty: 3,
          },
          {
            id: "programmer",
            name: "Programista",
            nameEn: "Programmer",
            basePay: 2200,
            difficulty: 3,
          },
          {
            id: "lawyer",
            name: "Prawnik",
            nameEn: "Lawyer",
            basePay: 2800,
            difficulty: 4,
          },
          {
            id: "doctor",
            name: "Lekarz",
            nameEn: "Doctor",
            basePay: 3200,
            difficulty: 4,
          },
          {
            id: "surgeon",
            name: "Chirurg",
            nameEn: "Surgeon",
            basePay: 4500,
            difficulty: 5,
          },
          {
            id: "pilot",
            name: "Pilot",
            nameEn: "Pilot",
            basePay: 5500,
            difficulty: 5,
          },
          {
            id: "ceo",
            name: "Dyrektor",
            nameEn: "CEO",
            basePay: 7000,
            difficulty: 5,
          },
        ];

        // Wymagane doświadczenie na każdy poziom gwiazdek
        const JOBS_REQUIRED_PER_STAR = 3; // 3 prace na poprzednim poziomie = odblokowanie następnego

        function getWorkExperience() {
          const save = getCurrentSave();
          if (!save) return { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          if (!save[modeKey]) {
            save[modeKey] = {
              money: 1500,
              garage: [],
              spent: 0,
              debt: 0,
              debtDeadline: null,
              totalTaxPaid: 0,
              health: 100,
              food: 1000,
              water: 1000,
              backpack: [],
              activeInsurances: [],
              businesses: [],
              credits: [],
              workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
              vouchersToSend: [],
              receivedVouchers: [],
            };
          }
          if (!save[modeKey].workExperience) {
            save[modeKey].workExperience = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
          }
          return save[modeKey].workExperience;
        }

        function saveWorkExperience(exp) {
          const save = getCurrentSave();
          if (!save) return;
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          if (!save[modeKey]) save[modeKey] = {};
          save[modeKey].workExperience = exp;
          saveState();
        }

        function getUnlockedStars() {
          const exp = getWorkExperience();
          let unlocked = 1; // 1 gwiazdka zawsze odblokowana

          if (exp[1] >= JOBS_REQUIRED_PER_STAR) unlocked = 2;
          if (
            exp[1] >= JOBS_REQUIRED_PER_STAR &&
            exp[2] >= JOBS_REQUIRED_PER_STAR
          )
            unlocked = 3;
          if (
            exp[1] >= JOBS_REQUIRED_PER_STAR &&
            exp[2] >= JOBS_REQUIRED_PER_STAR &&
            exp[3] >= JOBS_REQUIRED_PER_STAR
          )
            unlocked = 4;
          if (
            exp[1] >= JOBS_REQUIRED_PER_STAR &&
            exp[2] >= JOBS_REQUIRED_PER_STAR &&
            exp[3] >= JOBS_REQUIRED_PER_STAR &&
            exp[4] >= JOBS_REQUIRED_PER_STAR
          )
            unlocked = 5;

          return unlocked;
        }

        function addWorkExperience(difficulty) {
          const exp = getWorkExperience();
          exp[difficulty] = (exp[difficulty] || 0) + 1;
          saveWorkExperience(exp);
        }

        // ==================== SYSTEM PODATKÓW OD PRACY ====================

        function getTodayDateString() {
          const now = new Date();
          return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(
            2,
            "0"
          )}-${String(now.getDate()).padStart(2, "0")}`;
        }

        function getWorkTaxData() {
          const save = getCurrentSave();
          if (!save)
            return {
              todayWorkCount: 0,
              lastWorkDate: null,
              totalEarnings: 0,
              pendingTaxReport: null,
            };
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          return {
            todayWorkCount: save[modeKey]?.todayWorkCount || 0,
            lastWorkDate: save[modeKey]?.lastWorkDate || null,
            totalEarnings: save[modeKey]?.todayEarnings || 0,
            pendingTaxReport: save[modeKey]?.pendingTaxReport || null,
          };
        }

        function saveWorkTaxData(data) {
          const save = getCurrentSave();
          if (!save) return;
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          if (!save[modeKey]) save[modeKey] = {};
          save[modeKey].todayWorkCount = data.todayWorkCount;
          save[modeKey].lastWorkDate = data.lastWorkDate;
          save[modeKey].todayEarnings = data.totalEarnings;
          save[modeKey].pendingTaxReport = data.pendingTaxReport;
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
        }

        function incrementWorkCount(earnings) {
          const today = getTodayDateString();
          const data = getWorkTaxData();

          // Jeśli pierwszy raz dzisiaj lub nowy dzień
          if (data.lastWorkDate !== today) {
            data.todayWorkCount = 0;
            data.totalEarnings = 0;
            data.lastWorkDate = today;
          }

          data.todayWorkCount++;
          data.totalEarnings += earnings;
          saveWorkTaxData(data);
        }

        function calculateDailyTax(workCount, earnings) {
          // Bazowy podatek: 5% od zarobków
          // + 2% za każdą pracę powyżej 1
          const baseRate = 0.05;
          const extraRate = Math.max(0, workCount - 1) * 0.02;
          const totalRate = Math.min(baseRate + extraRate, 0.25); // Max 25%
          return Math.floor(earnings * totalRate);
        }

        function checkPendingTaxReport() {
          const data = getWorkTaxData();
          const today = getTodayDateString();

          // Jeśli jest oczekujący raport - pokaż go
          if (data.pendingTaxReport) {
            showTaxReport(data.pendingTaxReport);
            return;
          }

          // Sprawdź czy poprzedni dzień (REALNY) miał prace
          if (
            data.lastWorkDate &&
            data.lastWorkDate !== today &&
            data.todayWorkCount > 0
          ) {
            // Oblicz podatek za poprzedni dzień
            const taxAmount = calculateDailyTax(
              data.todayWorkCount,
              data.totalEarnings
            );
            const report = {
              date: data.lastWorkDate,
              workCount: data.todayWorkCount,
              earnings: data.totalEarnings,
              taxAmount: taxAmount,
            };

            // Zapisz raport i zresetuj liczniki
            const newData = {
              todayWorkCount: 0,
              lastWorkDate: today,
              totalEarnings: 0,
              pendingTaxReport: report,
            };
            saveWorkTaxData(newData);
            showTaxReport(report);
          }
        }

        function showTaxReport(report) {
          const isEn = currentLang === "en";
          const taxRate =
            report.earnings > 0
              ? Math.floor((report.taxAmount / report.earnings) * 100)
              : 0;

          let modal = document.getElementById("modalTaxReport");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "modalTaxReport";
            modal.className = "modal";
            modal.style.display = "none";
            modal.innerHTML = `<div class="modal-content" style="max-width: 400px;"><div id="taxReportContent"></div></div>`;
            document.body.appendChild(modal);
          }

          const content = document.getElementById("taxReportContent");
          content.innerHTML = `
          <div style="background: #1a1a2e; border-radius: 10px; padding: 20px; font-family: 'Courier New', monospace;">
            <div style="text-align: center; border-bottom: 2px dashed #444; padding-bottom: 15px; margin-bottom: 15px;">
              <div style="font-size: 1.5em; font-weight: bold;">🧾 ${
                isEn ? "TAX REPORT" : "RAPORT PODATKOWY"
              }</div>
              <div style="color: #888; margin-top: 5px;">${
                isEn ? "Daily Income Tax" : "Podatek dochodowy dzienny"
              }</div>
              <div style="color: #666; font-size: 0.85em;">${report.date}</div>
            </div>
            
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>💼 ${isEn ? "Work shifts" : "Zmiany pracy"}:</span>
                <span>${report.workCount}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>💰 ${isEn ? "Total earnings" : "Łączne zarobki"}:</span>
                <span style="color: #4ade80;">+${report.earnings.toLocaleString()} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>📊 ${isEn ? "Tax rate" : "Stawka podatkowa"}:</span>
                <span style="color: #f59e0b;">${taxRate}%</span>
              </div>
            </div>
            
            <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold;">${
                  isEn ? "TAX DUE" : "DO ZAPŁATY"
                }:</span>
                <span style="color: #ef4444; font-size: 1.5em; font-weight: bold;">-${report.taxAmount.toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <div style="color: #666; font-size: 0.8em; text-align: center; margin-bottom: 15px;">
              ${
                isEn
                  ? "Tax is automatically deducted from your account"
                  : "Podatek jest automatycznie pobierany z konta"
              }
            </div>
            
            <button onclick="payTaxReport()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">
              💸 ${
                isEn ? "Pay Tax" : "Zapłać podatek"
              } (-${report.taxAmount.toLocaleString()} ${getCurrency()})
            </button>
          </div>
        `;

          modal.style.display = "flex";
        }

        function payTaxReport() {
          const data = getWorkTaxData();
          const isEn = currentLang === "en";

          if (!data.pendingTaxReport) return;

          const taxAmount = data.pendingTaxReport.taxAmount;

          if (money >= taxAmount) {
            money -= taxAmount;
            totalTaxPaid += taxAmount;
            showToast(
              `💸 ${
                isEn ? "Tax paid" : "Podatek zapłacony"
              }: -${taxAmount.toLocaleString()} ${getCurrency()}`
            );
          } else {
            // Nie stać - dodaj do długu
            const unpaid = taxAmount - money;
            money = 0;
            debt += unpaid;
            totalTaxPaid += taxAmount - unpaid;
            showToast(
              `⚠️ ${
                isEn
                  ? "Not enough money! Debt increased by"
                  : "Brak pieniędzy! Dług wzrósł o"
              } ${unpaid.toLocaleString()} ${getCurrency()}`
            );
          }

          // Wyczyść oczekujący raport
          data.pendingTaxReport = null;
          saveWorkTaxData(data);

          saveState();
          updateAllDisplays();

          const modal = document.getElementById("modalTaxReport");
          if (modal) modal.style.display = "none";
        }

        let workInterval = null;
        let sleepInterval = null;
        let coinInterval = null;
        let workTimeLeft = 120;
        let workEarned = 0;
        let workBonus = 0;
        let sleepLevel = 0;
        let currentJob = null;

        function renderJobsList() {
          const list = document.getElementById("jobsList");
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";
          const unlockedStars = getUnlockedStars();
          const exp = getWorkExperience();

          list.innerHTML = jobs
            .map((job) => {
              const difficultyStars = "⭐".repeat(job.difficulty);
              const jobName = currentLang === "pl" ? job.name : job.nameEn;
              const isLocked = job.difficulty > unlockedStars;

              // Oblicz ile jeszcze prac potrzeba
              let lockInfo = "";
              if (isLocked) {
                const prevLevel = job.difficulty - 1;
                const done = exp[prevLevel] || 0;
                const needed = JOBS_REQUIRED_PER_STAR - done;
                lockInfo = isEn
                  ? `🔒 Complete ${needed} more ${prevLevel}⭐ jobs to unlock`
                  : `🔒 Wykonaj jeszcze ${needed} prac ${prevLevel}⭐ aby odblokować`;
              }

              // Pokaż postęp na aktualnym poziomie
              const currentExp = exp[job.difficulty] || 0;
              const progressInfo =
                !isLocked && job.difficulty < 5
                  ? `<div style="font-size:0.7em;color:#666;margin-top:3px;">${
                      isEn ? "Progress" : "Postęp"
                    }: ${currentExp}/${JOBS_REQUIRED_PER_STAR}</div>`
                  : "";

              if (isLocked) {
                return `
                <div style="padding:15px;margin-bottom:10px;background:rgba(0,0,0,0.5);border:2px solid #444;border-radius:12px;opacity:0.5;cursor:not-allowed;">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                      <div style="font-size:1.1em;font-weight:bold;color:#666;">🔒 ${jobName}</div>
                      <div style="font-size:0.85em;color:#555;">${difficultyStars}</div>
                    </div>
                    <div style="text-align:right;">
                      <div style="color:#666;font-weight:bold;">${job.basePay.toLocaleString()} ${getCurrency()}</div>
                    </div>
                  </div>
                  <div style="font-size:0.8em;color:#f59e0b;margin-top:8px;text-align:center;">${lockInfo}</div>
                </div>
              `;
              }

              return `
              <div onclick="startWork('${
                job.id
              }')" style="padding:15px;margin-bottom:10px;background:rgba(0,0,0,0.3);border:2px solid #333;border-radius:12px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='#333'">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div>
                    <div style="font-size:1.1em;font-weight:bold;">${jobName}</div>
                    <div style="font-size:0.85em;color:#888;">${difficultyStars}</div>
                    ${progressInfo}
                  </div>
                  <div style="text-align:right;">
                    <div style="color:#4ade80;font-weight:bold;">${job.basePay.toLocaleString()} ${getCurrency()}</div>
                    <div style="font-size:0.75em;color:#888;">+ ${
                      t.bonuses || "bonusy"
                    }</div>
                    <div style="font-size:0.7em;color:#f59e0b;">💰 x${
                      job.difficulty
                    } ${isEn ? "bonus" : "bonus"}</div>
                  </div>
                </div>
              </div>
            `;
            })
            .join("");
        }

        function startWork(jobId) {
          currentJob = jobs.find((j) => j.id === jobId);
          if (!currentJob) return;

          // Sprawdź czy praca jest odblokowana
          const unlockedStars = getUnlockedStars();
          if (currentJob.difficulty > unlockedStars) {
            const isEn = currentLang === "en";
            showToast(
              `🔒 ${
                isEn
                  ? "This job is locked! Complete more lower-level jobs first."
                  : "Ta praca jest zablokowana! Wykonaj więcej prac niższego poziomu."
              }`
            );
            return;
          }

          const t = translations[currentLang] || translations.en;
          workTimeLeft = 120;
          workEarned = 0;
          workBonus = 0;
          sleepLevel = 0;

          document.getElementById("workJobName").textContent =
            currentLang === "pl" ? currentJob.name : currentJob.nameEn;
          document.getElementById("workTimer").textContent = "2:00";
          document.getElementById("workEarned").textContent = "0";
          document.getElementById("workBonus").textContent = "0";
          document.getElementById("sleepOverlayTop").style.height = "0";
          document.getElementById("sleepOverlayBottom").style.height = "0";
          document.getElementById("coinsContainer").innerHTML = "";

          closeModal("work");
          openModal("workGame");
          playSound("workStart");

          // Timer
          workInterval = setInterval(() => {
            workTimeLeft--;
            const mins = Math.floor(workTimeLeft / 60);
            const secs = workTimeLeft % 60;
            document.getElementById("workTimer").textContent = `${mins}:${secs
              .toString()
              .padStart(2, "0")}`;

            if (workTimeLeft <= 0) {
              endWork();
            }
          }, 1000);

          // Zasypianie - im trudniejsza praca tym WOLNIEJ zasypiasz (bo jesteś skupiony)
          // Ale łatwiejsze prace = szybciej zasypiasz z nudów
          const sleepRate = 1.5 - currentJob.difficulty * 0.2; // 1⭐ = 1.3, 5⭐ = 0.5 - szybsze zasypianie
          sleepInterval = setInterval(() => {
            sleepLevel = Math.min(48, sleepLevel + sleepRate); // max 48% - prawie nic nie widać
            updateSleepVisuals();
          }, 300); // szybsze tickowanie

          // Spadające monety - trudniejsza praca = więcej monet (bo więcej okazji)
          const coinRate = 800 + currentJob.difficulty * 200; // 1⭐ = 1000ms, 5⭐ = 1800ms między monetami
          coinInterval = setInterval(() => {
            spawnCoin();
          }, coinRate);
        }

        function spawnCoin() {
          const container = document.getElementById("coinsContainer");

          const coin = document.createElement("div");
          coin.className = "falling-coin";
          coin.innerHTML = "💰";
          coin.style.cssText = `
                position: absolute;
                top: -60px;
                left: ${Math.random() * 80 + 10}%;
                font-size: 4em;
                cursor: pointer;
                z-index: 5;
                transition: top 3s linear, transform 0.1s, filter 0.1s;
                user-select: none;
            `;

          // Hover effect - podświetlenie
          coin.onmouseenter = () => {
            coin.style.transform = "scale(1.3)";
            coin.style.filter = "brightness(1.5) drop-shadow(0 0 10px #4ade80)";
          };
          coin.onmouseleave = () => {
            coin.style.transform = "scale(1)";
            coin.style.filter = "none";
          };

          coin.onclick = () => {
            playSound("coin");
            workBonus += 100;
            document.getElementById("workBonus").textContent =
              workBonus.toLocaleString();
            coin.innerHTML = "+100";
            coin.style.color = "#4ade80";
            coin.style.fontSize = "2em";
            coin.style.pointerEvents = "none";
            coin.style.filter = "none";
            setTimeout(() => coin.remove(), 300);
          };

          container.appendChild(coin);

          setTimeout(() => {
            coin.style.top = "calc(100% + 60px)";
          }, 50);

          setTimeout(() => {
            if (coin.parentNode) coin.remove();
          }, 3500);
        }

        function updateSleepVisuals() {
          document.getElementById("sleepOverlayTop").style.height =
            sleepLevel + "%";
          document.getElementById("sleepOverlayBottom").style.height =
            sleepLevel + "%";

          // Monety prawie niewidoczne przy max śnie
          const coinsOpacity = 1 - (sleepLevel / 48) * 0.95; // od 1 do 0.05
          document.getElementById("coinsContainer").style.opacity =
            coinsOpacity;
        }

        // Płynne otwieranie oczu - im więcej śpisz tym wolniej się otwierają
        let wakeUpInterval = null;

        function startWakeUp() {
          if (wakeUpInterval) return;
          wakeUpInterval = setInterval(() => {
            // Im więcej śpisz, tym wolniej otwierasz oczy (mniejszy krok)
            const openSpeed = Math.max(0.5, 3 - (sleepLevel / 48) * 2.5); // od 3 do 0.5
            sleepLevel = Math.max(0, sleepLevel - openSpeed);
            updateSleepVisuals();
          }, 50); // płynna animacja
        }

        function stopWakeUp() {
          if (wakeUpInterval) {
            clearInterval(wakeUpInterval);
            wakeUpInterval = null;
          }
        }

        function wakeUp() {
          // Pojedyncze kliknięcie - małe otwarcie
          const openSpeed = Math.max(0.5, 3 - (sleepLevel / 48) * 2.5);
          sleepLevel = Math.max(0, sleepLevel - openSpeed * 2);
          updateSleepVisuals();
        }

        // Przerwij pracę wcześniej (-3% wypłaty)
        function quitWorkEarly() {
          if (!confirm("Przerwać pracę? Dostaniesz 3% mniej wypłaty.")) return;

          clearInterval(workInterval);
          clearInterval(sleepInterval);
          clearInterval(coinInterval);
          stopWakeUp();

          const t = translations[currentLang] || translations.en;
          const basePay = currentJob.basePay;

          // Proporcja przepracowanego czasu (120s = pełny czas)
          const timeWorked = 120 - workTimeLeft;
          const timeRatio = timeWorked / 120;

          // Podstawa proporcjonalna do czasu
          const proportionalBase = Math.round(basePay * timeRatio);

          // Bonus za zebrane monety
          const totalEarned = proportionalBase + workBonus;

          // Kara za spanie
          const sleepPenalty = (sleepLevel / 45) * 0.9;
          const moneyLostSleep = Math.round(totalEarned * sleepPenalty);

          // Kara 3% za wcześniejsze przerwanie
          const earlyPenalty = 0.03;
          const moneyLostEarly = Math.round(
            (totalEarned - moneyLostSleep) * earlyPenalty
          );

          // Finalna wypłata (zaokrąglona)
          const finalPay = Math.round(
            totalEarned - moneyLostSleep - moneyLostEarly
          );

          money += finalPay;
          saveState();
          updateAllDisplays();

          closeModal("workGame");
          playSound("workEnd");

          let msg = `💼 ${t.workInterrupted || "Praca przerwana!"}\n\n`;
          msg += `⏱️ Przepracowano: ${Math.floor(timeWorked / 60)}:${(
            timeWorked % 60
          )
            .toString()
            .padStart(2, "0")}\n`;
          msg += `${
            t.basePay || "Podstawa"
          }: ${proportionalBase.toLocaleString()} ${getCurrency()}\n`;
          msg += `💰 ${
            t.coinsCollected || "Zebrane monety"
          }: +${workBonus.toLocaleString()} ${getCurrency()}\n`;
          if (moneyLostSleep > 0) {
            msg += `😴 ${
              t.sleepPenalty || "Strata za spanie"
            }: -${moneyLostSleep.toLocaleString()} ${getCurrency()}\n`;
          }
          msg += `⏹️ Kara za przerwanie: -${moneyLostEarly.toLocaleString()} ${getCurrency()} (3%)\n`;
          msg += `\n${
            t.total || "Razem"
          }: ${finalPay.toLocaleString()} ${getCurrency()}`;

          alert(msg);
          currentJob = null;
        }

        function endWork() {
          clearInterval(workInterval);
          clearInterval(sleepInterval);
          clearInterval(coinInterval);
          stopWakeUp(); // Zatrzymaj otwieranie oczu

          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";
          const basePay = currentJob.basePay;

          // Bonus za gwiazdki - im więcej gwiazdek tym większy mnożnik bonusu
          const starMultiplier = currentJob.difficulty;
          const starBonus = Math.floor(workBonus * (starMultiplier - 1)); // dodatkowy bonus za gwiazdki

          // Bonus za klikanie monet + bonus za gwiazdki
          const totalEarned = basePay + workBonus + starBonus;

          // Im więcej śpisz (sleepLevel 0-45), tym więcej TRACISZ (0-90%)
          const sleepPenalty = (sleepLevel / 45) * 0.9;
          const moneyLost = Math.floor(totalEarned * sleepPenalty);
          const finalPay = totalEarned - moneyLost;

          money += finalPay;

          // === LICZNIK PRACY DLA PODATKÓW ===
          incrementWorkCount(finalPay);

          // Dodaj doświadczenie za ukończoną pracę
          addWorkExperience(currentJob.difficulty);

          saveState();
          updateAllDisplays();

          closeModal("workGame");
          playSound("workEnd");

          const penaltyPercent = Math.floor(sleepPenalty * 100);
          let msg = `💼 ${t.workDone || "Praca zakończona!"}\n\n`;
          msg += `${
            t.basePay || "Podstawa"
          }: ${basePay.toLocaleString()} ${getCurrency()}\n`;
          msg += `💰 ${
            t.coinsCollected || "Zebrane monety"
          }: +${workBonus.toLocaleString()} ${getCurrency()}\n`;
          if (starBonus > 0) {
            msg += `⭐ ${
              isEn ? "Star bonus" : "Bonus za gwiazdki"
            } (x${starMultiplier}): +${starBonus.toLocaleString()} ${getCurrency()}\n`;
          }
          if (moneyLost > 0) {
            msg += `😴 ${
              t.sleepPenalty || "Strata za spanie"
            }: -${moneyLost.toLocaleString()} ${getCurrency()} (${penaltyPercent}%)\n`;
          }
          msg += `\n${
            t.total || "Razem"
          }: ${finalPay.toLocaleString()} ${getCurrency()}`;

          // Info o postępie
          const exp = getWorkExperience();
          const currentExp = exp[currentJob.difficulty] || 0;
          if (currentJob.difficulty < 5) {
            msg += `\n\n📊 ${isEn ? "Progress" : "Postęp"} ${
              currentJob.difficulty
            }⭐: ${currentExp}/${JOBS_REQUIRED_PER_STAR}`;
            if (
              currentExp >= JOBS_REQUIRED_PER_STAR &&
              currentJob.difficulty < 5
            ) {
              msg += `\n🎉 ${
                isEn ? "Next level unlocked!" : "Następny poziom odblokowany!"
              }`;
            }
          }

          alert(msg);
          currentJob = null;
        }

        // ==================== UI SYSTEMU ONLINE ====================

        // Renderuj konto online
        function renderOnlineAccount() {
          const t = translations[currentLang] || translations.en;
          const content = document.getElementById("onlineAccountContent");

          // Pobierz znajomych z localStorage
          const friends = JSON.parse(
            localStorage.getItem("beamng_friends") || "[]"
          );

          content.innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:3em;margin-bottom:10px;">👤</div>
                    <div style="font-size:1.3em;font-weight:bold;">${playerName}</div>
                    <button onclick="editPlayerName()" style="margin-top:8px;padding:6px 15px;background:#333;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">
                        ✏️ ${t.editName || "Zmień nazwę"}
                    </button>
                </div>
                
                <!-- Zaproś znajomego -->
                <div style="background:#1a1a2e;padding:15px;border-radius:10px;margin-bottom:15px;">
                    <div style="font-weight:bold;margin-bottom:10px;">➕ ${
                      t.inviteFriend || "Zaproś znajomego"
                    }</div>
                    <button onclick="generateFriendInviteLink()" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;">
                        🔗 ${t.generateLink || "Wygeneruj link zaproszenia"}
                    </button>
                </div>
                
                <!-- Lista znajomych -->
                <div style="background:#1a1a2e;padding:15px;border-radius:10px;margin-bottom:15px;">
                    <div style="font-weight:bold;margin-bottom:10px;">⭐ ${
                      t.friends || "Znajomi"
                    }: ${friends.length}</div>
                    ${
                      friends.length > 0
                        ? `
                        <div style="max-height:200px;overflow-y:auto;">
                            ${friends
                              .map(
                                (f) => `
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#222;border-radius:6px;margin-bottom:5px;">
                                    <span style="flex:1;">👤 ${f}</span>
                                    <div style="display:flex;gap:5px;">
                                        <button onclick="openChat('${f}')" style="padding:6px 12px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">💬</button>
                                        <button onclick="removeFriend('${f}')" style="padding:6px 12px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">✖</button>
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        <p style="color:#888;font-size:0.75em;margin-top:8px;text-align:center;">💬 Wiadomość: ${CHAT_MESSAGE_FEE.toFixed(
                          2
                        )} ${getCurrency()}</p>
                    `
                        : `<div style="color:#666;text-align:center;padding:15px;">${
                            t.noFriends || "Brak znajomych"
                          }<br><span style="font-size:0.85em;">Wyślij link zaproszenia!</span></div>`
                    }
                </div>
            `;
        }

        // ========== SYSTEM ZNAJOMYCH (przez link) ==========
        function generateFriendInviteLink() {
          const baseUrl = window.location.href.split("?")[0];
          const link = `${baseUrl}?friend_invite=${encodeURIComponent(
            playerName
          )}`;

          if (navigator.share) {
            navigator.share({
              title: "Zaproszenie do znajomych - BeamNG Datapack",
              text: `${playerName} zaprasza Cię do znajomych!`,
              url: link,
            });
          } else {
            navigator.clipboard.writeText(link);
            showToast("📋 Link skopiowany!");
          }
        }

        function checkFriendInvite() {
          const params = new URLSearchParams(window.location.search);
          const inviteFrom = params.get("friend_invite");

          if (inviteFrom && playerName && inviteFrom !== playerName) {
            // Usuń parametr z URL
            window.history.replaceState({}, "", window.location.pathname);

            // Pokaż modal potwierdzenia
            if (
              confirm(
                `👋 ${inviteFrom} zaprasza Cię do znajomych!\n\nCzy chcesz dodać ${inviteFrom} do znajomych?`
              )
            ) {
              addFriendDirect(inviteFrom);
            }
          }
        }

        function addFriendDirect(friendName) {
          let friends = JSON.parse(
            localStorage.getItem("beamng_friends") || "[]"
          );

          if (friends.includes(friendName)) {
            showToast("ℹ️ Już jest znajomym");
            return;
          }

          friends.push(friendName);
          localStorage.setItem("beamng_friends", JSON.stringify(friends));

          showToast(`✅ Dodano ${friendName} do znajomych!`);
          renderOnlineAccount();
        }

        function removeFriend(friendName) {
          if (!confirm(`Usunąć ${friendName} ze znajomych?`)) return;

          let friends = JSON.parse(
            localStorage.getItem("beamng_friends") || "[]"
          );
          friends = friends.filter((f) => f !== friendName);
          localStorage.setItem("beamng_friends", JSON.stringify(friends));

          showToast(`🗑️ Usunięto ${friendName}`);
          renderOnlineAccount();
        }

        function getFriendsList() {
          return JSON.parse(localStorage.getItem("beamng_friends") || "[]");
        }

        // Powiadomienia - uproszczone (lokalne)
        function renderNotifications() {
          const t = translations[currentLang] || translations.en;
          const list = document.getElementById("notificationsList");
          list.innerHTML = `<p style="color:#888;text-align:center;">${
            t.noNotifications || "Brak powiadomień"
          }</p>`;
        }

        // ========== SYSTEM CZATU ==========
        let currentChatUser = null;
        let chatInterval = null;

        function openChat(username) {
          if (!playerName) return;

          // Sprawdź czy to znajomy
          const friends = getFriendsList();
          const isFriend = friends.includes(username);

          if (!isFriend) {
            showToast("❌ Możesz pisać tylko ze znajomymi!");
            return;
          }

          currentChatUser = username;
          document.getElementById("chatWithName").textContent = username;
          closeModal("notifications");
          closeModal("onlineAccount");
          openModal("chat");
          loadChatMessages();

          // Odświeżaj czat co 3 sekundy
          if (chatInterval) clearInterval(chatInterval);
          chatInterval = setInterval(loadChatMessages, 3000);
        }

        function closeChatModal() {
          if (chatInterval) clearInterval(chatInterval);
          chatInterval = null;
          currentChatUser = null;
          closeModal("chat");
        }

        function loadChatMessages() {
          if (!currentChatUser || !playerName) return;

          const data = getOnlineData();
          if (!data.chats) data.chats = {};

          // Chat ID to posortowane nazwy użytkowników
          const chatId = [playerName, currentChatUser].sort().join("_");
          const chat = data.chats[chatId] || { messages: [] };

          const container = document.getElementById("chatMessages");
          if (!container) return;

          if (chat.messages.length === 0) {
            container.innerHTML =
              '<p style="color:#666;text-align:center;">Brak wiadomości</p>';
            return;
          }

          container.innerHTML = chat.messages
            .map((m) => {
              const isMe = m.from === playerName;
              return `
                    <div style="margin-bottom:8px;text-align:${
                      isMe ? "right" : "left"
                    };">
                        <div style="display:inline-block;max-width:80%;padding:8px 12px;border-radius:12px;background:${
                          isMe ? "#3b82f6" : "#333"
                        };">
                            ${m.text}
                        </div>
                        <div style="font-size:0.7em;color:#666;margin-top:2px;">${formatTimeAgo(
                          m.timestamp
                        )}</div>
                    </div>
                `;
            })
            .join("");

          container.scrollTop = container.scrollHeight;
        }

        function sendChatMessage() {
          const input = document.getElementById("chatInput");
          const text = input.value.trim();
          if (!text || !currentChatUser || !playerName) return;

          const save = getCurrentSave();
          const t = translations[currentLang] || translations.en;

          // Sprawdź czy stać na wiadomość
          if (save.data.money < CHAT_MESSAGE_FEE) {
            showToast(
              `❌ ${
                t.notEnoughMoney || "Brak środków"
              } (${CHAT_MESSAGE_FEE.toFixed(2)} ${getCurrency()})`
            );
            return;
          }

          // Pobierz opłatę
          save.data.money -= CHAT_MESSAGE_FEE;
          saveSaveData();
          updateAllDisplays();

          const data = getOnlineData();
          if (!data.chats) data.chats = {};

          const chatId = [playerName, currentChatUser].sort().join("_");
          if (!data.chats[chatId]) {
            data.chats[chatId] = {
              messages: [],
              participants: [playerName, currentChatUser],
            };
          }

          data.chats[chatId].messages.push({
            from: playerName,
            text: text,
            timestamp: Date.now(),
          });

          // Ogranicz do 100 ostatnich wiadomości
          if (data.chats[chatId].messages.length > 100) {
            data.chats[chatId].messages =
              data.chats[chatId].messages.slice(-100);
          }

          saveOnlineData(data);

          // Wyślij powiadomienie do drugiej osoby
          sendNotification(currentChatUser, {
            type: "chatMessage",
            from: playerName,
            preview: text.substring(0, 50),
          });

          input.value = "";
          loadChatMessages();
        }

        // Enter wysyła wiadomość
        document.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && e.target.id === "chatInput") {
            sendChatMessage();
          }
        });

        // Renderuj aukcje
        let currentAuctionTab = "browse";

        async function showAuctionTab(tab) {
          currentAuctionTab = tab;
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => (b.style.background = "#222"));
          document.getElementById(
            "tab" + tab.charAt(0).toUpperCase() + tab.slice(1)
          ).style.background = "#333";
        }

        async function renderAuctionContent() {
          const t = translations[currentLang] || translations.en;
          const content = document.getElementById("auctionContent");

          if (!playerName) {
            content.innerHTML = `<p style="color:#888;text-align:center;padding:20px;">${
              t.loginFirst || "Najpierw się zaloguj"
            }</p>`;
            return;
          }

          if (currentAuctionTab === "browse") {
            const auctions = await getActiveAuctions();
            const otherAuctions = auctions.filter(
              (a) => a.seller !== playerName
            );

            if (otherAuctions.length === 0) {
              content.innerHTML = `<p style="color:#888;text-align:center;padding:20px;">${
                t.noAuctions || "Brak aukcji"
              }</p>`;
              return;
            }

            content.innerHTML = otherAuctions
              .map((a) => {
                const displayName =
                  a.name ||
                  (a.item
                    ? a.item.name || a.item.brand + " " + a.item.model
                    : "Pakiet");
                const icon =
                  a.items && a.items.length > 1
                    ? "📦"
                    : a.items && a.items[0]
                    ? getItemIcon(a.items[0])
                    : "📦";
                return `
                    <div onclick="showAuctionDetail('${
                      a.id
                    }')" style="background:#1a1a2e;padding:12px;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:bold;">${icon} ${displayName}</div>
                            <div style="color:#888;font-size:0.85em;">${
                              t.seller || "Sprzedawca"
                            }: ${a.seller}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#10b981;font-weight:bold;">${a.price.toLocaleString()} ${getCurrency()}</div>
                        </div>
                    </div>
                `;
              })
              .join("");
          } else if (currentAuctionTab === "my") {
            const auctions = await getActiveAuctions();
            const myAuctions = auctions.filter((a) => a.seller === playerName);

            if (myAuctions.length === 0) {
              content.innerHTML = `<p style="color:#888;text-align:center;padding:20px;">${
                t.noMyAuctions || "Nie masz wystawionych przedmiotów"
              }</p>`;
              return;
            }

            content.innerHTML = myAuctions
              .map((a) => {
                const displayName =
                  a.name ||
                  (a.item
                    ? a.item.name || a.item.brand + " " + a.item.model
                    : "Pakiet");
                const icon =
                  a.items && a.items.length > 1
                    ? "📦"
                    : a.items && a.items[0]
                    ? getItemIcon(a.items[0])
                    : "📦";
                return `
                    <div style="background:#1a1a2e;padding:12px;border-radius:8px;margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:bold;">${icon} ${displayName}</div>
                                <div style="color:#10b981;">${a.price.toLocaleString()} ${getCurrency()}</div>
                            </div>
                            <button onclick="cancelAuction('${
                              a.id
                            }')" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;">❌</button>
                        </div>
                        ${
                          a.negotiations && a.negotiations.length > 0
                            ? `<div style="color:#f59e0b;font-size:0.85em;margin-top:8px;">💬 ${
                                a.negotiations.length
                              } ${t.negotiations || "negocjacji"}</div>`
                            : ""
                        }
                    </div>
                `;
              })
              .join("");
          } else if (currentAuctionTab === "create") {
            // Lista rzeczy do wystawienia
            const save = getCurrentSave();

            content.innerHTML = `
                    <div style="margin-bottom:15px;">
                        <p style="color:#888;margin-bottom:10px;">${
                          t.selectItemsToSell || "Zaznacz co chcesz wystawić:"
                        }</p>
                        
                        <div style="font-weight:bold;margin:15px 0 8px;color:#f59e0b;">🚗 ${
                          t.cars || "Auta"
                        }</div>
                        <div id="auctionCarsList"></div>
                        
                        <div style="font-weight:bold;margin:15px 0 8px;color:#10b981;">🍔 ${
                          t.food || "Jedzenie"
                        }</div>
                        <div id="auctionFoodList"></div>
                        
                        <div style="font-weight:bold;margin:15px 0 8px;color:#8b5cf6;">🛡️ ${
                          t.customInsurance || "Własne ubezpieczenie"
                        }</div>
                        <button onclick="showCreateInsuranceForm()" style="width:100%;padding:12px;background:#1a1a2e;border:2px dashed #8b5cf6;border-radius:8px;color:#8b5cf6;cursor:pointer;">
                            ➕ ${t.createInsurance || "Stwórz ubezpieczenie"}
                        </button>
                        <div id="customInsurancePreview" style="margin-top:10px;"></div>
                    </div>
                    
                    <div id="auctionSelectedItems" style="background:#1a1a2e;padding:12px;border-radius:8px;margin:15px 0;display:none;">
                        <div style="font-weight:bold;margin-bottom:8px;">📦 ${
                          t.selectedItems || "Wybrane"
                        }:</div>
                        <div id="selectedItemsList"></div>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <label style="color:#888;font-size:0.9em;">${
                          t.totalPrice || "Cena za pakiet"
                        }:</label>
                        <input type="number" id="auctionPackagePrice" placeholder="0" style="width:100%;padding:12px;background:#1a1a2e;border:2px solid #333;border-radius:8px;color:white;font-size:1.2em;margin-top:5px;">
                    </div>
                    
                    <button onclick="createAuctionPackage()" style="width:100%;padding:15px;background:#10b981;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;margin-top:15px;">
                        ✅ ${t.listForSale || "Wystaw na sprzedaż"}
                    </button>
                `;

            renderAuctionItemLists();
          }
        }

        // Wybrane przedmioty do aukcji
        let auctionSelectedCars = [];
        let auctionSelectedFood = [];
        let auctionCustomInsurance = null;

        function renderAuctionItemLists() {
          const t = translations[currentLang] || translations.en;

          // Auta - używaj globalnej zmiennej garage
          const carsList = document.getElementById("auctionCarsList");
          if (!carsList) return;

          if (garage.length === 0) {
            carsList.innerHTML = `<p style="color:#666;font-size:0.9em;">${
              t.noCars || "Brak aut"
            }</p>`;
          } else {
            carsList.innerHTML = garage
              .map(
                (car, i) => `
                    <div onclick="toggleAuctionCar(${i})" style="background:${
                  auctionSelectedCars.includes(i) ? "#2a4a2a" : "#222"
                };padding:10px;border-radius:6px;margin-bottom:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:2px solid ${
                  auctionSelectedCars.includes(i) ? "#10b981" : "transparent"
                };">
                        <span>${car.brand} ${car.model}</span>
                        <span style="color:#888;">${car.price.toLocaleString()} ${getCurrency()}</span>
                    </div>
                `
              )
              .join("");
          }

          // Jedzenie - używaj globalnej zmiennej backpack
          const foodList = document.getElementById("auctionFoodList");
          if (!foodList) return;

          if (backpack.length === 0) {
            foodList.innerHTML = `<p style="color:#666;font-size:0.9em;">${
              t.noFood || "Brak jedzenia"
            }</p>`;
          } else {
            // Grupuj jedzenie według id
            const groupedFood = {};
            for (let i = 0; i < backpack.length; i++) {
              const item = backpack[i];
              const key = item.id || item.nameKey || "item_" + i;
              if (!groupedFood[key]) {
                groupedFood[key] = { item: item, indices: [], count: 0 };
              }
              groupedFood[key].indices.push(i);
              groupedFood[key].count++;
            }

            let html = "";
            for (const key in groupedFood) {
              const data = groupedFood[key];
              const item = data.item;
              const itemName = item.nameKey
                ? translations[currentLang][item.nameKey] || item.nameKey
                : item.name || "Przedmiot";
              const icon = item.icon || "📦";
              const selectedCount = data.indices.filter((i) =>
                auctionSelectedFood.includes(i)
              ).length;
              const isSelected = selectedCount > 0;
              const allSelected = selectedCount === data.count;

              html += `
                    <div onclick="toggleAuctionFoodGroup('${key}')" style="background:${
                isSelected ? "#2a4a2a" : "#222"
              };padding:10px;border-radius:6px;margin-bottom:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:2px solid ${
                allSelected ? "#10b981" : isSelected ? "#4a7a4a" : "transparent"
              };">
                        <span>${icon} ${itemName} ${
                data.count > 1
                  ? '<span style="color:#ff6b35;">x' + data.count + "</span>"
                  : ""
              }</span>
                        <span style="color:#888;">${(
                          item.price || 0
                        ).toLocaleString()} ${getCurrency()}</span>
                    </div>`;
            }
            foodList.innerHTML = html;
          }

          updateSelectedItemsPreview();
        }

        // Przechowuj grupowanie
        let foodGroups = {};

        function updateFoodGroups() {
          foodGroups = {};
          backpack.forEach((item, i) => {
            const key = item.id || item.nameKey || item.name;
            if (!foodGroups[key]) {
              foodGroups[key] = [];
            }
            foodGroups[key].push(i);
          });
        }

        function toggleAuctionFoodGroup(key) {
          updateFoodGroups();
          const indices = foodGroups[key] || [];

          // Sprawdź ile jest już zaznaczonych
          const selectedCount = indices.filter((i) =>
            auctionSelectedFood.includes(i)
          ).length;

          if (selectedCount === indices.length) {
            // Wszystkie zaznaczone - odznacz wszystkie
            indices.forEach((i) => {
              auctionSelectedFood = auctionSelectedFood.filter((x) => x !== i);
            });
          } else {
            // Nie wszystkie zaznaczone - zaznacz wszystkie
            indices.forEach((i) => {
              if (!auctionSelectedFood.includes(i)) {
                auctionSelectedFood.push(i);
              }
            });
          }

          renderAuctionItemLists();
        }

        function toggleAuctionCar(index) {
          if (auctionSelectedCars.includes(index)) {
            auctionSelectedCars = auctionSelectedCars.filter(
              (i) => i !== index
            );
          } else {
            auctionSelectedCars.push(index);
          }
          renderAuctionItemLists();
        }

        function updateSelectedItemsPreview() {
          const t = translations[currentLang] || translations.en;

          const container = document.getElementById("auctionSelectedItems");
          const list = document.getElementById("selectedItemsList");

          if (!container || !list) return;

          const hasItems =
            auctionSelectedCars.length > 0 ||
            auctionSelectedFood.length > 0 ||
            auctionCustomInsurance;
          container.style.display = hasItems ? "block" : "none";

          if (!hasItems) return;

          let html = "";
          let totalValue = 0;

          auctionSelectedCars.forEach((i) => {
            const car = garage[i];
            if (car) {
              html += `<div style="color:#f59e0b;">🚗 ${car.brand} ${car.model}</div>`;
              totalValue += car.price;
            }
          });

          auctionSelectedFood.forEach((i) => {
            const item = backpack[i];
            if (item) {
              const itemName = item.nameKey ? getItemName(item) : item.name;
              const icon = item.icon || "🍔";
              html += `<div style="color:#10b981;">${icon} ${itemName}</div>`;
              totalValue += item.price || 0;
            }
          });

          if (auctionCustomInsurance) {
            html += `<div style="color:#8b5cf6;">🛡️ ${auctionCustomInsurance.name}</div>`;
            if (auctionCustomInsurance.creationCost) {
              html += `<div style="color:#f59e0b;font-size:0.85em;margin-left:20px;">💰 ${
                t.creationCost || "Koszt"
              }: ${auctionCustomInsurance.creationCost.toLocaleString()} ${getCurrency()}</div>`;
            }
          }

          list.innerHTML = html;

          // Ustaw sugerowaną cenę
          const priceInput = document.getElementById("auctionPackagePrice");
          if (priceInput && !priceInput.value) {
            priceInput.placeholder = totalValue.toLocaleString();
          }
        }

        function showCreateInsuranceForm() {
          const t = translations[currentLang] || translations.en;
          const preview = document.getElementById("customInsurancePreview");

          preview.innerHTML = `
                <div style="background:#2a2a4e;padding:15px;border-radius:8px;border:2px solid #8b5cf6;">
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.insuranceName || "Nazwa ubezpieczenia"
                        }:</label>
                        <input type="text" id="customInsName" placeholder="${
                          t.myInsurance || "Moje ubezpieczenie"
                        }" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.whatItGives || "Co daje"
                        } (HP/jedzenie/woda):</label>
                        <div style="display:flex;gap:10px;margin-top:3px;">
                            <input type="number" id="customInsHP" placeholder="HP" style="flex:1;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;">
                            <input type="number" id="customInsFood" placeholder="🍔" style="flex:1;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;">
                            <input type="number" id="customInsWater" placeholder="💧" style="flex:1;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.coveragePercent || "Pokrycie napraw"
                        } (%):</label>
                        <input type="number" id="customInsCoverage" placeholder="50" min="0" max="100" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.paymentInterval || "Opłata co ile minut"
                        }:</label>
                        <input type="number" id="customInsInterval" placeholder="60" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#888;font-size:0.85em;">${
                          t.paymentAmount || "Kwota opłaty"
                        }:</label>
                        <input type="number" id="customInsPayment" placeholder="100" style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:white;margin-top:3px;">
                    </div>
                    
                    <div style="display:flex;gap:10px;">
                        <button onclick="addCustomInsurance()" style="flex:1;padding:10px;background:#8b5cf6;color:white;border:none;border-radius:6px;cursor:pointer;">✅ ${
                          t.add || "Dodaj"
                        }</button>
                        <button onclick="cancelCustomInsurance()" style="flex:1;padding:10px;background:#333;color:white;border:none;border-radius:6px;cursor:pointer;">❌ ${
                          t.cancel || "Anuluj"
                        }</button>
                    </div>
                </div>
            `;
        }

        // Ceny za tworzenie ubezpieczenia
        const INSURANCE_COST_PER_FOOD = 5; // 5 zł za 1 kalorię
        const INSURANCE_COST_PER_WATER = 15; // 15 zł za 1 ml
        const INSURANCE_COST_PER_HP = 20; // 20 zł za 1 HP
        const INSURANCE_MAX_VALUE = 1000; // Max dla każdego

        function calculateInsuranceCost(ins) {
          const foodCost = (ins.food || 0) * INSURANCE_COST_PER_FOOD;
          const waterCost = (ins.water || 0) * INSURANCE_COST_PER_WATER;
          const hpCost = (ins.hp || 0) * INSURANCE_COST_PER_HP;
          return foodCost + waterCost + hpCost;
        }

        function addCustomInsurance() {
          const t = translations[currentLang] || translations.en;

          const name =
            document.getElementById("customInsName").value.trim() ||
            t.myInsurance ||
            "Moje ubezpieczenie";
          let hp = parseInt(document.getElementById("customInsHP").value) || 0;
          let food =
            parseInt(document.getElementById("customInsFood").value) || 0;
          let water =
            parseInt(document.getElementById("customInsWater").value) || 0;
          const coverage =
            parseInt(document.getElementById("customInsCoverage").value) || 0;
          const interval =
            parseInt(document.getElementById("customInsInterval").value) || 60;
          const payment =
            parseInt(document.getElementById("customInsPayment").value) || 100;

          // Limity max 1000
          hp = Math.min(INSURANCE_MAX_VALUE, Math.max(0, hp));
          food = Math.min(INSURANCE_MAX_VALUE, Math.max(0, food));
          water = Math.min(INSURANCE_MAX_VALUE, Math.max(0, water));

          const insuranceData = {
            type: "customInsurance",
            name: name,
            hp: hp,
            food: food,
            water: water,
            coverage: Math.min(100, Math.max(0, coverage)),
            interval: interval,
            payment: payment,
          };

          const creationCost = calculateInsuranceCost(insuranceData);

          // Sprawdź czy stać gracza
          if (creationCost > money) {
            alert(
              `${t.notEnoughMoney || "Nie masz wystarczająco pieniędzy!"}\n${
                t.cost || "Koszt"
              }: ${creationCost.toLocaleString()} ${getCurrency()}`
            );
            return;
          }

          auctionCustomInsurance = insuranceData;
          auctionCustomInsurance.creationCost = creationCost;

          const preview = document.getElementById("customInsurancePreview");
          preview.innerHTML = `
                <div style="background:#2a2a4e;padding:12px;border-radius:8px;border:2px solid #8b5cf6;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:bold;color:#8b5cf6;">🛡️ ${name}</div>
                            <div style="color:#888;font-size:0.85em;">
                                ${hp > 0 ? `+${hp} HP ` : ""}${
            food > 0 ? `+${food} 🍔 ` : ""
          }${water > 0 ? `+${water} 💧 ` : ""}${
            coverage > 0 ? `${coverage}% napraw ` : ""
          }
                            </div>
                            <div style="color:#666;font-size:0.8em;">${payment} ${getCurrency()} / ${interval} min</div>
                        </div>
                        <button onclick="removeCustomInsurance()" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;">❌</button>
                    </div>
                    <div style="margin-top:8px;padding-top:8px;border-top:1px solid #444;color:#f59e0b;font-size:0.85em;">
                        💰 ${
                          t.creationCost || "Koszt stworzenia"
                        }: ${creationCost.toLocaleString()} ${getCurrency()}
                    </div>
                </div>
            `;

          updateSelectedItemsPreview();
        }

        function cancelCustomInsurance() {
          document.getElementById("customInsurancePreview").innerHTML = "";
        }

        function removeCustomInsurance() {
          auctionCustomInsurance = null;
          document.getElementById("customInsurancePreview").innerHTML = "";
          updateSelectedItemsPreview();
        }

        async function createAuctionPackage() {
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();

          // Sprawdź czy zalogowany
          if (!playerName) {
            alert(t.loginFirst || "Najpierw się zaloguj!");
            openModal("onlineAccount");
            return;
          }

          const hasItems =
            auctionSelectedCars.length > 0 ||
            auctionSelectedFood.length > 0 ||
            auctionCustomInsurance;
          if (!hasItems) {
            alert(t.selectSomething || "Wybierz coś do wystawienia!");
            return;
          }

          const price = parseInt(
            document.getElementById("auctionPackagePrice").value
          );
          if (!price || price <= 0) {
            alert(t.enterPrice || "Podaj cenę!");
            return;
          }

          // Oblicz koszt stworzenia (tylko za ubezpieczenie)
          let creationCost = 0;
          if (auctionCustomInsurance && auctionCustomInsurance.creationCost) {
            creationCost = auctionCustomInsurance.creationCost;
          }

          // Sprawdź czy stać
          if (creationCost > money) {
            alert(
              `${t.notEnoughMoney || "Nie masz wystarczająco pieniędzy!"}\n${
                t.creationCost || "Koszt stworzenia"
              }: ${creationCost.toLocaleString()} ${getCurrency()}`
            );
            return;
          }

          // Podsumowanie przed wystawieniem
          let summary = `📦 ${
            t.auctionSummary || "Podsumowanie"
          }\n━━━━━━━━━━━━\n`;

          auctionSelectedCars.forEach((i) => {
            const car = garage[i];
            summary += `🚗 ${car.brand} ${car.model}\n`;
          });

          auctionSelectedFood.forEach((i) => {
            const item = backpack[i];
            const itemName = item.nameKey ? getItemName(item) : item.name;
            const icon = item.icon || "🍔";
            summary += `${icon} ${itemName}\n`;
          });

          if (auctionCustomInsurance) {
            summary += `🛡️ ${auctionCustomInsurance.name}\n`;
            if (creationCost > 0) {
              summary += `   💰 ${
                t.creationCost || "Koszt"
              }: -${creationCost.toLocaleString()} ${getCurrency()}\n`;
            }
          }

          summary += `━━━━━━━━━━━━\n`;
          summary += `💵 ${
            t.sellingPrice || "Cena sprzedaży"
          }: ${price.toLocaleString()} ${getCurrency()}\n`;
          if (creationCost > 0) {
            summary += `💸 ${
              t.youPay || "Płacisz"
            }: -${creationCost.toLocaleString()} ${getCurrency()}\n`;
          }
          summary += `\n${t.confirmListing || "Wystawić?"}`;

          if (!confirm(summary)) {
            return;
          }

          // Pobierz opłatę za ubezpieczenie
          if (creationCost > 0) {
            money -= creationCost;
            spent += creationCost;
          }

          // Zbierz przedmioty
          const packageItems = [];
          let packageName = "";

          // Auta (sortuj malejąco żeby usuwać od końca)
          auctionSelectedCars
            .sort((a, b) => b - a)
            .forEach((i) => {
              const car = garage[i];
              packageItems.push({ type: "car", data: car });
              packageName +=
                (packageName ? " + " : "") + car.brand + " " + car.model;
            });

          // Jedzenie
          auctionSelectedFood
            .sort((a, b) => b - a)
            .forEach((i) => {
              const item = backpack[i];
              packageItems.push({ type: "food", data: item });
              const itemName = item.nameKey ? getItemName(item) : item.name;
              packageName += (packageName ? " + " : "") + itemName;
            });

          // Ubezpieczenie (bez creationCost w danych)
          if (auctionCustomInsurance) {
            const insData = { ...auctionCustomInsurance };
            delete insData.creationCost;
            packageItems.push({ type: "customInsurance", data: insData });
            packageName +=
              (packageName ? " + " : "") + auctionCustomInsurance.name;
          }

          // Utwórz aukcję
          const data = getOnlineData();
          if (!data.auctions) data.auctions = {};

          const auctionId =
            "auction_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 6);
          data.auctions[auctionId] = {
            seller: playerName,
            name: packageName,
            items: packageItems,
            price: price,
            createdAt: Date.now(),
            status: "active",
            bids: [],
            negotiations: [],
          };

          saveOnlineData(data);

          // Usuń przedmioty z inwentarza
          auctionSelectedCars
            .sort((a, b) => b - a)
            .forEach((i) => {
              garage.splice(i, 1);
            });
          auctionSelectedFood
            .sort((a, b) => b - a)
            .forEach((i) => {
              backpack.splice(i, 1);
            });

          saveState();

          // Reset
          auctionSelectedCars = [];
          auctionSelectedFood = [];
          auctionCustomInsurance = null;

          let resultMsg = `✅ ${
            t.auctionCreated || "Wystawiono!"
          }\n${packageName}`;
          if (creationCost > 0) {
            resultMsg += `\n💸 -${creationCost.toLocaleString()} ${getCurrency()}`;
          }
          alert(resultMsg);
          updateAllDisplays();
        }

        function getItemIcon(item) {
          if (!item) return "📦";
          if (item.type === "car") return "🚗";
          if (item.type === "food") return item.data?.icon || "🍔";
          if (item.type === "customInsurance") return "🛡️";
          if (item.icon) return item.icon;
          return "📦";
        }

        async function cancelAuction(auctionId) {
          const t = translations[currentLang] || translations.en;

          if (
            !confirm(
              t.confirmCancelAuction ||
                "Anulować aukcję? Przedmioty wrócą do Ciebie."
            )
          ) {
            return;
          }

          const data = getOnlineData();
          if (!data.auctions || !data.auctions[auctionId]) return;

          const auction = data.auctions[auctionId];

          // Sprawdź czy to Twoja aukcja
          if (auction.seller !== playerName) {
            alert(t.notYourAuction || "To nie Twoja aukcja!");
            return;
          }

          // Zwróć przedmioty
          const save = getCurrentSave();
          if (!save.data.backpack) save.data.backpack = [];

          if (auction.items) {
            auction.items.forEach((item) => {
              if (item.type === "car") {
                garage.push(item.data);
              } else if (item.type === "food") {
                save.data.backpack.push(item.data);
              }
              // Ubezpieczenie przepada (opłata za stworzenie była pobrana)
            });
          }

          // Usuń aukcję
          delete data.auctions[auctionId];
          saveOnlineData(data);

          saveState();
          updateAllDisplays();

          alert(`✅ ${t.auctionCancelled || "Aukcja anulowana!"}`);
        }

        async function showAuctionDetail(auctionId) {
          const t = translations[currentLang] || translations.en;
          const data = getOnlineData();
          const auction = data.auctions[auctionId];
          if (!auction) return;

          // Generuj listę przedmiotów w pakiecie
          let itemsHtml = "";
          if (auction.items && auction.items.length > 0) {
            itemsHtml = auction.items
              .map((item) => {
                if (item.type === "car") {
                  return `<div style="padding:8px;background:#222;border-radius:6px;margin-bottom:5px;">🚗 ${item.data.brand} ${item.data.model}</div>`;
                } else if (item.type === "food") {
                  const itemName = item.data.nameKey
                    ? t[item.data.nameKey] || item.data.nameKey
                    : item.data.name;
                  const icon = item.data.icon || "🍔";
                  const kcal = item.data.kcal || item.data.food || 0;
                  const ml = item.data.ml || item.data.water || 0;
                  return `<div style="padding:8px;background:#222;border-radius:6px;margin-bottom:5px;">${icon} ${itemName} (+${kcal} 🍔 +${ml} 💧)</div>`;
                } else if (item.type === "customInsurance") {
                  const ins = item.data;
                  return `<div style="padding:8px;background:#222;border-radius:6px;margin-bottom:5px;">
                            🛡️ ${ins.name}<br>
                            <span style="color:#888;font-size:0.85em;">
                                ${ins.hp > 0 ? `+${ins.hp} HP ` : ""}${
                    ins.food > 0 ? `+${ins.food} 🍔 ` : ""
                  }${ins.water > 0 ? `+${ins.water} 💧 ` : ""}${
                    ins.coverage > 0
                      ? `${ins.coverage}% ${t.repairs || "napraw"}`
                      : ""
                  }<br>
                                ${ins.payment} ${getCurrency()} / ${
                    ins.interval
                  } min
                            </span>
                        </div>`;
                }
                return "";
              })
              .join("");
          } else if (auction.item) {
            // Stary format - pojedynczy przedmiot
            itemsHtml = `<div style="padding:8px;background:#222;border-radius:6px;">${getItemIcon(
              auction.item
            )} ${
              auction.item.name || auction.item.brand + " " + auction.item.model
            }</div>`;
          }

          const content = document.getElementById("auctionDetailContent");
          content.innerHTML = `
                <h3>📦 ${auction.name || "Pakiet"}</h3>
                <div style="background:#1a1a2e;padding:15px;border-radius:10px;margin:15px 0;">
                    <div style="font-weight:bold;margin-bottom:10px;">${
                      t.contents || "Zawartość"
                    }:</div>
                    ${itemsHtml}
                    <div style="display:flex;justify-content:space-between;margin-top:15px;padding-top:10px;border-top:1px solid #333;">
                        <span style="color:#888;">${
                          t.seller || "Sprzedawca"
                        }:</span>
                        <span>${auction.seller}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:8px;">
                        <span style="color:#888;">${t.price || "Cena"}:</span>
                        <span style="color:#10b981;font-weight:bold;font-size:1.2em;">${auction.price.toLocaleString()} ${getCurrency()}</span>
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <button onclick="buyAuctionItem('${auctionId}')" style="padding:15px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;">
                        💰 ${t.buyNow || "Kup teraz"}
                    </button>
                    <button onclick="showNegotiateModal('${auctionId}')" style="padding:15px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1em;">
                        🤝 ${t.negotiate || "Negocjuj cenę"}
                    </button>
                </div>
            `;
          openModal("auctionDetail");
        }

        let pendingAuctionId = null;

        async function buyAuctionItem(auctionId) {
          const t = translations[currentLang] || translations.en;
          const data = getOnlineData();
          const auction = data.auctions[auctionId];

          if (auction.price > limit) {
            pendingAction = "buyAuction";
            pendingAuctionId = auctionId;
            closeModal("auctionDetail");
            openModal("pin");
            return;
          }

          await completePurchaseWithPin(auctionId);
        }

        async function completePurchaseWithPin(auctionId) {
          const t = translations[currentLang] || translations.en;
          const result = await acceptAuction(auctionId, pin);

          if (result.success) {
            money -= result.price;
            spent += result.price;

            const save = getCurrentSave();
            if (!save.data.backpack) save.data.backpack = [];
            if (!save.data.customInsurances) save.data.customInsurances = [];

            // Dodaj przedmioty z pakietu
            if (result.items && result.items.length > 0) {
              result.items.forEach((item) => {
                if (item.type === "car") {
                  garage.push(item.data);
                } else if (item.type === "food") {
                  save.data.backpack.push(item.data);
                } else if (item.type === "customInsurance") {
                  save.data.customInsurances.push(item.data);
                }
              });
            } else if (result.item) {
              // Stary format
              if (result.item.type === "car") {
                garage.push(result.item.item || result.item);
              } else if (result.item.type === "food") {
                save.data.backpack.push(result.item.item || result.item);
              }
            }

            saveState();
            updateAllDisplays();
            closeModal("auctionDetail");
            alert(`✅ ${t.purchaseSuccess || "Zakup udany!"}`);
          } else if (result.error === "noMoney") {
            alert(t.notEnoughMoney || "Nie masz wystarczająco pieniędzy!");
          }
          pendingAuctionId = null;
        }

        async function forgotPinAuction() {
          const t = translations[currentLang] || translations.en;
          closeModal("pin");

          if (pendingAuctionId) {
            const data = getOnlineData();
            const auction = data.auctions[pendingAuctionId];

            sendNotification(auction.seller, {
              type: "pinRequired",
              from: playerName,
              auctionId: pendingAuctionId,
              amount: auction.price,
              message: t.buyerForgotPin || "Kupujący nie pamięta PIN",
            });

            alert(t.waitingForSeller || "Wysłano prośbę do sprzedawcy...");
          }
          pendingAction = null;
          pendingAuctionId = null;
        }

        async function showNegotiateModal(auctionId) {
          const t = translations[currentLang] || translations.en;
          const price = prompt(t.enterYourOffer || "Podaj swoją ofertę:");
          if (!price) return;

          const priceNum = parseInt(price);
          if (isNaN(priceNum) || priceNum <= 0) return;

          await negotiateAuction(auctionId, priceNum);
          closeModal("auctionDetail");
          alert(`✅ ${t.offerSent || "Wysłano ofertę!"}`);
        }

        async function allowWithoutPinUI(notifId, auctionId, buyerName) {
          await allowWithoutPin(notifId, auctionId, buyerName);
          renderNotifications();
        }

        async function denyWithoutPinUI(notifId, buyerName) {
          await denyWithoutPin(notifId, buyerName);
          renderNotifications();
        }

        async function respondNegotiation(notifId, auctionId, response) {
          const data = getOnlineData();
          const auction = data.auctions[auctionId];
          if (!auction) return;

          const negIndex = auction.negotiations.length - 1;
          await respondToNegotiation(auctionId, negIndex, response, null);
          removeNotification(notifId);
          renderNotifications();
        }

        async function showCounterOffer(notifId, auctionId, fromPlayer) {
          const t = translations[currentLang] || translations.en;
          const price = prompt(t.enterCounterOffer || "Podaj kontr-ofertę:");
          if (!price) return;

          const priceNum = parseInt(price);
          if (isNaN(priceNum) || priceNum <= 0) return;

          const data = getOnlineData();
          const auction = data.auctions[auctionId];
          const negIndex = auction.negotiations.length - 1;

          await respondToNegotiation(auctionId, negIndex, "counter", priceNum);
          removeNotification(notifId);
          renderNotifications();
        }

        // ==================== INIT ====================
        function init() {
          ensureDefaultSave();
          loadSaveData();
          generateLangGrid();
          applyLanguage();
          updateGameModeUI();
          updateAllDisplays();
          updateCurrentSaveDisplay();
          checkMissedTaxes();
          checkMissedHunger();
          checkInsuranceBenefits();
          startTaxTimer();
          startHungerTimer();
          startInsuranceTimer();
          checkUrlForVoucher();

          // Sprawdź oczekujące podatki od pracy
          setTimeout(() => {
            checkPendingTaxReport();
          }, 1000);

          // Sprawdź oczekujące raporty firm
          setTimeout(() => {
            checkPendingBusinessReports();
          }, 2000);

          // Sprawdź czy zalogowany - jeśli nie, pokaż ekran logowania
          if (!checkRequireLogin()) {
            // Sprawdź zaproszenie do znajomych
            checkFriendInvite();
          }

          // Event listenery dla modali
          document
            .getElementById("modalOnlineAccount")
            ?.addEventListener("click", (e) => {
              if (e.target.id === "modalOnlineAccount")
                closeModal("onlineAccount");
            });
          document
            .getElementById("modalNotifications")
            ?.addEventListener("click", (e) => {
              if (e.target.id === "modalNotifications")
                closeModal("notifications");
            });
          document
            .getElementById("modalChat")
            ?.addEventListener("click", (e) => {
              if (e.target.id === "modalChat") closeChatModal();
            });
          document
            .getElementById("modalAuction")
            ?.addEventListener("click", (e) => {
              if (e.target.id === "modalAuction") closeModal("auction");
            });
        }

        function saveState() {
          saveSaveData();
          localStorage.setItem("beamng_lang", currentLang);
        }

        async function generateCardCode() {
          const data = getOnlineData();
          const existingCards = new Set();

          // Zbierz wszystkie istniejące numery kart
          if (data.players) {
            for (const player of Object.values(data.players)) {
              if (player.cardNumber) {
                existingCards.add(player.cardNumber);
              }
            }
          }

          // Generuj unikalny kod 6 cyfr
          let code;
          let attempts = 0;
          do {
            code = "";
            for (let i = 0; i < 6; i++) code += Math.floor(Math.random() * 10);
            attempts++;
          } while (existingCards.has(code) && attempts < 100);

          return code;
        }

        function generateCardCodeSync() {
          // Wersja synchroniczna dla kompatybilności - 6 cyfr
          let code = "";
          for (let i = 0; i < 6; i++) code += Math.floor(Math.random() * 10);
          return code;
        }

        // ==================== OBSŁUGA FORMULARZY ====================
        let currentImageDataForVerify = null;
        let carSearchQuery = "";

        // Renderuj listę aut do kupienia
        function renderCarBuyList() {
          const grid = document.getElementById("carBuyGrid");
          const query = carSearchQuery.toLowerCase();
          const cars = getCurrentCars();

          const filtered = cars.filter(
            (car) =>
              car.brand.toLowerCase().includes(query) ||
              car.model.toLowerCase().includes(query) ||
              car.type.toLowerCase().includes(query)
          );

          if (filtered.length === 0) {
            grid.innerHTML =
              '<div style="text-align:center;padding:20px;color:#888;grid-column:span 2;">Nie znaleziono aut</div>';
            return;
          }

          grid.innerHTML = filtered
            .map(
              (car) => `
                <div class="shop-item" onclick="buyCar('${
                  car.id
                }')" style="padding:10px;">
                    <div class="item-icon">🚗</div>
                    <div class="item-name" style="font-size:0.8em;">${
                      car.brand
                    } ${car.model}</div>
                    <div class="item-stats">
                        <span style="color:#888;">${car.year}</span><br>
                        <span style="color:#aaa;font-size:0.9em;">${
                          car.type
                        }</span>
                    </div>
                    <div class="item-price">${car.price.toLocaleString()} ${getCurrency()}</div>
                </div>
            `
            )
            .join("");
        }

        function filterCars() {
          carSearchQuery = document.getElementById("carSearchInput").value;
          renderCarBuyList();
        }

        function buyCar(carId) {
          const cars = getCurrentCars();
          const car = cars.find((c) => c.id === carId);
          if (!car) return;

          const t = translations[currentLang] || translations.en;

          if (money < car.price) {
            alert(t.notEnoughMoney || "Nie masz wystarczająco pieniędzy!");
            return;
          }

          if (
            confirm(
              `${t.buyQuestion || "Kupić"} ${car.brand} ${car.model} ${
                t.forPrice || "za"
              } ${car.price.toLocaleString()} ${getCurrency()}?`
            )
          ) {
            // Dodaj do garażu
            garage.push({
              id: car.id,
              brand: car.brand,
              model: car.model,
              name: `${car.brand} ${car.model}`,
              price: car.price,
              type: car.type,
              year: car.year,
              upgradePercent: 50,
            });

            money -= car.price;
            spent += car.price;
            saveState();
            updateAllDisplays();
            playSound("buy");
            const t = translations[currentLang] || translations.en;
            alert(`🚙 ${t.carBought || "Kupiono"} ${car.brand} ${car.model}!`);
            closeModal("buy");
          }
        }

        // SPRZEDAŻ - garaż
        function renderGarage() {
          const list = document.getElementById("sellGarageList");
          const empty = document.getElementById("sellEmptyGarage");
          const section = document.getElementById("sellGarageSection");

          if (garage.length === 0) {
            section.style.display = "none";
            empty.style.display = "block";
            return;
          }

          empty.style.display = "none";
          section.style.display = "block";

          list.innerHTML = garage
            .map((car, i) => {
              const upgradePercent = car.upgradePercent || 50;
              const sellPrice = Math.floor(car.price * (upgradePercent / 100));
              return `
                <div class="garage-item" onclick="sellCar(${i})" ${
                car.broken ? 'style="opacity:0.5;pointer-events:none;"' : ""
              }>
                    <div>
                        <div class="car-name">🚗 ${
                          car.name || car.brand + " " + car.model
                        }</div>
                        <div class="car-price">${car.year || ""}</div>
                    </div>
                    <div style="text-align:right;">
                        ${
                          car.broken
                            ? '<div style="color:#ef4444;">🔧 Zepsute</div>'
                            : `
                            <div style="color:#4ade80;font-weight:bold;">+${sellPrice.toLocaleString()} ${getCurrency()}</div>
                            <div style="color:#888;font-size:0.8em;">${upgradePercent.toFixed(
                              1
                            )}%</div>
                        `
                        }
                    </div>
                </div>
            `;
            })
            .join("");
        }

        function sellCar(index) {
          if (index < 0 || index >= garage.length) return;

          const car = garage[index];
          const t = translations[currentLang] || translations.en;

          if (car.broken) {
            alert(t.cantSellBroken || "Nie można sprzedać zepsutego auta!");
            return;
          }

          const upgradePercent = car.upgradePercent || 50;
          const sellPrice = Math.floor(car.price * (upgradePercent / 100));

          const carName = car.name || car.brand + " " + car.model;
          if (
            confirm(
              `${t.confirmSell || "Sprzedać"} ${carName} ${
                t.forPrice || "za"
              } ${sellPrice.toLocaleString()} ${getCurrency()}?`
            )
          ) {
            money += sellPrice;
            garage.splice(index, 1);
            saveState();
            updateAllDisplays();
            renderGarage();
            playSound("sell");
            alert(
              `💸 Sprzedano za ${sellPrice.toLocaleString()} ${getCurrency()}!`
            );

            if (garage.length === 0) {
              closeModal("sell");
            }
          }
        }

        // Inicjalizacja inputów - zarobek km
        function initEarnInputs() {
          const kmInput = document.getElementById("kmInput");
          const btn = document.getElementById("earnBtn");

          if (kmInput) kmInput.value = "";
          if (btn) btn.classList.remove("active");

          const calcSpan = document.getElementById("kmCalc");
          if (calcSpan) calcSpan.textContent = "0";
        }

        // Event listener dla km
        document.addEventListener("input", function (e) {
          if (e.target.id === "kmInput") {
            const km = parseFloat(e.target.value) || 0;
            document.getElementById("kmCalc").textContent = (
              km * 100
            ).toLocaleString();
            currentEarnAmount = Math.floor(km * 100);
            document
              .getElementById("earnBtn")
              .classList.toggle("active", km > 0);
          }
        });

        function showSuccess(type, text, amount, amountClass) {
          const response = document.getElementById(type + "Response");
          const icon = type === "earn" ? "🛣️" : type === "buy" ? "🚙" : "💸";

          response.innerHTML = `
                <div class="result-icon">${icon}</div>
                <div class="result-text">${text}</div>
                <div class="result-amount ${amountClass}">${amount}</div>
            `;
          document.getElementById(type + "Btn").classList.add("active");
        }

        function showError(type) {
          const response = document.getElementById(type + "Response");
          response.innerHTML = `
                <div class="result-icon">❌</div>
                <div class="result-text" style="color: #f87171;">${
                  translations[currentLang].invalidScreenshot ||
                  "Nie rozpoznano danych!"
                }</div>
            `;
          document.getElementById(type + "Btn").classList.remove("active");
        }

        // ==================== SYSTEM WERYFIKACJI QR ====================
        let peer = null;
        let currentVerifyType = null;
        let currentImageData = null;
        let verifyResolve = null;

        // Sprawdź czy to strona weryfikatora
        function checkIfVerifier() {
          const params = new URLSearchParams(window.location.search);
          const peerId = params.get("verify");
          const type = params.get("type");
          const img = params.get("img");

          if (peerId && type) {
            showVerifierPage(peerId, type, img);
            return true;
          }
          return false;
        }

        function showVerifierPage(peerId, type, imgData) {
          document.body.innerHTML = `
                <div class="verify-page">
                    <h2>🔍 Weryfikacja transakcji</h2>
                    <p id="verifyQuestion">${getVerifyQuestion(type)}</p>
                    <img id="verifyImage" src="${imgData || ""}" style="${
            imgData ? "" : "display:none"
          }">
                    <div id="verifyStatus">
                        <div class="loader" style="width:40px;height:40px;border:3px solid #333;border-top-color:#ff6b35;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto;"></div>
                        <p>Łączenie z graczem...</p>
                    </div>
                    <div class="verify-buttons" id="verifyButtons" style="display:none;">
                        <button class="verify-btn yes" onclick="sendVerifyResponse(true)">✅ TAK</button>
                        <button class="verify-btn no" onclick="sendVerifyResponse(false)">❌ NIE</button>
                    </div>
                    <div id="verifyResult" style="display:none;"></div>
                </div>
            `;

          // Połącz z graczem
          connectToPlayer(peerId);
        }

        function getVerifyQuestion(type) {
          const questions = {
            repair: "Czy na tym obrazku widać uszkodzone auto?",
            sell: "Czy na tym obrazku widać auto?",
            sellDamage: "Czy auto na obrazku jest ZNISZCZONE?",
          };
          return questions[type] || "Czy obrazek jest prawidłowy?";
        }

        let verifierConn = null;

        function connectToPlayer(peerId) {
          const verifierPeer = new Peer();

          verifierPeer.on("open", () => {
            verifierConn = verifierPeer.connect(peerId);

            verifierConn.on("open", () => {
              document.getElementById("verifyStatus").innerHTML =
                '<p style="color:#4ade80;">✅ Połączono!</p>';
              document.getElementById("verifyButtons").style.display = "flex";
            });

            verifierConn.on("data", (data) => {
              if (data.type === "image") {
                document.getElementById("verifyImage").src = data.image;
                document.getElementById("verifyImage").style.display = "block";
              }
            });

            verifierConn.on("error", (err) => {
              document.getElementById("verifyStatus").innerHTML =
                '<p style="color:#ef4444;">❌ Błąd połączenia</p>';
            });
          });

          verifierPeer.on("error", (err) => {
            document.getElementById("verifyStatus").innerHTML =
              '<p style="color:#ef4444;">❌ Nie można połączyć</p>';
          });
        }

        function sendVerifyResponse(approved) {
          if (verifierConn) {
            verifierConn.send({ type: "response", approved: approved });

            document.getElementById("verifyButtons").style.display = "none";
            document.getElementById("verifyResult").style.display = "block";
            document.getElementById("verifyResult").innerHTML = approved
              ? '<div class="verify-result">✅</div><p style="color:#4ade80;font-size:1.5em;">Transakcja potwierdzona!</p>'
              : '<div class="verify-result">❌</div><p style="color:#ef4444;font-size:1.5em;">Transakcja odrzucona!</p>';
          }
        }

        // Funkcja do generowania QR i czekania na weryfikację
        function startVerification(type, imageData) {
          return new Promise((resolve) => {
            verifyResolve = resolve;
            currentVerifyType = type;
            currentImageData = imageData;

            // Stwórz peer dla gracza
            if (peer) {
              peer.destroy();
            }

            peer = new Peer();

            peer.on("open", (id) => {
              // Generuj URL dla weryfikatora
              const baseUrl = window.location.href.split("?")[0];
              const verifyUrl = `${baseUrl}?verify=${id}&type=${type}`;

              // Pokaż QR
              showQRCode(type, verifyUrl, imageData);
            });

            peer.on("connection", (conn) => {
              conn.on("open", () => {
                // Wyślij obrazek do weryfikatora
                conn.send({ type: "image", image: imageData });
                updateQRStatus("connected");
              });

              conn.on("data", (data) => {
                if (data.type === "response") {
                  if (data.approved) {
                    updateQRStatus("approved");
                    resolve(true);
                  } else {
                    updateQRStatus("rejected");
                    resolve(false);
                  }
                }
              });
            });

            peer.on("error", (err) => {
              console.error("Peer error:", err);
              updateQRStatus("error");
              resolve(false);
            });
          });
        }

        function showQRCode(type, url, imageData) {
          const response = document.getElementById(type + "Response");

          response.innerHTML = `
                <div class="qr-section">
                    <h4>📱 Poproś kogoś o weryfikację</h4>
                    <p>Niech zeskanuje kod QR telefonem</p>
                    <div class="qr-container" id="qr-${type}"></div>
                    <div class="qr-status waiting" id="qrStatus-${type}">
                        ⏳ Oczekiwanie na weryfikatora...
                    </div>
                </div>
            `;

          // Generuj QR kod
          new QRCode(document.getElementById(`qr-${type}`), {
            text: url,
            width: 180,
            height: 180,
            colorDark: "#1a1a2e",
            colorLight: "#ffffff",
          });
        }

        function updateQRStatus(status) {
          const statusEl = document.querySelector('[id^="qrStatus-"]');
          if (!statusEl) return;

          const type = currentVerifyType;
          const btn = document.getElementById(type + "Btn");

          switch (status) {
            case "connected":
              statusEl.className = "qr-status waiting";
              statusEl.innerHTML =
                "🔗 Weryfikator połączony, czekam na odpowiedź...";
              break;
            case "approved":
              statusEl.className = "qr-status success";
              statusEl.innerHTML = "✅ Transakcja potwierdzona!";
              if (btn) btn.classList.add("active");

              // Pokaż też koszt/cenę
              setTimeout(() => {
                showVerifiedResult(type);
              }, 1000);
              break;
            case "rejected":
              statusEl.className = "qr-status rejected";
              statusEl.innerHTML = "❌ Transakcja odrzucona!";
              if (btn) btn.classList.remove("active");
              break;
            case "error":
              statusEl.className = "qr-status rejected";
              statusEl.innerHTML = "❌ Błąd połączenia";
              break;
          }
        }

        function showVerifiedResult(type) {
          const response = document.getElementById(type + "Response");

          if (type === "repair") {
            response.innerHTML = `
                    <div class="result-icon">🔧✅</div>
                    <div class="result-text">${
                      translations[currentLang].repairCostInfo ||
                      "Koszt naprawy:"
                    }</div>
                    <div class="result-amount cost">-5,000 ${getCurrency()}</div>
                    <div style="color:#4ade80;margin-top:10px;font-size:0.9em;">Zweryfikowano!</div>
                `;
          } else if (type === "buy") {
            response.innerHTML = `
                    <div class="result-icon">🚙✅</div>
                    <div class="result-text">${
                      translations[currentLang].foundPrice || "Cena auta:"
                    } ${currentBuyPrice.toLocaleString()} ${getCurrency()}</div>
                    <div class="result-amount cost">-${currentBuyPrice.toLocaleString()} ${getCurrency()}</div>
                    <div style="color:#4ade80;margin-top:10px;font-size:0.9em;">Zweryfikowano!</div>
                `;
          } else if (type === "sell") {
            response.innerHTML = `
                    <div class="result-icon">💸✅</div>
                    <div class="result-text">${
                      translations[currentLang].foundPrice || "Cena auta:"
                    } (50%)</div>
                    <div class="result-amount earn">+${currentSellPrice.toLocaleString()} ${getCurrency()}</div>
                    <div style="color:#4ade80;margin-top:10px;font-size:0.9em;">Zweryfikowano!</div>
                `;
          }
        }

        // Zmodyfikowana funkcja naprawy z QR
        async function analyzeRepairImage(input) {
          if (!input.files || !input.files[0]) return;

          const file = input.files[0];
          const preview = document.getElementById("repairPreview");
          const response = document.getElementById("repairResponse");
          const btn = document.getElementById("repairBtn");

          const reader = new FileReader();
          reader.onload = async function (e) {
            const imageData = e.target.result;
            preview.src = imageData;
            preview.style.display = "block";
            document.getElementById("repairUpload").style.display = "none";

            response.classList.add("active");

            // Uruchom weryfikację QR
            const approved = await startVerification("repair", imageData);

            if (!approved) {
              btn.classList.remove("active");
            }
          };
          reader.readAsDataURL(file);
        }

        function confirmCarVisible(type) {
          const response = document.getElementById(type + "Response");
          const btn = document.getElementById(type + "Btn");

          if (type === "repair") {
            response.innerHTML = `
                    <div class="result-icon">🔧</div>
                    <div class="result-text">${
                      translations[currentLang].repairCostInfo ||
                      "Koszt naprawy:"
                    }</div>
                    <div class="result-amount cost">-5,000 ${getCurrency()}</div>
                `;
            btn.classList.add("active");
          }
        }

        function denyCarVisible(type) {
          const response = document.getElementById(type + "Response");
          response.innerHTML = `
                <div class="result-icon">❌</div>
                <div class="result-text" style="color: #f87171;">${
                  translations[currentLang].noCarOnScreen ||
                  "Wyślij screenshot z widocznym autem!"
                }</div>
            `;
          // Reset uploadu
          setTimeout(() => {
            resetUploadForm(type);
          }, 2000);
        }

        // ==================== AKCJE ====================
        function confirmEarn() {
          money += currentEarnAmount;
          saveState();
          updateAllDisplays();
          alert(`💰 +${currentEarnAmount.toLocaleString()} ${getCurrency()}!`);
          closeModal("earn");
        }

        // ==================== PODATKI ====================
        function checkMissedTaxes() {
          // WYŁĄCZONY - stary system podatków co 5 minut
          // Teraz podatki są pobierane raz dziennie od zarobków z pracy
        }

        function startTaxTimer() {
          // WYŁĄCZONY - stary system podatków co 5 minut
          // Teraz podatki są pobierane raz dziennie od zarobków z pracy
          // setInterval(updateNextTaxDisplay, 1000);
          // setInterval(collectTax, 5 * 60 * 1000);
        }

        function collectTax() {
          // WYŁĄCZONY - stary system
          // Teraz używamy checkPendingTaxReport() dla podatków dziennych
        }

        function addDebt(amount) {
          debt += amount;
          if (!debtDeadline) {
            const deadline = new Date();
            deadline.setDate(deadline.getDate() + 7);
            debtDeadline = deadline.toISOString();
          }
          saveState();
        }

        function updateNextTaxDisplay() {
          // WYŁĄCZONY - stary system
        }

        function toggleAutoPay() {
          // WYŁĄCZONY - stary system
        }

        function payDebt() {
          if (money >= debt) {
            money -= debt;
            debt = 0;
            debtDeadline = null;
            saveState();
            updateAllDisplays();
            alert("✅ Dług spłacony!");
          } else {
            alert(
              translations[currentLang].notEnoughMoney ||
                "Nie masz wystarczająco pieniędzy!"
            );
          }
        }

        // ==================== GŁÓD I PRAGNIENIE ====================
        function checkMissedHunger() {
          const now = Date.now();
          const elapsed = now - lastHungerTime;
          const missedIntervals = Math.floor(elapsed / HUNGER_INTERVAL);

          if (missedIntervals > 0) {
            // Zmniejsz jedzenie i picie
            food = Math.max(0, food - FOOD_DECAY * missedIntervals);
            water = Math.max(0, water - WATER_DECAY * missedIntervals);

            // Jeśli głodny/spragniony - trać zdrowie
            if (food <= 0 || water <= 0) {
              const healthLoss = missedIntervals * 5;
              health = Math.max(0, health - healthLoss);
            }

            lastHungerTime = now;
            saveState();
          }
        }

        function startHungerTimer() {
          // Sprawdzaj co sekundę dla aktualizacji wyświetlania
          setInterval(updateHungerDisplay, 1000);
          // Zużywaj głód/pragnienie co 5 minut
          setInterval(consumeHunger, HUNGER_INTERVAL);
        }

        function consumeHunger() {
          food = Math.max(0, food - FOOD_DECAY);
          water = Math.max(0, water - WATER_DECAY);

          // Jeśli głodny/spragniony - trać zdrowie
          if (food <= 0 || water <= 0) {
            health = Math.max(0, health - 5);
          }

          lastHungerTime = Date.now();
          saveState();
          updateAllDisplays();

          // Sprawdź śmierć
          checkDeath();

          // Ostrzeżenie gdy niski poziom - ciche
        }

        function checkDeath() {
          if (health <= 0) {
            playerDied();
          }
        }

        function playerDied() {
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();
          const isEn = currentLang === "en";

          // Zatrzymaj wszystkie ulepszania
          Object.keys(upgradeIntervals).forEach((idx) => {
            clearInterval(upgradeIntervals[idx]);
          });
          upgradeIntervals = {};

          // Sprawdź czy jest checkpoint
          const modeKey =
            gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";
          const checkpoint = save[modeKey];

          // Pokaż epicką animację śmierci
          showDeathScreen(checkpoint, () => {
            if (checkpoint) {
              loadCheckpoint();
            } else {
              resetModeProgress();
            }
            updateAllDisplays();
            renderGarageModal();
          });
        }

        // ==================== EPICKI EKRAN ŚMIERCI ====================
        function showDeathScreen(hasCheckpoint, callback) {
          const isEn = currentLang === "en";

          // Stwórz overlay śmierci
          const deathOverlay = document.createElement("div");
          deathOverlay.id = "deathOverlay";
          deathOverlay.innerHTML = `
          <style>
            @keyframes deathFadeIn {
              0% { opacity: 0; }
              100% { opacity: 1; }
            }
            @keyframes deathPulse {
              0%, 100% { transform: scale(1); opacity: 1; }
              50% { transform: scale(1.1); opacity: 0.8; }
            }
            @keyframes deathGlitch {
              0%, 100% { transform: translateX(0); filter: hue-rotate(0deg); }
              25% { transform: translateX(-5px); filter: hue-rotate(90deg); }
              50% { transform: translateX(5px); filter: hue-rotate(180deg); }
              75% { transform: translateX(-3px); filter: hue-rotate(270deg); }
            }
            @keyframes bloodDrip {
              0% { height: 0; }
              100% { height: 100%; }
            }
            @keyframes heartbeat {
              0%, 100% { transform: scale(1); }
              15% { transform: scale(1.3); }
              30% { transform: scale(1); }
              45% { transform: scale(1.2); }
              60% { transform: scale(1); }
            }
            @keyframes textFlicker {
              0%, 100% { opacity: 1; }
              50% { opacity: 0.5; }
            }
            #deathOverlay {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: radial-gradient(ellipse at center, #1a0000 0%, #000000 70%, #000000 100%);
              z-index: 99999;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              animation: deathFadeIn 1s ease-out;
              overflow: hidden;
            }
            .death-vignette {
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: radial-gradient(ellipse at center, transparent 30%, rgba(139,0,0,0.4) 100%);
              pointer-events: none;
            }
            .death-blood-left, .death-blood-right {
              position: absolute;
              top: 0;
              width: 100px;
              background: linear-gradient(180deg, #8b0000 0%, #dc143c 50%, transparent 100%);
              animation: bloodDrip 2s ease-out forwards;
              opacity: 0.6;
            }
            .death-blood-left { left: 10%; }
            .death-blood-right { right: 15%; }
            .death-skull {
              font-size: 8em;
              animation: heartbeat 2s ease-in-out infinite, deathGlitch 0.5s ease-in-out infinite;
              text-shadow: 0 0 50px #dc143c, 0 0 100px #8b0000;
              margin-bottom: 20px;
            }
            .death-title {
              font-size: 4em;
              font-weight: bold;
              color: #dc143c;
              text-shadow: 0 0 20px #dc143c, 0 0 40px #8b0000, 2px 2px 0 #000;
              animation: deathPulse 1.5s ease-in-out infinite;
              margin-bottom: 20px;
              letter-spacing: 10px;
            }
            .death-subtitle {
              font-size: 1.2em;
              color: #888;
              margin-bottom: 40px;
              animation: textFlicker 2s ease-in-out infinite;
            }
            .death-checkpoint-info {
              background: ${
                hasCheckpoint ? "rgba(34,197,94,0.2)" : "rgba(239,68,68,0.2)"
              };
              border: 2px solid ${hasCheckpoint ? "#22c55e" : "#ef4444"};
              border-radius: 15px;
              padding: 20px 40px;
              margin-bottom: 30px;
              text-align: center;
            }
            .death-checkpoint-icon {
              font-size: 3em;
              margin-bottom: 10px;
            }
            .death-checkpoint-text {
              color: ${hasCheckpoint ? "#4ade80" : "#f87171"};
              font-size: 1.1em;
            }
            .death-btn {
              padding: 18px 50px;
              font-size: 1.3em;
              font-weight: bold;
              border: none;
              border-radius: 12px;
              cursor: pointer;
              background: linear-gradient(145deg, #dc143c, #8b0000);
              color: white;
              box-shadow: 0 5px 30px rgba(220,20,60,0.5);
              transition: all 0.3s;
              text-transform: uppercase;
              letter-spacing: 3px;
            }
            .death-btn:hover {
              transform: scale(1.05);
              box-shadow: 0 8px 40px rgba(220,20,60,0.7);
            }
            .death-particles {
              position: absolute;
              width: 100%;
              height: 100%;
              pointer-events: none;
              overflow: hidden;
            }
            .death-particle {
              position: absolute;
              width: 4px;
              height: 4px;
              background: #dc143c;
              border-radius: 50%;
              animation: particleFall linear infinite;
            }
            @keyframes particleFall {
              0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
              100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
            }
          </style>
          
          <div class="death-vignette"></div>
          <div class="death-blood-left"></div>
          <div class="death-blood-right"></div>
          
          <div class="death-particles" id="deathParticles"></div>
          
          <div class="death-skull">💀</div>
          <div class="death-title">${isEn ? "YOU DIED" : "ZGINĄŁEŚ"}</div>
          <div class="death-subtitle">${
            isEn
              ? "Your journey has come to an end..."
              : "Twoja podróż dobiegła końca..."
          }</div>
          
          <div class="death-checkpoint-info">
            <div class="death-checkpoint-icon">${
              hasCheckpoint ? "💾" : "❌"
            }</div>
            <div class="death-checkpoint-text">
              ${
                hasCheckpoint
                  ? isEn
                    ? "Loading last checkpoint..."
                    : "Wczytywanie ostatniego checkpointu..."
                  : isEn
                  ? "No checkpoint found - Starting over!"
                  : "Brak checkpointu - Zaczynasz od nowa!"
              }
            </div>
          </div>
          
          <button class="death-btn" id="deathContinueBtn">
            ${
              hasCheckpoint
                ? isEn
                  ? "↻ RESPAWN"
                  : "↻ ODRODZENIE"
                : isEn
                ? "⟳ NEW START"
                : "⟳ NOWY START"
            }
          </button>
        `;

          document.body.appendChild(deathOverlay);

          // Dodaj particles
          const particlesContainer = document.getElementById("deathParticles");
          for (let i = 0; i < 50; i++) {
            const particle = document.createElement("div");
            particle.className = "death-particle";
            particle.style.left = Math.random() * 100 + "%";
            particle.style.animationDuration = Math.random() * 3 + 2 + "s";
            particle.style.animationDelay = Math.random() * 2 + "s";
            particlesContainer.appendChild(particle);
          }

          // Obsługa przycisku
          document.getElementById("deathContinueBtn").onclick = () => {
            deathOverlay.style.animation =
              "deathFadeIn 0.5s ease-out reverse forwards";
            setTimeout(() => {
              deathOverlay.remove();
              callback();
            }, 500);
          };
        }

        function createCheckpoint() {
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";
          const save = getCurrentSave();
          if (!save) return;

          const modeKey =
            gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";
          const dataKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";

          // Zapisz KOMPLETNY stan jako checkpoint - włącznie z firmami, kredytami, itd.
          const modeData = save[dataKey] || {};

          save[modeKey] = {
            // Podstawowe dane finansowe
            money: money,
            garage: JSON.parse(JSON.stringify(garage)),
            spent: spent,
            debt: debt,
            debtDeadline: debtDeadline,
            totalTaxPaid: totalTaxPaid,

            // Statystyki gracza
            health: health,
            food: food,
            water: water,
            backpack: JSON.parse(JSON.stringify(backpack)),
            activeInsurances: JSON.parse(JSON.stringify(activeInsurances)),

            // FIRMY - pełna kopia
            businesses: modeData.businesses
              ? JSON.parse(JSON.stringify(modeData.businesses))
              : [],

            // KREDYTY - pełna kopia
            credits: modeData.credits
              ? JSON.parse(JSON.stringify(modeData.credits))
              : [],

            // Doświadczenie w pracy
            workExperience: modeData.workExperience
              ? JSON.parse(JSON.stringify(modeData.workExperience))
              : {},

            // Vouchery
            vouchersToSend: modeData.vouchersToSend
              ? JSON.parse(JSON.stringify(modeData.vouchersToSend))
              : [],
            receivedVouchers: modeData.receivedVouchers
              ? JSON.parse(JSON.stringify(modeData.receivedVouchers))
              : [],

            // Powiadomienia pracowników
            workerNotifications: modeData.workerNotifications
              ? JSON.parse(JSON.stringify(modeData.workerNotifications))
              : [],

            // Timestamp
            createdAt: Date.now(),
          };

          localStorage.setItem("beamng_saves", JSON.stringify(saves));

          // Pokaż ładną animację zamiast alert
          showCheckpointCreatedAnimation();
          renderSavesList();
        }

        function showCheckpointCreatedAnimation() {
          const isEn = currentLang === "en";

          const overlay = document.createElement("div");
          overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          z-index: 99998;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease-out;
        `;
          overlay.innerHTML = `
          <div style="text-align: center; animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);">
            <div style="font-size: 6em; margin-bottom: 20px; animation: bounce 0.6s ease-out;">💾</div>
            <div style="font-size: 2em; color: #4ade80; font-weight: bold; text-shadow: 0 0 20px rgba(74,222,128,0.5);">
              ${isEn ? "CHECKPOINT SAVED!" : "CHECKPOINT ZAPISANY!"}
            </div>
            <div style="color: #888; margin-top: 10px; font-size: 1.1em;">
              ${
                isEn
                  ? "If you die, you will return to this moment"
                  : "Jeśli zginiesz, wrócisz do tego momentu"
              }
            </div>
            <div style="color: #4ade80; margin-top: 15px; font-size: 0.9em;">
              ✓ ${isEn ? "Money" : "Pieniądze"} ✓ ${isEn ? "Cars" : "Auta"} ✓ ${
            isEn ? "Businesses" : "Firmy"
          } ✓ ${isEn ? "Credits" : "Kredyty"} ✓ ${
            isEn ? "Workers" : "Pracownicy"
          }
            </div>
          </div>
          <style>
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes scaleIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
            @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
          </style>
        `;

          document.body.appendChild(overlay);

          setTimeout(() => {
            overlay.style.animation = "fadeIn 0.3s ease-out reverse forwards";
            setTimeout(() => overlay.remove(), 300);
          }, 2000);
        }

        function loadCheckpoint() {
          const save = getCurrentSave();
          if (!save) return;

          const modeKey =
            gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";
          const dataKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          const checkpoint = save[modeKey];

          if (!checkpoint) return;

          // Przywróć podstawowe dane
          money = checkpoint.money;
          garage = JSON.parse(JSON.stringify(checkpoint.garage));
          spent = checkpoint.spent;
          debt = checkpoint.debt;
          debtDeadline = checkpoint.debtDeadline;
          totalTaxPaid = checkpoint.totalTaxPaid;
          health = checkpoint.health;
          food = checkpoint.food;
          water = checkpoint.water;
          backpack = JSON.parse(JSON.stringify(checkpoint.backpack));
          activeInsurances = JSON.parse(
            JSON.stringify(checkpoint.activeInsurances)
          );

          // Przywróć FIRMY i KREDYTY do modeData
          if (!save[dataKey]) save[dataKey] = {};

          // Firmy
          if (checkpoint.businesses) {
            save[dataKey].businesses = JSON.parse(
              JSON.stringify(checkpoint.businesses)
            );
          } else {
            save[dataKey].businesses = [];
          }

          // Kredyty
          if (checkpoint.credits) {
            save[dataKey].credits = JSON.parse(
              JSON.stringify(checkpoint.credits)
            );
          } else {
            save[dataKey].credits = [];
          }

          // Doświadczenie
          if (checkpoint.workExperience) {
            save[dataKey].workExperience = JSON.parse(
              JSON.stringify(checkpoint.workExperience)
            );
          }

          // Vouchery
          if (checkpoint.vouchersToSend) {
            save[dataKey].vouchersToSend = JSON.parse(
              JSON.stringify(checkpoint.vouchersToSend)
            );
          }
          if (checkpoint.receivedVouchers) {
            save[dataKey].receivedVouchers = JSON.parse(
              JSON.stringify(checkpoint.receivedVouchers)
            );
          }

          // Powiadomienia
          if (checkpoint.workerNotifications) {
            save[dataKey].workerNotifications = JSON.parse(
              JSON.stringify(checkpoint.workerNotifications)
            );
          }

          // Wznów ulepszania
          resumeUpgrades();
          saveState();

          // Zapisz zmiany
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
        }

        function resetModeProgress() {
          const save = getCurrentSave();
          const dataKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";

          // Reset podstawowych danych
          money = 1500;
          garage = [];
          spent = 0;
          debt = 0;
          debtDeadline = null;
          totalTaxPaid = 0;
          health = 100;
          food = 1000;
          water = 1000;
          backpack = [];
          activeInsurances = [];

          // Reset WSZYSTKIEGO w modeData
          if (save && save[dataKey]) {
            save[dataKey].businesses = [];
            save[dataKey].credits = [];
            save[dataKey].workExperience = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            save[dataKey].vouchersToSend = [];
            save[dataKey].receivedVouchers = [];
            save[dataKey].workerNotifications = [];
          }

          saveState();
          localStorage.setItem("beamng_saves", JSON.stringify(saves));
        }

        function deleteCheckpoint() {
          const t = translations[currentLang] || translations.en;
          const save = getCurrentSave();
          if (!save) return;

          const modeKey =
            gameMode === "reallife" ? "realLifeCheckpoint" : "beamngCheckpoint";

          if (!save[modeKey]) {
            alert(
              t.noCheckpointToDelete || "Nie masz checkpointu do usunięcia!"
            );
            return;
          }

          if (
            confirm(
              t.confirmDeleteCheckpoint ||
                "Usunąć checkpoint? Jeśli zginiesz, stracisz cały postęp!"
            )
          ) {
            delete save[modeKey];
            localStorage.setItem("beamng_saves", JSON.stringify(saves));
            alert(t.checkpointDeleted || "Checkpoint usunięty!");
            renderSavesList();
          }
        }

        function updateHungerDisplay() {
          // Można tu dodać timer do następnego zużycia
        }

        // ==================== UBEZPIECZENIA ====================
        let selectedInsurancePackage = null;

        function renderInsuranceList() {
          const list = document.getElementById("insuranceList");
          const activeSection = document.getElementById(
            "activeInsurancesSection"
          );
          const activeList = document.getElementById("activeInsurancesList");
          const activeCount = document.getElementById("activeCount");

          const t = translations[currentLang] || translations.en;

          // Pokaż aktywne ubezpieczenia
          if (activeInsurances.length > 0) {
            activeSection.style.display = "block";
            activeCount.textContent = activeInsurances.length;

            activeList.innerHTML = activeInsurances
              .map((ins, idx) => {
                const pkg = insurancePackages.find(
                  (p) => p.id === ins.packageId
                );
                if (!pkg) return "";

                const periodText =
                  ins.period === "hour"
                    ? t.perHour || "/godz"
                    : ins.period === "day"
                    ? t.perDay || "/dzień"
                    : t.perWeek || "/tydzień";

                const remaining = ins.nextPaymentAt - Date.now();
                const hoursLeft = Math.max(
                  0,
                  Math.floor(remaining / (60 * 60 * 1000))
                );
                const minsLeft = Math.max(
                  0,
                  Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000))
                );

                return `
                        <div style="background:rgba(74,222,128,0.1);border:1px solid #4ade80;border-radius:8px;padding:8px;margin-bottom:5px;display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:bold;font-size:0.9em;">${
                                  pkg.icon
                                } ${getInsuranceName(pkg)}</div>
                                <div style="font-size:0.75em;color:#888;">${ins.price.toLocaleString()} ${getCurrency()} ${periodText}</div>
                                <div style="font-size:0.7em;color:#aaa;">⏱️ ${hoursLeft}h ${minsLeft}m | ${
                  ins.autoPay ? "✅" : "❌"
                } Auto</div>
                            </div>
                            <button onclick="showInsuranceDetails(${idx})" style="padding:5px 10px;background:#ff6b35;color:white;border:none;border-radius:5px;font-size:0.8em;cursor:pointer;">📋</button>
                        </div>
                    `;
              })
              .join("");
          } else {
            activeSection.style.display = "none";
          }

          // Lista pakietów do kupienia
          list.innerHTML = insurancePackages
            .map((pkg) => {
              const isOwned = activeInsurances.some(
                (i) => i.packageId === pkg.id
              );

              return `
                <div class="garage-item" onclick="${
                  isOwned ? "" : `showInsurancePeriods('${pkg.id}')`
                }" style="${
                isOwned
                  ? "opacity:0.5;cursor:default;border-color:#4ade80;"
                  : ""
              }">
                    <div>
                        <div class="car-name">${pkg.icon} ${getInsuranceName(
                pkg
              )}</div>
                        <div style="font-size:0.75em;color:#aaa;">${getInsuranceDesc(
                          pkg
                        )} ${t.every || "co"} ${pkg.interval} min</div>
                    </div>
                    <div style="text-align:right;font-size:0.75em;">
                        <div style="color:#ff6b35;">${
                          pkg.prices.hour
                        } ${getCurrency()}<span style="color:#666;">${
                t.perHourShort || "/h"
              }</span></div>
                        <div style="color:#ff6b35;">${
                          pkg.prices.day
                        } ${getCurrency()}<span style="color:#666;">${
                t.perDayShort || "/d"
              }</span></div>
                        <div style="color:#ff6b35;">${
                          pkg.prices.week
                        } ${getCurrency()}<span style="color:#666;">${
                t.perWeekShort || "/tyg"
              }</span></div>
                        ${
                          isOwned
                            ? '<div style="color:#4ade80;margin-top:2px;">✅</div>'
                            : ""
                        }
                    </div>
                </div>
            `;
            })
            .join("");
        }

        function showInsurancePeriods(packageId) {
          selectedInsurancePackage = insurancePackages.find(
            (p) => p.id === packageId
          );
          if (!selectedInsurancePackage) return;

          const pkg = selectedInsurancePackage;
          const t = translations[currentLang] || translations.en;

          document.getElementById("insurancePeriodDetails").innerHTML = `
                <div style="font-size:2em;">${pkg.icon}</div>
                <div style="font-weight:bold;font-size:1.2em;">${getInsuranceName(
                  pkg
                )}</div>
                <div style="color:#aaa;font-size:0.9em;">${getInsuranceDesc(
                  pkg
                )} ${t.every || "co"} ${pkg.interval} min</div>
            `;

          document.getElementById("periodOptions").innerHTML = `
                <button onclick="buyInsurance('hour')" style="padding:15px;background:linear-gradient(145deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span>⏰ ${t.hour || "Godzina"}</span>
                    <span style="font-weight:bold;">${pkg.prices.hour.toLocaleString()} ${getCurrency()}</span>
                </button>
                <button onclick="buyInsurance('day')" style="padding:15px;background:linear-gradient(145deg,#3b82f6,#2563eb);color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span>📅 ${t.day || "Dzień"}</span>
                    <span style="font-weight:bold;">${pkg.prices.day.toLocaleString()} ${getCurrency()}</span>
                </button>
                <button onclick="buyInsurance('week')" style="padding:15px;background:linear-gradient(145deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span>📆 ${t.week || "Tydzień"}</span>
                    <span style="font-weight:bold;">${pkg.prices.week.toLocaleString()} ${getCurrency()}</span>
                </button>
            `;

          openModal("insurancePeriod");
        }

        function buyInsurance(period) {
          if (!selectedInsurancePackage) return;

          const pkg = selectedInsurancePackage;
          let price, duration;

          if (period === "hour") {
            price = pkg.prices.hour;
            duration = 60 * 60 * 1000; // 1 godzina
          } else if (period === "day") {
            price = pkg.prices.day;
            duration = 24 * 60 * 60 * 1000; // 1 dzień
          } else {
            price = pkg.prices.week;
            duration = 7 * 24 * 60 * 60 * 1000; // 1 tydzień
          }

          if (money < price) {
            alert(
              translations[currentLang].notEnoughMoney ||
                "Nie masz wystarczająco pieniędzy!"
            );
            return;
          }

          // Sprawdź czy już ma to ubezpieczenie
          if (activeInsurances.some((i) => i.packageId === pkg.id)) {
            alert(
              translations[currentLang].alreadyHaveInsurance ||
                "Już masz to ubezpieczenie!"
            );
            return;
          }

          money -= price;
          activeInsurances.push({
            packageId: pkg.id,
            period: period,
            price: price,
            totalPaid: price,
            benefitCount: 0,
            autoPay: true,
            startedAt: Date.now(),
            lastBenefitAt: Date.now(),
            nextPaymentAt: Date.now() + duration,
          });

          playSound("insurance");
          saveState();
          updateAllDisplays();
          closeModal("insurancePeriod");
          renderInsuranceList();

          const t = translations[currentLang] || translations.en;
          alert(
            `🏥 ${getInsuranceName(pkg)} - ${t.activated || "Aktywowane"}!`
          );
        }

        function showInsuranceDetails(index) {
          if (index < 0 || index >= activeInsurances.length) return;

          const ins = activeInsurances[index];
          const pkg = insurancePackages.find((p) => p.id === ins.packageId);
          if (!pkg) return;

          const t = translations[currentLang] || translations.en;
          const periodText =
            ins.period === "hour"
              ? t.perHour || "/godz"
              : ins.period === "day"
              ? t.perDay || "/dzień"
              : t.perWeek || "/tydzień";

          const remaining = ins.nextPaymentAt - Date.now();
          const daysLeft = Math.floor(remaining / (24 * 60 * 60 * 1000));
          const hoursLeft = Math.floor(
            (remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000)
          );
          const minsLeft = Math.floor(
            (remaining % (60 * 60 * 1000)) / (60 * 1000)
          );

          // Oblicz zwrot (10% jeśli użyto 3+ razy)
          const refund =
            ins.benefitCount >= 3 ? Math.floor(ins.totalPaid * 0.1) : 0;

          document.getElementById("insuranceDetailsContent").innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:3em;">${pkg.icon}</div>
                    <div style="font-weight:bold;font-size:1.3em;">${getInsuranceName(
                      pkg
                    )}</div>
                    <div style="color:#aaa;">${getInsuranceDesc(pkg)} ${
            t.every || "co"
          } ${pkg.interval} min</div>
                </div>
                
                <div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:15px;margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${t.price || "Cena"}:</span>
                        <span style="color:#ff6b35;font-weight:bold;">${ins.price.toLocaleString()} ${getCurrency()} ${periodText}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${t.totalPaid || "Zapłacono łącznie"}:</span>
                        <span>${ins.totalPaid.toLocaleString()} ${getCurrency()}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${
                          t.benefitsReceived || "Otrzymane korzyści"
                        }:</span>
                        <span>${ins.benefitCount}x</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span>${t.nextPayment || "Następna płatność"}:</span>
                        <span>${
                          daysLeft > 0 ? daysLeft + "d " : ""
                        }${hoursLeft}h ${minsLeft}m</span>
                    </div>
                </div>
                
                <div class="tax-toggle" style="margin-bottom:15px;">
                    <div>
                        <strong>${t.autoPay || "Automatyczne płacenie"}</strong>
                    </div>
                    <div class="toggle-switch ${
                      ins.autoPay ? "active" : ""
                    }" onclick="toggleInsuranceAutoPay(${index})"></div>
                </div>
                
                <button onclick="cancelInsurance(${index})" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-size:1em;cursor:pointer;">
                    ❌ ${t.cancelInsurance || "Zrezygnuj"} ${
            refund > 0
              ? `(${
                  t.refund || "zwrot"
                }: ${refund.toLocaleString()} ${getCurrency()})`
              : `(${t.noRefund || "brak zwrotu"})`
          }
                </button>
            `;

          openModal("insuranceDetails");
        }

        function toggleInsuranceAutoPay(index) {
          if (index < 0 || index >= activeInsurances.length) return;
          activeInsurances[index].autoPay = !activeInsurances[index].autoPay;
          saveState();
          showInsuranceDetails(index);
          updateCardDisplay();
        }

        function cancelInsurance(index) {
          if (index < 0 || index >= activeInsurances.length) return;

          const ins = activeInsurances[index];
          const pkg = insurancePackages.find((p) => p.id === ins.packageId);
          const t = translations[currentLang] || translations.en;

          // Oblicz zwrot
          const refund =
            ins.benefitCount >= 3 ? Math.floor(ins.totalPaid * 0.1) : 0;

          const confirmMsg =
            refund > 0
              ? `${
                  t.confirmCancelWithRefund || "Zrezygnować? Zwrot"
                }: ${refund.toLocaleString()} ${getCurrency()}`
              : t.confirmCancelNoRefund ||
                "Zrezygnować? Brak zwrotu (użyto mniej niż 3 razy)";

          if (confirm(confirmMsg)) {
            if (refund > 0) {
              money += refund;
            }
            activeInsurances.splice(index, 1);
            saveState();
            updateAllDisplays();
            closeModal("insuranceDetails");
            renderInsuranceList();
          }
        }

        function checkInsuranceBenefits() {
          const now = Date.now();
          let needsSave = false;

          for (let i = activeInsurances.length - 1; i >= 0; i--) {
            const ins = activeInsurances[i];
            const pkg = insurancePackages.find((p) => p.id === ins.packageId);
            if (!pkg) continue;

            // Sprawdź czy czas na płatność
            if (now >= ins.nextPaymentAt) {
              let duration;
              if (ins.period === "hour") duration = 60 * 60 * 1000;
              else if (ins.period === "day") duration = 24 * 60 * 60 * 1000;
              else duration = 7 * 24 * 60 * 60 * 1000;

              if (ins.autoPay) {
                // Auto-pay: płać lub idź na dług, ale ZAWSZE kontynuuj ubezpieczenie
                if (money >= ins.price) {
                  money -= ins.price;
                  ins.totalPaid += ins.price;
                } else {
                  // Nie ma kasy - płać ile możesz, reszta na dług
                  const paid = money;
                  money = 0;
                  ins.totalPaid += paid;
                  addDebt(ins.price - paid);
                }
                ins.nextPaymentAt = now + duration;
                needsSave = true;
              } else {
                // Nie auto-pay = dług i usuń ubezpieczenie
                addDebt(ins.price);
                activeInsurances.splice(i, 1);
                needsSave = true;
                continue;
              }
            }

            // Przyznaj korzyści
            const intervalMs = pkg.interval * 60 * 1000;
            if (now - ins.lastBenefitAt >= intervalMs) {
              if (pkg.benefits.hp > 0)
                health = Math.min(MAX_HEALTH, health + pkg.benefits.hp);
              if (pkg.benefits.kcal > 0)
                food = Math.min(MAX_FOOD, food + pkg.benefits.kcal);
              if (pkg.benefits.ml > 0)
                water = Math.min(MAX_WATER, water + pkg.benefits.ml);

              ins.lastBenefitAt = now;
              ins.benefitCount++;
              needsSave = true;
            }
          }

          if (needsSave) {
            saveState();
            updateAllDisplays();
          }
        }

        function startInsuranceTimer() {
          setInterval(checkInsuranceBenefits, 60 * 1000);
        }

        // ==================== WYŚWIETLANIE ====================
        function updateAllDisplays() {
          updateMoneyDisplay();
          updateCardDisplay();
          updateDebtDisplay();
          updateTaxDisplay();
          updateStatusBars();
        }

        function updateStatusBars() {
          // Zdrowie
          const healthPercent = (health / MAX_HEALTH) * 100;
          document.getElementById("healthBar").style.width =
            healthPercent + "%";
          document.getElementById(
            "healthValue"
          ).textContent = `${health}/${MAX_HEALTH}`;

          // Jedzenie
          const foodPercent = (food / MAX_FOOD) * 100;
          document.getElementById("foodBar").style.width = foodPercent + "%";
          document.getElementById(
            "foodValue"
          ).textContent = `${food}/${MAX_FOOD} kcal`;

          // Picie
          const waterPercent = (water / MAX_WATER) * 100;
          document.getElementById("waterBar").style.width = waterPercent + "%";
          document.getElementById(
            "waterValue"
          ).textContent = `${water}/${MAX_WATER} ml`;
        }

        function updateInventoryDisplay() {
          document.getElementById(
            "invHealth"
          ).textContent = `${health}/${MAX_HEALTH} HP`;
          document.getElementById(
            "invFood"
          ).textContent = `${food}/${MAX_FOOD} kcal`;
          document.getElementById(
            "invWater"
          ).textContent = `${water}/${MAX_WATER} ml`;
        }

        function showShopTab(tab) {
          currentShopTab = tab;
          document
            .querySelectorAll("#modalShop .inv-tab")
            .forEach((t) => t.classList.remove("active"));
          event.target.classList.add("active");
          renderShopItems();
        }

        // SKLEP - kupowanie do plecaka
        function renderShopItems() {
          const grid = document.getElementById("shopGrid");
          const items = currentShopTab === "food" ? foodItems : drinkItems;

          grid.innerHTML = items
            .map(
              (item) => `
                <div class="shop-item" onclick="buyToBackpack('${
                  item.id
                }', '${currentShopTab}')">
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${getItemName(item)}</div>
                    <div class="item-stats">
                        ${
                          item.kcal > 0
                            ? `<span class="positive">+${item.kcal} kcal</span><br>`
                            : ""
                        }
                        ${
                          item.ml > 0
                            ? `<span class="positive">+${item.ml} ml</span><br>`
                            : ""
                        }
                        ${
                          item.hp > 0
                            ? `<span class="positive">+${item.hp} HP</span>`
                            : ""
                        }
                        ${
                          item.hp < 0
                            ? `<span class="negative">${item.hp} HP</span>`
                            : ""
                        }
                    </div>
                    <div class="item-price">${item.price} zł</div>
                </div>
            `
            )
            .join("");
        }

        function buyToBackpack(itemId, type) {
          const items = type === "food" ? foodItems : drinkItems;
          const item = items.find((i) => i.id === itemId);
          if (!item) return;

          if (money < item.price) {
            alert(
              translations[currentLang].notEnoughMoney ||
                "Nie masz wystarczająco pieniędzy!"
            );
            return;
          }

          // Kup i dodaj do plecaka
          money -= item.price;
          backpack.push({ ...item, type: type });

          playSound("buy");
          saveState();
          updateAllDisplays();

          alert(`${item.icon} ${getItemName(item)} → 🎒`);
        }

        // EKWIPUNEK - zawartość plecaka
        function renderBackpack() {
          const grid = document.getElementById("backpackGrid");
          const empty = document.getElementById("emptyBackpack");

          if (backpack.length === 0) {
            grid.style.display = "none";
            empty.style.display = "block";
            return;
          }

          grid.style.display = "grid";
          empty.style.display = "none";

          // Grupuj przedmioty
          const grouped = {};
          backpack.forEach((item, index) => {
            if (!grouped[item.id]) {
              grouped[item.id] = { ...item, count: 0, indices: [] };
            }
            grouped[item.id].count++;
            grouped[item.id].indices.push(index);
          });

          grid.innerHTML = Object.values(grouped)
            .map((item) => {
              // Sprawdź czy można użyć
              const foodPercent = (food / MAX_FOOD) * 100;
              const waterPercent = (water / MAX_WATER) * 100;
              const canUse =
                (item.kcal > 0 && foodPercent < 98) ||
                (item.ml > 0 && waterPercent < 98) ||
                (item.kcal === 0 && item.ml === 0);
              const blocked = !canUse;

              return `
                <div class="shop-item ${blocked ? "blocked" : ""}" onclick="${
                blocked ? "" : `useItem('${item.id}')`
              }" style="${blocked ? "opacity:0.5;cursor:not-allowed;" : ""}">
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${getItemName(item)} ${
                item.count > 1
                  ? `<span style="color:#ff6b35;">x${item.count}</span>`
                  : ""
              }</div>
                    <div class="item-stats">
                        ${
                          item.kcal > 0
                            ? `<span class="positive">+${item.kcal} kcal</span><br>`
                            : ""
                        }
                        ${
                          item.ml > 0
                            ? `<span class="positive">+${item.ml} ml</span><br>`
                            : ""
                        }
                        ${
                          item.hp > 0
                            ? `<span class="positive">+${item.hp} HP</span>`
                            : ""
                        }
                        ${
                          item.hp < 0
                            ? `<span class="negative">${item.hp} HP</span>`
                            : ""
                        }
                    </div>
                    ${
                      blocked
                        ? `<div style="color:#f87171;font-size:0.8em;margin-top:5px;">⛔ ${
                            translations[currentLang].tooFull || "Jesteś pełny!"
                          }</div>`
                        : `<div style="color:#4ade80;font-size:0.85em;margin-top:5px;">▶ ${
                            translations[currentLang].useItem || "Użyj"
                          }</div>`
                    }
                </div>
            `;
            })
            .join("");
        }

        function useItem(itemId) {
          const index = backpack.findIndex((i) => i.id === itemId);
          if (index === -1) return;

          const item = backpack[index];

          // Sprawdź czy można użyć (pasek < 98%)
          const foodPercent = (food / MAX_FOOD) * 100;
          const waterPercent = (water / MAX_WATER) * 100;

          if (item.kcal > 0 && foodPercent >= 98) {
            alert(
              translations[currentLang].foodFull || "Nie możesz więcej jeść!"
            );
            return;
          }
          if (item.ml > 0 && waterPercent >= 98) {
            alert(
              translations[currentLang].waterFull || "Nie możesz więcej pić!"
            );
            return;
          }

          // Użyj przedmiotu
          food = Math.min(food + item.kcal, MAX_FOOD);
          water = Math.min(water + item.ml, MAX_WATER);
          health = Math.max(0, Math.min(health + item.hp, MAX_HEALTH));

          // Dźwięk
          if (item.ml > 0) {
            playSound("drink");
          } else {
            playSound("eat");
          }

          // Usuń z plecaka
          backpack.splice(index, 1);

          saveState();
          updateAllDisplays();
          updateInventoryDisplay();
          renderBackpack();

          let effectText = "";
          if (item.kcal > 0) effectText += `+${item.kcal} kcal `;
          if (item.ml > 0) effectText += `+${item.ml} ml `;
          if (item.hp > 0) effectText += `+${item.hp} HP`;
          if (item.hp < 0) effectText += `${item.hp} HP`;

          alert(`${item.icon} ${getItemName(item)}\n${effectText}`);
        }

        function formatCurrency(amount) {
          const symbol = currentLang === "en" ? "$" : "zł";
          return amount.toLocaleString() + " " + symbol;
        }

        function getCurrency() {
          return currentLang === "en" ? "$" : "zł";
        }

        function updateMoneyDisplay() {
          const display = document.getElementById("moneyDisplay");
          display.textContent = formatCurrency(money);
          display.classList.toggle("low", money < 5000);
        }

        function updateCardDisplay() {
          document.getElementById("cardCode").textContent = cardCode;
          document.getElementById("cardBalance").textContent =
            formatCurrency(money);
          document.getElementById("limitValue").textContent =
            formatCurrency(limit);
          document.getElementById("spentValue").textContent =
            formatCurrency(spent);
          document.getElementById("remainingValue").textContent =
            formatCurrency(limit - spent);
          document.getElementById("limitBar").style.width =
            Math.min((spent / limit) * 100, 100) + "%";

          // Lista ubezpieczeń na karcie
          const listEl = document.getElementById("insuranceAutoPayList");
          const noInsEl = document.getElementById("noInsurancesCard");
          const t = translations[currentLang] || translations.en;

          if (activeInsurances.length > 0) {
            noInsEl.style.display = "none";
            listEl.innerHTML = activeInsurances
              .map((ins, idx) => {
                const pkg = insurancePackages.find(
                  (p) => p.id === ins.packageId
                );
                if (!pkg) return "";

                const periodText =
                  ins.period === "day"
                    ? t.perDay || "/d"
                    : ins.period === "week"
                    ? t.perWeek || "/tyg"
                    : t.perMonth || "/mies";

                return `
                        <div class="tax-toggle" style="margin-bottom:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px;">
                            <div>
                                <strong style="font-size:0.9em;">${
                                  pkg.icon
                                } ${getInsuranceName(pkg)}</strong>
                                <p style="font-size:0.7em;color:#888;margin:0;">${
                                  ins.price
                                } zł ${periodText}</p>
                            </div>
                            <div class="toggle-switch ${
                              ins.autoPay ? "active" : ""
                            }" onclick="toggleInsuranceAutoPayFromCard(${idx})"></div>
                        </div>
                    `;
              })
              .join("");
          } else {
            noInsEl.style.display = "block";
            listEl.innerHTML = "";
          }
        }

        function toggleInsuranceAutoPayFromCard(index) {
          if (index < 0 || index >= activeInsurances.length) return;
          activeInsurances[index].autoPay = !activeInsurances[index].autoPay;
          saveState();
          updateCardDisplay();
        }

        function updateDebtDisplay() {
          const debtDisplay = document.getElementById("debtDisplay");

          if (debt > 0) {
            debtDisplay.classList.add("active");
            document.getElementById("debtAmount").textContent =
              debt.toLocaleString() + " " + getCurrency();

            if (debtDeadline) {
              const daysLeft = Math.ceil(
                (new Date(debtDeadline) - new Date()) / (1000 * 60 * 60 * 24)
              );
              document.getElementById(
                "debtDeadline"
              ).textContent = `${daysLeft} ${
                translations[currentLang].daysLeft || "dni do spłaty"
              }`;
            }

            document.getElementById("currentDebt").textContent =
              debt.toLocaleString() + " " + getCurrency();
            document.getElementById("payDebtBtn").style.display = "block";
          } else {
            debtDisplay.classList.remove("active");
            document.getElementById("currentDebt").textContent =
              "0 " + getCurrency();
            document.getElementById("payDebtBtn").style.display = "none";
          }
        }

        function updateTaxDisplay() {
          const totalTaxEl = document.getElementById("totalTaxPaid");
          if (totalTaxEl) {
            totalTaxEl.textContent =
              totalTaxPaid.toLocaleString() + " " + getCurrency();
          }
        }

        // ==================== MODALS ====================
        function openModal(type) {
          const modal = document.getElementById(
            "modal" + type.charAt(0).toUpperCase() + type.slice(1)
          );
          if (!modal) {
            console.warn("Modal not found:", type);
            return;
          }
          modal.classList.add("active");

          if (type === "card") updateCardDisplay();
          if (type === "tax") {
            updateTaxDisplay();
            updateDebtDisplay();
          }
          if (type === "pin") {
            currentPin = "";
            updatePinDisplay();
          }
          if (type === "sell") {
            renderGarage();
          }
          if (type === "buy") {
            carSearchQuery = "";
            document.getElementById("carSearchInput").value = "";
            renderCarBuyList();
          }
          if (type === "earn") initEarnInputs();
          if (type === "repair") {
            selectedRepairCarIndex = null;
            renderRepairCarList();
          }
          if (type === "shop") {
            currentShopTab = "food";
            renderShopItems();
            document
              .querySelectorAll("#modalShop .inv-tab")
              .forEach((t, i) => t.classList.toggle("active", i === 0));
          }
          if (type === "inventory") {
            updateInventoryDisplay();
            renderBackpack();
          }
          if (type === "insurance") {
            renderInsuranceList();
          }
          if (type === "saves") {
            renderSavesList();
          }
          if (type === "vouchers") {
            renderVouchersList();
          }
          if (type === "garage") {
            renderGarageModal();
          }
          if (type === "work") {
            renderJobsList();
          }
          if (type === "onlineAccount") {
            renderOnlineAccount();
          }
          if (type === "notifications") {
            renderWorkerNotifications();
          }
        }

        function closeModal(type) {
          const modal = document.getElementById(
            "modal" + type.charAt(0).toUpperCase() + type.slice(1)
          );
          if (modal) {
            modal.classList.remove("active");
          }
        }

        function resetUploadForm(type) {
          const fileEl = document.getElementById(type + "File");
          const previewEl = document.getElementById(type + "Preview");
          const uploadEl = document.getElementById(type + "Upload");
          const responseEl = document.getElementById(type + "Response");
          const btnEl = document.getElementById(type + "Btn");

          if (fileEl) fileEl.value = "";
          if (previewEl) previewEl.style.display = "none";
          if (uploadEl) uploadEl.style.display = "block";
          if (responseEl) responseEl.classList.remove("active");
          if (btnEl) btnEl.classList.remove("active");
        }

        // ==================== PIN ====================
        function updatePinDisplay() {
          for (let i = 1; i <= 6; i++) {
            const digit = document.getElementById("pin" + i);
            digit.textContent = currentPin.length >= i ? "●" : "";
            digit.classList.toggle("filled", currentPin.length >= i);
          }
        }

        function addPinDigit(d) {
          if (currentPin.length < 6) {
            currentPin += d;
            updatePinDisplay();
          }
        }
        function deletePinDigit() {
          currentPin = currentPin.slice(0, -1);
          updatePinDisplay();
        }

        function confirmPin() {
          if (currentPin === pin) {
            if (pendingAction === "resetLimit") {
              spent = 0;
              saveState();
              updateCardDisplay();
              alert("✅");
            } else if (pendingAction === "setLimit") {
              const newLimit = parseInt(
                document.getElementById("newLimitInput").value
              );
              if (newLimit >= 100) {
                limit = newLimit;
                saveState();
                updateCardDisplay();
                alert("✅");
              }
            } else if (pendingAction === "repair") {
              money -= REPAIR_COST;
              spent += REPAIR_COST;
              saveState();
              updateAllDisplays();
              alert(`🔧 -5,000 ${getCurrency()}`);
              closeModal("repair");
            } else if (pendingAction === "buy") {
              money -= currentBuyPrice;
              spent += currentBuyPrice;
              saveState();
              updateAllDisplays();
              alert(`🚙 -${currentBuyPrice.toLocaleString()} ${getCurrency()}`);
              closeModal("buy");
            } else if (pendingAction === "buyAuction" && pendingAuctionId) {
              completePurchaseWithPin(pendingAuctionId);
            }
            pendingAction = null;
            closeModal("pin");
          } else {
            alert("❌ PIN");
            currentPin = "";
            updatePinDisplay();
          }
        }

        function setNewLimit() {
          const newLimit = parseInt(
            document.getElementById("newLimitInput").value
          );
          if (newLimit >= 100) {
            pendingAction = "setLimit";
            closeModal("setLimit");
            openModal("pin");
          } else {
            alert("❌ Min. 100 zł");
          }
        }

        // ==================== JĘZYKI ====================
        function generateLangGrid() {
          const grid = document.getElementById("langGrid");
          grid.innerHTML = "";
          Object.entries(languages).forEach(([code, lang]) => {
            const option = document.createElement("div");
            option.className =
              "lang-option" + (code === currentLang ? " selected" : "");
            option.innerHTML = `${lang.flag} ${lang.name}`;
            option.onclick = () => {
              currentLang = code;
              saveState();
              applyLanguage();
              updateAllDisplays();
              generateLangGrid();
              closeModal("language");
            };
            grid.appendChild(option);
          });
        }

        function applyLanguage() {
          const trans = translations[currentLang] || translations.en;
          document.querySelectorAll("[data-translate]").forEach((el) => {
            if (trans[el.getAttribute("data-translate")]) {
              el.textContent = trans[el.getAttribute("data-translate")];
            }
          });
          // Aktualizuj też ekran blokady mobilnej
          if (typeof updateMobileBlockLanguage === "function") {
            updateMobileBlockLanguage();
          }
        }

        // ==================== DRAG & DROP ====================
        ["repair", "sell"].forEach((type) => {
          const area = document.getElementById(type + "Upload");
          if (!area) return;
          area.addEventListener("dragover", (e) => {
            e.preventDefault();
            area.classList.add("dragover");
          });
          area.addEventListener("dragleave", () =>
            area.classList.remove("dragover")
          );
          area.addEventListener("drop", (e) => {
            e.preventDefault();
            area.classList.remove("dragover");
            const file = e.dataTransfer.files[0];
            if (file?.type.startsWith("image/")) {
              const input = document.getElementById(type + "File");
              const dt = new DataTransfer();
              dt.items.add(file);
              input.files = dt.files;
              if (type === "repair") analyzeRepairImage(input);
              else if (type === "sell") startSellQR(input);
            }
          });
        });

        // Background tax
        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) {
            checkMissedTaxes();
            updateAllDisplays();
            processAutomaticBusinessDays();
          }
        });
        window.addEventListener("beforeunload", saveState);

        // ==================== SYSTEM FIRM ====================

        // Kategorie firm - z tłumaczeniami
        function getBusinessCategories() {
          const isEn = currentLang === "en";
          return {
            gastronomy: {
              name: isEn ? "🍔 Gastronomy" : "🍔 Gastronomia",
              types: [
                {
                  id: "fastfood",
                  name: "Fast Food",
                  icon: "🍟",
                  startCost: 25000,
                  clientsPerDay: 150,
                  avgIncome: 35,
                },
                {
                  id: "restaurant",
                  name: isEn ? "Restaurant" : "Restauracja",
                  icon: "🍽️",
                  startCost: 75000,
                  clientsPerDay: 60,
                  avgIncome: 120,
                },
                {
                  id: "cafe",
                  name: isEn ? "Cafe" : "Kawiarnia",
                  icon: "☕",
                  startCost: 35000,
                  clientsPerDay: 80,
                  avgIncome: 25,
                },
                {
                  id: "pizzeria",
                  name: "Pizzeria",
                  icon: "🍕",
                  startCost: 45000,
                  clientsPerDay: 70,
                  avgIncome: 55,
                },
                {
                  id: "bar",
                  name: "Bar",
                  icon: "🍺",
                  startCost: 55000,
                  clientsPerDay: 100,
                  avgIncome: 40,
                },
              ],
            },
            retail: {
              name: isEn ? "🛒 Retail" : "🛒 Handel",
              types: [
                {
                  id: "grocery",
                  name: isEn ? "Grocery Store" : "Sklep spożywczy",
                  icon: "🛒",
                  startCost: 40000,
                  clientsPerDay: 200,
                  avgIncome: 45,
                },
                {
                  id: "electronics",
                  name: isEn ? "Electronics Store" : "Sklep elektroniczny",
                  icon: "📱",
                  startCost: 100000,
                  clientsPerDay: 40,
                  avgIncome: 350,
                },
                {
                  id: "clothes",
                  name: isEn ? "Clothing Boutique" : "Butik odzieżowy",
                  icon: "👕",
                  startCost: 60000,
                  clientsPerDay: 50,
                  avgIncome: 150,
                },
                {
                  id: "autoparts",
                  name: isEn ? "Auto Parts Store" : "Sklep z częściami",
                  icon: "🔧",
                  startCost: 80000,
                  clientsPerDay: 35,
                  avgIncome: 200,
                },
                {
                  id: "pharmacy",
                  name: isEn ? "Pharmacy" : "Apteka",
                  icon: "💊",
                  startCost: 120000,
                  clientsPerDay: 120,
                  avgIncome: 65,
                },
              ],
            },
            services: {
              name: isEn ? "🔧 Services" : "🔧 Usługi",
              types: [
                {
                  id: "carwash",
                  name: isEn ? "Car Wash" : "Myjnia samochodowa",
                  icon: "🚿",
                  startCost: 30000,
                  clientsPerDay: 45,
                  avgIncome: 50,
                },
                {
                  id: "mechanic",
                  name: isEn ? "Auto Workshop" : "Warsztat samochodowy",
                  icon: "🔧",
                  startCost: 70000,
                  clientsPerDay: 12,
                  avgIncome: 450,
                },
                {
                  id: "hairdresser",
                  name: isEn ? "Hair Salon" : "Salon fryzjerski",
                  icon: "💇",
                  startCost: 25000,
                  clientsPerDay: 25,
                  avgIncome: 80,
                },
                {
                  id: "gym",
                  name: isEn ? "Gym" : "Siłownia",
                  icon: "🏋️",
                  startCost: 90000,
                  clientsPerDay: 150,
                  avgIncome: 15,
                },
                {
                  id: "hotel",
                  name: "Hotel",
                  icon: "🏨",
                  startCost: 200000,
                  clientsPerDay: 50,
                  avgIncome: 250,
                },
              ],
            },
            finance: {
              name: isEn ? "💰 Finance" : "💰 Finanse",
              types: [
                {
                  id: "bank",
                  name: isEn ? "Bank" : "Bank",
                  icon: "🏦",
                  startCost: 500000,
                  clientsPerDay: 200,
                  avgIncome: 50,
                  special: "bank",
                },
                {
                  id: "insurance",
                  name: isEn ? "Insurance Company" : "Firma ubezpieczeniowa",
                  icon: "🛡️",
                  startCost: 300000,
                  clientsPerDay: 30,
                  avgIncome: 400,
                  special: "insurance",
                },
                {
                  id: "exchange",
                  name: isEn ? "Currency Exchange" : "Kantor",
                  icon: "💱",
                  startCost: 150000,
                  clientsPerDay: 80,
                  avgIncome: 25,
                },
                {
                  id: "loans",
                  name: isEn ? "Loan Company" : "Firma pożyczkowa",
                  icon: "💳",
                  startCost: 250000,
                  clientsPerDay: 25,
                  avgIncome: 300,
                  special: "loans",
                },
              ],
            },
            transport: {
              name: "🚚 Transport",
              types: [
                {
                  id: "taxi",
                  name: isEn ? "Taxi Company" : "Firma taksówkowa",
                  icon: "🚕",
                  startCost: 50000,
                  clientsPerDay: 80,
                  avgIncome: 45,
                },
                {
                  id: "delivery",
                  name: isEn ? "Delivery Company" : "Firma kurierska",
                  icon: "📦",
                  startCost: 80000,
                  clientsPerDay: 150,
                  avgIncome: 25,
                },
                {
                  id: "trucking",
                  name: isEn ? "Trucking Company" : "Firma transportowa",
                  icon: "🚛",
                  startCost: 200000,
                  clientsPerDay: 15,
                  avgIncome: 800,
                },
                {
                  id: "rental",
                  name: isEn ? "Car Rental" : "Wypożyczalnia aut",
                  icon: "🚗",
                  startCost: 150000,
                  clientsPerDay: 20,
                  avgIncome: 200,
                },
              ],
            },
            tech: {
              name: isEn ? "💻 Technology" : "💻 Technologia",
              types: [
                {
                  id: "software",
                  name: "Software House",
                  icon: "💻",
                  startCost: 100000,
                  clientsPerDay: 5,
                  avgIncome: 3000,
                },
                {
                  id: "itservice",
                  name: isEn ? "IT Service" : "Serwis IT",
                  icon: "🖥️",
                  startCost: 40000,
                  clientsPerDay: 20,
                  avgIncome: 250,
                },
                {
                  id: "webagency",
                  name: isEn ? "Web Agency" : "Agencja webowa",
                  icon: "🌐",
                  startCost: 60000,
                  clientsPerDay: 8,
                  avgIncome: 600,
                },
                {
                  id: "gaming",
                  name: isEn ? "Game Studio" : "Studio gier",
                  icon: "🎮",
                  startCost: 150000,
                  clientsPerDay: 3,
                  avgIncome: 5000,
                },
              ],
            },
            entertainment: {
              name: isEn ? "🎬 Entertainment" : "🎬 Rozrywka",
              types: [
                {
                  id: "cinema",
                  name: isEn ? "Cinema" : "Kino",
                  icon: "🎬",
                  startCost: 300000,
                  clientsPerDay: 500,
                  avgIncome: 35,
                },
                {
                  id: "club",
                  name: isEn ? "Night Club" : "Klub nocny",
                  icon: "🎵",
                  startCost: 200000,
                  clientsPerDay: 300,
                  avgIncome: 50,
                },
                {
                  id: "arcade",
                  name: isEn ? "Arcade" : "Salon gier",
                  icon: "🕹️",
                  startCost: 80000,
                  clientsPerDay: 100,
                  avgIncome: 30,
                },
                {
                  id: "escape",
                  name: "Escape Room",
                  icon: "🔐",
                  startCost: 50000,
                  clientsPerDay: 20,
                  avgIncome: 120,
                },
              ],
            },
            construction: {
              name: isEn ? "🏗️ Construction" : "🏗️ Budownictwo",
              types: [
                {
                  id: "construction",
                  name: isEn ? "Construction Company" : "Firma budowlana",
                  icon: "🏗️",
                  startCost: 250000,
                  clientsPerDay: 8,
                  avgIncome: 5000,
                },
                {
                  id: "renovation",
                  name: isEn ? "Renovation Company" : "Firma remontowa",
                  icon: "🔨",
                  startCost: 80000,
                  clientsPerDay: 15,
                  avgIncome: 800,
                },
                {
                  id: "architecture",
                  name: isEn ? "Architecture Office" : "Biuro architektoniczne",
                  icon: "📐",
                  startCost: 120000,
                  clientsPerDay: 6,
                  avgIncome: 2000,
                },
              ],
            },
          };
        }

        // Imiona pracowników
        const WORKER_NAMES = {
          male: [
            "Adam",
            "Piotr",
            "Marcin",
            "Tomasz",
            "Michał",
            "Krzysztof",
            "Jan",
            "Paweł",
            "Andrzej",
            "Marek",
            "Robert",
            "Kamil",
            "Łukasz",
            "Jakub",
            "Mateusz",
            "John",
            "Mike",
            "David",
            "James",
            "Robert",
          ],
          female: [
            "Anna",
            "Maria",
            "Katarzyna",
            "Magdalena",
            "Agnieszka",
            "Joanna",
            "Monika",
            "Ewa",
            "Aleksandra",
            "Natalia",
            "Karolina",
            "Patrycja",
            "Justyna",
            "Dominika",
            "Weronika",
            "Sarah",
            "Emily",
            "Jessica",
            "Ashley",
            "Amanda",
          ],
        };

        const WORKER_SURNAMES = [
          "Kowalski",
          "Nowak",
          "Wiśniewski",
          "Wójcik",
          "Kowalczyk",
          "Kamiński",
          "Lewandowski",
          "Zieliński",
          "Szymański",
          "Woźniak",
          "Smith",
          "Johnson",
          "Williams",
          "Brown",
          "Jones",
        ];

        // Typy osobowości pracowników z tłumaczeniami
        function getWorkerPersonalities() {
          const isEn = currentLang === "en";
          return [
            {
              id: "ambitious",
              name: isEn ? "Ambitious" : "Ambitny",
              salaryMod: 1.3,
              productivityMod: 1.4,
              qualityMod: 1.2,
              speedMod: 1.3,
              errorRate: 0.08,
              traits: isEn
                ? ["Wants promotion", "Works hard", "Demands more"]
                : ["Chce awansować", "Pracuje ciężko", "Wymaga więcej"],
            },
            {
              id: "lazy",
              name: isEn ? "Lazy" : "Leniwy",
              salaryMod: 0.8,
              productivityMod: 0.6,
              qualityMod: 0.8,
              speedMod: 0.6,
              errorRate: 0.25,
              traits: isEn
                ? ["Minimizes effort", "Cheap", "Slow"]
                : ["Minimalizuje wysiłek", "Tani", "Wolny"],
            },
            {
              id: "friendly",
              name: isEn ? "Friendly" : "Przyjazny",
              salaryMod: 1.0,
              productivityMod: 1.0,
              qualityMod: 1.1,
              speedMod: 1.0,
              errorRate: 0.1,
              traits: isEn
                ? ["Good atmosphere", "Likes clients", "Stable"]
                : ["Dobra atmosfera", "Lubi klientów", "Stabilny"],
            },
            {
              id: "perfectionist",
              name: isEn ? "Perfectionist" : "Perfekcjonista",
              salaryMod: 1.2,
              productivityMod: 1.3,
              qualityMod: 1.5,
              speedMod: 0.8,
              errorRate: 0.02,
              traits: isEn
                ? ["High quality", "Slower", "Precise"]
                : ["Wysoka jakość", "Wolniejszy", "Dokładny"],
            },
            {
              id: "experienced",
              name: isEn ? "Experienced" : "Doświadczony",
              salaryMod: 1.5,
              productivityMod: 1.5,
              qualityMod: 1.3,
              speedMod: 1.2,
              errorRate: 0.05,
              traits: isEn
                ? ["Very effective", "Expensive", "Reliable"]
                : ["Bardzo skuteczny", "Drogi", "Niezawodny"],
            },
            {
              id: "newbie",
              name: isEn ? "Newbie" : "Początkujący",
              salaryMod: 0.6,
              productivityMod: 0.7,
              qualityMod: 0.7,
              speedMod: 0.8,
              errorRate: 0.3,
              traits: isEn
                ? ["Cheap", "Learning", "Makes mistakes"]
                : ["Tani", "Uczy się", "Popełnia błędy"],
            },
          ];
        }

        // Pobierz przetłumaczoną osobowość po ID
        function getTranslatedPersonality(personalityId) {
          const personalities = getWorkerPersonalities();
          return (
            personalities.find((p) => p.id === personalityId) ||
            personalities[0]
          );
        }

        // Pobierz przetłumaczone stanowisko po ID
        function getTranslatedPosition(positionId) {
          const positions = getWorkerPositions();
          return positions[positionId] || positions.regular;
        }

        // Stanowiska z tłumaczeniami
        function getWorkerPositions() {
          const isEn = currentLang === "en";
          return {
            manager: {
              name: isEn ? "Manager" : "Kierownik",
              baseSalary: 800,
              required: true,
            },
            senior: {
              name: isEn ? "Senior Worker" : "Starszy pracownik",
              baseSalary: 500,
            },
            regular: { name: isEn ? "Worker" : "Pracownik", baseSalary: 350 },
            junior: {
              name: isEn ? "Junior Worker" : "Młodszy pracownik",
              baseSalary: 250,
            },
            intern: { name: isEn ? "Intern" : "Stażysta", baseSalary: 150 },
          };
        }

        // Generuj losowego pracownika z pełnym kontraktem
        function generateWorker(position = "regular") {
          const isMale = Math.random() > 0.5;
          const names = isMale ? WORKER_NAMES.male : WORKER_NAMES.female;
          const name = names[Math.floor(Math.random() * names.length)];
          let surname =
            WORKER_SURNAMES[Math.floor(Math.random() * WORKER_SURNAMES.length)];
          if (!isMale && surname.endsWith("ski"))
            surname = surname.slice(0, -1) + "a";
          if (!isMale && surname.endsWith("cki"))
            surname = surname.slice(0, -2) + "ka";

          const personalities = getWorkerPersonalities();
          const positions = getWorkerPositions();
          const personality =
            personalities[Math.floor(Math.random() * personalities.length)];
          const pos = positions[position];

          // === POPRZEDNIA PRACA ===
          const previousJobs = getPreviousJobs();
          const hasPreviousJob = Math.random() > 0.25; // 75% ma poprzednią pracę
          const previousJob = hasPreviousJob
            ? previousJobs[Math.floor(Math.random() * previousJobs.length)]
            : null;

          // === PREFEROWANA ROLA ===
          const roles = getWorkerRoles();
          // Niektóre role są bardziej prawdopodobne dla pewnych stanowisk
          let preferredRole;
          if (position === "manager") {
            preferredRole =
              Math.random() > 0.3
                ? "supervisor"
                : Math.random() > 0.5
                ? "marketing"
                : "pricing";
          } else if (position === "senior") {
            preferredRole =
              Math.random() > 0.5
                ? "service"
                : Math.random() > 0.5
                ? "marketing"
                : "pricing";
          } else {
            preferredRole = "service"; // Juniorzy i regularni głównie obsługa
            if (Math.random() > 0.8)
              preferredRole = Math.random() > 0.5 ? "marketing" : "pricing";
          }

          const roleInfo = roles[preferredRole];

          // Bazowa dniówka (tygodniówka / 7)
          const baseWeeklySalary = Math.floor(
            pos.baseSalary * personality.salaryMod * (0.9 + Math.random() * 0.3)
          );
          const expectedDailySalary = Math.floor(baseWeeklySalary / 7);
          const minDailySalary = Math.floor(expectedDailySalary * 0.7);
          const bonusPercent = Math.floor(5 + Math.random() * 20);

          // Losowe dodatkowe cechy wpływające na cenę
          const hasExperience = hasPreviousJob && Math.random() > 0.4; // Doświadczenie z poprzedniej pracy
          const hasReferences = hasPreviousJob && Math.random() > 0.3; // Referencje z poprzedniej
          const needsTraining =
            !hasPreviousJob ||
            personality.id === "newbie" ||
            Math.random() > 0.7;
          const isFlexible = Math.random() > 0.6;
          const wantsStability = Math.random() > 0.5;
          const expectsBonus = Math.random() > 0.4;

          // Modyfikatory ceny za cechy
          let priceModifier = 1.0;
          const priceReasons = [];

          if (hasExperience) {
            priceModifier += 0.15;
            priceReasons.push({ id: "experience", mod: "+15%" });
          }
          if (hasReferences) {
            priceModifier += 0.1;
            priceReasons.push({ id: "references", mod: "+10%" });
          }
          if (needsTraining) {
            priceModifier -= 0.2;
            priceReasons.push({ id: "training", mod: "-20%" });
          }
          if (isFlexible) {
            priceModifier -= 0.05;
            priceReasons.push({ id: "flexible", mod: "-5%" });
          }
          if (personality.id === "perfectionist") {
            priceReasons.push({ id: "perfectionist", mod: "+20%" });
          }
          if (personality.id === "experienced") {
            priceReasons.push({ id: "skilled", mod: "+50%" });
          }
          if (personality.id === "lazy") {
            priceReasons.push({ id: "lowEffort", mod: "-20%" });
          }
          if (personality.id === "newbie") {
            priceReasons.push({ id: "beginner", mod: "-40%" });
          }
          if (personality.id === "ambitious") {
            priceReasons.push({ id: "ambitious", mod: "+30%" });
          }

          // Role wymagające budżetu kosztują więcej
          if (roleInfo.needsBudget) {
            priceModifier += 0.1;
            priceReasons.push({ id: "specialRole", mod: "+10%" });
          }

          priceReasons.push({
            id: "position_" + position,
            mod: pos.baseSalary + " base",
          });

          // Finalna dniówka
          const finalDailySalary = Math.floor(
            expectedDailySalary * priceModifier
          );

          // Oczekiwany bonus za podpis
          const signingBonus = expectsBonus
            ? Math.floor(100 + Math.random() * 400)
            : 0;

          // Oczekiwane wyniki - REALISTYCZNE (zależne od roli)
          let expectedPerformance;
          if (preferredRole === "service") {
            const prodMod = personality.productivityMod || 1;
            expectedPerformance = Math.floor(10 + prodMod * 8); // 10-18 klientów
          } else {
            expectedPerformance = 0; // Role inne niż obsługa nie obsługują klientów
          }

          // Oczekiwany budżet (dla ról które go potrzebują)
          let expectedBudget = 0;
          if (roleInfo.needsBudget) {
            expectedBudget = Math.floor(500 + Math.random() * 2000); // 500-2500
          }

          return {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            name: `${name} ${surname}`,
            gender: isMale ? "male" : "female",
            position: position,
            positionName: pos.name,
            personality: personality,

            // === POPRZEDNIA PRACA ===
            previousJob: previousJob,

            // === ROLA ===
            preferredRole: preferredRole,
            assignedRole: null, // Ustala pracodawca

            // === BUDŻET ===
            expectedBudget: expectedBudget,
            assignedBudget: 0, // Ustala pracodawca
            budgetSpent: 0, // Ile wydał

            // Wynagrodzenie
            expectedDailySalary: finalDailySalary,
            minDailySalary: minDailySalary,
            currentDailySalary: null,
            bonusPercent: bonusPercent,

            // Stare pola dla kompatybilności
            expectedSalary: finalDailySalary * 7,
            minSalary: minDailySalary * 7,
            currentSalary: null,

            // Cechy dodatkowe
            hasExperience: hasExperience,
            hasReferences: hasReferences,
            needsTraining: needsTraining,
            isFlexible: isFlexible,
            wantsStability: wantsStability,

            // Powody ceny
            priceReasons: priceReasons,

            // Kontrakt
            signingBonus: signingBonus,
            expectedPerformance: expectedPerformance,
            contractType: null,
            canReduceSalary: false,

            // Status
            hired: false,
            productivity: personality.productivityMod,
            satisfaction: 100,
            daysWorked: 0,
            totalEarned: 0,
            dailyClientsServed: 0,
            performanceHistory: [],

            chatHistory: [],
            negotiationState: "initial",
          };
        }

        // Lista poprzednich prac
        function getPreviousJobs() {
          const isEn = currentLang === "en";
          return [
            {
              id: "retail",
              name: isEn ? "Retail store" : "Sklep detaliczny",
              years: Math.floor(1 + Math.random() * 5),
            },
            {
              id: "restaurant",
              name: isEn ? "Restaurant" : "Restauracja",
              years: Math.floor(1 + Math.random() * 4),
            },
            {
              id: "office",
              name: isEn ? "Office work" : "Praca biurowa",
              years: Math.floor(1 + Math.random() * 6),
            },
            {
              id: "factory",
              name: isEn ? "Factory" : "Fabryka",
              years: Math.floor(1 + Math.random() * 8),
            },
            {
              id: "hotel",
              name: isEn ? "Hotel" : "Hotel",
              years: Math.floor(1 + Math.random() * 4),
            },
            {
              id: "bank",
              name: isEn ? "Bank" : "Bank",
              years: Math.floor(1 + Math.random() * 5),
            },
            {
              id: "it",
              name: isEn ? "IT company" : "Firma IT",
              years: Math.floor(1 + Math.random() * 4),
            },
            {
              id: "logistics",
              name: isEn ? "Logistics" : "Logistyka",
              years: Math.floor(1 + Math.random() * 5),
            },
            {
              id: "sales",
              name: isEn ? "Sales" : "Sprzedaż",
              years: Math.floor(1 + Math.random() * 6),
            },
            {
              id: "customer_service",
              name: isEn ? "Customer service" : "Obsługa klienta",
              years: Math.floor(1 + Math.random() * 4),
            },
          ];
        }

        // Role pracowników
        function getWorkerRoles() {
          const isEn = currentLang === "en";
          return {
            service: {
              id: "service",
              name: isEn ? "Customer Service" : "Obsługa klientów",
              icon: "👷",
              description: isEn
                ? "Serves customers directly"
                : "Bezpośrednio obsługuje klientów",
              needsBudget: false,
              availableIn: "all", // wszystkie firmy
            },
            marketing: {
              id: "marketing",
              name: "Marketing",
              icon: "📢",
              description: isEn
                ? "Buys promotions automatically (10-15min research)"
                : "Automatycznie kupuje promocje (10-15min research)",
              needsBudget: true,
              availableIn: "all",
            },
            pricing: {
              id: "pricing",
              name: isEn ? "Price Control" : "Kontrola cen",
              icon: "💰",
              description: isEn
                ? "Adjusts prices based on reviews"
                : "Dostosowuje ceny na podstawie opinii",
              needsBudget: false,
              availableIn: ["shop", "restaurant", "entertainment"], // tylko firmy z cenami
            },
            cleaning: {
              id: "cleaning",
              name: isEn ? "Cleaning" : "Sprzątanie",
              icon: "🧹",
              description: isEn
                ? "Keeps business clean (dirty = bad reviews)"
                : "Utrzymuje czystość (brudno = złe opinie)",
              needsBudget: false,
              availableIn: "all",
            },
            supervisor: {
              id: "supervisor",
              name: isEn ? "Supervisor" : "Kierownik",
              icon: "👔",
              description: isEn
                ? "Manages other workers, improves efficiency"
                : "Zarządza pracownikami, poprawia efektywność",
              needsBudget: false,
              availableIn: "all",
            },
          };
        }

        // Sprawdź czy rola jest dostępna dla danej kategorii firmy
        function isRoleAvailableForBusiness(roleId, categoryId) {
          const roles = getWorkerRoles();
          const role = roles[roleId];
          if (!role) return false;
          if (role.availableIn === "all") return true;
          if (Array.isArray(role.availableIn)) {
            return role.availableIn.includes(categoryId);
          }
          return false;
        }

        // System promocji dla firmy
        function getPromotionOptions() {
          const isEn = currentLang === "en";
          return [
            {
              id: "flyers",
              name: isEn ? "Flyers" : "Ulotki",
              cost: 200,
              duration: 1, // dni
              clientBoost: 1.1, // +10% klientów
              icon: "📄",
            },
            {
              id: "social_media",
              name: isEn ? "Social Media Ads" : "Reklama w social media",
              cost: 500,
              duration: 3,
              clientBoost: 1.2,
              icon: "📱",
            },
            {
              id: "local_radio",
              name: isEn ? "Local Radio" : "Lokalne radio",
              cost: 1000,
              duration: 5,
              clientBoost: 1.3,
              icon: "📻",
            },
            {
              id: "billboard",
              name: isEn ? "Billboard" : "Billboard",
              cost: 2500,
              duration: 7,
              clientBoost: 1.4,
              icon: "🪧",
            },
            {
              id: "tv_ad",
              name: isEn ? "TV Advertisement" : "Reklama TV",
              cost: 5000,
              duration: 7,
              clientBoost: 1.6,
              icon: "📺",
            },
            {
              id: "influencer",
              name: isEn ? "Influencer Campaign" : "Kampania z influencerem",
              cost: 3000,
              duration: 5,
              clientBoost: 1.5,
              icon: "🌟",
            },
          ];
        }

        // Tłumaczenia powodów ceny
        function getPriceReasonText(reasonId) {
          const isEn = currentLang === "en";
          const reasons = {
            experience: isEn
              ? "Has work experience"
              : "Ma doświadczenie zawodowe",
            references: isEn ? "Has references" : "Ma referencje",
            training: isEn ? "Needs training" : "Wymaga przeszkolenia",
            flexible: isEn ? "Flexible hours" : "Elastyczne godziny",
            perfectionist: isEn
              ? "Perfectionist - high quality"
              : "Perfekcjonista - wysoka jakość",
            skilled: isEn ? "Highly skilled" : "Wysoko wykwalifikowany",
            lowEffort: isEn ? "Lower effort" : "Mniejszy wysiłek",
            beginner: isEn ? "Beginner - learning" : "Początkujący - uczy się",
            ambitious: isEn
              ? "Ambitious - high demands"
              : "Ambitny - duże wymagania",
            position_manager: isEn
              ? "Manager position"
              : "Stanowisko kierownika",
            position_senior: isEn
              ? "Senior position"
              : "Stanowisko starszego pracownika",
            position_regular: isEn
              ? "Regular position"
              : "Stanowisko pracownika",
            position_junior: isEn
              ? "Junior position"
              : "Stanowisko młodszego pracownika",
            position_intern: isEn ? "Intern position" : "Stanowisko stażysty",
          };
          return reasons[reasonId] || reasonId;
        }

        // Generuj klienta dla firmy
        function generateClient(businessType) {
          const isMale = Math.random() > 0.5;
          const names = isMale ? WORKER_NAMES.male : WORKER_NAMES.female;
          const name = names[Math.floor(Math.random() * names.length)];

          const moods = ["happy", "neutral", "impatient", "demanding"];
          const mood = moods[Math.floor(Math.random() * moods.length)];

          return {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            name: name,
            gender: isMale ? "male" : "female",
            mood: mood,
            chatHistory: [],
            resolved: false,
            spending: 0,
          };
        }

        // Stan czatu z botem
        let currentBusinessChat = {
          type: null, // "worker" lub "client"
          businessId: null,
          targetId: null,
          awaitingInput: null,
        };

        // ========== GŁÓWNE FUNKCJE FIRM ==========

        function getBusinesses() {
          const save = getCurrentSave();
          if (!save) return [];
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          if (!save[modeKey]) {
            save[modeKey] = {
              money: 1500,
              garage: [],
              spent: 0,
              debt: 0,
              debtDeadline: null,
              totalTaxPaid: 0,
              health: 100,
              food: 1000,
              water: 1000,
              backpack: [],
              activeInsurances: [],
              businesses: [],
              credits: [],
              workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
              vouchersToSend: [],
              receivedVouchers: [],
            };
          }
          if (!save[modeKey].businesses) save[modeKey].businesses = [];
          return save[modeKey].businesses;
        }

        function saveBusinesses(businesses) {
          const save = getCurrentSave();
          if (!save) return;
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          if (!save[modeKey]) save[modeKey] = {};
          save[modeKey].businesses = businesses;
          saveState();
        }

        function renderBusinessModal() {
          const content = document.getElementById("businessContent");
          const t = translations[currentLang] || translations.en;
          const businesses = getBusinesses();

          if (businesses.length === 0) {
            content.innerHTML = `
            <div style="text-align: center; padding: 30px;">
              <div style="font-size: 4em; margin-bottom: 15px;">🏢</div>
              <p style="color: #888; margin-bottom: 20px;">${t.noBusinesses}</p>
              <button onclick="showCreateBusiness()" style="padding: 15px 30px; background: linear-gradient(145deg, #f59e0b, #d97706); color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer;">
                🏗️ ${t.createBusiness}
              </button>
            </div>
          `;
            return;
          }

          let totalIncome = 0;
          let totalExpenses = 0;
          businesses.forEach((b) => {
            totalIncome += b.weeklyIncome || 0;
            totalExpenses += b.weeklyExpenses || 0;
          });

          content.innerHTML = `
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="color: #888;">${t.totalIncomeWeek}:</span>
              <span style="color: #4ade80; font-weight: bold;">+${totalIncome.toLocaleString()} ${getCurrency()}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #888;">${t.totalExpensesWeek}:</span>
              <span style="color: #ef4444; font-weight: bold;">-${totalExpenses.toLocaleString()} ${getCurrency()}</span>
            </div>
            <div style="border-top: 1px solid #333; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
              <span style="color: #888;">${t.netProfitWeek}:</span>
              <span style="color: ${
                totalIncome - totalExpenses >= 0 ? "#4ade80" : "#ef4444"
              }; font-weight: bold;">
                ${totalIncome - totalExpenses >= 0 ? "+" : ""}${(
            totalIncome - totalExpenses
          ).toLocaleString()} ${getCurrency()}
              </span>
            </div>
          </div>

          <div style="max-height: 300px; overflow-y: auto;">
            ${businesses
              .map(
                (b, i) => `
              <div onclick="showBusinessDetail(${i})" style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" 
                   onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1em; font-weight: bold;">${
                      b.icon
                    } ${b.name}</div>
                    <div style="color: #888; font-size: 0.85em;">${
                      b.typeName
                    }</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #4ade80;">+${(
                      b.weeklyIncome || 0
                    ).toLocaleString()}/${
                  currentLang === "en" ? "wk" : "tyg"
                }</div>
                    <div style="color: #888; font-size: 0.85em;">👥 ${
                      b.workers?.filter((w) => w.hired).length || 0
                    } ${t.workers}</div>
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>

          <button onclick="showCreateBusiness()" style="width: 100%; padding: 15px; background: linear-gradient(145deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; margin-top: 15px;">
            ➕ ${t.createNextBusiness}
          </button>
        `;
        }

        function showCreateBusiness() {
          closeModal("business");
          openModal("createBusiness");
          renderCreateBusinessStep1();
        }

        function renderCreateBusinessStep1() {
          const content = document.getElementById("createBusinessContent");
          const t = translations[currentLang] || translations.en;

          content.innerHTML = `
          <p style="color: #888; margin-bottom: 15px; text-align: center;">${
            t.selectCategory
          }:</p>
          <div style="max-height: 400px; overflow-y: auto;">
            ${Object.entries(getBusinessCategories())
              .map(
                ([catId, cat]) => `
              <div onclick="renderCreateBusinessStep2('${catId}')" style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                   onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                <div style="font-size: 1.1em; font-weight: bold;">${cat.name}</div>
                <div style="color: #888; font-size: 0.85em;">${cat.types.length} ${t.businessTypes}</div>
              </div>
            `
              )
              .join("")}
          </div>
          <button onclick="closeModal('createBusiness'); openModal('business');" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer;">
            ← ${t.back}
          </button>
        `;
        }

        function renderCreateBusinessStep2(categoryId) {
          const content = document.getElementById("createBusinessContent");
          const category = getBusinessCategories()[categoryId];
          const t = translations[currentLang] || translations.en;

          content.innerHTML = `
          <p style="color: #888; margin-bottom: 15px; text-align: center;">${
            category.name
          } - ${t.selectType}:</p>
          <div style="max-height: 400px; overflow-y: auto;">
            ${category.types
              .map(
                (type) => `
              <div onclick="renderCreateBusinessStep3('${categoryId}', '${
                  type.id
                }')" style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                   onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1em; font-weight: bold;">${
                      type.icon
                    } ${type.name}</div>
                    <div style="color: #888; font-size: 0.85em;">~${
                      type.clientsPerDay
                    } ${t.clientsPerDay}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #f59e0b; font-weight: bold;">${type.startCost.toLocaleString()} ${getCurrency()}</div>
                    <div style="color: #4ade80; font-size: 0.85em;">~${
                      type.avgIncome
                    } ${getCurrency()}/${
                  currentLang === "en" ? "client" : "klient"
                }</div>
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
          <button onclick="renderCreateBusinessStep1()" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer;">
            ← ${t.backToCategories}
          </button>
        `;
        }

        function renderCreateBusinessStep3(categoryId, typeId) {
          const content = document.getElementById("createBusinessContent");
          const category = getBusinessCategories()[categoryId];
          const type = category.types.find((tp) => tp.id === typeId);
          const t = translations[currentLang] || translations.en;

          const canAfford = money >= type.startCost;

          content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em;">${type.icon}</div>
            <div style="font-size: 1.3em; font-weight: bold; margin-top: 10px;">${
              type.name
            }</div>
          </div>

          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: #888;">${t.startCost}:</span>
              <span style="color: #f59e0b; font-weight: bold;">${type.startCost.toLocaleString()} ${getCurrency()}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: #888;">${t.clientsPerDay}:</span>
              <span>~${type.clientsPerDay}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #888;">${t.avgIncomeClient}:</span>
              <span style="color: #4ade80;">~${
                type.avgIncome
              } ${getCurrency()}</span>
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="color: #888; font-size: 0.9em;">${
              t.businessName
            }:</label>
            <input type="text" id="newBusinessName" placeholder="${
              type.name
            }" maxlength="30" 
                   style="width: 100%; padding: 12px; background: #1a1a2e; border: 2px solid #333; border-radius: 8px; color: white; margin-top: 5px; font-size: 1em;">
          </div>

          ${
            !canAfford
              ? `
            <div style="background: rgba(239,68,68,0.2); border: 1px solid #ef4444; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
              <span style="color: #ef4444;">❌ ${
                t.notEnoughMoneyBusiness
              }</span>
              <div style="color: #888; font-size: 0.85em; margin-top: 5px;">${
                t.youNeed
              }: ${type.startCost.toLocaleString()} ${getCurrency()}</div>
            </div>
          `
              : ""
          }

          <button onclick="createBusiness('${categoryId}', '${typeId}')" ${
            !canAfford ? "disabled" : ""
          } 
                  style="width: 100%; padding: 15px; background: ${
                    canAfford
                      ? "linear-gradient(145deg, #10b981, #059669)"
                      : "#333"
                  }; color: white; border: none; border-radius: 10px; font-size: 1em; cursor: ${
            canAfford ? "pointer" : "not-allowed"
          };">
            🏗️ ${
              t.createBusinessFor
            } ${type.startCost.toLocaleString()} ${getCurrency()}
          </button>

          <button onclick="renderCreateBusinessStep2('${categoryId}')" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer;">
            ← ${t.back}
          </button>
        `;
        }

        function createBusiness(categoryId, typeId) {
          const category = getBusinessCategories()[categoryId];
          const type = category.types.find((tp) => tp.id === typeId);
          const nameInput = document.getElementById("newBusinessName");
          const name = nameInput?.value.trim() || type.name;
          const t = translations[currentLang] || translations.en;

          if (money < type.startCost) {
            showToast("❌ " + t.notEnoughMoneyBusiness);
            return;
          }

          money -= type.startCost;

          // Generuj początkowych kandydatów na pracowników
          const candidates = [];
          candidates.push(generateWorker("manager")); // Zawsze jeden kierownik
          for (let i = 0; i < 3; i++) {
            candidates.push(generateWorker("regular"));
          }
          for (let i = 0; i < 2; i++) {
            candidates.push(generateWorker("junior"));
          }

          const newBusiness = {
            id: Date.now().toString(),
            name: name,
            categoryId: categoryId,
            typeId: typeId,
            typeName: type.name,
            icon: type.icon,
            startCost: type.startCost,
            clientsPerDay: type.clientsPerDay,
            avgIncome: type.avgIncome,
            special: type.special || null,
            createdAt: Date.now(),
            workers: candidates,
            clients: [],
            weeklyIncome: 0,
            weeklyExpenses: 0,
            totalIncome: 0,
            totalExpenses: 0,
            lastPaymentTime: Date.now(),
            reputation: 50, // 0-100
            insurances: [], // Dla firm ubezpieczeniowych
            companyBalance: 0, // Konto firmowe - 30% z pracy właściciela
            cleanliness: 100, // 0-100, spada z czasem
            priceModifier: 1.0, // mnożnik cen (0.5-2.0)
            lastCleanTime: Date.now(),
            marketingResearchEnd: null, // kiedy kończy się research promocji
            // Godziny otwarcia
            openHour: 8, // 8:00
            closeHour: 20, // 20:00
            is24h: type.special === "24h", // niektóre firmy działają 24/7
            // Dzisiejszy dzień
            todayClients: [], // klienci którzy przyszli dzisiaj
            todayIncome: 0,
            todayReviews: { positive: 0, negative: 0, neutral: 0 },
            lastBusinessDay: null, // data ostatniego dnia roboczego
            pendingDayReport: null, // oczekujący raport do wyświetlenia
          };

          const businesses = getBusinesses();
          businesses.push(newBusiness);
          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          closeModal("createBusiness");
          openModal("business");
          renderBusinessModal();
          showToast(`🏢 ${t.businessCreated}: ${name}!`);
        }

        function showBusinessDetail(index) {
          const businesses = getBusinesses();
          const business = businesses[index];
          if (!business) return;

          closeModal("business");
          openModal("businessDetail");
          renderBusinessDetail(index);
        }

        function renderBusinessDetail(index) {
          const content = document.getElementById("businessDetailContent");
          const businesses = getBusinesses();
          const business = businesses[index];
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          const hiredWorkers = business.workers.filter((w) => w.hired);
          const candidateWorkers = business.workers.filter((w) => !w.hired);
          const weeklyProfit =
            (business.weeklyIncome || 0) - (business.weeklyExpenses || 0);

          content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 2.5em;">${business.icon}</div>
            <h2 style="color: #ff6b35; margin-top: 10px;">${business.name}</h2>
            <div style="color: #888;">${business.typeName}</div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
            <div style="background: rgba(74,222,128,0.1); border: 1px solid #4ade80; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="color: #4ade80; font-size: 1.3em; font-weight: bold;">+${(
                business.weeklyIncome || 0
              ).toLocaleString()}</div>
              <div style="color: #888; font-size: 0.8em;">${
                isEn ? "income/week" : "przychód/tydzień"
              }</div>
            </div>
            <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="color: #ef4444; font-size: 1.3em; font-weight: bold;">-${(
                business.weeklyExpenses || 0
              ).toLocaleString()}</div>
              <div style="color: #888; font-size: 0.8em;">${
                isEn ? "expenses/week" : "wydatki/tydzień"
              }</div>
            </div>
          </div>

          <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>${t.netProfitWeek}:</span>
              <span style="color: ${
                weeklyProfit >= 0 ? "#4ade80" : "#ef4444"
              }; font-weight: bold; font-size: 1.2em;">
                ${
                  weeklyProfit >= 0 ? "+" : ""
                }${weeklyProfit.toLocaleString()} ${getCurrency()}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
              <span style="color: #888;">${t.reputation}:</span>
              <span>${"⭐".repeat(Math.floor(business.reputation / 20))} ${
            business.reputation
          }%</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
              <span style="color: #888;">🧹 ${
                isEn ? "Cleanliness" : "Czystość"
              }:</span>
              <span style="color: ${
                (business.cleanliness || 100) > 60
                  ? "#4ade80"
                  : (business.cleanliness || 100) > 30
                  ? "#f59e0b"
                  : "#ef4444"
              };">
                ${Math.round(business.cleanliness || 100)}%
                ${
                  (business.cleanliness || 100) < 40
                    ? isEn
                      ? "⚠️ Dirty!"
                      : "⚠️ Brudno!"
                    : ""
                }
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
              <span style="color: #888;">💰 ${
                isEn ? "Price level" : "Poziom cen"
              }:</span>
              <span style="color: ${
                (business.priceModifier || 1) > 1.2
                  ? "#ef4444"
                  : (business.priceModifier || 1) < 0.8
                  ? "#4ade80"
                  : "#f59e0b"
              };">
                ${Math.round((business.priceModifier || 1) * 100)}%
                ${
                  (business.priceModifier || 1) > 1.3
                    ? isEn
                      ? "📈 High"
                      : "📈 Wysokie"
                    : (business.priceModifier || 1) < 0.7
                    ? isEn
                      ? "📉 Low"
                      : "📉 Niskie"
                    : ""
                }
              </span>
            </div>
            ${
              hiredWorkers.length > 0
                ? (() => {
                    const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
                    const nextPay =
                      (business.lastPaymentTime || Date.now()) + WEEK_MS;
                    const remaining = nextPay - Date.now();
                    let timeStr = isEn ? "Now!" : "Teraz!";
                    if (remaining > 0) {
                      const days = Math.floor(
                        remaining / (24 * 60 * 60 * 1000)
                      );
                      const hours = Math.floor(
                        (remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000)
                      );
                      timeStr =
                        days > 0 ? days + "d " + hours + "h" : hours + "h";
                    }
                    return `
              <div style="border-top: 1px solid #333; margin-top: 10px; padding-top: 10px;">
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: #888;">💰 ${
                    isEn ? "Next payday" : "Następna wypłata"
                  }:</span>
                  <span style="color: #ef4444;">${timeStr} (-${
                      business.weeklyExpenses || 0
                    } ${getCurrency()})</span>
                </div>
              </div>`;
                  })()
                : ""
            }
          </div>

          <!-- GODZINY OTWARCIA I DZISIEJSI KLIENCI -->
          <div style="background: linear-gradient(145deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); border: 1px solid #10b981; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div style="font-weight: bold; color: #10b981;">🕐 ${
                isEn ? "Opening Hours" : "Godziny Otwarcia"
              }</div>
              <div style="color: ${
                isBusinessOpen(business) ? "#4ade80" : "#ef4444"
              }; font-weight: bold;">
                ${
                  isBusinessOpen(business)
                    ? isEn
                      ? "✅ OPEN"
                      : "✅ OTWARTE"
                    : isEn
                    ? "🔒 CLOSED"
                    : "🔒 ZAMKNIĘTE"
                }
              </div>
            </div>
            ${
              business.is24h
                ? `
              <div style="text-align: center; color: #4ade80; font-size: 1.1em;">🌙 24/7</div>
            `
                : `
              <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <label style="color: #888; font-size: 0.8em;">${
                    isEn ? "Open" : "Otwarcie"
                  }</label>
                  <select onchange="setBusinessHours(${index}, 'open', this.value)" style="width: 100%; padding: 8px; background: #333; border: 1px solid #555; border-radius: 5px; color: white;">
                    ${Array.from(
                      { length: 24 },
                      (_, i) =>
                        `<option value="${i}" ${
                          (business.openHour || 8) === i ? "selected" : ""
                        }>${String(i).padStart(2, "0")}:00</option>`
                    ).join("")}
                  </select>
                </div>
                <div style="flex: 1;">
                  <label style="color: #888; font-size: 0.8em;">${
                    isEn ? "Close" : "Zamknięcie"
                  }</label>
                  <select onchange="setBusinessHours(${index}, 'close', this.value)" style="width: 100%; padding: 8px; background: #333; border: 1px solid #555; border-radius: 5px; color: white;">
                    ${Array.from(
                      { length: 24 },
                      (_, i) =>
                        `<option value="${i}" ${
                          (business.closeHour || 20) === i ? "selected" : ""
                        }>${String(i).padStart(2, "0")}:00</option>`
                    ).join("")}
                  </select>
                </div>
              </div>
            `
            }
            
            <!-- Dzisiejsi klienci -->
            <div style="border-top: 1px solid #333; padding-top: 10px; margin-top: 10px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #888;">👥 ${
                  isEn ? "Today's clients" : "Klienci dziś"
                }:</span>
                <span style="color: #4ade80; font-weight: bold;">${
                  business.clientsServedToday || 0
                }</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #888;">💰 ${
                  isEn ? "Today's income" : "Przychód dziś"
                }:</span>
                <span style="color: #4ade80; font-weight: bold;">+${(
                  business.todayIncome || 0
                ).toLocaleString()} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-around; text-align: center; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px;">
                <div>
                  <div style="font-size: 1.2em;">😊</div>
                  <div style="color: #4ade80; font-weight: bold;">${
                    business.todayReviews?.positive || 0
                  }</div>
                </div>
                <div>
                  <div style="font-size: 1.2em;">😐</div>
                  <div style="color: #888; font-weight: bold;">${
                    business.todayReviews?.neutral || 0
                  }</div>
                </div>
                <div>
                  <div style="font-size: 1.2em;">😠</div>
                  <div style="color: #ef4444; font-weight: bold;">${
                    business.todayReviews?.negative || 0
                  }</div>
                </div>
              </div>
              
              <!-- Ostatnie opinie -->
              ${
                business.todayClients && business.todayClients.length > 0
                  ? `
                <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 10px;">
                  <div style="color: #888; font-size: 0.85em; margin-bottom: 8px;">📝 ${
                    isEn ? "Recent reviews" : "Ostatnie opinie"
                  }:</div>
                  <div style="max-height: 150px; overflow-y: auto;">
                    ${business.todayClients
                      .slice(-5)
                      .reverse()
                      .map((c) => {
                        const time = new Date(c.time);
                        const timeStr =
                          time.getHours().toString().padStart(2, "0") +
                          ":" +
                          time.getMinutes().toString().padStart(2, "0");
                        const stars =
                          "⭐".repeat(Math.floor(c.rating || 3)) +
                          ((c.rating || 3) % 1 >= 0.5 ? "½" : "");
                        const color =
                          (c.rating || 3) >= 4
                            ? "#4ade80"
                            : (c.rating || 3) >= 3
                            ? "#f59e0b"
                            : "#ef4444";
                        return `
                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 5px; margin-bottom: 5px; font-size: 0.85em;">
                          <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: ${color};">${stars}</span>
                            <span style="color: #666; font-size: 0.8em;">${timeStr}</span>
                          </div>
                          <div style="color: #ccc; font-style: italic;">"${
                            c.text || "..."
                          }"</div>
                          ${
                            c.spent
                              ? `<div style="color: #4ade80; font-size: 0.8em; margin-top: 3px;">+${
                                  c.spent
                                } ${getCurrency()}</div>`
                              : ""
                          }
                        </div>
                      `;
                      })
                      .join("")}
                  </div>
                </div>
              `
                  : ""
              }
            </div>
          </div>

          <!-- WŁAŚCICIEL -->
          <div style="background: linear-gradient(145deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05)); border: 1px solid #3b82f6; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div>
                <div style="font-weight: bold; color: #3b82f6;">👔 ${
                  isEn ? "Owner" : "Właściciel"
                }</div>
                <div style="color: #888; font-size: 0.85em;">${
                  isEn
                    ? "Capacity: 10 clients/day"
                    : "Zdolność: 10 klientów/dzień"
                }</div>
              </div>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <span style="color: #888; font-size: 0.9em;">${
                  isEn ? "Work here" : "Pracuj tutaj"
                }</span>
                <input type="checkbox" ${
                  business.ownerWorking ? "checked" : ""
                } onchange="toggleOwnerWorking(${index}, this.checked)" 
                       style="width: 20px; height: 20px; cursor: pointer;">
              </label>
            </div>
            ${
              business.ownerWorking
                ? `
            <button onclick="startOwnerWork(${index})" style="width: 100%; padding: 12px; background: linear-gradient(145deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">
              💼 ${
                isEn
                  ? "Work shift (3:30, earn 💰)"
                  : "Zmiana robocza (3:30, zarabiaj 💰)"
              }
            </button>
            `
                : `
            <div style="color: #666; font-size: 0.85em; text-align: center;">${
              isEn
                ? "Enable to work here and earn extra money"
                : "Włącz aby pracować i zarabiać dodatkowe pieniądze"
            }</div>
            `
            }
          </div>

          <!-- KONTO FIRMOWE -->
          <div style="background: linear-gradient(145deg, rgba(139,92,246,0.1), rgba(139,92,246,0.05)); border: 1px solid #8b5cf6; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div style="font-weight: bold; color: #8b5cf6;">🏦 ${
                isEn ? "Company Account" : "Konto Firmowe"
              }</div>
              <div style="color: #8b5cf6; font-size: 1.3em; font-weight: bold;">${(
                business.companyBalance || 0
              ).toLocaleString()} ${getCurrency()}</div>
            </div>
            <div style="color: #888; font-size: 0.85em; margin-bottom: 10px;">
              ${
                isEn
                  ? "30% of owner work goes here. Used for worker budgets."
                  : "30% zarobków właściciela trafia tutaj. Służy do budżetów pracowników."
              }
            </div>
            <button onclick="transferToCompany(${index})" style="width: 100%; padding: 10px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">
              ➡️ ${isEn ? "Deposit from wallet" : "Wpłać z portfela"}
            </button>
          </div>

          <!-- PROMOCJE -->
          <div style="background: linear-gradient(145deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05)); border: 1px solid #f59e0b; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div style="font-weight: bold; color: #f59e0b;">📢 ${
                isEn ? "Promotions" : "Promocje"
              }</div>
              ${
                business.activePromotions &&
                business.activePromotions.length > 0
                  ? `<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em;">${
                      business.activePromotions.length
                    } ${isEn ? "active" : "aktywne"}</span>`
                  : `<span style="color: #666; font-size: 0.8em;">${
                      isEn ? "None active" : "Brak aktywnych"
                    }</span>`
              }
            </div>
            ${
              business.activePromotions && business.activePromotions.length > 0
                ? `
              <div style="margin-bottom: 10px;">
                ${business.activePromotions
                  .map((p) => {
                    const promo = getPromotionOptions().find(
                      (o) => o.id === p.id
                    );
                    const daysLeft = Math.ceil(
                      (p.endTime - Date.now()) / (24 * 60 * 60 * 1000)
                    );
                    return `
                    <div style="display: flex; justify-content: space-between; background: #1a1a2e; padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                      <span>${promo?.icon || "📢"} ${promo?.name || p.id}</span>
                      <span style="color: #4ade80;">+${Math.round(
                        (promo?.clientBoost - 1) * 100
                      )}% • ${daysLeft}d</span>
                    </div>
                  `;
                  })
                  .join("")}
              </div>
            `
                : ""
            }
            <button onclick="openPromotionsModal(${index})" style="width: 100%; padding: 10px; background: linear-gradient(145deg, #f59e0b, #d97706); color: white; border: none; border-radius: 8px; cursor: pointer;">
              ${isEn ? "Buy promotion" : "Kup promocję"}
            </button>
          </div>

          <h3 style="color: #f59e0b; margin: 20px 0 10px;">👥 ${
            t.hiredWorkers
          } (${hiredWorkers.length})</h3>
          ${
            hiredWorkers.length === 0
              ? `
            <p style="color: #666; text-align: center; padding: 15px;">${t.noWorkersYet}</p>
          `
              : `
            <div style="max-height: 150px; overflow-y: auto;">
              ${hiredWorkers
                .map((w) => {
                  const translatedPersonality = getTranslatedPersonality(
                    w.personality.id
                  );
                  const translatedPosition = getTranslatedPosition(w.position);
                  return `
                <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-weight: bold;">${
                      w.gender === "male" ? "👨" : "👩"
                    } ${w.name}</div>
                    <div style="color: #888; font-size: 0.85em;">${
                      translatedPosition.name
                    } • ${translatedPersonality.name}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #ef4444;">${w.currentSalary}/${
                    isEn ? "wk" : "tyg"
                  }</div>
                    <button onclick="talkToWorker(${index}, '${
                    w.id
                  }')" style="padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; font-size: 0.8em; cursor: pointer; margin-top: 5px;">💬</button>
                    <button onclick="fireWorker(${index}, '${
                    w.id
                  }')" style="padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 5px; font-size: 0.8em; cursor: pointer; margin-top: 5px;">🚫</button>
                  </div>
                </div>
              `;
                })
                .join("")}
            </div>
          `
          }

          <h3 style="color: #10b981; margin: 20px 0 10px;">🆕 ${
            t.candidates
          } (${candidateWorkers.length})</h3>
          ${
            candidateWorkers.length === 0
              ? `
            <p style="color: #666; text-align: center; padding: 15px;">${
              t.noCandidates
            }</p>
            <p style="color: #888; text-align: center; font-size: 0.85em;">
              ${
                isEn
                  ? "New candidates appear every 5 minutes"
                  : "Nowi kandydaci pojawiają się co 5 minut"
              }
            </p>
          `
              : `
            <div style="max-height: 200px; overflow-y: auto;">
              ${candidateWorkers
                .map((w) => {
                  const translatedPersonality = getTranslatedPersonality(
                    w.personality.id
                  );
                  const translatedPosition = getTranslatedPosition(w.position);
                  return `
                <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-weight: bold;">${
                        w.gender === "male" ? "👨" : "👩"
                      } ${w.name}</div>
                      <div style="color: #888; font-size: 0.85em;">${
                        translatedPosition.name
                      }</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="color: #f59e0b;">${
                        translatedPersonality.name
                      }</div>
                      <div style="color: #888; font-size: 0.8em;">${
                        t.expects
                      }: ~${w.expectedSalary}/${isEn ? "wk" : "tyg"}</div>
                    </div>
                  </div>
                  <div style="color: #666; font-size: 0.8em; margin-top: 5px;">
                    ${translatedPersonality.traits.join(" • ")}
                  </div>
                  <button onclick="negotiateWithWorker(${index}, '${
                    w.id
                  }')" style="width: 100%; padding: 10px; background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                    💬 ${t.negotiateTerms}
                  </button>
                </div>
              `;
                })
                .join("")}
            </div>
          `
          }

          ${
            business.clients && business.clients.length > 0
              ? `
            <h3 style="color: #8b5cf6; margin: 20px 0 10px;">🧑‍🤝‍🧑 ${
              t.activeClients
            } (${business.clients.length})</h3>
            <div style="max-height: 150px; overflow-y: auto;">
              ${business.clients
                .map(
                  (c) => `
                <div onclick="talkToClient(${index}, '${
                    c.id
                  }')" style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div>${c.gender === "male" ? "👨" : "👩"} ${c.name}</div>
                    <div style="color: #888; font-size: 0.85em;">${
                      c.mood === "happy"
                        ? "😊"
                        : c.mood === "impatient"
                        ? "😤"
                        : c.mood === "demanding"
                        ? "😠"
                        : "😐"
                    } ${c.mood}</div>
                  </div>
                  <button style="padding: 8px 15px; background: #8b5cf6; color: white; border: none; border-radius: 6px;">💬 ${
                    t.serve
                  }</button>
                </div>
              `
                )
                .join("")}
            </div>
          `
              : ""
          }

          ${(() => {
            // Info o następnym dniu roboczym
            const lastDayTime = business.lastDayProcessed || Date.now();
            const DAY_MS = 24 * 60 * 60 * 1000; // 24h w rzeczywistości
            const nextDay = lastDayTime + DAY_MS;
            const remaining = nextDay - Date.now();
            let timeStr = isEn ? "Processing..." : "Przetwarzanie...";
            if (remaining > 0) {
              const hours = Math.floor(remaining / (60 * 60 * 1000));
              const mins = Math.floor(
                (remaining % (60 * 60 * 1000)) / (60 * 1000)
              );
              timeStr = hours + "h " + mins + "min";
            }
            return `
              <div style="background: rgba(139,92,246,0.1); border: 1px solid #8b5cf6; padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <div style="color: #8b5cf6; font-weight: bold;">📅 ${
                  isEn ? "Next work day in" : "Następny dzień roboczy za"
                }:</div>
                <div style="font-size: 1.3em; margin-top: 5px;">${timeStr}</div>
                <div style="color: #666; font-size: 0.8em; margin-top: 5px;">${
                  isEn
                    ? "Days pass automatically every 24h"
                    : "Dni mijają automatycznie co 24h"
                }</div>
              </div>
            `;
          })()}

          <button onclick="closeBusiness(${index})" style="width: 100%; padding: 12px; background: #333; color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; cursor: pointer; margin-top: 10px;">
            🗑️ ${t.closeBusiness}
          </button>

          <button onclick="closeModal('businessDetail'); openModal('business'); renderBusinessModal();" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
            ← ${t.backToList}
          </button>
        `;
        }

        function generateNewCandidates(businessIndex) {
          const t = translations[currentLang] || translations.en;
          if (money < 500) {
            showToast(
              "❌ " + t.needForRecruitment + " 500 " + getCurrency() + "!"
            );
            return;
          }
          money -= 500;

          const businesses = getBusinesses();
          const business = businesses[businessIndex];

          // Usuń nieprzyjętych kandydatów
          business.workers = business.workers.filter((w) => w.hired);

          // Dodaj nowych
          const positions = [
            "manager",
            "senior",
            "regular",
            "regular",
            "junior",
            "junior",
            "intern",
          ];
          for (let i = 0; i < 4; i++) {
            const pos = positions[Math.floor(Math.random() * positions.length)];
            business.workers.push(generateWorker(pos));
          }

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();
          renderBusinessDetail(businessIndex);
          showToast("🔄 " + t.foundCandidates);
        }

        // ========== PRACA WŁAŚCICIELA ==========

        function toggleOwnerWorking(businessIndex, working) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          business.ownerWorking = working;
          saveBusinesses(businesses);
          renderBusinessDetail(businessIndex);
        }

        // ========== KONTO FIRMOWE ==========

        function transferToCompany(businessIndex) {
          const isEn = currentLang === "en";
          const businesses = getBusinesses();
          const business = businesses[businessIndex];

          const amount = prompt(
            isEn
              ? `How much to deposit? (Your balance: ${money.toLocaleString()})`
              : `Ile wpłacić? (Twoje saldo: ${money.toLocaleString()})`,
            "1000"
          );

          if (amount === null) return;
          const num = parseInt(amount) || 0;

          if (num <= 0) {
            showToast(isEn ? "❌ Invalid amount" : "❌ Nieprawidłowa kwota");
            return;
          }
          if (num > money) {
            showToast(isEn ? "❌ Not enough money!" : "❌ Za mało pieniędzy!");
            return;
          }

          money -= num;
          business.companyBalance = (business.companyBalance || 0) + num;

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();
          renderBusinessDetail(businessIndex);

          showToast(
            `➡️ ${
              isEn ? "Deposited" : "Wpłacono"
            }: ${num.toLocaleString()} ${getCurrency()}`
          );
        }

        function setBusinessHours(businessIndex, type, value) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const hour = parseInt(value);
          const isEn = currentLang === "en";

          const oldHour =
            type === "open" ? business.openHour : business.closeHour;

          if (type === "open") {
            business.openHour = hour;
          } else {
            business.closeHour = hour;
          }

          // Powiadom pracowników o zmianie godzin (10% szans na narzekanie)
          if (oldHour !== hour) {
            const hiredWorkers = business.workers.filter((w) => w.hired);
            hiredWorkers.forEach((worker) => {
              if (Math.random() < 0.1) {
                const message = generateWorkerMessage("hours_complaint");
                addWorkerNotification(
                  businessIndex,
                  worker.id,
                  "hours_complaint",
                  message
                );
                worker.satisfaction = Math.max(
                  0,
                  (worker.satisfaction || 50) - 5
                );
              }
            });
          }

          saveBusinesses(businesses);
          renderBusinessDetail(businessIndex);
        }

        // ========== SYSTEM PROMOCJI ==========

        function openPromotionsModal(businessIndex) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const isEn = currentLang === "en";
          const promotions = getPromotionOptions();

          let modal = document.getElementById("modalPromotions");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "modalPromotions";
            modal.className = "modal";
            modal.innerHTML = `<div class="modal-content" style="max-width: 450px;"><div id="promotionsContent"></div></div>`;
            document.body.appendChild(modal);
          }

          const content = document.getElementById("promotionsContent");
          content.innerHTML = `
          <h2 style="color: #f59e0b; margin-bottom: 20px; text-align: center;">📢 ${
            isEn ? "Buy Promotion" : "Kup Promocję"
          }</h2>
          <div style="color: #888; font-size: 0.9em; margin-bottom: 15px; text-align: center;">
            ${
              isEn
                ? "Promotions attract more customers to your business"
                : "Promocje przyciągają więcej klientów do Twojej firmy"
            }
          </div>
          <div style="color: #4ade80; text-align: center; margin-bottom: 20px;">💰 ${money.toLocaleString()} ${getCurrency()}</div>
          
          <div style="max-height: 350px; overflow-y: auto;">
            ${promotions
              .map((promo) => {
                const alreadyActive = business.activePromotions?.some(
                  (p) => p.id === promo.id
                );
                const canAfford = money >= promo.cost;
                return `
                <div style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 10px; ${
                  alreadyActive ? "opacity: 0.5;" : ""
                }">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div>
                      <span style="font-size: 1.3em;">${promo.icon}</span>
                      <span style="font-weight: bold; margin-left: 8px;">${
                        promo.name
                      }</span>
                    </div>
                    <span style="color: ${
                      canAfford ? "#4ade80" : "#ef4444"
                    }; font-weight: bold;">${promo.cost.toLocaleString()} ${getCurrency()}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; color: #888; font-size: 0.85em; margin-bottom: 10px;">
                    <span>📅 ${promo.duration} ${isEn ? "days" : "dni"}</span>
                    <span style="color: #4ade80;">+${Math.round(
                      (promo.clientBoost - 1) * 100
                    )}% ${isEn ? "customers" : "klientów"}</span>
                  </div>
                  ${
                    alreadyActive
                      ? `
                    <div style="text-align: center; color: #f59e0b; font-size: 0.9em;">✅ ${
                      isEn ? "Already active" : "Już aktywna"
                    }</div>
                  `
                      : `
                    <button onclick="buyPromotion(${businessIndex}, '${
                          promo.id
                        }')" 
                            style="width: 100%; padding: 10px; background: ${
                              canAfford ? "#10b981" : "#333"
                            }; color: white; border: none; border-radius: 8px; cursor: ${
                          canAfford ? "pointer" : "not-allowed"
                        };"
                            ${canAfford ? "" : "disabled"}>
                      ${
                        canAfford
                          ? isEn
                            ? "Buy"
                            : "Kup"
                          : isEn
                          ? "Not enough money"
                          : "Za mało pieniędzy"
                      }
                    </button>
                  `
                  }
                </div>
              `;
              })
              .join("")}
          </div>
          
          <button onclick="document.getElementById('modalPromotions').style.display='none'; openModal('businessDetail'); renderBusinessDetail(${businessIndex});" style="width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px;">
            ← ${isEn ? "Back" : "Wróć"}
          </button>
        `;

          modal.style.display = "flex";
        }

        function buyPromotion(businessIndex, promoId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const isEn = currentLang === "en";
          const promo = getPromotionOptions().find((p) => p.id === promoId);

          if (!promo) return;
          if (money < promo.cost) {
            showToast(isEn ? "❌ Not enough money!" : "❌ Za mało pieniędzy!");
            return;
          }

          // Sprawdź czy już aktywna
          if (!business.activePromotions) business.activePromotions = [];
          if (business.activePromotions.some((p) => p.id === promoId)) {
            showToast(
              isEn
                ? "❌ This promotion is already active!"
                : "❌ Ta promocja jest już aktywna!"
            );
            return;
          }

          // Kup promocję
          money -= promo.cost;
          business.activePromotions.push({
            id: promoId,
            startTime: Date.now(),
            endTime: Date.now() + promo.duration * 24 * 60 * 60 * 1000,
          });

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          showToast(`✅ ${isEn ? "Bought" : "Kupiono"}: ${promo.name}!`);
          openPromotionsModal(businessIndex); // Odśwież modal
        }

        // Aktualizuj promocje (usuń wygasłe)
        function updateBusinessPromotions() {
          const businesses = getBusinesses();
          const now = Date.now();
          let changed = false;

          businesses.forEach((business) => {
            if (business.activePromotions) {
              const before = business.activePromotions.length;
              business.activePromotions = business.activePromotions.filter(
                (p) => p.endTime > now
              );
              if (business.activePromotions.length !== before) changed = true;
            }
          });

          if (changed) saveBusinesses(businesses);
        }

        // Oblicz bonus z promocji
        function getPromotionBonus(business) {
          let bonus = 1.0;
          const now = Date.now();
          const promos = getPromotionOptions();

          if (business.activePromotions) {
            business.activePromotions.forEach((active) => {
              if (active.endTime > now) {
                const promo = promos.find((p) => p.id === active.id);
                if (promo) bonus *= promo.clientBoost;
              }
            });
          }

          return bonus;
        }

        // Sprawdzaj promocje co minutę
        setInterval(updateBusinessPromotions, 60000);

        let ownerWorkInterval = null;
        let ownerWorkCollected = 0;
        let ownerWorkTimeLeft = 210; // 3:30 = 210 sekund
        let ownerWorkGameInterval = null;
        let currentWorkCategory = null;

        // ==================== ANIMACJE PRACY WG KATEGORII ====================

        const categoryWorkGames = {
          // 🍔 GASTRONOMIA - Łapanie zamówień na tacę
          gastronomy: {
            name: { pl: "Łapanie zamówień", en: "Catching Orders" },
            icon: "🍔",
            instruction: {
              pl: "Klikaj spadające jedzenie zanim spadnie!",
              en: "Click falling food before it drops!",
            },
            items: ["🍔", "🍕", "🍟", "🌭", "☕", "🍰", "🍺", "🥗", "🍣", "🍝"],
            bonusItem: "⭐",
            bgGradient:
              "linear-gradient(180deg, #1a1a2e 0%, #2d1f0f 50%, #1a1a2e 100%)",
            itemValue: 300,
            bonusValue: 800,
            spawnRate: 700,
            fallSpeed: 2.8,
          },

          // 🛒 HANDEL - Skanowanie produktów
          retail: {
            name: { pl: "Skanowanie produktów", en: "Scanning Products" },
            icon: "🛒",
            instruction: {
              pl: "Skanuj produkty klikając na nie!",
              en: "Scan products by clicking them!",
            },
            items: ["📦", "🛍️", "📱", "👕", "💊", "🔧", "🎁", "🧴", "🥫", "🧃"],
            bonusItem: "💎",
            bgGradient:
              "linear-gradient(180deg, #1a1a2e 0%, #1f2937 50%, #1a1a2e 100%)",
            itemValue: 350,
            bonusValue: 900,
            spawnRate: 650,
            fallSpeed: 2.5,
          },

          // 🔧 USŁUGI - Naprawianie (klikanie narzędzi)
          services: {
            name: { pl: "Obsługa klientów", en: "Serving Customers" },
            icon: "🔧",
            instruction: {
              pl: "Klikaj klientów i narzędzia!",
              en: "Click customers and tools!",
            },
            items: ["🔧", "💇", "🚿", "🏋️", "🛏️", "✂️", "🧽", "🔩", "🪛", "👤"],
            bonusItem: "🌟",
            bgGradient:
              "linear-gradient(180deg, #1a1a2e 0%, #1e3a5f 50%, #1a1a2e 100%)",
            itemValue: 400,
            bonusValue: 1000,
            spawnRate: 750,
            fallSpeed: 2.6,
          },

          // 💰 FINANSE - Łapanie pieniędzy
          finance: {
            name: { pl: "Obsługa transakcji", en: "Processing Transactions" },
            icon: "💰",
            instruction: {
              pl: "Łap pieniądze i karty!",
              en: "Catch money and cards!",
            },
            items: ["💵", "💴", "💶", "💳", "🪙", "💎", "📊", "📈", "🏦", "💹"],
            bonusItem: "💰",
            bgGradient:
              "linear-gradient(180deg, #1a1a2e 0%, #0f3d0f 50%, #1a1a2e 100%)",
            itemValue: 500,
            bonusValue: 1200,
            spawnRate: 800,
            fallSpeed: 2.4,
          },

          // 🚚 TRANSPORT - Łapanie paczek i pojazdów
          transport: {
            name: { pl: "Koordynacja dostaw", en: "Coordinating Deliveries" },
            icon: "🚚",
            instruction: {
              pl: "Zarządzaj dostawami i pojazdami!",
              en: "Manage deliveries and vehicles!",
            },
            items: ["📦", "🚚", "🚕", "🛻", "✈️", "🚛", "📮", "🗺️", "⛽", "🔑"],
            bonusItem: "🏆",
            bgGradient:
              "linear-gradient(180deg, #1a1a2e 0%, #2d2d1f 50%, #1a1a2e 100%)",
            itemValue: 450,
            bonusValue: 1100,
            spawnRate: 720,
            fallSpeed: 2.7,
          },

          // 💻 TECHNOLOGIA - Łapanie kodu i komputerów
          tech: {
            name: { pl: "Kodowanie", en: "Coding" },
            icon: "💻",
            instruction: {
              pl: "Łap błędy i pisz kod!",
              en: "Catch bugs and write code!",
            },
            items: ["💻", "🖥️", "⌨️", "🐛", "🔌", "📟", "🖱️", "💾", "🌐", "📡"],
            bonusItem: "🚀",
            bgGradient:
              "linear-gradient(180deg, #1a1a2e 0%, #0f1f3d 50%, #1a1a2e 100%)",
            itemValue: 600,
            bonusValue: 1500,
            spawnRate: 850,
            fallSpeed: 2.3,
          },

          // 🎬 ROZRYWKA - Łapanie biletów i gwiazdek
          entertainment: {
            name: { pl: "Zarządzanie eventem", en: "Event Management" },
            icon: "🎬",
            instruction: {
              pl: "Łap bilety i gwiazdki!",
              en: "Catch tickets and stars!",
            },
            items: ["🎬", "🎵", "🎤", "🕹️", "🎭", "🎪", "🎟️", "🎶", "🎧", "🎺"],
            bonusItem: "🌟",
            bgGradient:
              "linear-gradient(180deg, #1a1a2e 0%, #3d1f3d 50%, #1a1a2e 100%)",
            itemValue: 350,
            bonusValue: 900,
            spawnRate: 600,
            fallSpeed: 3.0,
          },

          // 🏗️ BUDOWNICTWO - Łapanie materiałów budowlanych
          construction: {
            name: { pl: "Zarządzanie budową", en: "Construction Management" },
            icon: "🏗️",
            instruction: {
              pl: "Łap materiały budowlane!",
              en: "Catch building materials!",
            },
            items: ["🧱", "🔨", "📐", "🪵", "⚙️", "🪜", "🦺", "🪨", "🔩", "📏"],
            bonusItem: "🏆",
            bgGradient:
              "linear-gradient(180deg, #1a1a2e 0%, #3d2d1f 50%, #1a1a2e 100%)",
            itemValue: 550,
            bonusValue: 1300,
            spawnRate: 780,
            fallSpeed: 2.5,
          },
        };

        function startOwnerWork(businessIndex) {
          const isEn = currentLang === "en";
          const businesses = getBusinesses();
          const business = businesses[businessIndex];

          if (ownerWorkInterval) {
            showToast(
              isEn ? "❌ You're already working!" : "❌ Już pracujesz!",
              { type: "error" }
            );
            return;
          }

          // Znajdź kategorię biznesu
          const categories = getBusinessCategories();
          let foundCategory = null;
          for (const [catId, cat] of Object.entries(categories)) {
            if (cat.types.some((t) => t.id === business.typeId)) {
              foundCategory = catId;
              break;
            }
          }

          currentWorkCategory = foundCategory || "gastronomy";
          const gameConfig = categoryWorkGames[currentWorkCategory];

          ownerWorkCollected = 0;
          ownerWorkTimeLeft = 210;

          let modal = document.getElementById("modalOwnerWork");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "modalOwnerWork";
            modal.className = "modal";
            document.body.appendChild(modal);
          }

          const gameName = gameConfig.name[isEn ? "en" : "pl"];
          const instruction = gameConfig.instruction[isEn ? "en" : "pl"];

          modal.innerHTML = `
          <div class="modal-content" style="max-width: 520px; height: 520px; position: relative; overflow: hidden; padding: 15px; background: linear-gradient(145deg, #1e293b, #0f172a); border: 2px solid rgba(255,107,53,0.5);">
            
            <!-- Header z kategorią -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 2em;">${gameConfig.icon}</span>
                <div>
                  <div style="font-size: 1em; font-weight: bold; color: #ff6b35;">${gameName}</div>
                  <div style="font-size: 0.75em; color: #888;">${
                    business.name
                  }</div>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 1.8em; font-family: monospace; color: #f59e0b;" id="ownerWorkTimer">3:30</div>
              </div>
            </div>
            
            <!-- Zebrane pieniądze -->
            <div style="background: linear-gradient(145deg, rgba(74,222,128,0.2), rgba(74,222,128,0.05)); padding: 10px 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <span style="color: #888; font-size: 0.85em;">${
                  isEn ? "Earned" : "Zebrano"
                }:</span>
                <span style="color: #4ade80; font-size: 1.5em; font-weight: bold; margin-left: 10px;" id="ownerWorkBonus">0</span>
                <span style="color: #4ade80; font-size: 1em;"> ${getCurrency()}</span>
              </div>
              <div style="display: flex; gap: 8px;">
                <div style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.8em;">
                  ${gameConfig.items[0]} <span style="color: #4ade80;">+${
            gameConfig.itemValue
          }</span>
                </div>
                <div style="background: rgba(255,215,0,0.2); padding: 4px 8px; border-radius: 6px; font-size: 0.8em;">
                  ${gameConfig.bonusItem} <span style="color: #ffd700;">+${
            gameConfig.bonusValue
          }</span>
                </div>
              </div>
            </div>
            
            <!-- Obszar gry -->
            <div id="ownerWorkGameArea" style="position: relative; width: 100%; height: 280px; background: ${
              gameConfig.bgGradient
            }; border-radius: 14px; overflow: hidden; box-shadow: inset 0 0 30px rgba(0,0,0,0.5);">
              <div id="ownerCoinsContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
              
              <!-- Instrukcja na środku -->
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; opacity: 0.3;">
                <div style="font-size: 3em; margin-bottom: 10px;">${
                  gameConfig.icon
                }</div>
                <div style="color: #fff; font-size: 0.9em;">${instruction}</div>
              </div>
              
              <!-- Efekt dolnej krawędzi -->
              <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: linear-gradient(180deg, transparent, rgba(239,68,68,0.3)); pointer-events: none;"></div>
            </div>
            
            <!-- Przycisk zakończenia -->
            <button id="ownerWorkEndBtn" style="width: 100%; padding: 12px; background: linear-gradient(145deg, #ef4444, #dc2626); color: white; border: none; border-radius: 10px; cursor: pointer; margin-top: 12px; font-size: 1em; font-weight: bold; transition: all 0.2s;">
              ❌ ${isEn ? "End shift early" : "Zakończ wcześniej"}
            </button>
          </div>
        `;

          document.getElementById("ownerWorkEndBtn").onclick = () =>
            endOwnerWork(businessIndex);

          modal.classList.add("active");
          modal.style.display = "flex";

          // Timer
          ownerWorkInterval = setInterval(() => {
            ownerWorkTimeLeft--;
            const mins = Math.floor(ownerWorkTimeLeft / 60);
            const secs = ownerWorkTimeLeft % 60;
            const timerEl = document.getElementById("ownerWorkTimer");
            if (timerEl) {
              timerEl.textContent = `${mins}:${secs
                .toString()
                .padStart(2, "0")}`;
              if (ownerWorkTimeLeft <= 30) {
                timerEl.style.color = "#ef4444";
                timerEl.style.animation = "badge-pulse 0.5s infinite";
              }
            }

            if (ownerWorkTimeLeft <= 0) {
              endOwnerWork(businessIndex);
            }
          }, 1000);

          // Spawn items
          ownerWorkGameInterval = setInterval(() => {
            spawnWorkItem(gameConfig);
          }, gameConfig.spawnRate);

          // Pierwszy item od razu
          setTimeout(() => spawnWorkItem(gameConfig), 300);
        }

        function spawnWorkItem(gameConfig) {
          const container = document.getElementById("ownerCoinsContainer");
          if (!container) return;

          const isBonus = Math.random() < 0.15; // 15% szans na bonus
          const itemEmoji = isBonus
            ? gameConfig.bonusItem
            : gameConfig.items[
                Math.floor(Math.random() * gameConfig.items.length)
              ];
          const value = isBonus ? gameConfig.bonusValue : gameConfig.itemValue;

          const item = document.createElement("div");
          item.innerHTML = itemEmoji;
          item.dataset.value = value;
          item.dataset.isBonus = isBonus;

          const startX = Math.random() * 80 + 10;
          const fallDuration = gameConfig.fallSpeed + Math.random() * 0.5;

          item.style.cssText = `
          position: absolute;
          top: -60px;
          left: ${startX}%;
          font-size: ${isBonus ? "3.5em" : "2.8em"};
          cursor: pointer;
          z-index: 5;
          transition: transform 0.15s, filter 0.15s;
          user-select: none;
          filter: ${
            isBonus
              ? "drop-shadow(0 0 15px gold)"
              : "drop-shadow(0 2px 4px rgba(0,0,0,0.5))"
          };
          animation: itemFall${Math.random()
            .toString(36)
            .substr(2, 5)} ${fallDuration}s linear forwards;
        `;

          // Dodaj animację CSS inline (unikalna dla każdego itemu)
          const styleId =
            "workItemStyle" + Math.random().toString(36).substr(2, 5);
          const style = document.createElement("style");
          style.id = styleId;
          style.textContent = `
          @keyframes itemFall${styleId.replace("workItemStyle", "")} {
            0% { top: -60px; }
            100% { top: calc(100% + 60px); }
          }
        `;
          document.head.appendChild(style);
          item.style.animation = `itemFall${styleId.replace(
            "workItemStyle",
            ""
          )} ${fallDuration}s linear forwards`;

          // Hover effect
          item.onmouseenter = () => {
            item.style.transform = "scale(1.3)";
            item.style.filter = `brightness(1.5) drop-shadow(0 0 20px ${
              isBonus ? "gold" : "#4ade80"
            })`;
          };
          item.onmouseleave = () => {
            item.style.transform = "scale(1)";
            item.style.filter = isBonus
              ? "drop-shadow(0 0 15px gold)"
              : "drop-shadow(0 2px 4px rgba(0,0,0,0.5))";
          };

          // Click - collect
          item.onclick = (e) => {
            e.stopPropagation();
            playSound("coin");

            ownerWorkCollected += value;
            const bonusEl = document.getElementById("ownerWorkBonus");
            if (bonusEl)
              bonusEl.textContent = ownerWorkCollected.toLocaleString();

            // Animacja zebrania
            item.style.transition = "all 0.3s ease-out";
            item.style.transform = "scale(1.5)";
            item.style.opacity = "0";
            item.style.pointerEvents = "none";

            // Popup z wartością
            const popup = document.createElement("div");
            popup.textContent = `+${value}`;
            popup.style.cssText = `
            position: absolute;
            top: ${item.offsetTop}px;
            left: ${item.offsetLeft}px;
            color: ${isBonus ? "#ffd700" : "#4ade80"};
            font-size: 1.2em;
            font-weight: bold;
            pointer-events: none;
            text-shadow: 0 0 10px ${isBonus ? "gold" : "#4ade80"};
            z-index: 100;
            transition: all 0.8s ease-out;
          `;
            container.appendChild(popup);

            // Animuj popup
            setTimeout(() => {
              popup.style.transform = "translateY(-50px)";
              popup.style.opacity = "0";
            }, 50);

            setTimeout(() => {
              item.remove();
              popup.remove();
              const styleToRemove = document.getElementById(styleId);
              if (styleToRemove) styleToRemove.remove();
            }, 350);
          };

          container.appendChild(item);

          // Usuń po spadnięciu
          setTimeout(() => {
            if (item.parentNode) {
              item.style.transition = "opacity 0.3s ease-out";
              item.style.opacity = "0";
              setTimeout(() => {
                item.remove();
                const styleToRemove = document.getElementById(styleId);
                if (styleToRemove) styleToRemove.remove();
              }, 300);
            }
          }, fallDuration * 1000);
        }

        function endOwnerWork(businessIndex) {
          if (ownerWorkInterval) {
            clearInterval(ownerWorkInterval);
            ownerWorkInterval = null;
          }
          if (ownerWorkGameInterval) {
            clearInterval(ownerWorkGameInterval);
            ownerWorkGameInterval = null;
          }

          const isEn = currentLang === "en";
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const gameConfig =
            categoryWorkGames[currentWorkCategory] ||
            categoryWorkGames.gastronomy;

          // Pokaż podsumowanie przed zamknięciem
          const modal = document.getElementById("modalOwnerWork");
          if (modal && ownerWorkCollected > 0) {
            const companyShare = Math.floor(ownerWorkCollected * 0.3);
            const playerShare = ownerWorkCollected - companyShare;

            modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px; text-align: center; padding: 30px; background: linear-gradient(145deg, #1e293b, #0f172a); border: 2px solid #4ade80;">
              <div style="font-size: 4em; margin-bottom: 15px;">🎉</div>
              <h2 style="color: #4ade80; margin-bottom: 20px;">${
                isEn ? "Shift Complete!" : "Zmiana zakończona!"
              }</h2>
              
              <div style="background: rgba(74,222,128,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div style="font-size: 0.9em; color: #888; margin-bottom: 5px;">${
                  isEn ? "Total earned" : "Łącznie zebrano"
                }</div>
                <div style="font-size: 2.5em; font-weight: bold; color: #4ade80;">${ownerWorkCollected.toLocaleString()} ${getCurrency()}</div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: rgba(59,130,246,0.1); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.8em; color: #888;">👤 ${
                    isEn ? "Your share" : "Twój udział"
                  }</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #3b82f6;">+${playerShare.toLocaleString()}</div>
                </div>
                <div style="background: rgba(245,158,11,0.1); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.8em; color: #888;">🏢 ${
                    isEn ? "Company" : "Firma"
                  }</div>
                  <div style="font-size: 1.3em; font-weight: bold; color: #f59e0b;">+${companyShare.toLocaleString()}</div>
                </div>
              </div>
              
              <button onclick="closeOwnerWorkModal(${businessIndex})" style="width: 100%; padding: 15px; background: linear-gradient(145deg, #4ade80, #22c55e); color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                ✓ ${isEn ? "Great!" : "Świetnie!"}
              </button>
            </div>
          `;

            money += playerShare;
            business.companyBalance =
              (business.companyBalance || 0) + companyShare;

            saveBusinesses(businesses);
            saveState();
            updateAllDisplays();
          } else {
            closeOwnerWorkModal(businessIndex);
            showToast(
              isEn ? "😔 No earnings this shift" : "😔 Nic nie zarobiono",
              { type: "warning" }
            );
          }

          ownerWorkCollected = 0;
          ownerWorkTimeLeft = 210;
          currentWorkCategory = null;
        }

        function closeOwnerWorkModal(businessIndex) {
          const modal = document.getElementById("modalOwnerWork");
          if (modal) {
            modal.classList.remove("active");
            modal.style.display = "none";
          }
          if (businessIndex !== undefined) {
            renderBusinessDetail(businessIndex);
          }
        }

        // ========== SYSTEM CZATU Z AI (PRACOWNICY/KLIENCI) ==========

        function negotiateWithWorker(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const t = translations[currentLang] || translations.en;

          currentBusinessChat = {
            type: "worker_negotiate",
            businessId: businessIndex,
            targetId: workerId,
            awaitingInput: null,
          };

          closeModal("businessDetail");
          openModal("businessChat");

          document.getElementById(
            "businessChatTitle"
          ).textContent = `💬 ${t.chatWith} ${worker.name}`;

          // Reset historii czatu dla nowej negocjacji
          worker.chatHistory = [];
          worker.negotiationState = "initial";

          continueWorkerNegotiation(businessIndex, workerId);
        }

        function continueWorkerNegotiation(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          const messagesDiv = document.getElementById("businessChatMessages");
          const optionsDiv = document.getElementById("businessChatOptions");
          const inputDiv = document.getElementById("businessChatInput");

          // Renderuj historię
          messagesDiv.innerHTML = worker.chatHistory
            .map(
              (msg) => `
          <div style="margin-bottom: 12px; ${
            msg.from === "player" ? "text-align: right;" : ""
          }">
            <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: ${
              msg.from === "player" ? "#3b82f6" : "#333"
            }; white-space: pre-line;">
              ${msg.text}
            </div>
          </div>
        `
            )
            .join("");
          messagesDiv.scrollTop = messagesDiv.scrollHeight;

          inputDiv.style.display = "none";
          optionsDiv.innerHTML = "";

          // Jeśli już zatrudniony lub odrzucony
          if (
            worker.negotiationState === "accepted" ||
            worker.negotiationState === "rejected"
          ) {
            optionsDiv.innerHTML = `
            <button onclick="closeModal('businessChat'); openModal('businessDetail'); renderBusinessDetail(${businessIndex});" style="padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ← ${t.backToBusinessBtn}
            </button>
          `;
            return;
          }

          // Jeśli pracownik odrzucił rolę
          if (worker.negotiationState === "role_rejected") {
            optionsDiv.innerHTML = `
            <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; color: #ef4444;">
              ⚠️ ${
                isEn
                  ? "Worker rejected the proposed role"
                  : "Pracownik odrzucił proponowaną rolę"
              }
            </div>
            <button onclick="worker.negotiationState = 'initial'; worker.chatHistory = []; continueWorkerNegotiation(${businessIndex}, '${workerId}')" style="padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">
              🔄 ${isEn ? "Try different role" : "Spróbuj inną rolę"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 10px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%;">
              ❌ ${isEn ? "End negotiations" : "Zakończ negocjacje"}
            </button>
          `;
            return;
          }

          // Jeśli pracownik odrzucił budżet
          if (worker.negotiationState === "budget_rejected") {
            optionsDiv.innerHTML = `
            <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; color: #ef4444;">
              ⚠️ ${
                isEn
                  ? "Worker rejected the proposed budget"
                  : "Pracownik odrzucił proponowany budżet"
              }
            </div>
            <button onclick="worker.negotiationState = 'budget_negotiation'; continueWorkerNegotiation(${businessIndex}, '${workerId}')" style="padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">
              🔄 ${isEn ? "Offer different budget" : "Zaproponuj inny budżet"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 10px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%;">
              ❌ ${isEn ? "End negotiations" : "Zakończ negocjacje"}
            </button>
          `;
            return;
          }

          const dailySalary =
            worker.expectedDailySalary || Math.floor(worker.expectedSalary / 7);
          const weeklySalary = dailySalary * 7;
          const roles = getWorkerRoles();
          const preferredRoleInfo =
            roles[worker.preferredRole] || roles.service;

          // Stan negocjacji
          if (worker.negotiationState === "initial") {
            if (worker.chatHistory.length === 0) {
              // Powitanie z informacją o poprzedniej pracy i preferowanej roli
              let greeting = isEn
                ? `Hello! I'm ${
                    worker.name
                  }, applying for ${worker.positionName.toLowerCase()}.`
                : `Dzień dobry! Jestem ${
                    worker.name
                  }, aplikuję na stanowisko ${worker.positionName.toLowerCase()}.`;
              worker.chatHistory.push({ from: "worker", text: greeting });

              // Poprzednia praca
              if (worker.previousJob) {
                const prevJobText = isEn
                  ? `📋 Previous work: ${worker.previousJob.name} (${
                      worker.previousJob.years
                    } ${worker.previousJob.years === 1 ? "year" : "years"})`
                  : `📋 Poprzednia praca: ${worker.previousJob.name} (${
                      worker.previousJob.years
                    } ${
                      worker.previousJob.years === 1
                        ? "rok"
                        : worker.previousJob.years < 5
                        ? "lata"
                        : "lat"
                    })`;
                worker.chatHistory.push({ from: "worker", text: prevJobText });
              } else {
                worker.chatHistory.push({
                  from: "worker",
                  text: isEn
                    ? "📋 This would be my first job."
                    : "📋 To byłaby moja pierwsza praca.",
                });
              }

              // Preferowana rola
              const roleText = isEn
                ? `${preferredRoleInfo.icon} I'd like to work as: ${preferredRoleInfo.name}\n${preferredRoleInfo.description}`
                : `${preferredRoleInfo.icon} Chciałbym pracować jako: ${preferredRoleInfo.name}\n${preferredRoleInfo.description}`;
              worker.chatHistory.push({ from: "worker", text: roleText });

              // Jeśli rola wymaga budżetu
              if (preferredRoleInfo.needsBudget && worker.expectedBudget > 0) {
                const budgetText = isEn
                  ? `💵 For this role I would need a budget of about ${
                      worker.expectedBudget
                    } ${getCurrency()}.`
                  : `💵 Do tej roli potrzebowałbym budżetu około ${
                      worker.expectedBudget
                    } ${getCurrency()}.`;
                worker.chatHistory.push({ from: "worker", text: budgetText });
              }

              saveBusinesses(businesses);
            }

            // Odśwież wiadomości
            messagesDiv.innerHTML = worker.chatHistory
              .map(
                (msg) => `
            <div style="margin-bottom: 12px; ${
              msg.from === "player" ? "text-align: right;" : ""
            }">
              <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: ${
                msg.from === "player" ? "#3b82f6" : "#333"
              }; white-space: pre-line;">
                ${msg.text}
              </div>
            </div>
          `
              )
              .join("");
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Opcje - najpierw ustal rolę
            optionsDiv.innerHTML = `
            <div style="background: #1a1a2e; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
              <div style="color: #888; font-size: 0.85em; margin-bottom: 8px;">${
                isEn
                  ? "Select role for this worker:"
                  : "Wybierz rolę dla tego pracownika:"
              }</div>
              <select id="selectWorkerRole" style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: white;">
                ${Object.values(roles)
                  .map(
                    (r) => `
                  <option value="${r.id}" ${
                      r.id === worker.preferredRole ? "selected" : ""
                    }>
                    ${r.icon} ${r.name} ${r.needsBudget ? "(💵)" : ""}
                  </option>
                `
                  )
                  .join("")}
              </select>
            </div>
            <button onclick="confirmWorkerRole(${businessIndex}, '${workerId}')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">
              ✅ ${
                isEn ? "Confirm role & continue" : "Potwierdź rolę i kontynuuj"
              }
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 10px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
              ❌ ${t.rejectBtn}
            </button>
          `;
          } else if (worker.negotiationState === "role_confirmed") {
            // Rola potwierdzona - teraz negocjuj warunki
            const currentOffer = worker.offerDailySalary || dailySalary;
            const currentBonus =
              worker.offerBonusPercent || worker.bonusPercent;
            const assignedRole = roles[worker.assignedRole] || roles.service;

            // Odśwież wiadomości
            messagesDiv.innerHTML = worker.chatHistory
              .map(
                (msg) => `
            <div style="margin-bottom: 12px; ${
              msg.from === "player" ? "text-align: right;" : ""
            }">
              <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: ${
                msg.from === "player" ? "#3b82f6" : "#333"
              }; white-space: pre-line;">
                ${msg.text}
              </div>
            </div>
          `
              )
              .join("");
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            optionsDiv.innerHTML = `
            <div style="background: rgba(59,130,246,0.1); border: 1px solid #3b82f6; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
              <span style="color: #3b82f6;">${assignedRole.icon} ${
              isEn ? "Role" : "Rola"
            }: ${assignedRole.name}</span>
              ${
                worker.assignedBudget > 0
                  ? `<span style="color: #f59e0b; margin-left: 10px;">💵 ${
                      worker.assignedBudget
                    } ${getCurrency()}</span>`
                  : ""
              }
            </div>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'accept_terms')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">
              ✅ ${
                isEn ? "Accept terms" : "Zgódź się na warunki"
              } (${currentOffer}/${isEn ? "day" : "dzień"} + ${currentBonus}%)
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'edit_details')" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">
              📋 ${isEn ? "Discuss details" : "Omów szczegóły"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ❌ ${t.rejectBtn}
            </button>
          `;
          } else if (worker.negotiationState === "budget_negotiation") {
            // Negocjacja budżetu dla ról które go potrzebują
            const expectedBudget = worker.expectedBudget || 1000;
            const currentBudget = worker.offerBudget || expectedBudget;
            const companyBalance = business.companyBalance || 0;

            // Odśwież wiadomości
            messagesDiv.innerHTML = worker.chatHistory
              .map(
                (msg) => `
            <div style="margin-bottom: 12px; ${
              msg.from === "player" ? "text-align: right;" : ""
            }">
              <div style="display: inline-block; max-width: 80%; padding: 10px 15px; border-radius: 15px; background: ${
                msg.from === "player" ? "#3b82f6" : "#333"
              }; white-space: pre-line;">
                ${msg.text}
              </div>
            </div>
          `
              )
              .join("");
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            optionsDiv.innerHTML = `
            <div style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
              <h4 style="margin-bottom: 10px; color: #f59e0b;">💵 ${
                isEn ? "Budget Assignment" : "Przydziel Budżet"
              }</h4>
              <div style="color: #888; font-size: 0.85em; margin-bottom: 10px;">
                ${
                  isEn
                    ? "This worker needs a budget for their role. The budget comes from the company account."
                    : "Ten pracownik potrzebuje budżetu do swojej roli. Budżet pochodzi z konta firmowego."
                }
              </div>
              <div style="margin-bottom: 10px;">
                <label style="color: #888; font-size: 0.85em;">${
                  isEn ? "Budget amount" : "Kwota budżetu"
                } (${
              isEn ? "suggested" : "sugerowane"
            }: ${expectedBudget})</label>
                <input type="number" id="offerBudget" value="${Math.min(
                  currentBudget,
                  companyBalance
                )}" min="0" max="${companyBalance}"
                       style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: white; margin-top: 5px;">
              </div>
              <div style="color: #8b5cf6; font-size: 0.9em;">🏦 ${
                isEn ? "Company account" : "Konto firmowe"
              }: ${companyBalance.toLocaleString()} ${getCurrency()}</div>
              ${
                companyBalance < expectedBudget
                  ? `<div style="color: #f59e0b; font-size: 0.8em; margin-top: 5px;">⚠️ ${
                      isEn
                        ? "Work in your business to earn more!"
                        : "Pracuj w swojej firmie żeby zarobić więcej!"
                    }</div>`
                  : ""
              }
            </div>
            <button onclick="confirmBudget(${businessIndex}, '${workerId}')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">
              ✅ ${isEn ? "Confirm budget" : "Potwierdź budżet"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 10px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
              ❌ ${t.rejectBtn}
            </button>
          `;
          } else if (worker.negotiationState === "editing_details") {
            // Edycja szczegółów oferty
            const currentOffer = worker.offerDailySalary || dailySalary;
            const currentBonus =
              worker.offerBonusPercent || worker.bonusPercent;
            const currentSigning =
              worker.offerSigningBonus !== undefined
                ? worker.offerSigningBonus
                : worker.signingBonus || 0;
            const currentType = worker.offerContractType || "fixed";
            const currentPerf =
              worker.offerExpectedPerf || worker.expectedPerformance;

            optionsDiv.innerHTML = `
            <div style="background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
              <h4 style="margin-bottom: 15px; color: #f59e0b;">📋 ${
                isEn ? "Contract Details" : "Szczegóły Umowy"
              }</h4>
              
              <div style="margin-bottom: 12px;">
                <label style="color: #888; font-size: 0.85em; display: block; margin-bottom: 3px;">💰 ${
                  isEn ? "Daily salary" : "Dniówka"
                } (${isEn ? "expected" : "oczekiwane"}: ${dailySalary})</label>
                <input type="number" id="offerDailySalary" value="${currentOffer}" min="1" 
                       style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: white; font-size: 1em;">
              </div>
              
              <div style="margin-bottom: 12px;">
                <label style="color: #888; font-size: 0.85em; display: block; margin-bottom: 3px;">📊 ${
                  isEn ? "Commission %" : "Prowizja %"
                } (${isEn ? "expected" : "oczekiwane"}: ${
              worker.bonusPercent
            }%)</label>
                <input type="number" id="offerBonusPercent" value="${currentBonus}" min="0" max="50"
                       style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: white; font-size: 1em;">
              </div>
              
              <div style="margin-bottom: 12px;">
                <label style="color: #888; font-size: 0.85em; display: block; margin-bottom: 3px;">🎁 ${
                  isEn ? "Signing bonus" : "Bonus za podpis"
                } (${isEn ? "expected" : "oczekiwane"}: ${
              worker.signingBonus || 0
            })</label>
                <input type="number" id="offerSigningBonus" value="${currentSigning}" min="0" max="10000"
                       style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: white; font-size: 1em;">
              </div>
              
              <div style="margin-bottom: 12px;">
                <label style="color: #888; font-size: 0.85em; display: block; margin-bottom: 3px;">📝 ${
                  isEn ? "Contract type" : "Typ umowy"
                }</label>
                <select id="offerContractType" style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: white; font-size: 1em;">
                  <option value="fixed" ${
                    currentType === "fixed" ? "selected" : ""
                  }>${
              isEn ? "Fixed (no reductions)" : "Stała (bez obniżek)"
            }</option>
                  <option value="performance" ${
                    currentType === "performance" ? "selected" : ""
                  }>${
              isEn ? "Performance-based" : "Zależna od wyników"
            }</option>
                </select>
              </div>
              
              <div style="margin-bottom: 12px;">
                <label style="color: #888; font-size: 0.85em; display: block; margin-bottom: 3px;">🎯 ${
                  isEn ? "Expected clients/day" : "Oczekiwani klienci/dzień"
                }</label>
                <input type="number" id="offerExpectedPerf" value="${currentPerf}" min="1" max="100"
                       style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: white; font-size: 1em;">
              </div>
            </div>
            
            <button onclick="sendContractOffer(${businessIndex}, '${workerId}')" style="padding: 15px; background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1.1em;">
              📨 ${isEn ? "Send offer" : "Wyślij ofertę"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'back')" style="padding: 10px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%;">
              ← ${isEn ? "Back" : "Wróć"}
            </button>
          `;
          } else if (worker.negotiationState === "worker_accepted") {
            // Pracownik zaakceptował
            const finalDaily = worker.agreedDailySalary;
            const finalBonus = worker.agreedBonusPercent;
            const finalSigning = worker.agreedSigningBonus || 0;

            optionsDiv.innerHTML = `
            <div style="background: rgba(16,185,129,0.1); border: 1px solid #10b981; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
              <div style="color: #10b981; font-weight: bold; margin-bottom: 10px;">✅ ${
                isEn ? "Worker accepted!" : "Pracownik zaakceptował!"
              }</div>
              <div style="font-size: 0.9em; color: #ccc;">
                💰 ${finalDaily} ${getCurrency()}/${isEn ? "day" : "dzień"}<br>
                📊 ${finalBonus}% ${isEn ? "commission" : "prowizji"}<br>
                🎁 ${finalSigning} ${getCurrency()} ${
              isEn ? "signing bonus" : "bonus za podpis"
            }
              </div>
            </div>
            
            <button onclick="signContract(${businessIndex}, '${workerId}')" style="padding: 15px; background: linear-gradient(145deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1.1em;">
              ✍️ ${isEn ? "Sign contract" : "Podpisz umowę"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'edit_details')" style="padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%;">
              📋 ${isEn ? "Change offer" : "Zmień ofertę"}
            </button>
          `;
          } else if (worker.negotiationState === "worker_counter") {
            // Kontrpropozycja
            optionsDiv.innerHTML = `
            <div style="background: rgba(245,158,11,0.1); border: 1px solid #f59e0b; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
              <div style="color: #f59e0b; font-weight: bold; margin-bottom: 10px;">💬 ${
                isEn ? "Counter-offer:" : "Kontrpropozycja:"
              }</div>
              <div style="font-size: 0.9em; color: #ccc;">
                💰 ${worker.counterDailySalary} ${getCurrency()}/${
              isEn ? "day" : "dzień"
            }<br>
                📊 ${worker.counterBonusPercent}% ${
              isEn ? "commission" : "prowizji"
            }
              </div>
            </div>
            
            <button onclick="acceptCounterOffer(${businessIndex}, '${workerId}')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">
              ✅ ${isEn ? "Accept counter-offer" : "Akceptuj kontrpropozycję"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'edit_details')" style="padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%;">
              📋 ${isEn ? "Make new offer" : "Złóż nową ofertę"}
            </button>
            <button onclick="respondToWorker(${businessIndex}, '${workerId}', 'reject')" style="padding: 10px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
              ❌ ${t.rejectBtn}
            </button>
          `;
          } else if (worker.negotiationState === "contract_setup") {
            // Stary stan - przekieruj do nowego
            worker.negotiationState = "editing_details";
            saveBusinesses(businesses);
            continueWorkerNegotiation(businessIndex, workerId);
            return;
          }
        }

        // Finalizacja kontraktu
        function finalizeContract(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";

          const signingBonus =
            parseInt(document.getElementById("contractSigningBonus")?.value) ||
            0;
          const contractType =
            document.getElementById("contractType")?.value || "fixed";
          const expectedPerf =
            parseInt(document.getElementById("contractExpectedPerf")?.value) ||
            worker.expectedPerformance;

          const dailySalary =
            worker.agreedDailySalary ||
            worker.expectedDailySalary ||
            Math.floor(worker.expectedSalary / 7);
          const totalCost = signingBonus;

          if (money < totalCost) {
            showToast(
              isEn
                ? "❌ Not enough money for signing bonus!"
                : "❌ Nie stać Cię na bonus za podpis!"
            );
            return;
          }

          // Pobierz bonus za podpis
          if (signingBonus > 0) {
            money -= signingBonus;
          }

          // Ustaw kontrakt
          worker.hired = true;
          worker.currentDailySalary = dailySalary;
          worker.currentSalary = dailySalary * 7;
          worker.agreedBonus = worker.agreedBonus || worker.bonusPercent;
          worker.bonusPercent = worker.agreedBonus;
          worker.contractType = contractType;
          worker.canReduceSalary = contractType === "performance";
          worker.expectedPerformance = expectedPerf;
          worker.signingBonusPaid = signingBonus;
          worker.negotiationState = "accepted";
          worker.hiredAt = Date.now();

          worker.chatHistory.push({
            from: "worker",
            text: isEn
              ? `Great! I'm happy to join the team. Let's get to work!`
              : `Świetnie! Cieszę się, że dołączam do zespołu. Do pracy!`,
          });

          recalculateBusinessExpenses(businessIndex);
          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          showToast(`✅ ${isEn ? "Hired" : "Zatrudniono"} ${worker.name}!`);

          setTimeout(() => {
            closeModal("businessChat");
            openModal("businessDetail");
            renderBusinessDetail(businessIndex);
          }, 1000);
        }

        // Potwierdź budżet pracownika
        function confirmBudget(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";

          const budgetAmount =
            parseInt(document.getElementById("offerBudget")?.value) || 0;
          const companyBalance = business.companyBalance || 0;

          // Budżet płacony z konta firmowego
          if (budgetAmount > companyBalance) {
            showToast(
              isEn
                ? "❌ Not enough on company account! Work to earn more."
                : "❌ Za mało na koncie firmowym! Pracuj żeby zarobić więcej."
            );
            return;
          }

          // Pobierz z konta firmowego
          if (budgetAmount > 0) {
            business.companyBalance = companyBalance - budgetAmount;
          }

          worker.assignedBudget = budgetAmount;
          worker.offerBudget = budgetAmount;

          // Wiadomość gracza
          worker.chatHistory.push({
            from: "player",
            text: isEn
              ? `I'm assigning you a budget of ${budgetAmount} ${getCurrency()}.`
              : `Przyznaję Ci budżet w wysokości ${budgetAmount} ${getCurrency()}.`,
          });

          // Reakcja pracownika - może odmówić przy za niskim budżecie
          const expectedBudget = worker.expectedBudget || 1000;

          // Sprawdź czy pracownik odmówi
          if (budgetAmount < expectedBudget * 0.3) {
            // Bardzo niski budżet - duża szansa na odmowę
            const rejectChance = 0.7 - budgetAmount / expectedBudget;
            if (Math.random() < rejectChance) {
              // Zwróć pieniądze na konto firmowe
              business.companyBalance =
                (business.companyBalance || 0) + budgetAmount;
              worker.assignedBudget = 0;

              worker.chatHistory.push({
                from: "worker",
                text: isEn
                  ? `I'm sorry, but ${budgetAmount} ${getCurrency()} is too little. I need at least ${Math.floor(
                      expectedBudget * 0.5
                    )} to do my job properly. I can't accept this.`
                  : `Przepraszam, ale ${budgetAmount} ${getCurrency()} to za mało. Potrzebuję minimum ${Math.floor(
                      expectedBudget * 0.5
                    )} żeby dobrze wykonywać pracę. Nie mogę tego przyjąć.`,
              });
              worker.negotiationState = "budget_rejected";
              saveBusinesses(businesses);
              continueWorkerNegotiation(businessIndex, workerId);
              return;
            }
          }

          if (budgetAmount >= expectedBudget) {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "That's a good budget to start with!"
                : "To dobry budżet na początek!",
            });
          } else if (budgetAmount >= expectedBudget * 0.5) {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "It's less than I hoped, but I'll make it work."
                : "To mniej niż się spodziewałem, ale dam radę.",
            });
          } else if (budgetAmount > 0) {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "That's quite limited, but I'll do what I can."
                : "To dość ograniczony budżet, ale zrobię co mogę.",
            });
          } else {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "No budget? That will make my job very difficult..."
                : "Bez budżetu? To bardzo utrudni moją pracę...",
            });
          }

          // Przejdź do negocjacji płacy
          const dailySalary =
            worker.expectedDailySalary || Math.floor(worker.expectedSalary / 7);

          let reasonsText = isEn
            ? "Now, about my salary:"
            : "Teraz co do mojej pensji:";
          if (worker.priceReasons && worker.priceReasons.length > 0) {
            worker.priceReasons.forEach((r) => {
              reasonsText += `\n• ${getPriceReasonText(r.id)} (${r.mod})`;
            });
          }
          worker.chatHistory.push({ from: "worker", text: reasonsText });

          worker.chatHistory.push({
            from: "worker",
            text: isEn
              ? `I expect: ${dailySalary} ${getCurrency()}/day + ${
                  worker.bonusPercent
                }% commission.`
              : `Oczekuję: ${dailySalary} ${getCurrency()}/dzień + ${
                  worker.bonusPercent
                }% prowizji.`,
          });

          if (worker.signingBonus > 0) {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? `Plus a signing bonus of ${
                    worker.signingBonus
                  } ${getCurrency()}.`
                : `Plus bonus za podpis: ${
                    worker.signingBonus
                  } ${getCurrency()}.`,
            });
          }

          worker.negotiationState = "role_confirmed";
          saveBusinesses(businesses);
          continueWorkerNegotiation(businessIndex, workerId);
        }

        // Potwierdź rolę pracownika
        function confirmWorkerRole(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";

          const selectedRole =
            document.getElementById("selectWorkerRole")?.value || "service";
          const roles = getWorkerRoles();
          const roleInfo = roles[selectedRole];

          // Wiadomość gracza
          worker.chatHistory.push({
            from: "player",
            text: isEn
              ? `I'd like you to work as ${roleInfo.name}.`
              : `Chciałbym, żebyś pracował jako ${roleInfo.name}.`,
          });

          // Sprawdź czy pracownik się zgodzi na rolę
          // Szansa na odmowę jeśli rola inna niż preferowana
          if (selectedRole !== worker.preferredRole) {
            const acceptChance =
              0.6 + (worker.personality?.agreeableness || 0) * 0.3; // 60-90% szans
            if (Math.random() > acceptChance) {
              // Odmowa!
              worker.chatHistory.push({
                from: "worker",
                text: isEn
                  ? `I'm sorry, but I really want to work in ${
                      roles[worker.preferredRole].name
                    }. I can't accept this role.`
                  : `Przepraszam, ale naprawdę chcę pracować jako ${
                      roles[worker.preferredRole].name
                    }. Nie mogę przyjąć tej roli.`,
              });
              worker.chatHistory.push({
                from: "worker",
                text: isEn
                  ? "Would you reconsider? Or maybe we should part ways..."
                  : "Czy mógłbyś to przemyśleć? Albo może nasze drogi powinny się rozejść...",
              });
              worker.negotiationState = "role_rejected";
              saveBusinesses(businesses);
              continueWorkerNegotiation(businessIndex, workerId);
              return;
            }
          }

          worker.assignedRole = selectedRole;

          // Reakcja pracownika - zgoda
          if (selectedRole === worker.preferredRole) {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "Perfect, that's exactly what I wanted!"
                : "Świetnie, dokładnie o to mi chodziło!",
            });
          } else {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "That's not exactly what I had in mind, but I can adapt."
                : "To nie do końca to, co miałem na myśli, ale mogę się dostosować.",
            });
          }

          // Jeśli rola wymaga budżetu - pytaj o budżet
          if (roleInfo.needsBudget) {
            const expectedBudget = worker.expectedBudget || 1000;
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? `For this role I'll need a budget. I'd suggest starting with ${expectedBudget} ${getCurrency()}.`
                : `Do tej roli będę potrzebować budżetu. Proponuję zacząć od ${expectedBudget} ${getCurrency()}.`,
            });
            worker.negotiationState = "budget_negotiation";
          } else {
            // Przejdź do negocjacji warunków
            const dailySalary =
              worker.expectedDailySalary ||
              Math.floor(worker.expectedSalary / 7);

            // Powody ceny
            let reasonsText = isEn
              ? "Now, about my salary expectations:"
              : "Teraz co do moich oczekiwań płacowych:";
            if (worker.priceReasons && worker.priceReasons.length > 0) {
              worker.priceReasons.forEach((r) => {
                reasonsText += `\n• ${getPriceReasonText(r.id)} (${r.mod})`;
              });
            }
            worker.chatHistory.push({ from: "worker", text: reasonsText });

            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? `I expect: ${dailySalary} ${getCurrency()}/day + ${
                    worker.bonusPercent
                  }% commission.`
                : `Oczekuję: ${dailySalary} ${getCurrency()}/dzień + ${
                    worker.bonusPercent
                  }% prowizji.`,
            });

            if (worker.signingBonus > 0) {
              worker.chatHistory.push({
                from: "worker",
                text: isEn
                  ? `Plus a signing bonus of ${
                      worker.signingBonus
                    } ${getCurrency()}.`
                  : `Plus bonus za podpis: ${
                      worker.signingBonus
                    } ${getCurrency()}.`,
              });
            }

            // Tylko dla obsługi klientów podaj wydajność
            if (selectedRole === "service") {
              const perf = worker.expectedPerformance || 15;
              worker.chatHistory.push({
                from: "worker",
                text: isEn
                  ? `I can handle about ${perf} clients per day.`
                  : `Mogę obsłużyć około ${perf} klientów dziennie.`,
              });
            }

            worker.negotiationState = "role_confirmed";
          }

          saveBusinesses(businesses);
          continueWorkerNegotiation(businessIndex, workerId);
        }

        function respondToWorker(businessIndex, workerId, response) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          if (response === "accept_terms") {
            // Akceptuj warunki pracownika i przejdź do podpisu
            const dailySalary =
              worker.expectedDailySalary ||
              Math.floor(worker.expectedSalary / 7);
            worker.agreedDailySalary = dailySalary;
            worker.agreedBonusPercent = worker.bonusPercent;
            worker.agreedSigningBonus = worker.signingBonus || 0;
            worker.agreedContractType = "fixed";
            worker.agreedExpectedPerf = worker.expectedPerformance;

            worker.chatHistory.push({
              from: "player",
              text: isEn ? "I accept your terms." : "Akceptuję Twoje warunki.",
            });
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "Excellent! Let's sign the contract."
                : "Doskonale! Podpiszmy umowę.",
            });
            worker.negotiationState = "worker_accepted";
            saveBusinesses(businesses);
          } else if (response === "edit_details") {
            worker.chatHistory.push({
              from: "player",
              text: isEn
                ? "Let's discuss the details..."
                : "Omówmy szczegóły...",
            });
            worker.negotiationState = "editing_details";
            saveBusinesses(businesses);
          } else if (response === "back") {
            worker.negotiationState = "initial";
            saveBusinesses(businesses);
          } else if (response === "reject") {
            worker.chatHistory.push({ from: "player", text: t.rejectMsg });
            worker.chatHistory.push({
              from: "worker",
              text: t.workerUnderstandMsg,
            });
            worker.negotiationState = "rejected";

            business.workers = business.workers.filter(
              (w) => w.id !== workerId
            );
            saveBusinesses(businesses);

            setTimeout(() => {
              closeModal("businessChat");
              openModal("businessDetail");
              renderBusinessDetail(businessIndex);
            }, 1500);
          }

          continueWorkerNegotiation(businessIndex, workerId);
        }

        // Wyślij ofertę kontraktu
        function sendContractOffer(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";

          const offerDaily =
            parseInt(document.getElementById("offerDailySalary")?.value) ||
            worker.expectedDailySalary;
          const offerBonus =
            parseInt(document.getElementById("offerBonusPercent")?.value) ||
            worker.bonusPercent;
          const offerSigning =
            parseInt(document.getElementById("offerSigningBonus")?.value) || 0;
          const offerType =
            document.getElementById("offerContractType")?.value || "fixed";
          const offerPerf =
            parseInt(document.getElementById("offerExpectedPerf")?.value) ||
            worker.expectedPerformance;

          worker.offerDailySalary = offerDaily;
          worker.offerBonusPercent = offerBonus;
          worker.offerSigningBonus = offerSigning;
          worker.offerContractType = offerType;
          worker.offerExpectedPerf = offerPerf;

          worker.chatHistory.push({
            from: "player",
            text: isEn
              ? `My offer: ${offerDaily} ${getCurrency()}/day + ${offerBonus}% commission. Signing bonus: ${offerSigning} ${getCurrency()}. Contract: ${
                  offerType === "fixed" ? "fixed" : "performance-based"
                }.`
              : `Moja oferta: ${offerDaily} ${getCurrency()}/dzień + ${offerBonus}% prowizji. Bonus za podpis: ${offerSigning} ${getCurrency()}. Umowa: ${
                  offerType === "fixed" ? "stała" : "zależna od wyników"
                }.`,
          });

          const expectedDaily =
            worker.expectedDailySalary || Math.floor(worker.expectedSalary / 7);
          const expectedBonus = worker.bonusPercent;
          const expectedSigning = worker.signingBonus || 0;

          const offerValue = offerDaily + offerBonus * 10 + offerSigning * 0.1;
          const expectedValue =
            expectedDaily + expectedBonus * 10 + expectedSigning * 0.1;
          const ratio = offerValue / expectedValue;

          if (ratio >= 1.0) {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "This is a great offer! I accept."
                : "To świetna oferta! Akceptuję.",
            });
            worker.agreedDailySalary = offerDaily;
            worker.agreedBonusPercent = offerBonus;
            worker.agreedSigningBonus = offerSigning;
            worker.agreedContractType = offerType;
            worker.agreedExpectedPerf = offerPerf;
            worker.negotiationState = "worker_accepted";
          } else if (ratio >= 0.85) {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "It's less than I expected, but I can work with that."
                : "To mniej niż oczekiwałem, ale mogę się zgodzić.",
            });
            worker.agreedDailySalary = offerDaily;
            worker.agreedBonusPercent = offerBonus;
            worker.agreedSigningBonus = offerSigning;
            worker.agreedContractType = offerType;
            worker.agreedExpectedPerf = offerPerf;
            worker.negotiationState = "worker_accepted";
          } else if (ratio >= 0.7) {
            const counterDaily = Math.floor((offerDaily + expectedDaily) / 2);
            const counterBonus = Math.floor((offerBonus + expectedBonus) / 2);
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? `That's too low. How about ${counterDaily} ${getCurrency()}/day and ${counterBonus}% commission?`
                : `To za mało. Co powiesz na ${counterDaily} ${getCurrency()}/dzień i ${counterBonus}% prowizji?`,
            });
            worker.counterDailySalary = counterDaily;
            worker.counterBonusPercent = counterBonus;
            worker.negotiationState = "worker_counter";
          } else {
            worker.chatHistory.push({
              from: "worker",
              text: isEn
                ? "Sorry, that offer is too low for me."
                : "Przykro mi, ta oferta jest dla mnie za niska.",
            });
            worker.negotiationState = "initial";
          }

          saveBusinesses(businesses);
          continueWorkerNegotiation(businessIndex, workerId);
        }

        function acceptCounterOffer(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";

          worker.chatHistory.push({
            from: "player",
            text: isEn
              ? "Alright, I accept your counter-offer."
              : "Dobrze, akceptuję Twoją propozycję.",
          });
          worker.chatHistory.push({
            from: "worker",
            text: isEn
              ? "Great! Let's finalize the contract."
              : "Świetnie! Sfinalizujmy umowę.",
          });

          worker.agreedDailySalary = worker.counterDailySalary;
          worker.agreedBonusPercent = worker.counterBonusPercent;
          worker.agreedSigningBonus = worker.offerSigningBonus || 0;
          worker.agreedContractType = worker.offerContractType || "fixed";
          worker.agreedExpectedPerf =
            worker.offerExpectedPerf || worker.expectedPerformance;
          worker.negotiationState = "worker_accepted";

          saveBusinesses(businesses);
          continueWorkerNegotiation(businessIndex, workerId);
        }

        function signContract(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";

          const signingBonus = worker.agreedSigningBonus || 0;
          if (money < signingBonus) {
            showToast(
              isEn
                ? "❌ Not enough money for signing bonus!"
                : "❌ Nie stać Cię na bonus za podpis!"
            );
            return;
          }

          if (signingBonus > 0) money -= signingBonus;

          worker.hired = true;
          worker.currentDailySalary = worker.agreedDailySalary;
          worker.currentSalary = worker.agreedDailySalary * 7;
          worker.bonusPercent = worker.agreedBonusPercent;
          worker.contractType = worker.agreedContractType;
          worker.canReduceSalary = worker.agreedContractType === "performance";
          worker.expectedPerformance = worker.agreedExpectedPerf;
          worker.signingBonusPaid = signingBonus;
          worker.negotiationState = "accepted";
          worker.hiredAt = Date.now();

          worker.chatHistory.push({
            from: "worker",
            text: isEn
              ? "Contract signed! I'm ready to work."
              : "Umowa podpisana! Jestem gotowy do pracy.",
          });

          recalculateBusinessExpenses(businessIndex);
          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          showToast(`✅ ${isEn ? "Hired" : "Zatrudniono"} ${worker.name}!`);

          setTimeout(() => {
            closeModal("businessChat");
            openModal("businessDetail");
            renderBusinessDetail(businessIndex);
          }, 1000);
        }

        function sendBusinessChatInput() {
          const input = document.getElementById("businessChatInputField");
          const value = input.value.trim();
          if (!value) return;
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          const { businessId, targetId, awaitingInput } = currentBusinessChat;
          const businesses = getBusinesses();
          const business = businesses[businessId];
          const worker = business.workers.find((w) => w.id === targetId);
          if (!worker) return;

          if (awaitingInput === "salary_offer") {
            const offer = parseInt(value);
            if (isNaN(offer) || offer <= 0) {
              showToast(
                isEn ? "❌ Enter a valid amount!" : "❌ Wpisz prawidłową kwotę!"
              );
              return;
            }

            const expectedDaily =
              worker.expectedDailySalary ||
              Math.floor(worker.expectedSalary / 7);
            const minDaily =
              worker.minDailySalary || Math.floor(worker.minSalary / 7);

            worker.chatHistory.push({
              from: "player",
              text:
                (isEn ? "I propose " : "Proponuję ") +
                offer +
                " " +
                getCurrency() +
                (isEn ? " per day." : " dziennie."),
            });

            // Reakcja pracownika
            if (offer >= expectedDaily) {
              worker.chatHistory.push({
                from: "worker",
                text: isEn ? "That's a great offer!" : "To świetna oferta!",
              });
              worker.agreedDailySalary = offer;
              worker.expectedDailySalary = offer;
              worker.expectedSalary = offer * 7;
              worker.negotiationState = "contract_setup";
              worker.agreedBonus = worker.bonusPercent;
              saveBusinesses(businesses);
            } else if (offer >= minDaily) {
              const diff = expectedDaily - offer;
              if (diff < 20) {
                worker.chatHistory.push({
                  from: "worker",
                  text: isEn
                    ? "Alright, I can work with that."
                    : "Dobrze, mogę się na to zgodzić.",
                });
                worker.agreedDailySalary = offer;
                worker.expectedDailySalary = offer;
                worker.expectedSalary = offer * 7;
                worker.negotiationState = "contract_setup";
                worker.agreedBonus = worker.bonusPercent;
                saveBusinesses(businesses);
              } else {
                const counter = Math.floor((offer + expectedDaily) / 2);
                worker.chatHistory.push({
                  from: "worker",
                  text:
                    (isEn ? "How about " : "Co powiesz na ") +
                    counter +
                    " " +
                    getCurrency() +
                    (isEn ? " per day?" : " dziennie?"),
                });
                worker.expectedDailySalary = counter;
                worker.expectedSalary = counter * 7;
                worker.negotiationState = "initial";
                saveBusinesses(businesses);
              }
            } else {
              worker.chatHistory.push({
                from: "worker",
                text:
                  (isEn
                    ? "That's too low. I need at least "
                    : "To za mało. Potrzebuję minimum ") +
                  minDaily +
                  " " +
                  getCurrency() +
                  (isEn ? " per day." : " dziennie."),
              });
              worker.negotiationState = "initial";
              saveBusinesses(businesses);
            }

            input.value = "";
            currentBusinessChat.awaitingInput = null;
            continueWorkerNegotiation(businessId, targetId);
          } else if (awaitingInput === "bonus_offer") {
            const bonusOffer = parseInt(value);
            if (isNaN(bonusOffer) || bonusOffer < 0 || bonusOffer > 50) {
              showToast(
                isEn
                  ? "❌ Enter valid % (0-50)!"
                  : "❌ Wpisz poprawny % (0-50)!"
              );
              return;
            }

            worker.chatHistory.push({
              from: "player",
              text:
                (isEn ? "How about " : "Co powiesz na ") +
                bonusOffer +
                (isEn ? "% commission?" : "% prowizji?"),
            });

            // Reakcja pracownika na prowizję
            const expectedBonus = worker.bonusPercent;
            if (bonusOffer >= expectedBonus) {
              worker.chatHistory.push({
                from: "worker",
                text: isEn ? "That works for me!" : "To mi odpowiada!",
              });
              worker.agreedBonus = bonusOffer;
              worker.bonusPercent = bonusOffer;
              worker.negotiationState = "initial";
              saveBusinesses(businesses);
            } else if (bonusOffer >= expectedBonus * 0.5) {
              const dailySalary =
                worker.expectedDailySalary ||
                Math.floor(worker.expectedSalary / 7);
              const newDaily = Math.floor(
                dailySalary * (1 + (expectedBonus - bonusOffer) * 0.02)
              );
              worker.chatHistory.push({
                from: "worker",
                text:
                  (isEn ? "I can accept " : "Mogę zaakceptować ") +
                  bonusOffer +
                  (isEn ? "%, but I'd need " : "%, ale potrzebowałbym ") +
                  newDaily +
                  " " +
                  getCurrency() +
                  (isEn ? " per day then." : " dziennie wtedy."),
              });
              worker.agreedBonus = bonusOffer;
              worker.bonusPercent = bonusOffer;
              worker.expectedDailySalary = newDaily;
              worker.expectedSalary = newDaily * 7;
              worker.negotiationState = "initial";
              saveBusinesses(businesses);
            } else {
              worker.chatHistory.push({
                from: "worker",
                text:
                  (isEn
                    ? "That's too low. I need at least "
                    : "To za mało. Potrzebuję minimum ") +
                  Math.floor(expectedBonus * 0.7) +
                  "%.",
              });
              worker.negotiationState = "initial";
              saveBusinesses(businesses);
            }

            input.value = "";
            currentBusinessChat.awaitingInput = null;
            continueWorkerNegotiation(businessId, targetId);
          }
        }

        function talkToWorker(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker || !worker.hired) return;
          const isEn = currentLang === "en";
          const roles = getWorkerRoles();
          const positions = getWorkerPositions();

          currentBusinessChat = {
            type: "worker_talk",
            businessId: businessIndex,
            targetId: workerId,
            awaitingInput: null,
          };

          closeModal("businessDetail");
          openModal("businessChat");

          const titleEl = document.getElementById("businessChatTitle");
          if (titleEl)
            titleEl.textContent = `💬 ${isEn ? "Talk with" : "Rozmowa z"} ${
              worker.name
            }`;

          const messagesDiv = document.getElementById("businessChatMessages");
          const optionsDiv = document.getElementById("businessChatOptions");
          if (!messagesDiv || !optionsDiv) return;

          const satisfaction = worker.satisfaction || 100;
          const satEmoji =
            satisfaction > 70 ? "😊" : satisfaction > 40 ? "😐" : "😞";
          const roleInfo =
            roles[worker.assignedRole || "service"] || roles.service;
          const workerPosition = worker.position || "regular";
          const posInfo = positions[workerPosition] || positions.regular;
          const canReduce =
            worker.canReduceSalary || worker.contractType === "performance";

          messagesDiv.innerHTML = `
          <div style="margin-bottom: 12px;">
            <div style="display: inline-block; max-width: 85%; padding: 10px 15px; border-radius: 15px; background: #333;">
              ${satEmoji} ${
            isEn
              ? "Hi boss! How can I help?"
              : "Cześć szefie! W czym mogę pomóc?"
          }
            </div>
          </div>
          <div style="margin-bottom: 12px;">
            <div style="display: inline-block; max-width: 85%; padding: 10px 15px; border-radius: 15px; background: #333;">
              <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #444;">
                <strong>${
                  isEn ? "My current terms" : "Moje obecne warunki"
                }:</strong>
              </div>
              <div style="display: grid; gap: 5px; font-size: 0.9em;">
                <div>👔 ${
                  isEn ? "Position" : "Stanowisko"
                }: <span style="color: #f59e0b;">${posInfo.name}</span></div>
                <div>${roleInfo.icon} ${
            isEn ? "Role" : "Rola"
          }: <span style="color: #3b82f6;">${roleInfo.name}</span></div>
                <div>💰 ${
                  isEn ? "Salary" : "Pensja"
                }: <span style="color: #4ade80;">${
            worker.currentSalary
          } ${getCurrency()}/${isEn ? "wk" : "tyg"}</span></div>
                <div>📊 ${
                  isEn ? "Commission" : "Prowizja"
                }: <span style="color: #8b5cf6;">${
            worker.bonusPercent
          }%</span></div>
                <div>📝 ${
                  isEn ? "Contract" : "Umowa"
                }: <span style="color: #888;">${
            worker.contractType === "performance"
              ? isEn
                ? "Performance-based"
                : "Zależna od wyników"
              : isEn
              ? "Fixed"
              : "Stała"
          }</span></div>
                ${
                  worker.assignedBudget > 0
                    ? `<div>💵 ${
                        isEn ? "Budget" : "Budżet"
                      }: <span style="color: #f59e0b;">${
                        worker.assignedBudget - (worker.budgetSpent || 0)
                      } / ${
                        worker.assignedBudget
                      } ${getCurrency()}</span></div>`
                    : ""
                }
                <div>😊 ${
                  isEn ? "Satisfaction" : "Satysfakcja"
                }: <span style="color: ${
            satisfaction > 70
              ? "#4ade80"
              : satisfaction > 40
              ? "#f59e0b"
              : "#ef4444"
          };">${satisfaction}%</span></div>
                <div>📅 ${isEn ? "Days worked" : "Dni pracy"}: ${
            worker.daysWorked || 0
          }</div>
              </div>
            </div>
          </div>
        `;

          // Dostępne awanse
          const positionOrder = [
            "intern",
            "junior",
            "regular",
            "senior",
            "manager",
          ];
          const currentPosIndex = positionOrder.indexOf(workerPosition);
          const canPromote =
            currentPosIndex >= 0 && currentPosIndex < positionOrder.length - 1;
          const nextPosition = canPromote
            ? positionOrder[currentPosIndex + 1]
            : null;
          const nextPosInfo = nextPosition ? positions[nextPosition] : null;

          optionsDiv.innerHTML = `
          <div style="display: grid; gap: 8px;">
            ${
              canPromote
                ? `
              <button onclick="promoteWorker(${businessIndex}, '${workerId}')" style="padding: 12px; background: linear-gradient(145deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 8px; cursor: pointer; text-align: left;">
                ⬆️ ${isEn ? "Promote to" : "Awansuj na"} ${nextPosInfo.name} 
                <span style="opacity: 0.8; font-size: 0.85em;">(+30% ${
                  isEn ? "salary" : "pensji"
                })</span>
              </button>
            `
                : `
              <div style="padding: 12px; background: #333; color: #666; border-radius: 8px; text-align: center;">
                👔 ${isEn ? "Highest position" : "Najwyższe stanowisko"}
              </div>
            `
            }
            
            <button onclick="giveRaise(${businessIndex}, '${workerId}')" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; text-align: left;">
              💰 ${isEn ? "Give raise" : "Daj podwyżkę"} (+10%)
            </button>
            
            ${
              canReduce
                ? `
              <button onclick="reduceSalary(${businessIndex}, '${workerId}')" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; text-align: left;">
                📉 ${isEn ? "Reduce salary" : "Obniż pensję"} (-10%)
              </button>
            `
                : `
              <div style="padding: 10px; background: #333; color: #666; border-radius: 8px; font-size: 0.85em; text-align: center;">
                📝 ${
                  isEn
                    ? "Fixed contract - cannot reduce salary"
                    : "Umowa stała - nie można obniżyć pensji"
                }
              </div>
            `
            }
            
            ${
              roleInfo.needsBudget
                ? `
              <button onclick="adjustBudget(${businessIndex}, '${workerId}')" style="padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; text-align: left;">
                💵 ${isEn ? "Adjust budget" : "Zmień budżet"}
              </button>
            `
                : ""
            }
            
            <button onclick="closeModal('businessChat'); openModal('businessDetail'); renderBusinessDetail(${businessIndex});" style="padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ← ${isEn ? "Back" : "Wróć"}
            </button>
          </div>
        `;
        }

        function promoteWorker(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";
          const positions = getWorkerPositions();

          const positionOrder = [
            "intern",
            "junior",
            "regular",
            "senior",
            "manager",
          ];
          const workerPosition = worker.position || "regular";
          const currentPosIndex = positionOrder.indexOf(workerPosition);

          if (
            currentPosIndex >= positionOrder.length - 1 ||
            currentPosIndex === -1
          ) {
            showToast(
              isEn
                ? "❌ Already at highest position!"
                : "❌ Już na najwyższym stanowisku!"
            );
            return;
          }

          const newPosition = positionOrder[currentPosIndex + 1];
          const newPosInfo = positions[newPosition];

          worker.position = newPosition;
          worker.positionName = newPosInfo.name;
          worker.currentSalary = Math.floor(worker.currentSalary * 1.3); // +30% za awans
          worker.currentDailySalary = Math.floor(worker.currentSalary / 7);
          worker.satisfaction = Math.min(
            100,
            (worker.satisfaction || 100) + 25
          );

          recalculateBusinessExpenses(businessIndex);
          saveBusinesses(businesses);
          saveState();

          showToast(
            `⬆️ ${worker.name} ${isEn ? "promoted to" : "awansowany na"} ${
              newPosInfo.name
            }!`
          );
          talkToWorker(businessIndex, workerId);
        }

        function giveRaise(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";

          worker.currentSalary = Math.floor(worker.currentSalary * 1.1);
          worker.currentDailySalary = Math.floor(worker.currentSalary / 7);
          worker.satisfaction = Math.min(
            100,
            (worker.satisfaction || 100) + 15
          );

          recalculateBusinessExpenses(businessIndex);
          saveBusinesses(businesses);
          saveState();

          showToast(
            `💰 ${worker.name} ${
              isEn ? "got a raise to" : "dostał podwyżkę do"
            } ${worker.currentSalary}/${isEn ? "wk" : "tyg"}!`
          );
          talkToWorker(businessIndex, workerId);
        }

        function reduceSalary(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";

          // Sprawdź czy można obniżyć
          if (
            !worker.canReduceSalary &&
            worker.contractType !== "performance"
          ) {
            showToast(
              isEn
                ? "❌ Fixed contract - cannot reduce!"
                : "❌ Umowa stała - nie można obniżyć!"
            );
            return;
          }

          // Pracownik może odmówić jeśli zadowolenie niskie lub dobre wyniki
          const satisfaction = worker.satisfaction || 100;
          if (satisfaction < 50) {
            showToast(
              `😠 ${worker.name}: "${
                isEn
                  ? "No way! I'm already underpaid!"
                  : "Nie ma mowy! Już jestem za mało opłacany!"
              }"`
            );
            worker.satisfaction = Math.max(0, satisfaction - 10);
            saveBusinesses(businesses);
            talkToWorker(businessIndex, workerId);
            return;
          }

          // Obniż pensję
          worker.currentSalary = Math.floor(worker.currentSalary * 0.9);
          worker.currentDailySalary = Math.floor(worker.currentSalary / 7);
          worker.satisfaction = Math.max(0, satisfaction - 20);

          recalculateBusinessExpenses(businessIndex);
          saveBusinesses(businesses);
          saveState();

          showToast(
            `📉 ${worker.name} ${
              isEn ? "salary reduced to" : "pensja obniżona do"
            } ${worker.currentSalary}/${isEn ? "wk" : "tyg"}`
          );
          talkToWorker(businessIndex, workerId);
        }

        function adjustBudget(businessIndex, workerId) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = business.workers.find((w) => w.id === workerId);
          if (!worker) return;
          const isEn = currentLang === "en";

          const currentBudget = worker.assignedBudget || 0;
          const companyBalance = business.companyBalance || 0;

          const newBudget = prompt(
            isEn
              ? `Enter new budget (current: ${currentBudget}, company account: ${companyBalance}):`
              : `Podaj nowy budżet (obecny: ${currentBudget}, konto firmowe: ${companyBalance}):`,
            currentBudget
          );

          if (newBudget === null) return;

          const budgetNum = parseInt(newBudget) || 0;
          const difference = budgetNum - currentBudget;

          // Budżet płacony z konta firmowego
          if (difference > companyBalance) {
            showToast(
              isEn
                ? "❌ Not enough on company account!"
                : "❌ Za mało na koncie firmowym!"
            );
            return;
          }

          if (difference > 0) {
            business.companyBalance = companyBalance - difference;
          } else {
            // Zwrot niewydanego budżetu na konto firmowe
            const unusedOld = currentBudget - (worker.budgetSpent || 0);
            const unusedNew = Math.max(
              0,
              budgetNum - (worker.budgetSpent || 0)
            );
            const refund = unusedOld - unusedNew;
            if (refund > 0)
              business.companyBalance = (business.companyBalance || 0) + refund;
          }

          worker.assignedBudget = budgetNum;
          if (worker.budgetSpent > budgetNum) worker.budgetSpent = budgetNum;

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          showToast(
            `💵 ${
              isEn ? "Budget changed to" : "Budżet zmieniony na"
            } ${budgetNum} ${getCurrency()}`
          );
          talkToWorker(businessIndex, workerId);
        }

        function fireWorker(businessIndex, workerId) {
          if (!confirm("Na pewno zwolnić tego pracownika?")) return;

          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          business.workers = business.workers.filter((w) => w.id !== workerId);

          recalculateBusinessExpenses(businessIndex);
          saveBusinesses(businesses);
          saveState();

          renderBusinessDetail(businessIndex);
          showToast(
            "🚫 " + (translations[currentLang] || translations.en).workerFired
          );
        }

        function recalculateBusinessExpenses(businessIndex) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];

          let weeklyExpenses = 0;
          business.workers
            .filter((w) => w.hired)
            .forEach((w) => {
              weeklyExpenses += w.currentSalary || 0;
            });

          business.weeklyExpenses = weeklyExpenses;
          saveBusinesses(businesses);
        }

        function simulateBusinessDay(businessIndex) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          const hiredWorkers = business.workers.filter((w) => w.hired);
          if (hiredWorkers.length === 0) {
            showToast("❌ " + t.needWorkers);
            return;
          }

          // Oblicz produktywność
          let totalProductivity = 0;
          hiredWorkers.forEach((w) => {
            totalProductivity += w.productivity || 1;
          });
          const avgProductivity = totalProductivity / hiredWorkers.length;

          // Symuluj klientów
          const clientCount = Math.floor(
            business.clientsPerDay *
              avgProductivity *
              (0.7 + Math.random() * 0.6)
          );
          let dayIncome = 0;

          for (let i = 0; i < clientCount; i++) {
            const clientSpend = Math.floor(
              business.avgIncome * (0.5 + Math.random())
            );
            dayIncome += clientSpend;
          }

          // Oblicz prowizje dla pracowników
          let bonusesPaid = 0;
          const workerReports = [];
          hiredWorkers.forEach((w) => {
            const workerBonus = Math.floor(
              (dayIncome * (w.bonusPercent / 100)) / hiredWorkers.length
            );
            bonusesPaid += workerBonus;
            w.totalEarned = (w.totalEarned || 0) + workerBonus;
            w.daysWorked = (w.daysWorked || 0) + 1;
            workerReports.push({
              name: w.name,
              bonus: workerBonus,
              productivity: Math.round((w.productivity || 1) * 100),
            });
          });

          // RACHUNKI - zależne od wielkości firmy
          const electricityCost = Math.floor(
            50 + business.clientsPerDay * 3 + Math.random() * 30
          );
          const waterCost = Math.floor(
            20 + business.clientsPerDay * 1.5 + Math.random() * 15
          );
          const gasCost = Math.floor(
            30 + business.clientsPerDay * 2 + Math.random() * 20
          );
          const internetCost = 50;
          const rentCost = Math.floor(business.startCost * 0.002); // 0.2% kosztu startu dziennie
          const totalBills =
            electricityCost + waterCost + gasCost + internetCost + rentCost;

          const netIncome = dayIncome - bonusesPaid - totalBills;
          business.weeklyIncome = (business.weeklyIncome || 0) + netIncome;
          business.totalIncome = (business.totalIncome || 0) + dayIncome;
          business.totalExpenses =
            (business.totalExpenses || 0) + totalBills + bonusesPaid;

          // Dodaj do pieniędzy gracza
          money += netIncome;

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          // Pokaż modal z paragonem
          showDayReport({
            businessName: business.name,
            clients: clientCount,
            income: dayIncome,
            workers: workerReports,
            bonusesPaid: bonusesPaid,
            bills: {
              electricity: electricityCost,
              water: waterCost,
              gas: gasCost,
              internet: internetCost,
              rent: rentCost,
              total: totalBills,
            },
            netIncome: netIncome,
            businessIndex: businessIndex,
          });
        }

        function showDayReport(report) {
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          // Stwórz modal raportu
          let modal = document.getElementById("modalDayReport");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "modalDayReport";
            modal.className = "modal";
            modal.innerHTML = `<div class="modal-content" style="max-width: 450px;"><div id="dayReportContent"></div></div>`;
            document.body.appendChild(modal);
          }

          const content = document.getElementById("dayReportContent");
          const totalSalaries = report.salariesPaid || 0;
          const reviews = report.reviews || {
            positive: 0,
            negative: 0,
            neutral: 0,
            angry: 0,
          };
          const repChange = report.reputationChange || 0;
          const unserved = report.unservedClients || 0;
          const capacity = report.capacity || 0;

          content.innerHTML = `
          <div style="background: #1a1a2e; border-radius: 10px; padding: 20px; font-family: 'Courier New', monospace;">
            <div style="text-align: center; border-bottom: 2px dashed #444; padding-bottom: 15px; margin-bottom: 15px;">
              <div style="font-size: 1.5em; font-weight: bold;">🧾 ${
                isEn ? "DAILY REPORT" : "RAPORT DZIENNY"
              }</div>
              <div style="color: #888; margin-top: 5px;">${
                report.businessName
              }</div>
              <div style="color: #666; font-size: 0.85em;">${new Date().toLocaleDateString()}</div>
              ${
                report.ownerWorking
                  ? `<div style="color: #3b82f6; font-size: 0.8em; margin-top: 5px;">👔 ${
                      isEn ? "Owner working" : "Właściciel pracuje"
                    }</div>`
                  : ""
              }
            </div>
            
            <!-- KLIENCI -->
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #4ade80; font-weight: bold; margin-bottom: 8px;">👥 ${
                isEn ? "CUSTOMERS" : "KLIENCI"
              }</div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>${isEn ? "Potential" : "Potencjalnych"}:</span>
                <span>${report.potentialClients || report.clients}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>${isEn ? "Capacity" : "Zdolność obsługi"}:</span>
                <span>${capacity}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="color: #4ade80;">✅ ${
                  isEn ? "Served" : "Obsłużonych"
                }:</span>
                <span style="color: #4ade80; font-weight: bold;">${
                  report.clients
                }</span>
              </div>
              ${
                unserved > 0
                  ? `
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="color: #ef4444;">❌ ${
                  isEn ? "Unserved" : "Nieobsłużonych"
                }:</span>
                <span style="color: #ef4444; font-weight: bold;">${unserved}</span>
              </div>
              `
                  : ""
              }
            </div>
            
            <!-- PRZYCHÓD -->
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #4ade80; font-weight: bold; margin-bottom: 8px;">📈 ${
                isEn ? "INCOME" : "PRZYCHÓD"
              }</div>
              <div style="display: flex; justify-content: space-between;">
                <span>${isEn ? "From clients" : "Od klientów"}:</span>
                <span style="color: #4ade80;">+${report.income.toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <!-- OPINIE KLIENTÓW -->
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #8b5cf6; font-weight: bold; margin-bottom: 8px;">⭐ ${
                isEn ? "REVIEWS" : "OPINIE"
              }</div>
              <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                  <div style="font-size: 1.2em;">😊</div>
                  <div style="color: #4ade80; font-weight: bold;">${
                    reviews.positive
                  }</div>
                  <div style="font-size: 0.65em; color: #888;">${
                    isEn ? "Positive" : "Pozytywne"
                  }</div>
                </div>
                <div>
                  <div style="font-size: 1.2em;">😐</div>
                  <div style="color: #888; font-weight: bold;">${
                    reviews.neutral
                  }</div>
                  <div style="font-size: 0.65em; color: #888;">${
                    isEn ? "Neutral" : "Neutralne"
                  }</div>
                </div>
                <div>
                  <div style="font-size: 1.2em;">😠</div>
                  <div style="color: #ef4444; font-weight: bold;">${
                    reviews.negative - (reviews.angry || 0)
                  }</div>
                  <div style="font-size: 0.65em; color: #888;">${
                    isEn ? "Negative" : "Negatywne"
                  }</div>
                </div>
                ${
                  reviews.angry > 0
                    ? `
                <div>
                  <div style="font-size: 1.2em;">🤬</div>
                  <div style="color: #dc2626; font-weight: bold;">${
                    reviews.angry
                  }</div>
                  <div style="font-size: 0.65em; color: #888;">${
                    isEn ? "Angry" : "Wściekli"
                  }</div>
                </div>
                `
                    : ""
                }
              </div>
              <div style="text-align: center; margin-top: 8px; padding: 5px; background: rgba(139,92,246,0.1); border-radius: 5px;">
                <span>${isEn ? "Reputation" : "Reputacja"}: </span>
                <span style="color: ${
                  repChange >= 0 ? "#4ade80" : "#ef4444"
                }; font-weight: bold;">
                  ${repChange >= 0 ? "+" : ""}${repChange} → ${
            report.newReputation
          }%
                </span>
              </div>
            </div>
            
            <!-- PRACOWNICY -->
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #f59e0b; font-weight: bold; margin-bottom: 8px;">👷 ${
                isEn ? "WORKERS" : "PRACOWNICY"
              }</div>
              ${
                report.workers && report.workers.length > 0
                  ? report.workers
                      .map(
                        (w) => `
                <div style="display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 3px;">
                  <span>${w.name || "Pracownik"}</span>
                  <span style="color: #ef4444;">-${
                    (w.salary || 0) + (w.bonus || 0)
                  } ${getCurrency()}</span>
                </div>
                <div style="font-size: 0.7em; color: #666; margin-bottom: 5px; margin-left: 10px;">
                  💰 ${isEn ? "Salary" : "Pensja"}: ${w.salary || 0} + 🎁 ${
                          isEn ? "Bonus" : "Prowizja"
                        }: ${w.bonus || 0}
                </div>
              `
                      )
                      .join("")
                  : `<div style="color: #888; font-size: 0.9em;">${
                      isEn ? "No hired workers" : "Brak zatrudnionych"
                    }</div>`
              }
              ${
                report.workers && report.workers.length > 0
                  ? `
              <div style="display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold; border-top: 1px solid #333; padding-top: 5px;">
                <span>${isEn ? "Salaries" : "Pensje"}:</span>
                <span style="color: #ef4444;">-${totalSalaries.toLocaleString()} ${getCurrency()}</span>
              </div>`
                  : ""
              }
              <div style="display: flex; justify-content: space-between; font-weight: bold;">
                <span>${isEn ? "Commissions" : "Prowizje"}:</span>
                <span style="color: #ef4444;">-${(
                  report.bonusesPaid || 0
                ).toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <!-- RACHUNKI -->
            <div style="border-bottom: 1px dashed #444; padding-bottom: 10px; margin-bottom: 10px;">
              <div style="color: #ef4444; font-weight: bold; margin-bottom: 8px;">📋 ${
                isEn ? "BILLS" : "RACHUNKI"
              }</div>
              <div style="display: flex; justify-content: space-between; font-size: 0.85em;">
                <span>⚡ ${isEn ? "Electricity" : "Prąd"}</span>
                <span>-${report.bills.electricity} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.85em;">
                <span>💧 ${isEn ? "Water" : "Woda"}</span>
                <span>-${report.bills.water} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.85em;">
                <span>🔥 ${isEn ? "Gas" : "Gaz"}</span>
                <span>-${report.bills.gas} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.85em;">
                <span>🌐 Internet</span>
                <span>-${report.bills.internet} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.85em;">
                <span>🏠 ${isEn ? "Rent" : "Czynsz"}</span>
                <span>-${report.bills.rent} ${getCurrency()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold; border-top: 1px solid #333; padding-top: 5px;">
                <span>${isEn ? "Bills total" : "Rachunki razem"}:</span>
                <span style="color: #ef4444;">-${report.bills.total.toLocaleString()} ${getCurrency()}</span>
              </div>
            </div>
            
            <!-- PODSUMOWANIE -->
            <div style="text-align: center; padding-top: 10px; border-top: 2px dashed #444;">
              <div style="font-size: 0.9em; color: #888; margin-bottom: 5px;">
                ${report.income.toLocaleString()} - ${totalSalaries.toLocaleString()} - ${report.bonusesPaid.toLocaleString()} - ${report.bills.total.toLocaleString()}
              </div>
              <div style="font-size: 1.4em; font-weight: bold; color: ${
                report.netIncome >= 0 ? "#4ade80" : "#ef4444"
              };">
                ${isEn ? "NET PROFIT" : "ZYSK NETTO"}: ${
            report.netIncome >= 0 ? "+" : ""
          }${report.netIncome.toLocaleString()} ${getCurrency()}
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(139,92,246,0.1); border-radius: 8px;">
                <div style="color: #8b5cf6; font-weight: bold;">🏦 ${
                  isEn ? "Company Balance" : "Konto Firmowe"
                }</div>
                <div style="font-size: 1.2em; color: #8b5cf6; font-weight: bold;">${(
                  report.companyBalance || 0
                ).toLocaleString()} ${getCurrency()}</div>
              </div>
            </div>
            
            <button onclick="closeDayReport(${
              report.businessIndex
            })" style="width: 100%; padding: 15px; background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 1.1em;">
              ✅ OK
            </button>
          </div>
        `;

          modal.style.display = "flex";
        }

        function closeDayReport(businessIndex) {
          const modal = document.getElementById("modalDayReport");
          if (modal) modal.style.display = "none";
          renderBusinessDetail(businessIndex);
        }

        function closeBusiness(businessIndex) {
          const t = translations[currentLang] || translations.en;
          if (
            !confirm(
              currentLang === "en"
                ? "Close this business? You won't recover the startup cost."
                : "Na pewno zamknąć tę firmę? Nie odzyskasz kosztów założenia."
            )
          )
            return;

          const businesses = getBusinesses();
          businesses.splice(businessIndex, 1);
          saveBusinesses(businesses);
          saveState();

          closeModal("businessDetail");
          openModal("business");
          renderBusinessModal();
          showToast(
            "🗑️ " +
              (translations[currentLang] || translations.en).businessClosed
          );
        }

        function talkToClient(businessIndex, clientId) {
          // Implementacja obsługi klienta
          showToast("💬 System klientów w budowie...");
        }

        // ==================== SYSTEM BANKU I KREDYTÓW ====================

        function getCredits() {
          const save = getCurrentSave();
          if (!save) return [];
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          if (!save[modeKey]) {
            save[modeKey] = {
              money: 1500,
              garage: [],
              spent: 0,
              debt: 0,
              debtDeadline: null,
              totalTaxPaid: 0,
              health: 100,
              food: 1000,
              water: 1000,
              backpack: [],
              activeInsurances: [],
              businesses: [],
              credits: [],
              workExperience: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
              vouchersToSend: [],
              receivedVouchers: [],
            };
          }
          if (!save[modeKey].credits) save[modeKey].credits = [];
          return save[modeKey].credits;
        }

        function saveCredits(credits) {
          const save = getCurrentSave();
          if (!save) return;
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          if (!save[modeKey]) save[modeKey] = {};
          save[modeKey].credits = credits;
          saveState();
        }

        function renderBankModal() {
          const content = document.getElementById("bankContent");
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";
          const credits = getCredits();

          // Opcje kredytów
          const creditOptions = [
            { amount: 1000, interest: 5, months: 3 },
            { amount: 5000, interest: 8, months: 6 },
            { amount: 10000, interest: 10, months: 12 },
            { amount: 25000, interest: 12, months: 12 },
            { amount: 50000, interest: 15, months: 24 },
            { amount: 100000, interest: 18, months: 36 },
          ];

          content.innerHTML = `
          <div style="background: rgba(16,185,129,0.1); border: 1px solid #10b981; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #10b981; margin-bottom: 15px;">💰 ${
              t.takeCredit
            }</h3>
            <div style="max-height: 200px; overflow-y: auto;">
              ${creditOptions
                .map((opt, i) => {
                  const monthlyRate = Math.ceil(
                    (opt.amount * (1 + opt.interest / 100)) / opt.months
                  );
                  const total = monthlyRate * opt.months;
                  return `
                <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-size: 1.2em; font-weight: bold; color: #4ade80;">${opt.amount.toLocaleString()} ${getCurrency()}</div>
                      <div style="color: #888; font-size: 0.85em;">${
                        opt.interest
                      }% • ${opt.months} ${t.months}</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="color: #f59e0b;">${monthlyRate}/${
                    isEn ? "mo" : "msc"
                  }</div>
                      <button onclick="takeCredit(${opt.amount}, ${
                    opt.interest
                  }, ${
                    opt.months
                  })" style="padding: 8px 15px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px;">
                        ${t.takeCredit}
                      </button>
                    </div>
                  </div>
                </div>
              `;
                })
                .join("")}
            </div>
          </div>
          
          <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 15px; border-radius: 10px;">
            <h3 style="color: #ef4444; margin-bottom: 15px;">📋 ${
              t.yourCredits
            } (${credits.length})</h3>
            ${
              credits.length === 0
                ? `
              <p style="color: #666; text-align: center;">${t.noCredits}</p>
            `
                : `
              <div style="max-height: 250px; overflow-y: auto;">
                ${credits
                  .map((cr, i) => {
                    // Oblicz czas do następnej raty lub termin płatności
                    const now = Date.now();
                    const MONTH_MS = 30 * 24 * 60 * 60 * 1000;
                    let statusHtml = "";

                    if (cr.rateDue && cr.rateDueDate) {
                      // Rata do zapłaty!
                      const remaining = cr.rateDueDate - now;
                      if (remaining > 0) {
                        const days = Math.floor(
                          remaining / (24 * 60 * 60 * 1000)
                        );
                        const hours = Math.floor(
                          (remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000)
                        );
                        statusHtml =
                          '<div style="background: #ef4444; color: white; padding: 5px 10px; border-radius: 5px; margin-top: 8px; text-align: center; font-weight: bold;">⚠️ ' +
                          (isEn ? "PAY NOW! " : "ZAPŁAĆ! ") +
                          days +
                          "d " +
                          hours +
                          "h " +
                          (isEn ? "left" : "zostało") +
                          "</div>";
                      } else {
                        statusHtml =
                          '<div style="background: #dc2626; color: white; padding: 5px 10px; border-radius: 5px; margin-top: 8px; text-align: center; font-weight: bold;">🚨 ' +
                          (isEn ? "OVERDUE!" : "PO TERMINIE!") +
                          "</div>";
                      }
                    } else {
                      // Czas do następnej raty
                      const timeSince = now - (cr.lastPayment || cr.takenAt);
                      const timeToNext = MONTH_MS - timeSince;
                      if (timeToNext > 0) {
                        const days = Math.floor(
                          timeToNext / (24 * 60 * 60 * 1000)
                        );
                        statusHtml =
                          '<div style="color: #888; font-size: 0.8em; margin-top: 5px;">📅 ' +
                          (isEn
                            ? "Next installment in "
                            : "Następna rata za ") +
                          days +
                          (isEn ? " days" : " dni") +
                          "</div>";
                      }
                    }

                    return `
                  <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; ${
                    cr.rateDue ? "border: 2px solid #ef4444;" : ""
                  } ${
                      (cr.missedPayments || 0) >= 2
                        ? "border: 2px solid #dc2626; box-shadow: 0 0 10px rgba(220,38,38,0.5);"
                        : ""
                    }">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-weight: bold;">${cr.originalAmount.toLocaleString()} ${getCurrency()}</div>
                        <div style="color: #888; font-size: 0.85em;">${
                          t.remaining
                        }: ${cr.remainingAmount.toLocaleString()} ${getCurrency()}</div>
                        <div style="color: #888; font-size: 0.85em;">${
                          cr.remainingMonths
                        } ${t.months} • ${cr.monthlyPayment}/${
                      isEn ? "mo" : "msc"
                    }</div>
                        ${
                          (cr.missedPayments || 0) > 0
                            ? '<div style="color: #ef4444; font-size: 0.85em; margin-top: 3px;">⚠️ ' +
                              (isEn ? "Warnings: " : "Ostrzeżenia: ") +
                              cr.missedPayments +
                              "/3</div>"
                            : ""
                        }
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button onclick="payCreditRate(${i})" style="padding: 6px 12px; background: ${
                      cr.rateDue ? "#ef4444" : "#f59e0b"
                    }; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                          ${t.payRate} (${cr.monthlyPayment})
                        </button>
                        <button onclick="payCreditOff(${i})" style="padding: 6px 12px; background: #333; color: white; border: 1px solid #666; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                          ${t.payOff} (${cr.remainingAmount})
                        </button>
                      </div>
                    </div>
                    ${statusHtml}
                    ${
                      (cr.missedPayments || 0) >= 2
                        ? '<div style="background: #dc2626; color: white; padding: 8px; border-radius: 5px; margin-top: 8px; text-align: center; font-weight: bold;">🚔 ' +
                          (isEn
                            ? "DEBT COLLECTOR COMING SOON!"
                            : "WINDYKACJA JUŻ NIEDŁUGO!") +
                          "</div>"
                        : ""
                    }
                  </div>
                `;
                  })
                  .join("")}
              </div>
            `
            }
          </div>
        `;
        }

        function takeCredit(amount, interest, months) {
          const t = translations[currentLang] || translations.en;
          const monthlyPayment = Math.ceil(
            (amount * (1 + interest / 100)) / months
          );
          const totalToRepay = monthlyPayment * months;

          const credit = {
            id: Date.now().toString(),
            originalAmount: amount,
            totalToRepay: totalToRepay,
            remainingAmount: totalToRepay,
            monthlyPayment: monthlyPayment,
            remainingMonths: months,
            interest: interest,
            takenAt: Date.now(),
            lastPayment: Date.now(),
          };

          const credits = getCredits();
          credits.push(credit);
          saveCredits(credits);

          money += amount;
          saveState();
          updateAllDisplays();
          renderBankModal();

          showToast(
            `✅ ${t.creditTaken} +${amount.toLocaleString()} ${getCurrency()}`
          );
        }

        function payCreditRate(creditIndex) {
          const t = translations[currentLang] || translations.en;
          const credits = getCredits();
          const credit = credits[creditIndex];
          if (!credit) return;

          if (money < credit.monthlyPayment) {
            showToast(`❌ ${t.notEnoughForRate}`);
            return;
          }

          money -= credit.monthlyPayment;
          credit.remainingAmount -= credit.monthlyPayment;
          credit.remainingMonths--;
          credit.lastPayment = Date.now();
          credit.rateDue = false;
          credit.rateDueDate = null;

          if (credit.remainingMonths <= 0 || credit.remainingAmount <= 0) {
            credits.splice(creditIndex, 1);
            showToast(`🎉 ${t.creditPaidOff}`);
          } else {
            showToast(
              `✅ ${t.ratePaid}: -${credit.monthlyPayment} ${getCurrency()}`
            );
          }

          saveCredits(credits);
          saveState();
          updateAllDisplays();
          renderBankModal();
        }

        function payCreditOff(creditIndex) {
          const t = translations[currentLang] || translations.en;
          const credits = getCredits();
          const credit = credits[creditIndex];
          if (!credit) return;

          if (money < credit.remainingAmount) {
            showToast(`❌ ${t.notEnoughForRate}`);
            return;
          }

          money -= credit.remainingAmount;
          credits.splice(creditIndex, 1);

          saveCredits(credits);
          saveState();
          updateAllDisplays();
          renderBankModal();

          showToast(`🎉 ${t.creditPaidOff}`);
        }

        // Automatyczne raty kredytów (co miesiąc = 30 dni w grze)
        function processCreditPayments() {
          const credits = getCredits();
          const now = Date.now();
          const MONTH_MS = 30 * 24 * 60 * 60 * 1000; // 30 dni - cykl raty
          const GRACE_PERIOD_MS = 7 * 24 * 60 * 60 * 1000; // 7 dni na spłatę
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";
          let changed = false;

          credits.forEach((credit, i) => {
            const timeSincePayment =
              now - (credit.lastPayment || credit.takenAt);

            // Sprawdź czy minął miesiąc - czas na nową ratę
            if (timeSincePayment >= MONTH_MS && !credit.rateDue) {
              credit.rateDue = true;
              credit.rateDueDate = now + GRACE_PERIOD_MS;
              credit.missedPayments = credit.missedPayments || 0;
              changed = true;
              showToast(
                `💳 ${
                  isEn ? "Loan installment due!" : "Rata kredytu do zapłaty!"
                } ${credit.monthlyPayment} ${getCurrency()} (7 ${
                  isEn ? "days" : "dni"
                })`
              );
            }

            // Sprawdź czy minął termin płatności raty
            if (credit.rateDue && now > credit.rateDueDate) {
              // Termin minął - kara!
              credit.remainingAmount = Math.ceil(credit.remainingAmount * 1.05);
              credit.rateDue = false;
              credit.rateDueDate = null;
              credit.lastPayment = now;
              credit.missedPayments = (credit.missedPayments || 0) + 1;
              changed = true;

              // Konsekwencje za niespłacanie
              if (credit.missedPayments === 1) {
                showToast(
                  `⚠️ ${
                    isEn
                      ? "Missed payment! +5% penalty. Warning!"
                      : "Nieopłacona rata! +5% kary. Ostrzeżenie!"
                  }`
                );
              } else if (credit.missedPayments === 2) {
                showToast(
                  `🚨 ${
                    isEn
                      ? "2nd missed payment! Debt collector warning!"
                      : "Druga nieopłacona rata! Ostrzeżenie od windykacji!"
                  }`
                );
              } else if (credit.missedPayments >= 3) {
                // Windykacja - zabierają co mają
                showToast(
                  `🚔 ${
                    isEn
                      ? "DEBT COLLECTOR! Seizing assets..."
                      : "WINDYKACJA! Zajmowanie majątku..."
                  }`
                );

                // Zabierz pieniądze
                const seized = Math.min(money, credit.monthlyPayment * 2);
                if (seized > 0) {
                  money -= seized;
                  credit.remainingAmount -= seized;
                  showToast(
                    `💸 ${
                      isEn ? "Seized" : "Zajęto"
                    }: ${seized} ${getCurrency()}`
                  );
                }

                // Zabierz samochód jeśli jest
                const save = getCurrentSave();
                if (save.data.cars && save.data.cars.length > 0) {
                  const carValue = Math.floor(
                    (save.data.cars[0].price || 10000) * 0.3
                  );
                  credit.remainingAmount -= carValue;
                  showToast(
                    `🚗 ${
                      isEn ? "Car seized! Value" : "Samochód zajęty! Wartość"
                    }: ${carValue} ${getCurrency()}`
                  );
                  save.data.cars = [];
                  save.data.currentCar = null;
                }

                // Zamknij firmy jeśli dług wciąż duży
                if (credit.remainingAmount > credit.monthlyPayment * 3) {
                  const businesses = getBusinesses();
                  if (businesses.length > 0) {
                    const biz = businesses[0];
                    const bizValue = Math.floor(biz.startCost * 0.2);
                    credit.remainingAmount -= bizValue;
                    businesses.splice(0, 1);
                    saveBusinesses(businesses);
                    showToast(
                      `🏢 ${isEn ? "Business seized!" : "Firma zajęta!"} ${
                        biz.name
                      } (-${bizValue} ${getCurrency()})`
                    );
                  }
                }

                credit.missedPayments = 0; // Reset po windykacji
                saveState();
              }
            }
          });

          // Usuń spłacone kredyty
          const activeCredits = credits.filter((c) => c.remainingAmount > 0);

          if (changed) {
            saveCredits(activeCredits);
            updateAllDisplays();
          }
        }

        // Uruchom sprawdzanie rat co minutę
        setInterval(processCreditPayments, 60000);

        // Dodaj obsługę modalu firm i banku do openModal
        const originalOpenModal = openModal;
        openModal = function (type) {
          originalOpenModal(type);
          if (type === "business") {
            renderBusinessModal();
          } else if (type === "bank") {
            renderBankModal();
          }
        };

        // ==================== AUTOMATYCZNE DNI ROBOCZE ====================

        // ========== SYSTEM POWIADOMIEŃ OD PRACOWNIKÓW I BIZNESU ==========

        function getWorkerNotifications() {
          const save = getCurrentSave();
          if (!save) return [];
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          if (!save[modeKey]) return [];
          return save[modeKey].workerNotifications || [];
        }

        function saveWorkerNotifications(notifications) {
          const save = getCurrentSave();
          if (!save) return;
          const modeKey =
            gameMode === "reallife" ? "realLifeData" : "beamngData";
          if (!save[modeKey]) save[modeKey] = {};
          save[modeKey].workerNotifications = notifications;

          // Zapisz cały obiekt saves
          try {
            localStorage.setItem("beamng_saves", JSON.stringify(saves));
          } catch (e) {
            console.error("Error saving notifications:", e);
          }
        }

        function addWorkerNotification(
          businessIndex,
          workerId,
          type,
          message,
          extra = {}
        ) {
          const notifications = getWorkerNotifications();
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const worker = workerId
            ? business?.workers?.find((w) => w.id === workerId)
            : null;

          const notifId =
            "wn_" + Date.now() + "_" + Math.random().toString(36).substr(2, 6);

          notifications.push({
            id: notifId,
            businessIndex: businessIndex,
            businessName: business?.name || "Firma",
            workerId: workerId,
            workerName: worker?.name || extra.workerName || null,
            type: type,
            message: message,
            timestamp: Date.now(),
            read: false,
            ...extra,
          });

          // Trzymaj max 50 powiadomień
          while (notifications.length > 50) {
            notifications.shift();
          }

          saveWorkerNotifications(notifications);
          updateWorkerNotificationBadge();

          // ==================== MEGA TOAST DLA WAŻNYCH POWIADOMIEŃ ====================
          const importantTypes = [
            "quit_warning",
            "raise_request",
            "client_review_bad",
            "low_cleanliness",
            "unhappy",
          ];
          const infoTypes = [
            "new_candidate",
            "day_end",
            "client_review_good",
            "promotion_bought",
          ];

          const isEn = currentLang === "en";

          // Konfiguracja typów
          const typeConfig = {
            quit_warning: {
              icon: "⚠️",
              title: isEn ? "Quit Warning!" : "Groźba odejścia!",
              type: "error",
            },
            raise_request: {
              icon: "💰",
              title: isEn ? "Salary Request" : "Prośba o podwyżkę",
              type: "warning",
            },
            client_review_bad: {
              icon: "😠",
              title: isEn ? "Bad Review!" : "Zła opinia!",
              type: "error",
            },
            client_review_good: {
              icon: "😊",
              title: isEn ? "Great Review!" : "Świetna opinia!",
              type: "success",
            },
            low_cleanliness: {
              icon: "⚠️",
              title: isEn ? "Low Cleanliness!" : "Niska czystość!",
              type: "warning",
            },
            unhappy: {
              icon: "😤",
              title: isEn ? "Unhappy Worker" : "Niezadowolony pracownik",
              type: "warning",
            },
            new_candidate: {
              icon: "📋",
              title: isEn ? "New Candidate" : "Nowy kandydat",
              type: "info",
            },
            day_end: {
              icon: "📊",
              title: isEn ? "Daily Report" : "Raport dzienny",
              type: "success",
            },
            promotion_bought: {
              icon: "📢",
              title: isEn ? "Promotion Active" : "Promocja aktywna",
              type: "success",
            },
          };

          // Pokaż toast dla ważnych i informacyjnych powiadomień
          if (importantTypes.includes(type) || infoTypes.includes(type)) {
            const config = typeConfig[type] || {
              icon: "🔔",
              title: isEn ? "Notification" : "Powiadomienie",
              type: "notification",
            };

            showToast(message, {
              icon: config.icon,
              title: `${config.title} • ${worker?.name || business?.name}`,
              type: config.type,
              duration: importantTypes.includes(type) ? 6000 : 4000,
              businessIndex: businessIndex,
              workerId: workerId,
              notificationType: type,
            });
          }
        }

        // Powiadomienie o nowym kliencie i opinii
        function notifyClientReview(businessIndex, client) {
          const isEn = currentLang === "en";
          const rating = client.rating || 3;
          const stars = "⭐".repeat(Math.floor(rating));

          let type, message;
          if (rating >= 4) {
            type = "client_review_good";
            message = `${stars} "${client.text}"`;
          } else if (rating >= 3) {
            type = "client_review_neutral";
            message = `${stars} "${client.text}"`;
          } else {
            type = "client_review_bad";
            message = `${stars} "${client.text}"`;
          }

          addWorkerNotification(businessIndex, null, type, message, {
            clientSpent: client.spent,
            rating: rating,
          });
        }

        // Powiadomienie o kupionej promocji
        function notifyPromotionBought(
          businessIndex,
          workerName,
          promoName,
          cost
        ) {
          const isEn = currentLang === "en";
          const message = isEn
            ? `Bought promotion "${promoName}" for ${cost} ${getCurrency()}`
            : `Kupił promocję "${promoName}" za ${cost} ${getCurrency()}`;

          addWorkerNotification(
            businessIndex,
            null,
            "promotion_bought",
            message,
            {
              workerName: workerName,
              promoName: promoName,
              cost: cost,
            }
          );
        }

        // Powiadomienie o zmianie cen przez pricing workera
        function notifyPriceChange(
          businessIndex,
          workerName,
          oldPrice,
          newPrice
        ) {
          const isEn = currentLang === "en";
          const direction = newPrice > oldPrice ? "📈" : "📉";
          const message = isEn
            ? `${direction} Adjusted prices: ${Math.round(
                oldPrice * 100
              )}% → ${Math.round(newPrice * 100)}%`
            : `${direction} Zmienił ceny: ${Math.round(
                oldPrice * 100
              )}% → ${Math.round(newPrice * 100)}%`;

          addWorkerNotification(businessIndex, null, "price_change", message, {
            workerName: workerName,
          });
        }

        // Powiadomienie o sprzątaniu
        function notifyCleaningDone(businessIndex, workerName, cleanliness) {
          const isEn = currentLang === "en";
          const message = isEn
            ? `🧹 Cleaned! Cleanliness now: ${Math.round(cleanliness)}%`
            : `🧹 Posprzątane! Czystość teraz: ${Math.round(cleanliness)}%`;

          addWorkerNotification(businessIndex, null, "cleaning_done", message, {
            workerName: workerName,
          });
        }

        // Powiadomienie o niskiej czystości
        function notifyLowCleanliness(businessIndex, cleanliness) {
          const isEn = currentLang === "en";
          const message = isEn
            ? `⚠️ Cleanliness critical: ${Math.round(
                cleanliness
              )}%! Hire a cleaner!`
            : `⚠️ Czystość krytyczna: ${Math.round(
                cleanliness
              )}%! Zatrudnij sprzątacza!`;

          addWorkerNotification(
            businessIndex,
            null,
            "low_cleanliness",
            message
          );
        }

        // Powiadomienie o nowym kandydacie
        function notifyNewCandidate(businessIndex, candidateName, position) {
          const isEn = currentLang === "en";
          const message = isEn
            ? `📋 New candidate: ${candidateName} (${position})`
            : `📋 Nowy kandydat: ${candidateName} (${position})`;

          addWorkerNotification(businessIndex, null, "new_candidate", message, {
            candidateName: candidateName,
          });
        }

        // Powiadomienie o zakończeniu dnia
        function notifyDayEnd(businessIndex, income, clients, reputation) {
          const isEn = currentLang === "en";
          const message = isEn
            ? `📊 Day ended: ${clients} clients, +${income.toLocaleString()} ${getCurrency()}, rep: ${reputation}%`
            : `📊 Dzień zakończony: ${clients} klientów, +${income.toLocaleString()} ${getCurrency()}, rep: ${reputation}%`;

          addWorkerNotification(businessIndex, null, "day_end", message, {
            income: income,
            clients: clients,
          });
        }

        function updateWorkerNotificationBadge() {
          // Użyj głównej funkcji updateNotificationBadge
          updateNotificationBadge();
        }

        // ==================== FILTR POWIADOMIEŃ ====================
        let currentNotificationFilter = "all";

        function renderNotificationFilters() {
          const container = document.getElementById("notificationFilters");
          if (!container) return;

          const notifications = getWorkerNotifications();
          const isEn = currentLang === "en";

          // Policz według typu
          const typeCounts = {};
          notifications.forEach((n) => {
            const category = getNotificationCategory(n.type);
            typeCounts[category] = (typeCounts[category] || 0) + 1;
          });

          const filters = [
            {
              id: "all",
              label: isEn ? "All" : "Wszystkie",
              icon: "📋",
              count: notifications.length,
            },
            {
              id: "worker",
              label: isEn ? "Workers" : "Pracownicy",
              icon: "👷",
              count: typeCounts.worker || 0,
            },
            {
              id: "client",
              label: isEn ? "Reviews" : "Opinie",
              icon: "⭐",
              count: typeCounts.client || 0,
            },
            {
              id: "business",
              label: isEn ? "Business" : "Firma",
              icon: "🏢",
              count: typeCounts.business || 0,
            },
            {
              id: "unread",
              label: isEn ? "Unread" : "Nieprzeczytane",
              icon: "🔵",
              count: notifications.filter((n) => !n.read).length,
            },
          ];

          container.innerHTML = filters
            .map(
              (f) => `
          <button class="notif-filter-btn ${
            currentNotificationFilter === f.id ? "active" : ""
          }" 
                  onclick="setNotificationFilter('${f.id}')"
                  ${
                    f.count === 0 && f.id !== "all" ? 'style="opacity:0.5"' : ""
                  }>
            ${f.icon} ${f.label}
            ${
              f.count > 0
                ? `<span class="notif-filter-count">${f.count}</span>`
                : ""
            }
          </button>
        `
            )
            .join("");
        }

        function getNotificationCategory(type) {
          if (
            [
              "raise_request",
              "unhappy",
              "quit_warning",
              "hours_complaint",
              "budget_request",
            ].includes(type)
          )
            return "worker";
          if (
            [
              "client_review_good",
              "client_review_neutral",
              "client_review_bad",
            ].includes(type)
          )
            return "client";
          return "business";
        }

        function setNotificationFilter(filter) {
          currentNotificationFilter = filter;
          renderNotificationFilters();
          renderWorkerNotifications();
        }

        function renderWorkerNotifications() {
          const container = document.getElementById("notificationsList");
          if (!container) return;

          let notifications = getWorkerNotifications();
          const isEn = currentLang === "en";

          // Renderuj filtry
          renderNotificationFilters();

          console.log("Worker notifications:", notifications);

          // Filtrowanie
          if (currentNotificationFilter === "unread") {
            notifications = notifications.filter((n) => !n.read);
          } else if (currentNotificationFilter !== "all") {
            notifications = notifications.filter(
              (n) =>
                getNotificationCategory(n.type) === currentNotificationFilter
            );
          }

          if (notifications.length === 0) {
            // Sprawdź czy są firmy
            const businesses = getBusinesses();
            const hasBusinesses = businesses && businesses.length > 0;
            const hasHiredWorkers = businesses?.some((b) =>
              b.workers?.some((w) => w.hired)
            );

            let emptyTitle = isEn ? "No notifications" : "Brak powiadomień";
            let emptyMsg = "";

            if (currentNotificationFilter !== "all") {
              emptyMsg = isEn
                ? "No notifications in this category"
                : "Brak powiadomień w tej kategorii";
            } else if (!hasBusinesses) {
              emptyMsg = isEn
                ? "Create a business to receive notifications"
                : "Stwórz firmę aby otrzymywać powiadomienia";
            } else if (!hasHiredWorkers) {
              emptyMsg = isEn
                ? "Hire workers to get employee notifications"
                : "Zatrudnij pracowników aby otrzymywać powiadomienia";
            } else {
              emptyMsg = isEn
                ? "All caught up! Check back later."
                : "Wszystko przejrzane! Sprawdź później.";
            }

            container.innerHTML = `
            <div class="notifications-empty">
              <div class="notifications-empty-icon">📭</div>
              <h3>${emptyTitle}</h3>
              <p>${emptyMsg}</p>
            </div>
          `;
            return;
          }

          // Sortuj od najnowszych
          const sorted = [...notifications].sort(
            (a, b) => b.timestamp - a.timestamp
          );

          const typeConfig = {
            raise_request: {
              icon: "💰",
              color: "#f59e0b",
              action: "chat",
              label: isEn ? "Salary request" : "Prośba o podwyżkę",
            },
            unhappy: {
              icon: "😤",
              color: "#ef4444",
              action: "chat",
              label: isEn ? "Unhappy" : "Niezadowolony",
            },
            quit_warning: {
              icon: "⚠️",
              color: "#ef4444",
              action: "chat",
              label: isEn ? "Quit warning" : "Groźba odejścia",
            },
            hours_complaint: {
              icon: "🕐",
              color: "#f59e0b",
              action: "chat",
              label: isEn ? "Hours complaint" : "Skarga na godziny",
            },
            budget_request: {
              icon: "💵",
              color: "#f59e0b",
              action: "chat",
              label: isEn ? "Budget request" : "Prośba o budżet",
            },
            client_review_good: {
              icon: "😊",
              color: "#4ade80",
              action: "review",
              label: isEn ? "Good review" : "Dobra opinia",
            },
            client_review_neutral: {
              icon: "😐",
              color: "#6b7280",
              action: "review",
              label: isEn ? "Neutral review" : "Neutralna opinia",
            },
            client_review_bad: {
              icon: "😠",
              color: "#ef4444",
              action: "review",
              label: isEn ? "Bad review" : "Zła opinia",
            },
            promotion_bought: {
              icon: "📢",
              color: "#8b5cf6",
              action: "business",
              label: isEn ? "Promotion" : "Promocja",
            },
            price_change: {
              icon: "💰",
              color: "#3b82f6",
              action: "business",
              label: isEn ? "Price change" : "Zmiana cen",
            },
            cleaning_done: {
              icon: "🧹",
              color: "#10b981",
              action: "business",
              label: isEn ? "Cleaning" : "Sprzątanie",
            },
            low_cleanliness: {
              icon: "⚠️",
              color: "#ef4444",
              action: "business",
              label: isEn ? "Low cleanliness" : "Niska czystość",
            },
            new_candidate: {
              icon: "📋",
              color: "#3b82f6",
              action: "business",
              label: isEn ? "New candidate" : "Nowy kandydat",
            },
            day_end: {
              icon: "📊",
              color: "#4ade80",
              action: "business",
              label: isEn ? "Daily report" : "Raport dzienny",
            },
            test_welcome: {
              icon: "🎉",
              color: "#8b5cf6",
              action: "business",
              label: isEn ? "Welcome" : "Powitanie",
            },
          };

          container.innerHTML = sorted
            .map((n) => {
              const time = new Date(n.timestamp);
              const now = new Date();
              let timeStr;

              const diffMs = now - time;
              const diffMins = Math.floor(diffMs / 60000);
              const diffHours = Math.floor(diffMs / 3600000);

              if (diffMins < 1) {
                timeStr = isEn ? "Just now" : "Przed chwilą";
              } else if (diffMins < 60) {
                timeStr = `${diffMins} min`;
              } else if (
                diffHours < 24 &&
                time.toDateString() === now.toDateString()
              ) {
                timeStr =
                  time.getHours().toString().padStart(2, "0") +
                  ":" +
                  time.getMinutes().toString().padStart(2, "0");
              } else {
                timeStr = time.toLocaleDateString();
              }

              const config = typeConfig[n.type] || {
                icon: "📩",
                color: "#6b7280",
                action: "business",
                label: "Powiadomienie",
              };

              // Wybierz odpowiednią akcję
              let clickAction;
              if (config.action === "chat" && n.workerId) {
                clickAction = `openWorkerNotification('${n.id}')`;
              } else {
                clickAction = `markWorkerNotifRead('${n.id}')`;
              }

              // Pokaż ikonę akcji
              let actionHint = "";
              if (config.action === "chat") actionHint = "💬";
              else if (config.action === "review") actionHint = "👁️";
              else if (config.action === "business") actionHint = "→";

              return `
            <div class="notification-item ${n.read ? "" : "unread"} type-${
                n.type
              }"
                 onclick="${clickAction}">
              <div class="notification-item-header">
                <div class="notification-icon" style="background: ${
                  config.color
                }22; color: ${config.color}">
                  ${config.icon}
                </div>
                <div class="notification-content">
                  <div class="notification-title">
                    ${n.workerName || n.businessName}
                    <span class="action-hint">${actionHint}</span>
                  </div>
                  <div class="notification-text">${n.message || ""}</div>
                  <div class="notification-meta">
                    <span>🕐 ${timeStr}</span>
                    ${
                      n.workerName && n.businessName
                        ? `<span class="business-tag">🏢 ${n.businessName}</span>`
                        : ""
                    }
                  </div>
                </div>
                <div class="notification-actions-row">
                  <button class="notif-delete-btn" onclick="event.stopPropagation(); deleteWorkerNotification('${
                    n.id
                  }')" title="${isEn ? "Delete" : "Usuń"}">
                    🗑️
                  </button>
                </div>
              </div>
            </div>
          `;
            })
            .join("");
        }

        function markAllNotificationsRead() {
          const notifications = getWorkerNotifications();
          notifications.forEach((n) => (n.read = true));
          saveWorkerNotifications(notifications);
          updateWorkerNotificationBadge();
          renderWorkerNotifications();

          const isEn = currentLang === "en";
          showToast(
            isEn
              ? "✅ All notifications marked as read"
              : "✅ Wszystkie powiadomienia oznaczone jako przeczytane",
            { type: "success", duration: 2000 }
          );
        }

        function markWorkerNotifRead(notifId) {
          const notifications = getWorkerNotifications();
          const notif = notifications.find((n) => n.id === notifId);
          if (notif) {
            notif.read = true;
            saveWorkerNotifications(notifications);
            updateWorkerNotificationBadge();
            renderWorkerNotifications();

            // Otwórz odpowiedni widok w zależności od typu
            closeModal("notifications");

            setTimeout(() => {
              if (notif.type.startsWith("client_review")) {
                // Otwórz modal opinii
                showReviewModal(notif);
              } else if (notif.type === "new_candidate") {
                // Otwórz firmę z kandydatami
                showBusinessDetail(notif.businessIndex);
              } else if (notif.type === "day_end") {
                // Otwórz firmę
                showBusinessDetail(notif.businessIndex);
              } else if (
                notif.type === "promotion_bought" ||
                notif.type === "price_change" ||
                notif.type === "cleaning_done" ||
                notif.type === "low_cleanliness"
              ) {
                // Otwórz firmę
                showBusinessDetail(notif.businessIndex);
              }
            }, 100);
          }
        }

        // Modal opinii klienta
        function showReviewModal(notif) {
          const isEn = currentLang === "en";
          const rating = notif.rating || 3;
          const stars =
            "⭐".repeat(Math.floor(rating)) + (rating % 1 >= 0.5 ? "½" : "");
          const time = new Date(notif.timestamp);
          const timeStr = time.toLocaleString();

          let ratingColor = "#888";
          let ratingText = isEn ? "Average" : "Średnia";
          let emoji = "😐";

          if (rating >= 4.5) {
            ratingColor = "#4ade80";
            ratingText = isEn ? "Excellent!" : "Doskonała!";
            emoji = "🤩";
          } else if (rating >= 4) {
            ratingColor = "#4ade80";
            ratingText = isEn ? "Very Good" : "Bardzo dobra";
            emoji = "😊";
          } else if (rating >= 3) {
            ratingColor = "#f59e0b";
            ratingText = isEn ? "Average" : "Średnia";
            emoji = "😐";
          } else if (rating >= 2) {
            ratingColor = "#ef4444";
            ratingText = isEn ? "Poor" : "Słaba";
            emoji = "😕";
          } else {
            ratingColor = "#ef4444";
            ratingText = isEn ? "Terrible!" : "Tragiczna!";
            emoji = "😠";
          }

          // Wyciągnij tekst opinii z wiadomości (usuwając gwiazdki na początku)
          let reviewText = notif.message || "";
          // Usuń gwiazdki i cudzysłowy z początku
          reviewText = reviewText
            .replace(/^[⭐½\s]+/, "")
            .replace(/^"/, "")
            .replace(/"$/, "");

          const modalHtml = `
          <div class="modal active" id="modalReview" onclick="if(event.target.id==='modalReview')closeModal('review')">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
              <span class="close" onclick="closeModal('review')">&times;</span>
              
              <div style="font-size: 4em; margin-bottom: 10px;">${emoji}</div>
              
              <h2 style="color: ${ratingColor}; margin-bottom: 5px;">${ratingText}</h2>
              
              <div style="font-size: 2em; margin-bottom: 15px;">${stars}</div>
              
              <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                <div style="font-style: italic; font-size: 1.1em; color: #ddd; line-height: 1.5;">
                  "${reviewText}"
                </div>
              </div>
              
              <div style="color: #666; font-size: 0.85em; margin-bottom: 10px;">
                🏢 ${notif.businessName}
              </div>
              
              ${
                notif.clientSpent
                  ? `
                <div style="color: #4ade80; font-size: 0.9em; margin-bottom: 10px;">
                  💰 ${
                    isEn ? "Spent" : "Wydał"
                  }: ${notif.clientSpent.toLocaleString()} ${getCurrency()}
                </div>
              `
                  : ""
              }
              
              <div style="color: #666; font-size: 0.8em;">
                📅 ${timeStr}
              </div>
              
              <button onclick="closeModal('review')" style="margin-top: 20px; padding: 12px 30px; background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">
                OK
              </button>
            </div>
          </div>
        `;

          // Usuń stary modal jeśli istnieje
          const oldModal = document.getElementById("modalReview");
          if (oldModal) oldModal.remove();

          // Dodaj nowy modal
          document.body.insertAdjacentHTML("beforeend", modalHtml);
        }

        function openWorkerNotification(notifId) {
          const notifications = getWorkerNotifications();
          const notif = notifications.find((n) => n.id === notifId);

          if (!notif) return;

          // Oznacz jako przeczytane
          notif.read = true;
          saveWorkerNotifications(notifications);
          updateWorkerNotificationBadge();

          // Zamknij modal powiadomień
          closeModal("notifications");

          // Otwórz czat z pracownikiem jeśli ma workerId
          if (notif.workerId) {
            setTimeout(() => {
              talkToWorker(notif.businessIndex, notif.workerId);
            }, 100);
          }
        }

        function deleteWorkerNotification(notifId) {
          let notifications = getWorkerNotifications();
          notifications = notifications.filter((n) => n.id !== notifId);
          saveWorkerNotifications(notifications);
          renderWorkerNotifications();
          updateWorkerNotificationBadge();
        }

        function clearAllNotifications() {
          saveWorkerNotifications([]);
          renderWorkerNotifications();
          updateWorkerNotificationBadge();
        }

        // Wiadomości jakie mogą wysłać pracownicy
        function getWorkerMessageTemplates() {
          const isEn = currentLang === "en";
          return {
            raise_request: isEn
              ? [
                  "I think I deserve a raise. Can we talk about my salary?",
                  "I've been working hard. I'd like to discuss a pay increase.",
                  "My performance has improved. Could we review my compensation?",
                  "I feel underpaid for my responsibilities. Can we negotiate?",
                  "Other companies are offering more. I'd like a raise to stay.",
                ]
              : [
                  "Uważam, że zasługuję na podwyżkę. Możemy porozmawiać?",
                  "Ciężko pracuję. Chciałbym omówić podwyżkę.",
                  "Moja wydajność się poprawiła. Możemy przejrzeć wynagrodzenie?",
                  "Czuję się niedopłacany. Możemy negocjować?",
                  "Inne firmy oferują więcej. Chciałbym podwyżkę żeby zostać.",
                ],
            unhappy: isEn
              ? [
                  "I'm not happy with the current situation...",
                  "Things aren't going well for me here.",
                  "I have some concerns I need to discuss.",
                  "The working conditions are affecting my mood.",
                  "I'm feeling demotivated lately.",
                ]
              : [
                  "Nie jestem zadowolony z obecnej sytuacji...",
                  "Nie układa mi się tutaj dobrze.",
                  "Mam pewne obawy do omówienia.",
                  "Warunki pracy wpływają na mój nastrój.",
                  "Ostatnio czuję się zdemotywowany.",
                ],
            quit_warning: isEn
              ? [
                  "I'm considering leaving if things don't change.",
                  "I've had offers from other companies...",
                  "If my concerns aren't addressed, I may have to quit.",
                  "I'm at my breaking point here.",
                  "This might be my last warning before I resign.",
                ]
              : [
                  "Rozważam odejście jeśli nic się nie zmieni.",
                  "Miałem oferty od innych firm...",
                  "Jeśli moje obawy nie zostaną rozwiązane, będę musiał odejść.",
                  "Jestem na granicy wytrzymałości.",
                  "To może być moje ostatnie ostrzeżenie przed rezygnacją.",
                ],
            hours_complaint: isEn
              ? [
                  "The new working hours don't suit me at all!",
                  "I wasn't consulted about the schedule change.",
                  "These hours are really inconvenient for me.",
                  "Can we discuss the working hours? I'm struggling.",
                  "The schedule change is affecting my personal life.",
                ]
              : [
                  "Nowe godziny pracy zupełnie mi nie pasują!",
                  "Nikt mnie nie pytał o zmianę grafiku.",
                  "Te godziny są dla mnie bardzo niewygodne.",
                  "Możemy omówić godziny pracy? Mam problem.",
                  "Zmiana grafiku wpływa na moje życie prywatne.",
                ],
            budget_request: isEn
              ? [
                  "I need more budget to do my job effectively.",
                  "My current budget is running low. Can we discuss?",
                  "I could achieve more with additional resources.",
                  "The budget is limiting my work. Can we increase it?",
                  "I'm requesting a budget review for my department.",
                ]
              : [
                  "Potrzebuję większego budżetu żeby efektywnie pracować.",
                  "Mój budżet się kończy. Możemy porozmawiać?",
                  "Mógłbym osiągnąć więcej z dodatkowymi zasobami.",
                  "Budżet ogranicza moją pracę. Możemy go zwiększyć?",
                  "Proszę o przegląd budżetu dla mojego działu.",
                ],
          };
        }

        function generateWorkerMessage(type) {
          const templates = getWorkerMessageTemplates();
          const messages = templates[type] || templates.unhappy;
          return messages[Math.floor(Math.random() * messages.length)];
        }

        // Sprawdź czy pracownicy chcą wysłać wiadomości
        function checkWorkerMessages() {
          const businesses = getBusinesses();
          const now = Date.now();
          const isEn = currentLang === "en";

          businesses.forEach((business, businessIndex) => {
            const hiredWorkers = business.workers.filter((w) => w.hired);

            hiredWorkers.forEach((worker) => {
              // Sprawdź czy pracownik niedawno wysłał wiadomość (min 1h przerwy)
              const lastMessage = worker.lastNotificationTime || 0;
              if (now - lastMessage < 60 * 60 * 1000) return;

              const satisfaction = worker.satisfaction || 50;
              const daysWorked = worker.daysWorked || 0;

              // Różne warunki wysyłania wiadomości

              // Prośba o podwyżkę - po 7 dniach pracy, losowo
              if (daysWorked >= 7 && Math.random() < 0.02) {
                const message = generateWorkerMessage("raise_request");
                addWorkerNotification(
                  businessIndex,
                  worker.id,
                  "raise_request",
                  message
                );
                worker.lastNotificationTime = now;
                worker.pendingRequest = "raise";
              }
              // Niezadowolenie - gdy satisfaction < 40
              else if (satisfaction < 40 && Math.random() < 0.05) {
                const message = generateWorkerMessage("unhappy");
                addWorkerNotification(
                  businessIndex,
                  worker.id,
                  "unhappy",
                  message
                );
                worker.lastNotificationTime = now;
              }
              // Ostrzeżenie o odejściu - gdy satisfaction < 20
              else if (satisfaction < 20 && Math.random() < 0.03) {
                const message = generateWorkerMessage("quit_warning");
                addWorkerNotification(
                  businessIndex,
                  worker.id,
                  "quit_warning",
                  message
                );
                worker.lastNotificationTime = now;
                worker.pendingRequest = "quit_warning";
              }
              // Prośba o budżet - gdy ma rolę z budżetem i budżet < 20% oczekiwanego
              else if (worker.assignedBudget !== undefined) {
                const budget =
                  worker.assignedBudget - (worker.budgetSpent || 0);
                const expected = worker.expectedBudget || 1000;
                if (budget < expected * 0.2 && Math.random() < 0.04) {
                  const message = generateWorkerMessage("budget_request");
                  addWorkerNotification(
                    businessIndex,
                    worker.id,
                    "budget_request",
                    message
                  );
                  worker.lastNotificationTime = now;
                  worker.pendingRequest = "budget";
                }
              }
            });

            // Powiadomienie o niskiej czystości
            if ((business.cleanliness || 100) < 30) {
              const lastCleanWarning = business.lastCleanlinessWarning || 0;
              if (now - lastCleanWarning > 30 * 60 * 1000) {
                // Max raz na 30 min
                notifyLowCleanliness(businessIndex, business.cleanliness);
                business.lastCleanlinessWarning = now;
              }
            }
          });

          saveBusinesses(businesses);
        }

        // Sprawdzaj wiadomości pracowników co 2 minuty
        setInterval(checkWorkerMessages, 2 * 60 * 1000);
        // Sprawdź przy starcie
        setTimeout(checkWorkerMessages, 10000);
        // Aktualizuj badge przy starcie
        setTimeout(() => {
          updateWorkerNotificationBadge();

          // TEST: Dodaj testowe powiadomienie jeśli są firmy
          const businesses = getBusinesses();
          if (businesses && businesses.length > 0) {
            const notifs = getWorkerNotifications();
            // Dodaj testowe tylko raz (sprawdź czy nie ma już testowego)
            if (!notifs.some((n) => n.type === "test_welcome")) {
              const isEn = currentLang === "en";
              addWorkerNotification(
                0,
                null,
                "test_welcome",
                isEn
                  ? "🎉 Notification system working! Click to see your business."
                  : "🎉 System powiadomień działa! Kliknij aby zobaczyć firmę.",
                { workerName: isEn ? "System" : "System" }
              );
            }
          }
        }, 2000);

        // ========== NOWY SYSTEM - KLIENCI W CZASIE RZECZYWISTYM ==========

        // System opinii klientów - teksty dla każdej oceny (1-5 gwiazdek, po 20 tekstów)
        function getReviewTexts() {
          const isEn = currentLang === "en";
          return {
            // ⭐ 1 gwiazdka - bardzo źle
            star1: isEn
              ? [
                  "Terrible experience! Never coming back!",
                  "Worst service I've ever seen.",
                  "Complete waste of money.",
                  "Staff was incredibly rude.",
                  "Dirty and disgusting place.",
                  "I want my money back!",
                  "Absolutely horrible.",
                  "Don't waste your time here.",
                  "The worst decision I made today.",
                  "I'm shocked how bad this was.",
                  "Zero stars if I could!",
                  "Management should be ashamed.",
                  "Health hazard! Avoid!",
                  "Scam! Don't fall for it!",
                  "I feel robbed.",
                  "Unacceptable quality.",
                  "My expectations were low but WOW.",
                  "Even free would be too expensive.",
                  "I'm writing a complaint.",
                  "Warned everyone I know.",
                ]
              : [
                  "Tragiczne doświadczenie! Nigdy nie wrócę!",
                  "Najgorsza obsługa jaką widziałem.",
                  "Kompletna strata pieniędzy.",
                  "Personel był niesamowicie niegrzeczny.",
                  "Brudne i obrzydliwe miejsce.",
                  "Chcę zwrot pieniędzy!",
                  "Absolutnie okropne.",
                  "Nie trać tu czasu.",
                  "Najgorsza decyzja dnia.",
                  "Jestem w szoku jak źle było.",
                  "Zero gwiazdek jakbym mógł!",
                  "Zarząd powinien się wstydzić.",
                  "Zagrożenie zdrowia! Unikać!",
                  "Oszustwo! Nie daj się nabrać!",
                  "Czuję się okradziony.",
                  "Nieakceptowalna jakość.",
                  "Moje oczekiwania były niskie ale WOW.",
                  "Nawet za darmo byłoby za drogo.",
                  "Piszę skargę.",
                  "Ostrzegłem wszystkich znajomych.",
                ],
            // ⭐⭐ 1.5-2 gwiazdki - słabo
            star2: isEn
              ? [
                  "Pretty disappointing overall.",
                  "Expected much better.",
                  "Not worth the price.",
                  "Service was slow and unfriendly.",
                  "Could use some serious improvements.",
                  "Left feeling unsatisfied.",
                  "Mediocre at best.",
                  "Won't be recommending this.",
                  "The place needs cleaning.",
                  "Overpriced for what you get.",
                  "Staff seemed untrained.",
                  "Long wait times.",
                  "Quality was below average.",
                  "Had better experiences elsewhere.",
                  "Not impressed at all.",
                  "Needs work in many areas.",
                  "Probably won't return.",
                  "Felt rushed and ignored.",
                  "Not what was advertised.",
                  "Barely acceptable.",
                ]
              : [
                  "Dość rozczarowujące ogólnie.",
                  "Oczekiwałem znacznie lepiej.",
                  "Nie warte ceny.",
                  "Obsługa była powolna i nieprzyjazna.",
                  "Wymaga poważnych poprawek.",
                  "Wyszedłem niezadowolony.",
                  "W najlepszym razie przeciętne.",
                  "Nie będę polecać.",
                  "Miejsce wymaga sprzątania.",
                  "Zawyżona cena za to co dostajemy.",
                  "Personel wydawał się nieprzeszkolony.",
                  "Długi czas oczekiwania.",
                  "Jakość poniżej średniej.",
                  "Miałem lepsze doświadczenia gdzie indziej.",
                  "Zupełnie nie robi wrażenia.",
                  "Wymaga pracy w wielu obszarach.",
                  "Prawdopodobnie nie wrócę.",
                  "Czułem się pośpieszany i ignorowany.",
                  "Nie to co reklamowano.",
                  "Ledwo akceptowalne.",
                ],
            // ⭐⭐⭐ 2.5-3 gwiazdki - średnio
            star3: isEn
              ? [
                  "It was okay, nothing special.",
                  "Average experience.",
                  "Some good, some bad.",
                  "Met basic expectations.",
                  "Neither great nor terrible.",
                  "Room for improvement.",
                  "Decent but unremarkable.",
                  "Standard quality.",
                  "Could be better, could be worse.",
                  "Just an ordinary visit.",
                  "Fair for the price.",
                  "No complaints, no praise.",
                  "Middle of the road.",
                  "Acceptable quality.",
                  "Did the job.",
                  "Neutral feelings about it.",
                  "Been to better, been to worse.",
                  "It's fine I guess.",
                  "Nothing to write home about.",
                  "Average service.",
                ]
              : [
                  "Było okej, nic specjalnego.",
                  "Przeciętne doświadczenie.",
                  "Trochę dobrego, trochę złego.",
                  "Spełniło podstawowe oczekiwania.",
                  "Ani świetne ani okropne.",
                  "Jest miejsce na poprawę.",
                  "Przyzwoite ale nie wyróżniające się.",
                  "Standardowa jakość.",
                  "Mogło być lepiej, mogło gorzej.",
                  "Zwykła wizyta.",
                  "W porządku jak na cenę.",
                  "Bez skarg, bez pochwał.",
                  "Środek drogi.",
                  "Akceptowalna jakość.",
                  "Spełniło zadanie.",
                  "Neutralne odczucia.",
                  "Byłem w lepszych i gorszych.",
                  "Jest w porządku chyba.",
                  "Nic o czym pisać.",
                  "Przeciętna obsługa.",
                ],
            // ⭐⭐⭐⭐ 3.5-4 gwiazdki - dobrze
            star4: isEn
              ? [
                  "Really good experience!",
                  "Would definitely come back.",
                  "Friendly and professional staff.",
                  "Good value for money.",
                  "Pleasant surprise!",
                  "Above my expectations.",
                  "Clean and well-organized.",
                  "Highly recommended!",
                  "Quality service.",
                  "Left happy and satisfied.",
                  "Will tell my friends.",
                  "Almost perfect!",
                  "Great atmosphere.",
                  "Efficient and quick.",
                  "Minor issues but overall great.",
                  "Professional and courteous.",
                  "Impressed with the quality.",
                  "Worth every penny.",
                  "A solid choice.",
                  "Very good experience overall.",
                ]
              : [
                  "Naprawdę dobre doświadczenie!",
                  "Na pewno wrócę.",
                  "Przyjazny i profesjonalny personel.",
                  "Dobra wartość za pieniądze.",
                  "Miła niespodzianka!",
                  "Powyżej moich oczekiwań.",
                  "Czysto i dobrze zorganizowane.",
                  "Gorąco polecam!",
                  "Jakościowa obsługa.",
                  "Wyszedłem szczęśliwy i zadowolony.",
                  "Powiem znajomym.",
                  "Prawie idealne!",
                  "Świetna atmosfera.",
                  "Sprawnie i szybko.",
                  "Drobne problemy ale ogólnie super.",
                  "Profesjonalnie i uprzejmie.",
                  "Pod wrażeniem jakości.",
                  "Warte każdej złotówki.",
                  "Solidny wybór.",
                  "Bardzo dobre doświadczenie ogólnie.",
                ],
            // ⭐⭐⭐⭐⭐ 4.5-5 gwiazdek - doskonale
            star5: isEn
              ? [
                  "Absolutely amazing! 10/10!",
                  "Best experience ever!",
                  "Perfect in every way!",
                  "Exceeded all expectations!",
                  "World class service!",
                  "I'm a customer for life!",
                  "Flawless experience!",
                  "Outstanding quality!",
                  "This is how it should be done!",
                  "Blown away by excellence!",
                  "Five stars isn't enough!",
                  "Incredible attention to detail!",
                  "Top notch everything!",
                  "My new favorite place!",
                  "Absolutely brilliant!",
                  "Perfection achieved!",
                  "Can't recommend enough!",
                  "A true gem!",
                  "Beyond expectations!",
                  "Simply the best!",
                ]
              : [
                  "Absolutnie niesamowite! 10/10!",
                  "Najlepsze doświadczenie ever!",
                  "Perfekcyjne pod każdym względem!",
                  "Przekroczyło wszystkie oczekiwania!",
                  "Obsługa na światowym poziomie!",
                  "Jestem klientem na całe życie!",
                  "Bezbłędne doświadczenie!",
                  "Wybitna jakość!",
                  "Tak to powinno wyglądać!",
                  "Zaskoczony doskonałością!",
                  "Pięć gwiazdek to za mało!",
                  "Niesamowita dbałość o szczegóły!",
                  "Wszystko na najwyższym poziomie!",
                  "Moje nowe ulubione miejsce!",
                  "Absolutnie genialne!",
                  "Perfekcja osiągnięta!",
                  "Nie mogę wystarczająco polecić!",
                  "Prawdziwy skarb!",
                  "Ponad oczekiwania!",
                  "Po prostu najlepsze!",
                ],
          };
        }

        function getRandomReview(rating) {
          // rating: 1-5 (można też 1.5, 2.5 itd)
          const texts = getReviewTexts();
          let category;
          if (rating <= 1) category = "star1";
          else if (rating <= 2) category = "star2";
          else if (rating <= 3) category = "star3";
          else if (rating <= 4) category = "star4";
          else category = "star5";

          const options = texts[category];
          return options[Math.floor(Math.random() * options.length)];
        }

        function reviewTypeToRating(reviewType) {
          switch (reviewType) {
            case "angry":
              return 1;
            case "negative":
              return 2;
            case "neutral":
              return 3;
            case "positive":
              return 4;
            case "excellent":
              return 5;
            default:
              return 3;
          }
        }

        function ratingToStars(rating) {
          const fullStars = Math.floor(rating);
          const halfStar = rating % 1 >= 0.5;
          let stars = "⭐".repeat(fullStars);
          if (halfStar) stars += "½";
          return stars;
        }

        function getTodayDateStr() {
          const d = new Date();
          return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
        }

        function getCurrentHour() {
          return new Date().getHours();
        }

        function isBusinessOpen(business) {
          if (business.is24h) return true;
          const hour = getCurrentHour();
          return (
            hour >= (business.openHour || 8) &&
            hour < (business.closeHour || 20)
          );
        }

        function processBusinessRealtime() {
          const businesses = getBusinesses();
          const now = Date.now();
          const today = getTodayDateStr();
          const currentHour = getCurrentHour();
          let anyChanged = false;

          businesses.forEach((business, index) => {
            // Sprawdź czy nowy dzień - zresetuj dane
            if (business.lastBusinessDay !== today) {
              // Jeśli był poprzedni dzień i ma dane - stwórz raport
              if (
                business.lastBusinessDay &&
                (business.todayIncome > 0 || business.todayClients?.length > 0)
              ) {
                createDayReport(business, index);
              }
              // Reset na nowy dzień
              business.todayClients = [];
              business.todayIncome = 0;
              business.todayReviews = { positive: 0, negative: 0, neutral: 0 };
              business.lastBusinessDay = today;
              business.clientsServedToday = 0;
              anyChanged = true;
            }

            // Sprawdź czy czas na zamknięcie i raport
            if (!business.is24h && currentHour >= (business.closeHour || 20)) {
              if (!business.dayReportCreated) {
                createDayReport(business, index);
                business.dayReportCreated = true;
                anyChanged = true;
              }
            } else {
              business.dayReportCreated = false;
            }

            // Jeśli firma otwarta - losowo przychodź klienci
            if (isBusinessOpen(business)) {
              const result = processIncomingClient(business, index);
              if (result) anyChanged = true;
            }
          });

          if (anyChanged) {
            saveBusinesses(businesses);
          }
        }

        function processIncomingClient(business, businessIndex) {
          const hiredWorkers = business.workers.filter((w) => w.hired);
          const serviceWorkers = hiredWorkers.filter(
            (w) => (w.assignedRole || "service") === "service"
          );
          const cleaningWorkers = hiredWorkers.filter(
            (w) => w.assignedRole === "cleaning"
          );
          const pricingWorkers = hiredWorkers.filter(
            (w) => w.assignedRole === "pricing"
          );
          const marketingWorkers = hiredWorkers.filter(
            (w) => w.assignedRole === "marketing"
          );
          const ownerWorking = business.ownerWorking || false;
          const isEn = currentLang === "en";

          // Ile klientów powinno przyjść dzisiaj
          const openHours = business.is24h
            ? 24
            : (business.closeHour || 20) - (business.openHour || 8);
          const clientsPerHour = business.clientsPerDay / openHours;

          // Modyfikatory
          const reputationBonus = (business.reputation || 50) / 50;
          const promoBonus = getPromotionBonus(business);

          // Szansa na klienta w tej minucie
          const clientChancePerMinute =
            (clientsPerHour / 60) * reputationBonus * promoBonus;

          if (Math.random() > clientChancePerMinute) {
            return false; // Brak klienta w tej minucie
          }

          // Klient przyszedł!
          const clientsServedToday = business.clientsServedToday || 0;

          // Oblicz zdolność obsługi
          const OWNER_CAPACITY = 10;
          const WORKER_CAPACITY = 15;
          let totalCapacity = ownerWorking ? OWNER_CAPACITY : 0;

          serviceWorkers.forEach((w) => {
            totalCapacity += Math.floor(
              WORKER_CAPACITY * (w.personality?.speedMod || 1)
            );
          });

          // Jeśli przekroczono zdolność - klient odchodzi zły
          if (clientsServedToday >= totalCapacity && !ownerWorking) {
            business.todayReviews.negative++;
            const rating = 1;
            const client = {
              time: Date.now(),
              served: false,
              review: "angry",
              rating: rating,
              text: getRandomReview(rating),
            };
            business.todayClients.push(client);

            // Powiadomienie o złej opinii
            notifyClientReview(businessIndex, client);
            return true;
          }

          // Obsłuż klienta
          const avgQuality =
            serviceWorkers.length > 0
              ? serviceWorkers.reduce(
                  (sum, w) => sum + (w.personality?.qualityMod || 1),
                  0
                ) / serviceWorkers.length
              : 1;
          const avgErrorRate =
            serviceWorkers.length > 0
              ? serviceWorkers.reduce(
                  (sum, w) => sum + (w.personality?.errorRate || 0.1),
                  0
                ) / serviceWorkers.length
              : 0.1;

          const priceModifier = business.priceModifier || 1;
          const cleanliness = business.cleanliness || 100;

          const clientSpend = Math.floor(
            business.avgIncome *
              avgQuality *
              priceModifier *
              (0.5 + Math.random())
          );
          business.todayIncome += clientSpend;
          business.clientsServedToday = (business.clientsServedToday || 0) + 1;

          // Ocena klienta - bardziej szczegółowa
          const madeError = Math.random() < avgErrorRate;
          const cleanlinessEffect =
            cleanliness < 30 ? -1 : cleanliness < 60 ? -0.5 : 0.5;
          const priceEffect =
            priceModifier > 1.3 ? -0.5 : priceModifier < 0.8 ? 0.5 : 0;
          const qualityEffect = (avgQuality - 1) * 2;

          // Bazowa ocena 3, modyfikowana przez różne czynniki
          let rating =
            3 +
            cleanlinessEffect +
            priceEffect +
            qualityEffect +
            (Math.random() - 0.5);
          if (madeError) rating -= 1.5;
          rating = Math.max(1, Math.min(5, rating));
          rating = Math.round(rating * 2) / 2; // Zaokrąglij do 0.5

          let review = "neutral";
          if (rating <= 1.5) {
            review = "negative";
            business.todayReviews.negative++;
          } else if (rating <= 2.5) {
            review = "negative";
            business.todayReviews.negative++;
          } else if (rating <= 3.5) {
            review = "neutral";
            business.todayReviews.neutral++;
          } else if (rating <= 4.5) {
            review = "positive";
            business.todayReviews.positive++;
          } else {
            review = "excellent";
            business.todayReviews.positive++;
          }

          const client = {
            time: Date.now(),
            served: true,
            spent: clientSpend,
            review: review,
            rating: rating,
            text: getRandomReview(rating),
          };
          business.todayClients.push(client);

          // Powiadomienie o opinii (tylko złe i bardzo dobre)
          if (rating <= 2 || rating >= 5) {
            notifyClientReview(businessIndex, client);
          }

          // Aktualizuj czystość
          if (cleaningWorkers.length > 0) {
            const cleanPower = cleaningWorkers.reduce(
              (sum, w) => sum + (w.personality?.qualityMod || 1) * 5,
              0
            );
            const oldCleanliness = business.cleanliness || 100;
            business.cleanliness = Math.min(100, oldCleanliness + cleanPower);
            business.lastCleanTime = Date.now();

            // Powiadomienie o sprzątaniu (tylko raz na jakiś czas)
            if (business.cleanliness >= 90 && oldCleanliness < 90) {
              notifyCleaningDone(
                businessIndex,
                cleaningWorkers[0].name,
                business.cleanliness
              );
            }
          } else {
            // Bez sprzątania - czystość spada
            business.cleanliness = Math.max(
              0,
              (business.cleanliness || 100) - 0.5
            );
          }

          // Pricing worker dostosowuje ceny
          if (pricingWorkers.length > 0) {
            const oldPrice = priceModifier;
            const targetPrice = 0.5 + (business.reputation / 100) * 1.0;
            const adjustment = (targetPrice - priceModifier) * 0.02;
            business.priceModifier = Math.max(
              0.5,
              Math.min(2.0, priceModifier + adjustment)
            );

            // Powiadomienie o znaczącej zmianie ceny
            if (Math.abs(business.priceModifier - oldPrice) > 0.05) {
              notifyPriceChange(
                businessIndex,
                pricingWorkers[0].name,
                oldPrice,
                business.priceModifier
              );
            }
          }

          // Marketing worker - research i kupowanie promocji
          marketingWorkers.forEach((w) => {
            if (
              w.assignedBudget > 0 &&
              (w.budgetSpent || 0) < w.assignedBudget
            ) {
              if (
                !business.marketingResearchEnd ||
                Date.now() >= business.marketingResearchEnd
              ) {
                const promotions = getPromotionOptions();
                const activePromoIds = (business.activePromotions || []).map(
                  (p) => p.id
                );
                const availableBudget = w.assignedBudget - (w.budgetSpent || 0);

                const affordablePromos = promotions
                  .filter(
                    (p) =>
                      !activePromoIds.includes(p.id) &&
                      p.cost <= availableBudget
                  )
                  .sort((a, b) => b.clientBoost - a.clientBoost);

                if (affordablePromos.length > 0) {
                  const promo = affordablePromos[0];
                  w.budgetSpent = (w.budgetSpent || 0) + promo.cost;
                  if (!business.activePromotions)
                    business.activePromotions = [];
                  business.activePromotions.push({
                    id: promo.id,
                    startTime: Date.now(),
                    endTime: Date.now() + promo.duration * 24 * 60 * 60 * 1000,
                    boughtBy: w.name,
                  });

                  // Powiadomienie o kupionej promocji
                  notifyPromotionBought(
                    businessIndex,
                    w.name,
                    promo.name,
                    promo.cost
                  );
                }

                const researchTime = (10 + Math.random() * 5) * 60 * 1000;
                business.marketingResearchEnd = Date.now() + researchTime;
              }
            }
          });

          return true;
        }

        function createDayReport(business, businessIndex) {
          const isEn = currentLang === "en";
          const hiredWorkers = business.workers.filter((w) => w.hired);

          // Oblicz pensje
          let salariesPaid = 0;
          let bonusesPaid = 0;
          const workerReports = [];

          hiredWorkers.forEach((w) => {
            const dailySalary = Math.floor(
              (w.currentSalary || w.expectedSalary || 350) / 7
            );
            salariesPaid += dailySalary;

            const workerBonus = Math.floor(
              ((business.todayIncome || 0) * (w.bonusPercent || 0)) /
                100 /
                Math.max(1, hiredWorkers.length)
            );
            bonusesPaid += workerBonus;

            w.totalEarned = (w.totalEarned || 0) + dailySalary + workerBonus;
            w.daysWorked = (w.daysWorked || 0) + 1;

            workerReports.push({
              name: w.name,
              role: w.assignedRole || "service",
              salary: dailySalary,
              bonus: workerBonus,
            });
          });

          // Rachunki
          const clientsServed = business.clientsServedToday || 0;
          const electricityCost = Math.floor(50 + clientsServed * 2);
          const waterCost = Math.floor(20 + clientsServed * 1);
          const gasCost = Math.floor(30 + clientsServed * 1.5);
          const internetCost = 50;
          const rentCost = Math.floor((business.startCost || 10000) * 0.001);
          const totalBills =
            electricityCost + waterCost + gasCost + internetCost + rentCost;

          // Reputacja
          const reviews = business.todayReviews || {
            positive: 0,
            negative: 0,
            neutral: 0,
          };
          const reputationChange = reviews.positive * 2 - reviews.negative * 3;
          business.reputation = Math.max(
            0,
            Math.min(100, (business.reputation || 50) + reputationChange)
          );

          // Finanse - z konta firmowego
          const totalExpenses = salariesPaid + bonusesPaid + totalBills;
          const dayIncome = business.todayIncome || 0;
          const netIncome = dayIncome - totalExpenses;

          // Dodaj dochód do konta firmowego
          business.companyBalance = (business.companyBalance || 0) + dayIncome;

          // Płać pensje z konta firmowego
          const salaryExpenses = salariesPaid + bonusesPaid;
          if (business.companyBalance >= salaryExpenses) {
            business.companyBalance -= salaryExpenses;
          } else {
            const deficit = salaryExpenses - business.companyBalance;
            business.companyBalance = 0;
            business.debt = (business.debt || 0) + deficit;
          }

          // Rachunki - z firmowego, potem z właściciela
          if (business.companyBalance >= totalBills) {
            business.companyBalance -= totalBills;
          } else {
            const remaining = totalBills - business.companyBalance;
            business.companyBalance = 0;
            if (money >= remaining) {
              money -= remaining;
            } else {
              debt += remaining - money;
              money = 0;
            }
          }

          // Zapisz raport do wyświetlenia
          business.pendingDayReport = {
            date: business.lastBusinessDay,
            businessName: business.name,
            businessIndex: businessIndex,
            clients: clientsServed,
            income: dayIncome,
            reviews: reviews,
            reputationChange: reputationChange,
            newReputation: business.reputation,
            workers: workerReports,
            salariesPaid: salariesPaid,
            bonusesPaid: bonusesPaid,
            bills: {
              electricity: electricityCost,
              water: waterCost,
              gas: gasCost,
              internet: internetCost,
              rent: rentCost,
              total: totalBills,
            },
            netIncome: netIncome,
            companyBalance: business.companyBalance,
          };

          // Powiadomienie o zakończeniu dnia
          notifyDayEnd(
            businessIndex,
            dayIncome,
            clientsServed,
            business.reputation
          );

          business.totalIncome = (business.totalIncome || 0) + dayIncome;
          business.totalExpenses =
            (business.totalExpenses || 0) + totalExpenses;

          saveState();
        }

        function checkPendingBusinessReports() {
          const businesses = getBusinesses();
          businesses.forEach((business, index) => {
            if (business.pendingDayReport) {
              showDayReport(business.pendingDayReport);
              business.pendingDayReport = null;
            }
          });
          saveBusinesses(businesses);
        }

        // Uruchom co 30 sekund
        setInterval(processBusinessRealtime, 30000);
        // Aktualizuj promocje co minutę
        setInterval(updateBusinessPromotions, 60000);

        function processAutomaticBusinessDays() {
          // Stara funkcja - teraz używamy processBusinessRealtime
          processBusinessRealtime();
        }

        function processBusinessDayAuto(businessIndex) {
          const businesses = getBusinesses();
          const business = businesses[businessIndex];
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          // Aktualizuj promocje
          updateBusinessPromotions();

          const hiredWorkers = business.workers.filter((w) => w.hired);
          const serviceWorkers = hiredWorkers.filter(
            (w) => (w.assignedRole || "service") === "service"
          );
          const marketingWorkers = hiredWorkers.filter(
            (w) => w.assignedRole === "marketing"
          );
          const cleaningWorkers = hiredWorkers.filter(
            (w) => w.assignedRole === "cleaning"
          );
          const pricingWorkers = hiredWorkers.filter(
            (w) => w.assignedRole === "pricing"
          );
          const ownerWorking = business.ownerWorking || false;

          // ========== CZYSTOŚĆ - spada z czasem ==========
          const lastClean = business.lastCleanTime || Date.now();
          const hoursSinceClean = (Date.now() - lastClean) / (60 * 60 * 1000);
          let cleanliness = business.cleanliness || 100;

          // Czystość spada o 2% na godzinę
          cleanliness = Math.max(0, cleanliness - hoursSinceClean * 2);

          // Cleaning workers przywracają czystość
          if (cleaningWorkers.length > 0) {
            const cleaningPower = cleaningWorkers.reduce((sum, w) => {
              return sum + (w.personality?.qualityMod || 1) * 20;
            }, 0);
            cleanliness = Math.min(100, cleanliness + cleaningPower);
            business.lastCleanTime = Date.now();
          }
          business.cleanliness = cleanliness;

          // ========== PRICING - dostosowuje ceny ==========
          let priceModifier = business.priceModifier || 1.0;
          if (pricingWorkers.length > 0 && business.reputation !== undefined) {
            // Wysoka reputacja = można podnieść ceny
            // Niska reputacja = trzeba obniżyć
            const targetPrice = 0.5 + (business.reputation / 100) * 1.0; // 0.5-1.5
            const pricingSkill = pricingWorkers[0].personality?.qualityMod || 1;
            // Powoli dostosowuj cenę w kierunku targetPrice
            const adjustment =
              (targetPrice - priceModifier) * 0.1 * pricingSkill;
            priceModifier = Math.max(
              0.5,
              Math.min(2.0, priceModifier + adjustment)
            );
            business.priceModifier = priceModifier;
          }

          // ========== MARKETING - automatycznie kupuje promocje ==========
          marketingWorkers.forEach((w) => {
            if (
              w.assignedBudget > 0 &&
              (w.budgetSpent || 0) < w.assignedBudget
            ) {
              const availableBudget = w.assignedBudget - (w.budgetSpent || 0);

              // Sprawdź czy kończy się research
              if (
                !business.marketingResearchEnd ||
                Date.now() >= business.marketingResearchEnd
              ) {
                // Research zakończony - kup promocję
                const promotions = getPromotionOptions();
                const activePromoIds = (business.activePromotions || []).map(
                  (p) => p.id
                );

                // Znajdź najlepszą promocję którą można kupić
                const affordablePromos = promotions
                  .filter(
                    (p) =>
                      !activePromoIds.includes(p.id) &&
                      p.cost <= availableBudget
                  )
                  .sort((a, b) => b.clientBoost - a.clientBoost); // najlepsza pierwsza

                if (affordablePromos.length > 0) {
                  const promo = affordablePromos[0];
                  // Kup promocję z budżetu pracownika
                  w.budgetSpent = (w.budgetSpent || 0) + promo.cost;
                  if (!business.activePromotions)
                    business.activePromotions = [];
                  business.activePromotions.push({
                    id: promo.id,
                    startTime: Date.now(),
                    endTime: Date.now() + promo.duration * 24 * 60 * 60 * 1000,
                    boughtBy: w.name,
                  });
                  showToast(
                    `📢 ${w.name} ${isEn ? "bought" : "kupił"}: ${promo.name}`
                  );

                  // Rozpocznij nowy research (10-15 minut)
                  const researchTime = (10 + Math.random() * 5) * 60 * 1000;
                  business.marketingResearchEnd = Date.now() + researchTime;
                }
              }
            }
          });

          // Jeśli nikt nie obsługuje - firma nie działa
          if (serviceWorkers.length === 0 && !ownerWorking) {
            const promoBonus = getPromotionBonus(business);
            const potentialClients = Math.floor(
              business.clientsPerDay *
                ((business.reputation || 50) / 50) *
                promoBonus *
                0.3
            );
            if (potentialClients > 0) {
              const negReviews = Math.floor(potentialClients * 0.5);
              business.reputation = Math.max(
                0,
                (business.reputation || 50) - negReviews
              );
              showToast(
                `⚠️ ${business.name}: ${
                  isEn
                    ? `${potentialClients} customers left unserved!`
                    : `${potentialClients} klientów nieobsłużonych!`
                }`
              );
            }
            business.lastDayProcessed = Date.now();
            saveBusinesses(businesses);
            return;
          }

          // ========== OBLICZ ZDOLNOŚĆ OBSŁUGI ==========
          const OWNER_CAPACITY = 10;
          const WORKER_CAPACITY = 15;

          let totalCapacity = 0;
          let totalQuality = 0;
          let totalErrorRate = 0;
          let workerCount = 0;

          // Właściciel pracuje
          if (ownerWorking) {
            totalCapacity += OWNER_CAPACITY;
            totalQuality += 1.0;
            totalErrorRate += 0.05;
            workerCount++;
          }

          // Tylko pracownicy obsługi liczą się do zdolności
          serviceWorkers.forEach((w) => {
            const personality = w.personality || {};
            const workerCapacity = Math.floor(
              WORKER_CAPACITY * (personality.speedMod || 1)
            );
            totalCapacity += workerCapacity;
            totalQuality += personality.qualityMod || 1;
            totalErrorRate += personality.errorRate || 0.1;
            workerCount++;
          });

          const avgQuality = workerCount > 0 ? totalQuality / workerCount : 1;
          const avgErrorRate =
            workerCount > 0 ? totalErrorRate / workerCount : 0.1;

          // ========== KLIENCI - zależni od reputacji, promocji i marketingu ==========
          const reputationBonus = (business.reputation || 50) / 50; // 0-2x
          const promoBonus = getPromotionBonus(business);

          // Marketing pracowników dodaje bonus (wydają budżet)
          let marketingBonus = 1.0;
          marketingWorkers.forEach((w) => {
            if (w.assignedBudget > 0 && w.budgetSpent < w.assignedBudget) {
              // Wydaj część budżetu na marketing dzienny
              const dailySpend = Math.min(
                100,
                w.assignedBudget - w.budgetSpent
              );
              w.budgetSpent = (w.budgetSpent || 0) + dailySpend;
              marketingBonus += dailySpend / 1000; // +10% za każde 100 wydane
            }
          });

          const potentialClients = Math.floor(
            business.clientsPerDay *
              reputationBonus *
              promoBonus *
              marketingBonus *
              (0.8 + Math.random() * 0.4)
          );

          // Obsłużeni klienci = min(potencjalni, zdolność)
          const servedClients = Math.min(potentialClients, totalCapacity);
          const unservedClients = potentialClients - servedClients;

          let dayIncome = 0;
          let positiveReviews = 0;
          let negativeReviews = 0;

          // ========== OBSŁUŻENI KLIENCI ==========
          for (let i = 0; i < servedClients; i++) {
            // Dochód zależy od ceny
            const clientSpend = Math.floor(
              business.avgIncome *
                avgQuality *
                priceModifier *
                (0.5 + Math.random())
            );
            dayIncome += clientSpend;

            const madeError = Math.random() < avgErrorRate;

            // Wpływ czystości na opinie
            const cleanlinessEffect =
              cleanliness < 30 ? -0.3 : cleanliness < 60 ? -0.1 : 0.1;

            // Wpływ ceny na opinie (wysokie ceny = więcej narzekań)
            const priceEffect =
              priceModifier > 1.3 ? -0.15 : priceModifier < 0.8 ? 0.1 : 0;

            if (madeError) {
              if (Math.random() < 0.7) negativeReviews++;
            } else {
              const positiveChance =
                0.3 + (avgQuality - 1) * 0.4 + cleanlinessEffect + priceEffect;
              if (Math.random() < positiveChance) {
                positiveReviews++;
              } else if (Math.random() < 0.05 - cleanlinessEffect) {
                negativeReviews++;
              }
            }

            // Brudno = dodatkowe złe opinie
            if (cleanliness < 40 && Math.random() < 0.3) {
              negativeReviews++;
            }
          }

          // ========== NIEOBSŁUŻENI KLIENCI - NEGATYWNE OPINIE ==========
          const angryClients = Math.floor(unservedClients * 0.6);
          negativeReviews += angryClients;

          // ========== AKTUALIZUJ REPUTACJĘ ==========
          const reputationChange = positiveReviews * 2 - negativeReviews * 3;
          business.reputation = Math.max(
            0,
            Math.min(100, (business.reputation || 50) + reputationChange)
          );

          // ========== WYPŁATY PRACOWNIKÓW (DZIENNE) ==========
          let salariesPaid = 0;
          let bonusesPaid = 0;
          const workerReports = [];

          hiredWorkers.forEach((w) => {
            const dailySalary = Math.floor(
              (w.currentSalary || w.expectedSalary) / 7
            );
            salariesPaid += dailySalary;

            const workerBonus = Math.floor(
              (dayIncome * (w.bonusPercent / 100)) / hiredWorkers.length
            );
            bonusesPaid += workerBonus;

            w.totalEarned = (w.totalEarned || 0) + dailySalary + workerBonus;
            w.daysWorked = (w.daysWorked || 0) + 1;

            workerReports.push({
              name: w.name,
              salary: dailySalary,
              bonus: workerBonus,
              productivity: Math.round((w.productivity || 1) * 100),
              personality: w.personality?.id || "neutral",
            });
          });

          // ========== RACHUNKI DZIENNE ==========
          const electricityCost = Math.floor(
            50 + servedClients * 2 + Math.random() * 30
          );
          const waterCost = Math.floor(
            20 + servedClients * 1 + Math.random() * 15
          );
          const gasCost = Math.floor(
            30 + servedClients * 1.5 + Math.random() * 20
          );
          const internetCost = 50;
          const rentCost = Math.floor(business.startCost * 0.001);
          const totalBills =
            electricityCost + waterCost + gasCost + internetCost + rentCost;

          // ========== PODSUMOWANIE ==========
          const totalExpenses = salariesPaid + bonusesPaid + totalBills;
          const netIncome = dayIncome - totalExpenses;

          business.totalIncome = (business.totalIncome || 0) + dayIncome;
          business.totalExpenses =
            (business.totalExpenses || 0) + totalExpenses;
          business.lastDayProcessed = Date.now();

          // Dochód z klientów idzie na konto firmowe
          business.companyBalance = (business.companyBalance || 0) + dayIncome;

          // Pensje i prowizje płacone z konta firmowego
          const salaryExpenses = salariesPaid + bonusesPaid;
          if (business.companyBalance >= salaryExpenses) {
            business.companyBalance -= salaryExpenses;
          } else {
            // Nie starcza na pensje - dług firmy
            const deficit = salaryExpenses - business.companyBalance;
            business.companyBalance = 0;
            business.debt = (business.debt || 0) + deficit;
            showToast(
              `⚠️ ${business.name}: ${
                isEn
                  ? "Not enough for salaries! Debt increased."
                  : "Brak na pensje! Dług wzrósł."
              }`
            );
          }

          // Rachunki - najpierw z konta firmowego, potem z konta właściciela
          let billsPaidFromCompany = 0;
          let billsPaidFromOwner = 0;

          if (business.companyBalance >= totalBills) {
            business.companyBalance -= totalBills;
            billsPaidFromCompany = totalBills;
          } else {
            // Częściowo z firmy, reszta z konta właściciela
            billsPaidFromCompany = business.companyBalance;
            const remaining = totalBills - billsPaidFromCompany;
            business.companyBalance = 0;

            if (money >= remaining) {
              money -= remaining;
              billsPaidFromOwner = remaining;
            } else {
              // Właściciel też nie ma - dług
              billsPaidFromOwner = money;
              const unpaid = remaining - money;
              money = 0;
              debt += unpaid;
              showToast(
                `⚠️ ${business.name}: ${
                  isEn
                    ? "Bills unpaid! Personal debt increased."
                    : "Rachunki nieopłacone! Dług osobisty wzrósł."
                }`
              );
            }
          }

          saveBusinesses(businesses);
          saveState();
          updateAllDisplays();

          // Pokaż dzienny raport
          showDayReport({
            businessName: business.name,
            clients: servedClients,
            unservedClients: unservedClients,
            potentialClients: potentialClients,
            capacity: totalCapacity,
            ownerWorking: ownerWorking,
            income: dayIncome,
            workers: workerReports,
            salariesPaid: salariesPaid,
            bonusesPaid: bonusesPaid,
            reviews: {
              positive: positiveReviews,
              negative: negativeReviews,
              neutral:
                servedClients -
                positiveReviews -
                Math.min(negativeReviews, servedClients),
              angry: angryClients,
            },
            reputationChange: reputationChange,
            newReputation: business.reputation,
            bills: {
              electricity: electricityCost,
              water: waterCost,
              gas: gasCost,
              internet: internetCost,
              rent: rentCost,
              total: totalBills,
            },
            netIncome: netIncome,
            companyBalance: business.companyBalance,
            businessIndex: businessIndex,
          });
        }

        // Sprawdzaj dni co 30 sekund
        setInterval(processAutomaticBusinessDays, 30000);

        // ==================== AUTOMATYCZNE GENEROWANIE KANDYDATÓW ====================

        function autoGenerateCandidates() {
          const businesses = getBusinesses();
          const now = Date.now();
          const TWO_MIN_MS = 2 * 60 * 1000; // 2 minuty
          let anyGenerated = false;
          const t = translations[currentLang] || translations.en;
          const isEn = currentLang === "en";

          businesses.forEach((business, index) => {
            const lastGen = business.lastCandidateGen || 0;
            const timeSinceLastGen = now - lastGen;

            // Oblicz ile generacji pominęliśmy (gdy strona była wyłączona)
            const missedGenerations = Math.floor(timeSinceLastGen / TWO_MIN_MS);

            if (missedGenerations >= 1) {
              // Sprawdź ile jest kandydatów (nie zatrudnionych)
              const candidates = business.workers.filter((w) => !w.hired);

              // Generuj nowych jeśli mniej niż 5 kandydatów (max)
              const maxCandidates = 5;
              if (candidates.length < maxCandidates) {
                const positions = [
                  "manager",
                  "senior",
                  "regular",
                  "regular",
                  "junior",
                  "junior",
                  "intern",
                ];
                // Generuj proporcjonalnie do pominiętych generacji, max 3 na raz
                const toGenerate = Math.min(
                  3,
                  maxCandidates - candidates.length,
                  missedGenerations
                );

                for (let i = 0; i < toGenerate; i++) {
                  const pos =
                    positions[Math.floor(Math.random() * positions.length)];
                  const newWorker = generateWorker(pos);
                  business.workers.push(newWorker);

                  // Powiadomienie o nowym kandydacie
                  const posName = getTranslatedPosition(pos)?.name || pos;
                  notifyNewCandidate(index, newWorker.name, posName);
                }

                if (toGenerate > 0) {
                  anyGenerated = true;
                }
              }

              business.lastCandidateGen = now;
            }
          });

          if (anyGenerated) {
            saveBusinesses(businesses);
          }
        }

        // Sprawdzaj kandydatów co minutę (generacja co 2 minuty)
        setInterval(autoGenerateCandidates, 60000);

        // Sprawdź od razu przy starcie (po 3 sekundach) - nadrobi zaległości
        setTimeout(autoGenerateCandidates, 3000);

        // Sprawdź od razu przy starcie
        setTimeout(processAutomaticBusinessDays, 2000);

        // START - sprawdź czy to strona weryfikatora
        if (!checkIfVerifier()) {
          init();
        }

        // ==================== ANIMOWANE PARTICLES W TLE ====================
        function initParticlesBackground() {
          // Sprawdź czy już istnieje
          if (document.getElementById("particlesBackground")) return;

          const container = document.createElement("div");
          container.id = "particlesBackground";
          document.body.insertBefore(container, document.body.firstChild);

          const colors = [
            "#ff6b35",
            "#3b82f6",
            "#8b5cf6",
            "#4ade80",
            "#ffd700",
            "#ec4899",
          ];

          // Stwórz 30 particles
          for (let i = 0; i < 30; i++) {
            const particle = document.createElement("div");
            particle.className = "bg-particle";

            const size = Math.random() * 6 + 2;
            const color = colors[Math.floor(Math.random() * colors.length)];
            const duration = Math.random() * 20 + 15;
            const delay = Math.random() * 20;
            const left = Math.random() * 100;

            particle.style.cssText = `
            width: ${size}px;
            height: ${size}px;
            background: ${color};
            left: ${left}%;
            animation-duration: ${duration}s;
            animation-delay: -${delay}s;
            box-shadow: 0 0 ${size * 2}px ${color};
          `;

            container.appendChild(particle);
          }

          // Dodaj też kilka większych świecących kulek
          for (let i = 0; i < 8; i++) {
            const orb = document.createElement("div");
            orb.className = "bg-particle";

            const size = Math.random() * 15 + 10;
            const color = colors[Math.floor(Math.random() * colors.length)];
            const duration = Math.random() * 30 + 25;
            const delay = Math.random() * 30;
            const left = Math.random() * 100;

            orb.style.cssText = `
            width: ${size}px;
            height: ${size}px;
            background: radial-gradient(circle, ${color} 0%, transparent 70%);
            left: ${left}%;
            animation-duration: ${duration}s;
            animation-delay: -${delay}s;
            filter: blur(2px);
            opacity: 0.15;
          `;

            container.appendChild(orb);
          }
        }

        // Inicjalizuj particles przy starcie
        initParticlesBackground();

        // Tłumaczenie ekranu blokady mobilnej
        function updateMobileBlockLanguage() {
          const isEn = currentLang === "en";
          const title = document.getElementById("mobileBlockTitle");
          const text = document.getElementById("mobileBlockText");

          if (title && text) {
            title.textContent = isEn
              ? "Game unavailable on mobile devices"
              : "Gra niedostępna na urządzeniach mobilnych";
            text.innerHTML = isEn
              ? "Due to the complexity of mechanics and interface, optimizing this game for mobile devices is not possible.<br><br>The game requires precise controls and a large screen, which are only available on desktop computers and laptops.<br><br>Please play on a computer! 🖥️"
              : "Ze względu na złożoność mechanik i interfejsu, optymalizacja tej gry na urządzenia mobilne nie jest możliwa.<br><br>Gra wymaga precyzyjnego sterowania i dużego ekranu, które są dostępne tylko na komputerach stacjonarnych i laptopach.<br><br>Zapraszamy do gry na komputerze! 🖥️";
          }
        }

        // Wywołaj przy starcie
        updateMobileBlockLanguage();
      </script>
    </div>
    <!-- koniec gameContainer -->
  </body>
</html>
